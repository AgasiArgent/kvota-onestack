# Отчёт за 11 февраля 2026

## Исправления ошибок

- **Sentry-краши:** Исправлено 44 места в коде, где приложение падало при пустых FK-связях (например, когда у КП нет клиента). Добавлено 61 регрессионный тест.
- **Дашборд закупок:** Падал с ошибкой при отсутствии данных. Исправлено.
- **Профиль клиента:** Вкладки (договоры, КП, спецификации) не показывали данные. Исправлено.
- **Логистические платежи:** Ошибка NOT NULL при создании платежа. Исправлено (миграция 170).

## Новый функционал

### Имперсонация ролей (админ)
Админ может переключиться на любую роль через выпадающее меню в сайдбаре. При этом:
- Меняется навигация — видны только ссылки, доступные этой роли
- Меняется контент страниц /tasks и /dashboard — показываются только релевантные блоки
- Жёлтый баннер предупреждает, что включён режим просмотра
- Кнопка «Выйти» возвращает полный доступ

**Зачем:** Незаменимо для тестирования и демонстрации системы. Админ может за секунду переключиться на любую из 12 ролей и увидеть систему глазами конкретного сотрудника — без выхода из аккаунта, без создания тестовых пользователей. Особенно полезно при показе клиентам/руководству: «вот что видит продажник, а вот что закупщик».

### Чек-лист перед передачей в закупки
При нажатии «Передать в закупки» теперь открывается модальное окно с обязательными вопросами:
- Это проценка? / Это тендер? / Запрос напрямую? / Через торгующую организацию?
- Описание оборудования (обязательное текстовое поле)

Ответы сохраняются и отображаются в закупках жёлтой карточкой «Информация от отдела продаж».

**Зачем:** Закупщики сразу получают контекст от продажника — не нужно переспрашивать.

## Изменения интерфейса

### Объединение страниц сделок и финансов в КП
Отдельные страницы /deals и /finance **удалены**. Вся информация по сделке теперь на странице КП:
- Вкладка «Сделка» — основная информация + план-факт сводка
- Вкладка «План-факт» — реестр платежей
- Вкладка «Логистика (сделка)» — этапы доставки

Прямые ссылки /finance/{id} автоматически редиректят на /quotes/{id}?tab=finance_main.

### Двухрядная раскладка вкладок
У КП с активной сделкой стало 11 вкладок — не помещались в одну строку. Теперь:
- 1-й ряд: рабочие вкладки (Продажи, Закупки, Логистика, Таможня, Контроль, Кост-анализ, Документы, Цепочка)
- 2-й ряд: финансовые вкладки с лейблом «Финансы:» (Сделка, План-факт, Логистика)

### Редизайн списка КП
Компактные карточки со статусом, клиентом, суммой и прогресс-баром workflow.

### Редизайн страницы сделки
Три вкладки: Основное / План-факт / Логистика. Платежи добавляются через модальное окно.

### Карточки логистических этапов
Горизонтальные карточки с загрузкой файлов вместо длинной таблицы.

### Дашборд для продажника
Блоки-сводки: активные КП, ожидающие действий, последние изменения.

### Вкладка «Сводка» на странице КП
Новая вкладка по умолчанию при открытии КП. Показывает 6 информационных карточек:
- Основная информация (клиент, ИНН, продавец, контактное лицо)
- Доставка (тип сделки, базис, страна, город)
- Дополнительная информация (тендер, источник, создатель)
- Порядок расчётов (условия, предоплата, валюта, курс)
- Итого (общая сумма + профит в валюте КП, кол-во позиций)
- Информация для печати (дата выставления, срок действия)

**Зачем:** Мгновенный обзор всех ключевых данных КП без переключения между вкладками. Особенно полезно для руководителей и контроллёров.

### Шапка КП на всех вкладках
Компактная однострочная шапка: IDN | статус | клиент | сумма — видна на каждой из 11 вкладок. Позволяет всегда знать, в каком КП находишься.

### Счётчик дней ожидания оплаты (ЕРПС)
В таблице «Контроль платежей» появилась колонка «Дней ожидания оплаты» с цветовой индикацией:
- Зелёный: < 30 дней или «Оплачено»
- Жёлтый: 30–60 дней
- Красный: > 60 дней

**Зачем:** Финансист сразу видит просроченные платежи и степень срочности.

### Профиль договора — тип и дата окончания
В договорах появились два новых поля:
- Тип: «единоразовый» или «пролонгируемый» (цветная метка в списке)
- Дата окончания

**Зачем:** Позволяет отслеживать сроки и типы договоров, планировать пролонгации.

## Администрирование

- Очистка ролей: 86 → 12 актуальных (миграция 168)
- Унификация UI расходов логистики с интерфейсом план-факта
- Перевод имён ролей head_of_* на русский в баннере и сайдбаре имперсонации

## Что изменилось для каждой роли

| Роль | Что нового |
|------|-----------|
| **Админ** | Имперсонация ролей (полный перевод), двухрядные вкладки, объединённые страницы финансов |
| **Продажник** | Дашборд с блоками-сводками, чек-лист перед передачей в закупки, новый дизайн списка КП, вкладка «Сводка» |
| **Закупщик** | Видит чек-лист от продажника, унифицированный UI расходов |
| **Логист** | Карточки этапов с загрузкой файлов |
| **Финансист** | Финансовые вкладки прямо на странице КП, счётчик дней ожидания оплаты в ЕРПС |
| **Все роли** | Шапка КП (IDN + клиент + сумма) на всех вкладках |

## Статистика

- **17 коммитов**, 7 миграций (167–173)
- **2260 тестов** проходят
- **~18 задач** выполнено за день (3 сессии)
