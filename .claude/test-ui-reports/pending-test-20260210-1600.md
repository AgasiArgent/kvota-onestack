BROWSER TEST
timestamp: 2026-02-10T16:00:00+03:00
session: 2026-02-10 #1
base_url: https://kvotaflow.ru

CONTEXT: Re-test after bug fixes from report-20260210-1500.md. 4 bugs were fixed:
1. `transition_quote` NameError → fixed to `transition_quote_status`
2. SellerCompany enum mismatch → DB name updated to match calculation engine
3. delivery_city/country form sync → removed conflicting hx_patch attributes
4. JS errors → DOMContentLoaded wrapper added, dead `text` variable removed

Use the SAME quote from previous test: Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246)
The quote should still be in `pending_quote_control` status from previous testing session.

---

TASK: Re-test Task 5 — Calculation with RAD seller company
URL: /quotes/ba4a486f-d2cb-4356-8832-db9db3c54246
STEPS:
1. Navigate to quote detail page
2. Change seller company back to RAD (if it was changed to MBR during previous testing)
3. Go to /quotes/ba4a486f-d2cb-4356-8832-db9db3c54246/calculate
4. Click "Обновить" to trigger calculation
5. Verify calculation succeeds WITHOUT SellerCompany enum error
6. Check that results show total, profit, margin
7. Click "Сохранить расчёт"
EXPECT: Calculation succeeds with RAD seller company. No "is not a valid SellerCompany" error.

---

TASK: [86af8hcmv] P1.3 — Janna's 7-point Quote Control Checklist
URL: /quote-control/ba4a486f-d2cb-4356-8832-db9db3c54246
STEPS:
1. Navigate to quote control page
2. Verify EXACTLY 7 checklist items (not old 11-item checklist):
   - Пункт 1: "Наценка vs условия оплаты" — should show ACTUAL markup % vs MINIMUM markup %.
     Minimum depends on payment terms: 100% предоплата = 8% (поставка) / 0% (транзит),
     100% постоплата = 15%/8%, частичная = 12.5%/5%.
     If actual < minimum → RED status indicator. If OK → GREEN.
   - Пункт 2: "Цены КП ↔ инвойс закупки" — should compare quote item prices with supplier invoice prices.
     Shows match/mismatch per item. If no invoices linked → warning.
   - Пункт 3: "Страна + НДС" — if supplier country is Turkey, Poland, or Lithuania →
     should show WARNING flag "Уточните НДС с МОЗ". Other countries → OK.
   - Пункт 4: "Логистика" — INFO only, shows logistics cost breakdown by segment.
     No action needed, just reference data.
   - Пункт 5: "Таможня" — INFO only, shows duties, excise, licenses (ДС/СС/СГР).
     No action needed, just reference data.
   - Пункт 6: "% курсовой разницы" — auto-calculated:
     0% if 100% prepayment, 1.5% if 50/50, 3% default.
     Should show the calculated value.
   - Пункт 7: "Откат/вознаграждение" — if LPR reward > 0, should flag for approval.
3. For each AUTO item (1, 2, 3, 6): verify it shows a calculated value, not empty or error
4. For each INFO item (4, 5): verify it shows reference data from the quote
5. Check if "Требуется согласование" banner appears (should appear for RUB currency quotes)
6. Check buttons at bottom: should see "Одобрить" / "Вернуть на доработку" / "Запросить согласование"
7. Click "Одобрить" or "Отправить на согласование"
8. Verify NO Python error (previously: `transition_quote is not defined`)
9. Check that status transitions correctly away from pending_quote_control
EXPECT: 7-item checklist renders with calculated values. Auto items show real data. Approval/transition works without errors.

---

TASK: Re-test Task 7 — Approval + PDF Generation
URL: (depends on status after Task 6)
STEPS:
1. If approval was requested → check that approval record exists
2. If top-manager approval needed → simulate approval (or check the flow)
3. Once approved → navigate to quote detail page
4. Click "Specification PDF" export button
5. Verify PDF downloads successfully
6. Check PDF contains: quote IDN (Q-202602-0073), items, totals
7. Click "Invoice PDF" if available
EXPECT: PDF generation works. Document contains correct data.

---

TASK: Re-test Task 8 — Specification Creation
URL: /spec-control/create/ba4a486f-d2cb-4356-8832-db9db3c54246
STEPS:
1. After quote is approved, navigate to spec creation page
2. Fill required fields if any
3. Create specification
4. Verify specification gets auto-number (format: contract-number-N)
5. Check that IDN-SKU from quote items carries over to specification
6. Navigate to /spec-control to verify spec appears in list
EXPECT: Specification created successfully with proper numbering and IDN-SKU.

---

TASK: Re-test Task 9 — Spec Signing + Deal + ERPS
URL: (spec detail page)
STEPS:
1. Navigate to specification detail page
2. Upload signed scan (or simulate signing flow)
3. Verify status transitions to "signed"
4. Check that Deal is auto-created
5. Navigate to /finance → ERPS tab
6. Verify specification appears in ERPS registry
7. Check columns: sum, profit, payment status, days until payment
EXPECT: Full pipeline: signing → deal creation → ERPS registry entry.

---

TASK: Re-test Task 10 — Console Errors
URL: /quotes/ba4a486f-d2cb-4356-8832-db9db3c54246
STEPS:
1. Navigate to quote detail page
2. Open browser console (check for errors)
3. Verify: NO "Cannot read properties of null (reading 'addEventListener')" error
4. Verify: NO "text is not defined" error in updateThemeIcon
5. Navigate to 2-3 other pages (/procurement, /customers, /admin)
6. Check console on each page
EXPECT: No recurring JS errors. favicon 404 and Tailwind CDN warning are acceptable (known, low priority).

---

TASK: Verify delivery_city/country form defaults
URL: /quotes/new
STEPS:
1. Create a new quote (click "+ Новый запрос" or navigate to /quotes/new)
2. After redirect to new quote detail page, check delivery_city field
3. Check delivery_country field
4. Both should show placeholder text "Москва" / "Россия" (not as submitted values)
5. Try to submit "Передать в закупки" WITHOUT filling delivery fields
6. Verify that validation catches empty delivery fields (they should be required)
EXPECT: Placeholder text visible but fields are actually empty. Form validation works correctly.

---

---

TASK: [P1.8] Payment countdown indicators on ERPS registry
URL: /finance?tab=erps
STEPS:
1. Navigate to /finance and click ERPS tab (or go directly to /finance?tab=erps)
2. Look for "Дней до оплаты" column (days_until_advance):
   - Green badge (>7 days): should show "N дней" with green background
   - Yellow badge (1-7 days): should show "N дней" with yellow background
   - Red badge (<=0): should show "ПРОСРОЧЕНО N дн." with red background
   - If no data: gray "-"
3. Look for "Остаток к оплате" column (remaining_payment_usd):
   - Should show dollar amount + percentage: "$X,XXX.XX (XX.X%)"
   - Red text if >50% unpaid, amber if 20-50%, green if <20%
4. Scroll to bottom of table — check summary footer:
   - Row 1: "ИТОГО К ПОЛУЧЕНИЮ:" with total outstanding amount in USD
   - Row 2: "ПРОСРОЧЕНО:" with count of overdue specifications
   - Row 3: "СРОЧНО (1-7 дней):" with count of urgent specifications
5. Try switching views (Полный, Компактный, Финансы, etc.) — indicators should persist
6. Check console for JS errors
EXPECT: Color-coded payment indicators visible. Summary footer with totals at bottom. No console errors.

---

REPORT_TO: .claude/test-ui-reports/report-20260210-1600.md
