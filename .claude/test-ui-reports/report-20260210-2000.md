# Browser Test Report

**Timestamp:** 2026-02-10T20:50:00+03:00
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Commit:** 5f0c903 (kwargs unwrap fix)
**Overall:** 2/3 PASS, 0 PARTIAL, 1 FAIL

---

## Task: [BUG-A3 VERIFY] Spec form save — contract, delivery_days, auto-number persistence
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2
**Status:** FAIL (all 3 bugs still present)

| # | Step | Result | Details |
|---|------|--------|---------|
| 1 | Navigate to spec page | PASS | Spec in "Черновик" status (already draft from previous test) |
| 2 | Select contract | PASS | Selected "ДП-20260201 от 2026-02-01" (value: 60b109ff-81e0-4798-9750-f3daa62154a0) |
| 3 | Enter delivery_days = 44 | PASS | Filled spinbutton with 44 (replaced debug marker 777) |
| 4 | Pre-save JS verification | PASS | contract=60b109ff, delivery_days=44 |
| 5 | Click Сохранить | PASS | Page reloaded |
| 6a | Post-save: contract | FAIL | Reverted to "-- Без привязки к договору --" (value: "") |
| 6b | Post-save: spec number | FAIL | Still "Без номера" (value: "") |
| 6c | Post-save: delivery_days | FAIL | Cleared to empty (value: "") |
| 7 | DB verification | FAIL | delivery_days=NULL, contract_id=NULL, specification_number=NULL |

### Server Logs — NEW ROOT CAUSE

```
/usr/local/lib/python3.12/site-packages/fasthtml/core.py:199: UserWarning: `kwargs has no type annotation and is not a recognised special name, so is ignored.
```

**FastHTML is IGNORING the `kwargs` parameter entirely** because it has no type annotation and is not a recognized special name. The form data never reaches the handler.

### Previous vs Current Root Cause

| Aspect | Previous (report-20260210-1930) | Current (this report) |
|--------|-------------------------------|----------------------|
| Debug markers | `delivery_days=777` saved | Debug markers removed |
| `[DEBUG spec-save]` lines | Present, showed `kwargs['kwargs']` nesting | No DEBUG lines (removed in fix commit) |
| FastHTML warning | Not checked | **`kwargs has no type annotation and is not a recognised special name, so is ignored`** |
| DB result | delivery_days=777 | delivery_days=NULL |

### Diagnosis

The kwargs unwrap fix (commit 5f0c903) did NOT resolve the issue. The problem is at the **FastHTML framework level**: FastHTML's route handler parameter resolution ignores any parameter named `kwargs` that lacks a type annotation. The form data is being silently dropped before the handler ever sees it.

### Fix Direction

The POST handler MUST NOT use `**kwargs` or a parameter named `kwargs`. Instead:
1. **Use explicit named parameters** for each form field: `contract_id: str = '', delivery_days: str = '', ...`
2. **OR use `request: Request`** and call `form = await request.form()` to get all form data
3. **OR use FastHTML's `Starlette` form data convention** (check FastHTML docs for the correct pattern)

**Console Errors:** none

---

## Task: [BUG-C2 RE-VERIFY] Admin deal creation still works
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2 → /deals
**Status:** PASS

| # | Step | Result | Details |
|---|------|--------|---------|
| 1 | Status already Черновик | PASS | From previous test save |
| 2 | Click "Подписана" | PASS | Status changed to Подписана |
| 3 | Green "Сделка создана" message | PASS | "Спецификация подписана. Сделка создана." — GREEN (rgb(22,163,74) = #16a34a) |
| 4 | Navigate to /deals | PASS | Both deals visible |
| 5 | DEAL-2026-0002 present | PASS | Test Company E2E, 581,839.50 USD, 2026-02-10, "В работе" |
| 6 | DEAL-2026-0001 present | PASS | Test Company E2E, 175,283.94 USD, 2026-02-02, "В работе" |
| 7 | Stats correct | PASS | 2 in work, 757,123 ₽ |

**Console Errors:** none
**Verdict:** Deal creation works correctly after kwargs fix. No regression.

---

## Task: [FULL RE-VERIFY] All previously fixed bugs
**URL:** various
**Status:** PASS (all 3 checks)

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | /dashboard?tab=spec-control — no duplicate | PASS | Q-202602-0073 appears ONCE in "Подписаны" section (row 6). 7 records total. |
| 2 | /finance?tab=erps — spec_sum_usd non-zero | PASS | Row 1: $2,232.12, Row 2: $7,409.33. ИТОГО: $9,641.45. 30 columns, 2 specs. |
| 3 | /deals — all deals visible | PASS | DEAL-2026-0002 (581,839.50 USD) + DEAL-2026-0001 (175,283.94 USD). FK resolution correct. |

**Console Errors:** none across all 3 pages

---

## Console Errors (all tasks)
None (0 errors across all tested pages)

---

## Summary

| Task | Status | Notes |
|------|--------|-------|
| BUG-A3: Spec persistence | **FAIL** | kwargs fix didn't work — FastHTML ignores `kwargs` param entirely |
| BUG-C2: Deal creation | **PASS** | Green "Сделка создана", deals visible, no regression |
| Full re-verify (3 checks) | **PASS** | No duplicate, ERPS amounts correct, deals visible |

**PASS: 2/3 | FAIL: 1/3**

---

## Bugs Still Open

### MAJOR — Spec form save (same 3 bugs, UPDATED root cause)
1. **Contract selection not persisted** — FastHTML drops form data
2. **Spec auto-numbering broken** — no specification_number generated
3. **Delivery days cleared on save** — FastHTML drops form data

### ROOT CAUSE (UPDATED)
**FastHTML framework warning:** `kwargs has no type annotation and is not a recognised special name, so is ignored`

The POST handler uses a parameter (likely `**kwargs` or `kwargs`) that FastHTML does not recognize. FastHTML silently ignores it, meaning ALL form data is dropped. The previous debug test (report-20260210-1930) showed `all_kwargs_keys=['kwargs']` because FastHTML was wrapping form data in a way the handler couldn't access.

**The fix must change the handler signature** — not just how it reads from kwargs, but how FastHTML delivers the form data to the handler in the first place.

### MEDIUM — Still present
4. **ERPS IDN column empty** — downstream of bugs #1-3 (spec number never set)

---

## ACTION for Terminal 1

**The kwargs unwrap fix (commit 5f0c903) did NOT work.** FastHTML ignores the `kwargs` parameter entirely.

**Evidence:** FastHTML warning in server logs:
```
fasthtml/core.py:199: UserWarning: `kwargs has no type annotation and is not a recognised special name, so is ignored.
```

**Required fix:** Change the POST handler signature. Do NOT use `**kwargs` or a bare `kwargs` parameter. Options:
1. Use explicit named parameters with type annotations: `contract_id: str = '', delivery_days: int = 0, specification_number: str = '', ...`
2. Use Starlette's `request: Request` + `await request.form()`
3. Check how OTHER working POST handlers in main.py handle form data (e.g., quote save, customer inline edit) and follow the same pattern
