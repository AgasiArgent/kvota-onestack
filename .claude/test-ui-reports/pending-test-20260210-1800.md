BROWSER TEST
timestamp: 2026-02-10T18:00:00+03:00
session: 2026-02-10 #1
base_url: https://kvotaflow.ru

CONTEXT: Re-test after 4 bug fix groups from report-20260210-1600.md.
Use quote Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246).
NOTE: Migrations 160 + 161 must be applied on VPS before testing.

---

TASK: [Group A] Spec creation — contract, delivery_days, auto-number persistence
URL: /spec-control/create/ba4a486f-d2cb-4356-8832-db9db3c54246
STEPS:
1. Navigate to spec creation page for Q-202602-0073
2. Select a contract from dropdown (e.g., "ДП-20260201 от 2026-02-01")
3. Note the delivery_days value (should be auto-filled, e.g., 44)
4. Click "Создать спецификацию"
5. On the spec detail page, verify:
   a. Contract is shown (NOT "Без привязки к договору")
   b. Spec number auto-generated (e.g., "ДП-20260201-2", NOT "Без номера")
   c. Delivery days shows the value from step 3 (NOT empty)
6. Navigate to /dashboard?tab=spec-control — verify spec appears in "Черновики"
EXPECT: All 3 fields (contract, auto-number, delivery_days) persist after save.

---

TASK: [Group B] No duplicate in spec-control list
URL: /dashboard?tab=spec-control
STEPS:
1. After creating the spec in Group A test above, navigate to /dashboard?tab=spec-control
2. Search for Q-202602-0073 in the list
3. Count how many times it appears
4. Check "Ожидают спецификации" section — Q-202602-0073 should NOT be there (it already has a spec)
5. Check "Черновики" section — the new spec SHOULD be there
6. Verify no duplicate entries for the same quote
EXPECT: Quote appears ONLY in "Черновики" (as a spec), NOT in both "Ожидают" and "Черновики".

---

TASK: [Group C] Deal visible in /deals after spec signing
URL: /spec-control/{spec_id} (use the spec created in Group A test)
STEPS:
1. Navigate to the spec detail page
2. Change spec status to "Подписана" (signed) via admin controls
3. Verify message: "Спецификация подписана. Сделка создана."
4. Navigate to /deals (or /finance with deals tab)
5. Look for the NEW deal — should appear in list with:
   - Customer name (Test Company E2E)
   - Spec number
   - Quote IDN (Q-202602-0073)
   - Amount
6. Click on the deal row — verify detail page loads without errors
7. Verify old deal DEAL-2026-0001 also still visible
EXPECT: New deal appears in /deals list immediately. Detail page loads. No PostgREST errors.

---

TASK: [ERPS View] spec_sum_usd shows correct amount (not $0.00)
URL: /finance?tab=erps
STEPS:
1. Navigate to /finance → ERPS tab
2. Find the spec from our test quote in the ERPS registry
3. Check "Сумма спец. USD" column — should show actual amount (NOT $0.00)
4. Check "Остаток к оплате USD" column — should show amount with percentage
5. Check "Профит USD" — should still show correct value ($757.31 or similar)
6. Check summary footer: "ИТОГО К ПОЛУЧЕНИЮ" should show non-zero total
7. Switch to "Финансы" view — verify payment columns are NOW visible:
   - "Остаток дней до аванса"
   - "Остаток к оплате USD"
   - "Остаток %"
8. Check console for errors
EXPECT: Spec sum shows real USD amount. Payment columns visible in Финансы view. Footer totals correct.

---

TASK: [P1.8 re-verify] Payment countdown badges with real data
URL: /finance?tab=erps
STEPS:
1. After ERPS view fix, check if any specs now have non-zero sums
2. Look for color-coded badges in "Дней до оплаты" column:
   - Green (>7 days) / Yellow (1-7 days) / Red (overdue) / Gray (no deadline)
3. Look for color-coded amounts in "Остаток к оплате USD":
   - Red (>50% unpaid) / Amber (20-50%) / Green (<20%)
4. If no deadline data exists, badges will show gray "-" (this is correct)
5. Verify summary footer counts match visible data
EXPECT: If deadline data exists, colored badges render correctly. If not, gray "-" is acceptable.

---

REPORT_TO: .claude/test-ui-reports/report-20260210-1800.md
