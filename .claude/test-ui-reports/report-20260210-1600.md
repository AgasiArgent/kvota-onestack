# Browser Test Report

**Timestamp:** 2026-02-10T17:25:00+03:00
**Session:** 2026-02-10 #1 (re-test after bug fixes)
**Base URL:** https://kvotaflow.ru
**Quote:** Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246)
**Overall:** 5/7 PASS, 1 PARTIAL, 1 PARTIAL

---

## Task: Re-test Task 5 — Calculation with RAD seller company
**URL:** /quotes/ba4a486f-d2cb-4356-8832-db9db3c54246/calculate
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to quote detail | PASS | Page loaded, status was pending_quote_control |
| 2 | Change seller to RAD | PASS | Changed from MBR to RAD via dropdown |
| 3 | Navigate to /calculate | PASS | Calculate page loaded with pricing form |
| 4 | Click "Обновить" | PASS | Calculation succeeded without SellerCompany enum error |
| 5 | Verify results | PASS | Total: 581,840, Profit: 59,470, Margin: 15.0% |
| 6 | Click "Сохранить расчёт" | PASS | Saved as v2 |

**Console Errors:** none
**Previously:** FAIL (SellerCompany enum mismatch). **Now FIXED.**

---

## Task: [86af8hcmv] P1.3 — Janna's 7-point Quote Control Checklist
**URL:** /quote-control/ba4a486f-d2cb-4356-8832-db9db3c54246
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to quote control | PASS | Page loaded |
| 2 | Verify 7 checklist items | PASS | Exactly 7 items displayed (not old 11) |
| 3 | Пункт 1: Наценка vs оплата | PASS | 15.0% actual vs 12.5% min — GREEN |
| 4 | Пункт 2: Цены КП ↔ инвойс | PASS | Shows "Нет инвойсов поставщиков" warning |
| 5 | Пункт 3: Страна + НДС | PASS | "Все страны стандартные" — OK |
| 6 | Пункт 4: Логистика | PASS | Shows 136,641.00 — INFO |
| 7 | Пункт 5: Таможня | PASS | "Не указана" — INFO |
| 8 | Пункт 6: Курсовая разница | PASS | 3.0% — "Предоплата не указана" |
| 9 | Пункт 7: Откат/ЛПР | PASS | "Нет" — OK |
| 10 | Click "Отправить на согласование" | PASS | Approval form loaded |
| 11 | Submit approval request | PASS | "Успешно - Отправлено менеджеру продаж" |
| 12 | Verify no transition_quote error | PASS | No Python error! Previously: NameError |

**Console Errors:** none
**Previously:** FAIL (transition_quote NameError). **Now FIXED.**

---

## Task: Re-test Task 7 — Approval + PDF Generation
**URL:** /quotes/ba4a486f-d2cb-4356-8832-db9db3c54246
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Submit justification | PASS | Filled business case, submitted. "КП отправлено на согласование", 1 approval request created |
| 2 | Check approvals page | PASS | Shows pending approval with reason + justification text |
| 3 | Approve as top-manager | PASS | Clicked "Одобрить" — status changed to "Одобрено" |
| 4 | Mark as sent to client | PASS | Clicked "Отправлено клиенту" — status "Отправлено", 3 response options visible |
| 5 | Test Specification PDF | PASS | Downloaded specification_TestCompanyE2E_2026-02-10_0.pdf |
| 6 | Test Invoice PDF | PASS | Downloaded invoice_TestCompanyE2E_2026-02-10_0.pdf |
| 7 | Client agrees → Specification | PASS | Status changed to "Спецификация", steps 1-7 all ✓ |

**Console Errors:** none
**Full workflow tested:** justification → approval → send to client → client agrees → spec stage

---

## Task: Re-test Task 8 — Specification Creation
**URL:** /spec-control/create/ba4a486f-d2cb-4356-8832-db9db3c54246
**Status:** PARTIAL PASS (3 bugs found)

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec creation | PASS | Form loaded with quote info (Q-202602-0073, 581,839.50 RUB) |
| 2 | Select contract | PASS | Selected "ДП-20260201 от 2026-02-01 (след.спец: №1)" |
| 3 | Create specification | PASS | Redirected to spec detail page |
| 4 | Auto-number from contract | FAIL | Spec number still "Без номера" — contract selection didn't generate auto-number |
| 5 | Contract persists after save | FAIL | Contract reverted to "Без привязки к договору" after save |
| 6 | Delivery days persist | FAIL | Was 44, cleared to empty after save |
| 7 | Verify spec in list | PASS | Appears in /dashboard?tab=spec-control as Черновик |
| 8 | Duplicate entry in list | BUG | Q-202602-0073 appears TWICE — once as "Ожидает" and once as "Черновик" |

**Console Errors:** none

**Bugs:**
1. **MAJOR: Contract selection not persisted** — Selecting a contract on spec creation form doesn't carry over to spec detail. After save, reverts to "Без привязки к договору".
2. **MAJOR: Auto-numbering broken** — Spec number should auto-generate as "ДП-20260201-1" when contract is selected, but stays "Без номера".
3. **MAJOR: Delivery days cleared on save** — Value 44 (auto-filled from calculation) is lost after save.
4. **MEDIUM: Duplicate in spec-control list** — Same quote appears in both "Ожидают спецификации" and "Черновики" sections simultaneously.

---

## Task: Re-test Task 9 — Spec Signing + Deal + ERPS
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2
**Status:** PARTIAL PASS (2 bugs found)

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec detail | PASS | Spec page loaded in "Черновик" status |
| 2 | Sign via admin panel | PASS | Clicked "Подписана" — status changed, fields locked |
| 3 | Verify "Сделка создана" message | PASS | Message: "Спецификация подписана. Сделка создана." |
| 4 | Check deals page | FAIL | Only old deal DEAL-2026-0001 visible (from 2026-02-02). New deal not appearing in list. |
| 5 | Check ERPS registry | PARTIAL | Spec appears in ERPS (row 2, profit $757.31) but IDN empty and sum shows $0.00 |
| 6 | Upload signed scan section | PASS | "Choose File" + "Загрузить скан" visible on signed spec |

**Console Errors:** none

**Bugs:**
1. **MAJOR: New deal not visible in /deals** — Message says deal created, but /deals only shows old deal. Either deal wasn't actually created or it's filtered out.
2. **MAJOR: ERPS IDN column empty** — Should show spec number/IDN.
3. **MAJOR: ERPS sum shows $0.00** — Should show spec total amount ($7,409).

---

## Task: Re-test Task 10 — Console Errors
**URL:** Multiple pages tested
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | /quotes/{uuid} | PASS | 0 errors, 2 warnings (Tailwind CDN + deprecated stylesheet) |
| 2 | /customers | PASS | 0 errors, 1 warning (Tailwind CDN) |
| 3 | /admin | PASS | 0 errors, 1 warning (Tailwind CDN) |
| 4 | No "addEventListener" error | PASS | Not observed on any page |
| 5 | No "text is not defined" error | PASS | Not observed on any page |

**Console Errors:** none (only Tailwind CDN warnings — known, acceptable)
**Previously:** JS errors on multiple pages. **Now FIXED.**

---

## Task: Verify delivery_city/country form defaults
**URL:** /quotes/new
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Create new quote | PASS | Q-202602-0074 created, redirected to detail |
| 2 | Check delivery_city | PASS | Empty field with placeholder "Введите город" |
| 3 | Check delivery_country | PASS | Empty field with placeholder "Введите страну" |
| 4 | Fields genuinely empty | PASS | No pre-filled values, just placeholder text |
| 5 | "Передать в закупки" button | PASS | Button appears disabled (no cursor=pointer) — validation active |

**Note:** Placeholders are "Введите город"/"Введите страну" (not "Москва"/"Россия" as test expected). This is actually better — more descriptive and no false impression of default values.

**Console Errors:** none

---

## Console Errors (all tasks)
None across all tested pages. Only Tailwind CDN warnings (known, low-priority).

---

## Summary

| Task | Status | Notes |
|------|--------|-------|
| Task 1: RAD Calculation | **PASS** | SellerCompany enum fix confirmed |
| Task 2: 7-point Checklist | **PASS** | transition_quote fix confirmed, 7 items correct |
| Task 3: Approval + PDF | **PASS** | Full workflow: justify → approve → send → PDF export |
| Task 4: Spec Creation | **PARTIAL** | Created but: contract not persisted, no auto-number, delivery_days cleared |
| Task 5: Signing + Deal + ERPS | **PARTIAL** | Signed OK but: deal not visible, ERPS missing IDN + sum |
| Task 6: Console Errors | **PASS** | 0 JS errors on all tested pages |
| Task 7: Delivery Defaults | **PASS** | Fields empty with proper placeholders |

**PASS: 5/7 | PARTIAL: 2/7 | FAIL: 0/7**

## Previously Fixed Bugs (confirmed)
1. `transition_quote` NameError → FIXED (approval works)
2. SellerCompany RAD enum mismatch → FIXED (calculation succeeds)
3. JS errors (addEventListener, text undefined) → FIXED (0 errors)
4. delivery_city/country form sync → FIXED (clean empty fields)

## New Bugs Found (7 total)

### Critical (0)
None

### Major (6)
1. **Spec contract not persisted** — Contract dropdown selection lost on save
2. **Spec auto-numbering broken** — "Без номера" even after contract selected
3. **Spec delivery_days cleared on save** — 44 days value lost after save
4. **Duplicate entry in spec-control list** — Same quote in "Ожидают" and "Черновики"
5. **New deal not visible in /deals** — "Сделка создана" message shown but deal doesn't appear
6. **ERPS sum shows $0.00** — Should show actual spec total

### Medium (1)
7. **ERPS IDN column empty** — Should show spec number/identifier

### Minor (0)
None

---

## ACTION for Terminal 1
Fix the 7 bugs above, priority order:
1. Spec creation save — contract_id, delivery_days, auto-number (likely same root cause in POST handler)
2. Duplicate in spec-control list (filter logic)
3. Deal creation / visibility (check if deal actually created or just message shown)
4. ERPS IDN and sum population
