# Browser Test Report — DEBUG Spec Save

**Timestamp:** 2026-02-10T19:45:00+03:00
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Commit:** 88bf051 (debug markers deployed)
**Overall:** DEBUG COMPLETE — Root cause identified

---

## Task: [BUG-A3 DEBUG] Spec form save — debug markers

### Test Execution

| # | Step | Result | Details |
|---|------|--------|---------|
| 1 | Navigate to spec page | PASS | Spec 36801d1b in "Подписана" status |
| 2 | Reset to Черновик | PASS | Admin panel → Черновик |
| 3 | Select contract | PASS | Selected "ДП-20260201 от 2026-02-01" (value: 60b109ff-81e0-4798-9750-f3daa62154a0) |
| 4 | Enter delivery_days = 44 | PASS | Filled spinbutton with 44 |
| 5 | Pre-save verification | PASS | JS confirms: contract=60b109ff, days=44 |
| 6 | Click Сохранить | PASS | Page reloaded |
| 7 | Post-save: contract | FAIL | Reverted to "-- Без привязки к договору --" |
| 8 | Post-save: spec number | FAIL | Still "Без номера" |
| 9 | Post-save: delivery_days | **777** | Shows debug marker value, NOT 44 and NOT empty |

### Server Logs (DEBUG lines)

```
[DEBUG spec-save] action=save, contract_id=None, delivery_days=None, specification_number=None, all_kwargs_keys=['kwargs']

[DEBUG spec-save UPDATE] spec_id=36801d1b-5785-476e-80dc-fc18610f64a2, update_data_keys=['quote_version_id', 'specification_number', 'proposal_idn', 'item_ind_sku', 'sign_date', 'validity_period', 'specification_currency', 'exchange_rate_to_ruble', 'client_payment_term_after_upd', 'client_payment_terms', 'cargo_pickup_country', 'readiness_period', 'goods_shipment_country', 'delivery_city_russia', 'cargo_type', 'logistics_period', 'delivery_days', 'delivery_days_type', 'our_legal_entity', 'client_legal_entity', 'supplier_payment_country', 'contract_id', 'status'], contract_id=None, delivery_days=777

[DEBUG spec-save RESULT] data=[{...full row..., 'contract_id': None, 'delivery_days': 777, 'specification_number': None}]
```

### Database Query Result

```
 delivery_days | contract_id | specification_number
---------------+-------------+----------------------
           777 |             |
(1 row)
```

**delivery_days = 777** → Save path runs successfully (form data extraction issue)
**contract_id = NULL** → Form value not extracted
**specification_number = NULL** → Auto-generation not triggered

---

## ROOT CAUSE ANALYSIS

### Finding: Form data not being extracted from POST request

The first DEBUG line is the smoking gun:

```
contract_id=None, delivery_days=None, specification_number=None, all_kwargs_keys=['kwargs']
```

**`all_kwargs_keys=['kwargs']`** — The POST handler receives a single `kwargs` dict instead of individual named parameters. This means the form fields (`contract_id`, `delivery_days`, etc.) are bundled inside `kwargs['kwargs']` instead of being top-level parameters.

### Diagnosis

The POST handler signature likely has `**kwargs` but the form data arrives as a dict-within-dict. The handler extracts:
- `contract_id = kwargs.get('contract_id')` → gets `None` (not at top level)
- `delivery_days = kwargs.get('delivery_days')` → gets `None` (not at top level)

But the actual form values are inside `kwargs['kwargs']` (the nested dict).

### Fix Direction

The POST handler needs to either:
1. **Extract from nested dict**: `form_data = kwargs.get('kwargs', kwargs)` then use `form_data.get('contract_id')`
2. **Fix the route signature**: Change from `**kwargs` to explicit `request: Request` and use `form = await request.form()`
3. **Check FastHTML form handling**: The form might need `hx-post` or specific encoding

### Confirmation

- **delivery_days=777** proves the UPDATE query runs and writes to DB correctly
- **contract_id=None** proves the form extraction is broken, not the save logic
- The issue is PURELY in how form data is read from the POST request, not in the DB layer

---

## Console Errors
None across all pages tested.

---

## Summary for Terminal 1

**ROOT CAUSE:** POST handler for spec save receives form data as `kwargs['kwargs']` (nested dict), not as top-level parameters. All form field reads (`kwargs.get('contract_id')`, etc.) return `None` because the values are one level deeper.

**PROOF:** `delivery_days=777` (hardcoded debug) saved to DB successfully. `contract_id=None` and `delivery_days=None` at extraction time despite being set in the form.

**ACTION:** Fix the form data extraction in the POST handler. Check what `kwargs['kwargs']` contains — likely has all the form values. Either destructure it or use `request.form()` directly.
