# Browser Test Report

**Timestamp:** 2026-02-10T18:20:00+03:00
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Quote:** Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246)
**Spec:** 36801d1b-5785-476e-80dc-fc18610f64a2
**Overall:** 2/5 PASS, 1 PARTIAL, 2 FAIL

---

## Task: [Group A] Spec creation — contract, delivery_days, auto-number persistence
**URL:** /spec-control/create/ba4a486f-d2cb-4356-8832-db9db3c54246
**Status:** FAIL (3 bugs still present)

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec creation page | PASS | Redirected to existing spec (36801d1b) in "Подписана" status |
| 2 | Reset spec to Черновик | PASS | Used admin panel to reset status |
| 3 | Select contract from dropdown | PASS | Selected "ДП-20260201 от 2026-02-01" |
| 4 | Note delivery_days value | PASS | Entered 44 days |
| 5 | Click "Сохранить" | PASS | Form submitted successfully |
| 6a | Contract shown after save | FAIL | Reverted to "Без привязки к договору" |
| 6b | Spec number auto-generated | FAIL | Still "Без номера" |
| 6c | Delivery days persisted | FAIL | Cleared to empty after save |

**Console Errors:** none
**Verdict:** All 3 spec creation persistence bugs from report-20260210-1600 are **still present**. Migrations 160+161 did not fix these.

---

## Task: [Group B] No duplicate in spec-control list
**URL:** /dashboard?tab=spec-control
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec-control | PASS | Page loaded with sections |
| 2 | Search for Q-202602-0073 | PASS | Found in list |
| 3 | Count appearances | PASS | Appears exactly ONCE |
| 4 | "Ожидают спецификации" section | PASS | Q-202602-0073 NOT in this section |
| 5 | "Черновики" section | PASS | Q-202602-0073 IS in this section (row 4) |
| 6 | No duplicate entries | PASS | Single entry only |

**Console Errors:** none
**Verdict:** Duplicate bug from report-20260210-1600 is **FIXED**. Quote appears only in "Черновики".

---

## Task: [Group C] Deal visible in /deals after spec signing
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2 → /deals
**Status:** FAIL

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec detail | PASS | Spec in "Черновик" status |
| 2 | Sign via admin "Подписана" | PASS | Status changed, fields locked |
| 3 | Verify "Сделка создана" message | PASS | "Спецификация подписана. Сделка создана." |
| 4 | Navigate to /deals | FAIL | Only DEAL-2026-0001 visible (old deal from 2026-02-02) |
| 5 | Look for new deal | FAIL | New deal not in list |
| 6 | Click on deal row | N/A | No new deal to click |
| 7 | Old deal DEAL-2026-0001 visible | PASS | Still present |

**Console Errors:** none
**Verdict:** Deal visibility bug from report-20260210-1600 is **still present**. Message says deal created but it doesn't appear in /deals list.

---

## Task: [ERPS View] spec_sum_usd shows correct amount (not $0.00)
**URL:** /finance?tab=erps
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to ERPS tab | PASS | Full view loaded, 2 specs, 30 columns |
| 2 | Find test spec in registry | PASS | Both rows visible for "Test Company E2E" |
| 3 | "Сумма спец. USD" column | PASS | Row 1: $2,232.12, Row 2: $7,409.33 (NOT $0.00!) |
| 4 | "Остаток к оплате USD" column | PASS | Row 1: $2,232.12 (100.0%), Row 2: $7,409.33 (100.0%) |
| 5 | "Профит USD" column | PASS | Row 1: $228.04, Row 2: $757.31 |
| 6 | Footer "ИТОГО К ПОЛУЧЕНИЮ" | PASS | $9,641.45 in red (#dc2626) — non-zero total |
| 7 | Switch to Финансы view | PASS | 23 columns (was 16). Payment columns NOW PRESENT: "Остаток дней до аванса", "Планируемая сумма аванса USD", "Всего оплачено USD", "Остаток к оплате USD", "Остаток %" |
| 8 | Console errors | PASS | 0 errors (only Tailwind CDN warning) |

**Console Errors:** none

**Previously broken (report-20260210-1700):**
- spec_sum_usd = $0.00 → **NOW FIXED** ($2,232.12 / $7,409.33)
- Финансы view missing payment columns → **NOW FIXED** (23 cols, includes 'auto' group)

**Still broken:**
- IDN column: empty for both rows (spec number not populated during creation — Group A bug)

---

## Task: [P1.8 re-verify] Payment countdown badges with real data
**URL:** /finance?tab=erps&view=finance
**Status:** PARTIAL PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Non-zero spec sums | PASS | $2,232.12 and $7,409.33 |
| 2 | "Остаток дней до аванса" badges | PASS (gray) | Both rows: gray "-" (#9ca3af) — correct for no-deadline data |
| 3 | Green/yellow/red day badges | UNTESTABLE | No advance deadlines set in test data |
| 4 | "Остаток к оплате USD" color | PASS | Both rows: RED (#dc2626) for >50% unpaid — "$2,232.12 (100.0%)" and "$7,409.33 (100.0%)" |
| 5 | Footer totals match data | PASS | ИТОГО: $9,641.45 (red), ПРОСРОЧЕНО: 0 (red), СРОЧНО: 0 (amber #d97706) |

**Console Errors:** none

**Color coding verified:**

| Element | Value | Color | Hex | Correct? |
|---------|-------|-------|-----|----------|
| Days countdown (no data) | - | Gray | #9ca3af | YES |
| Remaining payment (100% unpaid) | $2,232.12 (100.0%) | Red | #dc2626 | YES (>50%) |
| Remaining payment (100% unpaid) | $7,409.33 (100.0%) | Red | #dc2626 | YES (>50%) |
| Footer: ИТОГО К ПОЛУЧЕНИЮ | $9,641.45 | Red | #dc2626 | YES |
| Footer: ПРОСРОЧЕНО | 0 | Red | #dc2626 | YES |
| Footer: СРОЧНО (1-7 дней) | 0 | Amber | #d97706 | YES |

**Verdict:** Color coding works correctly for available data. Green (>7 days) and Yellow (1-7 days) badge states remain untestable — test specs have no advance payment deadlines set.

---

## Summary

| Task | Status | Notes |
|------|--------|-------|
| Group A: Spec persistence | **FAIL** | contract, delivery_days, auto-number ALL lost on save |
| Group B: No duplicate | **PASS** | Fixed — quote only in "Черновики" |
| Group C: Deal visibility | **FAIL** | "Сделка создана" message but deal not in /deals |
| ERPS View: spec_sum_usd | **PASS** | Fixed — real amounts shown ($2,232.12 / $7,409.33) |
| P1.8: Payment badges | **PARTIAL** | Red color coding works; green/yellow untestable (no deadlines) |

**PASS: 2/5 | PARTIAL: 1/5 | FAIL: 2/5**

---

## Bugs Still Open (from report-20260210-1600)

### MAJOR — Still broken (3)
1. **Spec contract not persisted** — Contract dropdown selection lost on save
2. **Spec auto-numbering broken** — "Без номера" even after contract selected
3. **Spec delivery_days cleared on save** — 44 days value lost after save

### MAJOR — Still broken (1)
4. **New deal not visible in /deals** — Message says created but not in list

### MEDIUM — Still broken (1)
5. **ERPS IDN column empty** — Downstream of bug #2 (spec number never set)

### FIXED (3)
6. ~~Duplicate in spec-control list~~ → **FIXED** (appears only in Черновики)
7. ~~ERPS spec_sum_usd shows $0.00~~ → **FIXED** (now shows real USD amounts)
8. ~~Финансы view missing payment columns~~ → **FIXED** (23 cols with auto group)

---

## ACTION for Terminal 1

### Priority 1: Spec creation POST handler (bugs 1-3, same root cause)
The POST handler for spec creation is not saving `contract_id`, `delivery_days`, and not generating `specification_number` from the contract. These 3 fields are likely all handled in the same code path — the POST handler probably doesn't extract them from the form data or doesn't include them in the INSERT.

### Priority 2: Deal creation / visibility (bug 4)
The "Сделка создана" message appears, suggesting the deal creation code runs, but the deal doesn't show in /deals. Possible causes:
- Deal is created but the /deals query filters it out (e.g., missing required fields)
- Deal creation fails silently after showing the success message
- Deal is created in wrong organization scope

### Note: Bug 5 (IDN empty) resolves automatically once bug 2 (auto-numbering) is fixed.
