# Browser Test Report

**Timestamp:** 2026-02-10T19:30:00+03:00
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Quote:** Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246)
**Spec:** 36801d1b-5785-476e-80dc-fc18610f64a2
**Overall:** 4/5 PASS, 0 PARTIAL, 1 FAIL

---

## Task: [BUG-A2] Spec update persistence — contract, delivery_days, auto-number
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2
**Status:** FAIL (all 3 bugs still present)

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec page | PASS | Redirected to existing spec in "Подписана" status |
| 2 | Reset to Черновик | PASS | Admin panel → Черновик, fields unlocked |
| 3 | Select contract | PASS | Selected "ДП-20260201 от 2026-02-01" |
| 4 | Enter delivery_days = 44 | PASS | Typed 44 in spinbutton |
| 5 | Click Сохранить | PASS | Page reloaded |
| 6a | Contract persisted | FAIL | Reverted to "-- Без привязки к договору --" (value: "") |
| 6b | Spec number auto-generated | FAIL | Still "Без номера" (value: "") |
| 6c | Delivery days persisted | FAIL | Cleared to empty (value: "") |

**Console Errors:** none
**Verdict:** All 3 spec creation persistence bugs are **STILL NOT FIXED**. The POST handler for spec update does not save contract_id, delivery_days, or generate specification_number.

---

## Task: [BUG-C2] Admin deal creation when setting status to "signed"
**URL:** /spec-control/36801d1b-5785-476e-80dc-fc18610f64a2 → /deals
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec detail | PASS | Spec in "Черновик" (from previous test) |
| 2 | Reset to Черновик | N/A | Already in Черновик |
| 3 | Set status to Подписана | PASS | Clicked admin "Подписана" button |
| 4 | Check message | PASS | "Спецификация подписана. Сделка создана." — GREEN with check-circle icon (color: #16a34a) |
| 5 | Navigate to /deals | PASS | Page loaded, 2 deals visible |
| 6 | New deal in list | PASS | DEAL-2026-0002: Test Company E2E, 581,839.50 USD, 2026-02-10, "В работе" |
| 7 | Click deal detail | PASS | Detail page loads: deal info, plan-fact section, payment buttons, no errors |

**Console Errors:** none
**Verdict:** Deal creation from admin signing **NOW WORKS**. Previously showed "Сделка не создана." — now shows green "Сделка создана." and deal appears in /deals list with correct data. Detail page loads cleanly.

**Note:** Previously (initial page load before test), the message was "Сделка не создана." (amber). After resetting to Черновик and re-signing, it shows "Сделка создана." (green). This suggests the fix requires a fresh Черновик→Подписана transition for the deal to be created.

---

## Task: [RE-VERIFY] Group B — no duplicate in spec-control list
**URL:** /dashboard?tab=spec-control
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to spec-control | PASS | Page loaded: 7 records total |
| 2 | Search for Q-202602-0073 | PASS | Found in row 6 |
| 3 | Count appearances | PASS | Appears exactly ONCE |
| 4 | Correct section | PASS | In "Подписаны" section (correct status) |
| 5 | Not in other sections | PASS | Not in "Ожидают" or "Черновики" |

**Console Errors:** none
**Sections breakdown:**
- Ожидают спецификации (3): Q-202601-0014, Q-202601-0003, Q-202601-0001
- Черновики (2): Q-202601-0016, Q-202601-0004
- Подписаны (2): **Q-202602-0073**, Q-202602-0044

---

## Task: [RE-VERIFY] ERPS View — spec_sum_usd shows correct amount
**URL:** /finance?tab=erps
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to ERPS tab | PASS | Full view, 2 specs, 30 columns |
| 2 | Spec sum USD — Row 1 | PASS | $2,232.12 (NOT $0.00) |
| 3 | Spec sum USD — Row 2 | PASS | $7,409.33 (NOT $0.00) |
| 4 | Profit USD | PASS | $228.04 / $757.31 |
| 5 | Footer ИТОГО К ПОЛУЧЕНИЮ | PASS | $9,641.45 (non-zero) |
| 6 | Remaining payment | PASS | $2,232.12 (100.0%) / $7,409.33 (100.0%) |

**Console Errors:** none

---

## Task: [RE-VERIFY] Deal visibility in /deals after spec signing
**URL:** /deals
**Status:** PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to /deals | PASS | Page loaded, stats: 2 in work, 757,123 ₽ |
| 2 | DEAL-2026-0001 (old) | PASS | Visible: Test Company E2E, 175,283.94 USD, 2026-02-02 |
| 3 | DEAL-2026-0002 (new) | PASS | Visible: Test Company E2E, 581,839.50 USD, 2026-02-10 |
| 4 | Deal detail loads | PASS | Click → detail page with info, plan-fact, payments sections |
| 5 | FK resolution | PASS | Customer name "Test Company E2E" resolved correctly |

**Console Errors:** none

---

## Summary

| Task | Status | Notes |
|------|--------|-------|
| BUG-A2: Spec persistence | **FAIL** | contract, delivery_days, auto-number ALL lost on save |
| BUG-C2: Admin deal creation | **PASS** | Green "Сделка создана", deal visible in /deals, detail loads |
| RE-VERIFY: No duplicate | **PASS** | Q-202602-0073 appears once in "Подписаны" |
| RE-VERIFY: ERPS spec_sum | **PASS** | $2,232.12 / $7,409.33 (non-zero) |
| RE-VERIFY: Deal visibility | **PASS** | DEAL-2026-0002 visible + detail page works |

**PASS: 4/5 | FAIL: 1/5**

---

## Bugs Fixed Since Last Report (report-20260210-1800)

1. ~~Deal not visible in /deals~~ → **FIXED** (DEAL-2026-0002 now appears)
2. ~~"Сделка не создана" on admin signing~~ → **FIXED** (green "Сделка создана" after fresh Черновик→Подписана transition)

## Bugs Still Open

### MAJOR — Spec creation persistence (3 bugs, likely same root cause)
1. **Contract selection not persisted** — form value lost on POST save
2. **Spec auto-numbering broken** — no specification_number generated from contract
3. **Delivery days cleared on save** — spinbutton value lost on POST save

### MEDIUM — Still present
4. **ERPS IDN column empty** — downstream of bug #2 (spec number never set)

---

## ACTION for Terminal 1

**Only 1 bug group remains: Spec update POST handler.**

The POST handler for `/spec-control/{id}` (save) does not persist:
- `contract_id` from the contract dropdown
- `delivery_days` from the spinbutton
- `specification_number` (should auto-generate from contract pattern)

All 3 values are correctly displayed in the form before save, but after POST + page reload, all 3 revert to empty/default. The root cause is in the POST handler — it's likely not reading these fields from `request.form()` or not including them in the Supabase UPDATE query.
