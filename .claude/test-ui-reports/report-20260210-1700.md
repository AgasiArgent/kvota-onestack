# Browser Test Report

**Timestamp:** 2026-02-10T17:35:00+03:00
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Overall:** PARTIAL PASS (1 task, infrastructure present but untestable with current data)

---

## Task: [P1.8] Payment countdown indicators on ERPS registry
**URL:** /finance?tab=erps
**Status:** PARTIAL PASS

| # | Check | Result | Details |
|---|-------|--------|---------|
| 1 | Navigate to ERPS tab | PASS | Page loaded, 2 specs visible, "Всего спецификаций: 2" |
| 2 | "Остаток дней до аванса" column exists | PASS | Column present in Full view (col 12 of 30) |
| 3 | Days column — gray no-data state | PASS | Both rows show gray "-" (color: #9ca3af) — correct for no-deadline data |
| 4 | Days column — green/yellow/red badges | UNTESTABLE | Test data has no advance deadlines set, so no colored badges rendered |
| 5 | "Остаток к оплате USD" column exists | PASS | Column present in Full view (col 15 of 30) |
| 6 | Remaining payment — dollar + percentage | PARTIAL | Both rows show "-" (spec sum $0.00). "Остаток %" column exists separately showing "0.0%" |
| 7 | Remaining payment color coding | UNTESTABLE | All values are $0.00/"-", no color thresholds triggered |
| 8 | Summary footer — ИТОГО К ПОЛУЧЕНИЮ | PASS | Shows "$0.00" in red (#dc2626) |
| 9 | Summary footer — ПРОСРОЧЕНО | PASS | Shows "0" in red (#dc2626) |
| 10 | Summary footer — СРОЧНО (1-7 дней) | PASS | Shows "0" in amber (#d97706) |
| 11 | View: Полный (30 cols) | PASS | All payment columns present, footer persists |
| 12 | View: Компактный (8 cols) | PASS | Reduced columns, has "Остаток к оплате USD", footer persists |
| 13 | View: Финансы (16 cols) | PARTIAL | Missing "Остаток дней до аванса", "Остаток к оплате USD", "Остаток %" — financial view lacks key payment countdown columns |
| 14 | Console errors | PASS | 0 errors across all views (only Tailwind CDN warnings) |

**Console Errors:** none (1 warning: Tailwind CDN — known, acceptable)

---

## Detailed Findings

### 1. Column Infrastructure — Present

The Full view (30 columns) includes all expected payment indicator columns:
- **"Остаток дней до аванса"** — days until advance payment deadline
- **"Крайний срок оплаты аванса"** — advance payment deadline date
- **"Планируемая сумма аванса USD"** — planned advance amount
- **"Всего оплачено USD"** — total paid
- **"Остаток к оплате USD"** — remaining payment
- **"Остаток %"** — remaining payment percentage

### 2. Gray No-Data State — Correct

When no deadline data exists, cells show `<span style="color: #9ca3af;">-</span>` (gray dash). This is the correct "no data" presentation.

### 3. Footer — Fully Functional with Color Coding

| Footer Row | Value | Color | Hex |
|------------|-------|-------|-----|
| ИТОГО К ПОЛУЧЕНИЮ: | $0.00 | Red | #dc2626 |
| ПРОСРОЧЕНО: | 0 | Red | #dc2626 |
| СРОЧНО (1-7 дней): | 0 | Amber | #d97706 |

Footer persists across all 3 tested views (Полный, Компактный, Финансы).

### 4. View Switching — Works but Finance View Incomplete

| View | Columns | Payment Indicators | Footer |
|------|---------|-------------------|--------|
| Полный | 30 | All present | Yes |
| Компактный | 8 | "Остаток к оплате USD" only | Yes |
| Финансы | 16 | Missing countdown columns | Yes |

**Issue:** The "Финансы" view does NOT include: "Остаток дней до аванса", "Планируемая сумма аванса USD", "Всего оплачено USD", "Остаток к оплате USD", "Остаток %". These are financial payment tracking columns that should logically be in the finance view.

---

## Bugs / Issues

### MEDIUM: Финансы view missing payment countdown columns
The "Финансы" view (16 cols) excludes the payment countdown and remaining payment columns. Since this view is intended for financial tracking, it should include "Остаток дней до аванса", "Остаток к оплате USD", and "Остаток %".

### LOW: Cannot verify color-coded badges with test data
Both test specs have:
- Сумма спец. USD = $0.00 (previously reported bug — spec sum not populated)
- No advance payment deadlines set
- No payments recorded

This means green/yellow/red badge rendering for countdown indicators **cannot be verified** — the infrastructure exists but there's no data to trigger colored states. Need test data with:
- Advance deadline in past (red)
- Advance deadline within 7 days (yellow)
- Advance deadline > 7 days (green)
- Non-zero spec sum with partial payments (for remaining % color coding)

### MAJOR: Spec sum $0.00 — wrong column in ERPS view (ROOT CAUSE FOUND)

**Symptom:** Both specs show $0.00 for "Сумма спец. USD" while "Профит USD" shows correct values ($228.04, $757.31).

**Root cause:** The `erps_registry` database view (migration 129) uses the wrong source for spec sum:
- `spec_sum_usd` = `qcs.calc_ak16_final_price_total` — from `quote_calculation_summaries` table
- `spec_profit_usd` = `q.total_profit_usd` — from `quotes` table

The problem: **`calc_ak16_final_price_total` is NEVER populated.** The calculation save logic (main.py lines 11822-11841) writes these columns to `quote_calculation_summaries`:
- `calc_s16_total_purchase_price` ✓
- `calc_v16_total_logistics` ✓
- `calc_y16_customs_duty` ✓
- `calc_total_brokerage` ✓
- `calc_ae16_sale_price_total` ✓
- `calc_al16_total_with_vat` ✓ ← this is the total with VAT
- `calc_af16_profit_margin` ✓
- Plus USD equivalents ✓

But `calc_ak16_final_price_total` is NOT in this list — it's never saved.

Meanwhile, `quotes.total_amount_usd` IS populated at line 11712 (same save block that populates `total_profit_usd`).

**Fix:** Update the ERPS view to use `q.total_amount_usd` instead of `qcs.calc_ak16_final_price_total`:
```sql
-- Line 23 of migration 129, CHANGE:
COALESCE(qcs.calc_ak16_final_price_total, 0) AS spec_sum_usd,
-- TO:
COALESCE(q.total_amount_usd, 0) AS spec_sum_usd,
```

This matches the pattern already used for profit (`q.total_profit_usd`), keeping both fields from the same source table.

**Impact:** This also fixes the downstream $0.00 in "Остаток к оплате USD" and "Планируемая сумма аванса USD" since both depend on `spec_sum_usd`.

### KNOWN (from previous report): IDN column empty
Both specs show empty IDN — bug #7 from report-20260210-1600.md (specification_number not populated during spec creation).

---

## Summary

| Check | Status | Notes |
|-------|--------|-------|
| Payment columns exist | **PASS** | All 6 payment-related columns in Full view |
| Gray no-data state | **PASS** | Correct #9ca3af styling for empty values |
| Color-coded badges | **UNTESTABLE** | No deadline data in test specs |
| Summary footer | **PASS** | 3 rows with correct color coding (red/amber) |
| View switching | **PARTIAL** | Footer persists but Финансы view missing key payment columns |
| Console errors | **PASS** | 0 errors |

**Overall: PARTIAL PASS** — Column infrastructure and footer are correctly implemented. Color-coded badge rendering cannot be verified due to test data having no deadlines and $0.00 sums.

---

## ACTION for Terminal 1

1. **FIX ERPS view spec_sum_usd (MAJOR, root cause found):** In migration 129 (or new migration), change `COALESCE(qcs.calc_ak16_final_price_total, 0) AS spec_sum_usd` → `COALESCE(q.total_amount_usd, 0) AS spec_sum_usd`. Also update all downstream references that use `qcs.calc_ak16_final_price_total` (remaining_payment_usd, remaining_payment_percent, planned_advance_usd). This one fix resolves spec sum $0.00, remaining payment $0.00, and planned advance $0.00.
2. **Add 'auto' group to Финансы view** — In main.py line 23611, change `'finance': ['spec', 'finance', 'management']` → `'finance': ['spec', 'auto', 'finance', 'management']` to include payment countdown columns.
3. **To fully verify badges:** After fix #1, existing test data should show non-zero sums. For deadline badges, need specs with `delivery_period_days` and `days_from_delivery_to_advance` populated.
