# E2E Test Report: Core Business Flow Validation
**Date:** 2026-02-10 15:00 (MSK)
**Session:** 2026-02-10 #1
**Base URL:** https://kvotaflow.ru
**Test Tool:** Playwright MCP (Claude in Chrome extension was unavailable)
**Quote:** Q-202602-0073 (UUID: ba4a486f-d2cb-4356-8832-db9db3c54246)

---

## TASK 1: Quote Creation + IDN + Items + IDN-SKU
**STATUS: PASS (with minor issues)**
**SCREENSHOTS:** task1-* (from previous session context)

### What worked:
- Auto-redirect from /quotes/new to /quotes/{uuid} works
- IDN Q-202602-0073 displayed correctly in Q-YYYYMM-NNNN format
- Client selection (Test Company E2E) via dropdown works
- Seller company selection works
- Delivery method (–ê–≤—Ç–æ) selection works
- 3 items added via Handsontable (brand, article, name, quantity)
- Bulk save via "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" button works (POST /items/bulk ‚Üí 200)
- All 3 items visible after reload with –ü–û–ó–ò–¶–ò–ò (3) counter

### ISSUES:
- **BUG (major):** delivery_city/delivery_country form inputs don't sync with visual combobox defaults. The combobox shows "–ú–æ—Å–∫–≤–∞"/"–†–æ—Å—Å–∏—è" visually, but underlying `input[name="delivery_city"]` and `input[name="delivery_country"]` are empty. This blocks "–ü–µ—Ä–µ–¥–∞—Ç—å –≤ –∑–∞–∫—É–ø–∫–∏" validation. Had to set values programmatically.
- **BUG (minor):** IDN-SKU column not visible in sales Handsontable grid. Grid columns are: ‚Ññ, –ë—Ä–µ–Ω–¥, –ê—Ä—Ç–∏–∫—É–ª, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ö–æ–ª-–≤–æ, –ï–¥.–∏–∑–º. ‚Äî no IDN-SKU column shown. Test expected Q-YYYYMM-NNNN-NNN format per item.

### NOTES:
- Handsontable requires object format for loadData (not array format)
- Status transition to "–ó–∞–∫—É–ø–∫–∏" worked via submitToProcurement()

---

## TASK 2: Procurement + Invoice Creation
**STATUS: PASS (with workarounds)**
**SCREENSHOTS:** task2-* (from previous session context)

### What worked:
- /procurement/{uuid} loads with all 3 items, progress 0/3
- Invoice creation flow: select items ‚Üí click "+ –ù–æ–≤—ã–π" ‚Üí fill form ‚Üí create
- Supplier search (TST - Test Supplier Company) works
- Currency (USD), country (CN), weight (150 kg) fields work
- Price filling via Handsontable (100/200/50 USD) works
- Production time (30 days) saved
- "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫—É–ø–∫—É" button transitions to /tasks

### ISSUES:
- **BUG (major):** Invoice creation supplier/buyer hidden inputs not populated via programmatic datalist selection. After typing supplier/buyer names and selecting from datalist, the hidden `input[name="supplier_id"]` and `input[name="buyer_company_id"]` remain empty. The JS handler that copies IDs from datalist options to hidden inputs doesn't trigger with programmatic input. Had to set hidden input values directly.
- **BUG (minor):** Buyer company datalist doesn't populate on programmatic focus. Required `htmx.trigger(input, 'focus')` to activate HTMX GET request.

### NOTES:
- Handsontable batch setDataAtCell with array-of-arrays format works for setting prices
- After completing procurement, redirects to /tasks dashboard

---

## TASK 3: Customs
**STATUS: PASS**
**SCREENSHOTS:** task3-customs-filled.png

### What worked:
- /customs/{uuid} loads with all 3 items, progress 0/3
- Handsontable (variable: `customsHot`) with columns: ‚Ññ, –ë—Ä–µ–Ω–¥, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ö–æ–ª-–≤–æ, –°—Ç—Ä–∞–Ω–∞ –∑–∞–∫—É–ø–∫–∏, –ö–æ–¥ –¢–ù –í–≠–î, –ü–æ—à–ª–∏–Ω–∞ %, –î–°, –°—Ç-—Ç—å –î–°, –°–°, –°—Ç-—Ç—å –°–°, –°–ì–†, –°—Ç-—Ç—å –°–ì–†
- HS codes filled: 8501.10.10 (5%), 8502.20.20 (10%), 8503.30.30 (7.5%)
- –î–° license checkbox + cost 5000 RUB for item 1
- General expenses filled: Brokerage hub 15000, Brokerage customs 20000, SVH 10000, Documentation 5000, Additional 3000 (all RUB)
- "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" saves correctly, progress updates to 100% (3/3)
- "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–∞–º–æ–∂–Ω—é" completes customs, fields become disabled
- Status badge shows "–õ–æ–≥–∏—Å—Ç–∏–∫–∞+–¢–∞–º–æ–∂–Ω—è" with history 3 transitions

### ISSUES:
- None

### NOTES:
- Batch setDataAtCell doesn't work for `customsHot` ‚Äî must use individual calls
- License cost note: "–°—Ç–æ–∏–º–æ—Å—Ç—å –ª–∏—Ü–µ–Ω–∑–∏–π (–î–°, –°–°, –°–ì–†) —É–∫–∞–∑–∞–Ω–∞ –≤ —Ä—É–±–ª—è—Ö (RUB)"

---

## TASK 4: Logistics
**STATUS: PASS**
**SCREENSHOTS:** task4-logistics-filled.png

### What worked:
- /logistics/{uuid} loads with invoice INV-01-Q-202602-0073 (USD)
- Route info: –ì–µ—Ä–º–∞–Ω–∏—è ‚Üí –†–æ—Å—Å–∏—è, üöõ –ê–≤—Ç–æ, 150.0 –∫–≥, 3 –ø–æ–∑.
- 3 cost segments filled: Supplier‚ÜíHub 500 USD, Hub‚ÜíCustoms 300 USD, Customs‚ÜíCustomer 200 USD
- Delivery time: 14 days
- "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" saves values correctly
- "–ó–∞–≤–µ—Ä—à–∏—Ç—å –ª–æ–≥–∏—Å—Ç–∏–∫—É" completes logistics
- Status automatically transitions to "–ü—Ä–æ–¥–∞–∂–∏" (step 4)
- Steps 1-3 show ‚úì checkmarks (–ß–µ—Ä–Ω–æ–≤–∏–∫ ‚úì, –ó–∞–∫—É–ø–∫–∏ ‚úì, –õ–æ–≥+–¢–∞–º ‚úì)
- History shows 5 transitions

### ISSUES:
- None

---

## TASK 5: Calculation
**STATUS: PASS (with workaround)**
**SCREENSHOTS:** task5-calculate-error.png, task5-calculate-success.png

### What worked (after workaround):
- /quotes/{uuid}/calculate loads with all parameters
- Company: MBR - –ú–ê–°–¢–ï–† –ë–≠–†–ò–ù–ì –û–û–û, Deal: –ü–æ—Å—Ç–∞–≤–∫–∞, Incoterms: DDP
- Currency: RUB, Markup: 15%, Payment: 100% advance
- "–û–±–Ω–æ–≤–∏—Ç—å" triggers calculation preview
- Results: Total excl VAT ‚ÇΩ476,918, Total incl VAT ‚ÇΩ581,840, Profit ‚ÇΩ59,470, Margin 15.0%
- Per-item breakdown with COGS/unit, Price/unit, Total, Profit
- Cost breakdown: Products ‚ÇΩ235,584 + Logistics ‚ÇΩ136,641 + Brokerage ‚ÇΩ53,000
- "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á—ë—Ç" saves and shows detailed results page
- Delivery Time: 44 days auto-calculated

### ISSUES:
- **BUG (critical):** Calculation engine SellerCompany enum mismatch. RAD seller company ("–û–û–û ¬´–†–ê–î –†–ï–°–£–†–°¬ª") fails with error: "'–û–û–û ¬´–†–ê–î –†–ï–°–£–†–°¬ª' is not a valid SellerCompany". The calculation engine expects enum values like "–†–ê–î –†–ï–°–£–†–° –û–û–û" but receives "–û–û–û ¬´–†–ê–î –†–ï–°–£–†–°¬ª" (different format with quotes and word order). Root cause: `build_calculation_inputs()` passes DB company name, but calculation_models.py SellerCompany enum has different name format. **Only MBR ("–ú–ê–°–¢–ï–† –ë–≠–†–ò–ù–ì –û–û–û") works**; RAD and GES will fail.

### NOTES:
- Workaround: Changed seller company from RAD to MBR on quote detail page
- The calculation engine cannot be modified per CLAUDE.md rules
- Fix needed in build_calculation_inputs() to map DB names to enum values

---

## TASK 6: Quote Control (–ö–æ–Ω—Ç—Ä–æ–ª—å)
**STATUS: PASS (UI exists, approval blocked)**
**SCREENSHOTS:** task6-quote-control.png

### What worked:
- "Submit for Quote Control" button transitions status to "–ö–æ–Ω—Ç—Ä–æ–ª—å –ö–ü"
- /quote-control/{uuid} page is comprehensive and well-designed:
  - Summary section (deal type, incoterms, currency, markup, items count)
  - 11-item checklist with contextual notes and warnings
  - Warning banner: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–æ–ø-–º–µ–Ω–µ–¥–∂–µ—Ä–∞" (because RUB currency)
  - Detailed calculation table per item (–ë–∞–∑–æ–≤—ã–π/–ü–æ–ª–Ω—ã–π/–ù–∞—Å—Ç—Ä–æ–∏—Ç—å presets)
  - Invoice verification section (0/3 items with invoices ‚Äî separate supplier invoice system)
  - Action buttons: "–í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É" + "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ"
- Approval request form loads with pre-filled reason and comment textarea

### ISSUES:
- **BUG (critical):** Approval submission fails with Python error: `name 'transition_quote' is not defined`. This is a NameError in the POST handler for `/quote-control/{id}/request-approval`. The function `transition_quote` is referenced but not imported/defined in scope. This blocks the entire approval ‚Üí PDF ‚Üí spec ‚Üí deal pipeline.

### NOTES:
- The control page UI is very thorough and well-built
- Checklist includes margin validation (min 12% for –ø–æ—Å—Ç–∞–≤–∫–∞, 8% for —Ç—Ä–∞–Ω–∑–∏—Ç)

---

## TASK 7: Approval + PDF Generation
**STATUS: BLOCKED**
**SCREENSHOTS:** task7-approval-error.png

### BLOCKER:
- Cannot proceed because Task 6 approval submission fails with `transition_quote` NameError
- PDF export buttons exist on quote page (Specification PDF, Invoice PDF, Validation Excel) but quote isn't in approved status

### NOTES:
- Export buttons are present: "Specification PDF", "Invoice PDF", "Validation Excel"
- These could potentially be tested independently of status, but the flow requires approval first

---

## TASK 8: Specification Creation
**STATUS: BLOCKED**

### BLOCKER:
- Quote is stuck in `pending_quote_control` status
- Cannot transition to `pending_spec_control` without completing approval flow
- Spec creation at /spec-control/create/{uuid} requires approved/signed status

---

## TASK 9: Specification Signing ‚Üí Deal ‚Üí ERPS
**STATUS: BLOCKED**

### BLOCKER:
- Depends on Task 8 (specification creation)
- Cannot test deal creation or ERPS without signed specification

---

## TASK 10: Console Errors & General Issues
**STATUS: FAIL (recurring JS errors on every page)**

### Recurring console errors on ALL pages:
1. **TypeError:** `Cannot read properties of null (reading 'addEventListener')` at line 2593 ‚Äî element not found when attaching event listener
2. **ReferenceError:** `text is not defined` at `updateThemeIcon` (line 2530/2539) ‚Äî theme toggle function references undefined variable
3. **404:** `/favicon.ico` not found
4. **Warning:** `cdn.tailwindcss.com should not be used in production` ‚Äî Tailwind CDN dev mode in production
5. **Warning:** `Deprecated stylesheet` ‚Äî outdated CSS reference

### Navigation:
- Sidebar links all work (–ì–ª–∞–≤–Ω–æ–µ, –†–µ–µ—Å—Ç—Ä—ã, –§–∏–Ω–∞–Ω—Å—ã, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
- Tab navigation between quote sections (–ü—Ä–æ–¥–∞–∂–∏, –ó–∞–∫—É–ø–∫–∏, –õ–æ–≥–∏—Å—Ç–∏–∫–∞, –¢–∞–º–æ–∂–Ω—è, –ö–æ–Ω—Ç—Ä–æ–ª—å, –î–æ–∫—É–º–µ–Ω—Ç—ã) works perfectly
- Status stepper (1-9 steps) updates correctly with ‚úì checkmarks

### Dropdowns:
- Client dropdown loads data correctly (12 clients)
- Seller company dropdown loads (3 companies)
- Contact person dropdown loads
- Delivery method, priority, incoterms dropdowns all work
- Currency dropdowns work across all sections

---

## SUMMARY

| Task | Name | Status |
|------|------|--------|
| 1 | Quote Creation + Items | PASS (with bugs) |
| 2 | Procurement + Invoice | PASS (with workarounds) |
| 3 | Customs | PASS |
| 4 | Logistics | PASS |
| 5 | Calculation | PASS (with workaround) |
| 6 | Quote Control | PASS (UI) / FAIL (approval) |
| 7 | Approval + PDF | BLOCKED |
| 8 | Specification | BLOCKED |
| 9 | Deal + ERPS | BLOCKED |
| 10 | Console & General | FAIL |

**TOTAL: 5/10 PASS, 1 PARTIAL, 1 FAIL, 3 BLOCKED**

### CRITICAL ISSUES: 2
1. **`transition_quote` is not defined** ‚Äî approval submission handler has Python NameError, blocks entire workflow from step 6 onward
2. **SellerCompany enum mismatch** ‚Äî calculation fails for RAD and GES seller companies (only MBR works). `build_calculation_inputs()` passes DB name format that doesn't match enum values

### MAJOR ISSUES: 2
1. **delivery_city/delivery_country inputs not synced** ‚Äî visual combobox defaults don't populate the underlying form inputs, blocking procurement submission
2. **Invoice creation supplier/buyer hidden inputs** ‚Äî programmatic datalist selection doesn't trigger JS handler to populate hidden ID fields

### MINOR ISSUES: 3
1. IDN-SKU column missing from sales Handsontable grid
2. Buyer company datalist doesn't populate on programmatic focus
3. Recurring JS errors on every page (addEventListener null, updateThemeIcon undefined)

### BLOCKERS:
- Tasks 7-9 blocked by `transition_quote` NameError in approval handler
- This means the full pipeline (approval ‚Üí PDF ‚Üí spec ‚Üí deal ‚Üí ERPS) cannot be tested

### RECOMMENDATION (fix priority):
1. **FIRST:** Fix `transition_quote` NameError in approval POST handler ‚Äî this unblocks the entire downstream pipeline
2. **SECOND:** Fix SellerCompany enum mapping in `build_calculation_inputs()` ‚Äî map DB company names to calculation engine enum values
3. **THIRD:** Fix delivery_city/country default value sync in quote form
4. **FOURTH:** Fix recurring JS errors (updateThemeIcon, addEventListener null)
