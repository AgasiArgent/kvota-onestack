BROWSER TEST
timestamp: 2026-02-10T15:00:00+03:00
session: 2026-02-10 #1
base_url: https://kvotaflow.ru
depth: full
type: end-to-end core business flow validation

---

## Предварительные условия

Логин: использовать аккаунт с ролями admin + sales + procurement + customs + logistics + finance.
Если такого нет — использовать admin-аккаунт.

---

## TASK 1: Создание запроса (КП) + IDN + позиции + IDN-SKU

URL: /quotes/new
STEPS:
1. Перейти на /quotes/new — должен автоматически создаться черновик и редирект на /quotes/{uuid}
2. Проверить что на странице отображается IDN в формате Q-YYYYMM-NNNN (например Q-202602-0001)
3. Записать IDN и URL квоты для дальнейших тестов
4. Заполнить клиента (выбрать любого из выпадающего списка inline)
5. Заполнить юрлицо-продавца (Seller Company)
6. Заполнить город доставки (например "Москва")
7. Выбрать метод доставки (например "Авто")
8. Добавить 3 позиции через форму добавления товара:
   - Позиция 1: Название "Тестовый товар 1", SKU "TEST-001", Бренд "TestBrand", Кол-во 10
   - Позиция 2: Название "Тестовый товар 2", SKU "TEST-002", Бренд "TestBrand", Кол-во 5
   - Позиция 3: Название "Тестовый товар 3", Бренд "OtherBrand", Кол-во 20
9. После добавления каждой позиции проверить что в таблице появляется IDN-SKU в формате Q-YYYYMM-NNNN-NNN
10. Сделать скриншот страницы с позициями и IDN-SKU

EXPECT:
- IDN квоты в формате Q-YYYYMM-NNNN отображается на странице
- Каждая позиция получает IDN-SKU (например Q-202602-0001-001, Q-202602-0001-002, Q-202602-0001-003)
- Все 3 позиции видны в таблице
- Inline-редактирование полей работает без ошибок
- Консоль без ошибок

---

## TASK 2: Перевод в закупки + заполнение

URL: (та же квота из Task 1)
STEPS:
1. На странице квоты найти кнопку перевода в закупки (submit/send to procurement)
2. Нажать кнопку — статус должен измениться на pending_procurement
3. Перейти на /procurement/{quote_id}
4. Проверить что страница загружается без ошибок
5. Создать инвойс (нажать "Создать инвойс" или аналогичную кнопку):
   - Выбрать поставщика из списка
   - Выбрать юрлицо-покупателя (Buyer Company)
   - Выбрать валюту USD
6. Привязать все 3 позиции к инвойсу
7. Заполнить цены для каждой позиции:
   - Позиция 1: purchase_price_original = 100 USD
   - Позиция 2: purchase_price_original = 200 USD
   - Позиция 3: purchase_price_original = 50 USD
8. Заполнить страну поставщика (Китай)
9. Заполнить production_time_days = 30
10. Заполнить общий вес инвойса (total_weight_kg = 150)
11. Нажать "Завершить" / "Complete" на инвойсе
12. Сделать скриншот заполненной формы закупок

EXPECT:
- Страница закупок загружается с позициями из КП
- Инвойс создаётся успешно
- Цены сохраняются
- Кнопка завершения работает
- Статус переходит дальше (pending_customs или pending_logistics_and_customs)
- Консоль без ошибок

---

## TASK 3: Заполнение таможни

URL: /customs/{quote_id}
STEPS:
1. Перейти на /customs/{quote_id}
2. Проверить что страница загружается с 3 позициями
3. Заполнить для каждой позиции:
   - Позиция 1: HS-код "8501.10.10", Пошлина 5%
   - Позиция 2: HS-код "8502.20.20", Пошлина 10%
   - Позиция 3: HS-код "8503.30.30", Пошлина 7.5%
4. Для одной позиции отметить лицензию ДС (checkbox + стоимость 5000)
5. Заполнить общие таможенные расходы если есть (brokerage, SVH, documentation)
6. Нажать "Завершить таможню" / "Complete customs"
7. Сделать скриншот

EXPECT:
- Все HS-коды и пошлины сохраняются
- Лицензии отображаются корректно
- Завершение работает без ошибок
- Консоль чистая

---

## TASK 4: Заполнение логистики

URL: /logistics/{quote_id}
STEPS:
1. Перейти на /logistics/{quote_id}
2. Проверить что страница загружается — инвойсы из закупок видны
3. Для каждого инвойса заполнить стоимости по 3 сегментам:
   - Supplier → Hub: 500 USD
   - Hub → Customs: 300 USD
   - Customs → Customer: 200 USD
4. Нажать "Завершить логистику" / "Complete logistics"
5. Проверить автопереход статуса в `pending_sales_review`
6. Сделать скриншот

EXPECT:
- Логистические стоимости сохраняются
- После завершения и таможни, и логистики → статус автоматически `pending_sales_review`
- Консоль без ошибок

---

## TASK 5: Расчёт КП

URL: /quotes/{quote_id}/calculate
STEPS:
1. Перейти на страницу расчёта
2. Проверить что все данные подгружены (позиции, цены, таможня, логистика)
3. Выбрать валюту КП (RUB)
4. Заполнить переменные расчёта:
   - Комиссия %: 15
   - Остальные переменные — оставить дефолтные или заполнить тестовые значения
5. Нажать "Рассчитать" / "Calculate"
6. Проверить что результат показывает:
   - Итоговую сумму
   - Профит
   - Маржу %
7. Сохранить расчёт
8. Сделать скриншот результатов

EXPECT:
- Расчёт выполняется без ошибок
- Суммы логичны (больше 0, профит положительный)
- Данные сохраняются
- Консоль чистая

---

## TASK 6: Контроль Жанной (pending_quote_control)

URL: /quotes/{quote_id} (или специальная страница контроля)
STEPS:
1. Найти кнопку "Отправить на контроль" или аналогичную на странице расчёта/квоты
2. Нажать — статус должен стать `pending_quote_control`
3. Проверить что есть:
   - UI для контролёра (просмотр данных расчёта)
   - Кнопки действий (одобрить / вернуть / запросить обоснование)
4. Если есть кнопка "Одобрить" — нажать
5. Проверить переход статуса
6. Сделать скриншот UI контролёра

EXPECT:
- Переход в pending_quote_control работает
- Есть UI для просмотра данных
- Есть кнопки действий
- Если UI отсутствует — ЗАФИКСИРОВАТЬ КАК БАГ с описанием что именно отсутствует

---

## TASK 7: Одобрение и генерация PDF

URL: /quotes/{quote_id}
STEPS:
1. Если квота в статусе approved (после контроля) — перейти к генерации PDF
2. Если нужно дополнительное одобрение (pending_approval) — проверить flow обоснования:
   a. Найти форму обоснования
   b. Заполнить обоснование
   c. Проверить переход к топ-менеджеру
   d. Одобрить от имени топ-менеджера
3. Нажать "Экспорт" / "Генерация КП" / кнопку экспорта PDF
4. Скачать PDF файл
5. Проверить в PDF:
   - IDN квоты отображается
   - Все позиции перечислены
   - Суммы корректны
6. Сделать скриншот страницы с кнопкой экспорта

EXPECT:
- PDF генерируется без ошибок
- IDN виден в документе
- Все позиции и суммы на месте
- Если flow одобрения не работает — ЗАФИКСИРОВАТЬ

---

## TASK 8: Создание спецификации

URL: /spec-control/create/{quote_id}
STEPS:
1. Перевести квоту в статус pending_spec_control (если ещё не там)
2. Перейти на /spec-control/create/{quote_id}
3. Проверить что форма загружается с данными из КП
4. Заполнить обязательные поля спецификации:
   - Номер контракта (выбрать из списка или создать)
   - Дата подписания
   - Срок действия
   - Валюта спецификации
5. Проверить что IDN-SKU каждой позиции отображается в спецификации
6. Сохранить спецификацию
7. Сделать скриншот

EXPECT:
- Спецификация создаётся из данных КП
- IDN-SKU каждой позиции виден
- Автонумерация спецификации работает (формат contract_number-N)
- Данные сохраняются корректно

---

## TASK 9: Подписание спецификации → Deal → ЕРПС

URL: /spec-control/{spec_id}
STEPS:
1. На странице спецификации найти механизм подписания:
   - Загрузить подписанный скан (если есть upload)
   - Или сменить статус на "signed"
2. Выполнить подписание
3. Проверить что:
   - Статус спецификации = "signed"
   - Автоматически создан Deal (сделка)
4. Перейти на /finance → таб ERPS
5. Найти подписанную спецификацию в реестре
6. Проверить наличие колонок:
   - IDN
   - Клиент
   - Дата подписания
   - Сумма
   - Профит
   - Оплачено / Остаток к оплате
   - Дней до оплаты (счётчик)
7. Сделать скриншот ЕРПС с новой записью

EXPECT:
- Подписание работает
- Deal создаётся автоматически
- Запись появляется в ЕРПС реестре
- Финансовые колонки отображают данные
- Если счётчик оплаты отсутствует — ЗАФИКСИРОВАТЬ (это задача T1.8-DEV)

---

## TASK 10: Проверка консоли и общие проблемы

URL: (все посещённые страницы)
STEPS:
1. На каждом шаге проверять консоль браузера на ошибки (JavaScript errors, 500 responses)
2. Проверить отображение на мобильных экранах (если возможно)
3. Проверить что навигация между страницами работает (sidebar links)
4. Проверить что все дропдауны загружают данные

EXPECT:
- Нет JavaScript ошибок в консоли
- Нет 500 ошибок от сервера
- Навигация работает

---

## Формат отчёта

Результат записать в: .claude/test-ui-reports/report-20260210-1500.md

Формат для каждого таска:
```
## TASK N: [название]
STATUS: PASS | FAIL | BLOCKED
SCREENSHOTS: [список файлов]
ISSUES:
- [описание бага] (severity: critical/major/minor)
NOTES:
- [дополнительные наблюдения]
```

В конце отчёта — общий вердикт:
```
## SUMMARY
TOTAL: X/10 PASS
CRITICAL ISSUES: [count]
MAJOR ISSUES: [count]
MINOR ISSUES: [count]
BLOCKERS: [list of steps that couldn't be completed]
RECOMMENDATION: [что чинить первым]
```

REPORT_TO: .claude/test-ui-reports/report-20260210-1500.md
