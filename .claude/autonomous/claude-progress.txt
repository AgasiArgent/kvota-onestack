# Claude Progress Log
# Project: OneStack Workflow Extension
# Created: 2025-01-14
# Spec: .claude/autonomous/app_spec.xml

## Project Overview

Расширение существующей системы OneStack (расчёт коммерческих предложений)
для поддержки многоролевого workflow с 9 ролями, уведомлениями через Telegram
и финансовым учётом план-факт.

**Текущее состояние:** Базовая система работает (КП, расчёт, экспорт)
**Цель:** Полный бизнес-процесс от заявки до сделки

## Features to Implement

88 features total across 8 phases:
1. Database Schema (16 features)
2. Role System (6 features)
3. Workflow Engine (10 features)
4. Role-Specific UI - Procurement, Logistics, Customs, Quote Control (19 features)
5. Telegram Bot (15 features)
6. Specifications & Deals (10 features)
7. Plan-Fact Finance (7 features)
8. Admin & Polish (5 features)

## Business Process Summary

1. Sales Manager uploads quote request
2. Procurement Manager(s) evaluate by brand
3. Logistics + Customs work in parallel
4. Sales Manager sets markup and terms
5. Quote Controller (Zhanna) reviews
6. Top Manager approves via Telegram (if needed)
7. Client negotiation, versioning
8. Spec Controller prepares specification
9. Signature → Deal
10. Finance tracks plan vs actual payments

## Key Roles

- sales: Менеджер по продажам
- procurement: Менеджер по закупкам (по брендам)
- logistics: Логист
- customs: Менеджер ТО (Олег Князев)
- quote_controller: Контроллер КП (Жанна)
- spec_controller: Контроллер спецификаций
- finance: Финансовый менеджер
- top_manager: Топ-менеджер (согласования через Telegram)
- admin: Администратор

---
## Sessions

## Session 2025-01-15 - Feature #1: Создать таблицу roles
- Created SQL migration: `migrations/001_create_roles_table.sql`
- Table structure: id (UUID PK), code (VARCHAR UNIQUE), name, description, created_at
- Inserted all 9 predefined roles: sales, procurement, logistics, customs, quote_controller, spec_controller, finance, top_manager, admin
- Added RLS policy for read-only access by authenticated users
- Added index on code column for fast lookups
- Files changed: migrations/001_create_roles_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #2: Создать таблицу user_roles
- Created SQL migration: `migrations/002_create_user_roles_table.sql`
- Table structure:
  - id (UUID PK)
  - user_id (UUID FK → auth.users)
  - organization_id (UUID FK → organizations)
  - role_id (UUID FK → roles)
  - created_at (TIMESTAMP)
  - created_by (UUID FK → auth.users)
- Added unique constraint on (user_id, organization_id, role_id)
- Created indexes: user_id, organization_id, role_id, (user_id, organization_id) composite
- RLS policies:
  - Users can see their own roles
  - Users can see roles of others in their organization
  - Only admins can insert/delete roles
- Files changed: migrations/002_create_user_roles_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #3: Создать таблицу brand_assignments
- Created SQL migration: `migrations/003_create_brand_assignments_table.sql`
- Table structure:
  - id (UUID PK)
  - organization_id (UUID FK → organizations)
  - brand (VARCHAR 255) - matches brand field in quote_items
  - user_id (UUID FK → auth.users) - procurement manager assigned
  - created_at (TIMESTAMP)
  - created_by (UUID FK → auth.users)
- Unique constraint: (organization_id, brand) - one manager per brand per org
- Created indexes: user_id, organization_id, (organization_id, brand) composite
- RLS policies:
  - Users can view brand assignments in their organization
  - Only admins can insert/update/delete brand assignments
- Files changed: migrations/003_create_brand_assignments_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #4: Создать таблицу workflow_transitions
- Created SQL migration: `migrations/004_create_workflow_transitions_table.sql`
- Table structure:
  - id (UUID PK)
  - quote_id (UUID FK -> quotes, CASCADE DELETE)
  - from_status (VARCHAR 50) - previous workflow status
  - to_status (VARCHAR 50) - new workflow status
  - actor_id (UUID FK -> auth.users)
  - actor_role (VARCHAR 50) - role of actor at time of transition
  - comment (TEXT) - optional reason for transition
  - created_at (TIMESTAMP)
- Indexes created:
  - quote_id - for looking up transitions by quote
  - actor_id - for filtering by who made the change
  - to_status - for analytics on status transitions
  - (quote_id, created_at DESC) - for time-ordered history
- RLS policies:
  - Users can view transitions for quotes in their organization
  - Users can insert transitions for quotes in their organization
  - No UPDATE/DELETE - audit log is immutable
- Added table and column comments for documentation
- Files changed: migrations/004_create_workflow_transitions_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #5: Создать таблицу approvals
- Created SQL migration: `migrations/005_create_approvals_table.sql`
- Table structure:
  - id (UUID PK)
  - quote_id (UUID FK -> quotes, CASCADE DELETE)
  - requested_by (UUID FK -> auth.users) - who requested approval
  - approver_id (UUID FK -> auth.users) - who should approve
  - approval_type (VARCHAR 50) - default 'top_manager'
  - reason (TEXT) - why approval is needed
  - status (VARCHAR 20) - 'pending', 'approved', 'rejected' with CHECK constraint
  - decision_comment (TEXT) - comment from approver
  - requested_at (TIMESTAMP)
  - decided_at (TIMESTAMP) - set automatically via trigger
- Added CHECK constraint: decided_at must be NULL when pending, NOT NULL otherwise
- Created indexes:
  - quote_id - for finding approvals by quote
  - requested_by - for filtering by requester
  - approver_id - for finding approvals to review
  - status - for filtering by approval status
  - requested_at DESC - for time-ordered listing
  - (approver_id, status) composite - for pending approvals dashboard
- RLS policies:
  - Users can view approvals for quotes in their organization
  - Quote controllers can create approval requests
  - Approvers can update their pending approvals
  - No DELETE - approvals are immutable audit records
- Added trigger to automatically set decided_at when status changes from pending
- Files changed: migrations/005_create_approvals_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #6: Создать таблицу specifications
- Created SQL migration: `migrations/006_create_specifications_table.sql`
- Table structure with all 18+ fields from spec_controller:
  - id (UUID PK)
  - quote_id (UUID FK -> quotes, CASCADE DELETE)
  - quote_version_id (UUID FK -> quote_versions, SET NULL on delete)
  - organization_id (UUID FK -> organizations, CASCADE DELETE)
  - specification_number, proposal_idn, item_ind_sku (identification fields)
  - sign_date (DATE), validity_period (VARCHAR)
  - specification_currency, exchange_rate_to_ruble (currency fields)
  - client_payment_term_after_upd (INTEGER), client_payment_terms (TEXT)
  - cargo_pickup_country, readiness_period, goods_shipment_country (origin fields)
  - delivery_city_russia, cargo_type, logistics_period (delivery fields)
  - our_legal_entity, client_legal_entity (legal entities)
  - supplier_payment_country
  - signed_scan_url (TEXT for storing signed document URL)
  - status (VARCHAR with CHECK: draft, pending_review, approved, signed)
  - created_by, created_at, updated_at (audit fields)
- Indexes created:
  - quote_id - for finding specifications by quote
  - organization_id - for org-scoped queries
  - status - for filtering by status
  - created_at DESC - for time-ordered listing
  - specification_number - for lookups by number
  - (organization_id, status) composite - for org-scoped status filtering
- RLS policies:
  - Users can view specifications in their organization
  - Users can insert specifications in their organization
  - Users can update specifications in their organization
  - Only admins can delete specifications
- Added trigger for automatic updated_at timestamp
- All columns documented with COMMENT statements
- Files changed: migrations/006_create_specifications_table.sql (new)
- Status: COMPLETE
