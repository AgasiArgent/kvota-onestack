# Claude Progress Log
# Project: OneStack Workflow Extension
# Created: 2025-01-14
# Spec: .claude/autonomous/app_spec.xml

## Project Overview

Расширение существующей системы OneStack (расчёт коммерческих предложений)
для поддержки многоролевого workflow с 9 ролями, уведомлениями через Telegram
и финансовым учётом план-факт.

**Текущее состояние:** Базовая система работает (КП, расчёт, экспорт)
**Цель:** Полный бизнес-процесс от заявки до сделки

## Features to Implement

88 features total across 8 phases:
1. Database Schema (16 features)
2. Role System (6 features)
3. Workflow Engine (10 features)
4. Role-Specific UI - Procurement, Logistics, Customs, Quote Control (19 features)
5. Telegram Bot (15 features)
6. Specifications & Deals (10 features)
7. Plan-Fact Finance (7 features)
8. Admin & Polish (5 features)

## Business Process Summary

1. Sales Manager uploads quote request
2. Procurement Manager(s) evaluate by brand
3. Logistics + Customs work in parallel
4. Sales Manager sets markup and terms
5. Quote Controller (Zhanna) reviews
6. Top Manager approves via Telegram (if needed)
7. Client negotiation, versioning
8. Spec Controller prepares specification
9. Signature → Deal
10. Finance tracks plan vs actual payments

## Key Roles

- sales: Менеджер по продажам
- procurement: Менеджер по закупкам (по брендам)
- logistics: Логист
- customs: Менеджер ТО (Олег Князев)
- quote_controller: Контроллер КП (Жанна)
- spec_controller: Контроллер спецификаций
- finance: Финансовый менеджер
- top_manager: Топ-менеджер (согласования через Telegram)
- admin: Администратор

---
## Sessions

## Session 2025-01-15 - Feature #1: Создать таблицу roles
- Created SQL migration: `migrations/001_create_roles_table.sql`
- Table structure: id (UUID PK), code (VARCHAR UNIQUE), name, description, created_at
- Inserted all 9 predefined roles: sales, procurement, logistics, customs, quote_controller, spec_controller, finance, top_manager, admin
- Added RLS policy for read-only access by authenticated users
- Added index on code column for fast lookups
- Files changed: migrations/001_create_roles_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #2: Создать таблицу user_roles
- Created SQL migration: `migrations/002_create_user_roles_table.sql`
- Table structure:
  - id (UUID PK)
  - user_id (UUID FK → auth.users)
  - organization_id (UUID FK → organizations)
  - role_id (UUID FK → roles)
  - created_at (TIMESTAMP)
  - created_by (UUID FK → auth.users)
- Added unique constraint on (user_id, organization_id, role_id)
- Created indexes: user_id, organization_id, role_id, (user_id, organization_id) composite
- RLS policies:
  - Users can see their own roles
  - Users can see roles of others in their organization
  - Only admins can insert/delete roles
- Files changed: migrations/002_create_user_roles_table.sql (new)
- Status: COMPLETE

## Session 2025-01-15 - Feature #3: Создать таблицу brand_assignments
- Created SQL migration: `migrations/003_create_brand_assignments_table.sql`
- Table structure:
  - id (UUID PK)
  - organization_id (UUID FK → organizations)
  - brand (VARCHAR 255) - matches brand field in quote_items
  - user_id (UUID FK → auth.users) - procurement manager assigned
  - created_at (TIMESTAMP)
  - created_by (UUID FK → auth.users)
- Unique constraint: (organization_id, brand) - one manager per brand per org
- Created indexes: user_id, organization_id, (organization_id, brand) composite
- RLS policies:
  - Users can view brand assignments in their organization
  - Only admins can insert/update/delete brand assignments
- Files changed: migrations/003_create_brand_assignments_table.sql (new)
- Status: COMPLETE
