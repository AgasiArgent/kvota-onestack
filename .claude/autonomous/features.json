{
  "version": "3.0",
  "project": "Kvota OneStack - Quote Workflow System with Supply Chain",
  "description": "Расширение OneStack: 4 типа компаний в цепочке поставок, IDN система, реестр инвойсов поставщиков, 12 ролей",
  "created": "2025-01-15T00:00:00Z",
  "stack": "Python FastHTML + HTMX + Supabase",
  "spec_file": ".claude/autonomous/app_spec.xml",
  "features": [
    {
      "id": "DB-001",
      "name": "Create suppliers table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T16:50:00Z",
      "description": "Create suppliers table with supplier_code, country, city, inn, kpp, contact fields"
    },
    {
      "id": "DB-002",
      "name": "Create buyer_companies table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T17:00:00Z",
      "description": "Create buyer_companies table (our legal entities for purchasing)"
    },
    {
      "id": "DB-003",
      "name": "Verify seller_companies table exists",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Verify seller_companies table from previous migration, add missing columns if needed"
    },
    {
      "id": "DB-004",
      "name": "Create customer_contacts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create customer_contacts table for LPR contacts with is_signatory field"
    },
    {
      "id": "DB-005",
      "name": "Create customer_contracts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create customer_contracts table with next_specification_number counter"
    },
    {
      "id": "DB-006",
      "name": "Create bank_accounts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create universal bank_accounts table with entity_type polymorphism",
      "notes": "Created migration 023_create_bank_accounts_table.sql with polymorphic design (entity_type/entity_id), BIK/SWIFT/IBAN validation, single-default trigger"
    },
    {
      "id": "DB-007",
      "name": "Create locations table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T17:10:00Z",
      "description": "Create locations directory for dropdown with search (country, city, is_hub)",
      "notes": "Created migration 024_create_locations_table.sql with pg_trgm extension, gin index for search, search_locations() function, RLS policies, and create_default_locations() seed function"
    },
    {
      "id": "DB-008",
      "name": "Create brand_supplier_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T17:20:00Z",
      "description": "Link brands to suppliers",
      "notes": "Created migration 025_create_brand_supplier_assignments_table.sql with is_primary flag, single-primary trigger, helper functions: get_primary_supplier_for_brand(), get_suppliers_for_brand(), get_brands_for_supplier()"
    },
    {
      "id": "DB-009",
      "name": "Create brand_procurement_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T17:30:00Z",
      "description": "Assign brands to procurement managers",
      "notes": "Created migration 026_create_brand_procurement_view.sql - view alias for existing brand_assignments table (003) with helper functions: get_procurement_manager_for_brand(), get_brands_for_procurement_manager(), get_procurement_assignments_summary()"
    },
    {
      "id": "DB-010",
      "name": "Create route_logistics_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T18:00:00Z",
      "description": "Assign routes to logistics managers with pattern matching",
      "notes": "Created migration 027_create_route_logistics_assignments_table.sql with route_pattern field supporting wildcards (*). Helper functions: match_route_to_logistics_manager(), get_routes_for_logistics_manager(), get_logistics_manager_for_locations(), get_route_assignments_summary(). RLS policies for organization isolation."
    },
    {
      "id": "DB-011",
      "name": "Extend quotes table with new columns",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:10:00Z",
      "description": "Add idn, seller_company_id, workflow_status, deal_type, assigned users, timestamps",
      "notes": "Created migration 028_extend_quotes_v3.sql adding idn (VARCHAR 100), seller_company_id (UUID FK). Added generate_quote_idn() function with IDN format SELLER-INN-YEAR-SEQ. Added auto-generate trigger. Organizations table extended with idn_counters JSONB. Note: workflow_status, deal_type already added in v2.0 migration 012."
    },
    {
      "id": "DB-012",
      "name": "Extend quote_items with supply chain columns",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:20:00Z",
      "description": "Add supplier_id, buyer_company_id, pickup_location_id, procurement fields",
      "notes": "Created migration 029_extend_quote_items_supply_chain.sql with: item_idn, supplier_id FK, buyer_company_id FK, pickup_location_id FK, supplier_payment_terms, supplier_advance_percent, production_time_days, weight_kg, volume_m3. Added generate_item_idn() function, auto-generate trigger, regenerate_item_idns_for_quote() helper, get_item_supply_chain_summary() function."
    },
    {
      "id": "DB-013",
      "name": "Extend quote_items with logistics fields",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:30:00Z",
      "description": "Add logistics_supplier_to_hub, logistics_hub_to_customs, logistics_customs_to_customer, logistics_total_days",
      "notes": "Created migration 030_extend_quote_items_logistics.sql with: 4 logistics columns (supplier→hub, hub→customs, customs→customer costs + total_days), check constraints (non-negative costs, positive days), helper functions: get_item_logistics_total(), get_quote_logistics_summary(), is_quote_logistics_complete(), and v_quote_items_logistics view for logistics workspace."
    },
    {
      "id": "DB-014",
      "name": "Extend quote_items with customs fields",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:40:00Z",
      "description": "Add hs_code, customs_duty_percent, customs_extra_cost",
      "notes": "Created migration 031_extend_quote_items_customs.sql with: hs_code (VARCHAR 20 with format validation), customs_duty_percent (DECIMAL 5,2, 0-100%), customs_extra_cost (DECIMAL 15,2). Helper functions: get_item_customs_total(), get_quote_customs_summary(), is_quote_customs_complete(), get_hs_code_stats(). Created v_quote_items_customs view for customs workspace. Added indexes for HS code reporting."
    },
    {
      "id": "DB-015",
      "name": "Create supplier_invoices table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T18:50:00Z",
      "description": "Create supplier invoices registry with status tracking",
      "notes": "Created migration 032_create_supplier_invoices_table.sql with status tracking (pending/partially_paid/paid/overdue/cancelled), RLS policies, auto-overdue function, helper functions (get_invoice_payment_summary, get_supplier_invoices_summary), view v_supplier_invoices_with_payments"
    },
    {
      "id": "DB-016",
      "name": "Create supplier_invoice_items table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:00:00Z",
      "description": "Link invoice items to quote_items",
      "notes": "Created migration 033_create_supplier_invoice_items_table.sql with: quote_item_id FK (optional for non-quote purchases), auto-calculate total trigger, auto-sync parent invoice total trigger, RLS policies inheriting from parent invoice. Helper functions: get_invoice_items_with_details(), get_invoices_for_quote_item(), get_quote_item_invoiced_total(), get_quote_invoicing_summary(). View: v_supplier_invoice_items_full"
    },
    {
      "id": "DB-017",
      "name": "Create supplier_invoice_payments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:10:00Z",
      "description": "Track payments with payment_type, buyer_company_id",
      "notes": "Created migration 034_create_supplier_invoice_payments_table.sql with: payment_type (advance/partial/final/refund), buyer_company_id FK (which legal entity paid), exchange_rate for RUB conversion. Auto-update invoice status trigger. RLS policies inherit from parent invoice. Helper functions: get_invoice_payments_summary(), get_payments_for_invoice(), get_payments_by_buyer_company(), get_supplier_payment_summary(). View: v_supplier_invoice_payments_full"
    },
    {
      "id": "DB-018",
      "name": "Create workflow_transitions table if not exists",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:20:00Z",
      "description": "Audit log for status transitions - verify or create",
      "notes": "VERIFIED: Table already exists in migration 004_create_workflow_transitions_table.sql with all required columns (id, quote_id, from_status, to_status, actor_id, actor_role, comment, created_at). Has proper indexes and RLS policies."
    },
    {
      "id": "DB-019",
      "name": "Create approvals table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:25:00Z",
      "description": "Track approval requests with modifications JSONB",
      "notes": "Table existed in migration 005. Created migration 035_add_modifications_to_approvals.sql to add modifications JSONB column for v3.0. Also added: apply_approval_modifications() function, v_approvals_with_modifications view, get_approval_history() function."
    },
    {
      "id": "DB-020",
      "name": "Create specifications table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:40:00Z",
      "description": "Store specification exports with all required fields",
      "notes": "Table existed in migration 006. Created migration 036_extend_specifications_v3.sql with: contract_id FK to customer_contracts, specification_date, export_data JSONB, updated status constraint (added 'cancelled'). Helper functions: get_next_specification_number(), generate_specification_number(), create_specification_from_quote(), get_specification_details(), get_specifications_summary(), get_specification_signatory(). View: v_specifications_list."
    },
    {
      "id": "DB-021",
      "name": "Create deals table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:50:00Z",
      "description": "Track completed deals linked to specifications",
      "notes": "VERIFIED: Table existed from migration 007. Created migration 037_extend_deals_v3.sql with v3.0 helper functions: create_deal_from_specification(), get_deal_details(), get_deals_summary(), get_deals_list(), complete_deal(), cancel_deal(). Added v_deals_list view with full context."
    },
    {
      "id": "DB-022",
      "name": "Create plan_fact_categories table with seed data",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T20:00:00Z",
      "description": "Seed payment categories (client_payment, supplier_payment, logistics, customs, tax, etc.)",
      "notes": "Created migration 038_create_plan_fact_categories_table.sql with 21 seed categories (8 core from spec + detailed subcategories). Categories include: client_payment/advance/final (income), supplier_payment/advance/balance, logistics segments, customs (duty/fee/broker), tax/VAT, finance_commission, lpr_reward, bank_commission, currency_conversion, other_expense. Helper functions: get_plan_fact_categories(), get_category_by_code(), get_income_categories(), get_expense_categories(), get_deal_category_stats(). RLS allows all reads, admin-only writes."
    },
    {
      "id": "DB-023",
      "name": "Create plan_fact_items table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T20:15:00Z",
      "description": "Track planned vs actual payments with variance",
      "notes": "Created migration 039_create_plan_fact_items_table.sql with: deal_id/category_id FKs, planned/actual amounts with currencies, auto-variance calculation (amount + percent), status tracking (planned/partial/completed/cancelled/overdue), payment documentation. Triggers: timestamp update, variance calculation, overdue check. Helper functions: create_plan_fact_item(), register_plan_fact_payment(), cancel_plan_fact_item(), get_deal_plan_fact_summary(), get_plan_fact_items(), generate_plan_fact_from_deal(), mark_plan_fact_items_overdue(). View: v_plan_fact_items_full. RLS policies for organization isolation."
    },
    {
      "id": "DB-024",
      "name": "Create telegram_users table",
      "category": "database",
      "priority": 3,
      "passes": true,
      "completed_at": "2026-01-15T20:30:00Z",
      "description": "Link Telegram accounts to system users",
      "notes": "Created migration 040_create_telegram_users_table.sql with: user_id/telegram_id linking, verification flow (code + expiry + attempts), notification preferences (task_assigned, approval_request, status_change, deal_update), RLS policies (own + admin access). Helper functions: generate_telegram_verification_code(), start_telegram_verification(), verify_telegram_user(), get_telegram_user(), get_telegram_id_for_user(), get_telegram_recipients_for_notification(), update_telegram_notification_preferences(), update_telegram_interaction(), unlink_telegram_account(), block_telegram_user(). View: v_telegram_users_summary."
    },
    {
      "id": "DB-025",
      "name": "Create notifications table",
      "category": "database",
      "priority": 3,
      "passes": true,
      "completed_at": "2026-01-15T20:45:00Z",
      "description": "Store notification history",
      "notes": "Table already existed from v2.0 (migration 011). Created migration 041_extend_notifications_v3.sql with v3.0 enhancements: added organization_id (multi-tenant), specification_id, approval_id, priority column (low/normal/high/urgent), metadata JSONB, expires_at for time-sensitive notifications. Extended type constraint with v3.0 types: workflow_transition, procurement_complete, logistics_complete, customs_complete, spec_ready, spec_signed, deal_created, payment_due, payment_received, invoice_received, invoice_overdue. Helper functions: create_notification_v3(), create_workflow_notification(), create_approval_notification(), get_pending_notifications_v3(), get_notification_counts(), mark_all_notifications_read(), cleanup_expired_notifications(). Updated RLS policies for organization isolation. View: v_notifications_list with related entity info."
    },
    {
      "id": "DB-026",
      "name": "Add RLS policies for all new tables",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T21:00:00Z",
      "description": "Row-level security for organization isolation",
      "notes": "Created migration 042_verify_v3_rls_policies.sql - comprehensive RLS verification. All v3.0 tables already have RLS enabled from their creation migrations: suppliers, buyer_companies, seller_companies, customer_contacts, customer_contracts, bank_accounts, locations, brand_supplier_assignments, route_logistics_assignments, supplier_invoices, supplier_invoice_items, supplier_invoice_payments, plan_fact_categories, plan_fact_items, telegram_users, notifications. Added helper functions: user_can_access_organization(), get_quote_organization_id(), get_customer_organization_id(), get_supplier_invoice_organization_id(), get_deal_organization_id(), user_has_any_role(). Created verify_v3_rls_status() audit function. Full policy documentation included."
    },
    {
      "id": "IDN-001",
      "name": "Implement IDN generation for quotes",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T21:30:00Z",
      "description": "Generate IDN in format SELLER-INN-YEAR-SEQ using idn_counters",
      "notes": "Created services/idn_service.py with: ParsedQuoteIDN/ParsedItemIDN dataclasses, IDNGenerationResult, parse_quote_idn(), parse_item_idn(), is_valid_quote_idn(), is_valid_item_idn(), validate_seller_code(), validate_inn(), generate_quote_idn() (calls DB function), assign_idn_to_quote(), get_quote_idn(), get_quote_by_idn(), utility functions. 26 tests pass in tests/test_idn_service.py. Database function already exists from migration 028."
    },
    {
      "id": "IDN-002",
      "name": "Implement IDN generation for quote items",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T21:30:00Z",
      "description": "Generate item IDN as QUOTE_IDN-POSITION",
      "notes": "Implemented in services/idn_service.py with: generate_item_idn() (calls DB function), regenerate_item_idns_for_quote(), get_item_idn(), get_item_by_idn(), extract_quote_idn_from_item_idn(), format_item_position(). Tests for item IDN parsing and validation included in tests/test_idn_service.py. Database function generate_item_idn() exists from migration 029."
    },
    {
      "id": "API-001",
      "name": "CRUD API for suppliers",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T22:00:00Z",
      "description": "Create, read, update, delete suppliers with search",
      "notes": "Created services/supplier_service.py with: Supplier dataclass, validation functions (validate_supplier_code, validate_inn, validate_kpp), CRUD operations (create_supplier, get_supplier, get_supplier_by_code, get_all_suppliers, get_suppliers_by_country, count_suppliers, update_supplier, activate_supplier, deactivate_supplier, delete_supplier), search function for HTMX dropdowns (search_suppliers, get_suppliers_for_dropdown), utility functions (get_unique_countries, get_supplier_stats, get_supplier_display_name, format_supplier_for_dropdown). Tests in tests/test_supplier_service.py with 30 passing tests."
    },
    {
      "id": "API-002",
      "name": "CRUD API for buyer_companies",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T22:30:00Z",
      "description": "Create, read, update, delete buyer companies",
      "notes": "Created services/buyer_company_service.py with: BuyerCompany dataclass with all table fields (company_code, inn, kpp, ogrn, registration_address, general_director_name/position), validation functions (validate_company_code, validate_inn for legal entity 10 digits, validate_kpp, validate_ogrn for 13 digits), CRUD operations (create_buyer_company, get_buyer_company, get_buyer_company_by_code, get_buyer_company_by_inn, get_all_buyer_companies, count_buyer_companies, search_buyer_companies, update_buyer_company, activate/deactivate, delete_buyer_company), dropdown helpers (get_buyer_companies_for_dropdown, format_buyer_company_for_dropdown), document generation helper (get_buyer_company_for_document with full_requisites formatting), stats function. Updated services/__init__.py with exports. Tests in tests/test_buyer_company_service.py with 44 passing tests."
    },
    {
      "id": "API-003",
      "name": "CRUD API for seller_companies",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T23:00:00Z",
      "description": "Create, read, update, delete seller companies",
      "notes": "Created services/seller_company_service.py with: SellerCompany dataclass (supplier_code for 3-letter code, supports 10/12-digit INN for legal entities/IE, 13/15-digit OGRN), validation functions (validate_supplier_code, validate_inn, validate_kpp, validate_ogrn), CRUD operations (create_seller_company, get_seller_company, get_seller_company_by_code, get_seller_company_by_inn, get_all_seller_companies, count_seller_companies, search_seller_companies, update_seller_company, activate/deactivate, delete_seller_company), dropdown helpers (get_seller_companies_for_dropdown, format_seller_company_for_dropdown), document generation helper (get_seller_company_for_document with full_requisites formatting including country), IDN helper (get_seller_company_for_idn), stats function with by_country breakdown, get_unique_countries() utility. Updated services/__init__.py with exports. Tests in tests/test_seller_company_service.py with 46 passing tests."
    },
    {
      "id": "API-004",
      "name": "CRUD API for customers with contacts",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "description": "Manage customers and their contacts",
      "completed_at": "2026-01-15T18:49:08.723871Z",
      "notes": "Created services/customer_service.py with: Customer/CustomerContact dataclasses, validation functions (inn, kpp, ogrn, email, phone), customer CRUD (create, get, get_with_contacts, get_by_inn, get_all, get_active, count, search, update, activate/deactivate, add/remove_warehouse_address, delete), contact CRUD (create, get, get_for_customer, get_signatory, get_primary, count, update, set_signatory, set_primary, delete, delete_all), utility functions (stats, display_name, dropdown format, for_document, for_idn, signatory_for_specification). Tests in tests/test_customer_service.py with 53 passing tests."
    },
    {
      "id": "API-005",
      "name": "CRUD API for customer_contracts",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:30:00Z",
      "description": "Manage supply contracts",
      "notes": "Created services/customer_contract_service.py with: CustomerContract dataclass, CONTRACT_STATUSES/STATUS_NAMES/STATUS_COLORS constants, validation functions (validate_contract_number, validate_contract_status), status helpers (get_contract_status_name, get_contract_status_color, is_contract_active), CRUD operations (create_contract, get_contract, get_contract_with_customer, get_contract_by_number, get_contracts_for_customer, get_active_contracts_for_customer, get_all_contracts, get_contracts_with_customer_names, count_contracts, search_contracts, contract_exists, update_contract, suspend_contract, terminate_contract, activate_contract, delete_contract), specification numbering (get_next_specification_number, get_current_specification_number, reset_specification_number), utility functions (get_contract_stats, get_contract_display_name, format_contract_for_dropdown, get_contracts_for_dropdown, get_contract_for_specification). Updated services/__init__.py with all exports. Tests in tests/test_customer_contract_service.py with 44 passing tests."
    },
    {
      "id": "API-006",
      "name": "CRUD API for locations",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T20:00:00Z",
      "description": "Manage locations directory",
      "notes": "Created services/location_service.py with: Location dataclass (country, city, code, address, is_hub, is_customs_point, display_name, search_text), validation functions (validate_location_code 2-5 uppercase letters, validate_country), create operations (create_location, create_location_if_not_exists), read operations (get_location, get_location_by_code, get_location_by_country_city, get_all_locations, get_locations_by_country, get_hub_locations, get_customs_point_locations, count_locations, location_exists), search operations (search_locations using DB RPC with fallback, get_active_locations), update operations (update_location, activate_location, deactivate_location, set_as_hub, set_as_customs_point), delete operations (delete_location), utility functions (get_unique_countries, get_location_stats, get_location_display_name, format_location_for_dropdown, get_locations_for_dropdown), seed data functions (seed_default_locations using DB RPC, get_location_for_route). Updated services/__init__.py with all exports. Tests in tests/test_location_service.py with 41 passing tests."
    },
    {
      "id": "API-007",
      "name": "Locations search endpoint for dropdown",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "description": "Search locations with query parameter for HTMX dropdown",
      "completed_at": "2026-01-15T19:03:01.440853",
      "notes": "Created API endpoints for location search:\n1. GET /api/locations/search - Returns HTML <option> elements for HTMX dropdown\n   - Query params: q (search query), hub_only, customs_only, limit\n   - Returns: HTML options with location badges [хаб], [таможня]\n   - Supports trigram-based partial matching\n2. GET /api/locations/search/json - Returns JSON for custom implementations\n   - Same params as HTML endpoint\n   - Returns: {items: [{value, label}], count, query}\n   - Error handling returns {error, items: []}\n3. Tests: tests/test_api_locations.py with 21 passing tests\n   - Search filtering, hub/customs filters\n   - JSON response structure\n   - Parameter parsing and validation"
    },
    {
      "id": "API-008",
      "name": "Brand assignments API",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T19:30:00Z",
      "description": "Manage brand-supplier and brand-procurement assignments",
      "notes": "Created services/brand_supplier_assignment_service.py with: BrandSupplierAssignment dataclass, CRUD operations (create/get/update/delete), query functions (get_assignments_for_brand, get_primary_supplier_for_brand, get_assignments_for_supplier, count_brand_supplier_assignments), bulk operations (bulk_create_brand_supplier_assignments), primary supplier management (set_primary_supplier_for_brand, unset_primary_supplier_for_brand - uses DB trigger for single-primary enforcement), utility functions (get_brand_supplier_mapping, get_suppliers_count_by_brand, get_brands_without_supplier, get_brands_without_primary_supplier, get_brand_supplier_assignment_stats, format_brand_supplier_for_display, get_suppliers_for_brand_dropdown). Note: brand_service.py already handles brand→procurement-manager assignments (brand_assignments table). This new service handles brand→supplier assignments (brand_supplier_assignments table from DB-008). Tests in tests/test_brand_supplier_assignment_service.py with 24 passing tests. Updated services/__init__.py with all exports."
    },
    {
      "id": "API-009",
      "name": "Route assignments API",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T20:00:00Z",
      "description": "Manage route-logistics assignments",
      "notes": "Created services/route_logistics_assignment_service.py with: RouteLogisticsAssignment dataclass, validation functions (validate_route_pattern, parse_route_pattern, build_route_pattern, normalize_route_pattern), CRUD operations (create/get/update/delete), route matching functions (match_route_to_logistics_manager using DB RPC with Python fallback, get_logistics_manager_for_locations, find_matching_routes), query functions (get_assignments_for_user, get_all_route_logistics_assignments, count_route_logistics_assignments, get_unique_route_patterns, get_unique_origins, get_unique_destinations), utility functions (get_route_user_mapping, get_routes_count_by_user, get_route_logistics_assignment_stats, get_route_assignments_summary, format_route_assignment_for_display, get_routes_for_dropdown, check_route_coverage, get_uncovered_routes). Updated services/__init__.py with all exports. Tests in tests/test_route_logistics_assignment_service.py with 35 passing tests."
    },
    {
      "id": "API-010",
      "name": "Supplier invoices CRUD",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T22:30:00Z",
      "description": "Manage supplier invoices with items",
      "notes": "Created services/supplier_invoice_service.py with: SupplierInvoice/SupplierInvoiceItem/InvoiceSummary dataclasses, validation functions (validate_invoice_number, validate_invoice_status, validate_currency, validate_amount), status helpers (get_invoice_status_name, get_invoice_status_color, is_invoice_payable, is_invoice_editable), invoice CRUD (create_invoice, create_invoice_with_items, get_invoice, get_invoice_with_details, get_invoice_by_number, get_invoices_for_supplier, get_all_invoices, count_invoices, search_invoices, invoice_exists, get_overdue_invoices, get_pending_invoices, update_invoice, update_invoice_status, cancel_invoice, mark_invoice_overdue, update_overdue_invoices, delete_invoice), item operations (add_invoice_item, get_invoice_item, get_invoice_items, get_invoice_items_with_details, update_invoice_item, delete_invoice_item, get_items_for_quote_item, get_total_invoiced_for_quote_item), utility functions (get_invoice_summary, get_invoice_stats_by_supplier, format_invoice_for_display, get_invoices_for_dropdown). Tests: tests/test_supplier_invoice_service.py with 52 passing tests. Updated services/__init__.py with all exports."
    },
    {
      "id": "API-011",
      "name": "Supplier invoice payments API",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T23:00:00Z",
      "description": "Register and track payments",
      "notes": "Created services/supplier_invoice_payment_service.py with: SupplierInvoicePayment/PaymentSummary/SupplierPaymentSummary/BuyerCompanyPaymentSummary dataclasses, validation functions (validate_payment_type, validate_payment_amount, validate_exchange_rate, validate_currency, validate_payment_document), payment type helpers (get_payment_type_name, get_payment_type_color, is_refund, is_advance, is_final_payment), CRUD operations (register_payment, register_advance_payment, register_final_payment, register_refund, get_payment, get_payment_with_details, get_payments_for_invoice, get_payments_for_invoice_with_details, get_all_payments, count_payments, get_recent_payments, get_payments_by_buyer_company, get_refunds_for_invoice, update_payment, update_payment_document, update_payment_exchange_rate, delete_payment, delete_all_payments_for_invoice), summary functions (get_invoice_payment_summary, get_supplier_payment_summary, get_payments_summary_by_buyer_company, get_payment_stats), utility functions (get_remaining_amount, is_invoice_fully_paid, format_payment_for_display, get_payments_for_display). Uses DB RPC functions for summaries. Tests: tests/test_supplier_invoice_payment_service.py with 69 passing tests. Updated services/__init__.py with all exports."
    },
    {
      "id": "WF-001",
      "name": "Workflow status transition service",
      "category": "backend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T23:30:00Z",
      "description": "Validate and execute status transitions based on role",
      "notes": "Workflow service already existed from v2.0 with comprehensive implementation. Created tests/test_workflow_service.py with 67 passing tests. Service includes: WorkflowStatus enum (15 statuses), StatusTransition/TransitionResult dataclasses, STATUS_NAMES/STATUS_NAMES_SHORT/STATUS_COLORS dictionaries, helper functions (get_status_name, get_status_color, is_final_status, is_in_progress, get_workflow_order, get_workflow_stage), transition validation (can_transition, get_allowed_transitions, get_allowed_target_statuses), permission matrix functions (get_transition_requirements, get_roles_for_transition, get_transitions_by_role, get_permission_matrix, get_permission_matrix_detailed, get_outgoing_transitions, get_incoming_transitions, is_comment_required, is_auto_transition), transition execution (transition_quote_status, get_quote_workflow_status, get_quote_transition_history, get_available_transitions_for_quote), auto-transition functions (check_and_auto_transition_to_sales_review, complete_logistics, complete_customs, get_parallel_stages_status), procurement assignment functions (get_procurement_users_for_quote, assign_procurement_users_to_quote, transition_to_pending_procurement, get_quote_procurement_status, check_all_procurement_complete, complete_procurement). Already exported in services/__init__.py."
    },
    {
      "id": "WF-002",
      "name": "Auto-transition: procurement complete",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T23:45:00Z",
      "description": "Auto-advance when all brands evaluated",
      "notes": "Implementation already exists in workflow_service.py. Functions: check_all_procurement_complete() - checks if ALL quote_items have procurement_status='completed' and returns completion stats (is_complete, total_items, completed_items, pending_items). complete_procurement() - validates role (procurement/admin), validates status (must be pending_procurement), validates not already completed, checks all items complete, sets procurement_completed_at timestamp, transitions to pending_logistics, logs transition. Added 11 tests in TestProcurementAutoTransition class."
    },
    {
      "id": "WF-003",
      "name": "Auto-transition: logistics+customs complete",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T23:45:00Z",
      "description": "Auto-advance when BOTH logistics and customs done",
      "notes": "Implementation already exists in workflow_service.py. Functions: complete_logistics() - validates role (logistics/admin), sets logistics_completed_at, triggers auto-transition check. complete_customs() - validates role (customs/admin), sets customs_completed_at, triggers auto-transition check. check_and_auto_transition_to_sales_review() - if BOTH completed, transitions to pending_sales_review. get_parallel_stages_status() - returns dict with logistics_completed, customs_completed, both_completed flags. Added 9 tests in TestLogisticsCustomsAutoTransition class."
    },
    {
      "id": "WF-004",
      "name": "Approval request creation",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-16T00:00:00Z",
      "description": "Create approval request with reason detection",
      "notes": "Implementation already exists in approval_service.py. request_approval() function (Feature #65) performs complete workflow: validates quote status (pending_quote_control), transitions to pending_approval, creates Approval records for all top_manager/admin users, sends Telegram notifications. ApprovalRequestResult dataclass captures success, quote_id, approvals_created, notifications_sent. create_approval() handles individual approval creation. create_approvals_for_role() creates for all users with specified role. Created tests/test_approval_service.py with 28 passing tests including dataclass tests, validation tests, create operations tests, import verification, service integration tests."
    },
    {
      "id": "WF-005",
      "name": "Approval with modifications",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Allow top_manager to modify quote during approval"
    },
    {
      "id": "WF-006",
      "name": "Quote versioning service",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-16T00:15:00Z",
      "description": "Create new versions during client_negotiation",
      "notes": "Implementation exists in quote_version_service.py. create_quote_version() creates immutable snapshot with auto-incrementing version number, stores: variables (with Decimal→float conversion), products snapshot, calculation results, totals, exchange rate info, change_reason. list_quote_versions() returns ordered list with transformed UI-compatible data. get_quote_version() fetches specific version with full details. Exported in services/__init__.py. Created tests/test_quote_version_service.py with 16 passing tests covering version creation, incrementation, data conversion, list/get operations, and edge cases."
    },
    {
      "id": "SPEC-001",
      "name": "Specification creation service",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-16T00:30:00Z",
      "description": "Create specification from selected quote version",
      "notes": "Implementation exists in specification_service.py. Specification dataclass with 25+ fields covering identification, dates, currency, origin, legal entities, status. create_specification() for basic creation. create_specification_from_quote() extracts data from quote and optional version, prefills fields. CreateSpecFromQuoteResult dataclass returns success, specification, error, prefilled_fields. Status workflow with SPEC_STATUSES (draft, pending_review, approved, signed) and transition validation. Created tests/test_specification_service.py with 28 passing tests."
    },
    {
      "id": "SPEC-002",
      "name": "Specification PDF generation",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-16T00:30:00Z",
      "description": "Generate PDF with all required fields",
      "notes": "Implementation exists in specification_export.py. generate_specification_pdf() and generate_spec_pdf_from_spec_id() create PDF from specification data. SpecificationData dataclass holds all data needed for PDF. fetch_specification_data() retrieves data from DB. generate_spec_pdf_html() creates HTML template for PDF conversion. Export includes products table, totals, currency info, legal entities. Tests verify imports."
    },
    {
      "id": "SPEC-003",
      "name": "Signed scan upload and storage",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-16T00:30:00Z",
      "description": "Upload and store signed specification scans",
      "notes": "Implementation exists in specification_service.py. set_signed_scan_url() updates specification with URL of signed scan. signed_scan_url field in Specification dataclass. get_specifications_for_signing() finds approved specs without signed scan. get_recently_signed_specifications() lists recently signed. Tests verify set_signed_scan_url functionality."
    },
    {
      "id": "DEAL-001",
      "name": "Deal creation from specification",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "description": "Create deal when specification is confirmed"
    },
    {
      "id": "DEAL-002",
      "name": "Plan-fact auto-generation",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T20:30:00Z",
      "description": "Generate planned payments from deal terms",
      "notes": "Implementation exists in services/plan_fact_service.py with: GeneratePlanFactResult dataclass, generate_plan_fact_from_deal() function that reads deal/spec/quote data, extracts calculation variables (advance percentages, timing), calculates totals (purchase, logistics, customs), and generates plan_fact_items for client payments (advance+remaining), supplier payments (advance+remaining), logistics costs, customs costs, and bank commissions. Also includes regenerate_plan_fact_for_deal() wrapper and get_plan_fact_generation_preview() for UI preview before generation. Tests: tests/test_plan_fact_generation.py with 44 passing tests."
    },
    {
      "id": "DEAL-003",
      "name": "Plan-fact actual payment registration",
      "category": "backend",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T21:00:00Z",
      "description": "Register actual payments with variance calculation",
      "notes": "Implemented in services/plan_fact_service.py with: RegisterPaymentResult dataclass, validation functions (validate_payment_amount, validate_payment_date, validate_payment_currency, validate_payment_document, validate_payment_data), register_payment_for_item() main function with comprehensive validation/variance calculation, register_partial_payment() for partial payments, bulk_register_payments() for batch operations, get_payment_registration_preview() for UI pre-fill, get_variance_summary() for post-payment analysis. Constants: SUPPORTED_PAYMENT_CURRENCIES, MIN/MAX_EXCHANGE_RATE, SIGNIFICANT_VARIANCE_THRESHOLD, MAX_OVERPAYMENT_RATIO. Tests: tests/test_payment_registration.py with 62 passing tests."
    },
    {
      "id": "UI-001",
      "name": "Suppliers list page",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "description": "List, search, filter suppliers",
      "completed_at": "2026-01-15T19:52:04.469243",
      "notes": "Implemented in main.py:\n- GET /suppliers - List page with search, country filter, status filter\n- GET /suppliers/{id} - Detail view page\n- Permission check for admin/procurement roles\n- Uses supplier_service functions: get_all_suppliers, search_suppliers, get_unique_countries, get_supplier_stats\n- Stats cards showing total/active/inactive counts\n- Table with: Code, Name, Location, INN, Contact, Email, Status, Actions\n- Russian UI labels"
    },
    {
      "id": "UI-002",
      "name": "Supplier form (create/edit)",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "description": "Form with all supplier fields",
      "completed_at": "2026-01-15T19:53:35.244854",
      "notes": "Implemented in main.py:\n- _supplier_form() helper function for rendering create/edit forms\n- GET /suppliers/new - Create form page\n- POST /suppliers/new - Handle creation\n- GET /suppliers/{id}/edit - Edit form page\n- POST /suppliers/{id}/edit - Handle update\n- POST /suppliers/{id}/delete - Soft delete (deactivate)\n- Form sections: Main info, Location, Legal (INN/KPP), Contact, Payment terms, Status\n- Validation: supplier_code format (3 uppercase letters), INN/KPP patterns\n- Permission check: admin or procurement role required\n- Russian UI labels, error handling, redirect on success"
    },
    {
      "id": "UI-003",
      "name": "Buyer companies list page",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T22:10:00Z",
      "description": "List our purchasing legal entities",
      "notes": "Implemented in main.py:\n- GET /buyer-companies - List page with search and status filter\n- GET /buyer-companies/{id} - Detail view page\n- Permission check: admin role required\n- Uses buyer_company_service: get_all_buyer_companies, search_buyer_companies, get_buyer_company_stats\n- Stats cards showing total/active/inactive counts\n- Table with: Code, Name, INN, KPP, OGRN, Director, Status, Actions\n- Info alert explaining what buyer companies are (our legal entities for purchasing)\n- Russian UI labels, filter form, empty state handling"
    },
    {
      "id": "UI-004",
      "name": "Buyer company form",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-16T03:00:00Z",
      "description": "Form with all buyer company fields",
      "notes": "Implemented in main.py:\n- _buyer_company_form() helper renders create/edit form\n- GET /buyer-companies/new - Create form page\n- POST /buyer-companies/new - Handle creation with validation\n- GET /buyer-companies/{id}/edit - Edit form page\n- POST /buyer-companies/{id}/edit - Handle update\n- POST /buyer-companies/{id}/delete - Soft delete (deactivate)\n- Form sections: Main info (code, name, country), Legal (INN/KPP/OGRN), Address, Director info, Status\n- Validation: company_code (3 uppercase letters), INN (10 digits required), KPP (9 digits), OGRN (13 digits)\n- Permission: admin role only\n- Russian UI labels, error handling, redirect on success"
    },
    {
      "id": "UI-005",
      "name": "Seller companies list page",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T23:00:00Z",
      "description": "List our selling legal entities",
      "notes": "Added GET /seller-companies list page and GET /seller-companies/{id} detail view. Admin only access. Table shows: code, name, country, INN, KPP, director, status. Search by name/code/INN. Filter by status. Stats cards showing total/active/inactive."
    },
    {
      "id": "UI-006",
      "name": "Seller company form",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T23:10:00Z",
      "description": "Form with all seller company fields",
      "notes": "Added _seller_company_form() helper function and 4 routes: GET/POST /seller-companies/new (create), GET/POST /seller-companies/{id}/edit (update), POST /seller-companies/{id}/delete (soft delete). Form sections: code (3 letters for IDN), name, country, legal (INN 10/12 digits, KPP 9 digits, OGRN 13/15 digits supporting both legal entities and IEs), registration address, director info, status checkbox. Russian UI labels. Admin only access."
    },
    {
      "id": "UI-007",
      "name": "Customers list with contacts preview",
      "category": "frontend",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T21:00:00Z",
      "description": "List customers showing primary contact",
      "notes": "Created GET /customers route with v3.0 features: search by name/INN, status filter, stats cards (total/active/with_contacts/with_signatory), contacts preview with signatory and primary badges. Created GET /customers/{id} detail page with: full customer info, addresses (including warehouses), director info, and contacts table with edit links. Uses customer_service functions. Russian localization. Permission check: admin, sales, or top_manager roles."
    },
    {
      "id": "UI-008",
      "name": "Customer detail page with contacts",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Customer details with embedded contacts list"
    },
    {
      "id": "UI-009",
      "name": "Customer contracts list",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "List contracts for customer"
    },
    {
      "id": "UI-010",
      "name": "Locations directory page",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Manage locations"
    },
    {
      "id": "UI-011",
      "name": "Location dropdown component with HTMX search",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Reusable dropdown with search"
    },
    {
      "id": "UI-012",
      "name": "Supplier invoices registry page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "List invoices with status filters"
    },
    {
      "id": "UI-013",
      "name": "Supplier invoice detail page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Invoice with items and payments"
    },
    {
      "id": "UI-014",
      "name": "Invoice payment form",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Register payment with buyer_company selection"
    },
    {
      "id": "UI-015",
      "name": "Quote form: seller company selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select seller company at quote level"
    },
    {
      "id": "UI-016",
      "name": "Quote item form: supplier selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select supplier at item level"
    },
    {
      "id": "UI-017",
      "name": "Quote item form: buyer company selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select buyer company at item level"
    },
    {
      "id": "UI-018",
      "name": "Quote item form: pickup location selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Location dropdown with search for pickup"
    },
    {
      "id": "UI-019",
      "name": "Procurement workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View filtered by assigned brands with editable procurement fields"
    },
    {
      "id": "UI-020",
      "name": "Logistics workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View filtered by assigned routes with logistics fields"
    },
    {
      "id": "UI-021",
      "name": "Customs workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View for customs stage with HS code, duty fields"
    },
    {
      "id": "UI-022",
      "name": "Quote controller checklist view",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Checklist UI for quote controller role"
    },
    {
      "id": "UI-023",
      "name": "Specification controller view (before send)",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Spec data entry form with PDF preview"
    },
    {
      "id": "UI-024",
      "name": "Specification controller view (after signature)",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Scan upload and verification"
    },
    {
      "id": "UI-025",
      "name": "Deal detail page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Show deal info and plan-fact summary"
    },
    {
      "id": "UI-026",
      "name": "Plan-fact table view",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Planned vs actual payments with variance"
    },
    {
      "id": "UI-027",
      "name": "Payment registration form",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Register actual payment with exchange rate"
    },
    {
      "id": "UI-028",
      "name": "Admin: brand assignments page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Assign brands to procurement managers"
    },
    {
      "id": "UI-029",
      "name": "Admin: route assignments page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Assign routes to logistics managers"
    },
    {
      "id": "UI-030",
      "name": "Admin: role view switcher",
      "category": "frontend",
      "priority": 3,
      "passes": false,
      "description": "Allow admin to preview UI as different roles"
    },
    {
      "id": "UI-031",
      "name": "Workflow status badge component",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Visual status indicator with color coding"
    },
    {
      "id": "UI-032",
      "name": "Workflow progress bar component",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Visual workflow progress indicator"
    },
    {
      "id": "UI-033",
      "name": "Workflow transition history",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Timeline of status transitions"
    },
    {
      "id": "UI-034",
      "name": "Quote version selector",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Select version during client_negotiation"
    },
    {
      "id": "UI-035",
      "name": "IDN display component",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Display IDN with copy-to-clipboard"
    },
    {
      "id": "TG-001",
      "name": "Telegram bot setup",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Create bot, configure webhook"
    },
    {
      "id": "TG-002",
      "name": "Telegram account linking",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Verification code flow"
    },
    {
      "id": "TG-003",
      "name": "Task notification messages",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Send notifications when tasks assigned"
    },
    {
      "id": "TG-004",
      "name": "Approval inline buttons",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Approve/reject buttons for top_manager"
    },
    {
      "id": "TEST-001",
      "name": "Database migration tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test all migrations apply cleanly"
    },
    {
      "id": "TEST-002",
      "name": "API endpoint tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test CRUD operations for all entities"
    },
    {
      "id": "TEST-003",
      "name": "Workflow transition tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test valid and invalid transitions"
    },
    {
      "id": "TEST-004",
      "name": "Role permission tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test field access by role"
    }
  ]
}