{
  "project": "OneStack Workflow Extension",
  "description": "Расширение OneStack с многоролевым workflow, Telegram-уведомлениями и план-фактом",
  "created": "2025-01-14T00:00:00Z",
  "stack": "Python FastHTML + HTMX + Supabase + python-telegram-bot",
  "spec_file": ".claude/autonomous/app_spec.xml",
  "features": [
    {
      "id": 1,
      "category": "database",
      "name": "Создать таблицу roles",
      "description": "SQL миграция для справочника ролей (sales, procurement, logistics, customs, quote_controller, spec_controller, finance, top_manager, admin)",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T04:40:00Z",
      "completed_at": "2025-01-15T04:45:00Z"
    },
    {
      "id": 2,
      "category": "database",
      "name": "Создать таблицу user_roles",
      "description": "SQL миграция для связи пользователей с ролями (user_id, organization_id, role_id)",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T05:00:00Z",
      "completed_at": "2025-01-15T05:05:00Z"
    },
    {
      "id": 3,
      "category": "database",
      "name": "Создать таблицу brand_assignments",
      "description": "SQL миграция для назначения брендов менеджерам по закупкам",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:00:00Z",
      "completed_at": "2025-01-15T06:05:00Z"
    },
    {
      "id": 4,
      "category": "database",
      "name": "Создать таблицу workflow_transitions",
      "description": "SQL миграция для аудит-лога переходов статусов",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T07:00:00Z",
      "completed_at": "2025-01-15T07:05:00Z"
    },
    {
      "id": 5,
      "category": "database",
      "name": "Создать таблицу approvals",
      "description": "SQL миграция для запросов на согласование",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T08:00:00Z",
      "completed_at": "2025-01-15T08:05:00Z"
    },
    {
      "id": 6,
      "category": "database",
      "name": "Создать таблицу specifications",
      "description": "SQL миграция для данных спецификаций (все поля из spec_controller)",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T09:00:00Z",
      "completed_at": "2025-01-15T09:05:00Z"
    },
    {
      "id": 7,
      "category": "database",
      "name": "Создать таблицу deals",
      "description": "SQL миграция для сделок (подписанные спецификации)",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T10:00:00Z",
      "completed_at": "2025-01-15T10:05:00Z"
    },
    {
      "id": 8,
      "category": "database",
      "name": "Создать таблицу plan_fact_categories",
      "description": "SQL миграция для справочника категорий платежей",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T11:00:00Z",
      "completed_at": "2025-01-15T11:05:00Z"
    },
    {
      "id": 9,
      "category": "database",
      "name": "Создать таблицу plan_fact_items",
      "description": "SQL миграция для записей план-факта",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T12:00:00Z",
      "completed_at": "2025-01-15T12:05:00Z"
    },
    {
      "id": 10,
      "category": "database",
      "name": "Создать таблицу telegram_users",
      "description": "SQL миграция для связи Telegram с пользователями",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T05:00:00Z",
      "completed_at": "2025-01-15T05:10:00Z"
    },
    {
      "id": 11,
      "category": "database",
      "name": "Создать таблицу notifications",
      "description": "SQL миграция для истории уведомлений",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:00:00Z",
      "completed_at": "2025-01-15T06:10:00Z"
    },
    {
      "id": 12,
      "category": "database",
      "name": "Расширить таблицу quotes",
      "description": "Добавить поля workflow_status, deal_type, assigned_*_users, *_completed_at",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:30:00Z",
      "completed_at": "2025-01-15T06:35:00Z"
    },
    {
      "id": 13,
      "category": "database",
      "name": "Расширить таблицу quote_items",
      "description": "Добавить поля assigned_procurement_user, procurement_status, hs_code, customs_duty, customs_extra",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T07:00:00Z",
      "completed_at": "2025-01-15T07:10:00Z"
    },
    {
      "id": 14,
      "category": "database",
      "name": "Заполнить справочник roles",
      "description": "INSERT данных для всех 9 ролей",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T07:30:00Z",
      "completed_at": "2025-01-15T07:35:00Z",
      "notes": "Already included in migration 001_create_roles_table.sql"
    },
    {
      "id": 15,
      "category": "database",
      "name": "Заполнить справочник plan_fact_categories",
      "description": "INSERT категорий: client_payment, supplier_payment, logistics, customs, tax, finance_commission, other",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T07:40:00Z",
      "completed_at": "2025-01-15T07:45:00Z"
    },
    {
      "id": 16,
      "category": "database",
      "name": "Настроить RLS для новых таблиц",
      "description": "Row Level Security политики для всех новых таблиц",
      "priority": 1,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T08:00:00Z",
      "completed_at": "2025-01-15T08:10:00Z",
      "notes": "RLS policies were included in each table's migration file. Created verification migration 015 with helper functions."
    },
    {
      "id": 17,
      "category": "roles",
      "name": "Сервис ролей: получение ролей пользователя",
      "description": "Функция get_user_roles(user_id, org_id) → список ролей",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T09:00:00Z",
      "completed_at": "2025-01-15T09:10:00Z"
    },
    {
      "id": 18,
      "category": "roles",
      "name": "Сервис ролей: проверка наличия роли",
      "description": "Функция has_role(user_id, org_id, role_code) → bool",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T10:00:00Z",
      "completed_at": "2025-01-15T10:15:00Z"
    },
    {
      "id": 19,
      "category": "roles",
      "name": "Сервис ролей: назначение роли",
      "description": "Функция assign_role(user_id, org_id, role_code, assigned_by)",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T11:00:00Z",
      "completed_at": "2025-01-15T11:10:00Z"
    },
    {
      "id": 20,
      "category": "roles",
      "name": "Сервис ролей: удаление роли",
      "description": "Функция remove_role(user_id, org_id, role_code)",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T12:00:00Z",
      "completed_at": "2025-01-15T12:10:00Z"
    },
    {
      "id": 21,
      "category": "roles",
      "name": "Middleware require_role",
      "description": "Декоратор/функция для проверки роли на route",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T13:00:00Z",
      "completed_at": "2025-01-15T13:15:00Z"
    },
    {
      "id": 22,
      "category": "roles",
      "name": "Контекст пользователя с ролями",
      "description": "Расширить session['user'] информацией о ролях",
      "priority": 2,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T14:00:00Z",
      "completed_at": "2025-01-15T14:15:00Z"
    },
    {
      "id": 23,
      "category": "workflow",
      "name": "Enum статусов workflow",
      "description": "Определить все статусы и допустимые переходы",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T15:00:00Z",
      "completed_at": "2025-01-15T15:30:00Z"
    },
    {
      "id": 24,
      "category": "workflow",
      "name": "Матрица переходов статусов",
      "description": "Кто может перевести из какого статуса в какой",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T16:00:00Z",
      "completed_at": "2025-01-15T16:30:00Z"
    },
    {
      "id": 25,
      "category": "workflow",
      "name": "Сервис перехода статуса",
      "description": "Функция transition_quote_status(quote_id, to_status, actor_id, comment)",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T17:00:00Z",
      "completed_at": "2025-01-15T17:30:00Z"
    },
    {
      "id": 26,
      "category": "workflow",
      "name": "Валидация перехода статуса",
      "description": "Проверка что переход разрешён для данной роли и текущего статуса",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T17:00:00Z",
      "completed_at": "2025-01-15T17:30:00Z",
      "notes": "Implemented within transition_quote_status() - can_transition() validates roles and status"
    },
    {
      "id": 27,
      "category": "workflow",
      "name": "Логирование переходов",
      "description": "Запись в workflow_transitions при каждом переходе",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T17:00:00Z",
      "completed_at": "2025-01-15T17:30:00Z",
      "notes": "Implemented within transition_quote_status() - Step 5 logs to workflow_transitions table"
    },
    {
      "id": 28,
      "category": "workflow",
      "name": "Автопереход logistics+customs → sales_review",
      "description": "Когда оба этапа завершены, автоматический переход",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T18:00:00Z",
      "completed_at": "2025-01-15T18:30:00Z"
    },
    {
      "id": 29,
      "category": "workflow",
      "name": "Назначение исполнителей при переходе",
      "description": "Автоматическое назначение procurement users по брендам при переходе в pending_procurement",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T19:00:00Z",
      "completed_at": "2025-01-15T19:30:00Z"
    },
    {
      "id": 30,
      "category": "brands",
      "name": "Сервис назначений брендов",
      "description": "CRUD для brand_assignments",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T20:00:00Z",
      "completed_at": "2025-01-15T20:30:00Z"
    },
    {
      "id": 31,
      "category": "brands",
      "name": "Получение менеджера по бренду",
      "description": "Функция get_procurement_manager(org_id, brand) → user_id",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T20:30:00Z",
      "completed_at": "2025-01-15T20:35:00Z"
    },
    {
      "id": 32,
      "category": "brands",
      "name": "Получение брендов менеджера",
      "description": "Функция get_assigned_brands(user_id, org_id) → list[brand]",
      "priority": 3,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T20:35:00Z",
      "completed_at": "2025-01-15T20:40:00Z"
    },
    {
      "id": 33,
      "category": "ui_procurement",
      "name": "Страница /procurement",
      "description": "Рабочая зона менеджера по закупкам",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T05:52:00Z",
      "completed_at": "2025-01-15T06:00:00Z"
    },
    {
      "id": 34,
      "category": "ui_procurement",
      "name": "Список КП с моими брендами",
      "description": "Фильтрованный список КП где есть позиции с моими брендами",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:15:00Z",
      "completed_at": "2025-01-15T06:30:00Z"
    },
    {
      "id": 35,
      "category": "ui_procurement",
      "name": "Форма ввода закупочных данных",
      "description": "Цена, страна/город, вес, срок производства, условия оплаты поставщику",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T12:00:00Z",
      "completed_at": "2025-01-15T12:30:00Z"
    },
    {
      "id": 36,
      "category": "ui_procurement",
      "name": "Скачивание списка для оценки",
      "description": "Excel export позиций КП для отправки поставщику",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T13:00:00Z",
      "completed_at": "2025-01-15T13:30:00Z"
    },
    {
      "id": 37,
      "category": "ui_procurement",
      "name": "Кнопка завершения оценки",
      "description": "Отметить свою часть как выполненную",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T22:00:00Z",
      "completed_at": "2025-01-15T22:30:00Z"
    },
    {
      "id": 38,
      "category": "ui_logistics",
      "name": "Страница /logistics",
      "description": "Рабочая зона логиста",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T23:00:00Z",
      "completed_at": "2025-01-15T23:30:00Z"
    },
    {
      "id": 39,
      "category": "ui_logistics",
      "name": "Список КП на этапе логистики",
      "description": "КП со статусом pending_logistics",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T23:30:00Z",
      "completed_at": "2025-01-15T23:31:00Z",
      "notes": "Already implemented in Feature #38 - /logistics page shows quotes filtered by pending_logistics status"
    },
    {
      "id": 40,
      "category": "ui_logistics",
      "name": "Форма ввода логистики",
      "description": "Стоимость по сегментам, срок доставки",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T23:35:00Z",
      "completed_at": "2025-01-15T23:50:00Z",
      "notes": "Created /logistics/{quote_id} page with form for logistics costs and delivery time. Data stored in quote_calculation_variables."
    },
    {
      "id": 41,
      "category": "ui_logistics",
      "name": "Кнопка завершения логистики",
      "description": "Завершить этап логистики",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T23:50:00Z",
      "completed_at": "2025-01-15T23:51:00Z",
      "notes": "Implemented in Feature #40 - form includes 'Завершить логистику' button that calls complete_logistics()"
    },
    {
      "id": 42,
      "category": "ui_customs",
      "name": "Страница /customs",
      "description": "Рабочая зона менеджера ТО",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:30:00Z",
      "completed_at": "2025-01-15T06:32:00Z",
      "notes": "Created /customs route with customs workspace page. Includes parallel stages status, filtering, role check for customs/admin."
    },
    {
      "id": 43,
      "category": "ui_customs",
      "name": "Список КП на этапе таможни",
      "description": "КП со статусом pending_customs",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T06:30:00Z",
      "completed_at": "2025-01-15T06:32:00Z",
      "notes": "Already implemented in Feature #42 - /customs page shows quotes filtered by pending_customs and pending_logistics status"
    },
    {
      "id": 44,
      "category": "ui_customs",
      "name": "Форма ввода таможенных данных",
      "description": "Коды ТН ВЭД, пошлины, доп. расходы",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T09:00:00Z",
      "completed_at": "2025-01-15T09:30:00Z",
      "notes": "Created /customs/{quote_id} GET page with per-item form for HS codes, duty %, and extra charges. Includes progress tracking and parallel stage status."
    },
    {
      "id": 45,
      "category": "ui_customs",
      "name": "Кнопка завершения таможни",
      "description": "Завершить этап таможни",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T09:30:00Z",
      "completed_at": "2025-01-15T09:35:00Z",
      "notes": "Implemented in Feature #44 - form includes 'Завершить таможню' button that calls complete_customs()"
    },
    {
      "id": 46,
      "category": "ui_quote_control",
      "name": "Страница /quote-control",
      "description": "Рабочая зона контроллера КП (Жанна)",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T12:00:00Z",
      "completed_at": "2025-01-15T12:30:00Z",
      "notes": "Created /quote-control route with stats, status filter, pending/awaiting/approved quote lists. Added quote_controller link to nav bar."
    },
    {
      "id": 47,
      "category": "ui_quote_control",
      "name": "Список КП на проверке",
      "description": "КП со статусом pending_quote_control",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T12:30:00Z",
      "completed_at": "2025-01-15T12:31:00Z",
      "notes": "Already implemented in Feature #46 - /quote-control page shows quotes filtered by pending_quote_control status"
    },
    {
      "id": 48,
      "category": "ui_quote_control",
      "name": "Чек-лист проверки КП",
      "description": "Все пункты проверки Жанны с чекбоксами",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T16:00:00Z",
      "completed_at": "2025-01-15T16:30:00Z",
      "notes": "Created /quote-control/{quote_id} page with full 10-item checklist. Auto-detects approval requirements (RUB currency, <100% prepayment, low markup, LPR reward). Shows color-coded status for each item."
    },
    {
      "id": 49,
      "category": "ui_quote_control",
      "name": "Форма возврата на доработку",
      "description": "Комментарий и кнопка возврата",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T18:00:00Z",
      "completed_at": "2025-01-15T18:30:00Z",
      "notes": "Created /quote-control/{quote_id}/return GET route for return form and POST handler. Form requires comment, uses transition_quote_status to move to PENDING_SALES_REVIEW."
    },
    {
      "id": 50,
      "category": "ui_quote_control",
      "name": "Кнопка отправки на согласование",
      "description": "Запрос согласования топ-менеджера с причиной",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T18:35:00Z",
      "completed_at": "2025-01-15T19:00:00Z",
      "notes": "Created /quote-control/{quote_id}/request-approval GET route for form and POST handler. Auto-detects approval reasons, pre-fills comment. Transitions to PENDING_APPROVAL."
    },
    {
      "id": 51,
      "category": "ui_quote_control",
      "name": "Кнопка одобрения КП",
      "description": "Одобрить и отправить менеджеру продаж",
      "priority": 4,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T19:05:00Z",
      "completed_at": "2025-01-15T19:30:00Z",
      "notes": "Created /quote-control/{quote_id}/approve GET/POST routes. Checks if approval is needed, redirects to request-approval if yes. Direct approval to APPROVED status."
    },
    {
      "id": 52,
      "category": "telegram",
      "name": "Создание Telegram-бота",
      "description": "Регистрация бота в BotFather, получение токена",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T20:00:00Z",
      "completed_at": "2025-01-15T20:30:00Z",
      "notes": "Created services/telegram_service.py with full bot infrastructure: Bot initialization, NotificationType enum, message templates, inline keyboards for approvals, send_message/send_notification/send_approval_request functions, webhook management, callback data parsing. Added python-telegram-bot>=21.0 to requirements.txt. Updated .env.example with TELEGRAM_BOT_TOKEN and TELEGRAM_WEBHOOK_URL variables."
    },
    {
      "id": 53,
      "category": "telegram",
      "name": "Webhook endpoint",
      "description": "POST /api/telegram/webhook для получения сообщений",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2025-01-15T21:00:00Z",
      "completed_at": "2025-01-15T21:30:00Z",
      "notes": "Created POST /api/telegram/webhook route in main.py. Added WebhookResult, parse_telegram_update, process_webhook_update, respond_to_command functions to telegram_service.py. Handles text messages, commands (/start, /status, /help), and callback queries (approve, reject, details). Returns JSON responses, always returns 200 OK to prevent Telegram retries."
    },
    {
      "id": 54,
      "category": "telegram",
      "name": "Команда /start",
      "description": "Приветствие и инструкция по привязке",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T07:03:34.246951",
      "completed_at": "2026-01-15T07:05:17.816974"
    },
    {
      "id": 55,
      "category": "telegram",
      "name": "Верификация аккаунта",
      "description": "Привязка telegram_id к user через код",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T07:15:00Z",
      "completed_at": "2026-01-15T07:35:00Z"
    },
    {
      "id": 56,
      "category": "telegram",
      "name": "UI генерации кода верификации",
      "description": "Страница /settings/telegram с кодом",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T08:00:00Z",
      "completed_at": "2026-01-15T08:30:00Z"
    },
    {
      "id": 57,
      "category": "telegram",
      "name": "Команда /status",
      "description": "Показать мои текущие задачи",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T12:00:00Z",
      "completed_at": "2026-01-15T12:30:00Z",
      "notes": "Implemented /status command with role-based task display. Shows tasks for sales, procurement, logistics, customs, quote_controller, and top_manager roles. Includes user info, role badges, task counts by category, and links to system."
    },
    {
      "id": 58,
      "category": "telegram",
      "name": "Отправка уведомления task_assigned",
      "description": "Уведомление о новой задаче",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T13:00:00Z",
      "completed_at": "2026-01-15T13:30:00Z",
      "notes": "Created send_task_assigned_notification() and related functions. Records notifications in DB, sends via Telegram if user has linked account. Added notify_users_of_task_assignment() for multiple users and notify_role_users_of_task() for role-based notifications."
    },
    {
      "id": 59,
      "category": "telegram",
      "name": "Отправка уведомления approval_required",
      "description": "Уведомление топ-менеджеру с кнопками",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T14:00:00Z",
      "completed_at": "2026-01-15T14:30:00Z",
      "notes": "Created send_approval_required_notification() and send_approval_notification_for_quote() functions. Sends to all top_manager/admin users with inline approve/reject/details buttons. Records notifications in DB."
    },
    {
      "id": 60,
      "category": "telegram",
      "name": "Inline-кнопка Согласовать",
      "description": "Callback handler для approve_{quote_id}",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T07:17:00Z",
      "completed_at": "2026-01-15T07:45:00Z",
      "notes": "Implemented handle_approve_callback() and send_callback_response() functions. Validates Telegram link, user role (top_manager/admin), quote status (pending_approval), then transitions to approved. Updates original message to show result."
    },
    {
      "id": 61,
      "category": "telegram",
      "name": "Inline-кнопка Отклонить",
      "description": "Callback handler для reject_{quote_id}",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T08:00:00Z",
      "completed_at": "2026-01-15T08:30:00Z",
      "notes": "Implemented handle_reject_callback() function. Validates Telegram link, user role (top_manager/admin), quote status (pending_approval), then transitions to rejected. Uses default rejection comment for Telegram rejections. Updates original message to show result."
    },
    {
      "id": 62,
      "category": "telegram",
      "name": "Уведомление status_changed",
      "description": "Уведомление об изменении статуса",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T09:00:00Z",
      "completed_at": "2026-01-15T09:30:00Z",
      "notes": "Implemented status_changed notification functionality: StatusChangedNotification dataclass, send_status_changed_notification() for sending to individual users, notify_quote_creator_of_status_change() for notifying quote creator, and notify_assigned_users_of_status_change() for notifying all assigned users (creator, procurement, logistics, customs). Skips actor from notification (they made the change). Records in DB and sends via Telegram if linked."
    },
    {
      "id": 63,
      "category": "telegram",
      "name": "Уведомление returned_for_revision",
      "description": "Уведомление о возврате на доработку",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T10:00:00Z",
      "completed_at": "2026-01-15T10:30:00Z",
      "notes": "Implemented returned_for_revision notification functionality: ReturnedForRevisionNotification dataclass, send_returned_for_revision_notification() for sending to individual users with Telegram message and DB recording, notify_creator_of_return() convenience function that fetches quote details and notifies creator. Integrated into /quote-control/{quote_id}/return POST handler to send notification on successful return."
    },
    {
      "id": 64,
      "category": "approvals",
      "name": "Сервис согласований",
      "description": "CRUD для таблицы approvals",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T11:00:00Z",
      "completed_at": "2026-01-15T11:30:00Z",
      "notes": "Created approval_service.py with full CRUD operations: Approval dataclass, create_approval(), create_approvals_for_role(), get_approval(), get_approval_by_quote(), get_approvals_for_quote(), get_pending_approval_for_quote(), get_pending_approvals_for_user(), get_approvals_requested_by(), get_approvals_with_details(), count_pending_approvals(), update_approval_status(), approve_quote_approval(), reject_quote_approval(), cancel_pending_approvals_for_quote(), has_pending_approval(), get_latest_approval_decision(), get_approval_stats_for_user(). Updated services/__init__.py with all exports."
    },
    {
      "id": 65,
      "category": "approvals",
      "name": "Создание запроса на согласование",
      "description": "Функция request_approval(quote_id, approver_id, reason)",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T12:00:00Z",
      "completed_at": "2026-01-15T12:30:00Z",
      "notes": "Created request_approval() function in approval_service.py with ApprovalRequestResult dataclass. Function performs complete workflow: validates quote status, transitions to pending_approval, creates approval records for top_manager/admin users via create_approvals_for_role(), sends Telegram notifications via send_approval_notification_for_quote(). Updated main.py POST handler at /quote-control/{quote_id}/request-approval to use the new function. Now shows approvals_created and notifications_sent counts on success."
    },
    {
      "id": 66,
      "category": "approvals",
      "name": "Обработка решения согласования",
      "description": "Функция process_approval_decision(approval_id, decision, comment)",
      "priority": 5,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T14:00:00Z",
      "completed_at": "2026-01-15T14:30:00Z",
      "notes": "Created process_approval_decision() function with ApprovalDecisionResult dataclass. Complete workflow: validates approval exists and is pending, validates quote is in pending_approval status, updates approval record, transitions quote to approved/rejected, cancels other pending approvals, sends notifications to creator and requester. Updated services/__init__.py with all exports."
    },
    {
      "id": 67,
      "category": "ui_spec_control",
      "name": "Страница /spec-control",
      "description": "Рабочая зона контроллера спецификаций",
      "priority": 6,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T15:00:00Z",
      "completed_at": "2026-01-15T15:30:00Z",
      "notes": "Created /spec-control route with workspace page for spec_controller role. Shows quotes pending specification creation (pending_spec_control status), specifications grouped by status (draft, pending_review, approved, signed). Added 'Спецификации' link to nav_bar for spec_controller/admin roles. Stats cards, status filter, action buttons for each item."
    },
    {
      "id": 68,
      "category": "ui_spec_control",
      "name": "Список спецификаций на проверке",
      "description": "Спецификации со статусом pending_review",
      "priority": 6,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T15:00:00Z",
      "completed_at": "2026-01-15T15:30:00Z",
      "notes": "Already implemented in Feature #67 - /spec-control page shows specifications at pending_review status in dedicated section with filtering support."
    },
    {
      "id": 69,
      "category": "ui_spec_control",
      "name": "Форма ввода данных спецификации",
      "description": "Все 18 полей из specifications",
      "priority": 6,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T16:00:00Z",
      "completed_at": "2026-01-15T16:45:00Z",
      "notes": "Implemented /spec-control/create/{quote_id} for creating new specifications and /spec-control/{spec_id} for viewing/editing. Form includes all 18 fields organized in 5 sections: Identification, Dates/Validity, Currency/Payment, Origin/Shipping, Legal Entities. Supports status transitions: draft → pending_review → approved."
    },
    {
      "id": 70,
      "category": "ui_spec_control",
      "name": "Preview PDF спецификации",
      "description": "Предпросмотр сгенерированного PDF",
      "priority": 6,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T17:00:00Z",
      "completed_at": "2026-01-15T17:45:00Z",
      "notes": "Implemented /spec-control/{spec_id}/preview-pdf route. Enhanced specification_export.py with SpecificationData class, fetch_specification_data(), generate_spec_pdf_html(), and generate_spec_pdf_from_spec_id(). Uses all 18 specification fields from the specifications table. Added 'Предпросмотр PDF' button to spec edit page. PDF opens in new tab with inline display."
    },
    {
      "id": 71,
      "category": "ui_spec_control",
      "name": "Загрузка подписанного скана",
      "description": "Upload скана + сохранение URL",
      "priority": 6,
      "passes": true,
      "in_progress": false,
      "started_at": "2026-01-15T19:00:00Z",
      "completed_at": "2026-01-15T19:30:00Z",
      "notes": "Implemented /spec-control/{spec_id}/upload-signed POST endpoint. Accepts PDF/JPG/PNG up to 10MB. Stores in Supabase Storage bucket 'specifications'. Updates signed_scan_url field. Added upload UI section to spec edit page (visible when status is approved/signed). Created migration 017 with storage bucket setup instructions."
    },
    {
      "id": 72,
      "category": "ui_spec_control",
      "name": "Кнопка подтверждения подписи",
      "description": "Перевод спецификации в статус signed → создание deal",
      "priority": 6,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 73,
      "category": "specifications",
      "name": "Сервис спецификаций",
      "description": "CRUD для таблицы specifications",
      "priority": 6,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 74,
      "category": "specifications",
      "name": "Создание спецификации из КП",
      "description": "Функция create_specification_from_quote(quote_id, version_id)",
      "priority": 6,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 75,
      "category": "deals",
      "name": "Сервис сделок",
      "description": "CRUD для таблицы deals",
      "priority": 6,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 76,
      "category": "deals",
      "name": "Создание сделки из спецификации",
      "description": "Функция create_deal_from_specification(specification_id)",
      "priority": 6,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 77,
      "category": "ui_finance",
      "name": "Страница /finance",
      "description": "Рабочая зона финансового менеджера",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 78,
      "category": "ui_finance",
      "name": "Список активных сделок",
      "description": "Сделки со статусом active",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 79,
      "category": "ui_finance",
      "name": "Таблица план-факт по сделке",
      "description": "Все записи plan_fact_items для сделки",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 80,
      "category": "ui_finance",
      "name": "Форма регистрации платежа",
      "description": "Ввод фактического платежа",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 81,
      "category": "plan_fact",
      "name": "Сервис план-факта",
      "description": "CRUD для plan_fact_items",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 82,
      "category": "plan_fact",
      "name": "Автогенерация плановых платежей",
      "description": "Создание plan_fact_items из условий сделки",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 83,
      "category": "plan_fact",
      "name": "Расчёт отклонений",
      "description": "Вычисление variance_amount при регистрации факта",
      "priority": 7,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 84,
      "category": "ui_admin",
      "name": "Страница /admin/users",
      "description": "Управление пользователями и ролями",
      "priority": 8,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 85,
      "category": "ui_admin",
      "name": "Страница /admin/brands",
      "description": "Назначение брендов менеджерам",
      "priority": 8,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 86,
      "category": "dashboard",
      "name": "Обновить dashboard для ролей",
      "description": "Показывать задачи в зависимости от роли",
      "priority": 8,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 87,
      "category": "dashboard",
      "name": "Прогресс-бар workflow на КП",
      "description": "Визуализация текущего этапа workflow",
      "priority": 8,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    },
    {
      "id": 88,
      "category": "audit",
      "name": "Просмотр истории переходов",
      "description": "UI для просмотра workflow_transitions по КП",
      "priority": 8,
      "passes": false,
      "in_progress": false,
      "started_at": null,
      "completed_at": null
    }
  ],
  "completion_criteria": {
    "all_tests_pass": true,
    "no_lint_errors": true,
    "e2e_verified": false
  },
  "session_count": 0,
  "last_session": null
}