{
  "version": "3.0",
  "project": "Kvota OneStack - Quote Workflow System with Supply Chain",
  "description": "Расширение OneStack: 4 типа компаний в цепочке поставок, IDN система, реестр инвойсов поставщиков, 12 ролей",
  "created": "2025-01-15T00:00:00Z",
  "stack": "Python FastHTML + HTMX + Supabase",
  "spec_file": ".claude/autonomous/app_spec.xml",
  "features": [
    {
      "id": "DB-001",
      "name": "Create suppliers table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T16:50:00Z",
      "description": "Create suppliers table with supplier_code, country, city, inn, kpp, contact fields"
    },
    {
      "id": "DB-002",
      "name": "Create buyer_companies table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T17:00:00Z",
      "description": "Create buyer_companies table (our legal entities for purchasing)"
    },
    {
      "id": "DB-003",
      "name": "Verify seller_companies table exists",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Verify seller_companies table from previous migration, add missing columns if needed"
    },
    {
      "id": "DB-004",
      "name": "Create customer_contacts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create customer_contacts table for LPR contacts with is_signatory field"
    },
    {
      "id": "DB-005",
      "name": "Create customer_contracts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create customer_contracts table with next_specification_number counter"
    },
    {
      "id": "DB-006",
      "name": "Create bank_accounts table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "description": "Create universal bank_accounts table with entity_type polymorphism",
      "notes": "Created migration 023_create_bank_accounts_table.sql with polymorphic design (entity_type/entity_id), BIK/SWIFT/IBAN validation, single-default trigger"
    },
    {
      "id": "DB-007",
      "name": "Create locations table migration",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T17:10:00Z",
      "description": "Create locations directory for dropdown with search (country, city, is_hub)",
      "notes": "Created migration 024_create_locations_table.sql with pg_trgm extension, gin index for search, search_locations() function, RLS policies, and create_default_locations() seed function"
    },
    {
      "id": "DB-008",
      "name": "Create brand_supplier_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T17:20:00Z",
      "description": "Link brands to suppliers",
      "notes": "Created migration 025_create_brand_supplier_assignments_table.sql with is_primary flag, single-primary trigger, helper functions: get_primary_supplier_for_brand(), get_suppliers_for_brand(), get_brands_for_supplier()"
    },
    {
      "id": "DB-009",
      "name": "Create brand_procurement_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T17:30:00Z",
      "description": "Assign brands to procurement managers",
      "notes": "Created migration 026_create_brand_procurement_view.sql - view alias for existing brand_assignments table (003) with helper functions: get_procurement_manager_for_brand(), get_brands_for_procurement_manager(), get_procurement_assignments_summary()"
    },
    {
      "id": "DB-010",
      "name": "Create route_logistics_assignments table",
      "category": "database",
      "priority": 2,
      "passes": true,
      "completed_at": "2026-01-15T18:00:00Z",
      "description": "Assign routes to logistics managers with pattern matching",
      "notes": "Created migration 027_create_route_logistics_assignments_table.sql with route_pattern field supporting wildcards (*). Helper functions: match_route_to_logistics_manager(), get_routes_for_logistics_manager(), get_logistics_manager_for_locations(), get_route_assignments_summary(). RLS policies for organization isolation."
    },
    {
      "id": "DB-011",
      "name": "Extend quotes table with new columns",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:10:00Z",
      "description": "Add idn, seller_company_id, workflow_status, deal_type, assigned users, timestamps",
      "notes": "Created migration 028_extend_quotes_v3.sql adding idn (VARCHAR 100), seller_company_id (UUID FK). Added generate_quote_idn() function with IDN format SELLER-INN-YEAR-SEQ. Added auto-generate trigger. Organizations table extended with idn_counters JSONB. Note: workflow_status, deal_type already added in v2.0 migration 012."
    },
    {
      "id": "DB-012",
      "name": "Extend quote_items with supply chain columns",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:20:00Z",
      "description": "Add supplier_id, buyer_company_id, pickup_location_id, procurement fields",
      "notes": "Created migration 029_extend_quote_items_supply_chain.sql with: item_idn, supplier_id FK, buyer_company_id FK, pickup_location_id FK, supplier_payment_terms, supplier_advance_percent, production_time_days, weight_kg, volume_m3. Added generate_item_idn() function, auto-generate trigger, regenerate_item_idns_for_quote() helper, get_item_supply_chain_summary() function."
    },
    {
      "id": "DB-013",
      "name": "Extend quote_items with logistics fields",
      "category": "database",
      "priority": 1,
      "passes": true,
      "completed_at": "2026-01-15T18:30:00Z",
      "description": "Add logistics_supplier_to_hub, logistics_hub_to_customs, logistics_customs_to_customer, logistics_total_days",
      "notes": "Created migration 030_extend_quote_items_logistics.sql with: 4 logistics columns (supplier→hub, hub→customs, customs→customer costs + total_days), check constraints (non-negative costs, positive days), helper functions: get_item_logistics_total(), get_quote_logistics_summary(), is_quote_logistics_complete(), and v_quote_items_logistics view for logistics workspace."
    },
    {
      "id": "DB-014",
      "name": "Extend quote_items with customs fields",
      "category": "database",
      "priority": 1,
      "passes": false,
      "description": "Add hs_code, customs_duty_percent, customs_extra_cost"
    },
    {
      "id": "DB-015",
      "name": "Create supplier_invoices table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Create supplier invoices registry with status tracking"
    },
    {
      "id": "DB-016",
      "name": "Create supplier_invoice_items table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Link invoice items to quote_items"
    },
    {
      "id": "DB-017",
      "name": "Create supplier_invoice_payments table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Track payments with payment_type, buyer_company_id"
    },
    {
      "id": "DB-018",
      "name": "Create workflow_transitions table if not exists",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Audit log for status transitions - verify or create"
    },
    {
      "id": "DB-019",
      "name": "Create approvals table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Track approval requests with modifications JSONB"
    },
    {
      "id": "DB-020",
      "name": "Create specifications table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Store specification exports with all required fields"
    },
    {
      "id": "DB-021",
      "name": "Create deals table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Track completed deals linked to specifications"
    },
    {
      "id": "DB-022",
      "name": "Create plan_fact_categories table with seed data",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Seed payment categories (client_payment, supplier_payment, logistics, customs, tax, etc.)"
    },
    {
      "id": "DB-023",
      "name": "Create plan_fact_items table",
      "category": "database",
      "priority": 2,
      "passes": false,
      "description": "Track planned vs actual payments with variance"
    },
    {
      "id": "DB-024",
      "name": "Create telegram_users table",
      "category": "database",
      "priority": 3,
      "passes": false,
      "description": "Link Telegram accounts to system users"
    },
    {
      "id": "DB-025",
      "name": "Create notifications table",
      "category": "database",
      "priority": 3,
      "passes": false,
      "description": "Store notification history"
    },
    {
      "id": "DB-026",
      "name": "Add RLS policies for all new tables",
      "category": "database",
      "priority": 1,
      "passes": false,
      "description": "Row-level security for organization isolation"
    },
    {
      "id": "IDN-001",
      "name": "Implement IDN generation for quotes",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Generate IDN in format SELLER-INN-YEAR-SEQ using idn_counters"
    },
    {
      "id": "IDN-002",
      "name": "Implement IDN generation for quote items",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Generate item IDN as QUOTE_IDN-POSITION"
    },
    {
      "id": "API-001",
      "name": "CRUD API for suppliers",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Create, read, update, delete suppliers with search"
    },
    {
      "id": "API-002",
      "name": "CRUD API for buyer_companies",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Create, read, update, delete buyer companies"
    },
    {
      "id": "API-003",
      "name": "CRUD API for seller_companies",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Create, read, update, delete seller companies"
    },
    {
      "id": "API-004",
      "name": "CRUD API for customers with contacts",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Manage customers and their contacts"
    },
    {
      "id": "API-005",
      "name": "CRUD API for customer_contracts",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Manage supply contracts"
    },
    {
      "id": "API-006",
      "name": "CRUD API for locations",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Manage locations directory"
    },
    {
      "id": "API-007",
      "name": "Locations search endpoint for dropdown",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Search locations with query parameter for HTMX dropdown"
    },
    {
      "id": "API-008",
      "name": "Brand assignments API",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Manage brand-supplier and brand-procurement assignments"
    },
    {
      "id": "API-009",
      "name": "Route assignments API",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Manage route-logistics assignments"
    },
    {
      "id": "API-010",
      "name": "Supplier invoices CRUD",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Manage supplier invoices with items"
    },
    {
      "id": "API-011",
      "name": "Supplier invoice payments API",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Register and track payments"
    },
    {
      "id": "WF-001",
      "name": "Workflow status transition service",
      "category": "backend",
      "priority": 1,
      "passes": false,
      "description": "Validate and execute status transitions based on role"
    },
    {
      "id": "WF-002",
      "name": "Auto-transition: procurement complete",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Auto-advance when all brands evaluated"
    },
    {
      "id": "WF-003",
      "name": "Auto-transition: logistics+customs complete",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Auto-advance when BOTH logistics and customs done"
    },
    {
      "id": "WF-004",
      "name": "Approval request creation",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Create approval request with reason detection"
    },
    {
      "id": "WF-005",
      "name": "Approval with modifications",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Allow top_manager to modify quote during approval"
    },
    {
      "id": "WF-006",
      "name": "Quote versioning service",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Create new versions during client_negotiation"
    },
    {
      "id": "SPEC-001",
      "name": "Specification creation service",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Create specification from selected quote version"
    },
    {
      "id": "SPEC-002",
      "name": "Specification PDF generation",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Generate PDF with all required fields"
    },
    {
      "id": "SPEC-003",
      "name": "Signed scan upload and storage",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Upload and store signed specification scans"
    },
    {
      "id": "DEAL-001",
      "name": "Deal creation from specification",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Create deal when specification is confirmed"
    },
    {
      "id": "DEAL-002",
      "name": "Plan-fact auto-generation",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Generate planned payments from deal terms"
    },
    {
      "id": "DEAL-003",
      "name": "Plan-fact actual payment registration",
      "category": "backend",
      "priority": 2,
      "passes": false,
      "description": "Register actual payments with variance calculation"
    },
    {
      "id": "UI-001",
      "name": "Suppliers list page",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "List, search, filter suppliers"
    },
    {
      "id": "UI-002",
      "name": "Supplier form (create/edit)",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Form with all supplier fields"
    },
    {
      "id": "UI-003",
      "name": "Buyer companies list page",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "List our purchasing legal entities"
    },
    {
      "id": "UI-004",
      "name": "Buyer company form",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Form with all buyer company fields"
    },
    {
      "id": "UI-005",
      "name": "Seller companies list page",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "List our selling legal entities"
    },
    {
      "id": "UI-006",
      "name": "Seller company form",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Form with all seller company fields"
    },
    {
      "id": "UI-007",
      "name": "Customers list with contacts preview",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "List customers showing primary contact"
    },
    {
      "id": "UI-008",
      "name": "Customer detail page with contacts",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Customer details with embedded contacts list"
    },
    {
      "id": "UI-009",
      "name": "Customer contracts list",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "List contracts for customer"
    },
    {
      "id": "UI-010",
      "name": "Locations directory page",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Manage locations"
    },
    {
      "id": "UI-011",
      "name": "Location dropdown component with HTMX search",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Reusable dropdown with search"
    },
    {
      "id": "UI-012",
      "name": "Supplier invoices registry page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "List invoices with status filters"
    },
    {
      "id": "UI-013",
      "name": "Supplier invoice detail page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Invoice with items and payments"
    },
    {
      "id": "UI-014",
      "name": "Invoice payment form",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Register payment with buyer_company selection"
    },
    {
      "id": "UI-015",
      "name": "Quote form: seller company selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select seller company at quote level"
    },
    {
      "id": "UI-016",
      "name": "Quote item form: supplier selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select supplier at item level"
    },
    {
      "id": "UI-017",
      "name": "Quote item form: buyer company selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Dropdown to select buyer company at item level"
    },
    {
      "id": "UI-018",
      "name": "Quote item form: pickup location selector",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Location dropdown with search for pickup"
    },
    {
      "id": "UI-019",
      "name": "Procurement workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View filtered by assigned brands with editable procurement fields"
    },
    {
      "id": "UI-020",
      "name": "Logistics workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View filtered by assigned routes with logistics fields"
    },
    {
      "id": "UI-021",
      "name": "Customs workspace view",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "View for customs stage with HS code, duty fields"
    },
    {
      "id": "UI-022",
      "name": "Quote controller checklist view",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Checklist UI for quote controller role"
    },
    {
      "id": "UI-023",
      "name": "Specification controller view (before send)",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Spec data entry form with PDF preview"
    },
    {
      "id": "UI-024",
      "name": "Specification controller view (after signature)",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Scan upload and verification"
    },
    {
      "id": "UI-025",
      "name": "Deal detail page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Show deal info and plan-fact summary"
    },
    {
      "id": "UI-026",
      "name": "Plan-fact table view",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Planned vs actual payments with variance"
    },
    {
      "id": "UI-027",
      "name": "Payment registration form",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Register actual payment with exchange rate"
    },
    {
      "id": "UI-028",
      "name": "Admin: brand assignments page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Assign brands to procurement managers"
    },
    {
      "id": "UI-029",
      "name": "Admin: route assignments page",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Assign routes to logistics managers"
    },
    {
      "id": "UI-030",
      "name": "Admin: role view switcher",
      "category": "frontend",
      "priority": 3,
      "passes": false,
      "description": "Allow admin to preview UI as different roles"
    },
    {
      "id": "UI-031",
      "name": "Workflow status badge component",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Visual status indicator with color coding"
    },
    {
      "id": "UI-032",
      "name": "Workflow progress bar component",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Visual workflow progress indicator"
    },
    {
      "id": "UI-033",
      "name": "Workflow transition history",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Timeline of status transitions"
    },
    {
      "id": "UI-034",
      "name": "Quote version selector",
      "category": "frontend",
      "priority": 2,
      "passes": false,
      "description": "Select version during client_negotiation"
    },
    {
      "id": "UI-035",
      "name": "IDN display component",
      "category": "frontend",
      "priority": 1,
      "passes": false,
      "description": "Display IDN with copy-to-clipboard"
    },
    {
      "id": "TG-001",
      "name": "Telegram bot setup",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Create bot, configure webhook"
    },
    {
      "id": "TG-002",
      "name": "Telegram account linking",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Verification code flow"
    },
    {
      "id": "TG-003",
      "name": "Task notification messages",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Send notifications when tasks assigned"
    },
    {
      "id": "TG-004",
      "name": "Approval inline buttons",
      "category": "integration",
      "priority": 3,
      "passes": false,
      "description": "Approve/reject buttons for top_manager"
    },
    {
      "id": "TEST-001",
      "name": "Database migration tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test all migrations apply cleanly"
    },
    {
      "id": "TEST-002",
      "name": "API endpoint tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test CRUD operations for all entities"
    },
    {
      "id": "TEST-003",
      "name": "Workflow transition tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test valid and invalid transitions"
    },
    {
      "id": "TEST-004",
      "name": "Role permission tests",
      "category": "testing",
      "priority": 1,
      "passes": false,
      "description": "Test field access by role"
    }
  ]
}