# OneStack - –¢–∞–±–ª–∏—Ü—ã –≤ Production –ë–î

> **–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2026-01-20
> **–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü OneStack:** 45
> **–°—Ö–µ–º–∞:** public (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `kvota`)

---

## ‚úÖ –¢–∞–±–ª–∏—Ü—ã –≤ Production (45 —à—Ç—É–∫)

### 1Ô∏è‚É£ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (Quotes) - 10 —Ç–∞–±–ª–∏—Ü

```
‚úì quotes
‚úì quote_items
‚úì quote_versions
‚úì quote_approval_history
‚úì quote_calculation_products_versioned
‚úì quote_calculation_results
‚úì quote_calculation_summaries
‚úì quote_calculation_summaries_versioned
‚úì quote_calculation_variables
‚úì quote_export_settings
‚úì quote_timeline_events
‚úì quote_workflow_transitions
```

### 2Ô∏è‚É£ –ü–ª–∞–Ω-–§–∞–∫—Ç (Finance) - 7 —Ç–∞–±–ª–∏—Ü

```
‚úì plan_fact_categories
‚úì plan_fact_items
‚úì plan_fact_financing_recalculated
‚úì plan_fact_logistics_stages
‚úì plan_fact_permissions
‚úì plan_fact_products
‚úì plan_fact_sections
```

### 3Ô∏è‚É£ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ - 5 —Ç–∞–±–ª–∏—Ü

```
‚úì organizations
‚úì organization_members
‚úì organization_currency_history
‚úì organization_exchange_rates
‚úì organization_invitations
‚úì organization_workflow_settings
```

### 4Ô∏è‚É£ –ö–ª–∏–µ–Ω—Ç—ã - 4 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì customers
‚úì customer_contacts
‚úì customer_contracts
‚úì customer_delivery_addresses
```

### 5Ô∏è‚É£ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ - 2 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì suppliers
‚úì supplier_countries
```

### 6Ô∏è‚É£ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –°–¥–µ–ª–∫–∏ - 3 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì specifications
‚úì specification_exports
‚úì deals
```

### 7Ô∏è‚É£ Workflow –∏ –†–æ–ª–∏ - 5 —Ç–∞–±–ª–∏—Ü

```
‚úì roles
‚úì user_roles
‚úì brand_assignments
‚úì approvals
‚úì workflow_transitions
```

### 8Ô∏è‚É£ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - 2 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì notifications
‚úì telegram_users
```

### 9Ô∏è‚É£ –ö–æ–º–ø–∞–Ω–∏–∏ - 2 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì seller_companies
‚úì purchasing_companies
```

### üîü –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ - 2 —Ç–∞–±–ª–∏—Ü—ã

```
‚úì calculation_settings
‚úì exchange_rates
```

### 1Ô∏è‚É£1Ô∏è‚É£ –ü—Ä–æ–¥—É–∫—Ç—ã - 1 —Ç–∞–±–ª–∏—Ü–∞

```
? products - –ù–ï –ù–ê–ô–î–ï–ù–ê! (–Ω—É–∂–Ω–∞ –±–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)
```

---

## ‚ùå –¢–∞–±–ª–∏—Ü—ã –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ Production (9+ —Ç–∞–±–ª–∏—Ü)

### –ú–∏–≥—Ä–∞—Ü–∏–∏ 018-034 (Supply Chain v3.0)

```
‚ùå buyer_companies          (–º–∏–≥—Ä–∞—Ü–∏—è 019)
‚ùå bank_accounts            (–º–∏–≥—Ä–∞—Ü–∏—è 023)
‚ùå locations                (–º–∏–≥—Ä–∞—Ü–∏—è 024)
‚ùå brand_supplier_assignments (–º–∏–≥—Ä–∞—Ü–∏—è 025)
‚ùå route_logistics_assignments (–º–∏–≥—Ä–∞—Ü–∏—è 027)
‚ùå supplier_invoices        (–º–∏–≥—Ä–∞—Ü–∏—è 032)
‚ùå supplier_invoice_items   (–º–∏–≥—Ä–∞—Ü–∏—è 033)
‚ùå supplier_invoice_payments (–º–∏–≥—Ä–∞—Ü–∏—è 034)
```

### –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü

```
‚ö†Ô∏è quotes - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—Å–µ –ø–æ–ª—è –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ 028
‚ö†Ô∏è quote_items - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—Å–µ –ø–æ–ª—è –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–π 029-031
‚ö†Ô∏è specifications - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—Å–µ –ø–æ–ª—è –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ 036
‚ö†Ô∏è deals - –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –≤—Å–µ –ø–æ–ª—è –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ 037
```

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É `kvota`

```sql
CREATE SCHEMA kvota;
GRANT USAGE ON SCHEMA kvota TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA kvota TO authenticated;
ALTER DEFAULT PRIVILEGES IN SCHEMA kvota GRANT ALL ON TABLES TO authenticated;
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ 45 —Ç–∞–±–ª–∏—Ü

```sql
-- Quotes
ALTER TABLE quotes SET SCHEMA kvota;
ALTER TABLE quote_items SET SCHEMA kvota;
ALTER TABLE quote_versions SET SCHEMA kvota;
-- ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö 45 —Ç–∞–±–ª–∏—Ü
```

### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ 018-034
cd migrations
psql -U postgres -d postgres < 018_create_suppliers_table.sql  # (—É–∂–µ –µ—Å—Ç—å suppliers, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
psql -U postgres -d postgres < 019_create_buyer_companies_table.sql
psql -U postgres -d postgres < 023_create_bank_accounts_table.sql
psql -U postgres -d postgres < 024_create_locations_table.sql
psql -U postgres -d postgres < 025_create_brand_supplier_assignments_table.sql
psql -U postgres -d postgres < 027_create_route_logistics_assignments_table.sql
psql -U postgres -d postgres < 032_create_supplier_invoices_table.sql
psql -U postgres -d postgres < 033_create_supplier_invoice_items_table.sql
psql -U postgres -d postgres < 034_create_supplier_invoice_payments_table.sql
```

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ backend

```python
# –í config/settings.py –∏–ª–∏ database.py
SUPABASE_DB_SCHEMA = "kvota"

# –í —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ Supabase
supabase = create_client(
    supabase_url=settings.SUPABASE_URL,
    supabase_key=settings.SUPABASE_KEY,
    options=ClientOptions(
        schema="kvota",
        # –∏–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
        # postgrest_client_timeout=10,
        # search_path="kvota,public"
    )
)
```

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å .env

```bash
DATABASE_SCHEMA=kvota
SUPABASE_SCHEMA=kvota
```

---

## üìä –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ Production

–≠—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –µ—Å—Ç—å –≤ production, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ `migrations/`:

```
+ quote_approval_history
+ quote_calculation_products_versioned
+ quote_calculation_results
+ quote_calculation_summaries
+ quote_calculation_summaries_versioned
+ quote_calculation_variables
+ quote_export_settings
+ quote_timeline_events
+ quote_workflow_transitions
+ specification_exports
+ organization_currency_history
+ organization_exchange_rates
+ organization_invitations
+ organization_workflow_settings
+ plan_fact_financing_recalculated
+ plan_fact_logistics_stages
+ plan_fact_permissions
+ plan_fact_products
+ plan_fact_sections
+ supplier_countries
+ purchasing_companies
+ calculation_settings
+ customer_delivery_addresses
```

**–î–µ–π—Å—Ç–≤–∏–µ:** –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–∞–º–ø —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–ø–∫—É –º–∏–≥—Ä–∞—Ü–∏–π.

---

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–∞–∑–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `products` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** - –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å
2. **22 —Ç–∞–±–ª–∏—Ü—ã** —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ production, –Ω–æ –Ω–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π - –Ω—É–∂–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
3. **8 –º–∏–≥—Ä–∞—Ü–∏–π** (018-034) –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã - –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Å—Ö–µ–º—ã `kvota`
4. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ —Å—Ö–µ–º—É `kvota` –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
5. –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å search_path –≤ PostgreSQL –¥–ª—è —Å—Ö–µ–º—ã kvota

---

## üîÑ –°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü

```sql
-- –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É
CREATE SCHEMA IF NOT EXISTS kvota;
GRANT USAGE ON SCHEMA kvota TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA kvota TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA kvota TO authenticated;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA kvota TO authenticated;
ALTER DEFAULT PRIVILEGES IN SCHEMA kvota GRANT ALL ON TABLES TO authenticated;
ALTER DEFAULT PRIVILEGES IN SCHEMA kvota GRANT ALL ON SEQUENCES TO authenticated;

-- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ 45 —Ç–∞–±–ª–∏—Ü OneStack
DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN (
        SELECT tablename FROM pg_tables
        WHERE schemaname = 'public'
        AND (
            tablename LIKE 'quote%'
            OR tablename LIKE 'plan_fact%'
            OR tablename LIKE 'organization%'
            OR tablename LIKE 'customer%'
            OR tablename LIKE 'supplier%'
            OR tablename LIKE 'specification%'
            OR tablename IN (
                'approvals', 'workflow_transitions', 'roles', 'user_roles',
                'brand_assignments', 'deals', 'notifications', 'telegram_users',
                'seller_companies', 'purchasing_companies', 'calculation_settings',
                'exchange_rates'
            )
        )
    ) LOOP
        EXECUTE format('ALTER TABLE public.%I SET SCHEMA kvota', r.tablename);
        RAISE NOTICE 'Moved table: %', r.tablename;
    END LOOP;
END $$;
```

---

**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-20
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤ —Å—Ö–µ–º—É `kvota`
