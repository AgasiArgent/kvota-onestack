# Tasks - 2026-02-02

## Summary
- Total tasks: 10
- To Do: 10 | In Progress: 0 | Complete: 0
- Related Commit: `776df8f` - Simplify spec-control: remove 5-department approval system

## Test Environment
- **Production URL:** https://kvotaflow.ru
- **Test User:** admin@test.kvotaflow.ru
- **Dashboard:** /dashboard?tab=spec-control
- **Spec Detail:** /spec-control/{spec-id}

---

## Tasks

### [TEST-001] Dashboard Stats - Verify "На проверке" Shows Zero
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
After migration 150, all specs with `pending_review` status should be migrated to `draft`. Verify the dashboard stats card shows 0 for "На проверке".

#### Test Steps
1. Navigate to `https://kvotaflow.ru/dashboard?tab=spec-control`
2. Check the statistics cards at the top
3. Verify "На проверке" card shows **0**
4. Verify "Черновики" count increased (includes migrated specs)

#### Expected Result
- "На проверке" = 0
- No errors in console

---

### [TEST-002] Admin Panel - Only 3 Status Buttons
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
The admin panel should only show 3 status buttons after removing `pending_review`. The "На проверке" button should NOT exist.

#### Test Steps
1. Login as admin user
2. Navigate to a draft specification
3. Find red "АДМИН-ПАНЕЛЬ УПРАВЛЕНИЯ СТАТУСОМ" section
4. Count the status buttons

#### Expected Result
Only 3 buttons visible:
- Черновик
- Утверждена
- Подписана

**NOT present:** "На проверке" button

---

### [TEST-003] Action Buttons - No "Submit for Review"
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
The action buttons section should show simplified workflow. "Отправить на проверку" button was removed.

#### Test Steps
1. Open a specification in **draft** status
2. Scroll to action buttons at bottom
3. List all visible buttons

#### Expected Result
Buttons present:
- :white_check_mark: "Сохранить" (yellow/primary)
- :white_check_mark: "Утвердить" (green/success)
- :white_check_mark: "Предпросмотр PDF"
- :white_check_mark: "Экспорт PDF"
- :white_check_mark: "DOCX (Beta)"
- :white_check_mark: "Назад"

**NOT present:** "Отправить на проверку"

---

### [TEST-004] Direct Draft to Approved Transition
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** Critical
- **Created:** 2026-02-02 07:55

#### Description
The new simplified workflow allows direct approval from draft status without intermediate pending_review step.

#### Test Steps
1. Open a draft specification
2. Click "Утвердить" button
3. Verify page reloads/updates
4. Check status badge

#### Expected Result
- Status changes from "Черновик" to "Утверждена"
- Status badge color changes to blue
- Form becomes read-only (disabled inputs)
- "Подписанный скан" upload section appears

---

### [TEST-005] No Department Approval UI Section
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
The green "ПРОГРЕСС СОГЛАСОВАНИЯ СПЕЦИФИКАЦИИ" section with 5-department approval workflow should be completely removed.

#### Test Steps
1. Open any specification (draft, approved, or signed)
2. Search page for text "ПРОГРЕСС СОГЛАСОВАНИЯ"
3. Look for green-bordered card with department checkmarks

#### Expected Result
- Section does NOT exist on page
- No "Закупки", "Логистика", "Таможня", "Продажи", "Контроль" approval cards
- No department approval forms

---

### [TEST-006] Signed Scan Upload - Approved Spec
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
Upload functionality should work using the unified document_service. Test uploading a signed scan to an approved specification.

#### Test Steps
1. Open an **approved** specification (use admin to set status if needed)
2. Find "ПОДПИСАННЫЙ СКАН" section
3. Click file input, select a test file (PDF/JPG/PNG, < 50MB)
4. Submit upload
5. Verify success

#### Expected Result
- File uploads successfully
- Success message or redirect with `?upload_success=1`
- File link appears in the section
- No errors in console

#### Technical Notes
- Now uses `document_service.upload_document()`
- Stored in `kvota-documents` bucket (unified)
- Document type: `specification_signed_scan`

---

### [TEST-007] Confirm Signature Creates Deal
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** Critical
- **Created:** 2026-02-02 07:55

#### Description
After uploading signed scan, the "Подтвердить подпись и создать сделку" button should change spec status to signed and create a deal record.

#### Test Steps
1. Open approved spec WITH uploaded signed scan
2. Find "Подтвердить подпись и создать сделку" button
3. Click the button
4. Verify status change and deal creation

#### Expected Result
- Spec status changes to "Подписана" (green badge)
- Deal is created (check /deals page)
- Success confirmation shown

---

### [TEST-008] Filter Dropdown Options
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** Medium
- **Created:** 2026-02-02 07:55

#### Description
The filter dropdown should still show all status options for backward compatibility, but "На проверке" should show (0).

#### Test Steps
1. Navigate to spec-control dashboard
2. Click the filter dropdown
3. List all options with their counts

#### Expected Result
Options visible:
- Все
- Ожидают спецификации (X)
- Черновики (X) - should have increased count
- На проверке (0) - must be 0
- Утверждены (X)
- Подписаны (X)

---

### [TEST-009] Console Error Check
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** High
- **Created:** 2026-02-02 07:55

#### Description
Verify no JavaScript errors related to removed approval functions or undefined references.

#### Test Steps
1. Open browser DevTools (F12) → Console tab
2. Navigate to `/dashboard?tab=spec-control`
3. Open a specification detail page
4. Navigate back
5. Check for errors throughout

#### Expected Result
- No JavaScript errors
- No "undefined" or "null" reference errors
- No failed network requests (except expected ones)
- No references to `get_spec_approval_status`, `approve_spec_department`, etc.

---

### [TEST-010] Non-Admin User - No Admin Panel
- **Status:** :red_circle: To Do
- **Type:** Browser Test
- **Priority:** Medium
- **Created:** 2026-02-02 07:55

#### Description
Users with only `spec_controller` role (not admin) should NOT see the admin status panel.

#### Test Steps
1. Login as user with ONLY `spec_controller` role (no admin)
2. Navigate to a specification
3. Look for red admin panel

#### Expected Result
- Red "АДМИН-ПАНЕЛЬ УПРАВЛЕНИЯ СТАТУСОМ" is NOT visible
- Regular action buttons ARE visible
- User can still save/approve via normal workflow

---

## Test Results Summary

| # | Test | Status | Result |
|---|------|--------|--------|
| 1 | Dashboard stats "На проверке" = 0 | :red_circle: To Do | |
| 2 | Admin panel has 3 buttons | :red_circle: To Do | |
| 3 | No "Отправить на проверку" button | :red_circle: To Do | |
| 4 | Draft → Approved direct transition | :red_circle: To Do | |
| 5 | No department approval section | :red_circle: To Do | |
| 6 | Signed scan upload works | :red_circle: To Do | |
| 7 | Confirm signature creates deal | :red_circle: To Do | |
| 8 | Filter dropdown options correct | :red_circle: To Do | |
| 9 | No console errors | :red_circle: To Do | |
| 10 | Admin panel hidden for non-admins | :red_circle: To Do | |

---

## History
- [2026-02-02 07:55] Task file created for spec-control simplification browser tests
- Related to commit `776df8f` - removed 5-department approval system (~800 lines)
