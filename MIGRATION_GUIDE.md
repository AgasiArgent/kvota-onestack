# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ —Å—Ö–µ–º—É kvota

> **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-20
> **–¶–µ–ª—å:** –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ OneStack –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é PostgreSQL —Å—Ö–µ–º—É `kvota` –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

---

## üìã –ß—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ

### –ú–∏–≥—Ä–∞—Ü–∏–∏:

1. **100_create_kvota_schema.sql** - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã `kvota`
2. **101_move_tables_to_kvota_schema.sql** - –ü–µ—Ä–µ–Ω–æ—Å 45 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
3. **102_create_buyer_companies_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ buyer_companies
4. **103_create_bank_accounts_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ bank_accounts
5. **105_create_brand_supplier_assignments_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ brand_supplier_assignments
6. **106_create_supplier_invoices_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ supplier_invoices
7. **107_create_supplier_invoice_items_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ supplier_invoice_items
8. **108_create_supplier_invoice_payments_kvota.sql** - –°–æ–∑–¥–∞–Ω–∏–µ supplier_invoice_payments

### –ò—Ç–æ–≥–æ:
- ‚úÖ **45 —Ç–∞–±–ª–∏—Ü** –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –∏–∑ `public` –≤ `kvota`
- ‚úÖ **5 –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü** –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –≤ `kvota`
- ‚úÖ **–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏** –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã
- ‚úÖ **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ **–î–∞–Ω–Ω—ã–µ** –Ω–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ production

```bash
# –ù–∞ VPS
cd /path/to/onestack

# –ü—Ä–æ–≤–µ—Ä–∫–∞ (dry-run) - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
./apply_kvota_migrations.sh --dry-run

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
./apply_kvota_migrations.sh
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:**
1. –°–æ–∑–¥–∞—Å—Ç—Å—è –±—ç–∫–∞–ø –ë–î: `backup_before_kvota_YYYYMMDD_HHMMSS.sql`
2. –ü—Ä–∏–º–µ–Ω—è—Ç—Å—è –≤—Å–µ 8 –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–±–ª–∏—Ü, –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º—ã)

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å backend –∫–æ–¥

#### –§–∞–π–ª: `backend/app/config/database.py`

```python
from supabase import create_client, Client

supabase: Client = create_client(
    supabase_url=settings.SUPABASE_URL,
    supabase_key=settings.SUPABASE_SERVICE_ROLE_KEY,
    options={
        "schema": "kvota"  # ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
    }
)
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å frontend –∫–æ–¥

#### –§–∞–π–ª: `frontend/lib/supabase.ts`

```typescript
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
  {
    db: {
      schema: 'kvota'  // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£
    }
  }
)
```

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
# –ù–∞ VPS
docker restart kvota-onestack
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
onestack/
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ 100_create_kvota_schema.sql             # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ 101_move_tables_to_kvota_schema.sql     # –ü–µ—Ä–µ–Ω–æ—Å 45 —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îú‚îÄ‚îÄ 102_create_buyer_companies_kvota.sql    # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ 103_create_bank_accounts_kvota.sql      # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ 105_create_brand_supplier_assignments_kvota.sql  # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ 106_create_supplier_invoices_kvota.sql  # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ 107_create_supplier_invoice_items_kvota.sql      # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ   ‚îî‚îÄ‚îÄ 108_create_supplier_invoice_payments_kvota.sql   # –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ
‚îú‚îÄ‚îÄ apply_kvota_migrations.sh                   # –ú–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ MIGRATION_GUIDE.md                          # –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
‚îú‚îÄ‚îÄ MIGRATION_CODE_CHANGES.md                   # –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
‚îú‚îÄ‚îÄ DATABASE_TABLES.md                          # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–∞–±–ª–∏—Ü
‚îî‚îÄ‚îÄ PRODUCTION_TABLES.md                        # –¢–∞–±–ª–∏—Ü—ã –≤ production
```

---

## ‚öôÔ∏è –û–ø—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç–∞

### Dry-run (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

```bash
./apply_kvota_migrations.sh --dry-run
```

–ü–æ–∫–∞–∂–µ—Ç:
- ‚úÖ –ö–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
- ‚ùå –ù–ï –≤–Ω–µ—Å–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
./apply_kvota_migrations.sh
```

–°–¥–µ–ª–∞–µ—Ç:
1. ‚úÖ –°–æ–∑–¥–∞—Å—Ç –±—ç–∫–∞–ø –ë–î
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç –≤—Å–µ 8 –º–∏–≥—Ä–∞—Ü–∏–π
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
4. ‚úÖ –ü–æ–∫–∞–∂–µ—Ç –æ—Ç—á–µ—Ç

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
docker exec -it supabase-db psql -U postgres -d postgres

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º—ã
\dn

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ kvota
\dt kvota.*

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ kvota
\df kvota.*

# –í—ã–π—Ç–∏
\q
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
Schema kvota created: YES
Tables in kvota: ~50 (45 moved + 5 new)
Functions in kvota: ~30-40
```

---

## üõ†Ô∏è –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–µ—Ç–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
docker exec -it supabase-db bash

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
psql -U postgres -d postgres

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞–∂–¥—É—é –º–∏–≥—Ä–∞—Ü–∏—é
\i /path/to/100_create_kvota_schema.sql
\i /path/to/101_move_tables_to_kvota_schema.sql
\i /path/to/102_create_buyer_companies_kvota.sql
\i /path/to/103_create_bank_accounts_kvota.sql
\i /path/to/105_create_brand_supplier_assignments_kvota.sql
\i /path/to/106_create_supplier_invoices_kvota.sql
\i /path/to/107_create_supplier_invoice_items_kvota.sql
\i /path/to/108_create_supplier_invoice_payments_kvota.sql

\q
exit
```

---

## üîô –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞

```bash
# –ù–∞–π—Ç–∏ –±—ç–∫–∞–ø
ls -lh backup_before_kvota_*.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
docker exec -i supabase-db psql -U postgres -d postgres < backup_before_kvota_XXXXXX.sql
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í–µ—Ä–Ω—É—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ public

```sql
-- –í–µ—Ä–Ω—É—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ public
DO $$
DECLARE
    r RECORD;
BEGIN
    FOR r IN (
        SELECT tablename FROM pg_tables
        WHERE schemaname = 'kvota'
    ) LOOP
        EXECUTE format('ALTER TABLE kvota.%I SET SCHEMA public', r.tablename);
    END LOOP;
END $$;

-- –£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—É kvota
DROP SCHEMA IF EXISTS kvota CASCADE;
```

---

## ‚ùì FAQ

### Q: –ü–æ—Ç–µ—Ä—è—é—Ç—Å—è –ª–∏ –¥–∞–Ω–Ω—ã–µ?
**A:** –ù–µ—Ç! –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ—Ç —Å—Ö–µ–º—É (namespace), –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ.

### Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —ç—Ç–æ –∑–∞–π–º–µ—Ç?
**A:** 2-5 –º–∏–Ω—É—Ç. –ü–µ—Ä–µ–Ω–æ—Å —Ç–∞–±–ª–∏—Ü - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.

### Q: –ù—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?
**A:** –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. –ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ª–µ—Ç—É.

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–ø–∞–ª–∞?
**A:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.

### Q: –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞?
**A:** –ò–∑–æ–ª—è—Ü–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ shared Supabase. –°–µ–π—á–∞—Å 130 —Ç–∞–±–ª–∏—Ü –≤ public, –∏–∑ –Ω–∏—Ö —Ç–æ–ª—å–∫–æ 45 - OneStack.

### Q: –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–π?
**A:** –î–∞, –Ω–æ —Å–æ–±–ª—é–¥–∞–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫: 100 ‚Üí 101 ‚Üí 102 ‚Üí 103 ‚Üí 105 ‚Üí 106 ‚Üí 107 ‚Üí 108

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –±—ç–∫–∞–ø: `backup_before_kvota_*.sql`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `MIGRATION_CODE_CHANGES.md` –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø–æ –∫–æ–¥—É
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] Backend –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω (schema: 'kvota')
- [ ] Frontend –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω (schema: 'kvota')
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ö–ü
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: –¥–∞–Ω–Ω—ã–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ

---

**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-20
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** Ready for production
