"""
Kvota OneStack - FastHTML + Supabase

A single-language (Python) quotation platform.
Run with: python main.py
"""

from fasthtml.common import *
from datetime import datetime, date, timedelta
from decimal import Decimal
from typing import Dict, Any, List, Optional
import os
import json
from starlette.responses import JSONResponse
from dotenv import load_dotenv

load_dotenv()

# Initialize Sentry for error tracking (must be before app creation)
import sentry_sdk

sentry_dsn = os.getenv("SENTRY_DSN")
if sentry_dsn:
    sentry_sdk.init(
        dsn=sentry_dsn,
        send_default_pii=True,
        traces_sample_rate=1.0,
        environment=os.getenv("SENTRY_ENVIRONMENT", "production" if not os.getenv("DEBUG") else "development"),
    )

from services.database import get_supabase, get_anon_client

# Import export services
from services.export_data_mapper import fetch_export_data
from services.specification_export import generate_specification_pdf, generate_spec_pdf_from_spec_id
from services.invoice_export import generate_invoice_pdf
from services.export_validation_service import create_validation_excel
from services.procurement_export import create_procurement_excel

# Import version service
from services.quote_version_service import (
    create_quote_version, list_quote_versions, get_quote_version,
    get_current_quote_version, can_update_version, update_quote_version
)

# Import role service
from services.role_service import get_user_role_codes, get_session_user_roles, require_role, require_any_role

# Import brand service for procurement
from services.brand_service import get_assigned_brands

# Import workflow service for status display
from services.workflow_service import (
    WorkflowStatus, STATUS_NAMES, STATUS_NAMES_SHORT, STATUS_COLORS,
    check_all_procurement_complete, complete_procurement, complete_logistics, complete_customs,
    transition_quote_status, get_quote_transition_history, transition_to_pending_procurement
)

# Import approval service (Feature #65, #86)
from services.approval_service import request_approval, count_pending_approvals, get_pending_approvals_for_user, get_approvals_with_details

# Import deal service (Feature #86)
from services.deal_service import count_deals_by_status, get_deals_by_status

# Import specification service (Feature #86)
from services.specification_service import count_specifications_by_status

# Import quote approval service (Bug #8 follow-up - Multi-department approval)
from services.quote_approval_service import (
    get_approval_status as get_quote_approval_status,
    approve_department as approve_quote_department,
    reject_department as reject_quote_department,
    user_can_approve_department as user_can_approve_quote_department,
    DEPARTMENT_NAMES as QUOTE_DEPARTMENT_NAMES,
    DEPARTMENTS as QUOTE_DEPARTMENTS
)

# Import calculation engine
from calculation_engine import calculate_multiproduct_quote
from calculation_mapper import map_variables_to_calculation_input, safe_decimal, safe_int
from calculation_models import (
    QuoteCalculationInput, Currency, SupplierCountry, SellerCompany,
    OfferSaleType, Incoterms, DMFeeType
)

# Import currency service for multi-currency logistics
from services.currency_service import convert_to_usd

# Import document service for file uploads
from services.document_service import (
    upload_document, get_document, get_documents_for_entity,
    get_download_url, delete_document, update_document,
    get_document_type_label, get_file_icon, format_file_size,
    get_allowed_document_types_for_entity, count_documents_for_entity,
    get_all_documents_for_quote, count_all_documents_for_quote,
    get_required_sub_entity_type, get_entity_type_label,
    DOCUMENT_TYPE_LABELS, INVOICE_DOCUMENT_TYPES, ITEM_DOCUMENT_TYPES
)

# ============================================================================
# APP SETUP
# ============================================================================

app, rt = fast_app(
    secret_key=os.getenv("APP_SECRET", "dev-secret-change-in-production"),
    live=True,
)

# ============================================================================
# STYLES
# ============================================================================

# Modern, attractive styles with smooth animations and depth
# Built on top of PicoCSS + DaisyUI + Tailwind for maximum visual appeal
# Supports light (default) and dark themes via CSS variables
APP_STYLES = """
/* ========== Theme Variables ========== */
/* Light theme (default) - inspired by Behance CRM reference */
:root {
    /* Page background */
    --bg-page: #f5f7fa;
    --bg-page-alt: #eef1f5;

    /* Sidebar/Nav */
    --bg-sidebar: #ffffff;
    --bg-sidebar-hover: #f3f4f6;
    --bg-sidebar-active: rgba(59, 130, 246, 0.1);
    --sidebar-border: #e5e7eb;
    --sidebar-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);

    /* Cards */
    --bg-card: #ffffff;
    --bg-card-hover: #ffffff;
    --card-border: #e5e7eb;
    --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    --card-shadow-hover: 0 12px 24px rgba(59, 130, 246, 0.12);

    /* Text colors */
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --text-on-accent: #ffffff;

    /* Accent colors */
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --accent-light: rgba(59, 130, 246, 0.1);
    --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);

    /* Borders */
    --border-color: #e5e7eb;
    --border-color-light: #f3f4f6;

    /* Status colors */
    --status-success: #10b981;
    --status-warning: #f59e0b;
    --status-error: #ef4444;
    --status-info: #3b82f6;

    /* Table */
    --table-header-bg: #f9fafb;
    --table-row-hover: rgba(59, 130, 246, 0.06);
    --table-stripe: rgba(59, 130, 246, 0.02);

    /* Forms */
    --input-bg: #ffffff;
    --input-border: #d1d5db;
    --input-focus-border: #3b82f6;
    --input-focus-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);

    /* ========== Button System Variables ========== */
    /* Primary (gray - main action) */
    --btn-primary-bg: #6b7280;
    --btn-primary-hover: #4b5563;
    --btn-primary-text: white;

    /* Secondary (white + gray border) */
    --btn-secondary-bg: white;
    --btn-secondary-border: #d1d5db;
    --btn-secondary-text: #374151;
    --btn-secondary-hover-bg: #f9fafb;

    /* Success (outline: white + green border, green fill on hover) */
    --btn-success-bg: white;
    --btn-success-border: #10b981;
    --btn-success-text: #059669;
    --btn-success-hover-bg: #10b981;
    --btn-success-hover-text: white;

    /* Danger (outline: white + red border, red fill on hover) */
    --btn-danger-bg: white;
    --btn-danger-border: #ef4444;
    --btn-danger-text: #dc2626;
    --btn-danger-hover-bg: #ef4444;
    --btn-danger-hover-text: white;

    /* Ghost (transparent background) */
    --btn-ghost-bg: transparent;
    --btn-ghost-text: #374151;
    --btn-ghost-hover-bg: #f3f4f6;

    /* Button sizing */
    --btn-padding: 0.625rem 1.25rem;
    --btn-padding-sm: 0.4rem 0.875rem;
    --btn-padding-lg: 0.875rem 1.75rem;
    --btn-radius: 0.5rem;
    --btn-gap: 0.5rem;
    --btn-font-size: 0.875rem;
    --btn-font-size-sm: 0.8125rem;
    --btn-font-size-lg: 1rem;

    /* ========== Compact Spacing (logistics-style) ========== */
    --spacing-tight: 8px;
    --spacing-compact: 12px;
    --spacing-normal: 16px;

    /* Compact Label Typography */
    --label-size: 11px;
    --label-weight: 600;
    --label-color: #94a3b8;
    --label-transform: uppercase;
    --label-spacing: 0.05em;

    /* Compact Inputs */
    --input-height-compact: 36px;
    --input-padding-compact: 8px 10px;
    --input-bg-compact: #f8fafc;
    --input-border-compact: #e2e8f0;

    /* Elevated Card Backgrounds */
    --bg-card-elevated: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
    --bg-card-success: linear-gradient(90deg, #f0fdf4 0%, #fafbfc 100%);

    /* Badge Gradients */
    --badge-pending: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    --badge-active: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    --badge-complete: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    --badge-purple: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    --badge-neutral: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    --badge-error: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);

    /* Subtle Shadows */
    --shadow-subtle: 0 1px 4px rgba(0,0,0,0.06);
    --shadow-card-v2: 0 2px 8px rgba(0,0,0,0.04);

    /* Transition */
    --transition-smooth: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Dark theme */
[data-theme="dark"] {
    /* Page background */
    --bg-page: #0f0f1a;
    --bg-page-alt: #1a1a2e;

    /* Sidebar/Nav */
    --bg-sidebar: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
    --bg-sidebar-hover: rgba(255, 255, 255, 0.1);
    --bg-sidebar-active: rgba(99, 102, 241, 0.15);
    --sidebar-border: rgba(255, 255, 255, 0.1);
    --sidebar-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);

    /* Cards */
    --bg-card: linear-gradient(135deg, #2d2d44 0%, #1e1e2f 100%);
    --bg-card-hover: linear-gradient(135deg, #353550 0%, #262638 100%);
    --card-border: rgba(255, 255, 255, 0.05);
    --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    --card-shadow-hover: 0 20px 40px rgba(99, 102, 241, 0.3);

    /* Text colors */
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --text-on-accent: #ffffff;

    /* Accent colors */
    --accent: #6366f1;
    --accent-hover: #4f46e5;
    --accent-light: rgba(99, 102, 241, 0.15);
    --accent-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);

    /* Borders */
    --border-color: rgba(255, 255, 255, 0.1);
    --border-color-light: rgba(255, 255, 255, 0.05);

    /* Status colors (same) */
    --status-success: #10b981;
    --status-warning: #f59e0b;
    --status-error: #ef4444;
    --status-info: #3b82f6;

    /* Table */
    --table-header-bg: rgba(99, 102, 241, 0.1);
    --table-row-hover: rgba(99, 102, 241, 0.12);
    --table-stripe: rgba(99, 102, 241, 0.03);

    /* Forms */
    --input-bg: #1e1e2f;
    --input-border: rgba(255, 255, 255, 0.15);
    --input-focus-border: #6366f1;
    --input-focus-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);

    /* ========== Button System Variables (Dark Theme) ========== */
    /* Primary (gray - main action) */
    --btn-primary-bg: #6b7280;
    --btn-primary-hover: #9ca3af;
    --btn-primary-text: white;

    /* Secondary (dark + lighter border) */
    --btn-secondary-bg: #2d2d44;
    --btn-secondary-border: rgba(255, 255, 255, 0.15);
    --btn-secondary-text: #e5e7eb;
    --btn-secondary-hover-bg: #3d3d5c;

    /* Success (outline: dark + green border, green fill on hover) */
    --btn-success-bg: #2d2d44;
    --btn-success-border: #10b981;
    --btn-success-text: #34d399;
    --btn-success-hover-bg: #10b981;
    --btn-success-hover-text: white;

    /* Danger (outline: dark + red border, red fill on hover) */
    --btn-danger-bg: #2d2d44;
    --btn-danger-border: #ef4444;
    --btn-danger-text: #f87171;
    --btn-danger-hover-bg: #ef4444;
    --btn-danger-hover-text: white;

    /* Ghost (transparent background) */
    --btn-ghost-bg: transparent;
    --btn-ghost-text: #e5e7eb;
    --btn-ghost-hover-bg: rgba(255, 255, 255, 0.1);

    /* ========== Compact Spacing (Dark Theme) ========== */
    --label-color: #94a3b8;
    --input-bg-compact: #1e1e2f;
    --input-border-compact: rgba(255, 255, 255, 0.15);
    --bg-card-elevated: linear-gradient(135deg, #2d2d44 0%, #252538 100%);
    --bg-card-success: linear-gradient(90deg, rgba(22, 163, 74, 0.15) 0%, #2d2d44 100%);

    /* Badge Gradients (Dark Theme) */
    --badge-pending: linear-gradient(135deg, rgba(217, 119, 6, 0.25) 0%, rgba(217, 119, 6, 0.15) 100%);
    --badge-active: linear-gradient(135deg, rgba(22, 163, 74, 0.25) 0%, rgba(22, 163, 74, 0.15) 100%);
    --badge-complete: linear-gradient(135deg, rgba(37, 99, 235, 0.25) 0%, rgba(37, 99, 235, 0.15) 100%);
    --badge-purple: linear-gradient(135deg, rgba(124, 58, 237, 0.25) 0%, rgba(124, 58, 237, 0.15) 100%);
    --badge-neutral: linear-gradient(135deg, rgba(107, 114, 128, 0.25) 0%, rgba(107, 114, 128, 0.15) 100%);
    --badge-error: linear-gradient(135deg, rgba(220, 38, 38, 0.25) 0%, rgba(220, 38, 38, 0.15) 100%);
}

/* ========== Global Enhancements ========== */
* {
    transition: all 0.2s ease-in-out;
}

html, body {
    font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
    line-height: 1.6;
    background: var(--bg-page);
    color: var(--text-primary);
    font-size: 14px;
}

h1 {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1.5rem;
    color: var(--text-primary);
    letter-spacing: -0.02em;
}

h2 {
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 1rem;
    color: var(--text-primary);
    letter-spacing: -0.01em;
}

h3 {
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

/* ========== Unified Header System ========== */
/*
 * 3-level hierarchy:
 * 1. .page-header (H1) - Page title with icon
 * 2. .section-header (H2) - Section on page
 * 3. .card-header (H3) - Card/form header
 */

/* Page Header - Main page title */
.page-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--border-color-light);
}

.page-header svg {
    flex-shrink: 0;
    color: var(--accent);
}

/* Section Header - Major section on page */
.section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color-light);
}

.section-header svg {
    flex-shrink: 0;
    color: var(--text-secondary);
}

/* Card Header - Inside cards/forms */
.card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color-light);
}

.card-header svg {
    flex-shrink: 0;
    color: var(--text-muted);
}

/* Card Header with accent color (for dashboard task cards) */
.card-header--accent {
    font-size: 1.125rem;
    font-weight: 600;
    padding: 0;
    margin-bottom: 1rem;
    border-bottom: none;
}

.card-header--accent svg {
    width: 24px;
    height: 24px;
}

/* Accent color variants */
.card-header--orange { color: #b45309; }
.card-header--orange svg { color: #b45309; }

.card-header--amber { color: #92400e; }
.card-header--amber svg { color: #92400e; }

.card-header--blue { color: #1e40af; }
.card-header--blue svg { color: #1e40af; }

.card-header--purple { color: #6b21a8; }
.card-header--purple svg { color: #6b21a8; }

.card-header--pink { color: #9d174d; }
.card-header--pink svg { color: #9d174d; }

.card-header--indigo { color: #4338ca; }
.card-header--indigo svg { color: #4338ca; }

.card-header--green { color: #059669; }
.card-header--green svg { color: #059669; }

.card-header--red { color: #9a3412; }
.card-header--red svg { color: #9a3412; }

/* Subsection header - smaller, no border */
.subsection-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin: 1.5rem 0 0.75rem 0;
}

.subsection-header svg {
    flex-shrink: 0;
    color: var(--text-muted);
}

/* ========== Navigation Bar ========== */
nav {
    background: var(--bg-sidebar);
    color: var(--text-primary);
    padding: 1rem 0;
    margin-bottom: 0;
    box-shadow: var(--sidebar-shadow);
    overflow-x: auto;
}

nav .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

nav ul {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

nav a {
    color: var(--text-secondary);
    text-decoration: none;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    white-space: nowrap;
    font-size: 0.9375rem;
}

nav a:hover {
    color: var(--accent);
    background: var(--accent-light);
    transform: translateY(-2px);
}

nav strong {
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 700;
}

/* ========== Cards with Hover Effects ========== */
.card,
[style*="border-left"],
.stat-card,
div[style*="max-width"][style*="margin"] {
    background: var(--bg-card) !important;
    border-radius: 0.75rem !important;
    box-shadow: var(--card-shadow) !important;
    padding: 1.5rem !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border: 1px solid var(--card-border) !important;
}

.card:hover,
[style*="border-left"]:hover,
.stat-card:hover,
div[style*="max-width"][style*="margin"]:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--card-shadow-hover) !important;
    border-color: var(--accent) !important;
}

/* ========== Enhanced Buttons ========== */
button, [role="button"], .button, a[role="button"] {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.15s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
}

/* Primary button (default) - Override ALL button colors including Pico CSS */
/* IMPORTANT: Exclude .btn class elements - they use BEM system */
button:not(.secondary):not(.ghost):not(.sidebar-toggle-btn):not(.theme-toggle):not(.btn),
[role="button"]:not(.secondary):not(.ghost):not(.btn),
button[type="submit"]:not(.btn),
a[href*="/new"]:not(.sidebar-item):not(.btn) {
    background: var(--accent) !important;
    color: var(--text-on-accent) !important;
    box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2) !important;
    border-color: transparent !important;
}

button:not(.secondary):not(.ghost):not(.sidebar-toggle-btn):not(.theme-toggle):not(.btn):hover,
[role="button"]:not(.secondary):not(.ghost):not(.btn):hover,
button[type="submit"]:not(.btn):hover,
a[href*="/new"]:not(.sidebar-item):not(.btn):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
    background: var(--accent-hover) !important;
}

/* Secondary button (legacy - exclude .btn) */
button.secondary:not(.btn),
[role="button"].secondary:not(.btn),
.button.secondary:not(.btn) {
    background: var(--bg-card);
    color: var(--accent);
    border: 1.5px solid var(--accent);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

button.secondary:not(.btn):hover,
[role="button"].secondary:not(.btn):hover,
.button.secondary:not(.btn):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
    background: var(--accent-light);
}

/* Ghost button (legacy - exclude .btn) */
button.ghost:not(.btn),
[role="button"].ghost:not(.btn),
.button.ghost:not(.btn) {
    background: transparent;
    color: var(--accent);
    border: none;
}

button.ghost:not(.btn):hover,
[role="button"].ghost:not(.btn):hover,
.button.ghost:not(.btn):hover {
    background: var(--accent-light);
}

/* Success button (legacy - exclude .btn) */
button.success:not(.btn),
[role="button"].success:not(.btn) {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
}

button.success:not(.btn):hover,
[role="button"].success:not(.btn):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
}

/* Danger button (legacy - exclude .btn) */
button.danger:not(.btn),
[role="button"].danger:not(.btn) {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
}

button.danger:not(.btn):hover,
[role="button"].danger:not(.btn):hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
}

/* Disabled state */
button:disabled,
[role="button"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* Small button variant (legacy - exclude .btn) */
button.btn-sm:not(.btn),
[role="button"].btn-sm:not(.btn) {
    padding: 0.4rem 0.875rem;
    font-size: 0.875rem;
}

/* ========== BEM Button System ========== */
/*
 * Standardized button classes using BEM methodology.
 * Use Python helpers: btn(), btn_link(), btn_icon()
 *
 * Variants:
 *   .btn--primary   - Gray fill, main actions (Передать, Сохранить)
 *   .btn--secondary - White + gray border, secondary actions
 *   .btn--success   - White + green border, confirmations (Одобрить)
 *   .btn--danger    - White + red border, destructive (Удалить, Отклонить)
 *   .btn--ghost     - Transparent, toolbar buttons (Добавить, Загрузить)
 *
 * Modifiers:
 *   .btn--sm        - Small size
 *   .btn--lg        - Large size
 *   .btn--full      - Full width
 *   .btn--icon-only - Square button for icons only
 */

/* Base button reset - highest specificity with .btn class */
/* Note: width: auto !important overrides PicoCSS full-width form buttons */
.btn {
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    gap: var(--btn-gap);
    padding: var(--btn-padding);
    border-radius: var(--btn-radius);
    font-size: var(--btn-font-size);
    font-weight: 500;
    line-height: 1;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.15s ease;
    border: 1px solid transparent;
    text-decoration: none;
    background: none;
    box-shadow: none;
    width: auto !important;
}

/* Primary - Gray fill (main actions) */
.btn.btn--primary {
    background: var(--btn-primary-bg);
    color: var(--btn-primary-text);
    border-color: var(--btn-primary-bg);
}

.btn.btn--primary:hover {
    background: var(--btn-primary-hover);
    border-color: var(--btn-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.25);
}

/* Secondary - White/gray outline */
.btn.btn--secondary {
    background: var(--btn-secondary-bg);
    color: var(--btn-secondary-text);
    border-color: var(--btn-secondary-border);
}

.btn.btn--secondary:hover {
    background: var(--btn-secondary-hover-bg);
    border-color: var(--btn-secondary-text);
}

/* Success - White + green border, green fill on hover */
.btn.btn--success {
    background: var(--btn-success-bg);
    color: var(--btn-success-text);
    border-color: var(--btn-success-border);
}

.btn.btn--success:hover {
    background: var(--btn-success-hover-bg);
    color: var(--btn-success-hover-text);
    border-color: var(--btn-success-hover-bg);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Danger - White + red border, red fill on hover */
.btn.btn--danger {
    background: var(--btn-danger-bg);
    color: var(--btn-danger-text);
    border-color: var(--btn-danger-border);
}

.btn.btn--danger:hover {
    background: var(--btn-danger-hover-bg);
    color: var(--btn-danger-hover-text);
    border-color: var(--btn-danger-hover-bg);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

/* Ghost - Transparent, for toolbar actions */
.btn.btn--ghost {
    background: var(--btn-ghost-bg);
    color: var(--btn-ghost-text);
    border-color: transparent;
}

.btn.btn--ghost:hover {
    background: var(--btn-ghost-hover-bg);
}

/* Size modifiers */
.btn.btn--sm {
    padding: var(--btn-padding-sm);
    font-size: var(--btn-font-size-sm);
}

.btn.btn--lg {
    padding: var(--btn-padding-lg);
    font-size: var(--btn-font-size-lg);
}

/* Full width */
.btn.btn--full {
    width: 100%;
}

/* Icon only (square) */
.btn.btn--icon-only {
    padding: 0.5rem;
    width: 2.25rem;
    height: 2.25rem;
}

.btn.btn--icon-only.btn--sm {
    padding: 0.375rem;
    width: 1.75rem;
    height: 1.75rem;
}

/* Disabled state */
.btn:disabled,
.btn[disabled],
.btn.btn--disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
    transform: none;
}

/* Focus state for accessibility */
.btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

/* Loading state */
.btn.btn--loading {
    position: relative;
    color: transparent;
    pointer-events: none;
}

.btn.btn--loading::after {
    content: '';
    position: absolute;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: btn-spin 0.6s linear infinite;
}

@keyframes btn-spin {
    to { transform: rotate(360deg); }
}

/* ========== Enhanced Status Badges ========== */
.status-badge {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    letter-spacing: 0.025em;
    transition: all 0.2s ease;
}

.status-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
}

/* Status colors with gradients */
.status-draft {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #78350f;
}

.status-sent {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.status-approved {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.status-rejected {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.status-pending {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.status-progress {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    color: white;
}

.status-cancelled {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
}

/* ========== Enhanced Stats Cards ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
}

.stat-card {
    text-align: center;
    padding: 1.5rem;
    background: var(--bg-card) !important;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--card-border);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    line-height: 1.2;
}

.stat-label {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

/* ========== Tables with Zebra Stripes & Hover ========== */
table {
    border-collapse: collapse;
    width: 100%;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: var(--card-shadow);
    background: var(--bg-card);
}

table tbody tr {
    transition: all 0.2s ease;
}

/* Zebra striping - alternating row colors */
table tbody tr:nth-child(even) {
    background: var(--table-stripe);
}

table tbody tr:hover {
    background: var(--table-row-hover) !important;
    cursor: pointer;
}

/* Table headers */
table thead {
    background: var(--table-header-bg);
}

table thead th {
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.075em;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid var(--border-color);
    color: var(--accent);
    text-align: left;
}

/* Table cells */
table tbody td {
    padding: 0.875rem 0.75rem;
    border-bottom: 1px solid var(--border-color-light);
    font-size: 0.9375rem;
    color: var(--text-primary);
}

/* First and last columns padding */
table thead th:first-child,
table tbody td:first-child {
    padding-left: 1.25rem;
}

table thead th:last-child,
table tbody td:last-child {
    padding-right: 1.25rem;
}
/* ========== Unified Table Design System (Livento CRM Style) ========== */
/* Reference: https://www.behance.net/gallery/239045803/CRM-Dashboard-UI-UX-Branding-Case-Study */

/* Table Container - adds shadow and rounded corners */
.table-container {
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    margin: 1.5rem;  /* Fixed spacing from edges */
    margin-top: 1rem;
}

/* Table Header Bar - search, filters, actions */
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-card);
    gap: 1rem;
    flex-wrap: wrap;
}

.table-header-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.table-header-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Search Input in Table Header */
.table-search {
    min-width: 250px;
    padding: 0.5rem 1rem !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 8px !important;
    font-size: 0.875rem;
    background: var(--bg-primary) !important;
    margin: 0 !important;
}

.table-search:focus {
    outline: none;
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

/* Unified Table Base Styles */
.unified-table {
    width: 100%;
    min-width: 800px;  /* Minimum width for readability, enables horizontal scroll */
    border-collapse: collapse;
    font-size: 0.875rem;
    box-shadow: none;
}

/* Unified Table Header */
.unified-table thead {
    background: #f8fafc;
    border-bottom: 1px solid var(--border-color);
}

[data-theme="dark"] .unified-table thead {
    background: rgba(255, 255, 255, 0.05);
}

.unified-table th {
    padding: 0.875rem 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    white-space: nowrap;
    border-bottom: none;
}

/* Right-align numeric columns */
.unified-table th.col-number,
.unified-table td.col-number,
.unified-table th.col-money,
.unified-table td.col-money {
    text-align: right;
}

/* Center-align action columns */
.unified-table th.col-actions,
.unified-table td.col-actions {
    text-align: center;
    width: 100px;
}

/* Unified Table Body */
.unified-table tbody tr {
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.15s;
}

.unified-table tbody tr:last-child {
    border-bottom: none;
}

.unified-table tbody tr:hover {
    background: #f8fafc;
}

[data-theme="dark"] .unified-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

.unified-table td {
    padding: 0.875rem 1rem;
    color: var(--text-primary);
    vertical-align: middle;
    border-bottom: none;
}

/* Clickable row */
.unified-table tbody tr.clickable-row {
    cursor: pointer;
}

.unified-table tbody tr.clickable-row:hover {
    background: rgba(59, 130, 246, 0.05);
}

/* Status Badges - Unified Color Palette */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}

.status-success { background: #dcfce7; color: #166534; }
.status-warning { background: #fef3c7; color: #92400e; }
.status-error { background: #fee2e2; color: #991b1b; }
.status-info { background: #dbeafe; color: #1e40af; }
.status-neutral { background: #f3f4f6; color: #4b5563; }
.status-new { background: #eff6ff; color: #2563eb; }
.status-progress { background: #f3e8ff; color: #7c3aed; }

[data-theme="dark"] .status-success { background: rgba(22, 163, 74, 0.2); color: #86efac; }
[data-theme="dark"] .status-warning { background: rgba(217, 119, 6, 0.2); color: #fcd34d; }
[data-theme="dark"] .status-error { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
[data-theme="dark"] .status-info { background: rgba(37, 99, 235, 0.2); color: #93c5fd; }
[data-theme="dark"] .status-neutral { background: rgba(107, 114, 128, 0.2); color: #d1d5db; }
[data-theme="dark"] .status-new { background: rgba(37, 99, 235, 0.15); color: #93c5fd; }
[data-theme="dark"] .status-progress { background: rgba(124, 58, 237, 0.2); color: #c4b5fd; }

/* Table Footer - pagination */
.table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1.25rem;
    border-top: 1px solid var(--border-color);
    background: #f8fafc;
    font-size: 0.875rem;
}

[data-theme="dark"] .table-footer {
    background: rgba(255, 255, 255, 0.02);
}

.table-pagination {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-pagination button {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-card);
    cursor: pointer;
    font-size: 0.875rem;
}

.table-pagination button:hover:not(:disabled) {
    background: #f3f4f6;
}

.table-pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.table-pagination .current-page {
    padding: 0.375rem 0.75rem;
    background: var(--accent);
    color: white;
    border-radius: 6px;
    font-weight: 500;
}

/* Empty State */
.table-empty {
    padding: 3rem 1rem;
    text-align: center;
    color: var(--text-muted);
}

.table-empty-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    opacity: 0.5;
}

.table-empty-text {
    font-size: 0.9375rem;
}

/* Action Buttons */
.table-action-btn {
    padding: 0.375rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.table-action-btn:hover {
    background: #f3f4f6;
    color: var(--text-primary);
}

[data-theme="dark"] .table-action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.table-action-btn.danger:hover {
    background: #fee2e2;
    color: #dc2626;
}

[data-theme="dark"] .table-action-btn.danger:hover {
    background: rgba(220, 38, 38, 0.2);
    color: #fca5a5;
}

/* Responsive Table Wrapper */
.table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

@media (max-width: 768px) {
    .table-header {
        flex-direction: column;
        align-items: stretch;
    }

    .table-search {
        min-width: 100%;
    }

    .unified-table th,
    .unified-table td {
        padding: 0.625rem 0.75rem;
    }
}


/* ========== Forms with Enhanced Styling ========== */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    justify-content: flex-start;
}

/* Labels */
label {
    font-weight: 500;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    display: block;
    color: var(--text-primary);
}

/* Input fields */
input[type="text"],
input[type="email"],
input[type="password"],
input[type="number"],
input[type="date"],
input[type="tel"],
select,
textarea {
    width: 100%;
    padding: 0.625rem 0.875rem;
    border: 1.5px solid var(--input-border);
    border-radius: 0.5rem;
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    background: var(--input-bg);
    color: var(--text-primary);
}

input[type="text"]:hover,
input[type="email"]:hover,
input[type="password"]:hover,
input[type="number"]:hover,
input[type="date"]:hover,
input[type="tel"]:hover,
select:hover,
textarea:hover {
    border-color: var(--accent);
}

input[type="text"]:focus,
input[type="email"]:focus,
input[type="password"]:focus,
input[type="number"]:focus,
input[type="date"]:focus,
input[type="tel"]:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: var(--input-focus-border);
    box-shadow: var(--input-focus-shadow);
}

/* Disabled state */
input:disabled,
select:disabled,
textarea:disabled {
    background: var(--bg-page-alt);
    cursor: not-allowed;
    opacity: 0.6;
}

/* Textarea specific */
textarea {
    min-height: 100px;
    resize: vertical;
}

/* ========== Enhanced Alerts ========== */
.alert {
    padding: 1rem 1.25rem;
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    font-size: 0.9375rem;
    line-height: 1.6;
    position: relative;
    overflow: hidden;
}

.alert::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 5px;
}

.alert-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.alert-success::before {
    background: linear-gradient(180deg, #10b981 0%, #059669 100%);
}

.alert-error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.alert-error::before {
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
}

.alert-info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.alert-info::before {
    background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
}

.alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.alert-warning::before {
    background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
}

/* ========== Enhanced Links ========== */
a {
    color: var(--accent);
    text-decoration: none;
    transition: all 0.2s ease;
    font-weight: 500;
}

a:hover {
    color: var(--accent-hover);
    text-decoration: underline;
}

a:active {
    color: var(--accent-hover);
}

/* ========== DaisyUI Stats Component Support ========== */
.stats {
    display: grid;
    grid-auto-flow: column;
    gap: 0;
    border-radius: 1rem;
    box-shadow: var(--card-shadow);
    overflow: hidden;
    background: var(--bg-card);
}

.stat {
    padding: 1.5rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    border-right: 1px solid var(--border-color-light);
}

.stat:last-child {
    border-right: none;
}

.stat-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Note: .stat-value is defined in main stat-card section above */

.stat-desc {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 400;
}

/* ========== Additional Polish ========== */
/* Better spacing for headings with emojis */
h2:first-line,
h3:first-line {
    line-height: 1.4;
}

/* Smooth scrolling */
html {
    scroll-behavior: smooth;
}

/* ========== Form Layout Improvements ========== */
/* Align form fields properly */
form {
    max-width: 100%;
}

/* Grid layout for form fields */
form .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

/* Stack labels and inputs vertically */
form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* Consistent form field widths */
form input[type="text"],
form input[type="email"],
form input[type="password"],
form input[type="number"],
form input[type="date"],
form input[type="tel"],
form select,
form textarea {
    width: 100%;
}

/* Search field containers (fix alignment issues) */
.search-container,
form[method="get"] {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
    flex-wrap: wrap;
}

.search-container input,
form[method="get"] input {
    flex: 1;
    min-width: 250px;
}

.search-container button,
form[method="get"] button {
    flex-shrink: 0;
}

/* ========== Legacy Button Overrides ========== */
/*
 * NOTE: These overrides exist for backward compatibility with old button styles.
 * For NEW buttons, use the BEM system: .btn, .btn--primary, .btn--success, etc.
 * See Python helpers: btn(), btn_link(), btn_icon()
 *
 * Legacy classes being phased out:
 * - .btn-outline → use .btn.btn--secondary
 * - .btn-danger → use .btn.btn--danger
 * - .secondary, .ghost, .success, .danger → use .btn.btn--{variant}
 */

/* Legacy .btn-outline - map to secondary style */
button.btn-outline:not(.btn),
a.btn-outline:not(.btn) {
    background: var(--btn-secondary-bg);
    color: var(--btn-secondary-text);
    border: 1px solid var(--btn-secondary-border);
    box-shadow: none;
    padding: 0.5rem 1rem;
}
button.btn-outline:not(.btn):hover,
a.btn-outline:not(.btn):hover {
    background: var(--btn-secondary-hover-bg);
    border-color: var(--btn-secondary-text);
}

/* Legacy .btn-danger (old style) - map to danger style */
button.btn-danger:not(.btn) {
    background: var(--btn-danger-bg);
    color: var(--btn-danger-text);
    border: 1px solid var(--btn-danger-border);
    box-shadow: none;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
button.btn-danger:not(.btn):hover {
    background: var(--btn-danger-hover-bg);
    color: var(--btn-danger-hover-text);
    border-color: var(--btn-danger-hover-bg);
}

/* Legacy old-style variants (without .btn class) */
button.secondary:not(.btn),
[role="button"].secondary:not(.btn) {
    background: var(--btn-secondary-bg);
    color: var(--accent);
    border: 1.5px solid var(--accent);
}

button.ghost:not(.btn),
[role="button"].ghost:not(.btn) {
    background: transparent;
    color: var(--accent);
    border: none;
    box-shadow: none;
}

button.success:not(.btn),
[role="button"].success:not(.btn) {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

button.danger:not(.btn),
[role="button"].danger:not(.btn) {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

/* Selection styling */
::selection {
    background: rgba(99, 102, 241, 0.2);
    color: #1e293b;
}

/* Focus visible for accessibility */
*:focus-visible {
    outline: 2px solid #6366f1;
    outline-offset: 2px;
}

/* ========== Responsive Design ========== */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.25rem; }
    h3 { font-size: 1.1rem; }

    nav .nav-container {
        flex-direction: column;
        gap: 1rem;
    }

    nav ul {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }
}

/* ========== Enhanced Tabs with "Folder Tab" Effect ========== */
.tabs {
    display: flex;
    gap: 0.25rem;
    margin-bottom: 0;
    padding-left: 0.5rem;
}

.tab {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem 0.5rem 0 0;
    background: var(--accent-light);
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.9375rem;
    border: 1px solid var(--border-color);
    border-bottom: none;
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: -1px;
}

.tab:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-primary);
}

.tab-active {
    background: var(--bg-card) !important;
    color: var(--accent) !important;
    font-weight: 600;
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 -4px 12px rgba(59, 130, 246, 0.15);
    border-color: var(--accent);
    z-index: 10;
}

.tab-active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    border-radius: 0.5rem 0.5rem 0 0;
}

/* Remove DaisyUI tab-lifted corner decorations (black corners) */
.tabs-lifted > .tab::before,
.tabs-lifted > .tab::after,
.tabs-lifted > .tab-active::after {
    display: none !important;
}

/* Also hide any corner elements from daisyUI tabs-lifted */
.tabs-lifted::before,
.tabs-lifted::after {
    display: none !important;
}

/* ========== Enhanced Stat Cards with Gradients ========== */
.stats {
    display: grid;
    grid-auto-flow: column;
    gap: 1rem;
    border-radius: 1rem;
    box-shadow: none;
    overflow: visible;
    background: transparent;
}

.stat {
    padding: 1.75rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    background: var(--bg-card);
    border-radius: 0.75rem;
    border: 1px solid var(--card-border);
    box-shadow: var(--card-shadow);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.stat::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
}

.stat:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-shadow-hover);
    border-color: var(--accent);
}

/* Note: stat-title, stat-value, stat-desc are defined earlier in stat-card section */

/* ========== Sidebar Navigation ========== */
.app-layout {
    display: flex;
    min-height: 100vh;
    background: var(--bg-page);
}

.sidebar {
    width: 240px;
    min-width: 240px;
    background: var(--bg-sidebar);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 100;
    overflow-y: auto;
    overflow-x: hidden;
    border-right: 1px solid var(--sidebar-border);
    box-shadow: var(--sidebar-shadow);
}

.sidebar.collapsed {
    width: 60px;
    min-width: 60px;
}

.sidebar-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--sidebar-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 56px;
    gap: 0.5rem;
}

.sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: var(--text-primary);
}

.sidebar-logo-text {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
}

.sidebar.collapsed .sidebar-logo-text {
    display: none;
}

.sidebar-toggle-btn {
    width: 32px;
    height: 32px;
    min-width: 32px;
    background: var(--bg-sidebar-hover) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 0.375rem !important;
    cursor: pointer;
    display: flex !important;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: var(--text-secondary) !important;
    transition: all 0.2s;
    padding: 0 !important;
    box-shadow: none !important;
    transform: none !important;
}

.sidebar-toggle-btn:hover {
    background: var(--accent-light) !important;
    color: var(--accent) !important;
    transform: none !important;
    box-shadow: none !important;
}

.sidebar.collapsed .sidebar-header {
    justify-content: center;
}

.sidebar.collapsed .sidebar-toggle-btn {
    width: 36px;
    height: 36px;
}

.sidebar-nav {
    flex: 1;
    padding: 0.5rem 0;
    overflow-y: auto;
    overflow-x: hidden;
}

.sidebar-section {
    margin-bottom: 0.25rem;
}

/* Clickable section header (accordion toggle) */
.sidebar-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.sidebar-section-header:hover {
    color: var(--text-secondary);
    background: var(--bg-sidebar-hover);
}

.sidebar-section-arrow {
    font-size: 0.5rem;
    transition: transform 0.2s ease;
}

.sidebar-section.collapsed .sidebar-section-arrow {
    transform: rotate(-90deg);
}

.sidebar-section-items {
    overflow: hidden;
    transition: max-height 0.3s ease;
    max-height: 500px;
}

.sidebar-section.collapsed .sidebar-section-items {
    max-height: 0;
}

.sidebar.collapsed .sidebar-section-header {
    display: none;
}

.sidebar-item {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.6rem 1rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s;
    border-left: 3px solid transparent;
    cursor: pointer;
}

.sidebar-item:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-primary);
    border-left-color: var(--accent);
}

.sidebar-item.active {
    background: var(--bg-sidebar-active);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 500;
}

.sidebar-item-icon {
    width: 20px;
    height: 20px;
    min-width: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

/* Lucide icons inherit current color */
.lucide-icon,
.lucide-icon svg {
    stroke: currentColor;
    fill: none;
}

.sidebar-item-icon svg {
    stroke: currentColor;
    width: 20px;
    height: 20px;
}

.sidebar-item-text {
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.sidebar.collapsed .sidebar-item-text {
    display: none;
}

.sidebar.collapsed .sidebar-badge {
    display: none;
}

.sidebar.collapsed .sidebar-item {
    justify-content: center;
    padding: 0.6rem;
    border-left: none;
}

/* User section at bottom */
.sidebar-footer {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--sidebar-border);
    margin-top: auto;
}

.sidebar-user {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    color: var(--text-secondary);
    font-size: 0.8rem;
    text-decoration: none;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s;
}

.sidebar-user:hover {
    background: var(--bg-sidebar-hover);
}

.sidebar-user-avatar {
    width: 32px;
    height: 32px;
    min-width: 32px;
    background: var(--accent-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-on-accent);
    font-weight: 600;
    font-size: 0.85rem;
}

.sidebar-user-info {
    overflow: hidden;
}

.sidebar-user-email {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 140px;
}

.sidebar-user-logout {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* ========== Theme Toggle (icon-only in header) ========== */
/* High specificity to override button:not(...) rules */
.sidebar-header-buttons > button.theme-toggle,
button.theme-toggle.theme-toggle {
    width: 32px;
    height: 32px;
    min-width: 32px;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 0 !important;
    background: var(--bg-sidebar-hover) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 0.375rem !important;
    color: var(--text-secondary) !important;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: none !important;
    transform: none !important;
}

.sidebar-header-buttons > button.theme-toggle:hover,
button.theme-toggle.theme-toggle:hover {
    background: var(--border-color) !important;
    color: var(--text-primary) !important;
    transform: none !important;
    box-shadow: none !important;
}

/* Theme toggle icons - show/hide based on current theme */
.theme-icon-moon,
.theme-icon-sun {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* Light theme (default): show moon icon, hide sun */
.theme-icon-sun {
    display: none;
}

/* Dark theme: show sun icon, hide moon */
[data-theme="dark"] .theme-icon-moon {
    display: none;
}

[data-theme="dark"] .theme-icon-sun {
    display: inline-flex;
}

/* Header buttons container */
.sidebar-header-buttons {
    display: flex;
    gap: 0.4rem;
    align-items: center;
}

/* When collapsed, stack buttons vertically */
.sidebar.collapsed .sidebar-header-buttons {
    flex-direction: column;
    gap: 0.3rem;
}

.sidebar.collapsed .sidebar-user-info {
    display: none;
}

.sidebar.collapsed .sidebar-user {
    justify-content: center;
}

/* Main content area */
.main-content {
    flex: 1;
    margin-left: 240px;
    transition: margin-left 0.3s ease;
    min-height: 100vh;
}

.sidebar.collapsed + .main-content,
.main-content.sidebar-collapsed {
    margin-left: 60px;
}

/* Remove old nav styles when sidebar is used (except sidebar-nav) */
.app-layout nav:not(.sidebar-nav) {
    display: none;
}

/* ========== Design System V2: Status Badge System ========== */
/* Reference: Logistics page compact design */

.status-badge-v2 {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    white-space: nowrap;
    transition: var(--transition-smooth);
}

.status-badge-v2--pending {
    background: var(--badge-pending);
    color: #92400e;
}

.status-badge-v2--active,
.status-badge-v2--success {
    background: var(--badge-active);
    color: #065f46;
}

.status-badge-v2--complete,
.status-badge-v2--info {
    background: var(--badge-complete);
    color: #1e40af;
}

.status-badge-v2--purple {
    background: var(--badge-purple);
    color: #6b21a8;
}

.status-badge-v2--neutral {
    background: var(--badge-neutral);
    color: #4b5563;
}

.status-badge-v2--error {
    background: var(--badge-error);
    color: #991b1b;
}

.status-badge-v2--warning {
    background: var(--badge-pending);
    color: #92400e;
}

/* Dark theme overrides */
[data-theme="dark"] .status-badge-v2--pending { color: #fcd34d; }
[data-theme="dark"] .status-badge-v2--active,
[data-theme="dark"] .status-badge-v2--success { color: #86efac; }
[data-theme="dark"] .status-badge-v2--complete,
[data-theme="dark"] .status-badge-v2--info { color: #93c5fd; }
[data-theme="dark"] .status-badge-v2--purple { color: #c4b5fd; }
[data-theme="dark"] .status-badge-v2--neutral { color: #d1d5db; }
[data-theme="dark"] .status-badge-v2--error { color: #fca5a5; }
[data-theme="dark"] .status-badge-v2--warning { color: #fcd34d; }

/* ========== Design System V2: Elevated Cards ========== */

.card-elevated {
    background: var(--bg-card-elevated);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: var(--shadow-card-v2);
    transition: var(--transition-smooth);
    overflow: hidden;
}

.card-elevated:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    transform: translateY(-2px);
}

.card-elevated-static {
    background: var(--bg-card-elevated);
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: var(--shadow-card-v2);
}

[data-theme="dark"] .card-elevated,
[data-theme="dark"] .card-elevated-static {
    border-color: rgba(255, 255, 255, 0.1);
}

/* ========== Design System V2: Compact Labels ========== */

.label-compact {
    font-size: var(--label-size);
    font-weight: var(--label-weight);
    color: var(--label-color);
    text-transform: var(--label-transform);
    letter-spacing: var(--label-spacing);
    margin-bottom: 4px;
}

/* ========== Design System V2: Enhanced Tables ========== */

.table-enhanced {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    background: var(--bg-card);
}

/* Table Container with rounded corners */
.table-enhanced-container {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-card-v2);
    border: 1px solid #e2e8f0;
}

[data-theme="dark"] .table-enhanced-container {
    border-color: rgba(255, 255, 255, 0.1);
}

/* Header Row */
.table-enhanced thead {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

[data-theme="dark"] .table-enhanced thead {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%);
}

.table-enhanced thead th {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    padding: 12px 16px;
    border-bottom: 2px solid #e2e8f0;
    text-align: left;
    white-space: nowrap;
}

[data-theme="dark"] .table-enhanced thead th {
    color: #94a3b8;
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

/* Body Rows */
.table-enhanced tbody tr {
    transition: all 0.15s ease;
    border-bottom: 1px solid #f1f5f9;
}

[data-theme="dark"] .table-enhanced tbody tr {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

.table-enhanced tbody tr:last-child {
    border-bottom: none;
}

/* Zebra Striping */
.table-enhanced tbody tr:nth-child(even) {
    background: rgba(59, 130, 246, 0.02);
}

[data-theme="dark"] .table-enhanced tbody tr:nth-child(even) {
    background: rgba(99, 102, 241, 0.04);
}

/* Hover Effect */
.table-enhanced tbody tr:hover {
    background: rgba(59, 130, 246, 0.06);
    box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.1);
}

[data-theme="dark"] .table-enhanced tbody tr:hover {
    background: rgba(99, 102, 241, 0.1);
    box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.15);
}

/* Cell Styling */
.table-enhanced td {
    padding: 14px 16px;
    font-size: 14px;
    vertical-align: middle;
}

/* Link Styling in Tables */
.table-enhanced a {
    color: #3b82f6;
    font-weight: 500;
}

[data-theme="dark"] .table-enhanced a {
    color: #93c5fd;
}

/* Right-align numeric columns */
.table-enhanced th.col-number,
.table-enhanced td.col-number,
.table-enhanced th.col-money,
.table-enhanced td.col-money {
    text-align: right;
}

/* Center-align action columns */
.table-enhanced th.col-actions,
.table-enhanced td.col-actions {
    text-align: center;
    width: 100px;
}

/* ========== Design System V2: Handsontable Overrides ========== */

/* Handsontable Container */
.handsontable-container {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-card-v2);
    border: 1px solid #e2e8f0;
}

[data-theme="dark"] .handsontable-container {
    border-color: rgba(255, 255, 255, 0.1);
}

/* Header Row - Match design system */
.handsontable-container .handsontable thead th,
.handsontable thead th.htNoFrame {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
    font-size: 11px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
    color: #64748b !important;
    border-bottom: 2px solid #e2e8f0 !important;
    padding: 10px 12px !important;
}

[data-theme="dark"] .handsontable-container .handsontable thead th,
[data-theme="dark"] .handsontable thead th.htNoFrame {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%) !important;
    color: #94a3b8 !important;
    border-bottom-color: rgba(255, 255, 255, 0.1) !important;
}

/* Body Cells */
.handsontable-container .handsontable td {
    border-color: #f1f5f9 !important;
    font-size: 14px !important;
    padding: 8px 12px !important;
}

[data-theme="dark"] .handsontable-container .handsontable td {
    border-color: rgba(255, 255, 255, 0.05) !important;
}

/* Zebra Striping */
.handsontable-container .handsontable tbody tr:nth-child(even) td {
    background: rgba(59, 130, 246, 0.02) !important;
}

[data-theme="dark"] .handsontable-container .handsontable tbody tr:nth-child(even) td {
    background: rgba(99, 102, 241, 0.04) !important;
}

/* Hover Effect */
.handsontable-container .handsontable tbody tr:hover td {
    background: rgba(59, 130, 246, 0.06) !important;
}

[data-theme="dark"] .handsontable-container .handsontable tbody tr:hover td {
    background: rgba(99, 102, 241, 0.1) !important;
}

/* Read-only Cells - Subtle gray background */
.handsontable-container .handsontable td.htDimmed {
    background: #f9fafb !important;
    color: #64748b !important;
}

[data-theme="dark"] .handsontable-container .handsontable td.htDimmed {
    background: rgba(255, 255, 255, 0.03) !important;
    color: #94a3b8 !important;
}

/* Editable Cells - White background */
.handsontable-container .handsontable td:not(.htDimmed) {
    background: #ffffff !important;
}

[data-theme="dark"] .handsontable-container .handsontable td:not(.htDimmed) {
    background: #1e1e2f !important;
}

/* Selected Cell */
.handsontable-container .handsontable td.current,
.handsontable-container .handsontable td.area {
    border: 2px solid #3b82f6 !important;
    box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.2) !important;
}

[data-theme="dark"] .handsontable-container .handsontable td.current,
[data-theme="dark"] .handsontable-container .handsontable td.area {
    border-color: #6366f1 !important;
    box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.3) !important;
}

/* Input in Cell */
.handsontable-container .handsontable .handsontableInput {
    font-size: 14px !important;
    padding: 6px 10px !important;
    border: 1px solid #3b82f6 !important;
    border-radius: 4px !important;
}

/* Checkbox Cells */
.handsontable-container .handsontable td.htCheckboxRendererInput {
    text-align: center !important;
}

/* Row headers styling */
.handsontable-container .handsontable th.ht_clone_left {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
    font-size: 12px !important;
    color: #64748b !important;
}

[data-theme="dark"] .handsontable-container .handsontable th.ht_clone_left {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 100%) !important;
    color: #94a3b8 !important;
}

/* ========== Design System V2: Animations ========== */

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.animate-fade-in-up {
    animation: fadeInUp 0.4s ease forwards;
}

.animate-fade-in {
    animation: fadeIn 0.3s ease forwards;
}

/* Staggered delays for card grids */
.stagger-1 { animation-delay: 0.05s; opacity: 0; }
.stagger-2 { animation-delay: 0.1s; opacity: 0; }
.stagger-3 { animation-delay: 0.15s; opacity: 0; }
.stagger-4 { animation-delay: 0.2s; opacity: 0; }
.stagger-5 { animation-delay: 0.25s; opacity: 0; }

/* ========== Design System V2: Compact Utilities ========== */

.p-tight { padding: var(--spacing-tight); }
.p-compact { padding: var(--spacing-compact); }
.p-normal { padding: var(--spacing-normal); }

.gap-tight { gap: var(--spacing-tight); }
.gap-compact { gap: var(--spacing-compact); }
.gap-normal { gap: var(--spacing-normal); }

.mb-tight { margin-bottom: var(--spacing-tight); }
.mb-compact { margin-bottom: var(--spacing-compact); }
.mb-normal { margin-bottom: var(--spacing-normal); }
"""

# ============================================================================
# LAYOUT HELPERS
# ============================================================================

def nav_bar(session):
    """Navigation bar component with role-based links"""
    user = session.get("user")
    if user:
        roles = user.get("roles", [])

        # Check if user is procurement-only (no access to sales features)
        is_procurement_only = "procurement" in roles and not any(
            role in roles for role in ["admin", "sales", "sales_manager", "quote_controller"]
        )

        # Base navigation items (hidden from procurement-only users)
        nav_items = [Li(A("Dashboard", href="/dashboard"))]

        # Hide Quotes/Customers/New Quote from procurement-only users
        if not is_procurement_only:
            nav_items.extend([
                Li(A("Quotes", href="/quotes")),
                Li(A("Customers", href="/customers")),
                Li(A("New Quote", href="/quotes/new")),
            ])

        # Role-specific navigation items
        if "procurement" in roles or "admin" in roles:
            nav_items.append(Li(A("Закупки", href="/procurement")))

        if "logistics" in roles or "admin" in roles:
            nav_items.append(Li(A("Логистика", href="/logistics")))

        if "customs" in roles or "admin" in roles:
            nav_items.append(Li(A("Таможня", href="/customs")))

        if "quote_controller" in roles or "admin" in roles:
            nav_items.append(Li(A("Контроль КП", href="/quote-control")))

        if "top_manager" in roles or "admin" in roles:
            nav_items.append(Li(A("Согласования", href="/approvals")))

        if "spec_controller" in roles or "admin" in roles:
            nav_items.append(Li(A("Спецификации", href="/spec-control")))

        if "finance" in roles or "admin" in roles:
            nav_items.append(Li(A("Финансы", href="/finance")))

        # Supply chain navigation (procurement + admin)
        if "procurement" in roles or "admin" in roles:
            nav_items.append(Li(A("Поставщики", href="/suppliers")))

        # Admin-only navigation
        if "admin" in roles:
            nav_items.append(Li(A("Админ", href="/admin")))
            nav_items.append(Li(A("Settings", href="/settings")))

        # Add profile and logout at the end
        nav_items.extend([
            Li(A("Профиль", href="/profile")),
            Li(A(f"Logout ({user.get('email', 'User')})", href="/logout")),
        ])

        return Nav(
            Div(
                Ul(Li(Strong("Kvota OneStack"))),
                Ul(*nav_items),
                cls="nav-container"
            )
        )
    return Nav(
        Div(
            Ul(Li(Strong("Kvota OneStack"))),
            Ul(Li(A("Login", href="/login"))),
            cls="nav-container"
        )
    )


def sidebar(session, current_path: str = ""):
    """
    Collapsible sidebar navigation with role-based menu items.

    Args:
        session: User session with roles
        current_path: Current URL path to highlight active item
    """
    user = session.get("user")

    if not user:
        # Not logged in - show minimal sidebar with login
        return Aside(
            Div(
                A(
                    Span("Kvota", cls="sidebar-logo-text"),
                    href="/",
                    cls="sidebar-logo"
                ),
                Button(
                    Div("☰", cls="sidebar-toggle-icon", id="toggle-icon"),
                    cls="sidebar-toggle-btn",
                    onclick="toggleSidebar()",
                    type="button"
                ),
                cls="sidebar-header"
            ),
            Nav(
                Div(
                    A(
                        Span("🔑", cls="sidebar-item-icon"),
                        Span("Войти", cls="sidebar-item-text"),
                        href="/login",
                        cls="sidebar-item"
                    ),
                    cls="sidebar-section"
                ),
                cls="sidebar-nav"
            ),
            # Footer with theme toggle
            Div(
                Button(
                    icon("moon", size=18, cls="theme-icon-moon"),
                    icon("sun", size=18, cls="theme-icon-sun"),
                    cls="theme-toggle",
                    onclick="toggleTheme()",
                    type="button",
                    title="Переключить тему"
                ),
                cls="sidebar-footer",
                style="padding: 0.5rem; display: flex; justify-content: center;"
            ),
            cls="sidebar",
            id="sidebar"
        )

    roles = user.get("roles", [])
    is_admin = "admin" in roles
    user_id = user.get("id")

    # Get pending approvals count for badge (top_manager/admin only)
    pending_approvals_count = 0
    if user_id and (is_admin or "top_manager" in roles):
        try:
            pending_approvals_count = count_pending_approvals(user_id)
        except Exception:
            pending_approvals_count = 0

    # Define menu structure with role requirements
    menu_sections = []

    # === MAIN SECTION ===
    main_items = [
        {"icon": "inbox", "label": "Мои задачи", "href": "/tasks", "roles": None},  # All users - primary entry point
    ]
    # Add "Новый КП" button for sales/admin
    if is_admin or any(r in roles for r in ["sales", "sales_manager"]):
        main_items.append({"icon": "plus-circle", "label": "Новый КП", "href": "/quotes/new", "roles": ["sales", "sales_manager", "admin"]})
    # Add "Обзор" (analytics) for admin/top_manager
    if is_admin or "top_manager" in roles:
        main_items.append({"icon": "bar-chart-3", "label": "Обзор", "href": "/dashboard?tab=overview", "roles": ["admin", "top_manager"]})
    # Add "Согласования" (approvals workspace) for top_manager/admin with badge
    if is_admin or "top_manager" in roles:
        main_items.append({
            "icon": "clock",
            "label": "Согласования",
            "href": "/approvals",
            "roles": ["admin", "top_manager"],
            "badge": pending_approvals_count if pending_approvals_count > 0 else None
        })

    menu_sections.append({"title": "Главное", "items": main_items})

    # === REGISTRIES SECTION (reference data) ===
    registries_items = []

    # Customers - for sales roles
    if is_admin or any(r in roles for r in ["sales", "sales_manager"]):
        registries_items.append({"icon": "users", "label": "Клиенты", "href": "/customers", "roles": ["sales", "sales_manager", "admin"]})

    # Suppliers - for procurement
    if is_admin or "procurement" in roles:
        registries_items.append({"icon": "building-2", "label": "Поставщики", "href": "/suppliers", "roles": ["procurement", "admin"]})

    # Company registries - for admin
    if is_admin:
        registries_items.append({"icon": "building", "label": "Юрлица", "href": "/companies", "roles": ["admin"]})

    if registries_items:
        menu_sections.append({"title": "Реестры", "items": registries_items})

    # === FINANCE SECTION (for finance roles) ===
    if is_admin or any(r in roles for r in ["finance", "top_manager"]):
        finance_items = [
            {"icon": "briefcase", "label": "Сделки", "href": "/deals", "roles": ["finance", "top_manager", "admin"]},
            {"icon": "file-text", "label": "ERPS", "href": "/finance?tab=erps", "roles": ["finance", "top_manager", "admin"]},
            {"icon": "calendar", "label": "Календарь", "href": "/payments/calendar", "roles": ["finance", "top_manager", "admin"]},
        ]
        menu_sections.append({"title": "Финансы", "items": finance_items})

    # === ADMIN SECTION ===
    if is_admin:
        admin_items = [
            {"icon": "user", "label": "Пользователи", "href": "/admin", "roles": ["admin"]},
            {"icon": "settings", "label": "Настройки", "href": "/settings", "roles": ["admin"]},
        ]
        menu_sections.append({"title": "Администрирование", "items": admin_items})

    # Build sidebar sections with collapsible headers
    nav_sections = []
    for idx, section in enumerate(menu_sections):
        section_items = []
        has_active = False

        for item in section["items"]:
            # Check if user has required role
            if item["roles"] is None or is_admin or any(r in roles for r in item["roles"]):
                is_active = current_path == item["href"] or (item["href"] != "/" and current_path.startswith(item["href"]))
                if is_active:
                    has_active = True

                # Build item content with optional badge
                item_content = [
                    icon(item["icon"], size=20, cls="sidebar-item-icon"),
                    Span(item["label"], cls="sidebar-item-text"),
                ]
                # Add badge if present (e.g., pending approvals count)
                if item.get("badge"):
                    item_content.append(
                        Span(
                            str(item["badge"]),
                            cls="sidebar-badge",
                            style="background: #ef4444; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: auto; min-width: 18px; text-align: center;"
                        )
                    )

                section_items.append(
                    A(
                        *item_content,
                        href=item["href"],
                        cls=f"sidebar-item {'active' if is_active else ''}"
                    )
                )

        if section_items:
            section_id = f"section-{idx}"
            nav_sections.append(
                Div(
                    # Clickable section header
                    Div(
                        Span(section["title"]),
                        Span("▼", cls="sidebar-section-arrow"),
                        cls="sidebar-section-header",
                        onclick=f"toggleSection('{section_id}')"
                    ),
                    # Collapsible items container
                    Div(
                        *section_items,
                        cls="sidebar-section-items",
                        id=section_id
                    ),
                    cls="sidebar-section",
                    data_has_active="true" if has_active else "false"
                )
            )

    # User info
    email = user.get("email", "User")
    initials = email[0].upper() if email else "U"

    return Aside(
        # Header with logo and separate toggle button
        Div(
            A(
                Span("Kvota", cls="sidebar-logo-text"),
                href="/dashboard",
                cls="sidebar-logo"
            ),
            Div(
                Button(
                    icon("moon", size=18, cls="theme-icon-moon"),
                    icon("sun", size=18, cls="theme-icon-sun"),
                    cls="theme-toggle",
                    onclick="toggleTheme()",
                    type="button",
                    title="Переключить тему"
                ),
                Button(
                    Div("☰", cls="sidebar-toggle-icon", id="toggle-icon"),
                    cls="sidebar-toggle-btn",
                    onclick="toggleSidebar()",
                    type="button",
                    title="Свернуть панель"
                ),
                cls="sidebar-header-buttons"
            ),
            cls="sidebar-header"
        ),
        # Navigation sections
        Nav(*nav_sections, cls="sidebar-nav"),
        # Footer with user info
        Div(
            A(
                Div(initials, cls="sidebar-user-avatar"),
                Div(
                    Div(email, cls="sidebar-user-email"),
                    Div("Выйти", cls="sidebar-user-logout"),
                    cls="sidebar-user-info"
                ),
                href="/logout",
                cls="sidebar-user"
            ),
            cls="sidebar-footer"
        ),
        cls="sidebar",
        id="sidebar"
    )


# JavaScript for sidebar toggle and section accordion
SIDEBAR_JS = """
<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const toggleIcon = document.getElementById('toggle-icon');

    sidebar.classList.toggle('collapsed');
    if (mainContent) {
        mainContent.classList.toggle('sidebar-collapsed');
    }

    // Update toggle icon
    const isCollapsed = sidebar.classList.contains('collapsed');
    if (toggleIcon) {
        toggleIcon.textContent = isCollapsed ? '▶' : '☰';
    }

    // Save state to localStorage
    localStorage.setItem('sidebarCollapsed', isCollapsed);
}

function toggleSection(sectionId) {
    const sidebar = document.getElementById('sidebar');
    // Don't toggle sections when sidebar is collapsed
    if (sidebar.classList.contains('collapsed')) return;

    const section = document.getElementById(sectionId);
    if (section) {
        const parent = section.closest('.sidebar-section');
        parent.classList.toggle('collapsed');

        // Save section states
        saveSectionStates();
    }
}

function saveSectionStates() {
    const sections = document.querySelectorAll('.sidebar-section');
    const states = {};
    sections.forEach((section, idx) => {
        states[idx] = section.classList.contains('collapsed');
    });
    localStorage.setItem('sidebarSections', JSON.stringify(states));
}

// Restore sidebar and section states on page load
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    const toggleIcon = document.getElementById('toggle-icon');

    // Restore sidebar collapsed state
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
        if (sidebar) sidebar.classList.add('collapsed');
        if (mainContent) mainContent.classList.add('sidebar-collapsed');
        if (toggleIcon) toggleIcon.textContent = '▶';
    }

    // Restore section states - collapse all by default, expand only those with active items
    const savedStates = localStorage.getItem('sidebarSections');
    const sections = document.querySelectorAll('.sidebar-section');

    if (savedStates) {
        // Restore from saved state
        const states = JSON.parse(savedStates);
        sections.forEach((section, idx) => {
            if (states[idx]) {
                section.classList.add('collapsed');
            }
        });
    } else {
        // First visit: collapse all sections except those with active items
        sections.forEach(section => {
            const hasActive = section.getAttribute('data-has-active') === 'true';
            if (!hasActive) {
                section.classList.add('collapsed');
            }
        });
    }
});

// Tab switching - update active class
function switchTab(clickedTab) {
    // Find all tabs in the same tablist
    const tablist = clickedTab.closest('[role="tablist"]');
    if (tablist) {
        const tabs = tablist.querySelectorAll('.tab');
        tabs.forEach(tab => tab.classList.remove('tab-active'));
        clickedTab.classList.add('tab-active');
    }
}

// Theme toggle functionality
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);

    // Update toggle button icon
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    // Icons are toggled via CSS based on data-theme attribute
    // Only update the text label
    // Theme toggle is now icon-only, no text to update
    if (text) {
        // Icon changes are handled by CSS based on data-theme attribute
    }
}

// Initialize theme on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
});
</script>
"""


# ============================================================================
# FEEDBACK / BUG REPORT COMPONENTS
# ============================================================================

FEEDBACK_JS = """
// ========================================
// FEEDBACK: Debug context collection
// ========================================

// Storage for console errors (last 10)
window._feedbackConsoleErrors = [];
window._feedbackHTMXRequests = [];

// Intercept console.error
(function() {
    const originalError = console.error;
    console.error = function(...args) {
        window._feedbackConsoleErrors.push({
            type: 'error',
            message: args.map(a => String(a)).join(' '),
            time: new Date().toISOString()
        });
        if (window._feedbackConsoleErrors.length > 10) {
            window._feedbackConsoleErrors.shift();
        }
        originalError.apply(console, args);
    };
})();

// Intercept console.warn
(function() {
    const originalWarn = console.warn;
    console.warn = function(...args) {
        window._feedbackConsoleErrors.push({
            type: 'warn',
            message: args.map(a => String(a)).join(' '),
            time: new Date().toISOString()
        });
        if (window._feedbackConsoleErrors.length > 10) {
            window._feedbackConsoleErrors.shift();
        }
        originalWarn.apply(console, args);
    };
})();

// Intercept JS exceptions
window.addEventListener('error', function(e) {
    window._feedbackConsoleErrors.push({
        type: 'exception',
        message: e.message + ' at ' + e.filename + ':' + e.lineno,
        time: new Date().toISOString()
    });
});

// Intercept HTMX requests
document.body.addEventListener('htmx:afterRequest', function(e) {
    const xhr = e.detail.xhr;
    window._feedbackHTMXRequests.push({
        url: e.detail.pathInfo?.requestPath || e.detail.requestConfig?.path,
        method: e.detail.requestConfig?.verb?.toUpperCase() || 'GET',
        status: xhr?.status || 'unknown',
        time: new Date().toISOString()
    });
    if (window._feedbackHTMXRequests.length > 10) {
        window._feedbackHTMXRequests.shift();
    }
});

// Collect debug context
function collectDebugContext() {
    return {
        url: window.location.href,
        title: document.title,
        userAgent: navigator.userAgent,
        screenSize: window.innerWidth + 'x' + window.innerHeight,
        consoleErrors: window._feedbackConsoleErrors.slice(-5),
        recentRequests: window._feedbackHTMXRequests.slice(-5),
        formState: collectFormState(),
        sentryEventId: (typeof Sentry !== 'undefined' && Sentry.lastEventId) ? Sentry.lastEventId() : null,
        collectedAt: new Date().toISOString()
    };
}

// Collect form state (without passwords)
function collectFormState() {
    const forms = {};
    document.querySelectorAll('form').forEach((form, idx) => {
        const formData = {};
        form.querySelectorAll('input, select, textarea').forEach(el => {
            if (el.type === 'password' || el.type === 'hidden') return;
            if (!el.name) return;
            formData[el.name] = el.value?.substring(0, 100) || '';
        });
        if (Object.keys(formData).length > 0) {
            forms['form_' + idx] = formData;
        }
    });
    return forms;
}

// Open feedback modal
function openFeedbackModal() {
    const context = collectDebugContext();

    document.getElementById('feedback-page-url').value = context.url;
    document.getElementById('feedback-page-title').value = context.title;
    document.getElementById('feedback-debug-context').value = JSON.stringify(context);

    // Show context preview
    const preview = document.getElementById('feedback-context-preview');
    let previewHtml = '<span class="opacity-70">URL:</span> ' + context.url.substring(0, 50) + (context.url.length > 50 ? '...' : '') + '<br>';
    const browser = context.userAgent.includes('Chrome') ? 'Chrome' :
                   context.userAgent.includes('Firefox') ? 'Firefox' : 'Other';
    previewHtml += '<span class="opacity-70">Browser:</span> ' + browser + '<br>';
    if (context.consoleErrors.length > 0) {
        previewHtml += '<span class="text-error">Console errors:</span> ' + context.consoleErrors.length + '<br>';
    }
    if (context.recentRequests.length > 0) {
        const failed = context.recentRequests.filter(r => r.status >= 400).length;
        previewHtml += '<span class="opacity-70">Recent requests:</span> ' + context.recentRequests.length;
        if (failed > 0) previewHtml += ' <span class="text-error">(' + failed + ' failed)</span>';
        previewHtml += '<br>';
    }
    preview.innerHTML = previewHtml;

    // Show modal
    document.getElementById('feedback-backdrop').style.display = 'block';
    document.getElementById('feedback-modal-box').style.display = 'block';
}

// Close feedback modal
function closeFeedbackModal() {
    document.getElementById('feedback-backdrop').style.display = 'none';
    document.getElementById('feedback-modal-box').style.display = 'none';
    // Reset form
    const form = document.querySelector('#feedback-modal-box form');
    if (form) form.reset();
    const result = document.getElementById('feedback-result');
    if (result) result.innerHTML = '';
}
"""


def feedback_modal():
    """Feedback modal dialog for bug reports and suggestions"""
    return Div(
        # Backdrop (semi-transparent, click to close)
        Div(
            id="feedback-backdrop",
            onclick="closeFeedbackModal()",
            cls="fixed inset-0 bg-black/50 z-[999]",
            style="display: none;"
        ),
        # Modal box (white, centered)
        Div(
            H3("Сообщить о проблеме", cls="font-bold text-lg mb-4"),
            Form(
                # Feedback type
                Div(
                    Label("Тип обращения", cls="label"),
                    Select(
                        Option("Ошибка / Баг", value="bug"),
                        Option("Предложение", value="suggestion"),
                        Option("Вопрос", value="question"),
                        name="feedback_type",
                        cls="select select-bordered w-full"
                    ),
                    cls="form-control mb-3"
                ),
                # Description
                Div(
                    Label("Опишите проблему", cls="label"),
                    Textarea(
                        name="description",
                        placeholder="Что случилось? Что ожидали увидеть?",
                        cls="textarea textarea-bordered w-full h-24",
                        required=True
                    ),
                    cls="form-control mb-3"
                ),
                # Context preview (compact)
                Div(
                    P("Автоматически прикрепится:", cls="text-xs text-gray-400 mb-1"),
                    Div(id="feedback-context-preview",
                        cls="text-xs bg-base-200 p-2 rounded max-h-16 overflow-auto font-mono"),
                    cls="form-control mb-4"
                ),
                # Hidden fields
                Input(type="hidden", name="page_url", id="feedback-page-url"),
                Input(type="hidden", name="page_title", id="feedback-page-title"),
                Input(type="hidden", name="debug_context", id="feedback-debug-context"),
                # Buttons
                Div(
                    btn("Отправить", variant="primary", icon_name="send", type="submit", full_width=True),
                    btn("Закрыть", variant="ghost", type="button", onclick="closeFeedbackModal()", full_width=True, cls="mt-2"),
                    cls="flex flex-col"
                ),
                hx_post="/api/feedback",
                hx_swap="innerHTML",
                hx_target="#feedback-result",
                # Auto-close after successful submit
                **{"hx-on::after-request": "if(event.detail.successful) setTimeout(() => closeFeedbackModal(), 1500)"}
            ),
            Div(id="feedback-result"),
            id="feedback-modal-box",
            cls="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 z-[1000] w-[90%] max-w-2xl",
            style="display: none;"
        ),
        id="feedback-modal"
    )


def feedback_button():
    """Floating feedback button (fixed position, bottom right)"""
    return Div(
        Button(
            I(data_lucide="bug", style="width: 36px; height: 36px;"),
            cls="theme-toggle",  # Exempt from global blue button styling
            style="width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; padding: 0; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; color: #6b7280; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1);",
            onclick="openFeedbackModal()",
            type="button",
            title="Сообщить о проблеме"
        ),
        cls="fixed bottom-4 right-4 z-50"
    )


def page_layout(title, *content, session=None, current_path: str = "", hide_nav: bool = False):
    """Standard page layout wrapper with sidebar navigation and theme support.

    Args:
        title: Page title
        *content: Page content elements
        session: User session data
        current_path: Current path for nav highlighting
        hide_nav: If True, hides sidebar and shows full-width content (for login, etc.)
    """
    # Build body content based on hide_nav flag
    if hide_nav:
        body_content = Body(
            *content,
            # Initialize Lucide icons for standalone pages
            Script("""
                document.addEventListener('DOMContentLoaded', function() {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            """)
        )
    else:
        body_content = Body(
            Div(
                sidebar(session or {}, current_path),
                Main(Div(*content, cls="container"), cls="main-content"),
                cls="app-layout"
            ),
            # Feedback components (floating button + modal)
            feedback_button(),
            feedback_modal()
        )

    return Html(
        Head(
            Title(f"{title} - Kvota"),
            Meta(charset="utf-8"),
            Meta(name="viewport", content="width=device-width, initial-scale=1"),
            # Google Fonts - Manrope (modern, clean font)
            Link(rel="preconnect", href="https://fonts.googleapis.com"),
            Link(rel="preconnect", href="https://fonts.gstatic.com", crossorigin=""),
            Link(rel="stylesheet", href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"),
            # PicoCSS - Modern, semantic CSS framework
            Link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"),
            # DaisyUI + TailwindCSS - Component library
            Script(src="https://cdn.tailwindcss.com"),
            Link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css"),
            # Custom styles (nav, badges, app-specific overrides)
            Style(APP_STYLES),
            # HTMX
            Script(src="https://unpkg.com/htmx.org@1.9.10"),
            # Lucide Icons
            Script(src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"),
            # Handsontable - Excel-like spreadsheet
            Script(src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"),
            Link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css"),
            # SheetJS - Excel/CSV file parsing
            Script(src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"),
            # Sidebar toggle script
            NotStr(SIDEBAR_JS),
            # Feedback JS (debug context collection)
            Script(FEEDBACK_JS),
            # Theme initialization + Lucide icons initialization
            Script("""
                (function() {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    document.documentElement.setAttribute('data-theme', savedTheme);
                })();
                // Initialize Lucide icons after DOM loaded
                document.addEventListener('DOMContentLoaded', function() {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    // Also reinitialize after HTMX swaps (must be inside DOMContentLoaded so document.body exists)
                    document.body.addEventListener('htmx:afterSwap', function() {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    });
                });
            """)
        ),
        body_content,
        data_theme="light"  # Default theme
    )


# ============================================================================
# ICON HELPER
# ============================================================================

def icon(name: str, size: int = 20, cls: str = "", color: str = "", style: str = ""):
    """
    Lucide icon helper - renders an icon using data-lucide attribute.

    Args:
        name: Lucide icon name (e.g., 'layout-dashboard', 'users', 'file-text')
        size: Icon size in pixels (default 20)
        cls: Additional CSS classes
        color: Icon color (e.g., '#64748b', 'red')
        style: Additional inline styles

    Example:
        icon('layout-dashboard')  # Dashboard icon
        icon('users', size=24)    # Users icon, larger
        icon('check', color='#10b981')  # Green check icon

    Common icons mapping (emoji -> Lucide):
        📊 -> layout-dashboard
        📋 -> file-text
        📝 -> plus-circle
        👥 -> users
        🛒 -> shopping-cart
        🏭 -> building-2
        🚚 -> truck
        🛃 -> shield-check
        💰 -> wallet
        ⚙️ -> settings
        🔧 -> wrench
        ✅ -> check-circle
        📑 -> file-stack
        🔑 -> key
    """
    style_parts = [f"width: {size}px; height: {size}px;"]
    if color:
        style_parts.append(f"color: {color};")
    if style:
        style_parts.append(style)

    return I(
        data_lucide=name,
        cls=f"lucide-icon {cls}".strip(),
        style=" ".join(style_parts)
    )


# ============================================================================
# DISMISSIBLE HINT HELPER
# ============================================================================

def dismissible_hint(hint_id: str, *content, variant: str = "info"):
    """
    Render a dismissible hint that can be closed by the user.
    Once dismissed, it won't appear again (stored in localStorage).

    Args:
        hint_id: Unique identifier for the hint (used as localStorage key)
        *content: Content to display inside the hint
        variant: Alert variant ('info', 'success', 'warning', 'error')

    Example:
        dismissible_hint("contacts-editing",
            icon("lightbulb", size=16), " Click on a field to edit it.",
            variant="info"
        )
    """
    element_id = f"hint-{hint_id}"
    storage_key = f"hint_dismissed_{hint_id}"

    # Close button handler: hide element and save to localStorage
    close_handler = f"""
        document.getElementById('{element_id}').style.display = 'none';
        localStorage.setItem('{storage_key}', 'true');
    """

    # Script to check localStorage on load and hide if already dismissed
    init_script = Script(f"""
        (function() {{
            if (localStorage.getItem('{storage_key}') === 'true') {{
                var el = document.getElementById('{element_id}');
                if (el) el.style.display = 'none';
            }}
        }})();
    """)

    return Div(
        Div(
            Div(*content, style="flex: 1;"),
            Span(
                icon("x", size=16),
                onclick=close_handler,
                style="cursor: pointer; padding: 4px; margin: -4px; opacity: 0.6; transition: opacity 0.15s;",
                onmouseover="this.style.opacity='1'",
                onmouseout="this.style.opacity='0.6'",
                title="Скрыть подсказку"
            ),
            style="display: flex; align-items: center; gap: 12px;"
        ),
        init_script,
        id=element_id,
        cls=f"alert alert-{variant}",
        style="margin: 1rem 0;"
    )


# ============================================================================
# STATUS BADGE HELPER (Design System V2)
# ============================================================================

def status_badge_v2(status: str, custom_label: str = None) -> Span:
    """
    Render a polished status badge with gradient background.

    Maps raw workflow status values to styled badges with Russian labels.

    Args:
        status: Raw status value from database (e.g., 'pending_procurement')
        custom_label: Override the default label

    Returns:
        Span element with status-badge-v2 classes

    Example:
        status_badge_v2('pending_procurement')  # Returns amber "Закупки" badge
        status_badge_v2('approved')             # Returns green "Одобрено" badge
    """
    # Status mapping: (Russian label, CSS variant)
    mapping = {
        # Workflow statuses
        'pending_procurement': ('Закупки', 'pending'),
        'pending_logistics': ('Логистика', 'info'),
        'pending_customs': ('Таможня', 'purple'),
        'pending_logistics_and_customs': ('Лог+Там', 'purple'),
        'pending_sales_review': ('Проверка', 'warning'),
        'pending_sales': ('Продажи', 'warning'),
        'pending_review': ('На проверке', 'warning'),
        'pending_control': ('Контроль', 'info'),
        'pending_spec_control': ('Контроль спец', 'info'),

        # Final statuses
        'draft': ('Черновик', 'neutral'),
        'approved': ('Одобрено', 'success'),
        'rejected': ('Отклонено', 'error'),
        'cancelled': ('Отменено', 'neutral'),
        'completed': ('Завершено', 'success'),

        # Quote statuses
        'new': ('Новый', 'info'),
        'sent': ('Отправлено', 'info'),
        'in_progress': ('В работе', 'active'),
        'pending': ('Ожидание', 'pending'),

        # Deal statuses
        'active': ('Активна', 'active'),
        'won': ('Выиграна', 'success'),
        'lost': ('Проиграна', 'error'),

        # Spec statuses
        'spec_draft': ('Черновик', 'neutral'),
        'spec_approved': ('Одобрено', 'success'),
    }

    # Normalize status to lowercase for matching (handles DB values like "Pending_procurement")
    status_lower = (status or '').lower().strip()
    label, variant = mapping.get(status_lower, (status or '—', 'neutral'))

    # Use custom label if provided
    if custom_label:
        label = custom_label

    return Span(label, cls=f"status-badge-v2 status-badge-v2--{variant}")


# ============================================================================
# BUTTON HELPERS (BEM System)
# ============================================================================

def btn(
    label: str,
    variant: str = "primary",
    size: str = None,
    icon_name: str = None,
    icon_right: bool = False,
    full_width: bool = False,
    disabled: bool = False,
    loading: bool = False,
    **kwargs
):
    """
    Standardized button helper using BEM classes.

    Args:
        label: Button text
        variant: 'primary' (gray), 'secondary' (outline), 'success' (green outline),
                 'danger' (red outline), 'ghost' (transparent)
        size: None (default), 'sm' (small), 'lg' (large)
        icon_name: Lucide icon name (e.g., 'check', 'x', 'send')
        icon_right: Place icon on the right side
        full_width: Make button full width
        disabled: Disable the button
        loading: Show loading spinner
        **kwargs: Additional attributes (type, onclick, name, value, etc.)

    Examples:
        btn("Сохранить", variant="primary", icon_name="save")
        btn("Одобрить", variant="success", icon_name="check")
        btn("Удалить", variant="danger", icon_name="trash-2", size="sm")
        btn("Добавить строку", variant="ghost", icon_name="plus")
    """
    # Build class list
    classes = ["btn", f"btn--{variant}"]

    if size:
        classes.append(f"btn--{size}")
    if full_width:
        classes.append("btn--full")
    if disabled:
        classes.append("btn--disabled")
    if loading:
        classes.append("btn--loading")

    # Add any extra classes from kwargs
    if "cls" in kwargs:
        classes.append(kwargs.pop("cls"))

    # Build content
    content = []
    icon_size = 14 if size == "sm" else (18 if size == "lg" else 16)

    if icon_name and not icon_right:
        content.append(icon(icon_name, size=icon_size))

    if label:
        content.append(label)

    if icon_name and icon_right:
        content.append(icon(icon_name, size=icon_size))

    return Button(
        *content,
        cls=" ".join(classes),
        disabled=disabled or loading,
        **kwargs
    )


def btn_link(
    label: str,
    href: str,
    variant: str = "primary",
    size: str = None,
    icon_name: str = None,
    icon_right: bool = False,
    full_width: bool = False,
    disabled: bool = False,
    **kwargs
):
    """
    Standardized link styled as button.

    Args:
        label: Link text
        href: URL to navigate to
        variant: Same as btn()
        size: Same as btn()
        icon_name: Lucide icon name
        icon_right: Place icon on the right side
        full_width: Make button full width
        disabled: Disable the link (adds visual disabled state)
        **kwargs: Additional attributes (target, role, etc.)

    Examples:
        btn_link("Новый КП", href="/quotes/new", icon_name="plus")
        btn_link("Назад", href="/quotes", variant="secondary", icon_name="arrow-left")
    """
    # Build class list
    classes = ["btn", f"btn--{variant}"]

    if size:
        classes.append(f"btn--{size}")
    if full_width:
        classes.append("btn--full")
    if disabled:
        classes.append("btn--disabled")

    # Add any extra classes from kwargs
    if "cls" in kwargs:
        classes.append(kwargs.pop("cls"))

    # Build content
    content = []
    icon_size = 14 if size == "sm" else (18 if size == "lg" else 16)

    if icon_name and not icon_right:
        content.append(icon(icon_name, size=icon_size))

    if label:
        content.append(label)

    if icon_name and icon_right:
        content.append(icon(icon_name, size=icon_size))

    # Set role="button" for proper styling
    return A(
        *content,
        href=href if not disabled else None,
        cls=" ".join(classes),
        role="button",
        **kwargs
    )


def btn_icon(
    icon_name: str,
    variant: str = "ghost",
    size: str = None,
    title: str = None,
    disabled: bool = False,
    **kwargs
):
    """
    Icon-only button (square).

    Args:
        icon_name: Lucide icon name
        variant: Same as btn() (default 'ghost' for toolbar icons)
        size: None (default 2.25rem) or 'sm' (1.75rem)
        title: Tooltip text
        disabled: Disable the button
        **kwargs: Additional attributes

    Examples:
        btn_icon("trash-2", variant="danger", title="Удалить")
        btn_icon("edit", title="Редактировать")
        btn_icon("eye", title="Просмотр", size="sm")
    """
    # Build class list
    classes = ["btn", f"btn--{variant}", "btn--icon-only"]

    if size:
        classes.append(f"btn--{size}")
    if disabled:
        classes.append("btn--disabled")

    # Add any extra classes from kwargs
    if "cls" in kwargs:
        classes.append(kwargs.pop("cls"))

    icon_size = 14 if size == "sm" else 18

    return Button(
        icon(icon_name, size=icon_size),
        cls=" ".join(classes),
        title=title,
        disabled=disabled,
        **kwargs
    )


# ============================================================================
# DAISYUI COMPONENT HELPERS
# ============================================================================

def tab_nav(tabs: list, active_tab: str = None, target_id: str = "tab-content"):
    """
    DaisyUI tab navigation with HTMX integration

    Args:
        tabs: List of dicts with {'id': str, 'label': str, 'url': str, 'icon': str (optional)}
        active_tab: ID of the currently active tab
        target_id: HTMX target element ID for tab content

    Example:
        tab_nav([
            {'id': 'general', 'label': 'Общая информация', 'url': '/customers/123/tab/general', 'icon': 'info'},
            {'id': 'addresses', 'label': 'Адреса', 'url': '/customers/123/tab/addresses', 'icon': 'map-pin'}
        ], active_tab='general')
    """
    def render_tab(tab):
        tab_icon = tab.get("icon")
        content = [icon(tab_icon, size=16, cls="tab-icon"), Span(tab["label"])] if tab_icon else [tab["label"]]
        return A(
            *content,
            href=tab.get("url", "#"),
            cls=f"tab tab-lifted {'tab-active' if tab['id'] == active_tab else ''}",
            style="display: inline-flex; align-items: center; gap: 0.375rem;" if tab_icon else None,
            hx_get=tab.get("url") if tab.get("url") and tab.get("url") != "#" else None,
            hx_target=f"#{target_id}" if tab.get("url") and tab.get("url") != "#" else None,
            hx_swap="innerHTML scroll:false",
            hx_push_url="true" if tab.get("url") and tab.get("url") != "#" else None,
            onclick="switchTab(this)"
        )

    return Div(
        *[render_tab(tab) for tab in tabs],
        role="tablist",
        cls="tabs tabs-lifted"
    )


def page_heading(text: str, icon_name: str = None, level: int = 1, **kwargs):
    """
    Page heading with optional Lucide icon.

    Args:
        text: Heading text
        icon_name: Lucide icon name (e.g., 'inbox', 'users', 'truck')
        level: Heading level (1=H1, 2=H2, 3=H3)
        **kwargs: Additional attributes (style, cls, etc.)

    Example:
        page_heading("Мои задачи", icon_name="inbox")
        page_heading("Закупки", icon_name="shopping-cart", level=2)
    """
    # Choose heading tag based on level
    heading_tags = {1: H1, 2: H2, 3: H3, 4: H4}
    HeadingTag = heading_tags.get(level, H1)

    # Icon sizes based on heading level
    icon_sizes = {1: 28, 2: 24, 3: 20, 4: 18}
    icon_size = icon_sizes.get(level, 24)

    # Build content
    if icon_name:
        # Merge styles
        style = kwargs.pop('style', '') or ''
        default_style = "display: flex; align-items: center; gap: 0.5rem;"
        combined_style = f"{default_style} {style}".strip()

        return HeadingTag(
            icon(icon_name, size=icon_size, cls="heading-icon"),
            Span(text),
            style=combined_style,
            **kwargs
        )
    else:
        return HeadingTag(text, **kwargs)


def badge(text: str, type: str = "neutral", size: str = "md"):
    """
    DaisyUI badge component

    Args:
        text: Badge text
        type: Badge color - 'neutral', 'primary', 'secondary', 'accent', 'success', 'warning', 'error', 'info'
        size: Badge size - 'xs', 'sm', 'md', 'lg'

    Example:
        badge("Активен", type="success")
        badge("Админ", type="error", size="sm")
    """
    type_class = f"badge-{type}" if type != "neutral" else ""
    size_class = f"badge-{size}" if size != "md" else ""
    return Span(text, cls=f"badge {type_class} {size_class}".strip())


def stat_card(value: str, label: str, description: str = None, icon: str = None):
    """
    DaisyUI stat card for dashboard statistics

    Args:
        value: Main value to display (large text)
        label: Label above the value
        description: Optional description below the value
        icon: Optional emoji or icon

    Example:
        stat_card(value="₽38,620", label="Выручка", description="Одобренные КП")
    """
    return Div(
        Div(icon, cls="stat-figure text-4xl") if icon else None,
        Div(label, cls="stat-title"),
        Div(value, cls="stat-value text-primary"),
        Div(description, cls="stat-desc") if description else None,
        cls="stat"
    )


def modal_dialog(id: str, title: str, content, actions=None):
    """
    DaisyUI modal dialog

    Args:
        id: Modal ID for targeting
        title: Modal title
        content: Modal body content (can be Div, Form, etc.)
        actions: Optional list of button elements for modal actions

    Example:
        modal_dialog(
            id="delete-confirm",
            title="Подтвердите удаление",
            content=P("Вы уверены, что хотите удалить этот элемент?"),
            actions=[
                btn("Отмена", variant="secondary", onclick="document.getElementById('delete-confirm').close()"),
                btn("Удалить", variant="danger", icon_name="trash-2")
            ]
        )
    """
    return Div(
        Div(
            Div(
                H3(title, cls="font-bold text-lg"),
                content,
                Div(
                    *actions if actions else [],
                    cls="modal-action"
                ) if actions else None,
                cls="modal-box"
            ),
            Form(method="dialog", cls="modal-backdrop"),
            cls="modal-content"
        ),
        id=id,
        cls="modal"
    )


def require_login(session):
    """Check if user is logged in"""
    if not session.get("user"):
        return RedirectResponse("/login", status_code=303)
    return None


def user_has_role(session, role_code: str) -> bool:
    """
    Check if logged-in user has a specific role (from session cache).

    This function checks the roles stored in the session at login time,
    avoiding database queries for role checks.

    Args:
        session: Session dict containing user info
        role_code: Role code to check for (e.g., 'admin', 'sales')

    Returns:
        True if user has the role, False otherwise

    Example:
        if user_has_role(session, 'admin'):
            # Show admin controls
            pass
    """
    user = session.get("user")
    if not user:
        return False
    roles = user.get("roles", [])
    return role_code in roles


def user_has_any_role(session, role_codes: list) -> bool:
    """
    Check if logged-in user has any of the specified roles (from session cache).

    Args:
        session: Session dict containing user info
        role_codes: List of role codes to check for

    Returns:
        True if user has at least one of the roles, False otherwise

    Example:
        if user_has_any_role(session, ['admin', 'finance']):
            # Show financial controls
            pass
    """
    user = session.get("user")
    if not user:
        return False
    roles = user.get("roles", [])
    return any(code in roles for code in role_codes)


def get_user_roles_from_session(session) -> list:
    """
    Get role codes for the logged-in user from session cache.

    Args:
        session: Session dict containing user info

    Returns:
        List of role codes, or empty list if not logged in
    """
    user = session.get("user")
    if not user:
        return []
    return user.get("roles", [])


def format_money(value, currency="RUB"):
    """Format money value"""
    if value is None:
        return "—"
    symbols = {"RUB": "₽", "USD": "$", "EUR": "€", "CNY": "¥"}
    symbol = symbols.get(currency, currency)
    return f"{symbol}{value:,.0f}"


def build_export_filename(doc_type: str, customer_name: str, quote_number: str, ext: str = "pdf") -> str:
    """
    Build human-readable export filename.

    Format: {doc_type}_{company}_{date}_{number}.{ext}
    Example: invoice_AcmeCorp_2024-02-02_44.pdf

    Args:
        doc_type: Document type (invoice, specification, etc.)
        customer_name: Customer/company name
        quote_number: Full quote number like "КП-2024-044"
        ext: File extension (pdf, xlsx)

    Returns:
        Safe ASCII filename string
    """
    import re
    from datetime import date

    # Cyrillic to Latin transliteration map
    translit_map = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'e',
        'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
        'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
        'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
        'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya',
        'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ё': 'E',
        'Ж': 'Zh', 'З': 'Z', 'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L', 'М': 'M',
        'Н': 'N', 'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U',
        'Ф': 'F', 'Х': 'H', 'Ц': 'Ts', 'Ч': 'Ch', 'Ш': 'Sh', 'Щ': 'Sch',
        'Ъ': '', 'Ы': 'Y', 'Ь': '', 'Э': 'E', 'Ю': 'Yu', 'Я': 'Ya',
    }

    def transliterate(text):
        return ''.join(translit_map.get(c, c) for c in text)

    # Extract numeric suffix from quote number (e.g., "044" from "КП-2024-044")
    number_match = re.search(r'(\d+)$', quote_number or '')
    short_number = number_match.group(1).lstrip('0') or '0' if number_match else '0'

    # Sanitize company name
    safe_name = customer_name or "Unknown"
    # Remove common legal suffixes to shorten
    safe_name = re.sub(r'\s*(ООО|ОАО|ЗАО|ИП|LLC|Inc|Ltd|Corp)\.?\s*', '', safe_name, flags=re.IGNORECASE)
    # Transliterate Cyrillic to Latin
    safe_name = transliterate(safe_name)
    # Keep only ASCII alphanumeric and some safe chars
    safe_name = re.sub(r'[^a-zA-Z0-9\s-]', '', safe_name)
    # Replace spaces with nothing (CamelCase style)
    safe_name = safe_name.replace(' ', '')
    # Truncate if too long
    safe_name = safe_name[:30] if len(safe_name) > 30 else safe_name
    # Fallback if empty after sanitization
    safe_name = safe_name or "Company"

    # Today's date
    today = date.today().isoformat()

    return f"{doc_type}_{safe_name}_{today}_{short_number}.{ext}"


def status_badge(status):
    """Status badge component with DaisyUI styling"""
    # Map old status classes to DaisyUI badge types
    type_map = {
        "draft": "warning",
        "sent": "info",
        "approved": "success",
        "rejected": "error"
    }
    badge_type = type_map.get(status, "neutral")
    return badge(status.capitalize(), type=badge_type)


# ============================================================================
# AUTH ROUTES
# ============================================================================

@rt("/")
def get(session):
    if session.get("user"):
        return RedirectResponse("/tasks", status_code=303)  # New primary entry point
    return RedirectResponse("/login", status_code=303)


@rt("/login")
def get(session):
    if session.get("user"):
        return RedirectResponse("/dashboard", status_code=303)

    # Design system styles for login page
    login_card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
        padding: 40px;
        max-width: 420px;
        margin: 0 auto;
    """

    logo_section_style = """
        text-align: center;
        margin-bottom: 32px;
    """

    logo_icon_style = """
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    """

    title_style = """
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 6px 0;
        letter-spacing: -0.02em;
    """

    subtitle_style = """
        font-size: 14px;
        color: #64748b;
        margin: 0;
    """

    label_style = """
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
    """

    input_style = """
        width: 100%;
        padding: 12px 14px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        color: #1e293b;
        transition: all 0.2s ease;
        box-sizing: border-box;
    """

    input_group_style = "margin-bottom: 20px;"

    submit_btn_style = """
        width: 100%;
        padding: 14px 20px;
        font-size: 15px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 28px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    """

    page_bg_style = """
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
    """

    return page_layout("Вход — OneStack",
        Div(
            Div(
                # Logo section
                Div(
                    Div(
                        icon("layers", size=28, style="color: white;"),
                        style=logo_icon_style
                    ),
                    H1("OneStack", style=title_style),
                    P("Система управления коммерческими предложениями", style=subtitle_style),
                    style=logo_section_style
                ),

                # Form
                Form(
                    # Email field
                    Div(
                        Label("Электронная почта", style=label_style, **{"for": "email"}),
                        Input(
                            name="email",
                            type="email",
                            id="email",
                            placeholder="your@email.com",
                            required=True,
                            style=input_style
                        ),
                        style=input_group_style
                    ),
                    # Password field
                    Div(
                        Label("Пароль", style=label_style, **{"for": "password"}),
                        Input(
                            name="password",
                            type="password",
                            id="password",
                            required=True,
                            style=input_style
                        ),
                        style=input_group_style
                    ),
                    # Submit button
                    Button(
                        icon("log-in", size=18),
                        Span("Войти в систему"),
                        type="submit",
                        style=submit_btn_style
                    ),
                    method="post",
                    action="/login"
                ),
                style=login_card_style
            ),
            style=page_bg_style
        ),
        session=session,
        hide_nav=True
    )


@rt("/login")
def post(email: str, password: str, session):
    """Authenticate with Supabase"""
    try:
        # Use anon client for auth
        client = get_anon_client()
        response = client.auth.sign_in_with_password({
            "email": email,
            "password": password
        })

        if response.user:
            # Get user's organization
            supabase = get_supabase()
            org_result = supabase.table("organization_members") \
                .select("organization_id, organizations(id, name)") \
                .eq("user_id", response.user.id) \
                .eq("status", "active") \
                .limit(1) \
                .execute()

            org_data = org_result.data[0] if org_result.data else None
            org_id = org_data["organization_id"] if org_data else None

            # Get user's roles in the organization
            user_roles = []
            if org_id:
                user_roles = get_user_role_codes(response.user.id, org_id)

            session["user"] = {
                "id": response.user.id,
                "email": response.user.email,
                "org_id": org_id,
                "org_name": org_data["organizations"]["name"] if org_data else "No Organization",
                "roles": user_roles  # List of role codes: ['sales', 'admin', etc.]
            }
            session["access_token"] = response.session.access_token

            return RedirectResponse("/dashboard", status_code=303)

    except Exception as e:
        error_msg = str(e)
        if "Invalid login credentials" in error_msg:
            error_msg = "Неверный email или пароль"

        # Design system styles for login page (same as GET)
        login_card_style = """
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            padding: 40px;
            max-width: 420px;
            margin: 0 auto;
        """

        logo_section_style = """
            text-align: center;
            margin-bottom: 32px;
        """

        logo_icon_style = """
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        """

        title_style = """
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 6px 0;
            letter-spacing: -0.02em;
        """

        subtitle_style = """
            font-size: 14px;
            color: #64748b;
            margin: 0;
        """

        label_style = """
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        """

        input_style = """
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            color: #1e293b;
            transition: all 0.2s ease;
            box-sizing: border-box;
        """

        input_group_style = "margin-bottom: 20px;"

        submit_btn_style = """
            width: 100%;
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 28px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        """

        page_bg_style = """
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
        """

        error_alert_style = """
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fecaca;
            border-radius: 10px;
            color: #dc2626;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 24px;
        """

        return page_layout("Вход — OneStack",
            Div(
                Div(
                    # Logo section
                    Div(
                        Div(
                            icon("layers", size=28, style="color: white;"),
                            style=logo_icon_style
                        ),
                        H1("OneStack", style=title_style),
                        P("Система управления коммерческими предложениями", style=subtitle_style),
                        style=logo_section_style
                    ),

                    # Error alert
                    Div(
                        icon("alert-circle", size=18),
                        Span(error_msg),
                        style=error_alert_style
                    ),

                    # Form
                    Form(
                        # Email field
                        Div(
                            Label("Электронная почта", style=label_style, **{"for": "email"}),
                            Input(
                                name="email",
                                type="email",
                                id="email",
                                value=email,
                                required=True,
                                style=input_style
                            ),
                            style=input_group_style
                        ),
                        # Password field
                        Div(
                            Label("Пароль", style=label_style, **{"for": "password"}),
                            Input(
                                name="password",
                                type="password",
                                id="password",
                                required=True,
                                style=input_style
                            ),
                            style=input_group_style
                        ),
                        # Submit button
                        Button(
                            icon("log-in", size=18),
                            Span("Войти в систему"),
                            type="submit",
                            style=submit_btn_style
                        ),
                        method="post",
                        action="/login"
                    ),
                    style=login_card_style
                ),
                style=page_bg_style
            ),
            session=session,
            hide_nav=True
        )


@rt("/logout")
def get(session):
    session.clear()
    return RedirectResponse("/login", status_code=303)


@rt("/unauthorized")
def get(session):
    """Page shown when user doesn't have required role"""
    # Design system styles
    card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        padding: 48px 40px;
        max-width: 480px;
        margin: 0 auto;
        text-align: center;
    """

    icon_container_style = """
        width: 72px;
        height: 72px;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 24px;
        border: 1px solid #fecaca;
    """

    title_style = """
        font-size: 22px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 12px 0;
        letter-spacing: -0.02em;
    """

    text_style = """
        font-size: 14px;
        color: #64748b;
        margin: 0 0 8px 0;
        line-height: 1.6;
    """

    btn_style = """
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        text-decoration: none;
        margin-top: 24px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    """

    page_bg_style = """
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
    """

    return page_layout("Доступ запрещён — OneStack",
        Div(
            Div(
                # Error icon
                Div(
                    icon("shield-x", size=36, style="color: #dc2626;"),
                    style=icon_container_style
                ),
                # Title
                H1("Доступ запрещён", style=title_style),
                # Description
                P("У вас нет прав для доступа к этой странице.", style=text_style),
                P("Обратитесь к администратору, если считаете это ошибкой.", style=text_style),
                # Back button
                A(
                    icon("arrow-left", size=16),
                    Span("Вернуться на главную"),
                    href="/tasks",
                    style=btn_style
                ),
                style=card_style
            ),
            style=page_bg_style
        ),
        session=session,
        hide_nav=True
    )


# ============================================================================
# DASHBOARD (Feature #86: Role-based tasks)
# ============================================================================

# Dashboard tab configuration
DASHBOARD_TABS = [
    {
        "id": "overview",
        "icon": "bar-chart-3",
        "label": "Обзор",
        "roles": ["admin", "top_manager"],  # Only admin/top_manager see overview
        "priority": 0,
    },
    {
        "id": "sales",
        "icon": "user-circle",
        "label": "Продажи",
        "roles": ["sales", "sales_manager"],
        "priority": 1,
    },
    {
        "id": "procurement",
        "icon": "shopping-cart",
        "label": "Закупки",
        "roles": ["procurement", "admin"],
        "priority": 2,
    },
    {
        "id": "logistics",
        "icon": "truck",
        "label": "Логистика",
        "roles": ["logistics", "head_of_logistics", "admin"],
        "priority": 3,
    },
    {
        "id": "customs",
        "icon": "shield-check",
        "label": "Таможня",
        "roles": ["customs", "head_of_customs", "admin"],
        "priority": 4,
    },
    {
        "id": "quote-control",
        "icon": "check-circle",
        "label": "Контроль КП",
        "roles": ["quote_controller", "admin"],
        "priority": 5,
    },
    {
        "id": "spec-control",
        "icon": "file-text",
        "label": "Спецификации",
        "roles": ["spec_controller", "admin"],
        "priority": 6,
    },
    {
        "id": "finance",
        "icon": "wallet",
        "label": "Финансы",
        "roles": ["finance", "top_manager", "admin"],
        "priority": 7,
    },
]


def get_dashboard_tabs(roles: list) -> list:
    """
    Get visible dashboard tabs based on user roles.

    Returns list of tab dicts the user can see, sorted by priority.
    """
    visible_tabs = []
    for tab in DASHBOARD_TABS:
        if any(role in roles for role in tab["roles"]):
            visible_tabs.append(tab)

    # Sort by priority
    visible_tabs.sort(key=lambda t: t["priority"])
    return visible_tabs


def get_default_dashboard_tab(roles: list) -> str:
    """
    Get default tab for user based on roles.

    Priority:
    1. overview (if admin/top_manager)
    2. First workspace tab by priority
    """
    visible_tabs = get_dashboard_tabs(roles)
    if not visible_tabs:
        return "overview"  # Fallback

    return visible_tabs[0]["id"]


def should_show_dashboard_tabs(roles: list) -> bool:
    """
    Determine if dashboard tabs should be shown.

    Key UX principle: if user has only ONE workspace role (excluding overview),
    show workspace directly without tabs.

    Returns True if tabs should be shown, False otherwise.
    """
    visible_tabs = get_dashboard_tabs(roles)

    # Separate overview from workspace tabs
    workspace_tabs = [t for t in visible_tabs if t["id"] != "overview"]
    has_overview = any(t["id"] == "overview" for t in visible_tabs)

    # Show tabs if:
    # - User has access to overview (admin/top_manager)
    # - User has multiple workspace tabs
    return has_overview or len(workspace_tabs) > 1


def _get_role_tasks_sections(user_id: str, org_id: str, roles: list, supabase) -> list:
    """
    Build role-specific task sections for the dashboard.
    Returns a list of FastHTML elements showing tasks relevant to user's roles.
    """
    sections = []

    # -------------------------------------------------------------------------
    # TOP MANAGER / ADMIN: Pending Approvals
    # -------------------------------------------------------------------------
    if 'top_manager' in roles or 'admin' in roles:
        pending_count = count_pending_approvals(user_id)
        if pending_count > 0:
            # Get approval details - only pending ones
            approvals = get_approvals_with_details(user_id, status='pending', limit=5)

            approval_rows = []
            for a in approvals:
                quote_info = a.get('quotes', {}) or {}
                # Handle both 'idn' and 'idn_quote' field names
                quote_idn = quote_info.get('idn_quote') or quote_info.get('idn') or f"#{a.get('quote_id', '')[:8]}"
                # Get customer name from nested customers relationship
                customer_name = quote_info.get('customers', {}).get('name', '—') if quote_info.get('customers') else '—'
                approval_rows.append(Tr(
                    Td(quote_idn),
                    Td(customer_name),
                    Td(format_money(quote_info.get('total_amount'))),
                    Td(a.get('requested_at', '')[:10] if a.get('requested_at') else '—'),
                    Td(
                        A("Согласовать", href=f"/quotes/{a.get('quote_id')}", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;")
                    )
                ))

            sections.append(
                Div(
                    H2(icon("clock", size=20), f" Ожидают согласования ({pending_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Сумма"), Th("Запрошено"), Th("Действие"))),
                            Tbody(*approval_rows) if approval_rows else Tbody(Tr(Td("Нет ожидающих", colspan="5", style="text-align: center;")))
                        , cls="table-enhanced") if approvals else P("Загрузка..."),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть все согласования →", href="/quotes?status=pending_approval", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #f59e0b; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #f59e0b; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # PROCUREMENT: Quotes needing procurement evaluation
    # -------------------------------------------------------------------------
    if 'procurement' in roles:
        # Get quotes in pending_procurement status
        proc_result = supabase.table("quotes") \
            .select("id, idn_quote, customers(name), workflow_status, created_at") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_procurement") \
            .order("created_at", desc=False) \
            .limit(5) \
            .execute()

        proc_quotes = proc_result.data or []
        proc_count = len(proc_quotes)

        if proc_count > 0:
            proc_rows = [
                Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
                    Td(A("Оценить", href=f"/procurement", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ) for q in proc_quotes
            ]

            sections.append(
                Div(
                    H2(icon("package", size=20), f" Закупки: ожидают оценки ({proc_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Создано"), Th("Действие"))),
                            Tbody(*proc_rows),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть раздел Закупки →", href="/procurement", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #fbbf24; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #fbbf24; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # LOGISTICS: Quotes needing logistics data
    # -------------------------------------------------------------------------
    if 'logistics' in roles:
        log_result = supabase.table("quotes") \
            .select("id, idn_quote, customers(name), workflow_status, created_at") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_logistics") \
            .order("created_at", desc=False) \
            .limit(5) \
            .execute()

        log_quotes = log_result.data or []
        log_count = len(log_quotes)

        if log_count > 0:
            log_rows = [
                Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
                    Td(A("Заполнить", href=f"/logistics", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ) for q in log_quotes
            ]

            sections.append(
                Div(
                    H2(icon("truck", size=20), f" Логистика: ожидают данных ({log_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Создано"), Th("Действие"))),
                            Tbody(*log_rows),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть раздел Логистика →", href="/logistics", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #3b82f6; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #3b82f6; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # CUSTOMS: Quotes needing customs data
    # -------------------------------------------------------------------------
    if 'customs' in roles:
        cust_result = supabase.table("quotes") \
            .select("id, idn_quote, customers(name), workflow_status, created_at") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_customs") \
            .order("created_at", desc=False) \
            .limit(5) \
            .execute()

        cust_quotes = cust_result.data or []
        cust_count = len(cust_quotes)

        if cust_count > 0:
            cust_rows = [
                Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
                    Td(A("Заполнить", href=f"/customs", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ) for q in cust_quotes
            ]

            sections.append(
                Div(
                    H2(icon("shield-check", size=20), f" Таможня: ожидают данных ({cust_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Создано"), Th("Действие"))),
                            Tbody(*cust_rows),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть раздел Таможня →", href="/customs", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #8b5cf6; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #8b5cf6; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # QUOTE_CONTROLLER: Quotes needing review
    # -------------------------------------------------------------------------
    if 'quote_controller' in roles or 'admin' in roles:
        qc_result = supabase.table("quotes") \
            .select("id, idn_quote, customers(name), workflow_status, total_amount, created_at") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_quote_control") \
            .order("created_at", desc=False) \
            .limit(5) \
            .execute()

        qc_quotes = qc_result.data or []
        qc_count = len(qc_quotes)

        if qc_count > 0:
            qc_rows = [
                Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(format_money(q.get("total_amount"))),
                    Td(A("Проверить", href=f"/quote-control/{q['id']}", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ) for q in qc_quotes
            ]

            sections.append(
                Div(
                    H2(icon("check-circle", size=20), f" Контроль КП: на проверке ({qc_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Сумма"), Th("Действие"))),
                            Tbody(*qc_rows),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть раздел Контроль КП →", href="/quote-control", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #ec4899; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #ec4899; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # SPEC_CONTROLLER: Specifications needing work
    # -------------------------------------------------------------------------
    if 'spec_controller' in roles or 'admin' in roles:
        spec_counts = count_specifications_by_status(org_id)
        pending_specs = spec_counts.get('pending_review', 0) + spec_counts.get('draft', 0)

        # Also check quotes pending spec control
        spec_quotes_result = supabase.table("quotes") \
            .select("id", count="exact") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_spec_control") \
            .execute()
        pending_spec_quotes = spec_quotes_result.count or 0

        total_spec_work = pending_specs + pending_spec_quotes

        if total_spec_work > 0:
            sections.append(
                Div(
                    H2(icon("file-text", size=20), f" Спецификации: требуют внимания ({total_spec_work})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Div(
                            Div(str(pending_spec_quotes), style="font-size: 20px; font-weight: 700; color: #4338ca;"),
                            Div("КП для создания спец.", style="font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em;"),
                            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); padding: 12px; border-radius: 8px; text-align: center;"
                        ),
                        Div(
                            Div(str(spec_counts.get('draft', 0)), style="font-size: 20px; font-weight: 700; color: #6366f1;"),
                            Div("Черновики", style="font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em;"),
                            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); padding: 12px; border-radius: 8px; text-align: center;"
                        ),
                        Div(
                            Div(str(spec_counts.get('pending_review', 0)), style="font-size: 20px; font-weight: 700; color: #818cf8;"),
                            Div("На проверке", style="font-size: 11px; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em;"),
                            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); padding: 12px; border-radius: 8px; text-align: center;"
                        ),
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;"
                    ),
                    A("Открыть раздел Спецификации →", href="/spec-control", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #6366f1; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #6366f1; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # FINANCE: Active deals
    # -------------------------------------------------------------------------
    if 'finance' in roles or 'admin' in roles:
        deal_counts = count_deals_by_status(org_id)
        active_deals = deal_counts.get('active', 0)

        if active_deals > 0:
            # Get a few active deals
            active_deals_list = get_deals_by_status(org_id, 'active', limit=5)

            deal_rows = []
            for d in active_deals_list:
                # Deal is a dataclass, use attribute access not .get()
                deal_rows.append(Tr(
                    Td(d.deal_number or '—'),
                    Td(format_money(d.total_amount, d.currency or 'RUB')),
                    Td(A("Открыть", href=f"/finance/{d.id}", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ))

            sections.append(
                Div(
                    H2(icon("wallet", size=20), f" Финансы: активные сделки ({active_deals})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("Сделка #"), Th("Сумма"), Th("Действие"))),
                            Tbody(*deal_rows) if deal_rows else Tbody(Tr(Td("Нет данных", colspan="3", style="text-align: center;"))),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Открыть раздел Финансы →", href="/finance", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #10b981; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #10b981; padding: 16px;"
                )
            )

    # -------------------------------------------------------------------------
    # SALES: My quotes (pending sales review)
    # -------------------------------------------------------------------------
    if 'sales' in roles:
        sales_result = supabase.table("quotes") \
            .select("id, idn_quote, customers(name), workflow_status, total_amount") \
            .eq("organization_id", org_id) \
            .eq("workflow_status", "pending_sales_review") \
            .order("updated_at", desc=True) \
            .limit(5) \
            .execute()

        sales_quotes = sales_result.data or []
        sales_count = len(sales_quotes)

        if sales_count > 0:
            sales_rows = [
                Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(format_money(q.get("total_amount"))),
                    Td(A("Продолжить", href=f"/quotes/{q['id']}", cls="button", style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"))
                ) for q in sales_quotes
            ]

            sections.append(
                Div(
                    H2(icon("edit-3", size=20), f" Продажи: ожидают вашего решения ({sales_count})",
                       style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;"),
                    Div(
                        Table(
                            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Сумма"), Th("Действие"))),
                            Tbody(*sales_rows),
                            cls="table-enhanced"
                        ),
                        cls="table-enhanced-container"
                    ),
                    A("Все мои КП →", href="/quotes", style="display: inline-block; margin-top: 12px; font-size: 13px; color: #f97316; font-weight: 500;"),
                    cls="card-elevated", style="border-left: 4px solid #f97316; padding: 16px;"
                )
            )

    return sections


def _dashboard_overview_content(user_id: str, org_id: str, roles: list, user: dict, supabase) -> list:
    """
    Overview tab content - overall stats and role-specific task summaries.
    Used for admin and top_manager roles.
    """
    # Get overall quotes stats
    quotes_result = supabase.table("quotes") \
        .select("id, status, workflow_status, total_amount") \
        .eq("organization_id", org_id) \
        .execute()

    quotes = quotes_result.data or []

    total_quotes = len(quotes)
    total_revenue = sum(
        Decimal(str(q.get("total_amount") or 0))
        for q in quotes if q.get("workflow_status") in ["approved", "deal"]
    )

    # Count quotes in active workflow stages
    active_workflow = len([q for q in quotes if q.get("workflow_status") not in
                          ["draft", "approved", "deal", "rejected", "cancelled", None]])

    # Get recent quotes
    recent_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), status, workflow_status, total_amount, created_at") \
        .eq("organization_id", org_id) \
        .order("created_at", desc=True) \
        .limit(5) \
        .execute()

    recent_quotes = recent_result.data or []

    # Build role-specific task sections
    task_sections = _get_role_tasks_sections(user_id, org_id, roles, supabase)

    # Role badges
    role_names = {
        'sales': ('Продажи', '#f97316'),
        'procurement': ('Закупки', '#fbbf24'),
        'logistics': ('Логистика', '#3b82f6'),
        'customs': ('Таможня', '#8b5cf6'),
        'quote_controller': ('Контроль КП', '#ec4899'),
        'spec_controller': ('Спецификации', '#6366f1'),
        'finance': ('Финансы', '#10b981'),
        'top_manager': ('Топ-менеджер', '#f59e0b'),
        'admin': ('Админ', '#ef4444'),
    }

    role_badges = [
        Span(role_names.get(r, (r, '#6b7280'))[0],
             style=f"display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.25rem; background: {role_names.get(r, (r, '#6b7280'))[1]}20; color: {role_names.get(r, (r, '#6b7280'))[1]}; border: 1px solid {role_names.get(r, (r, '#6b7280'))[1]}40;")
        for r in roles
    ] if roles else [Span("Нет ролей", style="color: #9ca3af; font-size: 0.875rem;")]

    return [
        # Header with roles
        Div(
            H1("Добро пожаловать!"),
            P(
                Strong("Организация: "), user.get('org_name', 'Неизвестно'), " | ",
                Strong("Ваши роли: "), *role_badges
            ),
            style="margin-bottom: 1rem;"
        ),

        # Overall stats cards
        Div(
            Div(
                Div(str(total_quotes), cls="stat-value"),
                Div("Всего КП"),
                cls="card stat-card"
            ),
            Div(
                Div(format_money(total_revenue), cls="stat-value"),
                Div("Выручка (одобренные)"),
                cls="card stat-card"
            ),
            Div(
                Div(str(active_workflow), cls="stat-value"),
                Div("В работе"),
                cls="card stat-card"
            ),
            cls="stats-grid"
        ),

        # Role-specific task sections
        H2(icon("list-todo", size=22), " Задачи по отделам", cls="section-header") if task_sections else "",
        *task_sections,

        # If no tasks, show helpful message
        Div(
            P(icon("check-circle", size=18), " Нет активных задач! Все под контролем.", style="color: #059669; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;"),
            cls="card", style="text-align: center; background: #ecfdf5;"
        ) if not task_sections else "",

        # Recent quotes
        H2(icon("file-text", size=22), " Последние КП", cls="section-header"),
        Table(
            Thead(Tr(Th("КП #"), Th("Клиент"), Th("Статус"), Th("Сумма"), Th("Действия"))),
            Tbody(
                *[Tr(
                    Td(q.get("idn_quote", f"#{q['id'][:8]}")),
                    Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                    Td(workflow_status_badge(q.get("workflow_status") or q.get("status", "draft"))),
                    Td(format_money(q.get("total_amount"))),
                    Td(A("Открыть", href=f"/quotes/{q['id']}"))
                ) for q in recent_quotes]
            ) if recent_quotes else Tbody(Tr(Td("Нет КП", colspan="5", style="text-align: center;")))
        ),
        A("Все КП →", href="/quotes"),
    ]


def _dashboard_procurement_content(user_id: str, org_id: str, supabase, status_filter: str = None, roles: list = None) -> list:
    """
    Procurement workspace tab content.
    Shows quotes with items having brands assigned to current user.
    Admin users see ALL items regardless of brand assignment.
    """
    # Check if user is admin - bypass brand filtering
    is_admin = roles and "admin" in roles

    # Get brands assigned to this user (empty for admin = see all)
    my_brands = get_assigned_brands(user_id, org_id) if not is_admin else []
    my_brands_lower = [b.lower() for b in my_brands]

    quotes_with_details = []

    # Admin sees all, regular users need assigned brands
    if is_admin or my_brands:
        # Query quote_items with my brands
        items_result = supabase.table("quote_items") \
            .select("id, quote_id, brand, procurement_status, quantity, product_name") \
            .execute()

        # Filter items for my brands (case-insensitive) - admins see all
        if is_admin:
            my_items = items_result.data or []
        else:
            my_items = [item for item in (items_result.data or [])
                        if (item.get("brand") or "").lower() in my_brands_lower]

        # Group items by quote_id
        items_by_quote = {}
        for item in my_items:
            qid = item["quote_id"]
            if qid not in items_by_quote:
                items_by_quote[qid] = []
            items_by_quote[qid].append(item)

        quote_ids_with_my_brands = list(items_by_quote.keys())

        if quote_ids_with_my_brands:
            # Get full quote data for those quotes
            quotes_result = supabase.table("quotes") \
                .select("id, idn_quote, customer_id, customers(name), workflow_status, status, total_amount, created_at") \
                .eq("organization_id", org_id) \
                .in_("id", quote_ids_with_my_brands) \
                .order("created_at", desc=True) \
                .execute()

            # Enrich quotes with item details
            for q in (quotes_result.data or []):
                q_items = items_by_quote.get(q["id"], [])
                total_items = len(q_items)
                completed_items = len([i for i in q_items if i.get("procurement_status") == "completed"])
                brands_in_quote = list(set([i.get("brand", "") for i in q_items]))

                quotes_with_details.append({
                    **q,
                    "my_items": q_items,
                    "my_items_total": total_items,
                    "my_items_completed": completed_items,
                    "my_items_pending": total_items - completed_items,
                    "my_brands_in_quote": brands_in_quote
                })

    # Apply status filter if provided
    if status_filter and status_filter != "all":
        quotes_with_details = [q for q in quotes_with_details
                               if q.get("workflow_status") == status_filter]

    # Separate quotes by workflow status
    pending_quotes = [q for q in quotes_with_details
                      if q.get("workflow_status") == "pending_procurement"]
    other_quotes = [q for q in quotes_with_details
                    if q.get("workflow_status") != "pending_procurement"]

    # Count stats
    pending_count = len(pending_quotes)
    in_progress_count = len([q for q in quotes_with_details
                             if q.get("workflow_status") in ["pending_logistics", "pending_customs", "pending_logistics_and_customs", "pending_sales_review"]])
    completed_count = len([q for q in quotes_with_details
                           if q.get("workflow_status") in ["approved", "deal", "sent_to_client"]])

    # Build the table rows
    def quote_row(q, show_work_button=True):
        customer_name = "—"
        if q.get("customers"):
            customer_name = q["customers"].get("name", "—")

        workflow_status = q.get("workflow_status") or q.get("status", "draft")

        my_total = q.get("my_items_total", 0)
        my_completed = q.get("my_items_completed", 0)
        brands_list = q.get("my_brands_in_quote", [])

        progress_pct = int((my_completed / my_total * 100) if my_total > 0 else 0)
        progress_bar = Div(
            Div(style=f"width: {progress_pct}%; height: 100%; background: #22c55e;"),
            style="width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; display: inline-block; margin-right: 0.5rem; overflow: hidden;",
            title=f"{my_completed}/{my_total} позиций оценено"
        )

        items_info = Span(progress_bar, f"{my_completed}/{my_total}", style="font-size: 0.875rem; color: #666;")

        brands_display = ", ".join(brands_list[:3])
        if len(brands_list) > 3:
            brands_display += f" +{len(brands_list) - 3}"

        return Tr(
            Td(
                A(q.get("idn_quote", f"#{q['id'][:8]}"), href=f"/quotes/{q['id']}", style="font-weight: 500;"),
                Div(brands_display, style="font-size: 0.75rem; color: #888; margin-top: 2px;")
            ),
            Td(customer_name),
            Td(workflow_status_badge(workflow_status)),
            Td(items_info),
            Td(format_money(q.get("total_amount"))),
            Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
            Td(
                btn_link("Открыть", href=f"/procurement/{q['id']}", variant="primary", size="sm")
                if show_work_button and workflow_status == "pending_procurement" else
                btn_link("Просмотр", href=f"/quotes/{q['id']}", variant="ghost", size="sm")
            )
        )

    # Status filter options
    status_options = [
        ("all", "Все статусы"),
        ("pending_procurement", "Ожидают оценки"),
        ("pending_logistics", "На логистике"),
        ("pending_customs", "На таможне"),
        ("pending_sales_review", "У менеджера продаж"),
        ("pending_quote_control", "На проверке"),
        ("approved", "Одобрено"),
        ("deal", "Сделка"),
    ]

    filter_form = Form(
        Label("Фильтр по статусу: ", For="status_filter", style="margin-right: 0.5rem;"),
        Select(
            *[Option(label, value=value, selected=(value == (status_filter or "all")))
              for value, label in status_options],
            name="status_filter",
            id="status_filter",
            onchange="this.form.submit()",
            style="padding: 0.375rem 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;"
        ),
        Hidden(name="tab", value="procurement"),
        method="get",
        action="/dashboard",
        style="margin-bottom: 1rem;"
    )

    return [
        # Header
        Div(
            H1(icon("shopping-cart", size=28), " Закупки", cls="page-header"),
            P("Рабочая зона менеджера по закупкам"),
            style="margin-bottom: 1rem;"
        ),

        # My assigned brands (admin sees all)
        Div(
            H3("Мои бренды"),
            P("Все бренды (администратор)" if is_admin else (", ".join(my_brands) if my_brands else "Нет назначенных брендов. Обратитесь к администратору.")),
            cls="card"
        ),

        # Stats
        Div(
            Div(
                Div(str(pending_count), cls="stat-value"),
                Div("Ожидает оценки"),
                cls="card stat-card",
                style="border-left: 4px solid #f59e0b;" if pending_count > 0 else ""
            ),
            Div(
                Div(str(in_progress_count), cls="stat-value"),
                Div("В процессе"),
                cls="card stat-card"
            ),
            Div(
                Div(str(completed_count), cls="stat-value"),
                Div("Завершено"),
                cls="card stat-card"
            ),
            Div(
                Div(str(len(quotes_with_details)), cls="stat-value"),
                Div("Всего моих КП"),
                cls="card stat-card"
            ),
            cls="stats-grid"
        ),

        # Filter
        filter_form,

        # Pending quotes section
        Div(
            Div(
                Div(
                    H3(icon("alert-circle", size=20), " Ожидают оценки", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ПРОГРЕСС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in pending_quotes]
                        ) if pending_quotes else Tbody(Tr(Td("Нет КП на оценке", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {pending_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if not status_filter or status_filter == "all" else None,

        # Filtered view
        Div(
            Div(
                Div(
                    H3(f"КП: {dict(status_options).get(status_filter, status_filter)}", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ПРОГРЕСС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in quotes_with_details]
                        ) if quotes_with_details else Tbody(Tr(Td("Нет КП с этим статусом", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(quotes_with_details)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if status_filter and status_filter != "all" else None,

        # Other quotes
        Div(
            Div(
                Div(
                    H3(icon("file-text", size=20), " Остальные КП", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ПРОГРЕСС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q, show_work_button=False) for q in other_quotes]
                        ) if other_quotes else Tbody(Tr(Td("Нет других КП", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(other_quotes)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if (not status_filter or status_filter == "all") and other_quotes else None,
    ]


def _dashboard_logistics_content(user_id: str, org_id: str, supabase, status_filter: str = None) -> list:
    """
    Logistics workspace tab content.
    Shows quotes in logistics stage.
    """
    # Get quotes for this organization
    quotes_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), workflow_status, status, total_amount, created_at, logistics_completed_at, customs_completed_at, assigned_logistics_user") \
        .eq("organization_id", org_id) \
        .order("created_at", desc=True) \
        .execute()

    all_quotes = quotes_result.data or []

    logistics_statuses = [
        "pending_logistics",
        "pending_customs",
        "pending_logistics_and_customs",
        "pending_sales_review",
    ]

    quotes_with_details = []
    for q in all_quotes:
        ws = q.get("workflow_status")
        if ws in logistics_statuses or status_filter:
            logistics_done = q.get("logistics_completed_at") is not None
            customs_done = q.get("customs_completed_at") is not None
            quotes_with_details.append({
                **q,
                "logistics_done": logistics_done,
                "customs_done": customs_done,
                "assigned_to_me": q.get("assigned_logistics_user") == user_id
            })

    if status_filter and status_filter != "all":
        quotes_with_details = [q for q in quotes_with_details
                               if q.get("workflow_status") == status_filter]

    pending_quotes = [q for q in quotes_with_details
                      if q.get("workflow_status") in ["pending_logistics", "pending_customs", "pending_logistics_and_customs"]
                      and not q.get("logistics_done")]
    completed_quotes = [q for q in quotes_with_details
                        if q.get("logistics_done")]

    pending_count = len(pending_quotes)
    completed_count = len(completed_quotes)

    def quote_row(q, show_work_button=True):
        customer_name = "—"
        if q.get("customers"):
            customer_name = q["customers"].get("name", "—")

        workflow_status = q.get("workflow_status") or q.get("status", "draft")
        logistics_done = q.get("logistics_done", False)
        customs_done = q.get("customs_done", False)

        stages_status = []
        if logistics_done:
            stages_status.append(Span(icon("check-circle", size=14), " Логистика", style="color: #22c55e; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"))
        else:
            stages_status.append(Span(icon("clock", size=14), " Логистика", style="color: #f59e0b; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"))

        if customs_done:
            stages_status.append(Span(icon("check-circle", size=14), " Таможня", style="color: #22c55e; display: inline-flex; align-items: center; gap: 0.25rem;"))
        else:
            stages_status.append(Span(icon("clock", size=14), " Таможня", style="color: #f59e0b; display: inline-flex; align-items: center; gap: 0.25rem;"))

        return Tr(
            Td(A(q.get("idn_quote", f"#{q['id'][:8]}"), href=f"/quotes/{q['id']}", style="font-weight: 500;")),
            Td(customer_name),
            Td(workflow_status_badge(workflow_status)),
            Td(*stages_status),
            Td(format_money(q.get("total_amount"))),
            Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
            Td(
                btn_link("Работать", href=f"/logistics/{q['id']}", variant="primary", size="sm")
                if show_work_button and not logistics_done and workflow_status in ["pending_logistics", "pending_customs", "pending_logistics_and_customs"] else
                btn_link("Просмотр", href=f"/logistics/{q['id']}", variant="ghost", size="sm")
            )
        )

    status_options = [
        ("all", "Все статусы"),
        ("pending_logistics", "На логистике"),
        ("pending_customs", "На таможне (параллельно)"),
        ("pending_sales_review", "У менеджера продаж"),
    ]

    filter_form = Form(
        Label("Фильтр по статусу: ", For="status_filter", style="margin-right: 0.5rem;"),
        Select(
            *[Option(label, value=value, selected=(value == (status_filter or "all")))
              for value, label in status_options],
            name="status_filter",
            id="status_filter",
            onchange="this.form.submit()",
            style="padding: 0.375rem 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;"
        ),
        Hidden(name="tab", value="logistics"),
        method="get",
        action="/dashboard",
        style="margin-bottom: 1rem;"
    )

    return [
        Div(
            H1(icon("truck", size=28), " Логистика", cls="page-header"),
            P("Рабочая зона логиста"),
            style="margin-bottom: 1rem;"
        ),

        Div(
            Div(
                Div(str(pending_count), cls="stat-value"),
                Div("Ожидает логистики"),
                cls="card stat-card",
                style="border-left: 4px solid #f59e0b;" if pending_count > 0 else ""
            ),
            Div(
                Div(str(completed_count), cls="stat-value"),
                Div("Завершено"),
                cls="card stat-card"
            ),
            Div(
                Div(str(len(quotes_with_details)), cls="stat-value"),
                Div("Всего КП"),
                cls="card stat-card"
            ),
            cls="stats-grid"
        ),

        filter_form,

        Div(
            Div(
                Div(
                    H3(icon("package", size=20), " Ожидают логистики", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in pending_quotes]
                        ) if pending_quotes else Tbody(Tr(Td("Нет КП на логистике", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {pending_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if not status_filter or status_filter == "all" else None,

        Div(
            Div(
                Div(
                    H3(f"КП: {dict(status_options).get(status_filter, status_filter)}", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in quotes_with_details]
                        ) if quotes_with_details else Tbody(Tr(Td("Нет КП с этим статусом", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(quotes_with_details)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if status_filter and status_filter != "all" else None,

        Div(
            Div(
                Div(
                    H3(icon("check-circle", size=20), " Завершено", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q, show_work_button=False) for q in completed_quotes]
                        ) if completed_quotes else Tbody(Tr(Td("Нет завершённых КП", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(completed_quotes)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if (not status_filter or status_filter == "all") and completed_quotes else None,
    ]


def _dashboard_customs_content(user_id: str, org_id: str, supabase, status_filter: str = None) -> list:
    """
    Customs workspace tab content.
    Shows quotes in customs stage.
    """
    quotes_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), workflow_status, status, total_amount, created_at, logistics_completed_at, customs_completed_at, assigned_customs_user") \
        .eq("organization_id", org_id) \
        .order("created_at", desc=True) \
        .execute()

    all_quotes = quotes_result.data or []

    customs_statuses = [
        "pending_customs",
        "pending_logistics",
        "pending_logistics_and_customs",
        "pending_sales_review",
    ]

    quotes_with_details = []
    for q in all_quotes:
        ws = q.get("workflow_status")
        if ws in customs_statuses or status_filter:
            logistics_done = q.get("logistics_completed_at") is not None
            customs_done = q.get("customs_completed_at") is not None
            quotes_with_details.append({
                **q,
                "logistics_done": logistics_done,
                "customs_done": customs_done,
                "assigned_to_me": q.get("assigned_customs_user") == user_id
            })

    if status_filter and status_filter != "all":
        quotes_with_details = [q for q in quotes_with_details
                               if q.get("workflow_status") == status_filter]

    pending_quotes = [q for q in quotes_with_details
                      if q.get("workflow_status") in ["pending_customs", "pending_logistics", "pending_logistics_and_customs"]
                      and not q.get("customs_done")]
    completed_quotes = [q for q in quotes_with_details
                        if q.get("customs_done")]

    pending_count = len(pending_quotes)
    completed_count = len(completed_quotes)

    def quote_row(q, show_work_button=True):
        customer_name = "—"
        if q.get("customers"):
            customer_name = q["customers"].get("name", "—")

        workflow_status = q.get("workflow_status") or q.get("status", "draft")
        logistics_done = q.get("logistics_done", False)
        customs_done = q.get("customs_done", False)

        stages_status = []
        if logistics_done:
            stages_status.append(Span(icon("check-circle", size=14), " Логистика", style="color: #22c55e; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"))
        else:
            stages_status.append(Span(icon("clock", size=14), " Логистика", style="color: #f59e0b; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"))

        if customs_done:
            stages_status.append(Span(icon("check-circle", size=14), " Таможня", style="color: #22c55e; display: inline-flex; align-items: center; gap: 0.25rem;"))
        else:
            stages_status.append(Span(icon("clock", size=14), " Таможня", style="color: #f59e0b; display: inline-flex; align-items: center; gap: 0.25rem;"))

        return Tr(
            Td(A(q.get("idn_quote", f"#{q['id'][:8]}"), href=f"/quotes/{q['id']}", style="font-weight: 500;")),
            Td(customer_name),
            Td(workflow_status_badge(workflow_status)),
            Td(*stages_status),
            Td(format_money(q.get("total_amount"))),
            Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
            Td(
                btn_link("Работать", href=f"/customs/{q['id']}", variant="primary", size="sm")
                if show_work_button and not customs_done and workflow_status in ["pending_customs", "pending_logistics", "pending_logistics_and_customs"] else
                btn_link("Просмотр", href=f"/customs/{q['id']}", variant="ghost", size="sm")
            )
        )

    status_options = [
        ("all", "Все статусы"),
        ("pending_customs", "На таможне"),
        ("pending_logistics", "На логистике (параллельно)"),
        ("pending_sales_review", "У менеджера продаж"),
    ]

    filter_form = Form(
        Label("Фильтр по статусу: ", For="status_filter", style="margin-right: 0.5rem;"),
        Select(
            *[Option(label, value=value, selected=(value == (status_filter or "all")))
              for value, label in status_options],
            name="status_filter",
            id="status_filter",
            onchange="this.form.submit()",
            style="padding: 0.375rem 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;"
        ),
        Hidden(name="tab", value="customs"),
        method="get",
        action="/dashboard",
        style="margin-bottom: 1rem;"
    )

    return [
        Div(
            H1(icon("shield-check", size=28), " Таможня", cls="page-header"),
            P("Рабочая зона таможенного отдела"),
            style="margin-bottom: 1rem;"
        ),

        Div(
            Div(
                Div(str(pending_count), cls="stat-value"),
                Div("Ожидает таможни"),
                cls="card stat-card",
                style="border-left: 4px solid #f59e0b;" if pending_count > 0 else ""
            ),
            Div(
                Div(str(completed_count), cls="stat-value"),
                Div("Завершено"),
                cls="card stat-card"
            ),
            Div(
                Div(str(len(quotes_with_details)), cls="stat-value"),
                Div("Всего КП"),
                cls="card stat-card"
            ),
            cls="stats-grid"
        ),

        filter_form,

        Div(
            Div(
                Div(
                    H3(icon("shield-check", size=20), " Ожидают таможни", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in pending_quotes]
                        ) if pending_quotes else Tbody(Tr(Td("Нет КП на таможне", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {pending_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if not status_filter or status_filter == "all" else None,

        Div(
            Div(
                Div(
                    H3(f"КП: {dict(status_options).get(status_filter, status_filter)}", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in quotes_with_details]
                        ) if quotes_with_details else Tbody(Tr(Td("Нет КП с этим статусом", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(quotes_with_details)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if status_filter and status_filter != "all" else None,

        Div(
            Div(
                Div(
                    H3(icon("check-circle", size=20), " Завершено", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ЭТАПЫ"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q, show_work_button=False) for q in completed_quotes]
                        ) if completed_quotes else Tbody(Tr(Td("Нет завершённых КП", colspan="7", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(completed_quotes)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if (not status_filter or status_filter == "all") and completed_quotes else None,
    ]


def _dashboard_quote_control_content(user_id: str, org_id: str, supabase, status_filter: str = None) -> list:
    """
    Quote Control workspace tab content.
    Shows quotes pending review for quote_controller role.
    """
    quotes_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), workflow_status, status, total_amount, created_at, deal_type, current_version_id") \
        .eq("organization_id", org_id) \
        .order("created_at", desc=True) \
        .execute()

    all_quotes = quotes_result.data or []

    control_statuses = [
        "pending_quote_control",
        "pending_approval",
        "approved",
        "sent_to_client",
    ]

    quotes_with_details = []
    for q in all_quotes:
        ws = q.get("workflow_status")
        if ws in control_statuses or status_filter:
            quotes_with_details.append({
                **q,
                "needs_review": ws == "pending_quote_control",
                "pending_approval": ws == "pending_approval",
                "is_approved": ws == "approved",
                "sent_to_client": ws == "sent_to_client",
            })

    if status_filter and status_filter != "all":
        quotes_with_details = [q for q in quotes_with_details
                               if q.get("workflow_status") == status_filter]

    pending_quotes = [q for q in quotes_with_details if q.get("needs_review")]
    awaiting_approval_quotes = [q for q in quotes_with_details if q.get("pending_approval")]
    approved_quotes = [q for q in quotes_with_details if q.get("is_approved") or q.get("sent_to_client")]

    pending_count = len(pending_quotes)
    awaiting_count = len(awaiting_approval_quotes)
    approved_count = len(approved_quotes)

    def quote_row(q, show_work_button=True):
        customer_name = "—"
        if q.get("customers"):
            customer_name = q["customers"].get("name", "—")

        workflow_status = q.get("workflow_status") or q.get("status", "draft")
        deal_type = q.get("deal_type")
        deal_type_badge = ""
        if deal_type == "supply":
            deal_type_badge = Span("Поставка", style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;")
        elif deal_type == "transit":
            deal_type_badge = Span("Транзит", style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;")

        return Tr(
            Td(
                A(q.get("idn_quote", f"#{q['id'][:8]}"), href=f"/quotes/{q['id']}", style="font-weight: 500;"),
                deal_type_badge if deal_type else "",
            ),
            Td(customer_name),
            Td(workflow_status_badge(workflow_status)),
            Td(format_money(q.get("total_amount"))),
            Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
            Td(
                btn_link("Проверить", href=f"/quote-control/{q['id']}", variant="primary", size="sm")
                if show_work_button and q.get("needs_review") else
                btn_link("Просмотр", href=f"/quote-control/{q['id']}", variant="ghost", size="sm")
            )
        )

    status_options = [
        ("all", "Все статусы"),
        ("pending_quote_control", "На проверке"),
        ("pending_approval", "Ожидает согласования"),
        ("approved", "Одобрено"),
        ("sent_to_client", "Отправлено клиенту"),
    ]

    filter_form = Form(
        Label("Фильтр по статусу: ", For="status_filter", style="margin-right: 0.5rem;"),
        Select(
            *[Option(label, value=value, selected=(value == (status_filter or "all")))
              for value, label in status_options],
            name="status_filter",
            id="status_filter",
            onchange="this.form.submit()",
            style="padding: 0.375rem 0.75rem; border-radius: 4px; border: 1px solid #d1d5db;"
        ),
        Hidden(name="tab", value="quote-control"),
        method="get",
        action="/dashboard",
        style="margin-bottom: 1rem;"
    )

    return [
        Div(
            H1(icon("check-circle", size=28), " Контроль КП", cls="page-header"),
            P("Рабочая зона контроллера КП"),
            style="margin-bottom: 1rem;"
        ),

        Div(
            Div(
                Div(str(pending_count), cls="stat-value"),
                Div("На проверке"),
                cls="card stat-card",
                style="border-left: 4px solid #f59e0b;" if pending_count > 0 else ""
            ),
            Div(
                Div(str(awaiting_count), cls="stat-value"),
                Div("Ожидает согласования"),
                cls="card stat-card",
                style="border-left: 4px solid #3b82f6;" if awaiting_count > 0 else ""
            ),
            Div(
                Div(str(approved_count), cls="stat-value"),
                Div("Одобрено/Отправлено"),
                cls="card stat-card"
            ),
            Div(
                Div(str(len(quotes_with_details)), cls="stat-value"),
                Div("Всего КП"),
                cls="card stat-card"
            ),
            cls="stats-grid"
        ),

        Div(filter_form, cls="card") if not status_filter or status_filter == "all" else filter_form,

        Div(
            Div(
                Div(
                    H3(f"КП: {dict(status_options).get(status_filter, status_filter)}", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in quotes_with_details]
                        ) if quotes_with_details else Tbody(Tr(Td("Нет КП с этим статусом", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {len(quotes_with_details)}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if status_filter and status_filter != "all" else None,

        Div(
            Div(
                Div(
                    H3(icon("file-text", size=20), " Ожидают проверки", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    Span("КП требующие проверки контроллера", style="color: #666; font-size: 0.875rem; font-weight: normal;"),
                    cls="table-header", style="flex-direction: column; align-items: flex-start; gap: 0.25rem;"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q) for q in pending_quotes]
                        ) if pending_quotes else Tbody(Tr(Td("Нет КП на проверке", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {pending_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if not status_filter or status_filter == "all" else None,

        Div(
            Div(
                Div(
                    H3(icon("clock", size=20), " Ожидают согласования", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    Span("КП отправленные на согласование топ-менеджеру", style="color: #666; font-size: 0.875rem; font-weight: normal;"),
                    cls="table-header", style="flex-direction: column; align-items: flex-start; gap: 0.25rem;"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q, show_work_button=False) for q in awaiting_approval_quotes]
                        ) if awaiting_approval_quotes else Tbody(Tr(Td("Нет КП на согласовании", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {awaiting_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if (not status_filter or status_filter == "all") and awaiting_approval_quotes else None,

        Div(
            Div(
                Div(
                    H3(icon("check-circle", size=20), " Одобренные КП", style="display: flex; align-items: center; gap: 0.5rem; margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("КП #"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("СУММА", cls="col-money"), Th("СОЗДАН"), Th("", cls="col-actions"))),
                        Tbody(
                            *[quote_row(q, show_work_button=False) for q in approved_quotes]
                        ) if approved_quotes else Tbody(Tr(Td("Нет одобренных КП", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {approved_count}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0;"
            )
        ) if (not status_filter or status_filter == "all") and approved_quotes else None,
    ]


def _dashboard_spec_control_content(user_id: str, org_id: str, supabase, status_filter: str = None) -> list:
    """
    Spec Control workspace tab content.
    Shows quotes pending specification and existing specifications.
    """
    # Get quotes awaiting specification creation
    quotes_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), workflow_status, status, total_amount, currency, created_at, deal_type, current_version_id") \
        .eq("organization_id", org_id) \
        .eq("workflow_status", "pending_spec_control") \
        .order("created_at", desc=True) \
        .execute()

    pending_quotes = quotes_result.data or []

    # Get all specifications
    specs_result = supabase.table("specifications") \
        .select("id, quote_id, specification_number, proposal_idn, status, sign_date, specification_currency, created_at, updated_at, quotes(idn_quote, customers(name))") \
        .eq("organization_id", org_id) \
        .order("created_at", desc=True) \
        .execute()

    all_specs = specs_result.data or []

    if status_filter and status_filter != "all":
        if status_filter == "pending_quotes":
            filtered_specs = []
        else:
            filtered_specs = [s for s in all_specs if s.get("status") == status_filter]
    else:
        filtered_specs = all_specs

    draft_specs = [s for s in all_specs if s.get("status") == "draft"]
    pending_review_specs = [s for s in all_specs if s.get("status") == "pending_review"]
    approved_specs = [s for s in all_specs if s.get("status") == "approved"]
    signed_specs = [s for s in all_specs if s.get("status") == "signed"]

    stats = {
        "pending_quotes": len(pending_quotes),
        "draft_specs": len(draft_specs),
        "pending_review": len(pending_review_specs),
        "approved": len(approved_specs),
        "signed": len(signed_specs),
        "total_specs": len(all_specs),
    }

    def spec_status_badge(status):
        status_map = {
            "draft": ("Черновик", "bg-gray-200 text-gray-800"),
            "pending_review": ("На проверке", "bg-yellow-200 text-yellow-800"),
            "approved": ("Утверждена", "bg-blue-200 text-blue-800"),
            "signed": ("Подписана", "bg-green-200 text-green-800"),
        }
        label, classes = status_map.get(status, (status, "bg-gray-200 text-gray-800"))
        return Span(label, cls=f"px-2 py-1 rounded text-sm {classes}")

    def deal_type_badge(deal_type):
        if deal_type == "supply":
            return Span("Поставка", cls="px-2 py-1 rounded text-sm bg-blue-100 text-blue-800")
        elif deal_type == "transit":
            return Span("Транзит", cls="px-2 py-1 rounded text-sm bg-yellow-100 text-yellow-800")
        return None

    def pending_quote_row(quote):
        customer_name = quote.get("customers", {}).get("name", "Unknown") if quote.get("customers") else "Unknown"
        return Tr(
            Td(A(quote.get("idn_quote", "-"), href=f"/quotes/{quote['id']}")),
            Td(customer_name),
            Td(deal_type_badge(quote.get("deal_type")) or "-"),
            Td(f"{quote.get('total_amount', 0):,.2f} {quote.get('currency', 'RUB')}"),
            Td(quote.get("created_at", "")[:10] if quote.get("created_at") else "-"),
            Td(
                btn_link("Создать спецификацию", href=f"/spec-control/create/{quote['id']}", variant="success", size="sm"),
            ),
        )

    def spec_row(spec, show_work_button=True):
        quote = spec.get("quotes", {}) or {}
        customer = quote.get("customers", {}) or {}
        quote_idn = quote.get("idn_quote", "-")
        customer_name = customer.get("name", "Unknown")

        return Tr(
            Td(spec.get("specification_number", "-") or A(quote_idn, href=f"/quotes/{spec.get('quote_id')}")),
            Td(customer_name),
            Td(spec_status_badge(spec.get("status", "draft"))),
            Td(spec.get("specification_currency", "-")),
            Td(spec.get("created_at", "")[:10] if spec.get("created_at") else "-"),
            Td(
                btn_link("Редактировать", href=f"/spec-control/{spec['id']}", variant="primary", size="sm") if show_work_button and spec.get("status") in ["draft", "pending_review"] else
                btn_link("Просмотр", href=f"/spec-control/{spec['id']}", variant="ghost", size="sm"),
            ),
        )

    return [
        H1(icon("files", size=28), " Контроль спецификаций", cls="page-header"),

        Div(
            Div(
                Div(str(stats["pending_quotes"]), cls="stat-value", style="color: #f59e0b;"),
                Div("Ожидают спецификации", style="font-size: 0.875rem;"),
                cls="stat-card",
                style="border-left: 4px solid #f59e0b;" if stats["pending_quotes"] > 0 else ""
            ),
            Div(
                Div(str(stats["pending_review"]), cls="stat-value", style="color: #3b82f6;"),
                Div("На проверке", style="font-size: 0.875rem;"),
                cls="stat-card"
            ),
            Div(
                Div(str(stats["approved"]), cls="stat-value", style="color: #22c55e;"),
                Div("Утверждены", style="font-size: 0.875rem;"),
                cls="stat-card"
            ),
            Div(
                Div(str(stats["signed"]), cls="stat-value", style="color: #10b981;"),
                Div("Подписаны", style="font-size: 0.875rem;"),
                cls="stat-card"
            ),
            cls="grid",
            style="grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;"
        ),

        Div(
            Label("Фильтр: ", For="status_filter"),
            Select(
                Option("Все", value="all", selected=not status_filter or status_filter == "all"),
                Option(f"Ожидают спецификации ({stats['pending_quotes']})", value="pending_quotes", selected=status_filter == "pending_quotes"),
                Option(f"Черновики ({stats['draft_specs']})", value="draft", selected=status_filter == "draft"),
                Option(f"На проверке ({stats['pending_review']})", value="pending_review", selected=status_filter == "pending_review"),
                Option(f"Утверждены ({stats['approved']})", value="approved", selected=status_filter == "approved"),
                Option(f"Подписаны ({stats['signed']})", value="signed", selected=status_filter == "signed"),
                id="status_filter",
                onchange="window.location.href='/dashboard?tab=spec-control&status_filter=' + this.value"
            ),
            style="margin-bottom: 1.5rem;"
        ),

        Div(
            Div(
                Div(
                    H3(f"КП ожидающие спецификации", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("№ КП"), Th("КЛИЕНТ"), Th("ТИП СДЕЛКИ"), Th("СУММА", cls="col-money"), Th("ДАТА"), Th("", cls="col-actions"))),
                        Tbody(
                            *[pending_quote_row(q) for q in pending_quotes]
                        ) if pending_quotes else Tbody(Tr(Td("Нет КП, ожидающих спецификации", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {stats['pending_quotes']}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 2rem;"
            )
        ) if not status_filter or status_filter in ["all", "pending_quotes"] else None,

        Div(
            Div(
                Div(
                    H3(f"Спецификации на проверке", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("№ СПЕЦИФИКАЦИИ"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ВАЛЮТА"), Th("ДАТА"), Th("", cls="col-actions"))),
                        Tbody(
                            *[spec_row(s) for s in pending_review_specs]
                        ) if pending_review_specs else Tbody(Tr(Td("Нет спецификаций на проверке", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {stats['pending_review']}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 2rem;"
            )
        ) if not status_filter or status_filter in ["all", "pending_review"] else None,

        Div(
            Div(
                Div(
                    H3(f"Черновики", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("№ СПЕЦИФИКАЦИИ"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ВАЛЮТА"), Th("ДАТА"), Th("", cls="col-actions"))),
                        Tbody(
                            *[spec_row(s) for s in draft_specs]
                        ) if draft_specs else Tbody(Tr(Td("Нет черновиков", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {stats['draft_specs']}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 2rem;"
            )
        ) if status_filter == "draft" else None,

        Div(
            Div(
                Div(
                    H3(f"Утверждённые спецификации", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("№ СПЕЦИФИКАЦИИ"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ВАЛЮТА"), Th("ДАТА"), Th("", cls="col-actions"))),
                        Tbody(
                            *[spec_row(s, show_work_button=False) for s in approved_specs]
                        ) if approved_specs else Tbody(Tr(Td("Нет утверждённых спецификаций", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {stats['approved']}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 2rem;"
            )
        ) if status_filter == "approved" else None,

        Div(
            Div(
                Div(
                    H3(f"Подписанные спецификации", style="margin: 0;"),
                    cls="table-header"
                ),
                Div(
                    Table(
                        Thead(Tr(Th("№ СПЕЦИФИКАЦИИ"), Th("КЛИЕНТ"), Th("СТАТУС"), Th("ВАЛЮТА"), Th("ДАТА"), Th("", cls="col-actions"))),
                        Tbody(
                            *[spec_row(s, show_work_button=False) for s in signed_specs]
                        ) if signed_specs else Tbody(Tr(Td("Нет подписанных спецификаций", colspan="6", style="text-align: center; color: #666;"))),
                    cls="unified-table"),
                    cls="table-responsive"
                ),
                Div(
                    Span(f"Записей: {stats['signed']}"),
                    cls="table-footer"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 2rem;"
            )
        ) if status_filter == "signed" or (not status_filter or status_filter == "all") and signed_specs else None,
    ]


def _dashboard_finance_content(user_id: str, org_id: str, supabase) -> list:
    """
    Finance workspace tab content.
    Redirects to the existing /finance page which already has tabs.
    """
    # For finance, we show a simple redirect message or embed the finance content
    # For now, return a link to the full finance page
    return [
        H1(icon("wallet", size=28), " Финансы", cls="page-header"),
        P("Финансовый раздел имеет собственные табы для детальной работы."),
        Div(
            btn_link("Открыть полный раздел Финансы →", href="/finance", variant="primary", icon_name="arrow-right", icon_right=True),
            style="margin-top: 1rem;"
        ),
    ]


def _calculate_days_remaining(deadline_date) -> str:
    """
    Calculate days remaining until deadline.
    Returns formatted string like 'осталось 5 дн.' or 'просрочено на 3 дн.'
    """
    if not deadline_date:
        return "—"

    try:
        if isinstance(deadline_date, str):
            deadline = datetime.strptime(deadline_date[:10], "%Y-%m-%d").date()
        else:
            deadline = deadline_date

        today = date.today()
        delta = (deadline - today).days

        if delta > 0:
            return f"осталось {delta} дн."
        elif delta == 0:
            return "сегодня"
        else:
            return f"просрочено на {abs(delta)} дн."
    except (ValueError, TypeError):
        return "—"


def _format_deadline_display(deadline_date) -> str:
    """
    Format deadline date with days remaining.
    Returns formatted string like '22.06.2026 (осталось 90 дн.)'
    """
    if not deadline_date:
        return "—"

    try:
        if isinstance(deadline_date, str):
            deadline = datetime.strptime(deadline_date[:10], "%Y-%m-%d").date()
        else:
            deadline = deadline_date

        formatted_date = deadline.strftime("%d.%m.%Y")
        days_remaining = _calculate_days_remaining(deadline_date)

        return f"{formatted_date} ({days_remaining})"
    except (ValueError, TypeError):
        return "—"


def _dashboard_sales_content(user_id: str, org_id: str, user: dict, supabase) -> list:
    """
    Sales Manager Dashboard tab content.
    Shows personal statistics, active specifications, active quotes, and profile card.
    """
    from services.user_profile_service import get_user_profile, get_user_statistics

    # Get user profile and statistics
    profile = get_user_profile(user_id, org_id)
    stats = get_user_statistics(user_id, org_id)

    # Get organization name
    org_result = supabase.table("organizations").select("name").eq("id", org_id).execute()
    org_name = org_result.data[0].get("name", "—") if org_result.data else "—"

    # Get current month sales (deals) and profit
    now = datetime.now()
    first_day_of_month = now.replace(day=1, hour=0, minute=0, second=0, microsecond=0)

    # Query deals closed this month by this user
    month_deals_result = supabase.table("quotes") \
        .select("id, total_amount_usd, total_profit_usd") \
        .eq("organization_id", org_id) \
        .eq("created_by_user_id", user_id) \
        .eq("workflow_status", "deal") \
        .gte("updated_at", first_day_of_month.isoformat()) \
        .execute()

    month_deals = month_deals_result.data or []
    month_sales = sum(float(d.get("total_amount_usd") or 0) for d in month_deals)
    month_profit = sum(float(d.get("total_profit_usd") or 0) for d in month_deals)

    # Get active specifications (status != 'signed') for this user
    active_specs_result = supabase.table("specifications") \
        .select("""
            id,
            specification_number,
            status,
            actual_delivery_date,
            created_at,
            quotes(
                id,
                idn_quote,
                total_amount_usd,
                total_profit_usd,
                customers(name)
            )
        """) \
        .eq("organization_id", org_id) \
        .eq("created_by", user_id) \
        .neq("status", "signed") \
        .order("created_at", desc=True) \
        .limit(10) \
        .execute()

    active_specs = active_specs_result.data or []

    # Calculate totals for active specs
    specs_total_amount = sum(
        float((s.get("quotes") or {}).get("total_amount_usd") or 0)
        for s in active_specs
    )
    specs_total_profit = sum(
        float((s.get("quotes") or {}).get("total_profit_usd") or 0)
        for s in active_specs
    )

    # Get active quotes (not deal/rejected/cancelled) for this user
    active_quotes_result = supabase.table("quotes") \
        .select("id, idn_quote, workflow_status, total_amount_usd, total_profit_usd, customers(name)") \
        .eq("organization_id", org_id) \
        .eq("created_by_user_id", user_id) \
        .not_.in_("workflow_status", ["deal", "rejected", "cancelled"]) \
        .order("created_at", desc=True) \
        .limit(10) \
        .execute()

    active_quotes = active_quotes_result.data or []

    # Spec status badge helper
    def spec_status_badge(status):
        status_map = {
            "draft": ("Черновик", "#6b7280", "#f3f4f6"),
            "pending_review": ("На проверке", "#d97706", "#fef3c7"),
            "approved": ("Одобрена", "#059669", "#d1fae5"),
            "signed": ("Подписана", "#2563eb", "#dbeafe"),
        }
        label, color, bg = status_map.get(status, (status or "—", "#6b7280", "#f3f4f6"))
        return Span(label, style=f"display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background: {bg}; color: {color}; font-weight: 500;")

    # Build spec rows
    def build_spec_row(spec):
        quote = spec.get("quotes") or {}
        customer = quote.get("customers") or {}
        spec_number = spec.get("specification_number") or "—"
        customer_name = customer.get("name") or "—"
        status = spec.get("status") or "draft"
        amount = float(quote.get("total_amount_usd") or 0)
        profit = float(quote.get("total_profit_usd") or 0)
        deadline = spec.get("actual_delivery_date")

        return Tr(
            Td(spec_number, style="font-weight: 500;"),
            Td(customer_name[:25] + "..." if len(customer_name) > 25 else customer_name),
            Td(spec_status_badge(status)),
            Td(f"${amount:,.0f}", style="text-align: right;"),
            Td(f"${profit:,.0f}", style="text-align: right; color: #059669;"),
            Td(_format_deadline_display(deadline), style="font-size: 0.875rem;"),
            cls="clickable-row",
            style="cursor: pointer;",
            onclick=f"window.location='/specifications/{spec['id']}'"
        )

    # Build quote rows
    def build_quote_row(quote):
        customer = quote.get("customers") or {}
        idn = quote.get("idn_quote") or "—"
        customer_name = customer.get("name") or "—"
        status = quote.get("workflow_status") or "draft"
        amount = float(quote.get("total_amount_usd") or 0)
        profit = float(quote.get("total_profit_usd") or 0)

        return Tr(
            Td(idn, style="font-weight: 500;"),
            Td(customer_name[:25] + "..." if len(customer_name) > 25 else customer_name),
            Td(workflow_status_badge(status)),
            Td(f"${amount:,.0f}", style="text-align: right;"),
            Td(f"${profit:,.0f}", style="text-align: right; color: #059669;"),
            cls="clickable-row",
            style="cursor: pointer;",
            onclick=f"window.location='/quotes/{quote['id']}'"
        )

    return [
        # Statistics cards row
        Div(
            Div(
                Div(str(stats.get("total_customers", 0)), cls="stat-value", style="font-size: 1.75rem; font-weight: 700; color: #1f2937;"),
                Div("Клиенты", style="font-size: 0.875rem; color: #6b7280;"),
                cls="card stat-card", style="text-align: center; padding: 1rem;"
            ),
            Div(
                Div(str(stats.get("total_quotes", 0)), cls="stat-value", style="font-size: 1.75rem; font-weight: 700; color: #1f2937;"),
                Div("Ваши КП", style="font-size: 0.875rem; color: #6b7280;"),
                cls="card stat-card", style="text-align: center; padding: 1rem;"
            ),
            Div(
                Div(str(stats.get("total_specifications", 0)), cls="stat-value", style="font-size: 1.75rem; font-weight: 700; color: #1f2937;"),
                Div("Ваши СП", style="font-size: 0.875rem; color: #6b7280;"),
                cls="card stat-card", style="text-align: center; padding: 1rem;"
            ),
            Div(
                Div(f"${month_sales:,.0f}", cls="stat-value", style="font-size: 1.75rem; font-weight: 700; color: #059669;"),
                Div("Продажи (месяц)", style="font-size: 0.875rem; color: #6b7280;"),
                cls="card stat-card", style="text-align: center; padding: 1rem;"
            ),
            Div(
                Div(f"${month_profit:,.0f}", cls="stat-value", style="font-size: 1.75rem; font-weight: 700; color: #10b981;"),
                Div("Профит (месяц)", style="font-size: 0.875rem; color: #6b7280;"),
                cls="card stat-card", style="text-align: center; padding: 1rem;"
            ),
            cls="grid",
            style="grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;"
        ),

        # Main content: two columns (tables + profile card)
        Div(
            # Left column: Tables
            Div(
                # Active Specifications section
                Div(
                    Div(
                        H3("Активные спецификации", style="margin: 0; display: inline;"),
                        Span(f"Итого: ${specs_total_amount:,.0f} | Профит: ${specs_total_profit:,.0f}",
                             style="float: right; color: #6b7280; font-size: 0.875rem; font-weight: normal;"),
                        style="margin-bottom: 1rem;"
                    ),
                    Table(
                        Thead(Tr(
                            Th("ИНД"),
                            Th("Клиент"),
                            Th("Статус"),
                            Th("Сумма", style="text-align: right;"),
                            Th("Профит", style="text-align: right;"),
                            Th("Дедлайн"),
                        )),
                        Tbody(
                            *[build_spec_row(s) for s in active_specs]
                        ) if active_specs else Tbody(
                            Tr(Td("Нет активных спецификаций", colspan="6", style="text-align: center; color: #9ca3af; padding: 2rem;"))
                        ),
                        style="width: 100%;"
                    ),
                    A("→ изменить", href="/specifications", style="display: block; margin-top: 0.75rem; color: #3b82f6; font-size: 0.875rem;"),
                    cls="card",
                    style="margin-bottom: 1.5rem;"
                ),

                # Active Quotes section
                Div(
                    H3("Активные КП", style="margin-bottom: 1rem;"),
                    Table(
                        Thead(Tr(
                            Th("ИНД"),
                            Th("Клиент"),
                            Th("Статус"),
                            Th("Сумма USD", style="text-align: right;"),
                            Th("Профит USD", style="text-align: right;"),
                        )),
                        Tbody(
                            *[build_quote_row(q) for q in active_quotes]
                        ) if active_quotes else Tbody(
                            Tr(Td("Нет активных КП", colspan="5", style="text-align: center; color: #9ca3af; padding: 2rem;"))
                        ),
                        style="width: 100%;"
                    ),
                    A("→ изменить", href="/quotes", style="display: block; margin-top: 0.75rem; color: #3b82f6; font-size: 0.875rem;"),
                    cls="card",
                ),
                style="flex: 1;"
            ),

            # Right column: Profile card
            Div(
                Div(
                    # Avatar placeholder
                    Div(
                        Span(icon("user", size=48), style="color: #9ca3af;"),
                        style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem auto;"
                    ),
                    # Name
                    H3(
                        profile.get("full_name") or user.get("email", "—"),
                        style="text-align: center; margin: 0 0 0.25rem 0; font-size: 1.125rem;"
                    ),
                    # Position
                    P(
                        profile.get("position") or "Менеджер по продажам",
                        style="text-align: center; color: #6b7280; margin: 0 0 0.75rem 0; font-size: 0.875rem;"
                    ),
                    # Phone
                    P(
                        Span(icon("phone", size=14), style="margin-right: 0.375rem;"),
                        profile.get("phone") or "—",
                        style="text-align: center; color: #374151; margin: 0 0 0.5rem 0; font-size: 0.875rem; display: flex; align-items: center; justify-content: center;"
                    ) if profile and profile.get("phone") else None,
                    # Organization
                    P(
                        Span(icon("building-2", size=14), style="margin-right: 0.375rem;"),
                        org_name,
                        style="text-align: center; color: #374151; margin: 0; font-size: 0.875rem; display: flex; align-items: center; justify-content: center;"
                    ),
                    cls="card",
                    style="padding: 1.5rem; text-align: center;"
                ),
                style="width: 260px; flex-shrink: 0;"
            ),

            style="display: flex; gap: 1.5rem; align-items: flex-start;"
        ),
    ]


def _build_dashboard_tabs_nav(tabs: list, active_tab: str) -> Div:
    """
    Build the dashboard tab navigation with design system styling.
    """
    # Tab styles following design system
    tab_base_style = """
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        border-bottom: none;
        margin-bottom: -1px;
    """

    tab_inactive_style = f"{tab_base_style} color: #64748b; background: transparent;"
    tab_active_style = f"""
        {tab_base_style}
        color: #1e293b;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-color: #e2e8f0;
        font-weight: 600;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
    """

    tab_links = []
    for tab in tabs:
        is_active = tab["id"] == active_tab
        tab_links.append(
            A(
                icon(tab.get("icon", "circle"), size=16, color="#3b82f6" if is_active else "#94a3b8"),
                Span(tab["label"]),
                href=f"/dashboard?tab={tab['id']}",
                style=tab_active_style if is_active else tab_inactive_style
            )
        )

    container_style = """
        display: flex;
        gap: 4px;
        padding: 0 4px;
        margin-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        padding: 12px 16px 0 16px;
        border-radius: 12px 12px 0 0;
    """

    return Div(
        *tab_links,
        role="tablist",
        style=container_style
    )


# ============================================================================
# TASKS - Unified Task Inbox (Hub)
# ============================================================================

def _count_user_tasks(user_id: str, org_id: str, roles: list, supabase) -> int:
    """Count total pending tasks for user across all roles."""
    total = 0

    # Approvals for top_manager/admin
    if 'top_manager' in roles or 'admin' in roles:
        total += count_pending_approvals(user_id)

    # Procurement tasks
    if 'procurement' in roles:
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_procurement").execute()
        total += result.count or 0

    # Logistics tasks
    if 'logistics' in roles:
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_logistics").execute()
        total += result.count or 0

    # Customs tasks
    if 'customs' in roles:
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_customs").execute()
        total += result.count or 0

    # Quote controller tasks
    if 'quote_controller' in roles or 'admin' in roles:
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_quote_control").execute()
        total += result.count or 0

    # Spec controller tasks
    if 'spec_controller' in roles or 'admin' in roles:
        spec_counts = count_specifications_by_status(org_id)
        total += spec_counts.get('pending_review', 0) + spec_counts.get('draft', 0)
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_spec_control").execute()
        total += result.count or 0

    # Finance tasks
    if 'finance' in roles or 'admin' in roles:
        deal_counts = count_deals_by_status(org_id)
        total += deal_counts.get('active', 0)

    # Sales tasks
    if 'sales' in roles:
        result = supabase.table("quotes").select("id", count="exact") \
            .eq("organization_id", org_id).eq("workflow_status", "pending_sales_review").execute()
        total += result.count or 0

    return total


@rt("/tasks")
def get(session):
    """
    Unified Task Inbox - shows all pending tasks for the user.
    This is the main entry point instead of dashboard tabs.

    Design System V2: Matches calculate page patterns with gradient cards,
    section headers with icons, and refined spacing.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user.get("id")
    org_id = user.get("org_id")
    supabase = get_supabase()

    # Get user roles
    roles = get_user_role_codes(user_id, org_id) if user_id and org_id else []

    # Count total tasks
    total_tasks = _count_user_tasks(user_id, org_id, roles, supabase)

    # Get task sections for all roles
    task_sections = _get_role_tasks_sections(user_id, org_id, roles, supabase)

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    page_title_style = """
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: -0.02em;
    """

    task_count_badge_style = f"""
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        border-radius: 9999px;
        font-size: 13px;
        font-weight: 600;
        background: {'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)' if total_tasks > 0 else 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)'};
        color: {'#dc2626' if total_tasks > 0 else '#059669'};
        border: 1px solid {'#fecaca' if total_tasks > 0 else '#a7f3d0'};
    """

    roles_label_style = """
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
        font-weight: 600;
        margin-right: 10px;
    """

    # Role badges with refined styling
    role_names = {
        'sales': ('Продажи', '#f97316'),
        'sales_manager': ('Менеджер продаж', '#ea580c'),
        'procurement': ('Закупки', '#eab308'),
        'logistics': ('Логистика', '#3b82f6'),
        'head_of_logistics': ('Рук. логистики', '#2563eb'),
        'customs': ('Таможня', '#8b5cf6'),
        'quote_controller': ('Контроль КП', '#ec4899'),
        'spec_controller': ('Спецификации', '#6366f1'),
        'finance': ('Финансы', '#10b981'),
        'top_manager': ('Топ-менеджер', '#f59e0b'),
        'admin': ('Админ', '#ef4444'),
    }

    role_badges = [
        Span(role_names.get(r, (r, '#6b7280'))[0],
             style=f"""
                display: inline-block;
                padding: 5px 12px;
                border-radius: 8px;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-weight: 600;
                margin-right: 8px;
                margin-bottom: 4px;
                background: {role_names.get(r, (r, '#6b7280'))[1]}12;
                color: {role_names.get(r, (r, '#6b7280'))[1]};
                border: 1px solid {role_names.get(r, (r, '#6b7280'))[1]}25;
             """)
        for r in roles
    ] if roles else [Span("Нет ролей", style="color: #9ca3af; font-size: 13px;")]

    # Empty state card style
    empty_state_style = """
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-radius: 12px;
        border: 1px solid #a7f3d0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        text-align: center;
        padding: 40px 32px;
    """

    # Build content
    content = [
        # Header card with gradient background
        Div(
            Div(
                # Title row with icon and count
                Div(
                    icon("inbox", size=26, style="color: #3b82f6;"),
                    H1("Мои задачи", style=page_title_style),
                    Span(
                        f"{total_tasks} " + ("задач" if total_tasks == 0 or total_tasks >= 5 else "задачи" if total_tasks >= 2 else "задача"),
                        style=task_count_badge_style
                    ),
                    style="display: flex; align-items: center; gap: 14px;"
                ),
                # Roles row
                Div(
                    Span("Роли:", style=roles_label_style),
                    *role_badges,
                    style="display: flex; align-items: center; flex-wrap: wrap; margin-top: 12px;"
                ),
            ),
            style=header_card_style
        ),
    ]

    # Add task sections or empty state
    if task_sections:
        content.extend(task_sections)
    else:
        content.append(
            Div(
                icon("check-circle", size=48, style="color: #22c55e; margin-bottom: 16px;"),
                H3("Отлично! Нет задач.", style="margin: 0 0 10px 0; font-size: 18px; font-weight: 600; color: #059669;"),
                P("Все задачи выполнены. Новые задачи появятся здесь автоматически.", style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;"),
                style=empty_state_style
            )
        )

    return page_layout("Мои задачи",
        *content,
        session=session,
        current_path="/tasks"
    )


@rt("/dashboard")
def get(session, tab: str = None, status_filter: str = None):
    """
    Unified Dashboard with role-based tabs.

    - Admin/top_manager see all tabs including overview
    - Single-role users see their workspace directly without tabs
    - Multi-role users see relevant tabs
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user.get("id")
    org_id = user.get("org_id")
    supabase = get_supabase()

    # Get user roles
    roles = get_user_role_codes(user_id, org_id) if user_id and org_id else []
    if not roles:
        roles = []

    # Get visible tabs for this user
    visible_tabs = get_dashboard_tabs(roles)
    show_tabs = should_show_dashboard_tabs(roles)

    # Determine active tab
    if not tab:
        tab = get_default_dashboard_tab(roles)

    # Validate that user has access to requested tab
    valid_tab_ids = [t["id"] for t in visible_tabs]
    if tab not in valid_tab_ids:
        # Fallback to default if invalid tab
        tab = get_default_dashboard_tab(roles)

    # Get tab title for page
    tab_titles = {
        "overview": "Обзор",
        "procurement": "Закупки",
        "logistics": "Логистика",
        "customs": "Таможня",
        "quote-control": "Контроль КП",
        "spec-control": "Спецификации",
        "finance": "Финансы",
        "sales": "Продажи",
    }
    page_title = f"Dashboard - {tab_titles.get(tab, tab)}"

    # Build tab content based on active tab
    if tab == "overview":
        content = _dashboard_overview_content(user_id, org_id, roles, user, supabase)
    elif tab == "procurement":
        content = _dashboard_procurement_content(user_id, org_id, supabase, status_filter, roles)
    elif tab == "logistics":
        content = _dashboard_logistics_content(user_id, org_id, supabase, status_filter)
    elif tab == "customs":
        content = _dashboard_customs_content(user_id, org_id, supabase, status_filter)
    elif tab == "quote-control":
        content = _dashboard_quote_control_content(user_id, org_id, supabase, status_filter)
    elif tab == "spec-control":
        content = _dashboard_spec_control_content(user_id, org_id, supabase, status_filter)
    elif tab == "finance":
        content = _dashboard_finance_content(user_id, org_id, supabase)
    elif tab == "sales":
        content = _dashboard_sales_content(user_id, org_id, user, supabase)
    else:
        content = _dashboard_overview_content(user_id, org_id, roles, user, supabase)

    # Build page with or without tabs
    if show_tabs:
        return page_layout(page_title,
            _build_dashboard_tabs_nav(visible_tabs, tab),
            Div(*content, id="tab-content"),
            session=session,
            current_path="/dashboard"
        )
    else:
        # Single workspace user - show content directly without tabs
        return page_layout(page_title,
            *content,
            session=session,
            current_path="/dashboard"
        )


# ============================================================================
# QUOTES LIST
# ============================================================================

def version_badge(quote_id, current_ver, total_count):
    """Render version badge for quotes list. Clickable if multiple versions."""
    if total_count <= 1:
        return Span(f"v{current_ver}", style="color: #94a3b8; font-size: 12px;")

    badge_style = """
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        color: #0369a1;
        border: 1px solid #bae6fd;
        text-decoration: none;
        transition: all 0.2s ease;
    """
    return A(
        f"v{current_ver}",
        Span(f"({total_count})", style="opacity: 0.7; margin-left: 4px;"),
        href=f"/quotes/{quote_id}/versions",
        style=badge_style,
        title="Посмотреть историю версий",
        onclick="event.stopPropagation();"
    )


@rt("/quotes")
def get(session):
    """
    Quotes List page with design system V2 styling.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, customers(name), workflow_status, total_amount, total_profit_usd, created_at, quote_versions!quote_versions_quote_id_fkey(version)") \
        .eq("organization_id", user["org_id"]) \
        .order("created_at", desc=True) \
        .execute()

    quotes = result.data or []

    # Process version data for each quote
    for q in quotes:
        versions = q.get("quote_versions") or []
        q["version_count"] = len(versions)
        q["current_version"] = max([v.get("version", 1) for v in versions]) if versions else 1

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    """

    page_title_style = """
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: -0.02em;
    """

    count_badge_style = """
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
        border: 1px solid #bfdbfe;
    """

    new_btn_style = """
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
    """

    search_input_style = """
        padding: 10px 14px 10px 38px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        color: #1e293b;
        min-width: 280px;
        transition: all 0.2s ease;
    """

    return page_layout("Коммерческие предложения",
        # Header card with title and actions
        Div(
            Div(
                icon("file-text", size=26, style="color: #3b82f6;"),
                H1("Коммерческие предложения", style=page_title_style),
                Span(f"{len(quotes)}", style=count_badge_style),
                style="display: flex; align-items: center; gap: 14px;"
            ),
            Div(
                A(
                    icon("plus", size=16),
                    Span("Новое КП"),
                    href="/quotes/new",
                    style=new_btn_style
                ),
            ),
            style=header_card_style
        ),

        # Enhanced table container with new design system
        Div(
            # Table header with search
            Div(
                Div(
                    icon("search", size=16, style="color: #94a3b8; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);"),
                    Input(
                        type="text",
                        placeholder="Поиск по номеру или клиенту...",
                        id="quotes-search",
                        style=search_input_style
                    ),
                    style="position: relative; display: inline-block;"
                ),
                cls="table-header-left"
            ),
            cls="table-header"
        ),

        # Table content with enhanced styling
        Div(
            Div(
                Table(
                    Thead(Tr(
                        Th("№ КП"),
                        Th("Клиент"),
                        Th("Статус"),
                        Th("Версии", style="text-align: center; width: 80px;"),
                        Th("Сумма", cls="col-money"),
                        Th("Профит", cls="col-money"),
                        Th("Дата"),
                        Th("", cls="col-actions")
                    )),
                    Tbody(
                        *[Tr(
                            Td(A(q.get("idn_quote", f"#{q['id'][:8]}"), href=f"/quotes/{q['id']}")),
                            Td(q.get("customers", {}).get("name", "—") if q.get("customers") else "—"),
                            Td(status_badge_v2(q.get("workflow_status", "draft"))),
                            Td(version_badge(q['id'], q.get('current_version', 1), q.get('version_count', 1)),
                               style="text-align: center;"),
                            Td(format_money(q.get("total_amount")), cls="col-money"),
                            Td(format_money(q.get("total_profit_usd")), cls="col-money",
                               style="color: #059669; font-weight: 500;"),
                            Td(q.get("created_at", "")[:10] if q.get("created_at") else "—"),
                            Td(
                                A(icon("eye", size=16), href=f"/quotes/{q['id']}", cls="table-action-btn", title="Просмотр"),
                                A(icon("pencil", size=16), href=f"/quotes/{q['id']}/edit", cls="table-action-btn", title="Редактировать"),
                                cls="col-actions"
                            ),
                            cls="clickable-row",
                            onclick=f"window.location='/quotes/{q['id']}'"
                        ) for q in quotes]
                    ) if quotes else Tbody(Tr(Td(
                        Div(
                            icon("file-text", size=32, style="color: #94a3b8; margin-bottom: 12px;"),
                            Div("Нет коммерческих предложений", style="font-size: 15px; font-weight: 500; color: #64748b; margin-bottom: 8px;"),
                            Div("Создайте первое КП для начала работы", style="font-size: 13px; color: #94a3b8; margin-bottom: 16px;"),
                            A(
                                icon("plus", size=14),
                                Span("Создать первое КП"),
                                href="/quotes/new",
                                style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; color: #3b82f6; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; text-decoration: none;"
                            ),
                            style="text-align: center; padding: 40px 24px;"
                        ),
                        colspan="8"
                    ))),
                    cls="table-enhanced"
                ),
                cls="table-enhanced-container"
            ),
            cls="table-responsive"
        ),

        # Table footer with count
        Div(
            Span(f"Всего: {len(quotes)} КП", style="font-size: 13px; color: #64748b;"),
            cls="table-footer"
        ) if quotes else None,

        session=session,
        current_path="/quotes"
    )


# ============================================================================
# CUSTOMERS LIST
# ============================================================================

@rt("/customers")
def get(session):
    """
    Customers List page with design system V2 styling.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    result = supabase.table("customers") \
        .select("id, name, email, phone, inn, created_at") \
        .eq("organization_id", user["org_id"]) \
        .order("name") \
        .execute()

    customers = result.data or []

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    """

    page_title_style = """
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: -0.02em;
    """

    count_badge_style = """
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #059669;
        border: 1px solid #a7f3d0;
    """

    new_btn_style = """
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
    """

    search_input_style = """
        padding: 10px 14px 10px 38px;
        font-size: 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        color: #1e293b;
        min-width: 280px;
        transition: all 0.2s ease;
    """

    return page_layout("Клиенты",
        # Header card with title and actions
        Div(
            Div(
                icon("users", size=26, style="color: #10b981;"),
                H1("Клиенты", style=page_title_style),
                Span(f"{len(customers)}", style=count_badge_style),
                style="display: flex; align-items: center; gap: 14px;"
            ),
            Div(
                A(
                    icon("plus", size=16),
                    Span("Новый клиент"),
                    href="/customers/new",
                    style=new_btn_style
                ),
            ),
            style=header_card_style
        ),

        # Enhanced table container
        Div(
            # Table header with search
            Div(
                Div(
                    icon("search", size=16, style="color: #94a3b8; position: absolute; left: 12px; top: 50%; transform: translateY(-50%);"),
                    Input(
                        type="text",
                        placeholder="Поиск по названию, ИНН или email...",
                        id="customers-search",
                        style=search_input_style
                    ),
                    style="position: relative; display: inline-block;"
                ),
                cls="table-header-left"
            ),
            cls="table-header"
        ),

        # Table content
        Div(
            Div(
                Table(
                    Thead(Tr(
                        Th("Название"),
                        Th("ИНН"),
                        Th("Email"),
                        Th("Телефон"),
                        Th("", cls="col-actions")
                    )),
                    Tbody(
                        *[Tr(
                            Td(A(c.get("name", "—"), href=f"/customers/{c['id']}", style="font-weight: 500; color: #3b82f6;")),
                            Td(c.get("inn", "—"), style="font-family: monospace; color: #64748b;"),
                            Td(c.get("email", "—")),
                            Td(c.get("phone", "—")),
                            Td(
                                A(icon("eye", size=16), href=f"/customers/{c['id']}", cls="table-action-btn", title="Просмотр"),
                                cls="col-actions"
                            ),
                            cls="clickable-row",
                            onclick=f"window.location='/customers/{c['id']}'"
                        ) for c in customers]
                    ) if customers else Tbody(Tr(Td(
                        Div(
                            icon("users", size=32, style="color: #94a3b8; margin-bottom: 12px;"),
                            Div("Нет клиентов", style="font-size: 15px; font-weight: 500; color: #64748b; margin-bottom: 8px;"),
                            Div("Добавьте первого клиента для начала работы", style="font-size: 13px; color: #94a3b8; margin-bottom: 16px;"),
                            A(
                                icon("plus", size=14),
                                Span("Добавить клиента"),
                                href="/customers/new",
                                style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; color: #3b82f6; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; text-decoration: none;"
                            ),
                            style="text-align: center; padding: 40px 24px;"
                        ),
                        colspan="5"
                    ))),
                    cls="table-enhanced"
                ),
                cls="table-enhanced-container"
            ),
            cls="table-responsive"
        ),

        # Table footer with count
        Div(
            Span(f"Всего: {len(customers)} клиентов", style="font-size: 13px; color: #64748b;"),
            cls="table-footer"
        ) if customers else None,

        session=session,
        current_path="/customers"
    )


# ============================================================================
# NEW CUSTOMER
# ============================================================================

@rt("/customers/new")
def get(session):
    redirect = require_login(session)
    if redirect:
        return redirect

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    form_card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    return page_layout("Новый клиент",
        # Header card with gradient
        Div(
            Div(
                btn_link("", href="/customers", variant="secondary", icon_name="arrow-left",
                         style="padding: 8px 12px; margin-right: 12px;"),
                Div(
                    icon("user-plus", size=24, color="#475569"),
                    Span(" Новый клиент", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                    style="display: flex; align-items: center;"
                ),
                style="display: flex; align-items: center;"
            ),
            style=header_card_style
        ),

        # Form card
        Div(
            Form(
                # Section: Company info
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span(" ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Название компании *", style=label_style),
                        Input(name="name", required=True, placeholder="ООО Ромашка", style=input_style),
                        style="flex: 2;"
                    ),
                    Div(
                        Label("ИНН", style=label_style),
                        Input(name="inn", placeholder="7701234567", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),

                # Section: Contact info
                Div(
                    icon("phone", size=16, color="#64748b"),
                    Span(" КОНТАКТНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("Email", style=label_style),
                        Input(name="email", type="email", placeholder="info@company.ru", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Телефон", style=label_style),
                        Input(name="phone", placeholder="+7 999 123 4567", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Label("Адрес доставки", style=label_style),
                    Textarea(name="address", placeholder="Адрес доставки товара", rows="3",
                             style=f"{input_style} resize: vertical;"),
                    style="margin-bottom: 24px;"
                ),

                # Actions
                Div(
                    btn("Сохранить клиента", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/customers", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e2e8f0;"
                ),
                method="post",
                action="/customers/new"
            ),
            style=form_card_style
        ),
        session=session
    )


@rt("/customers/new")
def post(name: str, inn: str, email: str, phone: str, address: str, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    try:
        result = supabase.table("customers").insert({
            "name": name,
            "inn": inn or None,
            "email": email or None,
            "phone": phone or None,
            "address": address or None,
            "organization_id": user["org_id"]
        }).execute()

        return RedirectResponse("/customers", status_code=303)

    except Exception as e:
        # Parse Supabase error
        error_str = str(e)

        # Check if it's a duplicate INN error
        if "duplicate key" in error_str and "idx_customers_org_inn" in error_str:
            error_msg = f"Клиент с ИНН '{inn}' уже существует в вашей организации."
        elif "duplicate key" in error_str:
            error_msg = "Такой клиент уже существует."
        else:
            # Try to extract the message from Supabase error format
            if "'message':" in error_str:
                try:
                    import re
                    match = re.search(r"'message': '([^']+)'", error_str)
                    if match:
                        error_msg = f"Ошибка при создании клиента: {match.group(1)}"
                    else:
                        error_msg = f"Ошибка при создании клиента: {error_str}"
                except:
                    error_msg = f"Ошибка при создании клиента: {error_str}"
            else:
                error_msg = f"Ошибка при создании клиента: {error_str}"

        return page_layout("New Customer",
            Div(error_msg, style="background: #fee; border: 1px solid #c33; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;"),
            H1("Add Customer"),
            Div(
                Form(
                    Div(
                        Label("Company Name *", Input(name="name", required=True, placeholder="ООО Ромашка", value=name)),
                        Label("INN", Input(name="inn", placeholder="7701234567", value=inn or "")),
                        cls="form-row"
                    ),
                    Div(
                        Label("Email", Input(name="email", type="email", placeholder="info@company.ru", value=email or "")),
                        Label("Phone", Input(name="phone", placeholder="+7 999 123 4567", value=phone or "")),
                        cls="form-row"
                    ),
                    Label("Address", Textarea(name="address", placeholder="Delivery address", rows="3", value=address or "")),
                    Div(
                        btn("Save Customer", variant="primary", icon_name="check", type="submit"),
                        btn_link("Cancel", href="/customers", variant="secondary"),
                        cls="form-actions"
                    ),
                    method="post",
                    action="/customers/new"
                ),
                cls="card"
            ),
            session=session
        )


# ============================================================================
# NEW QUOTE
# ============================================================================

@rt("/quotes/new")
def get(session):
    """Create a new draft quote immediately and redirect to edit page."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    try:
        # Generate quote number
        count_result = supabase.table("quotes") \
            .select("id", count="exact") \
            .eq("organization_id", user["org_id"]) \
            .execute()

        quote_num = (count_result.count or 0) + 1
        idn_quote = f"Q-{datetime.now().strftime('%Y%m')}-{quote_num:04d}"

        # Create empty draft (customer_id is now nullable)
        insert_data = {
            "idn_quote": idn_quote,
            "title": "Новый КП",
            "customer_id": None,  # Will be selected on detail page
            "organization_id": user["org_id"],
            "currency": "RUB",
            "delivery_terms": "DDP",
            "status": "draft",
            "created_by": user["id"]
        }

        result = supabase.table("quotes").insert(insert_data).execute()
        new_quote = result.data[0]

        # Redirect immediately to edit page
        return RedirectResponse(f"/quotes/{new_quote['id']}", status_code=303)

    except Exception as e:
        return page_layout("Ошибка",
            Div(f"Ошибка создания КП: {str(e)}", cls="alert alert-error"),
            btn_link("Назад к списку КП", href="/quotes", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# QUOTE DETAIL
# ============================================================================

@rt("/quotes/{quote_id}")
def get(quote_id: str, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    # Get quote with customer
    result = supabase.table("quotes") \
        .select("*, customers(name, inn, email)") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not result.data:
        return page_layout("Not Found",
            H1("Quote not found"),
            A("← Back to Quotes", href="/quotes"),
            session=session
        )

    quote = result.data[0]
    customer = quote.get("customers", {})

    # Get customers for dropdown (for inline editing)
    customers_result = supabase.table("customers") \
        .select("id, name, inn") \
        .eq("organization_id", user["org_id"]) \
        .order("name") \
        .execute()
    customers = customers_result.data or []

    # Get seller companies for dropdown
    from services.seller_company_service import get_all_seller_companies
    seller_companies = get_all_seller_companies(organization_id=user["org_id"], is_active=True)

    # Look up creator name from user_profiles
    creator_name = None
    if quote.get("created_by"):
        try:
            creator_result = supabase.table("user_profiles") \
                .select("full_name") \
                .eq("user_id", quote["created_by"]) \
                .limit(1) \
                .execute()
            if creator_result.data and creator_result.data[0].get("full_name"):
                creator_name = creator_result.data[0]["full_name"]
        except Exception:
            pass

    # Get quote items
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    items = items_result.data or []

    # Prepare items data for Handsontable (JSON)
    items_for_handsontable = [
        {
            'id': item.get('id'),
            'row_num': idx + 1,
            'brand': item.get('brand', ''),
            'product_code': item.get('product_code', ''),
            'product_name': item.get('product_name', ''),
            'quantity': item.get('quantity', 1),
            'unit': item.get('unit', 'шт')
        } for idx, item in enumerate(items)
    ]
    items_json = json.dumps(items_for_handsontable)

    workflow_status = quote.get("workflow_status") or quote.get("status", "draft")

    # Check for revision status (returned from quote control)
    revision_department = quote.get("revision_department")
    revision_comment = quote.get("revision_comment")
    is_revision = revision_department == "sales" and workflow_status == "pending_sales_review"

    # Check for justification status (Feature: approval justification workflow)
    needs_justification = quote.get("needs_justification", False)
    approval_reason = quote.get("approval_reason")
    is_justification_needed = needs_justification and workflow_status == "pending_sales_review"

    # Get approval status for multi-department workflow (Bug #8 follow-up)
    approval_status = get_quote_approval_status(quote_id, user["org_id"]) or {}

    # Delivery terms options
    delivery_terms_options = ["DDP", "DAP", "EXW", "FCA", "CPT", "CIP", "FOB", "CIF"]
    delivery_method_options = [
        ("air", "Авиа"),
        ("auto", "Авто"),
        ("sea", "Море"),
        ("multimodal", "Мультимодально")
    ]
    delivery_priority_options = [
        ("fast", "Лучше быстро"),
        ("cheap", "Лучше дешево"),
        ("normal", "Обычно")
    ]

    # Compute created_at display and expiry info
    created_at_display = "—"
    expiry_display = "—"
    is_expired = False
    if quote.get("created_at"):
        try:
            created_dt = datetime.fromisoformat(quote["created_at"].replace("Z", "+00:00"))
            created_at_display = created_dt.strftime("%d.%m.%Y %H:%M")
            validity = quote.get("validity_days") or 30
            expiry_dt = created_dt + timedelta(days=validity)
            expiry_display = expiry_dt.strftime("%d.%m.%Y")
            is_expired = datetime.now(created_dt.tzinfo) > expiry_dt
        except Exception:
            pass

    return page_layout(f"Quote {quote.get('idn_quote', '')}",
        # Compact header with inline editing
        Div(
            # Title row
            Div(
                H2(f"КП {quote.get('idn_quote', '')}", style="margin: 0;"),
                workflow_status_badge(workflow_status),
                style="display: flex; align-items: center; gap: 1rem;"
            ),
            style="margin-bottom: 1rem;"
        ),

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "overview", user.get("roles", [])),

        # Workflow progress bar (same as on procurement/logistics/customs pages)
        workflow_progress_bar(workflow_status),

        # Compact inline-editable details card with gradient styling
        Div(
            # Section header: ДЕТАЛИ КП
            Div(
                icon("file-text", size=16, color="#64748b"),
                Span(" ДЕТАЛИ КП", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),

            # Row 1: Customer and Seller Company
            Div(
                # Customer dropdown
                Div(
                    Label("КЛИЕНТ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Select(
                        Option("Выберите клиента...", value="", selected=(not quote.get("customer_id"))),
                        *[Option(
                            f"{c['name']}" + (f" ({c.get('inn', '')})" if c.get('inn') else ""),
                            value=c["id"],
                            selected=(c["id"] == quote.get("customer_id"))
                        ) for c in customers],
                        name="customer_id",
                        id="inline-customer",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;" + (" border-color: #f59e0b; background: #fffbeb;" if not quote.get("customer_id") else ""),
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "customer_id", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1; min-width: 200px;"
                ),
                # Seller Company dropdown
                Div(
                    Label("ПРОДАВЕЦ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Select(
                        Option("—", value=""),
                        *[Option(
                            f"{sc.supplier_code} - {sc.name}" if sc.supplier_code else sc.name,
                            value=str(sc.id),
                            selected=(str(sc.id) == str(quote.get("seller_company_id") or ""))
                        ) for sc in seller_companies],
                        name="seller_company_id",
                        id="inline-seller",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "seller_company_id", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1; min-width: 200px;"
                ),
                style="display: flex; gap: 1rem; margin-bottom: 1.25rem;"
            ),

            # Section header: ДОСТАВКА
            Div(
                icon("truck", size=16, color="#64748b"),
                Span(" ДОСТАВКА", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),

            # Row 2: Delivery City, Country, Method, Terms (flexbox)
            Div(
                # Delivery City
                Div(
                    Label("ГОРОД", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Input(
                        type="text",
                        value=quote.get("delivery_city") or "",
                        placeholder="Москва",
                        name="delivery_city",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "delivery_city", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 120px; min-width: 120px;"
                ),
                # Delivery Country
                Div(
                    Label("СТРАНА", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Input(
                        type="text",
                        value=quote.get("delivery_country") or "",
                        placeholder="Россия",
                        name="delivery_country",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "delivery_country", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 120px; min-width: 120px;"
                ),
                # Delivery Method
                Div(
                    Label("СПОСОБ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Select(
                        Option("—", value=""),
                        *[Option(label, value=val, selected=(val == quote.get("delivery_method"))) for val, label in delivery_method_options],
                        name="delivery_method",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "delivery_method", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 160px; min-width: 160px;"
                ),
                # Delivery Priority
                Div(
                    Label("ПРИОРИТЕТ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Select(
                        Option("—", value=""),
                        *[Option(label, value=val, selected=(val == quote.get("delivery_priority"))) for val, label in delivery_priority_options],
                        name="delivery_priority",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "delivery_priority", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 160px; min-width: 160px;"
                ),
                # Delivery Terms
                Div(
                    Label("УСЛОВИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Select(
                        *[Option(term, value=term, selected=(term == quote.get("delivery_terms"))) for term in delivery_terms_options],
                        name="delivery_terms",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "delivery_terms", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 100px; min-width: 100px;"
                ),
                style="display: flex; flex-wrap: wrap; gap: 1rem;"
            ),
            # Section header: СРОКИ И ИНФОРМАЦИЯ
            Div(
                icon("clock", size=16, color="#64748b"),
                Span(" СРОКИ И ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-top: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),

            # Row: Created at, Creator, Validity days, Expiry date
            Div(
                # Created at
                Div(
                    Label("ДАТА СОЗДАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Span(
                        created_at_display,
                        style="font-size: 14px; color: #334155; padding: 8px 0; display: block;"
                    ),
                    style="flex: 1 1 140px; min-width: 140px;"
                ),
                # Creator
                Div(
                    Label("СОЗДАЛ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Span(
                        creator_name or "—",
                        style="font-size: 14px; color: #334155; padding: 8px 0; display: block;"
                    ),
                    style="flex: 1 1 160px; min-width: 160px;"
                ),
                # Validity days (inline-editable)
                Div(
                    Label("СРОК ДЕЙСТВИЯ (ДНЕЙ)", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Input(
                        type="number",
                        value=str(quote.get("validity_days") or 30),
                        min="1",
                        name="validity_days",
                        style="width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; box-sizing: border-box; max-width: 120px;",
                        hx_patch=f"/quotes/{quote_id}/inline",
                        hx_trigger="change",
                        hx_vals='js:{field: "validity_days", value: event.target.value}',
                        hx_swap="none"
                    ),
                    style="flex: 1 1 160px; min-width: 160px;"
                ),
                # Expiry date (calculated, with red/green indicator)
                Div(
                    Label("ДЕЙСТВИТЕЛЕН ДО", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem; display: block;"),
                    Span(
                        expiry_display,
                        style=f"font-size: 14px; padding: 6px 10px; border-radius: 6px; display: inline-block; font-weight: 500; {'background: #fef2f2; color: #dc2626;' if is_expired else 'background: #f0fdf4; color: #16a34a;'}" if expiry_display != "\u2014" else "font-size: 14px; color: #334155; padding: 8px 0; display: block;"
                    ),
                    style="flex: 1 1 140px; min-width: 140px;"
                ),
                style="display: flex; flex-wrap: wrap; gap: 1rem;"
            ),
            cls="card", style="padding: 1.25rem; margin-bottom: 1rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Products (Handsontable spreadsheet) with gradient styling
        Div(
            # Section header with icon
            Div(
                Div(
                    icon("package", size=16, color="#64748b"),
                    Span(" ПОЗИЦИИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    Span(id="items-count", style="margin-left: 0.5rem; font-size: 11px; color: #94a3b8;"),
                    style="display: flex; align-items: center;"
                ),
                Div(
                    # Show totals only for non-draft quotes
                    (Span(f"Итого: {format_money(quote.get('total_amount'), quote.get('currency', 'RUB'))}",
                        style="font-weight: 600; color: #1e40af; margin-right: 1rem;") if quote.get('total_amount') and workflow_status != 'draft' else None),
                    Span(id="save-status", style="margin-right: 1rem; font-size: 0.85rem; color: #64748b;"),
                    # Add row button
                    A(icon("plus", size=16), " Добавить", id="btn-add-row", role="button", cls="secondary", style="padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.375rem; margin-right: 0.5rem; text-decoration: none; font-size: 0.8125rem;"),
                    # Import button
                    A(icon("upload", size=16), " Загрузить", id="btn-import", role="button", cls="secondary", style="padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.375rem; margin-right: 0.5rem; text-decoration: none; font-size: 0.8125rem;"),
                    Input(type="file", id="file-import", accept=".xlsx,.xls,.csv", style="display: none;"),
                    # Draft workflow buttons (only for draft status)
                    (A(icon("save", size=16), " Сохранить", id="btn-save-draft", role="button", cls="secondary", style="padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.375rem; margin-right: 0.5rem; text-decoration: none; font-size: 0.8125rem;", onclick="showSaveConfirmation()") if workflow_status == 'draft' else None),
                    (A(icon("send", size=16), " Передать в закупки", id="btn-submit-procurement", role="button", cls="btn-submit-disabled", style="padding: 0.375rem 0.75rem; display: inline-flex; align-items: center; gap: 0.375rem; text-decoration: none; border-radius: 6px; font-size: 0.8125rem;", onclick="submitToProcurement()") if workflow_status == 'draft' else None),
                    style="display: flex; align-items: center; flex-wrap: wrap; gap: 0.25rem;"
                ),
                style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0;"
            ),
            # Handsontable container with enhanced styling
            Div(
                Div(id="items-spreadsheet", style="width: 100%; height: 400px; overflow: hidden;"),
                cls="handsontable-container"
            ),
            # Footer with count
            Div(
                Span(id="footer-count", style="color: #64748b;"),
                style="padding: 0.5rem 1rem; border-top: 1px solid #e2e8f0; font-size: 0.8125rem;"
            ),
            style="margin: 0; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;"
        ),
        # Handsontable initialization script - EXPLICIT SAVE ONLY (no auto-save)
        Script(f"""
            (function() {{
                var quoteId = '{quote_id}';
                var quoteIdn = '{quote.get("idn_quote", "")}';
                var initialData = {items_json};
                var hot = null;
                var hasUnsavedChanges = false;

                function updateCount() {{
                    var count = hot ? hot.countRows() : 0;
                    var el = document.getElementById('items-count');
                    if (el) el.textContent = '(' + count + ')';
                    var footer = document.getElementById('footer-count');
                    if (footer) footer.textContent = 'Всего: ' + count + ' позиций';
                }}

                function showSaveStatus(status) {{
                    var el = document.getElementById('save-status');
                    if (!el) return;
                    if (status === 'saving') {{
                        el.textContent = 'Сохранение...';
                        el.style.color = '#f59e0b';
                    }} else if (status === 'saved') {{
                        el.textContent = 'Сохранено ✓';
                        el.style.color = '#10b981';
                        hasUnsavedChanges = false;
                        setTimeout(function() {{ el.textContent = ''; }}, 2000);
                    }} else if (status === 'error') {{
                        el.textContent = 'Не удалось сохранить';
                        el.style.color = '#ef4444';
                        setTimeout(function() {{ el.textContent = ''; }}, 5000);
                    }}
                }}

                // Bulk save all items - replaces everything in DB
                function saveAllItems() {{
                    // IMPORTANT: Finish any active cell edit before reading data
                    if (hot) hot.deselectCell();
                    var sourceData = hot.getSourceData();
                    var items = sourceData.filter(function(row) {{
                        return row.product_name && row.product_name.trim();
                    }});

                    if (items.length === 0) {{
                        alert('Нет позиций для сохранения');
                        return Promise.resolve(false);
                    }}

                    showSaveStatus('saving');

                    return fetch('/quotes/' + quoteId + '/items/bulk', {{
                        method: 'POST',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify({{ items: items }})
                    }})
                    .then(function(r) {{ return r.json(); }})
                    .then(function(data) {{
                        if (data.success) {{
                            // Update IDs in table data
                            if (data.items) {{
                                var validIdx = 0;
                                for (var i = 0; i < sourceData.length; i++) {{
                                    if (sourceData[i].product_name && sourceData[i].product_name.trim()) {{
                                        if (data.items[validIdx]) {{
                                            sourceData[i].id = data.items[validIdx].id;
                                        }}
                                        validIdx++;
                                    }}
                                }}
                            }}
                            showSaveStatus('saved');
                            return true;
                        }} else {{
                            showSaveStatus('error');
                            alert('Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка'));
                            return false;
                        }}
                    }})
                    .catch(function(e) {{
                        showSaveStatus('error');
                        alert('Ошибка сети: ' + e.message);
                        return false;
                    }});
                }}

                // Make saveAllItems available globally
                window.saveAllItems = saveAllItems;

                // Warn on page leave with unsaved changes
                window.addEventListener('beforeunload', function(e) {{
                    if (hasUnsavedChanges) {{
                        e.preventDefault();
                        e.returnValue = 'Есть несохранённые изменения. Уйти?';
                    }}
                }});

                // Row numbers are assigned on save, not during editing
                function updateRowNumbers() {{
                    updateCount();
                }}

                function initTable() {{
                    var container = document.getElementById('items-spreadsheet');
                    if (!container || typeof Handsontable === 'undefined') return;

                    hot = new Handsontable(container, {{
                        licenseKey: 'non-commercial-and-evaluation',
                        data: initialData.length > 0 ? initialData : [{{row_num: 1, brand: '', product_code: '', product_name: '', quantity: 1, unit: 'шт'}}],
                        colHeaders: ['№', 'Бренд', 'Артикул', 'Наименование', 'Кол-во', 'Ед.изм.'],
                        columns: [
                            {{data: 'row_num', readOnly: true, type: 'numeric', width: 50,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  // Always show visual row number (1-based), regardless of stored value
                                  td.innerHTML = row + 1;
                                  td.style.textAlign = 'center';
                                  td.style.color = '#666';
                                  return td;
                              }}
                            }},
                            {{data: 'brand', type: 'text', width: 120}},
                            {{data: 'product_code', type: 'text', width: 140}},
                            {{data: 'product_name', type: 'text', width: 300}},
                            {{data: 'quantity', type: 'numeric', width: 80}},
                            {{data: 'unit', type: 'dropdown', source: ['шт', 'упак', 'кг', 'м', 'л', 'компл'], width: 80}}
                        ],
                        rowHeaders: false,
                        stretchH: 'all',
                        autoWrapRow: true,
                        autoWrapCol: true,
                        contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'copy', 'cut'],
                        manualColumnResize: true,
                        minSpareRows: 0,
                        afterChange: function(changes, source) {{
                            if (source === 'loadData' || !changes) return;
                            // Mark as having unsaved changes (no auto-save)
                            hasUnsavedChanges = true;
                            updateCount();
                            if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();
                        }},
                        afterCreateRow: function(index, amount, source) {{
                            hasUnsavedChanges = true;
                            updateCount();
                            if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();
                        }},
                        afterRemoveRow: function() {{
                            hasUnsavedChanges = true;
                            updateCount();
                            if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();
                        }},
                        cells: function(row, col) {{
                            var cellProperties = {{}};
                            var rowData = this.instance.getSourceDataAtRow(row);
                            if (rowData && rowData.id) {{
                                cellProperties.title = quoteIdn + '-' + (row + 1);
                            }}
                            return cellProperties;
                        }}
                    }});

                    updateCount();
                    // Make hot available globally for validation
                    window.hot = hot;
                    if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();

                    var btnAdd = document.getElementById('btn-add-row');
                    if (btnAdd) {{
                        btnAdd.addEventListener('click', function() {{
                            // Add empty row - row_num will be assigned on save
                            // The renderer shows visual row index automatically
                            hot.alter('insert_row_below');
                            updateCount();
                            if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();
                        }});
                    }}

                    var btnFileImport = document.getElementById('btn-import');
                    var fileInput = document.getElementById('file-import');
                    if (btnFileImport && fileInput) {{
                        btnFileImport.addEventListener('click', function() {{
                            fileInput.click();
                        }});
                        fileInput.addEventListener('change', function(e) {{
                            var file = e.target.files[0];
                            if (!file) return;
                            var reader = new FileReader();
                            reader.onload = function(evt) {{
                                var data = new Uint8Array(evt.target.result);
                                var workbook = XLSX.read(data, {{type: 'array'}});
                                var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                var jsonData = XLSX.utils.sheet_to_json(firstSheet, {{header: 1}});
                                showFileImportModal(jsonData);
                            }};
                            reader.readAsArrayBuffer(file);
                            e.target.value = '';
                        }});
                    }}

                    window.switchTab = function(tab) {{
                        document.querySelectorAll('.tab-btn').forEach(function(btn) {{ btn.classList.remove('active'); }});
                        var tabBtn = document.getElementById('tab-' + tab);
                        if (tabBtn) tabBtn.classList.add('active');
                    }};
                }}

                function showFileImportModal(jsonData) {{
                    if (jsonData.length < 2) {{
                        alert('Файл пустой или содержит только заголовки');
                        return;
                    }}
                    var headers = jsonData[0];
                    var preview = jsonData.slice(1, 6);

                    function buildOptions(defaultText) {{
                        var opts = '<option value="">' + defaultText + '</option>';
                        for (var i = 0; i < headers.length; i++) {{
                            opts += '<option value="' + i + '">' + (headers[i] || 'Колонка ' + (i+1)) + '</option>';
                        }}
                        return opts;
                    }}

                    function buildPreviewTable() {{
                        var html = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;"><thead><tr style="background:#f3f4f6;">';
                        for (var i = 0; i < headers.length; i++) {{
                            html += '<th style="padding:0.5rem;border:1px solid #e5e7eb;text-align:left;">' + (headers[i] || '—') + '</th>';
                        }}
                        html += '</tr></thead><tbody>';
                        for (var r = 0; r < preview.length; r++) {{
                            html += '<tr>';
                            for (var c = 0; c < headers.length; c++) {{
                                html += '<td style="padding:0.5rem;border:1px solid #e5e7eb;">' + (preview[r][c] || '') + '</td>';
                            }}
                            html += '</tr>';
                        }}
                        html += '</tbody></table>';
                        return html;
                    }}

                    var modal = document.createElement('div');
                    modal.id = 'file-import-modal';
                    modal.innerHTML = '<div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">' +
                        '<div style="background:white;padding:2rem;border-radius:12px;max-width:800px;width:90%;max-height:80vh;overflow:auto;">' +
                        '<h3 style="margin-top:0;">Импорт из файла</h3>' +
                        '<p>Найдено строк: ' + (jsonData.length - 1) + '</p>' +
                        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.5rem;">' +
                        '<div><label>Наименование *</label><select id="map-name" style="width:100%;padding:0.5rem;">' + buildOptions('-- Выберите колонку --') + '</select></div>' +
                        '<div><label>Артикул</label><select id="map-code" style="width:100%;padding:0.5rem;">' + buildOptions('-- Не выбрано --') + '</select></div>' +
                        '<div><label>Бренд</label><select id="map-brand" style="width:100%;padding:0.5rem;">' + buildOptions('-- Не выбрано --') + '</select></div>' +
                        '<div><label>Количество</label><select id="map-qty" style="width:100%;padding:0.5rem;">' + buildOptions('-- По умолчанию 1 --') + '</select></div>' +
                        '</div>' +
                        '<h4>Превью данных:</h4>' +
                        '<div style="overflow-x:auto;margin-bottom:1.5rem;">' + buildPreviewTable() + '</div>' +
                        '<div style="display:flex;gap:1rem;justify-content:flex-end;">' +
                        '<button onclick="closeFileImportModal()" style="padding:0.75rem 1.5rem;border:1px solid #d1d5db;background:white;border-radius:8px;cursor:pointer;">Отмена</button>' +
                        '<button onclick="runFileImport()" style="padding:0.75rem 1.5rem;background:#6366f1;color:white;border:none;border-radius:8px;cursor:pointer;">Импортировать</button>' +
                        '</div></div></div>';
                    document.body.appendChild(modal);

                    headers.forEach(function(h, i) {{
                        var lower = (h || '').toString().toLowerCase();
                        if (lower.indexOf('наименование') >= 0 || lower.indexOf('название') >= 0 || lower.indexOf('name') >= 0) {{
                            document.getElementById('map-name').value = i;
                        }}
                        if (lower.indexOf('артикул') >= 0 || lower.indexOf('код') >= 0 || lower.indexOf('sku') >= 0) {{
                            document.getElementById('map-code').value = i;
                        }}
                        if (lower.indexOf('бренд') >= 0 || lower.indexOf('brand') >= 0) {{
                            document.getElementById('map-brand').value = i;
                        }}
                        if (lower.indexOf('кол') >= 0 || lower.indexOf('qty') >= 0 || lower.indexOf('quantity') >= 0) {{
                            document.getElementById('map-qty').value = i;
                        }}
                    }});

                    window.closeFileImportModal = function() {{
                        var m = document.getElementById('file-import-modal');
                        if (m) m.remove();
                    }};

                    window.runFileImport = function() {{
                        var nameIdx = document.getElementById('map-name').value;
                        if (nameIdx === '') {{
                            alert('Выберите колонку для наименования');
                            return;
                        }}
                        var codeIdx = document.getElementById('map-code').value;
                        var brandIdx = document.getElementById('map-brand').value;
                        var qtyIdx = document.getElementById('map-qty').value;

                        var newItems = [];
                        var currentCount = hot.countRows();
                        for (var i = 1; i < jsonData.length; i++) {{
                            var row = jsonData[i];
                            var name = row[nameIdx];
                            if (!name) continue;
                            newItems.push({{
                                row_num: currentCount + newItems.length,
                                brand: brandIdx !== '' ? (row[brandIdx] || '') : '',
                                product_code: codeIdx !== '' ? (row[codeIdx] || '') : '',
                                product_name: name,
                                quantity: qtyIdx !== '' ? (parseInt(row[qtyIdx]) || 1) : 1,
                                unit: 'шт'
                            }});
                        }}

                        if (newItems.length === 0) {{
                            alert('Нет данных для импорта');
                            return;
                        }}

                        // Add items to table (in memory) - user will click Save to persist
                        var sourceData = hot.getSourceData();
                        var filtered = sourceData.filter(function(r) {{ return r.product_name && r.product_name.trim(); }});
                        hot.loadData(filtered.concat(newItems));
                        hasUnsavedChanges = true;
                        updateCount();
                        closeFileImportModal();
                        alert('Импортировано ' + newItems.length + ' позиций. Нажмите "Сохранить" для сохранения.');
                        if (typeof updateSubmitButtonState === 'function') updateSubmitButtonState();
                    }};
                }}

                if (document.readyState === 'loading') {{
                    document.addEventListener('DOMContentLoaded', initTable);
                }} else {{
                    initTable();
                }}
            }})();
        """),
        # Tab button styles
        Style("""
            .tab-btn {
                padding: 0.75rem 1.5rem;
                border: none;
                background: transparent;
                cursor: pointer;
                font-weight: 500;
                color: #6b7280;
                border-bottom: 2px solid transparent;
                margin-bottom: -2px;
                transition: all 0.2s;
            }
            .tab-btn:hover {
                color: #374151;
            }
            .tab-btn.active {
                color: #4f46e5;
                border-bottom-color: #4f46e5;
            }
            #items-spreadsheet .htCore {
                font-size: 14px;
            }
            #items-spreadsheet th {
                background: #f9fafb !important;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.75rem;
                letter-spacing: 0.05em;
            }
        """),

        # Totals
        Div(
            H3("Totals"),
            Table(
                Tr(Td("Products Subtotal:"), Td(format_money(quote.get("subtotal"), quote.get("currency", "RUB")))),
                Tr(Td("Logistics:"), Td(format_money(quote.get("logistics_total"), quote.get("currency", "RUB")))),
                Tr(Td(Strong("Total:")), Td(Strong(format_money(quote.get("total_amount"), quote.get("currency", "RUB"))))),
            ),
            cls="card"
        ) if quote.get("total_amount") else None,

        # Multi-department approval progress (Bug #8 follow-up)
        Div(
            H3(icon("file-check", size=20), " Прогресс согласования КП", style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"),

            # Progress bar visual with 5 departments
            Div(
                *[Div(
                    Div(dept_name, style="font-weight: 600; font-size: 0.75rem; margin-bottom: 0.25rem;"),
                    Div(
                        icon("check-circle", size=28) if approval_status.get(dept, {}).get('approved') else
                        icon("clock", size=28) if approval_status.get(dept, {}).get('can_approve') else icon("x-circle", size=28),
                        style="color: #10b981;" if approval_status.get(dept, {}).get('approved') else ("color: #f59e0b;" if approval_status.get(dept, {}).get('can_approve') else "color: #9ca3af;")
                    ),
                    style="flex: 1; text-align: center; padding: 0.5rem; border-right: 2px solid #e5e7eb;" if dept != 'control' else "flex: 1; text-align: center; padding: 0.5rem;"
                ) for dept, dept_name in [('procurement', 'Закупки'), ('logistics', 'Логистика'), ('customs', 'Таможня'), ('sales', 'Продажи'), ('control', 'Контроль')]],
                style="display: flex; margin-bottom: 1.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px;"
            ),

            # Department status details
            *[
                Div(
                    # Header with status
                    Div(
                        Span(
                            icon("check-circle", size=18) if dept_status.get('approved') else
                            icon("clock", size=18) if dept_status.get('can_approve') else icon("x-circle", size=18),
                            f" {QUOTE_DEPARTMENT_NAMES[dept]}",
                            style=f"font-weight: 600; font-size: 1.1rem; color: {'#10b981' if dept_status.get('approved') else ('#f59e0b' if dept_status.get('can_approve') else '#9ca3af')}; display: inline-flex; align-items: center; gap: 0.25rem;"
                        ),
                        Span(
                            " - Одобрено" if dept_status.get('approved') else
                            " - Ожидает проверки" if dept_status.get('can_approve') else
                            " - Недоступно",
                            style="color: #059669;" if dept_status.get('approved') else
                            "color: #d97706;" if dept_status.get('can_approve') else "color: #6b7280;"
                        ),
                        style="margin-bottom: 0.75rem;"
                    ),

                    # If approved - show details
                    (Div(
                        P(f"Одобрил: {dept_status.get('approved_by', 'N/A')}", style="margin: 0.25rem 0; font-size: 0.875rem; color: #6b7280;"),
                        P(f"Дата: {dept_status.get('approved_at', '')[:10]}", style="margin: 0.25rem 0; font-size: 0.875rem; color: #6b7280;") if dept_status.get('approved_at') else None,
                        P(f"Комментарий: {dept_status.get('comments')}", style="margin: 0.25rem 0; font-size: 0.875rem;") if dept_status.get('comments') else None,
                    ) if dept_status.get('approved') else None),

                    # If can approve and user has role - show approve form
                    (Div(
                        Form(
                            Input(type="hidden", name="department", value=dept),
                            Textarea(
                                name="comments",
                                placeholder="Комментарий (необязательно)",
                                style="width: 100%; margin-bottom: 0.5rem; min-height: 60px;"
                            ),
                            btn("Одобрить", variant="success", icon_name="check", type="submit"),
                            action=f"/quotes/{quote_id}/approve-department",
                            method="POST"
                        ),
                        style="margin-top: 0.75rem;"
                    ) if dept_status.get('can_approve') and user_can_approve_quote_department(session, dept) else None),

                    # If blocked - show blocking message
                    (P(
                        f"Требуется одобрение: {', '.join([QUOTE_DEPARTMENT_NAMES[d] for d in dept_status.get('blocking_departments', [])])}",
                        style="margin-top: 0.5rem; font-size: 0.875rem; color: #dc2626;"
                    ) if dept_status.get('blocking_departments') and not dept_status.get('approved') else None),

                    cls="card",
                    style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb;"
                )
                for dept, dept_status in [(d, approval_status.get(d, {})) for d in QUOTE_DEPARTMENTS]
            ],

            cls="card",
            style="background: #f0fdf4; border-left: 4px solid #10b981; margin-bottom: 1.5rem;"
        ) if workflow_status in ['pending_review', 'pending_procurement', 'pending_logistics', 'pending_customs', 'pending_sales', 'pending_control', 'pending_spec_control'] and approval_status else None,

        # CSS for submit button states (using high specificity to override Pico)
        Style("""
            a[role="button"].btn-submit-disabled,
            a[role="button"].btn-submit-disabled:hover,
            a.btn-submit-disabled[role="button"],
            #btn-submit-procurement.btn-submit-disabled {
                background: #e5e7eb !important;
                background-color: #e5e7eb !important;
                color: #9ca3af !important;
                border: 1px solid #d1d5db !important;
                pointer-events: none !important;
                cursor: not-allowed !important;
            }
            a[role="button"].btn-submit-enabled,
            a[role="button"].btn-submit-enabled:hover,
            a.btn-submit-enabled[role="button"],
            #btn-submit-procurement.btn-submit-enabled {
                background: #16a34a !important;
                background-color: #16a34a !important;
                color: white !important;
                border: 1px solid #16a34a !important;
                pointer-events: auto !important;
                cursor: pointer !important;
            }
        """) if workflow_status == 'draft' else None,

        # Draft validation script (moved to header buttons)
        Script(f"""
            // Save all items when clicking Save button
            function showSaveConfirmation() {{
                var btn = document.getElementById('btn-save-draft');
                if (!btn) return;
                var originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> Сохранение...';
                btn.style.pointerEvents = 'none';

                // Call global saveAllItems function
                if (typeof window.saveAllItems === 'function') {{
                    window.saveAllItems().then(function(success) {{
                        if (success) {{
                            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Сохранено!';
                            btn.style.background = '#dcfce7';
                            btn.style.borderColor = '#16a34a';
                            btn.style.color = '#16a34a';
                        }} else {{
                            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> Ошибка';
                            btn.style.background = '#fee2e2';
                            btn.style.borderColor = '#ef4444';
                            btn.style.color = '#ef4444';
                        }}
                        btn.style.pointerEvents = '';
                        setTimeout(function() {{
                            btn.innerHTML = originalHTML;
                            btn.style.background = '';
                            btn.style.borderColor = '';
                            btn.style.color = '';
                        }}, 2000);
                    }});
                }} else {{
                    btn.innerHTML = originalHTML;
                    btn.style.pointerEvents = '';
                    alert('Таблица не загружена');
                }}
            }}

            // Validation for submit to procurement
            function validateForProcurement() {{
                var errors = [];

                // Check header fields
                var customer = document.getElementById('inline-customer');
                if (!customer || !customer.value) errors.push('Клиент');

                var seller = document.getElementById('inline-seller');
                if (!seller || !seller.value) errors.push('Продавец');

                var city = document.querySelector('input[name="delivery_city"]');
                if (!city || !city.value.trim()) errors.push('Город доставки');

                var country = document.querySelector('input[name="delivery_country"]');
                if (!country || !country.value.trim()) errors.push('Страна');

                var method = document.querySelector('select[name="delivery_method"]');
                if (!method || !method.value) errors.push('Способ доставки');

                var terms = document.querySelector('select[name="delivery_terms"]');
                if (!terms || !terms.value) errors.push('Условия поставки');

                // Check items in Handsontable
                if (typeof hot !== 'undefined' && hot) {{
                    var data = hot.getSourceData();
                    var validItems = 0;
                    for (var i = 0; i < data.length; i++) {{
                        var row = data[i];
                        if (row && row.product_name && row.product_name.trim() &&
                            row.quantity && !isNaN(row.quantity) && row.quantity > 0 &&
                            row.unit && row.unit.trim()) {{
                            validItems++;
                        }}
                    }}
                    if (validItems === 0) {{
                        errors.push('Хотя бы одна позиция (наименование, количество, ед.изм.)');
                    }}
                }} else {{
                    errors.push('Позиции не загружены');
                }}

                return errors;
            }}

            // Update submit button state based on validation
            function updateSubmitButtonState() {{
                var btn = document.getElementById('btn-submit-procurement');
                if (!btn) return;

                var errors = validateForProcurement();
                if (errors.length === 0) {{
                    btn.classList.remove('btn-submit-disabled');
                    btn.classList.add('btn-submit-enabled');
                    btn.title = 'Передать КП в отдел закупок';
                }} else {{
                    btn.classList.remove('btn-submit-enabled');
                    btn.classList.add('btn-submit-disabled');
                    btn.title = 'Заполните: ' + errors.join(', ');
                }}
            }}

            // Submit to procurement with validation - saves first, then submits
            function submitToProcurement() {{
                var errors = validateForProcurement();
                if (errors.length > 0) {{
                    alert('Заполните обязательные поля:\\n- ' + errors.join('\\n- '));
                    return false;
                }}

                var btn = document.getElementById('btn-submit-procurement');
                if (btn) {{
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg> Сохранение...';
                    btn.style.pointerEvents = 'none';
                }}

                // First save all items, then submit
                if (typeof window.saveAllItems === 'function') {{
                    window.saveAllItems().then(function(saved) {{
                        if (saved) {{
                            // Now submit via POST
                            var form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '/quotes/{quote_id}/submit-procurement';
                            document.body.appendChild(form);
                            form.submit();
                        }} else {{
                            if (btn) {{
                                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg> Передать в закупки';
                                btn.style.pointerEvents = '';
                            }}
                        }}
                    }});
                }} else {{
                    alert('Таблица не загружена');
                    if (btn) btn.style.pointerEvents = '';
                }}
                return true;
            }}

            // Run validation on page load and on changes
            document.addEventListener('DOMContentLoaded', function() {{
                updateSubmitButtonState();

                // Listen for changes to update button state
                document.querySelectorAll('input, select').forEach(function(el) {{
                    el.addEventListener('change', updateSubmitButtonState);
                }});
            }});

            // Also update after Handsontable changes
            window.updateSubmitButtonState = updateSubmitButtonState;
        """) if workflow_status == "draft" else None,

        # Revision banner for sales (Feature: multi-department return)
        Div(
            Div(
                Span("↩ Возвращено на доработку", style="font-weight: 600; font-size: 1.1rem;"),
                style="margin-bottom: 0.5rem;"
            ),
            Div(
                Span("Комментарий контроллёра КП:", style="font-weight: 500;"),
                P(revision_comment, style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap;"),
                style="margin-bottom: 1rem;"
            ) if revision_comment else None,
            P("После внесения исправлений верните КП на проверку.", style="margin: 0; font-size: 0.875rem;"),
            cls="card",
            style="background: #fef3c7; border: 2px solid #f59e0b; margin-bottom: 1rem;"
        ) if is_revision else None,

        # Justification banner (Feature: approval justification workflow)
        Div(
            Div(
                Span("📝 Требуется обоснование для согласования", style="font-weight: 600; font-size: 1.1rem;"),
                style="margin-bottom: 0.5rem;"
            ),
            Div(
                Span("Причина согласования (от контроллёра КП):", style="font-weight: 500;"),
                P(approval_reason, style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap;"),
                style="margin-bottom: 1rem;"
            ) if approval_reason else None,
            P("Укажите бизнес-обоснование для согласования этого КП топ-менеджером.", style="margin: 0; font-size: 0.875rem;"),
            cls="card",
            style="background: #dbeafe; border: 2px solid #3b82f6; margin-bottom: 1rem;"
        ) if is_justification_needed else None,

        # Workflow Actions (for pending_sales_review - submit for Quote Control, return after revision, or submit justification)
        Div(
            H3("Workflow"),
            # Justification flow: Submit justification for approval (Feature: approval justification workflow)
            Div(
                btn_link("Отправить обоснование", href=f"/quotes/{quote_id}/submit-justification", variant="primary", icon_name="check", size="lg"),
                P("Заполнить обоснование и отправить на согласование топ-менеджеру.", style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;"),
            ) if is_justification_needed else None,
            # Normal flow: Submit for Quote Control
            Form(
                btn("Submit for Quote Control", variant="primary", icon_name="file-text", size="lg", type="submit"),
                P("Send calculated quote to Zhanna for validation review.", style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;"),
                method="post",
                action=f"/quotes/{quote_id}/submit-quote-control"
            ) if not is_revision and not is_justification_needed else None,
            # Revision flow: Return to Quote Control with comment
            Div(
                btn_link("Вернуть на проверку", href=f"/quotes/{quote_id}/return-to-control", variant="success", icon_name="check", size="lg"),
                P("Отправить КП контроллёру после исправлений.", style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;"),
            ) if is_revision else None,
            cls="card", style="border-left: 4px solid #3b82f6;" if is_justification_needed else ("border-left: 4px solid #ec4899;" if not is_revision else "border-left: 4px solid #22c55e;")
        ) if workflow_status == "pending_sales_review" else None,

        # Workflow Actions (for pending_approval - Top Manager approval)
        Div(
            H3(icon("clock", size=20), " Согласование", cls="card-header"),
            P("Этот КП требует вашего одобрения.", style="margin-bottom: 1rem;"),

            # Show approval context (approval_reason from controller, approval_justification from sales)
            Div(
                Div(
                    Span("📋 Причина согласования (от контроллёра):", style="font-weight: 500;"),
                    P(approval_reason, style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap; background: #fef3c7; padding: 0.5rem; border-radius: 4px;"),
                    style="margin-bottom: 0.75rem;"
                ) if approval_reason else None,
                Div(
                    Span("💼 Обоснование менеджера:", style="font-weight: 500;"),
                    P(quote.get("approval_justification", ""), style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap; background: #dbeafe; padding: 0.5rem; border-radius: 4px;"),
                    style="margin-bottom: 1rem;"
                ) if quote.get("approval_justification") else None,
                style="margin-bottom: 1rem;"
            ) if approval_reason or quote.get("approval_justification") else None,

            Form(
                Div(
                    Label("Комментарий (необязательно):", for_="approval_comment"),
                    Input(type="text", name="comment", id="approval_comment",
                          placeholder="Ваш комментарий...", style="width: 100%; margin-bottom: 1rem;"),
                ),
                Div(
                    btn("Одобрить", variant="success", icon_name="check", type="submit", name="action", value="approve"),
                    btn("Отклонить", variant="danger", icon_name="x", type="submit", name="action", value="reject", cls="ml-3"),
                    btn_link("На доработку", href=f"/quotes/{quote_id}/approval-return", variant="secondary", icon_name="arrow-left", cls="ml-3"),
                    style="display: flex; gap: 0.75rem; flex-wrap: wrap;"
                ),
                method="post",
                action=f"/quotes/{quote_id}/manager-decision"
            ),
            cls="card", style="border-left: 4px solid #f59e0b;"
        ) if workflow_status == "pending_approval" and user_has_any_role(session, ["top_manager", "admin"]) else None,

        # Workflow Actions (for approved quotes - Send to Client)
        Div(
            H3("Отправить клиенту"),
            Form(
                Div(
                    Label("Email получателя", fr="sent_to_email", style="font-weight: 500;"),
                    Input(
                        type="email",
                        name="sent_to_email",
                        placeholder="client@company.com",
                        value=customer.get("email", "") if customer else "",
                        style="width: 100%; margin-top: 0.25rem;",
                        required=True
                    ),
                    style="margin-bottom: 1rem;"
                ),
                btn("Отправлено клиенту", variant="primary", icon_name="send", size="lg", type="submit"),
                P("Отметить КП как отправленное клиенту.", style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;"),
                method="post",
                action=f"/quotes/{quote_id}/send-to-client"
            ),
            cls="card", style="border-left: 4px solid #0891b2;"
        ) if workflow_status == "approved" and user_has_any_role(session, ["sales", "admin"]) else None,

        # Workflow Actions (for sent_to_client - Client Response)
        Div(
            H3(icon("message-circle", size=20), " Ответ клиента", style="display: flex; align-items: center; gap: 0.5rem;"),
            P("КП отправлено клиенту. Какой результат?", style="margin-bottom: 1rem; color: #666;"),
            Div(
                Form(
                    btn("Клиент согласен → Спецификация", variant="success", icon_name="check", type="submit"),
                    method="post",
                    action=f"/quotes/{quote_id}/submit-spec-control",
                    style="display: inline;"
                ),
                style="margin-bottom: 1rem;"
            ),
            cls="card", style="border-left: 4px solid #14b8a6;"
        ) if workflow_status == "sent_to_client" and user_has_any_role(session, ["sales", "admin"]) else None,

        # Client Change Request Section (for sent_to_client)
        Div(
            H3(icon("rotate-ccw", size=20), " Клиент просит изменения", style="display: flex; align-items: center; gap: 0.5rem;"),
            P("Выберите тип изменений:", style="margin-bottom: 1rem; color: #666;"),
            Form(
                Div(
                    # Change type radio buttons
                    Div(
                        Input(type="radio", name="change_type", value="add_item", id="change_add_item", required=True),
                        Label(" Добавить позицию → Закупка", fr="change_add_item", style="margin-left: 0.25rem;"),
                        style="margin-bottom: 0.5rem;"
                    ),
                    Div(
                        Input(type="radio", name="change_type", value="logistics", id="change_logistics"),
                        Label(" Изменить логистику → Логистика", fr="change_logistics", style="margin-left: 0.25rem;"),
                        style="margin-bottom: 0.5rem;"
                    ),
                    Div(
                        Input(type="radio", name="change_type", value="price", id="change_price"),
                        Label(" Изменить цену → Расчёт", fr="change_price", style="margin-left: 0.25rem;"),
                        style="margin-bottom: 0.5rem;"
                    ),
                    Div(
                        Input(type="radio", name="change_type", value="full", id="change_full"),
                        Label(" Полный пересчёт → Начало", fr="change_full", style="margin-left: 0.25rem;"),
                        style="margin-bottom: 1rem;"
                    ),
                    style="margin-bottom: 1rem;"
                ),
                # Client comment
                Div(
                    Label("Комментарий клиента:", fr="client_comment", style="font-weight: 500;"),
                    Textarea(name="client_comment", id="client_comment", placeholder="Опишите, что именно хочет изменить клиент...",
                             rows="3", style="width: 100%; margin-top: 0.25rem;"),
                    style="margin-bottom: 1rem;"
                ),
                Div(
                    btn("Отправить на доработку", variant="secondary", icon_name="rotate-ccw", size="lg", type="submit"),
                ),
                method="post",
                action=f"/quotes/{quote_id}/client-change-request"
            ),
            cls="card", style="border-left: 4px solid #f59e0b;"
        ) if workflow_status == "sent_to_client" and user_has_any_role(session, ["sales", "admin"]) else None,

        # Client Rejected Section (for sent_to_client)
        Div(
            H3(icon("x-circle", size=20), " Клиент отказался", style="display: flex; align-items: center; gap: 0.5rem; color: #dc2626;"),
            Form(
                Div(
                    Label("Причина отказа *", fr="rejection_reason", style="font-weight: 500;"),
                    Select(
                        Option("-- Выберите причину --", value="", disabled=True, selected=True),
                        Option("Цена слишком высокая", value="price_too_high"),
                        Option("Сроки не устраивают", value="delivery_time"),
                        Option("Выбрали другого поставщика", value="competitor"),
                        Option("Проект отменён / заморожен", value="project_cancelled"),
                        Option("Нет бюджета", value="no_budget"),
                        Option("Изменились требования", value="requirements_changed"),
                        Option("Другое", value="other"),
                        name="rejection_reason",
                        id="rejection_reason",
                        required=True,
                        style="width: 100%; margin-top: 0.25rem;"
                    ),
                    style="margin-bottom: 1rem;"
                ),
                Div(
                    Label("Комментарий:", fr="rejection_comment", style="font-weight: 500;"),
                    Textarea(name="rejection_comment", id="rejection_comment",
                             placeholder="Дополнительные детали об отказе...",
                             rows="2", style="width: 100%; margin-top: 0.25rem;"),
                    style="margin-bottom: 1rem;"
                ),
                btn("Отметить как отказ", variant="danger", icon_name="x", type="submit"),
                method="post",
                action=f"/quotes/{quote_id}/client-rejected"
            ),
            cls="card", style="border-left: 4px solid #dc2626;"
        ) if workflow_status == "sent_to_client" and user_has_any_role(session, ["sales", "admin"]) else None,

        # Actions section (only for non-draft quotes - after calculation)
        Div(
            H3("Actions"),
            Div(
                btn_link("Calculate", href=f"/quotes/{quote_id}/calculate", variant="primary", icon_name="calculator"),
                btn_link("Version History", href=f"/quotes/{quote_id}/versions", variant="secondary", icon_name="history"),
                style="display: flex; gap: 0.5rem;"
            ),
            H4("Export", style="margin-top: 1rem;"),
            Div(
                btn_link("Specification PDF", href=f"/quotes/{quote_id}/export/specification", variant="secondary", icon_name="file-text"),
                btn_link("Invoice PDF", href=f"/quotes/{quote_id}/export/invoice", variant="secondary", icon_name="file-text"),
                btn_link("Validation Excel", href=f"/quotes/{quote_id}/export/validation", variant="secondary", icon_name="table"),
                style="display: flex; gap: 0.5rem; flex-wrap: wrap;"
            ),
            cls="card"
        ) if workflow_status != "draft" else None,

        # Delete quote button (soft delete)
        Div(
            Div(
                btn_link("Назад", href="/quotes", variant="secondary", icon_name="arrow-left"),
                btn("Удалить КП", variant="danger", icon_name="trash-2", id="btn-delete-quote", onclick="showDeleteModal()", cls="ml-auto"),
                style="display: flex; align-items: center; gap: 1rem;"
            ),
            style="margin-top: 1rem;"
        ),

        # Delete confirmation modal
        Script(f"""
            function showDeleteModal() {{
                const modal = document.createElement('div');
                modal.id = 'delete-modal';
                modal.innerHTML = `
                    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 400px; width: 90%;">
                            <h3 style="margin-top: 0; color: #dc2626;">Удалить КП?</h3>
                            <p>КП будет отмечен как отменённый. Это действие можно отменить.</p>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                                <button onclick="document.getElementById('delete-modal').remove()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer;">Отмена</button>
                                <button onclick="deleteQuote()" style="padding: 0.75rem 1.5rem; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer;">Удалить</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }}

            function deleteQuote() {{
                fetch('/quotes/{quote_id}/cancel', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }}
                }})
                .then(r => r.json())
                .then(data => {{
                    if (data.success) {{
                        window.location.href = data.redirect || '/quotes';
                    }} else {{
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                        document.getElementById('delete-modal').remove();
                    }}
                }})
                .catch(err => {{
                    alert('Ошибка: ' + err.message);
                    document.getElementById('delete-modal').remove();
                }});
            }}
        """),
        session=session
    )


# ============================================================================
# SUBMIT QUOTE FOR PROCUREMENT
# ============================================================================

@rt("/quotes/{quote_id}/submit-procurement")
def post(quote_id: str, session):
    """Submit a draft quote for procurement evaluation."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    # Use the workflow service to transition to pending_procurement
    result = transition_to_pending_procurement(
        quote_id=quote_id,
        actor_id=user["id"],
        actor_roles=user_roles,
        comment="Submitted by sales for procurement evaluation"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error submitting quote: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# SUBMIT QUOTE FOR QUOTE CONTROL
# ============================================================================

@rt("/quotes/{quote_id}/submit-quote-control")
def post(quote_id: str, session):
    """Submit a quote from pending_sales_review to pending_quote_control."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    # Use the workflow service to transition to pending_quote_control
    result = transition_quote_status(
        quote_id=quote_id,
        to_status="pending_quote_control",
        actor_id=user["id"],
        actor_roles=user_roles,
        comment="Submitted by sales for quote control review"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error submitting quote: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# SALES - RETURN TO QUOTE CONTROL AFTER REVISION (Feature: multi-department return)
# ============================================================================

@rt("/quotes/{quote_id}/return-to-control")
def get(quote_id: str, session):
    """
    Form for sales to return a revised quote back to quote control.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["sales", "sales_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data
    workflow_status = quote.get("workflow_status", "draft")
    revision_comment = quote.get("revision_comment", "")
    idn_quote = quote.get("idn_quote", f"#{quote_id[:8]}")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    if workflow_status != "pending_sales_review":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}»."),
            A("← Назад", href=f"/quotes/{quote_id}"),
            session=session
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    comment_box_style = """
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        padding: 16px;
        border-radius: 0 8px 8px 0;
        margin-bottom: 24px;
    """

    textarea_style = """
        width: 100%;
        min-height: 120px;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
    """

    return page_layout(f"Вернуть на проверку - {idn_quote}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), f" Назад к КП {idn_quote}", href=f"/quotes/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1("Вернуть КП на проверку",
               style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            Div(
                icon("users", size=14, style="color: #64748b;"),
                Span(f"Клиент: {customer_name}", style="color: #475569;"),
                style="display: flex; align-items: center; gap: 8px; font-size: 14px;"
            ),
            style=header_style
        ),

        # Original comment (if present)
        Div(
            Div(icon("message-circle", size=14), " Исходный комментарий контроллёра", style=section_header_style),
            P(revision_comment if revision_comment else "— нет комментария —",
              style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.5;"),
            style=comment_box_style
        ) if revision_comment else None,

        # Form
        Form(
            Div(
                Div(icon("edit-3", size=14), " Комментарий об исправлениях *", style=section_header_style),
                P("Опишите, какие исправления были внесены:",
                  style="color: #64748b; font-size: 13px; margin: 0 0 12px 0;"),
                Textarea(
                    name="comment",
                    placeholder="Исправлена наценка...\nОбновлены условия оплаты...\nИзменены данные клиента...",
                    required=True,
                    style=textarea_style
                ),
                style="margin-bottom: 24px;"
            ),
            Div(
                Button(icon("check", size=14), " Вернуть на проверку", type="submit",
                       style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                A(icon("x", size=14), " Отмена", href=f"/quotes/{quote_id}",
                  style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
                style="display: flex; gap: 12px;"
            ),
            action=f"/quotes/{quote_id}/return-to-control",
            method="post",
            style=form_card_style
        ),
        session=session
    )


@rt("/quotes/{quote_id}/return-to-control")
def post(quote_id: str, session, comment: str = ""):
    """
    Handle return to quote control from sales.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["sales", "sales_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка"),
            P("Необходимо указать комментарий об исправлениях."),
            A("← Вернуться", href=f"/quotes/{quote_id}/return-to-control"),
            session=session
        )

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("workflow_status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    current_status = quote_result.data[0].get("workflow_status", "draft")

    if current_status != "pending_sales_review":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}»."),
            A("← Назад", href=f"/quotes/{quote_id}"),
            session=session
        )

    user_roles = get_user_roles_from_session(session)
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.PENDING_QUOTE_CONTROL,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"Исправления от продаж: {comment.strip()}"
    )

    if result.success:
        supabase.table("quotes").update({
            "revision_department": None,
            "revision_comment": None,
            "revision_returned_at": None
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на проверку"),
            P("КП отправлено контроллёру КП для повторной проверки."),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось вернуть КП: {result.error_message}"),
            A("← Назад", href=f"/quotes/{quote_id}/return-to-control"),
            session=session
        )


# ============================================================================
# SUBMIT JUSTIFICATION (Feature: approval justification workflow)
# ============================================================================

@rt("/quotes/{quote_id}/submit-justification")
def get(session, quote_id: str):
    """
    Justification form - sales manager provides business case for approval.

    Feature: Approval justification workflow (Variant B)
    - Controller specifies why approval is needed (approval_reason)
    - Sales manager provides business justification (approval_justification)
    - Then quote goes to top manager with full context
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has sales role
    if not user_has_any_role(session, ["sales", "sales_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")
    needs_justification = quote.get("needs_justification", False)
    approval_reason = quote.get("approval_reason", "")

    # Check if quote is in correct status and needs justification
    if workflow_status != "pending_sales_review" or not needs_justification:
        return page_layout("Обоснование не требуется",
            H1("Обоснование не требуется"),
            P("Это КП не требует обоснования для согласования."),
            A("← Вернуться к КП", href=f"/quotes/{quote_id}"),
            session=session
        )

    idn_quote = quote.get("idn_quote", "")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    return page_layout(f"Обоснование - {idn_quote}",
        # Header
        Div(
            A("← Вернуться к КП", href=f"/quotes/{quote_id}", style="color: #3b82f6; text-decoration: none;"),
            H1(icon("file-text", size=28), f" Обоснование для согласования {idn_quote}", cls="page-header"),
            P(f"Клиент: {customer_name}", style="color: #666;"),
            style="margin-bottom: 1rem;"
        ),

        # Approval reason from controller
        Div(
            H3("Причина согласования (от контроллёра КП)"),
            P(approval_reason, style="font-style: italic; white-space: pre-wrap; background: #f3f4f6; padding: 1rem; border-radius: 6px;"),
            cls="card",
            style="margin-bottom: 1rem; background: #fef3c7;"
        ) if approval_reason else None,

        # Form
        Form(
            Div(
                H3("Ваше обоснование", style="margin-bottom: 0.5rem;"),
                P("Объясните, почему эта сделка важна для компании и почему предложенные условия обоснованы.",
                  style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;"),
                Textarea(
                    name="justification",
                    id="justification",
                    placeholder="Укажите бизнес-обоснование...\n\nНапример:\n- Стратегический клиент с большим потенциалом\n- Первая сделка для входа в новый сегмент\n- Конкурентная ситуация требует гибкости по цене",
                    required=True,
                    style="width: 100%; min-height: 200px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; resize: vertical;"
                ),
                style="margin-bottom: 1rem;"
            ),

            # Action buttons
            Div(
                btn("Отправить на согласование", variant="primary", icon_name="send", type="submit"),
                btn_link("Отмена", href=f"/quotes/{quote_id}", variant="ghost"),
                style="display: flex; align-items: center; gap: 1rem;"
            ),

            action=f"/quotes/{quote_id}/submit-justification",
            method="post",
            cls="card"
        ),

        session=session
    )


@rt("/quotes/{quote_id}/submit-justification")
def post(session, quote_id: str, justification: str = ""):
    """
    Handle justification form submission.

    1. Validate justification is provided
    2. Save approval_justification
    3. Clear needs_justification flag
    4. Call request_approval to send to top manager
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has sales role
    if not user_has_any_role(session, ["sales", "sales_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Validate justification
    if not justification or not justification.strip():
        return page_layout("Ошибка",
            H1("Ошибка отправки"),
            P("Необходимо указать обоснование для согласования."),
            A("← Вернуться к форме", href=f"/quotes/{quote_id}/submit-justification"),
            session=session
        )

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("workflow_status, needs_justification, idn_quote, total_amount, currency, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")
    needs_justification = quote.get("needs_justification", False)
    idn_quote = quote.get("idn_quote", "")
    customer_name = quote.get("customers", {}).get("name", "") if quote.get("customers") else ""
    total_amount = quote.get("total_amount")

    # Verify quote is in correct status
    if workflow_status != "pending_sales_review" or not needs_justification:
        return page_layout("Ошибка",
            H1("Обоснование не требуется"),
            P("Это КП не находится в статусе ожидания обоснования."),
            A("← Вернуться к КП", href=f"/quotes/{quote_id}"),
            session=session
        )

    # Save justification and clear flag
    supabase.table("quotes").update({
        "approval_justification": justification.strip(),
        "needs_justification": False
    }).eq("id", quote_id).execute()

    # Get user's role codes for transition
    user_roles = get_user_roles_from_session(session)

    # Transition directly from pending_sales_review to pending_approval
    # (using new transition added for justification workflow)
    from services.workflow_service import transition_quote_status, WorkflowStatus
    from services.approval_service import create_approvals_for_role
    from services.telegram_service import send_approval_notification_for_quote
    import asyncio

    transition_result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.PENDING_APPROVAL,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"[С обоснованием] {justification.strip()[:200]}..."
    )

    if not transition_result.success:
        return page_layout("Ошибка",
            H1("Ошибка отправки"),
            P(f"Не удалось отправить КП на согласование: {transition_result.error_message}"),
            A("← Вернуться к форме", href=f"/quotes/{quote_id}/submit-justification"),
            session=session
        )

    # Create approval records for top_manager/admin users
    approvals = create_approvals_for_role(
        quote_id=quote_id,
        organization_id=org_id,
        requested_by=user_id,
        reason=f"[С обоснованием менеджера] {justification.strip()[:200]}...",
        role_codes=['top_manager', 'admin'],
        approval_type='top_manager'
    )
    approvals_created = len(approvals)

    # Send Telegram notifications
    notifications_sent = 0
    if approvals_created > 0:
        try:
            try:
                loop = asyncio.get_event_loop()
            except RuntimeError:
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)

            notification_result = loop.run_until_complete(
                send_approval_notification_for_quote(
                    quote_id=quote_id,
                    approval_reason=f"[С обоснованием менеджера] {justification.strip()[:100]}...",
                    requester_id=user_id
                )
            )
            notifications_sent = notification_result.get('telegram_sent', 0)
        except Exception as e:
            print(f"Error sending approval notifications: {e}")

    details = []
    if approvals_created > 0:
        details.append(P(f"Создано запросов на согласование: {approvals_created}"))
    if notifications_sent > 0:
        details.append(P(f"Отправлено уведомлений в Telegram: {notifications_sent}"))

    return page_layout("Успешно",
        H1(icon("check", size=28), " КП отправлено на согласование", cls="page-header"),
        P(f"КП {idn_quote} с вашим обоснованием отправлено на согласование топ-менеджеру."),
        *details,
        P("Вы получите уведомление о решении.", style="color: #666;"),
        btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
        session=session
    )


# ============================================================================
# MANAGER APPROVAL/REJECTION
# ============================================================================

@rt("/quotes/{quote_id}/manager-decision")
def post(quote_id: str, session, action: str = "", comment: str = ""):
    """Top manager approves or rejects a quote."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    # Check role
    if not user_has_any_role(session, ["top_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    if action == "approve":
        to_status = "approved"
        comment = comment or "Одобрено топ-менеджером"
    elif action == "reject":
        to_status = "rejected"
        if not comment:
            return page_layout("Error",
                Div("Для отклонения необходимо указать причину.", cls="alert alert-error"),
                A("← Back to Quote", href=f"/quotes/{quote_id}"),
                session=session
            )
    else:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)

    # Use the workflow service to transition
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=to_status,
        actor_id=user["id"],
        actor_roles=user_roles,
        comment=comment
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# TOP MANAGER - RETURN FOR REVISION (Feature: multi-department return)
# ============================================================================

@rt("/quotes/{quote_id}/approval-return")
def get(session, quote_id: str):
    """
    Return for revision form for top manager.
    Similar to quote controller's return form - can return to any department.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has top_manager role
    if not user_has_any_role(session, ["top_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is in pending_approval status
    if workflow_status != "pending_approval":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП не находится в статусе ожидания согласования."),
            A("← Вернуться к КП", href=f"/quotes/{quote_id}"),
            session=session
        )

    idn_quote = quote.get("idn_quote", "")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    return page_layout(f"Возврат на доработку - {idn_quote}",
        # Header
        Div(
            A("← Вернуться к КП", href=f"/quotes/{quote_id}", style="color: #3b82f6; text-decoration: none;"),
            H1(icon("arrow-left", size=28), f" Возврат КП {idn_quote} на доработку", cls="page-header"),
            P(f"Клиент: {customer_name}", style="color: #666;"),
            style="margin-bottom: 1rem;"
        ),

        # Department selection form
        Form(
            Div(
                H3("Выберите отдел для доработки", style="margin-bottom: 1rem;"),
                Div(
                    Input(type="radio", name="department", value="quote_control", id="dept_control", checked=True),
                    Label(" Контроль КП", for_="dept_control"),
                    style="margin-bottom: 0.5rem;"
                ),
                Div(
                    Input(type="radio", name="department", value="sales", id="dept_sales"),
                    Label(" Продажи", for_="dept_sales"),
                    style="margin-bottom: 0.5rem;"
                ),
                Div(
                    Input(type="radio", name="department", value="procurement", id="dept_procurement"),
                    Label(" Закупки", for_="dept_procurement"),
                    style="margin-bottom: 0.5rem;"
                ),
                Div(
                    Input(type="radio", name="department", value="logistics", id="dept_logistics"),
                    Label(" Логистика", for_="dept_logistics"),
                    style="margin-bottom: 0.5rem;"
                ),
                Div(
                    Input(type="radio", name="department", value="customs", id="dept_customs"),
                    Label(" Таможня", for_="dept_customs"),
                    style="margin-bottom: 1rem;"
                ),
                style="margin-bottom: 1rem;"
            ),

            Div(
                H3("Комментарий", style="margin-bottom: 0.5rem;"),
                P("Укажите, что необходимо исправить.", style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;"),
                Textarea(
                    name="comment",
                    id="comment",
                    placeholder="Укажите, что необходимо исправить...",
                    required=True,
                    style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; resize: vertical;"
                ),
                style="margin-bottom: 1rem;"
            ),

            # Action buttons
            Div(
                btn("Вернуть на доработку", variant="secondary", icon_name="arrow-left", type="submit"),
                btn_link("Отмена", href=f"/quotes/{quote_id}", variant="ghost"),
                style="display: flex; align-items: center; gap: 1rem;"
            ),

            action=f"/quotes/{quote_id}/approval-return",
            method="post",
            cls="card"
        ),

        session=session
    )


@rt("/quotes/{quote_id}/approval-return")
def post(session, quote_id: str, department: str = "quote_control", comment: str = ""):
    """
    Handle return for revision from top manager.
    Routes to the selected department with revision tracking.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has top_manager role
    if not user_has_any_role(session, ["top_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Validate comment
    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка"),
            P("Необходимо указать комментарий с описанием необходимых исправлений."),
            A("← Вернуться к форме", href=f"/quotes/{quote_id}/approval-return"),
            session=session
        )

    # Map department to workflow status
    department_status_map = {
        "quote_control": WorkflowStatus.PENDING_QUOTE_CONTROL,
        "sales": WorkflowStatus.PENDING_SALES_REVIEW,
        "procurement": WorkflowStatus.PENDING_PROCUREMENT,
        "logistics": WorkflowStatus.PENDING_LOGISTICS,
        "customs": WorkflowStatus.PENDING_CUSTOMS,
    }

    department_names = {
        "quote_control": "Контроль КП",
        "sales": "Продажи",
        "procurement": "Закупки",
        "logistics": "Логистика",
        "customs": "Таможня",
    }

    to_status = department_status_map.get(department, WorkflowStatus.PENDING_QUOTE_CONTROL)
    department_name = department_names.get(department, "Контроль КП")

    user_roles = get_user_roles_from_session(session)
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=to_status,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"[Возврат от топ-менеджера] {comment.strip()}"
    )

    if result.success:
        # Save revision tracking info
        supabase = get_supabase()
        supabase.table("quotes").update({
            "revision_department": department if department != "quote_control" else None,
            "revision_comment": comment.strip() if department != "quote_control" else None,
            "revision_returned_at": datetime.now(timezone.utc).isoformat() if department != "quote_control" else None
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на доработку"),
            P(f"КП отправлено в отдел «{department_name}» для доработки."),
            P(f"Комментарий: {comment.strip()}", style="color: #666; font-style: italic;"),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось вернуть КП: {result.error_message}"),
            A("← Вернуться к форме", href=f"/quotes/{quote_id}/approval-return"),
            session=session
        )


# ============================================================================
# SEND TO CLIENT
# ============================================================================

@rt("/quotes/{quote_id}/send-to-client")
def post(quote_id: str, session, sent_to_email: str = ""):
    """Send approved quote to client."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Save sent_at timestamp and sent_to_email
    from datetime import datetime
    supabase = get_supabase()
    supabase.table("quotes").update({
        "sent_at": datetime.utcnow().isoformat(),
        "sent_to_email": sent_to_email.strip() if sent_to_email else None
    }).eq("id", quote_id).execute()

    result = transition_quote_status(
        quote_id=quote_id,
        to_status="sent_to_client",
        actor_id=user["id"],
        actor_roles=user_roles,
        comment=f"Quote sent to client at {sent_to_email}" if sent_to_email else "Quote sent to client"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# CLIENT CHANGE REQUEST
# ============================================================================

@rt("/quotes/{quote_id}/client-change-request")
def post(quote_id: str, session, change_type: str = "", client_comment: str = ""):
    """Handle client change request - route to appropriate workflow stage."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Validate change type
    valid_types = ["add_item", "logistics", "price", "full"]
    if change_type not in valid_types:
        return page_layout("Error",
            Div("Invalid change type", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )

    # Record the change request
    from datetime import datetime
    try:
        supabase.table("quote_change_requests").insert({
            "quote_id": quote_id,
            "change_type": change_type,
            "client_comment": client_comment.strip() if client_comment else None,
            "requested_by": user["id"],
            "requested_at": datetime.utcnow().isoformat()
        }).execute()
    except Exception as e:
        # Table might not exist yet if migration not applied - continue anyway
        pass

    # Map change type to target workflow status
    status_map = {
        "add_item": "pending_procurement",
        "logistics": "pending_logistics",
        "price": "pending_sales_review",
        "full": "pending_procurement"
    }

    target_status = status_map.get(change_type, "pending_procurement")

    # Update quote with partial_recalc flag
    try:
        supabase.table("quotes").update({
            "partial_recalc": change_type
        }).eq("id", quote_id).execute()
    except Exception:
        pass

    # Transition quote status
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=target_status,
        actor_id=user["id"],
        actor_roles=user_roles,
        comment=f"Client change request: {change_type}. Comment: {client_comment}" if client_comment else f"Client change request: {change_type}"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# START NEGOTIATION
# ============================================================================

@rt("/quotes/{quote_id}/start-negotiation")
def post(quote_id: str, session):
    """Start client negotiation."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    result = transition_quote_status(
        quote_id=quote_id,
        to_status="client_negotiation",
        actor_id=user["id"],
        actor_roles=user_roles,
        comment="Client negotiation started"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# SUBMIT FOR SPEC CONTROL
# ============================================================================

@rt("/quotes/{quote_id}/submit-spec-control")
def post(quote_id: str, session):
    """Submit quote for specification control."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    result = transition_quote_status(
        quote_id=quote_id,
        to_status="pending_spec_control",
        actor_id=user["id"],
        actor_roles=user_roles,
        comment="Client accepted, submitted for specification"
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Error",
            Div(f"Error: {result.error_message}", cls="alert alert-error"),
            A("← Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )


@rt("/quotes/{quote_id}/client-rejected")
def post(quote_id: str, session, rejection_reason: str = "", rejection_comment: str = ""):
    """
    Mark quote as rejected by client with reason.
    Transitions to 'rejected' status and stores rejection reason.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_roles = user.get("roles", [])

    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Map rejection reason codes to human-readable labels
    reason_labels = {
        "price_too_high": "Цена слишком высокая",
        "delivery_time": "Сроки не устраивают",
        "competitor": "Выбрали другого поставщика",
        "project_cancelled": "Проект отменён / заморожен",
        "no_budget": "Нет бюджета",
        "requirements_changed": "Изменились требования",
        "other": "Другое",
    }

    reason_label = reason_labels.get(rejection_reason, rejection_reason)

    # Build comment with reason
    comment_parts = [f"Причина отказа: {reason_label}"]
    if rejection_comment and rejection_comment.strip():
        comment_parts.append(f"Комментарий: {rejection_comment.strip()}")

    full_comment = ". ".join(comment_parts)

    # Store rejection reason in quote metadata
    supabase = get_supabase()
    try:
        supabase.table("quotes").update({
            "rejection_reason": rejection_reason,
            "rejection_comment": rejection_comment.strip() if rejection_comment else None,
            "rejected_at": datetime.now().isoformat(),
            "rejected_by": user["id"]
        }).eq("id", quote_id).execute()
    except Exception as e:
        print(f"Error storing rejection reason: {e}")
        # Continue even if metadata update fails

    result = transition_quote_status(
        quote_id=quote_id,
        to_status="rejected",
        actor_id=user["id"],
        actor_roles=user_roles,
        comment=full_comment
    )

    if result.success:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)
    else:
        return page_layout("Ошибка",
            Div(f"Ошибка: {result.error_message}", cls="alert alert-error"),
            A("← Назад к КП", href=f"/quotes/{quote_id}"),
            session=session
        )


@rt("/quotes/{quote_id}/approve-department")
def post(quote_id: str, session, department: str = "", comments: str = ""):
    """
    Approve quote for a specific department.

    Bug #8 follow-up: Multi-department approval workflow
    POST handler for department approval form.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    # Validate department parameter
    if not department:
        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)

    # Check if user has permission to approve for this department
    if not user_can_approve_quote_department(session, department):
        return RedirectResponse("/unauthorized", status_code=303)

    # Perform approval
    success, message = approve_quote_department(
        quote_id=quote_id,
        organization_id=user["org_id"],
        department=department,
        user_id=user["id"],
        comments=comments if comments else None
    )

    # Debug logging
    print(f"[DEBUG] Approve department: dept={department}, success={success}, message={message}")

    # Redirect back to quote detail page
    # TODO: Add flash message with success/error message
    return RedirectResponse(f"/quotes/{quote_id}", status_code=303)


# ============================================================================
# QUOTE PRODUCTS
# ============================================================================

# ============================================================================
# QUOTE ITEM API (Handsontable)
# ============================================================================
# Note: /quotes/{quote_id}/products page was removed (2026-01-29)
# Product entry is now done via Handsontable on /quotes/{quote_id} overview page

@rt("/quotes/{quote_id}/items/{item_id}", methods=["PATCH"])
async def patch_quote_item(quote_id: str, item_id: str, session, request):
    """Update a single quote item field (for Handsontable auto-save)"""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    supabase = get_supabase()

    # Verify quote belongs to user's org
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Parse JSON body
    body = await request.body()
    try:
        data = json.loads(body)
    except:
        return JSONResponse({"success": False, "error": "Invalid JSON"}, status_code=400)

    # Allowed fields for update
    allowed_fields = ['product_name', 'product_code', 'brand', 'quantity', 'unit']
    update_data = {k: v for k, v in data.items() if k in allowed_fields}

    if not update_data:
        return JSONResponse({"success": False, "error": "No valid fields to update"}, status_code=400)

    try:
        result = supabase.table("quote_items") \
            .update(update_data) \
            .eq("id", item_id) \
            .eq("quote_id", quote_id) \
            .execute()

        if result.data:
            return JSONResponse({"success": True, "item": result.data[0]})
        else:
            return JSONResponse({"success": False, "error": "Item not found"}, status_code=404)
    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/quotes/{quote_id}/items/bulk", methods=["POST"])
async def bulk_insert_quote_items(quote_id: str, session, request):
    """Bulk insert quote items (for import functionality)"""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    supabase = get_supabase()

    # Verify quote belongs to user's org
    quote_result = supabase.table("quotes") \
        .select("id, organization_id") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Parse JSON body
    body = await request.body()
    try:
        data = json.loads(body)
    except:
        return JSONResponse({"success": False, "error": "Invalid JSON"}, status_code=400)

    items_data = data.get("items", [])
    if not items_data:
        return JSONResponse({"success": False, "error": "No items provided"}, status_code=400)

    # First, delete existing items for this quote (we're replacing all)
    try:
        supabase.table("quote_items") \
            .delete() \
            .eq("quote_id", quote_id) \
            .execute()
    except Exception as e:
        pass  # Ignore if no items existed

    # Prepare items for insert
    # base_price_vat is nullable with default 0, so we don't pass it
    # row_num column doesn't exist - ordering is by created_at
    insert_items = []
    for idx, item in enumerate(items_data, start=1):
        insert_items.append({
            "quote_id": quote_id,
            "product_name": item.get("product_name", ""),
            "product_code": item.get("product_code", ""),
            "brand": item.get("brand", ""),
            "quantity": int(item.get("quantity", 1)),
            "unit": item.get("unit", "шт")
        })

    try:
        result = supabase.table("quote_items") \
            .insert(insert_items) \
            .execute()

        return JSONResponse({
            "success": True,
            "items": [{"id": item["id"]} for item in result.data],
            "count": len(result.data)
        })
    except Exception as e:
        print(f"Bulk insert error: {e}")
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/quotes/{quote_id}/items", methods=["POST"])
async def create_single_quote_item(quote_id: str, session, request):
    """Create a single quote item (for Handsontable new row)"""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    supabase = get_supabase()

    # Verify quote belongs to user's org
    quote_result = supabase.table("quotes") \
        .select("id, organization_id") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Parse JSON body
    body = await request.body()
    try:
        item_data = json.loads(body)
    except:
        return JSONResponse({"success": False, "error": "Invalid JSON"}, status_code=400)

    # Prepare item for insert (row_num column doesn't exist, ordering is by created_at)
    insert_data = {
        "quote_id": quote_id,
        "product_name": item_data.get("product_name", ""),
        "product_code": item_data.get("product_code", ""),
        "brand": item_data.get("brand", ""),
        "quantity": int(item_data.get("quantity", 1)) if item_data.get("quantity") else 1,
        "unit": item_data.get("unit", "шт")
    }

    try:
        result = supabase.table("quote_items") \
            .insert(insert_data) \
            .execute()

        if result.data:
            return JSONResponse({
                "success": True,
                "item": {"id": result.data[0]["id"]}
            })
        else:
            return JSONResponse({"success": False, "error": "Insert failed"}, status_code=500)
    except Exception as e:
        print(f"Single item insert error: {e}")
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/quotes/{quote_id}/inline", methods=["PATCH"])
async def inline_update_quote(quote_id: str, session, request):
    """Inline update a single quote field via HTMX"""
    redirect = require_login(session)
    if redirect:
        return ""

    user = session["user"]
    supabase = get_supabase()

    # Verify quote belongs to user's org
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return ""

    # Parse form data from HTMX
    form = await request.form()
    field = form.get("field")
    value = form.get("value")

    # Debug logging to track "undefined" issue
    print(f"[INLINE UPDATE] quote_id={quote_id}, field={field}, value={repr(value)}")

    if not field:
        return ""

    # Allowed fields for inline update
    allowed_fields = [
        'customer_id', 'seller_company_id', 'delivery_city',
        'delivery_country', 'delivery_method', 'delivery_priority',
        'delivery_terms', 'currency', 'payment_terms', 'notes',
        'validity_days'
    ]

    if field not in allowed_fields:
        return ""

    # Handle empty values and the string "undefined" (JavaScript serialization bug)
    if value == "" or value is None or value == "undefined":
        value = None

    # Convert integer fields
    if field == "validity_days" and value is not None:
        try:
            value = max(1, int(value))
        except (ValueError, TypeError):
            value = 30

    try:
        supabase.table("quotes") \
            .update({field: value}) \
            .eq("id", quote_id) \
            .execute()
        return ""  # HTMX swap="none", no response needed
    except Exception as e:
        print(f"Inline update error: {e}")
        return ""


@rt("/quotes/{quote_id}/cancel", methods=["POST"])
def cancel_quote(quote_id: str, session):
    """Soft delete quote by setting workflow_status to 'cancelled'"""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    supabase = get_supabase()

    # Verify quote belongs to user's org
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    try:
        result = supabase.table("quotes") \
            .update({"workflow_status": "cancelled"}) \
            .eq("id", quote_id) \
            .execute()

        return JSONResponse({"success": True, "redirect": "/quotes"})
    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


# ============================================================================
# QUOTE EDIT
# ============================================================================

@rt("/quotes/{quote_id}/edit")
def get(quote_id: str, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    # Get quote (seller_company_id column may not exist if migration not applied)
    result = supabase.table("quotes") \
        .select("*") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not result.data:
        return page_layout("Not Found", H1("Quote not found"), session=session)

    quote = result.data[0]

    # Get customers
    customers_result = supabase.table("customers") \
        .select("id, name, inn") \
        .eq("organization_id", user["org_id"]) \
        .order("name") \
        .execute()

    customers = customers_result.data or []

    # Get seller companies for dropdown
    from services.seller_company_service import get_all_seller_companies, format_seller_company_for_dropdown
    seller_companies = get_all_seller_companies(organization_id=user["org_id"], is_active=True)

    # Prepare seller company info for pre-selected value
    # Note: seller_company_id column may not exist if migration 028 not applied
    selected_seller_id = quote.get("seller_company_id")
    selected_seller_label = None
    # We no longer join seller_companies since FK may not exist

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    input_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    """

    select_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    """

    label_style = "display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;"

    form_group_style = "margin-bottom: 16px;"

    grid_2col_style = "display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"

    return page_layout(f"Редактирование {quote.get('idn_quote', '')}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), " Назад к КП", href=f"/quotes/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1(f"Редактирование КП {quote.get('idn_quote', '')}",
               style="margin: 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            style=header_style
        ),

        Form(
            # Section 1: Client & Status
            Div(
                Div(icon("users", size=14), " Клиент и статус", style=section_header_style),
                Div(
                    Div(
                        Label("Клиент *", style=label_style),
                        Select(
                            *[Option(
                                f"{c['name']} ({c.get('inn', '')})",
                                value=c["id"],
                                selected=(c["id"] == quote.get("customer_id"))
                            ) for c in customers],
                            name="customer_id", required=True,
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    Div(
                        Label("Статус", style=label_style),
                        Select(
                            Option("Черновик", value="draft", selected=quote.get("status") == "draft"),
                            Option("Отправлено", value="sent", selected=quote.get("status") == "sent"),
                            Option("Одобрено", value="approved", selected=quote.get("status") == "approved"),
                            Option("Отклонено", value="rejected", selected=quote.get("status") == "rejected"),
                            name="status",
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    style=grid_2col_style
                ),
                Div(
                    Label("Компания-продавец *", style=label_style),
                    Select(
                        Option("Выберите компанию...", value=""),
                        *[Option(
                            format_seller_company_for_dropdown(sc),
                            value=sc.id,
                            selected=(str(sc.id) == str(selected_seller_id)) if selected_seller_id else False
                        ) for sc in seller_companies],
                        name="seller_company_id", required=True,
                        style=select_style
                    ),
                    Small("Наше юридическое лицо для продажи",
                          style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;"),
                    style=form_group_style
                ),
                style=form_card_style
            ),

            # Section 2: Delivery
            Div(
                Div(icon("truck", size=14), " Доставка", style=section_header_style),
                Div(
                    Div(
                        Label("Город доставки", style=label_style),
                        Input(
                            name="delivery_city",
                            type="text",
                            value=quote.get("delivery_city", "") or "",
                            placeholder="Москва, Пекин и т.д.",
                            style=input_style
                        ),
                        style=form_group_style
                    ),
                    Div(
                        Label("Страна доставки", style=label_style),
                        Input(
                            name="delivery_country",
                            type="text",
                            value=quote.get("delivery_country", "") or "",
                            placeholder="Россия, Китай и т.д.",
                            style=input_style
                        ),
                        style=form_group_style
                    ),
                    style=grid_2col_style
                ),
                Div(
                    Div(
                        Label("Способ доставки", style=label_style),
                        Select(
                            Option("-- Выберите способ --", value="", selected=not quote.get("delivery_method")),
                            Option("Авиа", value="air", selected=quote.get("delivery_method") == "air"),
                            Option("Авто", value="auto", selected=quote.get("delivery_method") == "auto"),
                            Option("Море", value="sea", selected=quote.get("delivery_method") == "sea"),
                            Option("Мультимодально", value="multimodal", selected=quote.get("delivery_method") == "multimodal"),
                            name="delivery_method",
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    Div(
                        Label("Условия поставки", style=label_style),
                        Select(
                            Option("EXW", value="EXW", selected=quote.get("delivery_terms") == "EXW"),
                            Option("FOB", value="FOB", selected=quote.get("delivery_terms") == "FOB"),
                            Option("CIF", value="CIF", selected=quote.get("delivery_terms") == "CIF"),
                            Option("DDP", value="DDP", selected=quote.get("delivery_terms") == "DDP"),
                            name="delivery_terms",
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    style=grid_2col_style
                ),
                Div(
                    Div(
                        Label("Приоритет доставки", style=label_style),
                        Select(
                            Option("-- Выберите приоритет --", value="", selected=not quote.get("delivery_priority")),
                            Option("Лучше быстро", value="fast", selected=quote.get("delivery_priority") == "fast"),
                            Option("Лучше дешево", value="cheap", selected=quote.get("delivery_priority") == "cheap"),
                            Option("Обычно", value="normal", selected=quote.get("delivery_priority") == "normal"),
                            name="delivery_priority",
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    style=grid_2col_style
                ),
                style=form_card_style
            ),

            # Section 3: Terms
            Div(
                Div(icon("file-text", size=14), " Условия оплаты и сроки", style=section_header_style),
                Div(
                    Div(
                        Label("Валюта", style=label_style),
                        Select(
                            Option("RUB", value="RUB", selected=quote.get("currency") == "RUB"),
                            Option("USD", value="USD", selected=quote.get("currency") == "USD"),
                            Option("EUR", value="EUR", selected=quote.get("currency") == "EUR"),
                            name="currency",
                            style=select_style
                        ),
                        style=form_group_style
                    ),
                    Div(
                        Label("Отсрочка платежа (дней)", style=label_style),
                        Input(name="payment_terms", type="number", value=str(quote.get("payment_terms", 30)), min="0",
                              style=input_style),
                        style=form_group_style
                    ),
                    Div(
                        Label("Срок поставки (дней)", style=label_style),
                        Input(name="delivery_days", type="number", value=str(quote.get("delivery_days", 45)), min="0",
                              style=input_style),
                        style=form_group_style
                    ),
                    Div(
                        Label("Срок действия КП (дней)", style=label_style),
                        Input(name="validity_days", type="number", value=str(quote.get("validity_days", 30)), min="1",
                              style=input_style),
                        style=form_group_style
                    ),
                    style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px;"
                ),
                Div(
                    Label("Примечания", style=label_style),
                    Textarea(quote.get("notes", "") or "", name="notes", rows="3",
                             style=f"{input_style} resize: vertical; min-height: 80px;"),
                    style=form_group_style
                ),
                style=form_card_style
            ),

            # Action buttons
            Div(
                Button(icon("check", size=14), " Сохранить", type="submit",
                       style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                A(icon("x", size=14), " Отмена", href=f"/quotes/{quote_id}",
                  style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
                Button(icon("trash-2", size=14), " Удалить КП", type="button",
                       hx_delete=f"/quotes/{quote_id}",
                       hx_confirm="Вы уверены, что хотите удалить это КП?",
                       style="padding: 10px 20px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; margin-left: auto;"),
                style="display: flex; gap: 12px; padding: 20px 0;"
            ),
            method="post",
            action=f"/quotes/{quote_id}/edit"
        ),

        session=session
    )


@rt("/quotes/{quote_id}/edit")
def post(quote_id: str, customer_id: str, status: str, currency: str, delivery_terms: str,
         payment_terms: int, delivery_days: int, notes: str,
         delivery_city: str = None, delivery_country: str = None, delivery_method: str = None,
         delivery_priority: str = None, seller_company_id: str = None,
         validity_days: int = 30, session=None):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    try:
        update_data = {
            "customer_id": customer_id,
            "status": status,
            "currency": currency,
            "delivery_terms": delivery_terms,
            "payment_terms": payment_terms,
            "delivery_days": delivery_days,
            "validity_days": validity_days,
            "notes": notes or None,
            "updated_at": datetime.now().isoformat()
        }

        # Add delivery location if provided
        if delivery_city and delivery_city.strip():
            update_data["delivery_city"] = delivery_city.strip()
        else:
            update_data["delivery_city"] = None

        if delivery_country and delivery_country.strip():
            update_data["delivery_country"] = delivery_country.strip()
        else:
            update_data["delivery_country"] = None

        if delivery_method and delivery_method.strip():
            update_data["delivery_method"] = delivery_method.strip()
        else:
            update_data["delivery_method"] = None

        if delivery_priority and delivery_priority.strip():
            update_data["delivery_priority"] = delivery_priority.strip()
        else:
            update_data["delivery_priority"] = None

        # v3.0: seller_company_id at quote level
        # If provided and not empty, set it; otherwise keep existing or set to None
        if seller_company_id and seller_company_id.strip():
            update_data["seller_company_id"] = seller_company_id.strip()
        else:
            update_data["seller_company_id"] = None

        supabase.table("quotes").update(update_data) \
            .eq("id", quote_id) \
            .eq("organization_id", user["org_id"]) \
            .execute()

        return RedirectResponse(f"/quotes/{quote_id}", status_code=303)

    except Exception as e:
        return page_layout("Error",
            Div(f"Error: {str(e)}", cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}/edit"),
            session=session
        )


@rt("/quotes/{quote_id}")
def delete(quote_id: str, session):
    redirect = require_login(session)
    if redirect:
        return ""

    user = session["user"]
    supabase = get_supabase()

    try:
        # Delete quote items first
        supabase.table("quote_items").delete().eq("quote_id", quote_id).execute()
        # Delete quote
        supabase.table("quotes").delete().eq("id", quote_id).eq("organization_id", user["org_id"]).execute()
        # Redirect to quotes list
        return RedirectResponse("/quotes", status_code=303)
    except Exception as e:
        return Div(f"Error: {str(e)}", cls="alert alert-error")


# ============================================================================
# CUSTOMER DETAIL/EDIT
# ============================================================================

# REMOVED: Old customer detail route - replaced by enhanced version at line ~15609
# This old route was causing routing conflicts preventing /customers/{customer_id}/contacts/new from working


@rt("/customers/{customer_id}/edit")
def get(customer_id: str, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    result = supabase.table("customers") \
        .select("*") \
        .eq("id", customer_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not result.data:
        return page_layout("Not Found", H1("Customer not found"), session=session)

    customer = result.data[0]

    return page_layout(f"Edit {customer.get('name', 'Customer')}",
        H1(f"Edit Customer"),

        Div(
            Form(
                Div(
                    Label("Company Name *", Input(name="name", value=customer.get("name", ""), required=True)),
                    Label("INN", Input(name="inn", value=customer.get("inn", "") or "")),
                    cls="form-row"
                ),
                Div(
                    Label("Email", Input(name="email", type="email", value=customer.get("email", "") or "")),
                    Label("Phone", Input(name="phone", value=customer.get("phone", "") or "")),
                    cls="form-row"
                ),
                Label("Address", Textarea(customer.get("address", "") or "", name="address", rows="3")),
                Div(
                    btn("Save Changes", variant="primary", icon_name="check", type="submit"),
                    btn_link("Cancel", href=f"/customers/{customer_id}", variant="secondary"),
                    cls="form-actions"
                ),
                method="post",
                action=f"/customers/{customer_id}/edit"
            ),
            cls="card"
        ),

        session=session
    )


@rt("/customers/{customer_id}/edit")
def post(customer_id: str, name: str, inn: str, email: str, phone: str, address: str, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    try:
        supabase.table("customers").update({
            "name": name,
            "inn": inn or None,
            "email": email or None,
            "phone": phone or None,
            "address": address or None,
            "updated_at": datetime.now().isoformat()
        }).eq("id", customer_id).eq("organization_id", user["org_id"]).execute()

        return RedirectResponse(f"/customers/{customer_id}", status_code=303)

    except Exception as e:
        return page_layout("Error",
            Div(f"Error: {str(e)}", cls="alert alert-error"),
            session=session
        )


# ============================================================================
# QUOTE CALCULATION (calls existing backend API)
# ============================================================================

import httpx

BACKEND_URL = os.getenv("BACKEND_URL", "http://localhost:8000")


# ============================================================================
# CALCULATION HELPERS
# ============================================================================

# Mapping from various database values to SupplierCountry enum values
# DO NOT MODIFY the enum values (right side) - they must match calculation_models.py
SUPPLIER_COUNTRY_MAPPING = {
    # Direct enum values (already valid)
    "Турция": "Турция",
    "Турция (транзитная зона)": "Турция (транзитная зона)",
    "Россия": "Россия",
    "Китай": "Китай",
    "Литва": "Литва",
    "Латвия": "Латвия",
    "Болгария": "Болгария",
    "Польша": "Польша",
    "ЕС (между странами ЕС)": "ЕС (между странами ЕС)",
    "ОАЭ": "ОАЭ",
    "Прочие": "Прочие",
    # ISO codes
    "TR": "Турция",
    "RU": "Россия",
    "CN": "Китай",
    "LT": "Литва",
    "LV": "Латвия",
    "BG": "Болгария",
    "PL": "Польша",
    "AE": "ОАЭ",
    # English names
    "Turkey": "Турция",
    "Russia": "Россия",
    "China": "Китай",
    "Lithuania": "Литва",
    "Latvia": "Латвия",
    "Bulgaria": "Болгария",
    "Poland": "Польша",
    "UAE": "ОАЭ",
    # Special values
    "OTHER": "Прочие",
    "other": "Прочие",
    "Другое": "Прочие",
    "": "Прочие",  # Empty defaults to OTHER
}

def map_supplier_country(value: str) -> str:
    """Map database supplier_country value to SupplierCountry enum value.

    Returns "Прочие" (OTHER) for any unmapped values.
    """
    if not value:
        return "Прочие"
    return SUPPLIER_COUNTRY_MAPPING.get(value, "Прочие")


def build_calculation_inputs(items: List[Dict], variables: Dict[str, Any]) -> List[QuoteCalculationInput]:
    """Build calculation inputs for all quote items.

    Note: Uses purchase_price_original as base_price_vat for calculation engine.
    Calculation engine is NOT modified - we adapt data to match its expectations.

    2026-01-26: Added per-item exchange rate calculation. Each item may have a different
    purchase_currency, so we calculate individual exchange rates to quote_currency.

    2026-01-28: Monetary values (brokerage, DM fee) are now stored in ORIGINAL currency.
    Conversion to USD happens here, just before passing to calculation engine.
    """
    from services.currency_service import convert_amount

    # Get quote currency (target currency for all conversions)
    quote_currency = variables.get('currency_of_quote') or variables.get('currency', 'USD')

    # ==========================================================================
    # CONVERT MONETARY VALUES TO QUOTE CURRENCY FOR CALCULATION ENGINE
    #
    # IMPORTANT: The calculation engine uses exchange_rate to convert purchase
    # prices to quote currency (R16 = P16 / exchange_rate). This means S16, AY16
    # are in quote currency. For Y16 = tariff * (AY16 + T16) to be correct,
    # T16 (logistics) must also be in quote currency.
    #
    # Values are stored in various currencies (logistics in USD, brokerage in
    # original currency). We convert ALL to quote currency here.
    #
    # 2026-01-28: Fixed currency mixing bug - was converting to USD but engine
    # outputs S16/AY16 in quote currency, causing Y16 calculation error.
    # ==========================================================================

    # Helper to convert value from source_currency to quote_currency
    def to_quote(value, from_currency):
        if not value:
            return safe_decimal(value)
        if from_currency == quote_currency:
            return safe_decimal(value)
        val = safe_decimal(value)
        if val > 0:
            return safe_decimal(convert_amount(val, from_currency, quote_currency))
        return val

    # Convert brokerage fields from their currencies to quote currency
    brokerage_hub_qc = to_quote(
        variables.get('brokerage_hub'),
        variables.get('brokerage_hub_currency', 'USD')
    )
    brokerage_customs_qc = to_quote(
        variables.get('brokerage_customs'),
        variables.get('brokerage_customs_currency', 'USD')
    )
    warehousing_at_customs_qc = to_quote(
        variables.get('warehousing_at_customs'),
        variables.get('warehousing_at_customs_currency', 'USD')
    )
    customs_documentation_qc = to_quote(
        variables.get('customs_documentation'),
        variables.get('customs_documentation_currency', 'USD')
    )
    brokerage_extra_qc = to_quote(
        variables.get('brokerage_extra'),
        variables.get('brokerage_extra_currency', 'USD')
    )

    # Convert logistics fields from USD to quote currency
    # Logistics costs are aggregated and stored in USD
    logistics_supplier_hub_qc = to_quote(
        variables.get('logistics_supplier_hub'), 'USD'
    )
    logistics_hub_customs_qc = to_quote(
        variables.get('logistics_hub_customs'), 'USD'
    )
    logistics_customs_client_qc = to_quote(
        variables.get('logistics_customs_client'), 'USD'
    )

    # Convert DM Fee from its currency to quote currency (only for fixed type)
    dm_fee_type = variables.get('dm_fee_type', 'fixed')
    dm_fee_currency = variables.get('dm_fee_currency', 'USD')
    if dm_fee_type == 'fixed':
        dm_fee_value_qc = to_quote(variables.get('dm_fee_value'), dm_fee_currency)
    else:
        # Percentage - no conversion needed
        dm_fee_value_qc = safe_decimal(variables.get('dm_fee_value'))

    # Create a copy of variables with quote-currency-converted values
    calc_variables = dict(variables)
    calc_variables['brokerage_hub'] = brokerage_hub_qc
    calc_variables['brokerage_customs'] = brokerage_customs_qc
    calc_variables['warehousing_at_customs'] = warehousing_at_customs_qc
    calc_variables['customs_documentation'] = customs_documentation_qc
    calc_variables['brokerage_extra'] = brokerage_extra_qc
    calc_variables['logistics_supplier_hub'] = logistics_supplier_hub_qc
    calc_variables['logistics_hub_customs'] = logistics_hub_customs_qc
    calc_variables['logistics_customs_client'] = logistics_customs_client_qc
    calc_variables['dm_fee_value'] = dm_fee_value_qc

    calc_inputs = []
    for item in items:
        # Skip unavailable items - they shouldn't be included in calculation
        if item.get('is_unavailable'):
            continue

        # Get item's purchase currency
        item_currency = item.get('purchase_currency') or item.get('currency_of_base_price', 'USD')

        # Product fields (adapt new schema to calculation engine expectations)
        product = {
            'base_price_vat': safe_decimal(item.get('purchase_price_original') or item.get('base_price_vat')),
            'quantity': item.get('quantity', 1),
            'weight_in_kg': safe_decimal(item.get('weight_in_kg')),
            'customs_code': item.get('customs_code', '0000000000'),
            'supplier_country': map_supplier_country(item.get('supplier_country') or variables.get('supplier_country', '')),
            'currency_of_base_price': item_currency,
            'import_tariff': item.get('customs_duty') or item.get('import_tariff'),  # customs_duty is saved by customs workspace
            'markup': item.get('markup'),
            'supplier_discount': item.get('supplier_discount'),
        }

        # Calculate per-item exchange rate (2026-01-26)
        # Formula: exchange_rate = "how many units of source currency per 1 unit of quote currency"
        # Example: if quote is EUR and item is USD, and 1 EUR = 1.08 USD, then exchange_rate = 1.08
        # Calculation: P16 (in USD) / 1.08 = R16 (in EUR)
        if item_currency == quote_currency:
            exchange_rate = Decimal("1.0")
        else:
            # convert_amount(1, quote_currency, item_currency) gives how many item_currency = 1 quote_currency
            exchange_rate = safe_decimal(convert_amount(Decimal("1"), quote_currency, item_currency))
            if exchange_rate == 0:
                exchange_rate = Decimal("1.0")  # Fallback if rate not found

        calc_input = map_variables_to_calculation_input(
            product=product,
            variables=calc_variables,  # Use USD-converted values for calculation
            exchange_rate=exchange_rate
        )
        calc_inputs.append(calc_input)

    return calc_inputs


def render_preview_panel(results: List, items: List[Dict], currency: str) -> str:
    """Render the preview panel HTML for HTMX."""
    if not results:
        return Div(P("Add products to preview calculation."), cls="alert alert-info", id="preview-panel")

    # Calculate totals
    total_purchase = sum(safe_decimal(r.purchase_price_total_quote_currency) for r in results)
    total_logistics = sum(safe_decimal(r.logistics_total) for r in results)
    total_cogs = sum(safe_decimal(r.cogs_per_product) for r in results)
    total_profit = sum(safe_decimal(r.profit) for r in results)
    total_no_vat = sum(safe_decimal(r.sales_price_total_no_vat) for r in results)
    total_with_vat = sum(safe_decimal(r.sales_price_total_with_vat) for r in results)

    avg_margin = (total_profit / total_cogs * 100) if total_cogs else Decimal("0")

    # Build product rows for preview
    product_rows = []
    for item, result in zip(items, results):
        product_rows.append(
            Tr(
                Td(item.get('product_name', 'Product')[:30]),
                Td(str(item.get('quantity', 1))),
                Td(format_money(result.sales_price_per_unit_no_vat, currency)),
                Td(format_money(result.sales_price_total_with_vat, currency)),
                Td(format_money(result.profit, currency)),
            )
        )

    return Div(
        H3("Preview (not saved)"),

        # Summary stats
        Div(
            Div(
                Div("Total (excl VAT)", style="font-size: 0.875rem; color: #666;"),
                Div(format_money(total_no_vat, currency), cls="stat-value", style="font-size: 1.5rem;"),
                cls="stat-card"
            ),
            Div(
                Div("Total (incl VAT)", style="font-size: 0.875rem; color: #666;"),
                Div(format_money(total_with_vat, currency), cls="stat-value", style="font-size: 1.5rem; color: #28a745;"),
                cls="stat-card"
            ),
            Div(
                Div("Profit", style="font-size: 0.875rem; color: #666;"),
                Div(format_money(total_profit, currency), cls="stat-value", style="font-size: 1.5rem;"),
                cls="stat-card"
            ),
            Div(
                Div("Avg Margin", style="font-size: 0.875rem; color: #666;"),
                Div(f"{avg_margin:.1f}%", cls="stat-value", style="font-size: 1.5rem;"),
                cls="stat-card"
            ),
            cls="stats-grid", style="margin-bottom: 1rem;"
        ),

        # Cost breakdown
        Table(
            Thead(Tr(Th("Product"), Th("Qty"), Th("Unit Price"), Th("Total"), Th("Profit"))),
            Tbody(*product_rows),
            Tfoot(
                Tr(
                    Td(Strong("TOTAL"), colspan="3"),
                    Td(Strong(format_money(total_with_vat, currency))),
                    Td(Strong(format_money(total_profit, currency))),
                )
            ),
            style="font-size: 0.875rem;"
        ),

        id="preview-panel",
        style="background: #f0fff0; border: 2px solid #28a745; padding: 1rem; border-radius: 8px;"
    )


# ============================================================================
# HTMX LIVE PREVIEW ROUTE
# ============================================================================

@rt("/quotes/{quote_id}/preview")
def post(
    quote_id: str,
    session,
    # Company settings
    seller_company: str = "МАСТЕР БЭРИНГ ООО",
    offer_sale_type: str = "поставка",
    offer_incoterms: str = "DDP",
    # Pricing (note: 'currency' matches form field name)
    currency: str = "RUB",
    markup: str = "15",
    supplier_discount: str = "0",
    exchange_rate: str = "1.0",
    delivery_time: str = "30",
    # Logistics
    logistics_supplier_hub: str = "0",
    logistics_hub_customs: str = "0",
    logistics_customs_client: str = "0",
    # Brokerage (values and currencies)
    brokerage_hub: str = "0",
    brokerage_hub_currency: str = "RUB",
    brokerage_customs: str = "0",
    brokerage_customs_currency: str = "RUB",
    warehousing_at_customs: str = "0",
    warehousing_at_customs_currency: str = "RUB",
    customs_documentation: str = "0",
    customs_documentation_currency: str = "RUB",
    brokerage_extra: str = "0",
    brokerage_extra_currency: str = "RUB",
    # Payment terms
    advance_from_client: str = "100",
    advance_to_supplier: str = "100",
    time_to_advance: str = "0",
    time_to_advance_on_receiving: str = "0",
    # DM Fee
    dm_fee_type: str = "fixed",
    dm_fee_value: str = "0",
    dm_fee_currency: str = "USD",
):
    """HTMX endpoint - returns preview panel only (no DB save)."""
    redirect = require_login(session)
    if redirect:
        return HTMLResponse("Unauthorized", status_code=401)

    user = session["user"]
    supabase = get_supabase()

    # Get quote
    quote_result = supabase.table("quotes") \
        .select("*") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return Div("Quote not found", cls="alert alert-error", id="preview-panel")

    quote = quote_result.data[0]
    # Note: 'currency' comes from form parameter (user's selection)
    # Don't override with quote.get("currency")

    # Get items
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()

    items = items_result.data or []

    if not items:
        return Div("Add products to preview.", cls="alert alert-info", id="preview-panel")

    try:
        # Aggregate delivery time from items (production_time_days) and invoices (logistics_total_days)
        max_production_days = max((item.get("production_time_days") or 0) for item in items) if items else 0

        invoices_days_result = supabase.table("invoices") \
            .select("logistics_total_days") \
            .eq("quote_id", quote_id) \
            .execute()
        max_logistics_days = max((inv.get("logistics_total_days") or 0) for inv in (invoices_days_result.data or [])) if invoices_days_result.data else 0

        aggregated_delivery_time = max_logistics_days + max_production_days
        form_delivery_time = safe_int(delivery_time)
        effective_delivery_time = max(aggregated_delivery_time, form_delivery_time)

        # ==========================================================================
        # STORE VALUES IN ORIGINAL CURRENCY (no conversion on save)
        # Conversion to USD happens only in build_calculation_inputs() before calculation
        # ==========================================================================

        # Build variables from form parameters
        variables = {
            'currency_of_quote': currency,
            'markup': safe_decimal(markup),
            'supplier_discount': safe_decimal(supplier_discount),
            'offer_incoterms': offer_incoterms,
            'delivery_time': effective_delivery_time,  # Uses MAX(logistics_days + production_days) if greater
            'seller_company': seller_company,
            'offer_sale_type': offer_sale_type,

            # Logistics (stored in USD - aggregated from invoices which are already converted)
            'logistics_supplier_hub': safe_decimal(logistics_supplier_hub),
            'logistics_hub_customs': safe_decimal(logistics_hub_customs),
            'logistics_customs_client': safe_decimal(logistics_customs_client),

            # Brokerage (stored in ORIGINAL currency, converted to USD in build_calculation_inputs)
            'brokerage_hub': safe_decimal(brokerage_hub),
            'brokerage_hub_currency': brokerage_hub_currency,
            'brokerage_customs': safe_decimal(brokerage_customs),
            'brokerage_customs_currency': brokerage_customs_currency,
            'warehousing_at_customs': safe_decimal(warehousing_at_customs),
            'warehousing_at_customs_currency': warehousing_at_customs_currency,
            'customs_documentation': safe_decimal(customs_documentation),
            'customs_documentation_currency': customs_documentation_currency,
            'brokerage_extra': safe_decimal(brokerage_extra),
            'brokerage_extra_currency': brokerage_extra_currency,

            # Payment terms
            'advance_from_client': safe_decimal(advance_from_client),
            'advance_to_supplier': safe_decimal(advance_to_supplier),
            'time_to_advance': safe_int(time_to_advance),
            'time_to_advance_on_receiving': safe_int(time_to_advance_on_receiving),

            # DM Fee (stored in ORIGINAL currency, converted to USD in build_calculation_inputs)
            'dm_fee_type': dm_fee_type,
            'dm_fee_value': safe_decimal(dm_fee_value),
            'dm_fee_currency': dm_fee_currency,

            # Exchange rate
            'exchange_rate': safe_decimal(exchange_rate),
        }

        # Build calculation inputs
        calc_inputs = build_calculation_inputs(items, variables)

        # Run calculation (in memory, no save)
        results = calculate_multiproduct_quote(calc_inputs)

        # Return preview panel
        return render_preview_panel(results, items, currency)

    except Exception as e:
        return Div(f"Preview error: {str(e)}", cls="alert alert-error", id="preview-panel")


# ============================================================================
# CALCULATION PAGE (GET) - Enhanced with all variables
# ============================================================================

@rt("/quotes/{quote_id}/calculate")
def get(quote_id: str, session):
    """Calculate quote using the 13-phase calculation engine with HTMX live preview."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    # Get quote with customer (v3.0 - fetch seller company separately to avoid FK issues)
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return page_layout("Not Found", H1("Quote not found"), session=session)

    quote = quote_result.data[0]
    currency = quote.get("currency", "USD")

    # Get seller company info separately using service function
    from services.seller_company_service import get_seller_company
    seller_company_info = None
    seller_company_display = "Не выбрана"
    seller_company_name = ""
    if quote.get("seller_company_id"):
        seller_company = get_seller_company(quote["seller_company_id"])
        if seller_company:
            seller_company_info = {"id": seller_company.id, "supplier_code": seller_company.supplier_code, "name": seller_company.name}
            seller_company_display = f"{seller_company.supplier_code} - {seller_company.name}"
            seller_company_name = seller_company.name

    # Get quote items
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()

    items = items_result.data or []

    if not items:
        return page_layout("Cannot Calculate",
            H1("No Products"),
            P("Add products to the quote before calculating."),
            A("Back to Quote", href=f"/quotes/{quote_id}"),
            session=session
        )

    # Try to load existing calculation variables
    vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()

    saved_vars = vars_result.data[0]["variables"] if vars_result.data else {}

    # NOTE: Monetary values (brokerage, DM fee) are now stored in ORIGINAL currency
    # No back-conversion needed for display - values are shown as entered

    # ==========================================================================
    # AGGREGATE LOGISTICS FROM INVOICES (with multi-currency support)
    # Logistics costs are entered per-invoice by logistics department
    # Each segment may have different currency - convert all to QUOTE CURRENCY before summing
    # The calculation engine expects logistics values in quote currency, not USD
    # ==========================================================================
    invoices_result = supabase.table("invoices") \
        .select("logistics_supplier_to_hub, logistics_hub_to_customs, logistics_customs_to_customer, "
                "logistics_supplier_to_hub_currency, logistics_hub_to_customs_currency, logistics_customs_to_customer_currency") \
        .eq("quote_id", quote_id) \
        .execute()

    invoices_logistics = invoices_result.data or []

    # Sum logistics costs from all invoices, converting each to USD (standard storage currency)
    # Conversion to quote currency happens only at export time (single point of conversion)
    from services.currency_service import convert_amount
    total_logistics_supplier_hub = Decimal(0)
    total_logistics_hub_customs = Decimal(0)
    total_logistics_customs_client = Decimal(0)

    for inv in invoices_logistics:
        # Supplier → Hub - convert to USD
        s2h_amount = Decimal(str(inv.get("logistics_supplier_to_hub") or 0))
        s2h_currency = inv.get("logistics_supplier_to_hub_currency") or "USD"
        if s2h_amount > 0:
            total_logistics_supplier_hub += convert_amount(s2h_amount, s2h_currency, "USD")

        # Hub → Customs - convert to USD
        h2c_amount = Decimal(str(inv.get("logistics_hub_to_customs") or 0))
        h2c_currency = inv.get("logistics_hub_to_customs_currency") or "USD"
        if h2c_amount > 0:
            total_logistics_hub_customs += convert_amount(h2c_amount, h2c_currency, "USD")

        # Customs → Customer - convert to USD
        c2c_amount = Decimal(str(inv.get("logistics_customs_to_customer") or 0))
        c2c_currency = inv.get("logistics_customs_to_customer_currency") or "USD"
        if c2c_amount > 0:
            total_logistics_customs_client += convert_amount(c2c_amount, c2c_currency, "USD")

    # Convert to float for downstream compatibility
    total_logistics_supplier_hub = float(total_logistics_supplier_hub)
    total_logistics_hub_customs = float(total_logistics_hub_customs)
    total_logistics_customs_client = float(total_logistics_customs_client)

    # Use aggregated values from invoices as defaults
    # Override saved_vars if: aggregated > 0 AND (saved is missing or saved is 0)
    # This ensures invoice-level logistics data flows to calculation
    saved_supplier_hub = float(saved_vars.get("logistics_supplier_hub", 0) or 0)
    saved_hub_customs = float(saved_vars.get("logistics_hub_customs", 0) or 0)
    saved_customs_client = float(saved_vars.get("logistics_customs_client", 0) or 0)

    if total_logistics_supplier_hub > 0 and saved_supplier_hub == 0:
        saved_vars["logistics_supplier_hub"] = total_logistics_supplier_hub
    if total_logistics_hub_customs > 0 and saved_hub_customs == 0:
        saved_vars["logistics_hub_customs"] = total_logistics_hub_customs
    if total_logistics_customs_client > 0 and saved_customs_client == 0:
        saved_vars["logistics_customs_client"] = total_logistics_customs_client

    # Default values (with saved values taking precedence)
    def get_var(key, default):
        return saved_vars.get(key, default)

    # Check for partial recalculation
    partial_recalc = quote.get("partial_recalc")

    # Check existing versions and workflow status for version dialog
    existing_versions = list_quote_versions(quote_id, user["org_id"])
    workflow_status = quote.get("workflow_status", "draft")
    can_update, update_reason = can_update_version(quote_id, user["org_id"])
    current_version = get_current_quote_version(quote_id, user["org_id"]) if existing_versions else None
    current_version_num = current_version.get("version_number", 1) if current_version else 0

    # ==========================================================================
    # COMPACT CALCULATE PAGE STYLING (Logistics-inspired design)
    # ==========================================================================
    # Inline styles for compact logistics-style layout
    card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 16px;
        margin-bottom: 12px;
    """
    label_style = "font-size: 11px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;"
    input_row_style = "display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;"
    input_row_last_style = "display: flex; align-items: center; padding: 8px 0;"
    input_style = "width: 100px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
    input_wide_style = "width: 140px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
    select_style = "width: 120px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
    select_currency_style = "width: 70px; padding: 8px 6px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
    section_title_style = "font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px;"
    field_label_style = "font-size: 13px; color: #64748b; width: 140px; font-weight: 500;"
    value_style = "font-size: 14px; font-weight: 600; color: #1e40af;"

    # Build seller company display
    seller_company_hidden = Input(type="hidden", name="seller_company", value=seller_company_name if seller_company_info else "")
    if seller_company_info:
        seller_display = Span(seller_company_display, style="font-weight: 600; color: #1e40af;")
    else:
        seller_display = Span("Не выбрана", style="color: #d97706; font-weight: 500;")

    return page_layout(f"Calculate - {quote.get('idn_quote', '')}",
        # Compact header
        Div(
            Div(
                icon("calculator", size=20),
                Span(f"Расчёт {quote.get('idn_quote', '')}", style="font-size: 1.25rem; font-weight: 600; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            Div(
                Span(quote.get('customers', {}).get('name', '—') if quote.get('customers') else '—', style="font-weight: 500;"),
                Span(" • ", style="color: #94a3b8;"),
                Span(f"{currency}", style="color: #3b82f6; font-weight: 600;"),
                Span(" • ", style="color: #94a3b8;"),
                Span(f"{len(items)} поз.", style="color: #64748b;"),
                style="font-size: 13px; margin-top: 4px;"
            ),
            style="margin-bottom: 16px;"
        ),

        # Partial recalculation banner
        Div(
            icon("refresh-cw", size=16),
            Span(" Частичный пересчёт: только наценка", style="font-weight: 600; margin-left: 6px;"),
            Span(" — данные закупки, логистики и таможни сохранены", style="font-size: 12px; color: #065f46; margin-left: 8px;"),
            style="background: linear-gradient(90deg, #dcfce7 0%, #f0fdf4 100%); border: 1px solid #86efac; border-radius: 8px; padding: 10px 14px; margin-bottom: 16px; display: flex; align-items: center; color: #166534;"
        ) if partial_recalc == "price" else None,

        # Main form with HTMX live preview
        Form(
            Div(
                # Left column: Compact form cards
                Div(
                    # === COMPANY & PRICING CARD (Combined) ===
                    Div(
                        # Section: Company
                        Div(
                            Span(icon("building-2", size=14), style="color: #64748b;"),
                            Span("Компания и условия", style=section_title_style[len("font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; "):]),
                            style=section_title_style
                        ),
                        # Row: Seller Company
                        Div(
                            Span("Продавец", style=field_label_style),
                            seller_display,
                            A("изменить", href=f"/quotes/{quote_id}/edit", style="font-size: 11px; margin-left: 8px; color: #94a3b8;"),
                            seller_company_hidden,
                            style=input_row_style
                        ),
                        # Row: Sale Type + Incoterms
                        Div(
                            Span("Тип сделки", style=field_label_style),
                            Select(
                                Option("Поставка", value="поставка", selected=True),
                                Option("Транзит", value="транзит"),
                                name="offer_sale_type",
                                style=select_style
                            ),
                            Span("Incoterms", style=f"{field_label_style} margin-left: 20px; width: 80px;"),
                            Select(
                                Option("DDP", value="DDP", selected=get_var('offer_incoterms', 'DDP') == "DDP"),
                                Option("DAP", value="DAP", selected=get_var('offer_incoterms', '') == "DAP"),
                                Option("CIF", value="CIF", selected=get_var('offer_incoterms', '') == "CIF"),
                                Option("FOB", value="FOB", selected=get_var('offer_incoterms', '') == "FOB"),
                                Option("EXW", value="EXW", selected=get_var('offer_incoterms', '') == "EXW"),
                                name="offer_incoterms",
                                style="width: 80px; padding: 8px 6px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
                            ),
                            style=input_row_style
                        ),

                        # Divider
                        Div(style="height: 1px; background: #e2e8f0; margin: 12px 0;"),

                        # Section: Pricing
                        Div(
                            Span(icon("percent", size=14), style="color: #64748b;"),
                            Span("Цена и наценка", style=section_title_style[len("font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; "):]),
                            style=section_title_style
                        ),
                        # Row: Currency + Markup
                        Div(
                            Span("Валюта КП", style=field_label_style),
                            Select(
                                Option("RUB", value="RUB", selected=currency == "RUB"),
                                Option("USD", value="USD", selected=currency == "USD"),
                                Option("EUR", value="EUR", selected=currency == "EUR"),
                                Option("CNY", value="CNY", selected=currency == "CNY"),
                                name="currency",
                                style=select_currency_style
                            ),
                            Span("Наценка", style=f"{field_label_style} margin-left: 20px; width: 80px;"),
                            Input(name="markup", type="number", value=str(get_var('markup', 15)), min="0", max="100", step="0.1",
                                  style="width: 70px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; text-align: right;"),
                            Span("%", style="margin-left: 4px; color: #64748b; font-size: 14px;"),
                            style=input_row_last_style
                        ),

                        # Hidden fields
                        Input(type="hidden", name="supplier_discount", value=str(get_var('supplier_discount', 0))),
                        Input(type="hidden", name="exchange_rate", value=str(get_var('exchange_rate', 1.0))),
                        Input(type="hidden", name="delivery_time", value=str(get_var('delivery_time', 30))),
                        Input(type="hidden", name="logistics_supplier_hub", value=str(get_var('logistics_supplier_hub', 0))),
                        Input(type="hidden", name="logistics_hub_customs", value=str(get_var('logistics_hub_customs', 0))),
                        Input(type="hidden", name="logistics_customs_client", value=str(get_var('logistics_customs_client', 0))),
                        Input(type="hidden", name="brokerage_hub", value=str(get_var('brokerage_hub', 0))),
                        Input(type="hidden", name="brokerage_hub_currency", value=str(get_var('brokerage_hub_currency', 'RUB'))),
                        Input(type="hidden", name="brokerage_customs", value=str(get_var('brokerage_customs', 0))),
                        Input(type="hidden", name="brokerage_customs_currency", value=str(get_var('brokerage_customs_currency', 'RUB'))),
                        Input(type="hidden", name="warehousing_at_customs", value=str(get_var('warehousing_at_customs', 0))),
                        Input(type="hidden", name="warehousing_at_customs_currency", value=str(get_var('warehousing_at_customs_currency', 'RUB'))),
                        Input(type="hidden", name="customs_documentation", value=str(get_var('customs_documentation', 0))),
                        Input(type="hidden", name="customs_documentation_currency", value=str(get_var('customs_documentation_currency', 'RUB'))),
                        Input(type="hidden", name="brokerage_extra", value=str(get_var('brokerage_extra', 0))),
                        Input(type="hidden", name="brokerage_extra_currency", value=str(get_var('brokerage_extra_currency', 'RUB'))),
                        Input(type="hidden", name="advance_to_supplier", value=str(get_var('advance_to_supplier', 100))),

                        style=card_style
                    ),

                    # === PAYMENT TERMS CARD ===
                    Div(
                        Div(
                            Span(icon("credit-card", size=14), style="color: #64748b;"),
                            Span("Условия оплаты", style=section_title_style[len("font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; "):]),
                            style=section_title_style
                        ),
                        # Row: All payment fields inline
                        Div(
                            Span("Аванс клиента", style=field_label_style),
                            Input(name="advance_from_client", type="number", value=str(get_var('advance_from_client', 100)), min="0", max="100", step="1",
                                  style="width: 60px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; text-align: right;"),
                            Span("%", style="margin-left: 4px; color: #64748b; font-size: 14px;"),
                            style=input_row_style
                        ),
                        Div(
                            Span("До аванса", style=field_label_style),
                            Input(name="time_to_advance", type="number", value=str(get_var('time_to_advance', 0)), min="0",
                                  style="width: 60px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; text-align: right;"),
                            Span("дн.", style="margin-left: 4px; color: #64748b; font-size: 14px;"),
                            Span("До расчёта", style=f"{field_label_style} margin-left: 20px; width: 80px;"),
                            Input(name="time_to_advance_on_receiving", type="number", value=str(get_var('time_to_advance_on_receiving', 0)), min="0",
                                  style="width: 60px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; text-align: right;"),
                            Span("дн.", style="margin-left: 4px; color: #64748b; font-size: 14px;"),
                            style=input_row_last_style
                        ),
                        style=card_style
                    ),

                    # === DM FEE CARD ===
                    Div(
                        Div(
                            Span(icon("award", size=14), style="color: #64748b;"),
                            Span("Вознаграждение (LPR)", style=section_title_style[len("font-size: 13px; font-weight: 600; color: #374151; margin: 0 0 12px 0; "):]),
                            style=section_title_style
                        ),
                        Div(
                            Span("Тип", style=field_label_style),
                            Select(
                                Option("Фикс.", value="fixed", selected=get_var('dm_fee_type', 'fixed') == "fixed"),
                                Option("%", value="percentage", selected=get_var('dm_fee_type', '') == "percentage"),
                                name="dm_fee_type",
                                style="width: 70px; padding: 8px 6px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"
                            ),
                            Span("Сумма", style=f"{field_label_style} margin-left: 16px; width: 60px;"),
                            Input(name="dm_fee_value", type="number", value=str(get_var('dm_fee_value', 0)), min="0", step="0.01",
                                  style="width: 80px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; text-align: right;"),
                            Select(
                                Option("RUB", value="RUB", selected=get_var('dm_fee_currency', 'RUB') == "RUB"),
                                Option("USD", value="USD", selected=get_var('dm_fee_currency', '') == "USD"),
                                Option("EUR", value="EUR", selected=get_var('dm_fee_currency', '') == "EUR"),
                                name="dm_fee_currency",
                                style="width: 65px; padding: 8px 6px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; margin-left: 4px;"
                            ),
                            style=input_row_last_style
                        ),
                        Span("Для % — валюта = валюте КП", style="font-size: 11px; color: #94a3b8; margin-top: 4px; display: block;"),
                        style=card_style
                    ),

                    style="flex: 1; min-width: 380px; max-width: 550px;"
                ),

                # Right column: Preview
                Div(
                    Div(
                        Div(
                            Span(icon("eye", size=14), style="color: #64748b;"),
                            Span("Предпросмотр", style="font-size: 13px; font-weight: 600; color: #374151; margin-left: 6px;"),
                            style="display: flex; align-items: center; margin-bottom: 8px;"
                        ),
                        Span("Автообновление при изменении полей", style="font-size: 11px; color: #94a3b8; display: block; margin-bottom: 12px;"),
                        Div(
                            P("Введите данные слева для расчёта", style="margin: 0; font-size: 13px;"),
                            style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); padding: 12px; border-radius: 8px; color: #1e40af;",
                            id="preview-panel"
                        ),
                        btn("Обновить", variant="secondary", icon_name="refresh-cw", type="button", size="sm",
                            hx_post=f"/quotes/{quote_id}/preview",
                            hx_target="#preview-panel",
                            hx_include="closest form",
                            style="margin-top: 12px;"
                        ),
                        style=f"{card_style} position: sticky; top: 16px;"
                    ),
                    style="flex: 1; min-width: 320px;"
                ),

                style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start;"
            ),

            # Hidden fields for version handling
            Input(type="hidden", name="version_action", id="version_action", value="new" if existing_versions else "auto"),
            Input(type="hidden", name="change_reason", id="change_reason", value=""),

            # Version dialog (shown only if versions exist)
            Div(
                Div(
                    # Dialog header
                    Div(
                        icon("git-branch", size=20),
                        Span("Сохранение версии", style="font-size: 16px; font-weight: 600; margin-left: 8px;"),
                        style="display: flex; align-items: center; margin-bottom: 16px;"
                    ),
                    # Current version info
                    Div(
                        Span(f"Текущая версия: v{current_version_num}", style="font-weight: 500;"),
                        style="margin-bottom: 12px; color: #64748b;"
                    ) if current_version_num > 0 else None,
                    # Options
                    Div(
                        # Update option (only if allowed)
                        Div(
                            Input(type="radio", name="version_choice", value="update", id="version_update",
                                  disabled=not can_update,
                                  style="margin-right: 8px;"),
                            Label(
                                f"Обновить версию v{current_version_num}",
                                fr="version_update",
                                style="cursor: pointer;" if can_update else "cursor: not-allowed; color: #9ca3af;"
                            ),
                            Span(" (не создавать новую)", style="font-size: 12px; color: #64748b;"),
                            style="margin-bottom: 8px;"
                        ) if can_update else Div(
                            icon("lock", size=14),
                            Span(update_reason, style="font-size: 13px; color: #dc2626; margin-left: 6px;"),
                            style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px 12px; background: #fef2f2; border-radius: 6px; border: 1px solid #fecaca;"
                        ),
                        # New version option
                        Div(
                            Input(type="radio", name="version_choice", value="new", id="version_new", checked=True,
                                  style="margin-right: 8px;"),
                            Label(
                                f"Создать версию v{current_version_num + 1}",
                                fr="version_new",
                                style="cursor: pointer; font-weight: 500;"
                            ),
                            style="margin-bottom: 12px;"
                        ),
                        style="margin-bottom: 16px;"
                    ),
                    # Change reason (optional)
                    Div(
                        Label("Причина изменения (опционально):", style="font-size: 13px; color: #64748b; display: block; margin-bottom: 6px;"),
                        Input(type="text", id="change_reason_input", placeholder="Скидка по запросу клиента",
                              style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;"),
                        style="margin-bottom: 20px;"
                    ),
                    # Dialog buttons
                    Div(
                        Button("Сохранить", type="button", id="version_dialog_save",
                               style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;"),
                        Button("Отмена", type="button", id="version_dialog_cancel",
                               style="padding: 10px 24px; background: #f1f5f9; color: #374151; border: 1px solid #e2e8f0; border-radius: 6px; margin-left: 8px; cursor: pointer;"),
                        style="display: flex; justify-content: flex-end;"
                    ),
                    style="background: white; padding: 24px; border-radius: 12px; max-width: 420px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);"
                ),
                id="version_dialog",
                style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;"
            ) if existing_versions else None,

            # Actions - compact
            Div(
                btn("Сохранить расчёт", variant="success", icon_name="check", type="button" if existing_versions else "submit",
                    id="save_calc_btn", onclick="showVersionDialog()" if existing_versions else None),
                btn_link("Отмена", href=f"/quotes/{quote_id}", variant="ghost"),
                style="display: flex; gap: 12px; margin-top: 16px; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; border: 1px solid #e2e8f0;"
            ),

            # JavaScript for version dialog
            Script(f"""
                function showVersionDialog() {{
                    document.getElementById('version_dialog').style.display = 'flex';
                }}

                document.addEventListener('DOMContentLoaded', function() {{
                    var dialog = document.getElementById('version_dialog');
                    var saveBtn = document.getElementById('version_dialog_save');
                    var cancelBtn = document.getElementById('version_dialog_cancel');
                    var form = document.querySelector('form[action="/quotes/{quote_id}/calculate"]');

                    if (cancelBtn) {{
                        cancelBtn.addEventListener('click', function() {{
                            dialog.style.display = 'none';
                        }});
                    }}

                    if (saveBtn) {{
                        saveBtn.addEventListener('click', function() {{
                            // Get selected version action
                            var versionChoice = document.querySelector('input[name="version_choice"]:checked');
                            if (versionChoice) {{
                                document.getElementById('version_action').value = versionChoice.value;
                            }}
                            // Get change reason
                            var changeReason = document.getElementById('change_reason_input');
                            if (changeReason) {{
                                document.getElementById('change_reason').value = changeReason.value;
                            }}
                            // Submit the form
                            dialog.style.display = 'none';
                            form.submit();
                        }});
                    }}

                    // Close dialog on backdrop click
                    if (dialog) {{
                        dialog.addEventListener('click', function(e) {{
                            if (e.target === dialog) {{
                                dialog.style.display = 'none';
                            }}
                        }});
                    }}
                }});
            """) if existing_versions else None,

            method="post",
            action=f"/quotes/{quote_id}/calculate",
            hx_post=f"/quotes/{quote_id}/preview",
            hx_target="#preview-panel",
            hx_trigger="input changed delay:500ms from:find input, input changed delay:500ms from:find select"
        ),

        session=session
    )


@rt("/quotes/{quote_id}/calculate")
def post(
    quote_id: str,
    session,
    # Company settings
    seller_company: str = "МАСТЕР БЭРИНГ ООО",
    offer_sale_type: str = "поставка",
    offer_incoterms: str = "DDP",
    # Pricing (note: 'currency' matches form field name)
    currency: str = "RUB",
    markup: str = "15",
    supplier_discount: str = "0",
    exchange_rate: str = "1.0",
    delivery_time: str = "30",
    # Version handling (new fields)
    version_action: str = "auto",  # "auto", "update", "new"
    change_reason: str = "",
    # Logistics
    logistics_supplier_hub: str = "0",
    logistics_hub_customs: str = "0",
    logistics_customs_client: str = "0",
    # Brokerage (values and currencies)
    brokerage_hub: str = "0",
    brokerage_hub_currency: str = "RUB",
    brokerage_customs: str = "0",
    brokerage_customs_currency: str = "RUB",
    warehousing_at_customs: str = "0",
    warehousing_at_customs_currency: str = "RUB",
    customs_documentation: str = "0",
    customs_documentation_currency: str = "RUB",
    brokerage_extra: str = "0",
    brokerage_extra_currency: str = "RUB",
    # Payment terms
    advance_from_client: str = "100",
    advance_to_supplier: str = "100",
    time_to_advance: str = "0",
    time_to_advance_on_receiving: str = "0",
    # DM Fee
    dm_fee_type: str = "fixed",
    dm_fee_value: str = "0",
    dm_fee_currency: str = "RUB",
):
    """Execute full 13-phase calculation engine and save results."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    # Get quote with items
    quote_result = supabase.table("quotes") \
        .select("*") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return page_layout("Error", Div("Quote not found", cls="alert alert-error"), session=session)

    quote = quote_result.data[0]
    # Note: 'currency' comes from form parameter (user's selection on calculate page)
    # Don't override with quote.get("currency") - the form value is what user wants

    # Get items
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()

    items = items_result.data or []

    if not items:
        return page_layout("Error",
            Div("Cannot calculate - no products in quote", cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )

    try:
        # ==========================================================================
        # AGGREGATE LOGISTICS FROM INVOICES (if form values are 0)
        # This ensures invoice-level logistics data flows to calculation even if
        # form fields weren't properly populated
        # ==========================================================================
        form_logistics_supplier_hub = safe_decimal(logistics_supplier_hub)
        form_logistics_hub_customs = safe_decimal(logistics_hub_customs)
        form_logistics_customs_client = safe_decimal(logistics_customs_client)

        print(f"[calc-debug] Form logistics values: S2H={logistics_supplier_hub}, H2C={logistics_hub_customs}, C2C={logistics_customs_client}")
        print(f"[calc-debug] Parsed form values: S2H={form_logistics_supplier_hub}, H2C={form_logistics_hub_customs}, C2C={form_logistics_customs_client}")

        # ==========================================================================
        # AGGREGATE DELIVERY TIME from invoices (logistics_total_days) + items (production_time_days)
        # ==========================================================================
        max_logistics_days = 0
        max_production_days = 0

        # Get max production_time_days from quote_items
        for item in items:
            prod_days = item.get("production_time_days") or 0
            if prod_days > max_production_days:
                max_production_days = prod_days

        # Get max logistics_total_days from invoices
        invoices_days_result = supabase.table("invoices") \
            .select("logistics_total_days") \
            .eq("quote_id", quote_id) \
            .execute()

        for inv in (invoices_days_result.data or []):
            log_days = inv.get("logistics_total_days") or 0
            if log_days > max_logistics_days:
                max_logistics_days = log_days

        # Calculate total delivery time
        aggregated_delivery_time = max_logistics_days + max_production_days
        form_delivery_time = safe_int(delivery_time)

        # Use aggregated value if it's greater than form value
        if aggregated_delivery_time > form_delivery_time:
            effective_delivery_time = aggregated_delivery_time
        else:
            effective_delivery_time = form_delivery_time

        print(f"[calc-debug] Delivery time: max_logistics={max_logistics_days}, max_production={max_production_days}, form={form_delivery_time}, effective={effective_delivery_time}")

        # ALWAYS aggregate logistics from invoices - invoices are the source of truth
        # (form values may be stale from previous calculations with different currency logic)
        print("[calc-debug] Aggregating logistics from invoices...")
        invoices_result = supabase.table("invoices") \
            .select("logistics_supplier_to_hub, logistics_hub_to_customs, logistics_customs_to_customer, "
                    "logistics_supplier_to_hub_currency, logistics_hub_to_customs_currency, logistics_customs_to_customer_currency") \
            .eq("quote_id", quote_id) \
            .execute()

        invoices_logistics = invoices_result.data or []

        # Import convert_amount for use in logistics aggregation and exchange rate calculation
        from services.currency_service import convert_amount

        if invoices_logistics:
            total_logistics_supplier_hub = Decimal(0)
            total_logistics_hub_customs = Decimal(0)
            total_logistics_customs_client = Decimal(0)

            print(f"[calc-debug] Quote currency: {currency}")
            print(f"[calc-debug] Found {len(invoices_logistics)} invoices with logistics data")
            print(f"[calc-debug] Converting all logistics to USD (standard storage currency)")

            for inv in invoices_logistics:
                # Supplier → Hub - convert to USD (standard storage currency)
                s2h_amount = Decimal(str(inv.get("logistics_supplier_to_hub") or 0))
                s2h_currency = inv.get("logistics_supplier_to_hub_currency") or "USD"
                if s2h_amount > 0:
                    converted = convert_amount(s2h_amount, s2h_currency, "USD")
                    print(f"[calc-debug] S2H: {s2h_amount} {s2h_currency} → {converted} USD")
                    total_logistics_supplier_hub += converted

                # Hub → Customs - convert to USD
                h2c_amount = Decimal(str(inv.get("logistics_hub_to_customs") or 0))
                h2c_currency = inv.get("logistics_hub_to_customs_currency") or "USD"
                if h2c_amount > 0:
                    converted = convert_amount(h2c_amount, h2c_currency, "USD")
                    print(f"[calc-debug] H2C: {h2c_amount} {h2c_currency} → {converted} USD")
                    total_logistics_hub_customs += converted

                # Customs → Customer - convert to USD
                c2c_amount = Decimal(str(inv.get("logistics_customs_to_customer") or 0))
                c2c_currency = inv.get("logistics_customs_to_customer_currency") or "USD"
                if c2c_amount > 0:
                    converted = convert_amount(c2c_amount, c2c_currency, "USD")
                    print(f"[calc-debug] C2C: {c2c_amount} {c2c_currency} → {converted} USD")
                    total_logistics_customs_client += converted

            # Use aggregated values (always override form values for logistics)
            print(f"[calc-debug] Aggregated logistics: S2H={total_logistics_supplier_hub}, H2C={total_logistics_hub_customs}, C2C={total_logistics_customs_client}")
            form_logistics_supplier_hub = total_logistics_supplier_hub
            form_logistics_hub_customs = total_logistics_hub_customs
            form_logistics_customs_client = total_logistics_customs_client
            print(f"[calc-debug] Final logistics values: S2H={form_logistics_supplier_hub}, H2C={form_logistics_hub_customs}, C2C={form_logistics_customs_client}")

        # ==========================================================================
        # STORE VALUES IN ORIGINAL CURRENCY (no conversion here)
        # Conversion to USD happens in build_calculation_inputs() before calculation
        # ==========================================================================
        print(f"[calc-debug] Brokerage (original): hub={brokerage_hub} {brokerage_hub_currency}, customs={brokerage_customs} {brokerage_customs_currency}")

        # Build variables from form parameters (store in ORIGINAL currency)
        variables = {
            'currency_of_quote': currency,
            'markup': safe_decimal(markup),
            'supplier_discount': safe_decimal(supplier_discount),
            'offer_incoterms': offer_incoterms,
            'delivery_time': effective_delivery_time,  # Uses MAX(logistics_days + production_days) if greater than form value
            'seller_company': seller_company,
            'offer_sale_type': offer_sale_type,

            # Logistics (stored in USD - aggregated from invoices which are already converted)
            'logistics_supplier_hub': form_logistics_supplier_hub,
            'logistics_hub_customs': form_logistics_hub_customs,
            'logistics_customs_client': form_logistics_customs_client,

            # Brokerage (stored in ORIGINAL currency, converted to USD in build_calculation_inputs)
            'brokerage_hub': safe_decimal(brokerage_hub),
            'brokerage_hub_currency': brokerage_hub_currency,
            'brokerage_customs': safe_decimal(brokerage_customs),
            'brokerage_customs_currency': brokerage_customs_currency,
            'warehousing_at_customs': safe_decimal(warehousing_at_customs),
            'warehousing_at_customs_currency': warehousing_at_customs_currency,
            'customs_documentation': safe_decimal(customs_documentation),
            'customs_documentation_currency': customs_documentation_currency,
            'brokerage_extra': safe_decimal(brokerage_extra),
            'brokerage_extra_currency': brokerage_extra_currency,

            # Payment terms
            'advance_from_client': safe_decimal(advance_from_client),
            'advance_to_supplier': safe_decimal(advance_to_supplier),
            'time_to_advance': safe_int(time_to_advance),
            'time_to_advance_on_receiving': safe_int(time_to_advance_on_receiving),

            # DM Fee (stored in ORIGINAL currency, converted to USD in build_calculation_inputs)
            'dm_fee_type': dm_fee_type,
            'dm_fee_value': safe_decimal(dm_fee_value),
            'dm_fee_currency': dm_fee_currency,

            # Exchange rate
            'exchange_rate': safe_decimal(exchange_rate),
        }

        # Build calculation inputs for all items
        calc_inputs = build_calculation_inputs(items, variables)

        print(f"[calc-debug] Variables passed to calc: logistics_supplier_hub={variables['logistics_supplier_hub']}, logistics_hub_customs={variables['logistics_hub_customs']}, logistics_customs_client={variables['logistics_customs_client']}")
        print(f"[calc-debug] Brokerage: hub={variables['brokerage_hub']}, customs={variables['brokerage_customs']}, warehousing={variables['warehousing_at_customs']}, docs={variables['customs_documentation']}, extra={variables['brokerage_extra']}")

        # Run full 13-phase calculation engine
        results = calculate_multiproduct_quote(calc_inputs)

        # Calculate totals from results
        total_purchase = sum(safe_decimal(r.purchase_price_total_quote_currency) for r in results)
        total_logistics = sum(safe_decimal(r.logistics_total) for r in results)
        print(f"[calc-debug] Calc results: total_purchase={total_purchase}, total_logistics={total_logistics}")
        total_brokerage = (
            safe_decimal(variables['brokerage_hub']) +
            safe_decimal(variables['brokerage_customs']) +
            safe_decimal(variables['warehousing_at_customs']) +
            safe_decimal(variables['customs_documentation']) +
            safe_decimal(variables['brokerage_extra'])
        )
        total_cogs = sum(safe_decimal(r.cogs_per_product) for r in results)
        total_profit = sum(safe_decimal(r.profit) for r in results)
        total_no_vat = sum(safe_decimal(r.sales_price_total_no_vat) for r in results)
        total_with_vat = sum(safe_decimal(r.sales_price_total_with_vat) for r in results)
        total_vat = sum(safe_decimal(r.vat_net_payable) for r in results)
        total_customs = sum(safe_decimal(r.customs_fee) for r in results)

        avg_margin = (total_profit / total_cogs * 100) if total_cogs else Decimal("0")

        # Calculate exchange rate from quote currency to USD for analytics
        if currency == 'USD':
            exchange_rate_to_usd = Decimal("1.0")
        else:
            exchange_rate_to_usd = safe_decimal(convert_amount(Decimal("1"), currency, 'USD'))
            if exchange_rate_to_usd == 0:
                exchange_rate_to_usd = Decimal("1.0")  # Fallback

        # Calculate USD equivalents for analytics
        subtotal_usd = total_purchase * exchange_rate_to_usd
        total_amount_usd = total_with_vat * exchange_rate_to_usd
        total_profit_usd = total_profit * exchange_rate_to_usd

        # Update quote totals (only use columns that exist in quotes table)
        supabase.table("quotes").update({
            "subtotal": float(total_purchase),
            "total_amount": float(total_with_vat),
            "total_profit_usd": float(total_profit_usd),
            # USD analytics columns
            "exchange_rate_to_usd": float(exchange_rate_to_usd),
            "subtotal_usd": float(subtotal_usd),
            "total_amount_usd": float(total_amount_usd),
            "updated_at": datetime.now().isoformat()
        }).eq("id", quote_id).execute()

        # Convert Decimal values to float for JSON storage
        variables_for_storage = {
            k: float(v) if isinstance(v, Decimal) else v
            for k, v in variables.items()
        }

        # Store calculation variables
        variables_record = {
            "quote_id": quote_id,
            "variables": variables_for_storage,
            "updated_at": datetime.now().isoformat()
        }
        existing_vars = supabase.table("quote_calculation_variables") \
            .select("quote_id") \
            .eq("quote_id", quote_id) \
            .execute()
        if existing_vars.data:
            supabase.table("quote_calculation_variables") \
                .update(variables_record) \
                .eq("quote_id", quote_id) \
                .execute()
        else:
            supabase.table("quote_calculation_variables") \
                .insert(variables_record) \
                .execute()

        # Store per-item calculation results (as JSONB)
        for item, result in zip(items, results):
            # Build phase_results JSONB with all calculation outputs
            phase_results = {
                # Purchase prices
                "N16": float(result.purchase_price_no_vat or 0),
                "P16": float(result.purchase_price_after_discount or 0),
                "R16": float(result.purchase_price_per_unit_quote_currency or 0),
                "S16": float(result.purchase_price_total_quote_currency or 0),
                # Logistics
                "T16": float(result.logistics_first_leg or 0),
                "U16": float(result.logistics_last_leg or 0),
                "V16": float(result.logistics_total or 0),
                # Customs and taxes
                "Y16": float(result.customs_fee or 0),
                "Z16": float(result.excise_tax_amount or 0),
                # COGS
                "AA16": float(result.cogs_per_unit or 0),
                "AB16": float(result.cogs_per_product or 0),
                # Sale prices (excl financial)
                "AD16": float(result.sale_price_per_unit_excl_financial or 0),
                "AE16": float(result.sale_price_total_excl_financial or 0),
                # Profit and fees
                "AF16": float(result.profit or 0),
                "AG16": float(result.dm_fee or 0),
                "AH16": float(result.forex_reserve or 0),
                "AI16": float(result.financial_agent_fee or 0),
                # Final sale prices
                "AJ16": float(result.sales_price_per_unit_no_vat or 0),
                "AK16": float(result.sales_price_total_no_vat or 0),
                "AL16": float(result.sales_price_total_with_vat or 0),
                "AM16": float(result.sales_price_per_unit_with_vat or 0),
                # VAT breakdown
                "AN16": float(result.vat_from_sales or 0),
                "AO16": float(result.vat_on_import or 0),
                "AP16": float(result.vat_net_payable or 0),
                # Special
                "AQ16": float(result.transit_commission or 0),
                # Internal pricing
                "AX16": float(result.internal_sale_price_per_unit or 0),
                "AY16": float(result.internal_sale_price_total or 0),
                # Financing
                "BA16": float(result.financing_cost_initial or 0),
                "BB16": float(result.financing_cost_credit or 0),
            }

            # Convert phase_results to USD for analytics
            rate = float(exchange_rate_to_usd)
            phase_results_usd = {k: v * rate for k, v in phase_results.items()}

            item_result = {
                "quote_id": quote_id,
                "quote_item_id": item["id"],
                "phase_results": phase_results,
                "phase_results_usd": phase_results_usd,
                "calculated_at": datetime.now().isoformat()
            }
            existing_result = supabase.table("quote_calculation_results") \
                .select("quote_item_id") \
                .eq("quote_item_id", item["id"]) \
                .execute()
            if existing_result.data:
                supabase.table("quote_calculation_results") \
                    .update(item_result) \
                    .eq("quote_item_id", item["id"]) \
                    .execute()
            else:
                supabase.table("quote_calculation_results") \
                    .insert(item_result) \
                    .execute()

            # Update quote_items with calculated prices
            quantity = item.get("quantity", 1)
            base_price_vat_per_unit = float(result.sales_price_total_with_vat) / quantity if quantity > 0 else 0
            supabase.table("quote_items").update({
                "base_price_vat": base_price_vat_per_unit
            }).eq("id", item["id"]).execute()

        # Store calculation summary (with USD equivalents for analytics)
        rate = float(exchange_rate_to_usd)
        calc_summary = {
            "quote_id": quote_id,
            # Quote currency values
            "calc_s16_total_purchase_price": float(total_purchase),
            "calc_v16_total_logistics": float(total_logistics),
            "calc_y16_customs_duty": float(total_customs),
            "calc_total_brokerage": float(total_brokerage),
            "calc_ae16_sale_price_total": float(total_no_vat),
            "calc_al16_total_with_vat": float(total_with_vat),
            "calc_af16_profit_margin": float(avg_margin),
            # USD equivalents for analytics
            "exchange_rate_to_usd": rate,
            "calc_s16_total_purchase_price_usd": float(total_purchase) * rate,
            "calc_v16_total_logistics_usd": float(total_logistics) * rate,
            "calc_y16_customs_duty_usd": float(total_customs) * rate,
            "calc_total_brokerage_usd": float(total_brokerage) * rate,
            "calc_ae16_sale_price_total_usd": float(total_no_vat) * rate,
            "calc_al16_total_with_vat_usd": float(total_with_vat) * rate,
            "calc_af16_total_profit_usd": float(total_profit) * rate,
            "calculated_at": datetime.now().isoformat()
        }
        existing_summary = supabase.table("quote_calculation_summaries") \
            .select("quote_id") \
            .eq("quote_id", quote_id) \
            .execute()
        if existing_summary.data:
            supabase.table("quote_calculation_summaries") \
                .update(calc_summary) \
                .eq("quote_id", quote_id) \
                .execute()
        else:
            supabase.table("quote_calculation_summaries") \
                .insert(calc_summary) \
                .execute()

        # Update quote currency if it changed
        if quote.get("currency") != currency:
            supabase.table("quotes") \
                .update({"currency": currency}) \
                .eq("id", quote_id) \
                .execute()

        # Handle partial recalculation for price-only changes
        partial_recalc = quote.get("partial_recalc")
        if partial_recalc == "price":
            # Clear partial_recalc flag
            supabase.table("quotes").update({
                "partial_recalc": None
            }).eq("id", quote_id).execute()

            # Transition back to client_negotiation
            user_roles = user.get("roles", [])
            transition_quote_status(
                quote_id=quote_id,
                to_status="client_negotiation",
                actor_id=user["id"],
                actor_roles=user_roles,
                comment="Partial recalculation: price updated, returning to client negotiation"
            )

        # Create or update quote version for audit trail
        all_results = []
        for item, result in zip(items, results):
            all_results.append({
                "item_id": item["id"],
                "N16": float(result.purchase_price_no_vat or 0),
                "S16": float(result.purchase_price_total_quote_currency or 0),
                "V16": float(result.logistics_total or 0),
                "AB16": float(result.cogs_per_product or 0),
                "AJ16": float(result.sales_price_per_unit_no_vat or 0),
                "AK16": float(result.sales_price_total_no_vat or 0),
                "AL16": float(result.sales_price_total_with_vat or 0),
                "AF16": float(result.profit or 0),
            })

        version_totals = {
            "total_purchase": float(total_purchase),
            "total_logistics": float(total_logistics),
            "total_cogs": float(total_cogs),
            "total_profit": float(total_profit),
            "total_no_vat": float(total_no_vat),
            "total_with_vat": float(total_with_vat),
            "avg_margin": float(avg_margin),
        }

        try:
            # Check existing versions and decide action
            existing_versions = list_quote_versions(quote_id, user["org_id"])
            current_version = get_current_quote_version(quote_id, user["org_id"]) if existing_versions else None

            # Determine change reason text
            reason_text = change_reason if change_reason else "Calculation saved"

            if not existing_versions:
                # First version - always create (no dialog shown)
                version = create_quote_version(
                    quote_id=quote_id,
                    user_id=user["id"],
                    variables=variables,
                    items=items,
                    results=all_results,
                    totals=version_totals,
                    change_reason=reason_text,
                    customer_id=quote.get("customer_id")
                )
                version_number = version.get("version") if version else 1

            elif version_action == "update" and current_version:
                # User chose to update existing version
                can_update_flag, _ = can_update_version(quote_id, user["org_id"])
                if can_update_flag:
                    version = update_quote_version(
                        version_id=current_version["id"],
                        quote_id=quote_id,
                        org_id=user["org_id"],
                        user_id=user["id"],
                        variables=variables,
                        items=items,
                        results=all_results,
                        totals=version_totals,
                        change_reason=reason_text
                    )
                    version_number = current_version.get("version_number", 1)
                else:
                    # Can't update, create new instead
                    version = create_quote_version(
                        quote_id=quote_id,
                        user_id=user["id"],
                        variables=variables,
                        items=items,
                        results=all_results,
                        totals=version_totals,
                        change_reason=reason_text,
                        customer_id=quote.get("customer_id")
                    )
                    version_number = version.get("version") if version else None

            else:
                # Create new version (default or user explicitly chose "new")
                version = create_quote_version(
                    quote_id=quote_id,
                    user_id=user["id"],
                    variables=variables,
                    items=items,
                    results=all_results,
                    totals=version_totals,
                    change_reason=reason_text,
                    customer_id=quote.get("customer_id")
                )
                version_number = version.get("version") if version else None

        except Exception as ve:
            # Version creation is optional - don't fail calculation
            version_number = None
            print(f"Warning: Failed to create version: {ve}")

        # Build detailed results page
        product_rows = []
        for item, result in zip(items, results):
            product_rows.append(
                Tr(
                    Td(item.get('product_name', 'Product')[:40]),
                    Td(str(item.get('quantity', 1))),
                    Td(format_money(result.cogs_per_unit, currency)),
                    Td(format_money(result.sales_price_per_unit_no_vat, currency)),
                    Td(format_money(result.sales_price_total_with_vat, currency)),
                    Td(format_money(result.profit, currency)),
                )
            )

        return page_layout(f"Calculation Results - {quote.get('idn_quote', '')}",
            Div("Calculation completed and saved!", cls="alert alert-success"),

            H1(f"Results for {quote.get('idn_quote', '')}"),

            # Summary stats
            Div(
                Div(
                    Div("Total (excl VAT)", style="font-size: 0.875rem; color: #666;"),
                    Div(format_money(total_no_vat, currency), cls="stat-value"),
                    cls="stat-card"
                ),
                Div(
                    Div("Total (incl VAT)", style="font-size: 0.875rem; color: #666;"),
                    Div(format_money(total_with_vat, currency), cls="stat-value", style="color: #28a745;"),
                    cls="stat-card"
                ),
                Div(
                    Div("Total Profit", style="font-size: 0.875rem; color: #666;"),
                    Div(format_money(total_profit, currency), cls="stat-value"),
                    cls="stat-card"
                ),
                Div(
                    Div("Avg Margin", style="font-size: 0.875rem; color: #666;"),
                    Div(f"{avg_margin:.1f}%", cls="stat-value"),
                    cls="stat-card"
                ),
                cls="stats-grid"
            ),

            # Cost breakdown
            Div(
                H3("Cost Breakdown"),
                Table(
                    Tr(Td("Products Purchase Total:"), Td(format_money(total_purchase, currency))),
                    Tr(Td("Logistics Total:"), Td(format_money(total_logistics, currency))),
                    Tr(Td("Brokerage Total:"), Td(format_money(total_brokerage, currency))),
                    Tr(Td("Total COGS:"), Td(format_money(total_cogs, currency))),
                    Tr(Td(Strong("VAT Payable:")), Td(Strong(format_money(total_vat, currency)))),
                ),
                cls="card"
            ),

            # Product details
            Div(
                H3("Product Details"),
                Table(
                    Thead(
                        Tr(
                            Th("Product"),
                            Th("Qty"),
                            Th("COGS/unit"),
                            Th("Price/unit"),
                            Th("Total"),
                            Th("Profit"),
                        )
                    ),
                    Tbody(*product_rows),
                    Tfoot(
                        Tr(
                            Td(Strong("TOTAL"), colspan="4"),
                            Td(Strong(format_money(total_with_vat, currency))),
                            Td(Strong(format_money(total_profit, currency))),
                        )
                    ),
                ),
                cls="card"
            ),

            # Variables used
            Div(
                H3("Calculation Variables"),
                Table(
                    Tr(Td("Markup:"), Td(f"{variables['markup']}%")),
                    Tr(Td("Incoterms:"), Td(variables['offer_incoterms'])),
                    Tr(Td("Delivery Time:"), Td(f"{variables['delivery_time']} days")),
                    Tr(Td("Client Advance:"), Td(f"{variables['advance_from_client']}%")),
                    Tr(Td("Exchange Rate:"), Td(str(variables['exchange_rate']))),
                ),
                cls="card"
            ),

            # Actions
            Div(
                btn_link("Back to Quote", href=f"/quotes/{quote_id}", variant="secondary", icon_name="arrow-left"),
                btn_link("Recalculate", href=f"/quotes/{quote_id}/calculate", variant="primary", icon_name="calculator"),
                cls="form-actions"
            ),

            session=session
        )

    except Exception as e:
        import traceback
        traceback.print_exc()
        return page_layout("Calculation Error",
            Div(f"Error: {str(e)}", cls="alert alert-error"),
            btn_link("Back", href=f"/quotes/{quote_id}/calculate", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# QUOTE DOCUMENTS TAB
# ============================================================================

@rt("/quotes/{quote_id}/documents")
def get(quote_id: str, session):
    """View documents tab for a quote with hierarchical binding support"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]
    user_roles = get_session_user_roles(session)

    supabase = get_supabase()

    # Get quote details
    quote_result = supabase.table("quotes") \
        .select("id, idn_quote, customer_id, status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            Div("Запрошенное КП не существует или у вас нет доступа.", cls="card"),
            A("← К списку КП", href="/quotes"),
            session=session
        )

    quote = quote_result.data[0]
    quote_number = quote.get("idn_quote") or quote_id[:8]

    # Get customer name
    customer_name = "—"
    if quote.get("customer_id"):
        customer_result = supabase.table("customers") \
            .select("name") \
            .eq("id", quote["customer_id"]) \
            .execute()
        if customer_result.data:
            customer_name = customer_result.data[0].get("name", "—")

    # Get supplier invoices for this quote (for invoice binding dropdown)
    invoices = []
    try:
        # First get quote item IDs
        quote_items_result = supabase.table("quote_items") \
            .select("id") \
            .eq("quote_id", quote_id) \
            .execute()

        quote_item_ids = [item["id"] for item in (quote_items_result.data or [])]

        if quote_item_ids:
            # Get invoice items linked to this quote's items
            invoice_items_result = supabase.table("supplier_invoice_items") \
                .select("invoice_id") \
                .in_("quote_item_id", quote_item_ids) \
                .execute()

            if invoice_items_result.data:
                invoice_ids = list(set(item["invoice_id"] for item in invoice_items_result.data if item.get("invoice_id")))
                if invoice_ids:
                    invoices_result = supabase.table("supplier_invoices") \
                        .select("id, invoice_number, supplier_id") \
                        .in_("id", invoice_ids) \
                        .order("invoice_date", desc=True) \
                        .execute()

                    if invoices_result.data:
                        # Get supplier names
                        supplier_ids = list(set(inv["supplier_id"] for inv in invoices_result.data if inv.get("supplier_id")))
                        suppliers_map = {}
                        if supplier_ids:
                            suppliers_result = supabase.table("suppliers") \
                                .select("id, name") \
                                .in_("id", supplier_ids) \
                                .execute()
                            suppliers_map = {s["id"]: s["name"] for s in (suppliers_result.data or [])}

                        for inv in invoices_result.data:
                            invoices.append({
                                "id": inv["id"],
                                "invoice_number": inv.get("invoice_number", ""),
                                "supplier_name": suppliers_map.get(inv.get("supplier_id"), "")
                            })
    except Exception as e:
        print(f"Error fetching invoices for quote documents: {e}")

    # Get quote items (for certificate binding dropdown)
    items = []
    try:
        items_result = supabase.table("quote_items") \
            .select("id, product_name, product_code, brand") \
            .eq("quote_id", quote_id) \
            .order("position") \
            .execute()

        if items_result.data:
            for item in items_result.data:
                items.append({
                    "id": item["id"],
                    "name": item.get("product_name", "Товар"),
                    "sku": item.get("product_code", ""),
                    "brand": item.get("brand", "")
                })
    except Exception as e:
        print(f"Error fetching items for quote documents: {e}")

    # Determine permissions based on roles
    can_upload = user_has_any_role(session, ["admin", "sales", "sales_manager", "procurement", "quote_controller", "finance", "logistics", "customs"])
    can_delete = user_has_any_role(session, ["admin", "sales_manager", "quote_controller", "finance"])

    # Get total documents count (all related to this quote)
    doc_count = count_all_documents_for_quote(quote_id)

    return page_layout(
        f"Документы КП {quote_number}",

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "documents", user_roles),

        # Header with modern styling
        Div(
            Div(
                icon("folder", size=24, color="#1e40af"),
                H1(f" Документы КП {quote_number}",
                   style="display: inline; margin: 0; margin-left: 8px; font-size: 1.5rem;"),
                style="display: flex; align-items: center;"
            ),
            P(f"Клиент: {customer_name}", style="color: #64748b; margin-top: 0.5rem;"),
            style="margin-bottom: 1.5rem;"
        ),

        # Info card with gradient styling
        Div(
            P(
                icon("info", size=16, color="#3b82f6"),
                " Здесь можно загружать и просматривать все документы по КП: документы самого КП, сканы инвойсов и сертификаты на товары.",
                style="display: flex; align-items: flex-start; gap: 0.5rem; margin: 0; color: #64748b; font-size: 0.875rem;"
            ),
            cls="card",
            style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6; margin-bottom: 1.5rem; padding: 1rem; border-radius: 8px;"
        ),

        # Documents section with hierarchical binding
        _quote_documents_section(
            quote_id=quote_id,
            session=session,
            invoices=invoices,
            items=items,
            can_upload=can_upload,
            can_delete=can_delete
        ),

        # Back button
        Div(
            A(icon("arrow-left", size=16), " К обзору КП", href=f"/quotes/{quote_id}",
              style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none;"),
            style="margin-top: 2rem;"
        ),

        session=session
    )


# ============================================================================
# VERSION HISTORY ROUTES
# ============================================================================

@rt("/quotes/{quote_id}/versions")
def get(quote_id: str, session):
    """View version history for a quote"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    # Get quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not quote_result.data:
        return page_layout("Not Found", H1("Quote not found"), session=session)

    quote = quote_result.data[0]
    currency = quote.get("currency", "USD")

    # Get versions
    versions = list_quote_versions(quote_id, user["org_id"])

    # Build version rows
    version_rows = []
    for v in versions:
        version_rows.append(
            Tr(
                Td(f"v{v['version_number']}"),
                Td(v.get("status", "draft")),
                Td(format_money(v.get("total_quote_currency"), currency)),
                Td(v.get("change_reason", "-")),
                Td(v.get("created_at", "")[:16].replace("T", " ")),
                Td(
                    A("View", href=f"/quotes/{quote_id}/versions/{v['version_number']}", style="margin-right: 0.5rem;"),
                ),
            )
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    table_style = """
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    """

    th_style = """
        padding: 14px 16px;
        text-align: left;
        background: #f8fafc;
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        border-bottom: 1px solid #e2e8f0;
    """

    td_style = "padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155;"

    return page_layout(f"История версий - {quote.get('idn_quote', '')}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), " Назад к КП", href=f"/quotes/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1(f"История версий",
               style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            Div(
                Span(icon("file-text", size=14), style="color: #64748b;"),
                Span(f"КП: {quote.get('idn_quote', '-')}", style="color: #475569; font-weight: 500;"),
                Span(" • ", style="color: #cbd5e1;"),
                Span(f"Клиент: {quote.get('customers', {}).get('name', '-')}", style="color: #64748b;"),
                style="display: flex; align-items: center; gap: 8px; font-size: 14px;"
            ),
            style=header_style
        ),

        # Versions table
        Table(
            Thead(
                Tr(
                    Th("Версия", style=th_style),
                    Th("Статус", style=th_style),
                    Th("Сумма", style=th_style),
                    Th("Причина изменения", style=th_style),
                    Th("Создана", style=th_style),
                    Th("", style=th_style),
                )
            ),
            Tbody(
                *[Tr(
                    Td(f"v{v['version_number']}", style=f"{td_style} font-weight: 600;"),
                    Td(
                        Span(v.get("status", "draft"),
                             style=f"padding: 4px 10px; border-radius: 12px; font-size: 12px; "
                                   f"background: {'#dcfce7' if v.get('status') == 'approved' else '#fef3c7' if v.get('status') == 'sent' else '#f1f5f9'}; "
                                   f"color: {'#166534' if v.get('status') == 'approved' else '#92400e' if v.get('status') == 'sent' else '#475569'};"),
                        style=td_style
                    ),
                    Td(format_money(v.get("total_quote_currency"), currency), style=f"{td_style} font-weight: 500;"),
                    Td(v.get("change_reason") or "-", style=f"{td_style} color: #64748b;"),
                    Td(v.get("created_at", "")[:16].replace("T", " "), style=f"{td_style} color: #64748b; font-size: 13px;"),
                    Td(
                        A(icon("eye", size=14), " Просмотр", href=f"/quotes/{quote_id}/versions/{v['version_number']}",
                          style="color: #3b82f6; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 4px;"),
                        style=td_style
                    ),
                ) for v in versions]
            ) if version_rows else Tbody(
                Tr(Td("Версий пока нет. Запустите расчёт для создания первой версии.",
                      colspan="6", style=f"{td_style} text-align: center; color: #94a3b8; padding: 40px;"))
            ),
            style=table_style
        ),

        # Action buttons
        Div(
            A(icon("arrow-left", size=14), " К КП", href=f"/quotes/{quote_id}",
              style="padding: 10px 16px; background: #f1f5f9; color: #475569; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
            A(icon("calculator", size=14), " Новый расчёт", href=f"/quotes/{quote_id}/calculate",
              style="padding: 10px 16px; background: #3b82f6; color: white; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
            style="margin-top: 20px; display: flex; gap: 12px;"
        ),

        session=session
    )


@rt("/quotes/{quote_id}/versions/{version_num}")
def get(quote_id: str, version_num: int, session):
    """View specific version details"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    # Get version
    version = get_quote_version(quote_id, version_num, user["org_id"])

    if not version:
        return page_layout("Not Found", H1("Version not found"), session=session)

    # Get quote for context
    supabase = get_supabase()
    quote_result = supabase.table("quotes") \
        .select("idn_quote, currency") \
        .eq("id", quote_id) \
        .execute()

    quote = quote_result.data[0] if quote_result.data else {}
    currency = quote.get("currency", "USD")

    # Build products from snapshot
    products = version.get("products_snapshot", [])
    results = version.get("calculation_results", [])

    product_rows = []
    for i, p in enumerate(products):
        r = results[i] if i < len(results) else {}
        product_rows.append(
            Tr(
                Td(p.get("product_name", "-")[:40]),
                Td(str(p.get("quantity", 1))),
                Td(format_money(r.get("AJ16"), currency)),
                Td(format_money(r.get("AL16"), currency)),
                Td(format_money(r.get("AF16"), currency)),
            )
        )

    # Get variables
    variables = version.get("quote_variables", {})

    return page_layout(f"Version {version_num} - {quote.get('idn_quote', '')}",
        # Gradient header card
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#64748b"),
                    Span("К истории версий", style="margin-left: 6px;"),
                    href=f"/quotes/{quote_id}/versions",
                    style="display: inline-flex; align-items: center; color: #64748b; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("history", size=24, color="#6366f1"),
                    Span(f"Версия {version_num}", style="font-size: 24px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    status_badge(version.get("status", "draft")),
                    style="display: flex; align-items: center; gap: 12px;"
                ),
                Div(
                    Span(f"КП: {quote.get('idn_quote', '-')}", style="color: #64748b; font-size: 14px;"),
                    style="margin-top: 4px;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Two column layout
        Div(
            # Left column - Version Info & Variables
            Div(
                # Version metadata card
                Div(
                    Div(
                        icon("info", size=16, color="#64748b"),
                        Span("ИНФОРМАЦИЯ О ВЕРСИИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                    ),
                    Div(
                        Div(
                            Span("Дата создания", style="font-size: 12px; color: #64748b; display: block; margin-bottom: 4px;"),
                            Span(version.get("created_at", "")[:16].replace("T", " "), style="font-size: 14px; font-weight: 500; color: #1e293b;"),
                            style="margin-bottom: 16px;"
                        ),
                        Div(
                            Span("Причина изменения", style="font-size: 12px; color: #64748b; display: block; margin-bottom: 4px;"),
                            Span(version.get("change_reason", "-") or "-", style="font-size: 14px; font-weight: 500; color: #1e293b;"),
                            style="margin-bottom: 16px;"
                        ),
                        Div(
                            Span("Итого по версии", style="font-size: 12px; color: #64748b; display: block; margin-bottom: 4px;"),
                            Span(format_money(version.get("total_quote_currency"), currency), style="font-size: 18px; font-weight: 600; color: #059669;"),
                        ),
                    ),
                    style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
                ),

                # Variables snapshot card
                Div(
                    Div(
                        icon("sliders", size=16, color="#64748b"),
                        Span("ПАРАМЕТРЫ РАСЧЁТА", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                    ),
                    Div(
                        *[
                            Div(
                                Span(label, style="font-size: 12px; color: #64748b;"),
                                Span(value, style="font-size: 14px; font-weight: 500; color: #1e293b;"),
                                style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9;"
                            )
                            for label, value in [
                                ("Наценка", f"{variables.get('markup', '-')}%"),
                                ("Инкотермс", variables.get('offer_incoterms', '-') or '-'),
                                ("Срок поставки", f"{variables.get('delivery_time', '-')} дн."),
                                ("Аванс от клиента", f"{variables.get('advance_from_client', '-')}%"),
                                ("Курс обмена", str(variables.get('exchange_rate', '-'))),
                            ]
                        ],
                    ),
                    style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
                ),
                style="flex: 1; min-width: 280px;"
            ),

            # Right column - Products
            Div(
                Div(
                    Div(
                        icon("package", size=16, color="#64748b"),
                        Span("ТОВАРЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        Span(f"{len(products)}", style="background: #e0e7ff; color: #4f46e5; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-left: 8px;"),
                        style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                    ),
                    Div(
                        Table(
                            Thead(
                                Tr(
                                    Th("Товар", style="text-align: left; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"),
                                    Th("Кол-во", style="text-align: center; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"),
                                    Th("Цена/ед.", style="text-align: right; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"),
                                    Th("Итого", style="text-align: right; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"),
                                    Th("Прибыль", style="text-align: right; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"),
                                )
                            ),
                            Tbody(
                                *[
                                    Tr(
                                        Td(p.get("product_name", "-")[:40], style="padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"),
                                        Td(str(p.get("quantity", 1)), style="text-align: center; padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"),
                                        Td(format_money((results[i] if i < len(results) else {}).get("AJ16"), currency), style="text-align: right; padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"),
                                        Td(format_money((results[i] if i < len(results) else {}).get("AL16"), currency), style="text-align: right; padding: 12px 16px; font-size: 14px; font-weight: 500; color: #1e293b; border-bottom: 1px solid #f1f5f9;"),
                                        Td(format_money((results[i] if i < len(results) else {}).get("AF16"), currency), style="text-align: right; padding: 12px 16px; font-size: 14px; font-weight: 500; color: #059669; border-bottom: 1px solid #f1f5f9;"),
                                    )
                                    for i, p in enumerate(products)
                                ] if products else [
                                    Tr(Td("Нет товаров", colspan="5", style="padding: 24px; text-align: center; color: #94a3b8;"))
                                ]
                            ),
                            style="width: 100%; border-collapse: collapse;"
                        ),
                        style="overflow-x: auto;"
                    ),
                    style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
                ),
                style="flex: 2; min-width: 400px;"
            ),
            style="display: flex; gap: 24px; flex-wrap: wrap;"
        ),

        # Action buttons
        Div(
            btn_link("История версий", href=f"/quotes/{quote_id}/versions", variant="secondary", icon_name="history"),
            btn_link("К КП", href=f"/quotes/{quote_id}", variant="primary", icon_name="file-text"),
            style="margin-top: 24px; display: flex; gap: 12px;"
        ),

        session=session
    )


# ============================================================================
# EXPORT ROUTES
# ============================================================================

@rt("/quotes/{quote_id}/export/specification")
def get(quote_id: str, session):
    """Export Specification PDF - uses contract-style template matching DOCX"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    try:
        # First, check if a specification exists for this quote
        from services.specification_service import get_specification_by_quote
        spec = get_specification_by_quote(quote_id, org_id)

        if spec:
            # Use new contract-style template (matches DOCX)
            from services.contract_spec_export import generate_contract_spec_pdf
            pdf_bytes, spec_number = generate_contract_spec_pdf(str(spec.id), org_id)
            safe_spec_number = "".join(c if c.isalnum() or c in "-_" else "_" for c in str(spec_number))
            filename = f"Specification_{safe_spec_number}.pdf"
        else:
            # Fallback to old template if no specification exists yet
            data = fetch_export_data(quote_id, org_id)
            pdf_bytes = generate_specification_pdf(data)
            customer_name = data.customer.get('company_name') or data.customer.get('name') or ''
            filename = build_export_filename(
                doc_type="specification",
                customer_name=customer_name,
                quote_number=data.quote.get('quote_number', ''),
                ext="pdf"
            )

        # Return as file download
        from starlette.responses import Response
        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={"Content-Disposition": f'attachment; filename="{filename}"'}
        )
    except ValueError as e:
        return page_layout("Export Error",
            Div(str(e), cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )
    except Exception as e:
        return page_layout("Export Error",
            Div(f"Failed to generate PDF: {str(e)}", cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )


@rt("/quotes/{quote_id}/export/invoice")
def get(quote_id: str, session):
    """Export Invoice PDF (Счет на оплату)"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    try:
        # Fetch all export data
        data = fetch_export_data(quote_id, user["org_id"])

        # Generate PDF
        pdf_bytes = generate_invoice_pdf(data)

        # Return as file download
        from starlette.responses import Response
        customer_name = data.customer.get('company_name') or data.customer.get('name') or ''
        filename = build_export_filename(
            doc_type="invoice",
            customer_name=customer_name,
            quote_number=data.quote.get('quote_number', ''),
            ext="pdf"
        )
        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={"Content-Disposition": f'attachment; filename="{filename}"'}
        )
    except ValueError as e:
        return page_layout("Export Error",
            Div(str(e), cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )
    except Exception as e:
        return page_layout("Export Error",
            Div(f"Failed to generate PDF: {str(e)}", cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )


@rt("/quotes/{quote_id}/export/validation")
def get(quote_id: str, session):
    """Export Validation Excel spreadsheet"""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    try:
        # Fetch all export data
        data = fetch_export_data(quote_id, user["org_id"])

        # Generate Excel
        excel_bytes = create_validation_excel(data)

        # Return as file download (XLSM with macros)
        from starlette.responses import Response
        filename = f"validation_{data.quote.get('quote_number', quote_id)}.xlsm"
        return Response(
            content=excel_bytes,
            media_type="application/vnd.ms-excel.sheet.macroEnabled.12",
            headers={"Content-Disposition": f'attachment; filename="{filename}"'}
        )
    except ValueError as e:
        return page_layout("Export Error",
            Div(str(e), cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )
    except Exception as e:
        return page_layout("Export Error",
            Div(f"Failed to generate Excel: {str(e)}", cls="alert alert-error"),
            A("← Back", href=f"/quotes/{quote_id}"),
            session=session
        )


# ============================================================================
# SETTINGS PAGE
# ============================================================================

@rt("/settings")
def get(session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    # Only admins can access settings
    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Настройки доступны только администраторам. Используйте раздел 'Профиль' для управления своими данными."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            btn_link("Мой профиль", href="/profile", variant="primary", icon_name="user"),
            session=session
        )

    supabase = get_supabase()

    # Get organization settings
    org_result = supabase.table("organizations") \
        .select("*") \
        .eq("id", user["org_id"]) \
        .execute()

    org = org_result.data[0] if org_result.data else {}

    # Get calculation settings
    calc_result = supabase.table("calculation_settings") \
        .select("*") \
        .eq("organization_id", user["org_id"]) \
        .execute()

    calc_settings = calc_result.data[0] if calc_result.data else {}

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
        margin-bottom: 20px;
    """

    input_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 100%;
        box-sizing: border-box;
    """

    label_style = "display: block; font-size: 13px; color: #475569; margin-bottom: 6px; font-weight: 500;"

    form_group_style = "margin-bottom: 16px;"

    grid_2col_style = "display: grid; grid-template-columns: 1fr 1fr; gap: 20px;"

    return page_layout("Настройки",
        # Header card
        Div(
            H1("Настройки организации",
               style="margin: 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            P(f"Организация: {org.get('name', '—')}",
              style="margin: 8px 0 0 0; font-size: 14px; color: #64748b;"),
            style=header_style
        ),

        # Organization info
        Div(
            Div(icon("building", size=14), " Информация об организации", style=section_header_style),
            Div(
                Label("Название организации", style=label_style),
                Input(name="name", value=org.get("name", ""), readonly=True,
                      style=f"{input_style} background: #f1f5f9; color: #64748b;"),
                Small("Для изменения реквизитов организации обратитесь к администратору",
                      style="color: #94a3b8; font-size: 12px; margin-top: 6px; display: block;"),
                style=form_group_style
            ),
            style=form_card_style
        ),

        # Calculation defaults
        Form(
            Div(
                Div(icon("calculator", size=14), " Настройки расчётов", style=section_header_style),
                Div(
                    Div(
                        Label("Риск курса валют (%)", style=label_style),
                        Input(name="rate_forex_risk", type="number", value=str(calc_settings.get("rate_forex_risk", 3)),
                              step="0.1", min="0", max="20", style=input_style),
                        style=form_group_style
                    ),
                    Div(
                        Label("Финансовая комиссия (%)", style=label_style),
                        Input(name="rate_fin_comm", type="number", value=str(calc_settings.get("rate_fin_comm", 2)),
                              step="0.1", min="0", max="20", style=input_style),
                        style=form_group_style
                    ),
                    style=grid_2col_style
                ),
                Div(
                    Label("Ставка кредита (% в день)", style=label_style),
                    Input(name="rate_loan_interest_daily", type="number",
                          value=str(round(calc_settings.get("rate_loan_interest_daily", 0.05), 6)),
                          step="any", min="0", max="1", style=f"{input_style} max-width: 300px;"),
                    style=form_group_style
                ),
                Button(icon("check", size=14), " Сохранить настройки", type="submit",
                       style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                style=form_card_style
            ),
            method="post",
            action="/settings"
        ),

        # Telegram settings link
        Div(
            Div(icon("message-circle", size=14), " Telegram", style=section_header_style),
            P("Привяжите Telegram для получения уведомлений о задачах и согласованиях.",
              style="color: #64748b; margin: 0 0 16px 0; font-size: 14px;"),
            A(icon("message-circle", size=14), " Настройки Telegram", href="/settings/telegram",
              style="padding: 10px 20px; background: #3b82f6; color: white; border-radius: 6px; font-size: 14px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;"),
            style=form_card_style
        ),

        session=session
    )


@rt("/settings")
def post(rate_forex_risk: float, rate_fin_comm: float, rate_loan_interest_daily: float, session):
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    supabase = get_supabase()

    try:
        # Check if settings exist
        existing = supabase.table("calculation_settings") \
            .select("organization_id") \
            .eq("organization_id", user["org_id"]) \
            .execute()

        settings_data = {
            "organization_id": user["org_id"],
            "rate_forex_risk": rate_forex_risk,
            "rate_fin_comm": rate_fin_comm,
            "rate_loan_interest_daily": rate_loan_interest_daily,
            "updated_at": datetime.now().isoformat()
        }

        if existing.data:
            supabase.table("calculation_settings") \
                .update(settings_data) \
                .eq("organization_id", user["org_id"]) \
                .execute()
        else:
            supabase.table("calculation_settings") \
                .insert(settings_data) \
                .execute()

        return page_layout("Settings",
            Div("Settings saved successfully!", cls="alert alert-success"),
            Script("setTimeout(() => window.location.href = '/settings', 1500);"),
            session=session
        )

    except Exception as e:
        return page_layout("Settings Error",
            Div(f"Error: {str(e)}", cls="alert alert-error"),
            A("← Back", href="/settings"),
            session=session
        )


# ============================================================================
# TELEGRAM SETTINGS PAGE (Feature #56)
# ============================================================================

@rt("/settings/telegram")
def get(session):
    """Telegram settings page for account linking.

    Feature #56: UI генерации кода верификации

    This page allows users to:
    - See their current Telegram connection status
    - Generate a verification code to link their Telegram account
    - Unlink their Telegram account
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    # Get current Telegram status
    status = get_user_telegram_status(user["id"])

    # Build status display
    if status.is_verified:
        # Account is linked and verified
        status_card = Div(
            Div(
                Span(icon("check-circle", size=32), style="color: #22c55e;"),
                H3("Telegram привязан", style="margin: 0.5rem 0;"),
                cls="text-center"
            ),
            Table(
                Tr(
                    Td("Аккаунт:", style="font-weight: 500; padding: 0.5rem;"),
                    Td(f"@{status.telegram_username}" if status.telegram_username else "—",
                       style="padding: 0.5rem;")
                ),
                Tr(
                    Td("Telegram ID:", style="font-weight: 500; padding: 0.5rem;"),
                    Td(Code(str(status.telegram_id)) if status.telegram_id else "—",
                       style="padding: 0.5rem;")
                ),
                Tr(
                    Td("Привязан:", style="font-weight: 500; padding: 0.5rem;"),
                    Td(status.verified_at[:10] if status.verified_at else "—",
                       style="padding: 0.5rem;")
                ),
                style="width: 100%; margin: 1rem 0;"
            ),
            P(icon("bell", size=16), " Вы будете получать уведомления о задачах и согласованиях в Telegram.",
              style="color: #166534; background: #dcfce7; padding: 0.75rem; border-radius: 8px; margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;"),
            Form(
                btn("Отвязать Telegram", variant="danger", icon_name="unlink", type="submit", name="action", value="unlink"),
                P("Внимание: после отвязки вы перестанете получать уведомления.",
                  style="color: #666; font-size: 0.875rem; margin-top: 0.5rem;"),
                method="post",
                action="/settings/telegram",
                style="margin-top: 1.5rem; text-align: center;"
            ),
            cls="card",
            style="padding: 1.5rem; max-width: 400px; margin: 0 auto;"
        )
    elif status.verification_code:
        # Has pending verification code
        status_card = Div(
            Div(
                Span(icon("clock", size=32), style="color: #f59e0b;"),
                H3("Ожидание верификации", style="margin: 0.5rem 0;"),
                cls="text-center"
            ),
            Div(
                P("Ваш код верификации:", style="margin-bottom: 0.5rem; color: #666;"),
                Div(
                    Code(status.verification_code,
                         style="font-size: 2rem; letter-spacing: 0.3rem; padding: 0.75rem 1.5rem; background: #f3f4f6; border-radius: 8px; display: inline-block;"),
                    style="text-align: center; margin: 1rem 0;"
                ),
                P(f"Код действителен до: {status.code_expires_at[:16].replace('T', ' ')}" if status.code_expires_at else "",
                  style="color: #666; font-size: 0.875rem; text-align: center;"),
                style="margin: 1rem 0;"
            ),
            Div(
                H4(icon("smartphone", size=18), " Как привязать:", style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;"),
                Ol(
                    Li("Откройте Telegram и найдите бота"),
                    Li("Отправьте боту команду /start"),
                    Li(f"Введите код: {status.verification_code}"),
                    style="padding-left: 1.25rem; line-height: 1.8;"
                ),
                style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-top: 1rem;"
            ),
            Form(
                btn("Получить новый код", variant="primary", icon_name="refresh-cw", type="submit", name="action", value="new_code"),
                method="post",
                action="/settings/telegram",
                style="margin-top: 1rem; text-align: center;"
            ),
            cls="card",
            style="padding: 1.5rem; max-width: 400px; margin: 0 auto;"
        )
    else:
        # Not linked, show button to get code
        status_card = Div(
            Div(
                Span(icon("smartphone", size=32), style="color: #3b82f6;"),
                H3("Telegram не привязан", style="margin: 0.5rem 0;"),
                cls="text-center"
            ),
            P("Привяжите Telegram-аккаунт, чтобы получать уведомления о:",
              style="margin: 1rem 0;"),
            Ul(
                Li(icon("bell", size=16), " Новых задачах на проверку", style="display: flex; align-items: center; gap: 0.5rem;"),
                Li(icon("check-circle", size=16), " Согласованиях коммерческих предложений", style="display: flex; align-items: center; gap: 0.5rem;"),
                Li(icon("file-text", size=16), " Изменениях статуса заявок", style="display: flex; align-items: center; gap: 0.5rem;"),
                Li(icon("alert-triangle", size=16), " Возвратах на доработку", style="display: flex; align-items: center; gap: 0.5rem;"),
                style="list-style: none; padding: 0; line-height: 1.8;"
            ),
            Form(
                btn("Получить код привязки", variant="primary", icon_name="link", type="submit", name="action", value="new_code"),
                method="post",
                action="/settings/telegram",
                style="margin-top: 1.5rem; text-align: center;"
            ),
            cls="card",
            style="padding: 1.5rem; max-width: 400px; margin: 0 auto;"
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    return page_layout("Настройки Telegram",
        Div(
            # Header card
            Div(
                Div(
                    A(icon("arrow-left", size=16), " Назад к настройкам", href="/settings",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                    style="margin-bottom: 12px;"
                ),
                H1("Привязка Telegram",
                   style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
                P("Получайте уведомления и согласовывайте КП прямо в Telegram",
                  style="margin: 0; font-size: 14px; color: #64748b;"),
                style=header_style
            ),
            status_card,
            style="max-width: 600px; margin: 0 auto;"
        ),
        session=session
    )


@rt("/settings/telegram")
def post(action: str, session):
    """Handle Telegram settings form submissions.

    Actions:
    - new_code: Generate a new verification code
    - unlink: Remove the Telegram link
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    if action == "new_code":
        # Request a new verification code
        code = request_verification_code(user["id"])
        if code:
            return page_layout("Код создан",
                Div(
                    Div(
                        Span(icon("check-circle", size=48), style="color: #16a34a;"),
                        H2("Код верификации создан!", style="margin: 1rem 0;"),
                        cls="text-center"
                    ),
                    Div(
                        Code(code,
                             style="font-size: 2.5rem; letter-spacing: 0.4rem; padding: 1rem 2rem; background: #dcfce7; border-radius: 8px; display: inline-block; color: #166534;"),
                        style="text-align: center; margin: 1.5rem 0;"
                    ),
                    P("Код действителен 30 минут.",
                      style="color: #666; text-align: center;"),
                    Div(
                        H4(icon("smartphone", size=18), " Следующие шаги:", style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;"),
                        Ol(
                            Li("Откройте Telegram"),
                            Li("Найдите нашего бота"),
                            Li(f"Отправьте команду: /start {code}"),
                            Li("Готово! Аккаунт будет привязан автоматически."),
                            style="padding-left: 1.25rem; line-height: 1.8;"
                        ),
                        style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;"
                    ),
                    A("← Назад к настройкам Telegram", href="/settings/telegram",
                      style="display: block; text-align: center; margin-top: 1.5rem; color: #3b82f6;"),
                    cls="card",
                    style="padding: 2rem; max-width: 450px; margin: 0 auto;"
                ),
                session=session
            )
        else:
            # Already verified or error
            status = get_user_telegram_status(user["id"])
            if status.is_verified:
                return page_layout("Уже привязан",
                    Div(
                        Span(icon("info", size=32), style="color: #3b82f6;"),
                        H2("Telegram уже привязан", style="margin: 0.5rem 0;"),
                        P("Ваш аккаунт уже связан с Telegram. Если хотите привязать другой аккаунт, сначала отвяжите текущий.",
                          style="color: #666;"),
                        A("← Назад к настройкам Telegram", href="/settings/telegram",
                          style="display: inline-block; margin-top: 1rem; color: #3b82f6;"),
                        cls="card text-center",
                        style="padding: 2rem; max-width: 400px; margin: 0 auto;"
                    ),
                    session=session
                )
            else:
                return page_layout("Ошибка",
                    Div(
                        Div(icon("x-circle", size=18), " Не удалось создать код верификации. Попробуйте позже.",
                            cls="alert alert-error"),
                        A("← Назад", href="/settings/telegram",
                          style="display: inline-block; margin-top: 1rem; color: #3b82f6;"),
                    ),
                    session=session
                )

    elif action == "unlink":
        # Unlink Telegram account
        success = unlink_telegram_account(user["id"])
        if success:
            return page_layout("Telegram отвязан",
                Div(
                    Div(
                        Span(icon("check-circle", size=32), style="color: #22c55e;"),
                        H2("Telegram успешно отвязан", style="margin: 0.5rem 0;"),
                        P("Вы больше не будете получать уведомления в Telegram. Вы можете привязать аккаунт снова в любое время.",
                          style="color: #666;"),
                        A("← Назад к настройкам Telegram", href="/settings/telegram",
                          style="display: inline-block; margin-top: 1rem; color: #3b82f6;"),
                        cls="card text-center",
                        style="padding: 2rem; max-width: 400px; margin: 0 auto;"
                    ),
                ),
                session=session
            )
        else:
            return page_layout("Ошибка",
                Div(
                    Div(icon("x-circle", size=18), " Не удалось отвязать Telegram. Попробуйте позже.",
                        cls="alert alert-error"),
                    A("← Назад", href="/settings/telegram",
                      style="display: inline-block; margin-top: 1rem; color: #3b82f6;"),
                ),
                session=session
            )

    # Unknown action - redirect back
    return RedirectResponse("/settings/telegram", status_code=303)


# ============================================================================
# PROCUREMENT WORKSPACE (Feature #33)
# ============================================================================

def workflow_status_badge(status_str: str):
    """
    Create a styled badge for workflow status.
    Uses workflow service colors and names.
    """
    try:
        status = WorkflowStatus(status_str) if status_str else None
    except ValueError:
        status = None

    if status:
        name = STATUS_NAMES_SHORT.get(status, status_str)
        # Convert Tailwind classes to inline styles for non-Tailwind environment
        color_map = {
            WorkflowStatus.DRAFT: ("#f3f4f6", "#1f2937"),
            WorkflowStatus.PENDING_PROCUREMENT: ("#fef3c7", "#92400e"),
            WorkflowStatus.PENDING_LOGISTICS: ("#dbeafe", "#1e40af"),
            WorkflowStatus.PENDING_CUSTOMS: ("#e9d5ff", "#6b21a8"),
            WorkflowStatus.PENDING_SALES_REVIEW: ("#ffedd5", "#9a3412"),
            WorkflowStatus.PENDING_QUOTE_CONTROL: ("#fce7f3", "#9d174d"),
            WorkflowStatus.PENDING_APPROVAL: ("#fef3c7", "#b45309"),
            WorkflowStatus.APPROVED: ("#dcfce7", "#166534"),
            WorkflowStatus.SENT_TO_CLIENT: ("#cffafe", "#0e7490"),
            WorkflowStatus.CLIENT_NEGOTIATION: ("#ccfbf1", "#115e59"),
            WorkflowStatus.PENDING_SPEC_CONTROL: ("#e0e7ff", "#3730a3"),
            WorkflowStatus.PENDING_SIGNATURE: ("#ede9fe", "#5b21b6"),
            WorkflowStatus.DEAL: ("#d1fae5", "#065f46"),
            WorkflowStatus.REJECTED: ("#fee2e2", "#991b1b"),
            WorkflowStatus.CANCELLED: ("#f5f5f4", "#57534e"),
        }
        bg, text = color_map.get(status, ("#f3f4f6", "#1f2937"))
        return Span(name, style=f"display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; background: {bg}; color: {text};")

    return Span(status_str or "—", cls="status-badge")


def workflow_progress_bar(status_str: str):
    """
    Create a visual workflow progress bar showing the current stage of a quote.

    Feature #87: Прогресс-бар workflow на КП

    Shows workflow stages as a horizontal bar with steps:
    1. Черновик (draft)
    2. Закупки (procurement)
    3. Лог + Там (logistics + customs parallel)
    4. Продажи (sales review)
    5. Контроль (quote control)
    6. Согласование (approval)
    7. Клиент (sent/negotiation)
    8. Спецификация (spec control)
    9. Сделка (deal)

    For rejected/cancelled shows a different indicator.
    """
    try:
        status = WorkflowStatus(status_str) if status_str else None
    except ValueError:
        status = None

    if not status:
        return Div()

    # Handle final negative states separately
    if status == WorkflowStatus.REJECTED:
        return Div(
            Span(icon("x-circle", size=18), " Отклонено", style="color: #dc2626; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;"),
            style="padding: 0.75rem 1rem; background: #fef2f2; border-radius: 8px; border-left: 4px solid #dc2626; margin: 0.5rem 0;"
        )
    if status == WorkflowStatus.CANCELLED:
        return Div(
            Span(icon("ban", size=18), " Отменено", style="color: #57534e; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;"),
            style="padding: 0.75rem 1rem; background: #f5f5f4; border-radius: 8px; border-left: 4px solid #78716c; margin: 0.5rem 0;"
        )

    # Define workflow stages in order (main path)
    # Some stages are parallel (logistics + customs) - we show them as one combined step
    stages = [
        ("draft", "Черновик", [WorkflowStatus.DRAFT]),
        ("procurement", "Закупки", [WorkflowStatus.PENDING_PROCUREMENT]),
        ("logistics_customs", "Лог+Там", [WorkflowStatus.PENDING_LOGISTICS, WorkflowStatus.PENDING_CUSTOMS]),
        ("sales", "Продажи", [WorkflowStatus.PENDING_SALES_REVIEW]),
        ("control", "Контроль", [WorkflowStatus.PENDING_QUOTE_CONTROL]),
        ("approval", "Согласование", [WorkflowStatus.PENDING_APPROVAL, WorkflowStatus.APPROVED]),
        ("client", "Клиент", [WorkflowStatus.SENT_TO_CLIENT, WorkflowStatus.CLIENT_NEGOTIATION]),
        ("spec", "Спец-я", [WorkflowStatus.PENDING_SPEC_CONTROL, WorkflowStatus.PENDING_SIGNATURE]),
        ("deal", "Сделка", [WorkflowStatus.DEAL]),
    ]

    # Find current stage index
    current_stage_idx = -1
    for idx, (stage_id, name, statuses) in enumerate(stages):
        if status in statuses:
            current_stage_idx = idx
            break

    # Build progress bar
    steps = []
    for idx, (stage_id, name, statuses) in enumerate(stages):
        is_current = status in statuses
        is_completed = idx < current_stage_idx
        is_future = idx > current_stage_idx

        # Determine step styling
        if is_completed:
            # Completed step - green
            circle_style = "background: #22c55e; color: white; border: 2px solid #22c55e;"
            text_style = "color: #22c55e; font-weight: 500;"
            step_icon = "✓"
        elif is_current:
            # Current step - blue with pulse animation
            circle_style = "background: #3b82f6; color: white; border: 2px solid #3b82f6; animation: pulse 2s infinite;"
            text_style = "color: #3b82f6; font-weight: 600;"
            step_icon = str(idx + 1)
        else:
            # Future step - gray
            circle_style = "background: #e5e7eb; color: #9ca3af; border: 2px solid #e5e7eb;"
            text_style = "color: #9ca3af;"
            step_icon = str(idx + 1)

        # Connector line (not for first step)
        connector = None
        if idx > 0:
            line_color = "#22c55e" if is_completed or is_current else "#e5e7eb"
            connector = Div(
                style=f"flex: 1; height: 2px; background: {line_color}; margin: 0 -2px;"
            )

        step = Div(
            # Circle with number or checkmark
            Div(
                step_icon,
                style=f"width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; {circle_style}"
            ),
            # Label
            Div(name, style=f"font-size: 11px; margin-top: 4px; text-align: center; white-space: nowrap; {text_style}"),
            style="display: flex; flex-direction: column; align-items: center; min-width: 50px;"
        )

        if connector:
            steps.append(Div(connector, style="display: flex; align-items: center; flex: 1; padding-bottom: 20px;"))
        steps.append(step)

    # CSS for pulse animation
    pulse_animation = Style("""
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
        }
    """)

    return Div(
        pulse_animation,
        Div(
            *steps,
            style="display: flex; align-items: flex-start; justify-content: space-between; width: 100%; padding: 0.5rem 0;"
        ),
        style="background: #f9fafb; border-radius: 8px; padding: 1rem; margin: 0.5rem 0; overflow-x: auto;"
    )


def workflow_transition_history(quote_id: str, limit: int = 20, collapsed: bool = True):
    """
    Create a UI component showing the workflow transition history for a quote.

    Feature #88: Просмотр истории переходов

    Shows an audit log of all status changes with:
    - From/to status (with colored badges)
    - Who made the transition (actor)
    - When it happened
    - Any comments/reasons

    Args:
        quote_id: UUID of the quote
        limit: Max number of transitions to show (default 20)
        collapsed: If True, history is collapsed by default with toggle button

    Returns:
        FastHTML Div component with transition history
    """
    from datetime import datetime

    # Get transition history
    history = get_quote_transition_history(quote_id, limit=limit)

    if not history:
        if collapsed:
            return Div()  # Don't show anything if no history and collapsed mode
        return Div(
            H4(icon("history", size=18), " История переходов", style="margin: 0 0 0.5rem; display: flex; align-items: center; gap: 0.5rem;"),
            P("История переходов пуста", style="color: #666; font-size: 0.875rem;"),
            cls="card",
            style="background: #f9fafb;"
        )

    # Format timestamp
    def format_date(date_str):
        if not date_str:
            return "—"
        try:
            dt = datetime.fromisoformat(date_str.replace("Z", "+00:00"))
            return dt.strftime("%d.%m.%Y %H:%M")
        except:
            return date_str[:16] if date_str else "—"

    # Build transition rows
    def transition_row(record, is_first=False):
        from_status = record.get("from_status", "—")
        to_status = record.get("to_status", "—")
        from_name = record.get("from_status_name", from_status)
        to_name = record.get("to_status_name", to_status)
        comment = record.get("comment", "")
        actor_role = record.get("actor_role", "")
        created_at = format_date(record.get("created_at"))

        # Get colors for status badges
        def get_badge_colors(status_str):
            try:
                status = WorkflowStatus(status_str) if status_str else None
            except ValueError:
                status = None

            color_map = {
                WorkflowStatus.DRAFT: ("#f3f4f6", "#1f2937"),
                WorkflowStatus.PENDING_PROCUREMENT: ("#fef3c7", "#92400e"),
                WorkflowStatus.PENDING_LOGISTICS: ("#dbeafe", "#1e40af"),
                WorkflowStatus.PENDING_CUSTOMS: ("#e9d5ff", "#6b21a8"),
                WorkflowStatus.PENDING_SALES_REVIEW: ("#ffedd5", "#9a3412"),
                WorkflowStatus.PENDING_QUOTE_CONTROL: ("#fce7f3", "#9d174d"),
                WorkflowStatus.PENDING_APPROVAL: ("#fef3c7", "#b45309"),
                WorkflowStatus.APPROVED: ("#dcfce7", "#166534"),
                WorkflowStatus.SENT_TO_CLIENT: ("#cffafe", "#0e7490"),
                WorkflowStatus.CLIENT_NEGOTIATION: ("#ccfbf1", "#115e59"),
                WorkflowStatus.PENDING_SPEC_CONTROL: ("#e0e7ff", "#3730a3"),
                WorkflowStatus.PENDING_SIGNATURE: ("#ede9fe", "#5b21b6"),
                WorkflowStatus.DEAL: ("#d1fae5", "#065f46"),
                WorkflowStatus.REJECTED: ("#fee2e2", "#991b1b"),
                WorkflowStatus.CANCELLED: ("#f5f5f4", "#57534e"),
            }
            if status:
                return color_map.get(status, ("#f3f4f6", "#1f2937"))
            return ("#f3f4f6", "#1f2937")

        from_bg, from_text = get_badge_colors(from_status)
        to_bg, to_text = get_badge_colors(to_status)

        # Role name translation
        role_names = {
            "sales": "Продажи",
            "procurement": "Закупки",
            "logistics": "Логистика",
            "customs": "Таможня",
            "quote_controller": "Контролёр КП",
            "spec_controller": "Контролёр спец.",
            "finance": "Финансы",
            "top_manager": "Руководство",
            "admin": "Админ",
            "system": "Система",
        }
        role_display = role_names.get(actor_role, actor_role) if actor_role else "—"

        return Div(
            # Timeline dot and line
            Div(
                # Dot
                Div(
                    style=f"width: 10px; height: 10px; border-radius: 50%; background: {'#3b82f6' if is_first else '#cbd5e1'}; margin-top: 5px;"
                ),
                # Line (except for last item)
                Div(style="width: 2px; flex: 1; background: #e5e7eb; margin-left: 4px;"),
                style="display: flex; flex-direction: column; align-items: center; margin-right: 12px;"
            ),
            # Content
            Div(
                # Header: timestamp and role
                Div(
                    Span(created_at, style="font-size: 0.75rem; color: #666;"),
                    Span(f" • {role_display}", style="font-size: 0.75rem; color: #9ca3af;") if role_display != "—" else None,
                    style="margin-bottom: 4px;"
                ),
                # Status transition
                Div(
                    Span(from_name, style=f"display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: {from_bg}; color: {from_text};"),
                    Span(" → ", style="margin: 0 6px; color: #9ca3af;"),
                    Span(to_name, style=f"display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: {to_bg}; color: {to_text};"),
                    style="margin-bottom: 4px;"
                ),
                # Comment if exists
                Div(
                    Span(f"💬 {comment}", style="font-size: 0.8rem; color: #4b5563; font-style: italic;"),
                    style="margin-top: 4px;"
                ) if comment else None,
                style="flex: 1; padding-bottom: 12px;"
            ),
            style="display: flex; align-items: stretch;"
        )

    # Build history list
    history_items = [transition_row(record, idx == 0) for idx, record in enumerate(history)]

    # Container ID for toggle functionality
    container_id = f"transition-history-{quote_id[:8]}"

    if collapsed:
        # Collapsible version with toggle button
        return Div(
            # Toggle button
            Div(
                btn(f"История переходов ({len(history)})", variant="secondary", icon_name="history", type="button", size="sm",
                    onclick=f"document.getElementById('{container_id}').classList.toggle('hidden');"),
                style="margin-bottom: 0.5rem;"
            ),
            # Hidden history container
            Div(
                *history_items,
                id=container_id,
                cls="hidden",  # Hidden by default
                style="padding: 0.75rem; background: #fafafa; border-radius: 8px; border: 1px solid #e5e7eb;"
            ),
            # CSS for hidden class
            Style("""
                .hidden { display: none; }
            """),
            style="margin: 0.5rem 0;"
        )
    else:
        # Always visible version
        return Div(
            H4(icon("history", size=18), " История переходов", style="margin: 0 0 0.75rem; display: flex; align-items: center; gap: 0.5rem;"),
            Div(
                *history_items,
                style="padding: 0.75rem; background: #fafafa; border-radius: 8px; border: 1px solid #e5e7eb;"
            ),
            cls="card",
            style="background: #f9fafb;"
        )




def quote_detail_tabs(quote_id: str, active_tab: str, user_roles: list):
    """
    Create role-based tab navigation for quote detail pages.

    Shows tabs based on user roles:
    - overview: all users with access to quote
    - procurement: procurement, admin
    - logistics: logistics, head_of_logistics, admin
    - customs: customs, head_of_customs, admin
    - control: quote_controller, admin

    Args:
        quote_id: UUID of the quote
        active_tab: Current active tab (overview, procurement, logistics, customs, control)
        user_roles: List of user roles

    Returns:
        Tab navigation component
    """
    # Define tabs with role requirements
    tabs_config = [
        {
            "id": "overview",
            "label": "Продажи",
            "icon": "shopping-bag",
            "href": f"/quotes/{quote_id}",
            "roles": None,  # All users with quote access
        },
        {
            "id": "procurement",
            "label": "Закупки",
            "icon": "shopping-cart",
            "href": f"/procurement/{quote_id}",
            "roles": ["procurement", "admin"],
        },
        {
            "id": "logistics",
            "label": "Логистика",
            "icon": "truck",
            "href": f"/logistics/{quote_id}",
            "roles": ["logistics", "head_of_logistics", "admin"],
        },
        {
            "id": "customs",
            "label": "Таможня",
            "icon": "shield-check",
            "href": f"/customs/{quote_id}",
            "roles": ["customs", "head_of_customs", "admin"],
        },
        {
            "id": "control",
            "label": "Контроль",
            "icon": "check-circle",
            "href": f"/quote-control/{quote_id}",
            "roles": ["quote_controller", "admin"],
        },
        {
            "id": "documents",
            "label": "Документы",
            "icon": "folder",
            "href": f"/quotes/{quote_id}/documents",
            "roles": None,  # All users with quote access
        },
    ]

    # Filter tabs based on user roles
    visible_tabs = []
    for tab in tabs_config:
        if tab["roles"] is None:
            visible_tabs.append(tab)
        elif any(r in user_roles for r in tab["roles"]):
            visible_tabs.append(tab)

    # Build tab elements
    tab_elements = []
    for tab in visible_tabs:
        is_active = tab["id"] == active_tab

        # Styling for active vs inactive
        if is_active:
            tab_style = """
                display: flex; align-items: center; gap: 0.5rem;
                padding: 0.75rem 1.25rem;
                background: #3b82f6; color: white;
                border-radius: 8px 8px 0 0;
                font-weight: 600; font-size: 0.9rem;
                text-decoration: none;
                border-bottom: 3px solid #1d4ed8;
            """
        else:
            tab_style = """
                display: flex; align-items: center; gap: 0.5rem;
                padding: 0.75rem 1.25rem;
                background: #f3f4f6; color: #4b5563;
                border-radius: 8px 8px 0 0;
                font-size: 0.9rem;
                text-decoration: none;
                transition: all 0.2s;
            """

        tab_elements.append(
            A(
                icon(tab["icon"], size=18),
                Span(tab["label"]),
                href=tab["href"],
                style=tab_style,
                cls="quote-detail-tab" + (" active" if is_active else "")
            )
        )

    # Return tabs container with hover style
    return Div(
        Style("""
            .quote-detail-tab:hover:not(.active) {
                background: #e5e7eb !important;
                color: #1f2937 !important;
            }
        """),
        Div(
            *tab_elements,
            style="display: flex; gap: 0.25rem; border-bottom: 1px solid #e5e7eb; margin-bottom: 1.5rem;"
        )
    )

# ============================================================================
# USER PROFILE PAGE
# ============================================================================

@rt("/profile")
def get(session):
    """User profile page - view and edit own profile."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    supabase = get_supabase()

    from services.user_profile_service import (
        get_departments, get_sales_groups, get_organization_users
    )

    # Get user profile
    profile_result = supabase.table("user_profiles").select(
        "*, departments(name), sales_groups(name)"
    ).eq("user_id", user_id).eq("organization_id", org_id).limit(1).execute()

    if profile_result.data:
        profile = profile_result.data[0]
    else:
        profile = {
            "full_name": "", "position": "", "phone": "",
            "date_of_birth": None, "hire_date": None, "location": "",
            "timezone": "Europe/Moscow", "bio": "",
            "department_id": None, "sales_group_id": None, "manager_id": None
        }

    # Get Telegram status
    tg_result = supabase.table("telegram_users").select(
        "telegram_id, telegram_username, verified_at"
    ).eq("user_id", user_id).limit(1).execute()

    tg_linked, tg_display = False, "—"
    if tg_result.data and tg_result.data[0].get("verified_at"):
        tg_linked = True
        tg_data = tg_result.data[0]
        tg_display = f"@{tg_data.get('telegram_username') or tg_data.get('telegram_id')}"

    departments = get_departments(org_id)
    sales_groups = get_sales_groups(org_id)
    users = get_organization_users(org_id)

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    section_card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
        margin-bottom: 20px;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    return page_layout("Мой профиль",
        # Header card with gradient
        Div(
            Div(
                btn_link("", href="/dashboard", variant="secondary", icon_name="arrow-left",
                         style="padding: 8px 12px; margin-right: 12px;"),
                Div(
                    icon("user", size=24, color="#475569"),
                    Span(" Мой профиль", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                    style="display: flex; align-items: center;"
                ),
                style="display: flex; align-items: center;"
            ),
            style=header_card_style
        ),

        Form(
            # Section 1: Personal info
            Div(
                Div(
                    icon("user", size=16, color="#64748b"),
                    Span(" ЛИЧНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("ФИО *", style=label_style),
                        Input(name="full_name", value=profile.get("full_name") or "", placeholder="Иванов Иван Иванович", required=True, style=input_style),
                        style="flex: 2;"
                    ),
                    Div(
                        Label("Email", style=label_style),
                        Input(value=user.get("email", "—"), readonly=True, disabled=True, style=f"{input_style} background: #f1f5f9; cursor: not-allowed;"),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Телефон", style=label_style),
                        Input(name="phone", type="tel", value=profile.get("phone") or "", placeholder="+7 (999) 123-45-67", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Дата рождения", style=label_style),
                        Input(name="date_of_birth", type="date", value=profile.get("date_of_birth") or "", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Label("Telegram", style=label_style),
                    Div(
                        Span(tg_display, style=f"color: {'#10b981' if tg_linked else '#9ca3af'}; font-weight: 500;"),
                        Small(" (привязан)" if tg_linked else " (не привязан)", style="color: #64748b; margin-left: 4px;"),
                        A(" → Настроить" if not tg_linked else " → Изменить", href="/settings/telegram", style="margin-left: 8px; font-size: 13px; color: #3b82f6;"),
                        style="display: flex; align-items: center; padding: 10px 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;"
                    ),
                ),
                style=section_card_style
            ),

            # Section 2: Organization
            Div(
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span(" ОРГАНИЗАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Должность", style=label_style),
                        Input(name="position", value=profile.get("position") or "", placeholder="Менеджер по продажам", style=input_style),
                        style="flex: 2;"
                    ),
                    Div(
                        Label("Дата приема", style=label_style),
                        Input(name="hire_date", type="date", value=profile.get("hire_date") or "", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Департамент", style=label_style),
                        Select(Option("— Не выбрано —", value="", selected=not profile.get("department_id")),
                            *[Option(dept["name"], value=dept["id"], selected=dept["id"] == profile.get("department_id")) for dept in departments],
                            name="department_id", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Группа продаж", style=label_style),
                        Select(Option("— Не выбрано —", value="", selected=not profile.get("sales_group_id")),
                            *[Option(sg["name"], value=sg["id"], selected=sg["id"] == profile.get("sales_group_id")) for sg in sales_groups],
                            name="sales_group_id", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Label("Руководитель", style=label_style),
                    Select(Option("— Не выбрано —", value="", selected=not profile.get("manager_id")),
                        *[Option(u["full_name"], value=u["id"], selected=u["id"] == profile.get("manager_id")) for u in users if u.get("full_name")],
                        name="manager_id", style=input_style),
                ),
                style=section_card_style
            ),

            # Section 3: Settings
            Div(
                Div(
                    icon("settings", size=16, color="#64748b"),
                    Span(" НАСТРОЙКИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Часовой пояс", style=label_style),
                        Select(
                            Option("Europe/Moscow (МСК, UTC+3)", value="Europe/Moscow", selected=profile.get("timezone") == "Europe/Moscow" or not profile.get("timezone")),
                            Option("Asia/Shanghai (CST, UTC+8)", value="Asia/Shanghai", selected=profile.get("timezone") == "Asia/Shanghai"),
                            Option("Asia/Hong_Kong (HKT, UTC+8)", value="Asia/Hong_Kong", selected=profile.get("timezone") == "Asia/Hong_Kong"),
                            Option("Asia/Dubai (GST, UTC+4)", value="Asia/Dubai", selected=profile.get("timezone") == "Asia/Dubai"),
                            Option("Europe/Istanbul (TRT, UTC+3)", value="Europe/Istanbul", selected=profile.get("timezone") == "Europe/Istanbul"),
                            name="timezone", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Офис/локация", style=label_style),
                        Input(name="location", value=profile.get("location") or "", placeholder="Москва, офис на Тверской", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px;"
                ),
                style=section_card_style
            ),

            # Section 4: Bio
            Div(
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span(" О СЕБЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    style=section_header_style
                ),
                Label("Биография", style=label_style),
                Textarea(profile.get("bio") or "", name="bio", rows="4", placeholder="Расскажите немного о себе, своем опыте, интересах...",
                         style=f"{input_style} resize: vertical;"),
                style=section_card_style
            ),

            # Actions
            Div(
                btn("Сохранить изменения", variant="primary", icon_name="save", type="submit"),
                btn_link("Отмена", href="/dashboard", variant="secondary", icon_name="x"),
                style="display: flex; gap: 12px; justify-content: flex-end;"
            ),
            method="post", action="/profile"
        ),
        session=session)


@rt("/profile")
def post(session, full_name: str, phone: str = "", date_of_birth: str = "",
         position: str = "", hire_date: str = "", department_id: str = "",
         sales_group_id: str = "", manager_id: str = "", timezone: str = "Europe/Moscow",
         location: str = "", bio: str = ""):
    """Save user profile."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    from services.user_profile_service import update_user_profile

    update_data = {
        "full_name": full_name.strip() if full_name else None,
        "phone": phone.strip() if phone else None,
        "date_of_birth": date_of_birth if date_of_birth else None,
        "position": position.strip() if position else None,
        "hire_date": hire_date if hire_date else None,
        "department_id": department_id if department_id else None,
        "sales_group_id": sales_group_id if sales_group_id else None,
        "manager_id": manager_id if manager_id else None,
        "timezone": timezone,
        "location": location.strip() if location else None,
        "bio": bio.strip() if bio else None
    }

    success = update_user_profile(user["id"], user["org_id"], **update_data)

    if success:
        return page_layout("Профиль сохранен",
            Div(Div("Профиль успешно обновлен!", cls="alert alert-success"),
                Script("setTimeout(() => window.location.href = '/profile', 1500);")),
            session=session)
    else:
        return page_layout("Ошибка",
            Div(Div("Не удалось сохранить профиль. Попробуйте позже.", cls="alert alert-error"),
                btn_link("Назад к профилю", href="/profile", variant="secondary", icon_name="arrow-left")),
            session=session)


@rt("/profile/{user_id}")
def get(session, user_id: str):
    """Admin view/edit other user's profile."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user, roles = session["user"], session["user"].get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён", H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"), session=session)

    supabase = get_supabase()
    from services.user_profile_service import get_departments, get_sales_groups, get_organization_users

    profile_result = supabase.table("user_profiles").select("*, departments(name), sales_groups(name)")        .eq("user_id", user_id).eq("organization_id", user["org_id"]).limit(1).execute()

    profile = profile_result.data[0] if profile_result.data else {
        "full_name": "", "position": "", "phone": "", "date_of_birth": None,
        "hire_date": None, "location": "", "timezone": "Europe/Moscow", "bio": "",
        "department_id": None, "sales_group_id": None, "manager_id": None
    }

    # Get email via RPC
    try:
        email_result = supabase.rpc("get_user_profile_data", {"p_user_id": user_id, "p_organization_id": user["org_id"]}).execute()
        target_email = email_result.data[0].get("email") if email_result.data else "—"
    except:
        target_email = "—"

    # Get Telegram status
    tg_result = supabase.table("telegram_users").select("telegram_id, telegram_username, verified_at").eq("user_id", user_id).limit(1).execute()
    tg_linked, tg_display = False, "—"
    if tg_result.data and tg_result.data[0].get("verified_at"):
        tg_linked, tg_data = True, tg_result.data[0]
        tg_display = f"@{tg_data.get('telegram_username') or tg_data.get('telegram_id')}"

    departments = get_departments(user["org_id"])
    sales_groups = get_sales_groups(user["org_id"])
    users = get_organization_users(user["org_id"])

    return page_layout(f"Профиль пользователя",
        H1(icon("user", size=28), f" Профиль: {profile.get('full_name') or 'Пользователь'}", cls="page-header"),
        Div(Span("👨‍💼 Режим администратора", style="font-weight: 600; color: #ef4444;"),
            Span(" — вы можете редактировать этот профиль", style="color: #666; font-size: 0.875rem;"),
            cls="alert alert-info", style="background: #fef3c7; border-color: #fbbf24;"),
        Form(
            Div(H3("Личная информация"),
                Div(Label("ФИО *", Input(name="full_name", value=profile.get("full_name") or "", placeholder="Иванов Иван Иванович", required=True)),
                    Label("Email", Input(value=target_email, readonly=True, disabled=True, style="background: #f3f4f6; cursor: not-allowed;")),
                    cls="form-row"),
                Div(Label("Телефон", Input(name="phone", type="tel", value=profile.get("phone") or "", placeholder="+7 (999) 123-45-67")),
                    Label("Дата рождения", Input(name="date_of_birth", type="date", value=profile.get("date_of_birth") or "")),
                    cls="form-row"),
                Div(Label("Telegram", Div(Span(tg_display, style=f"color: {'#10b981' if tg_linked else '#9ca3af'};"),
                        Small(" (привязан, редактирование недоступно)" if tg_linked else " (не привязан)", style="color: #666;"),
                        style="display: flex; align-items: center; padding: 0.5rem; background: #f9fafb; border-radius: 4px;")),
                    cls="form-row"),
                cls="card"),
            Div(H3("Организация"),
                Div(Label("Должность", Input(name="position", value=profile.get("position") or "", placeholder="Менеджер по продажам")),
                    Label("Дата приема на работу", Input(name="hire_date", type="date", value=profile.get("hire_date") or "")),
                    cls="form-row"),
                Div(Label("Департамент", Select(Option("— Не выбрано —", value="", selected=not profile.get("department_id")),
                        *[Option(dept["name"], value=dept["id"], selected=dept["id"] == profile.get("department_id")) for dept in departments], name="department_id")),
                    Label("Группа продаж", Select(Option("— Не выбрано —", value="", selected=not profile.get("sales_group_id")),
                        *[Option(sg["name"], value=sg["id"], selected=sg["id"] == profile.get("sales_group_id")) for sg in sales_groups], name="sales_group_id")),
                    cls="form-row"),
                Div(Label("Руководитель", Select(Option("— Не выбрано —", value="", selected=not profile.get("manager_id")),
                        *[Option(u["full_name"], value=u["id"], selected=u["id"] == profile.get("manager_id")) for u in users if u.get("full_name") and u["id"] != user_id], name="manager_id")),
                    cls="form-row"),
                cls="card"),
            Div(H3("Настройки"),
                Div(Label("Часовой пояс", Select(
                        Option("Europe/Moscow (МСК, UTC+3)", value="Europe/Moscow", selected=profile.get("timezone") == "Europe/Moscow" or not profile.get("timezone")),
                        Option("Asia/Shanghai (CST, UTC+8)", value="Asia/Shanghai", selected=profile.get("timezone") == "Asia/Shanghai"),
                        Option("Asia/Hong_Kong (HKT, UTC+8)", value="Asia/Hong_Kong", selected=profile.get("timezone") == "Asia/Hong_Kong"),
                        Option("Asia/Dubai (GST, UTC+4)", value="Asia/Dubai", selected=profile.get("timezone") == "Asia/Dubai"),
                        Option("Europe/Istanbul (TRT, UTC+3)", value="Europe/Istanbul", selected=profile.get("timezone") == "Europe/Istanbul"),
                        name="timezone")),
                    Label("Офис/локация", Input(name="location", value=profile.get("location") or "", placeholder="Москва, офис на Тверской")),
                    cls="form-row"),
                cls="card"),
            Div(H3("О себе"),
                Label("Биография", Textarea(profile.get("bio") or "", name="bio", rows="4", placeholder="Расскажите немного о себе, своем опыте, интересах...")),
                cls="card"),
            Div(btn("Сохранить изменения", variant="primary", icon_name="save", type="submit"),
                btn_link("К списку пользователей", href="/admin", variant="secondary", icon_name="arrow-left"),
                cls="form-actions"),
            method="post", action=f"/profile/{user_id}"),
        session=session)


@rt("/profile/{user_id}")
def post(session, user_id: str, full_name: str, phone: str = "", date_of_birth: str = "",
         position: str = "", hire_date: str = "", department_id: str = "",
         sales_group_id: str = "", manager_id: str = "", timezone: str = "Europe/Moscow",
         location: str = "", bio: str = ""):
    """Admin save other user's profile."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user, roles = session["user"], session["user"].get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён", H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"), session=session)

    from services.user_profile_service import update_user_profile

    update_data = {
        "full_name": full_name.strip() if full_name else None,
        "phone": phone.strip() if phone else None,
        "date_of_birth": date_of_birth if date_of_birth else None,
        "position": position.strip() if position else None,
        "hire_date": hire_date if hire_date else None,
        "department_id": department_id if department_id else None,
        "sales_group_id": sales_group_id if sales_group_id else None,
        "manager_id": manager_id if manager_id else None,
        "timezone": timezone,
        "location": location.strip() if location else None,
        "bio": bio.strip() if bio else None
    }

    success = update_user_profile(user_id, user["org_id"], **update_data)

    if success:
        return page_layout("Профиль сохранен",
            Div(Div("Профиль успешно обновлен!", cls="alert alert-success"),
                Script(f"setTimeout(() => window.location.href = '/profile/{user_id}', 1500);")),
            session=session)
    else:
        return page_layout("Ошибка",
            Div(Div("Не удалось сохранить профиль. Попробуйте позже.", cls="alert alert-error"),
                btn_link("Назад к профилю", href=f"/profile/{user_id}", variant="secondary", icon_name="arrow-left")),
            session=session)

@rt("/procurement")
def get(session, status_filter: str = None):
    """
    Redirect to unified dashboard procurement tab.
    Old URL preserved for backwards compatibility.
    """
    url = "/dashboard?tab=procurement"
    if status_filter:
        url += f"&status_filter={status_filter}"
    return RedirectResponse(url, status_code=303)


# ============================================================================
# PROCUREMENT DETAIL PAGE v2.0 - Single-Page Invoice-First Design
# ============================================================================
# Redesigned procurement workspace with:
# - Two-column layout (invoices left, items table right)
# - Invoice-first workflow: create invoice → assign items → enter prices
# - Handsontable for fast price entry with copy-paste support
# - Bulk operations for efficiency
# ============================================================================

@rt("/procurement/{quote_id}")
def get(quote_id: str, session):
    """
    Procurement workspace - single-page invoice-first design.

    Layout:
    - Left panel: Invoice list with create/edit functionality
    - Right panel: Items table (Handsontable) with price entry

    Workflow:
    1. Create invoice (supplier, buyer, currency)
    2. Assign items to invoice
    3. Enter prices (copy-paste from Excel supported)
    4. Set invoice weight/volume
    5. Complete procurement
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has procurement role
    if not user_has_any_role(session, ["procurement", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote with customer info
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    quote = quote_result.data
    if not quote:
        return page_layout("Not Found",
            Div(
                H1("КП не найдено"),
                P("КП не существует или у вас нет доступа."),
                btn_link("Назад к задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    # Check if user is admin - bypass brand filtering
    is_admin = user_has_any_role(session, ["admin"])

    # Get user's assigned brands (admin sees all)
    my_brands = get_assigned_brands(user_id, org_id) if not is_admin else []
    my_brands_lower = [b.lower() for b in my_brands]

    # Get all items for this quote
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    all_items = items_result.data or []

    # Filter items for my brands (handle None brand values) - admin sees all
    if is_admin:
        my_items = all_items
    else:
        my_items = [item for item in all_items
                    if (item.get("brand") or "").lower() in my_brands_lower]

    # Get existing invoices for this quote
    invoices_result = supabase.table("invoices") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    invoices = invoices_result.data or []

    # Build invoice map for quick lookup
    invoice_map = {inv["id"]: inv for inv in invoices}

    # Get supplier names
    supplier_ids = list(set(inv.get("supplier_id") for inv in invoices if inv.get("supplier_id")))
    suppliers = {}
    if supplier_ids:
        suppliers_result = supabase.table("suppliers").select("id, name").in_("id", supplier_ids).execute()
        suppliers = {s["id"]: s["name"] for s in suppliers_result.data or []}

    # Get buyer company names
    buyer_company_ids = list(set(inv.get("buyer_company_id") for inv in invoices if inv.get("buyer_company_id")))
    buyer_companies = {}
    if buyer_company_ids:
        buyers_result = supabase.table("buyer_companies").select("id, name, company_code").in_("id", buyer_company_ids).execute()
        buyer_companies = {b["id"]: {"name": b["name"], "code": b.get("company_code", "")} for b in buyers_result.data or []}

    # Calculate progress
    total_items = len(my_items)
    priced_items = len([i for i in my_items if i.get("purchase_price_original")])
    assigned_items = len([i for i in my_items if i.get("invoice_id")])
    completed_items = len([i for i in my_items if i.get("procurement_status") == "completed"])

    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"
    workflow_status = quote.get("workflow_status", "draft")
    quote_idn = quote.get("idn_quote", f"#{quote_id[:8]}")

    # Check for revision status
    revision_department = quote.get("revision_department")
    revision_comment = quote.get("revision_comment")
    is_revision = revision_department == "procurement" and workflow_status == "pending_procurement"

    # Check if quote is in the right status for editing
    can_edit = workflow_status in ["pending_procurement", "draft"]

    # Currency symbols for display
    currency_symbols = {"USD": "$", "EUR": "€", "RUB": "₽", "CNY": "¥", "TRY": "₺"}

    # Get IDs of invoices still in procurement (not completed)
    pending_invoice_ids = set(
        inv["id"] for inv in invoices
        if inv.get("status") == "pending_procurement"
    )

    # Filter items: show only items that need work
    # Hide: items in completed invoices (already processed)
    # Hide: items marked unavailable (no action needed)
    items_to_show = [
        item for item in my_items
        if (not item.get("invoice_id") and not item.get("is_unavailable", False))
        or item.get("invoice_id") in pending_invoice_ids
    ]

    # Prepare items data for Handsontable
    items_for_handsontable = []
    for idx, item in enumerate(items_to_show):
        inv = invoice_map.get(item.get("invoice_id"))
        items_for_handsontable.append({
            'id': item.get('id'),
            'brand': item.get('brand', ''),
            'product_name': item.get('product_name', ''),
            'product_code': item.get('product_code', ''),
            'quantity': item.get('quantity', 1),
            'price': item.get('purchase_price_original') if item.get('purchase_price_original') is not None else '',
            'production_time': item.get('production_time_days') if item.get('production_time_days') is not None else '',
            'price_includes_vat': item.get('price_includes_vat', False),
            'is_unavailable': item.get('is_unavailable', False),
            'invoice_id': item.get('invoice_id') or '',
            'invoice_label': f"#{invoices.index(inv)+1}" if inv else '',
        })

    items_json = json.dumps(items_for_handsontable)

    # Fetch documents for all invoices (supplier_invoice entity type)
    invoice_documents = {}
    for inv in invoices:
        docs = get_documents_for_entity("supplier_invoice", inv["id"])
        if docs:
            invoice_documents[inv["id"]] = docs[0]  # Take first (most recent) document

    # Prepare invoices data for JavaScript
    invoices_for_js = []
    for idx, inv in enumerate(invoices, 1):
        supp = suppliers.get(inv.get("supplier_id"), "—")
        buyer = buyer_companies.get(inv.get("buyer_company_id"), {})
        doc = invoice_documents.get(inv['id'])
        invoices_for_js.append({
            'id': inv['id'],
            'number': idx,
            'invoice_number': inv.get('invoice_number', ''),
            'supplier_id': inv.get('supplier_id'),
            'supplier_name': supp,
            'buyer_company_id': inv.get('buyer_company_id'),
            'buyer_name': buyer.get('name', '—'),
            'buyer_code': buyer.get('code', ''),
            'currency': inv.get('currency', 'USD'),
            'currency_symbol': currency_symbols.get(inv.get('currency', 'USD'), inv.get('currency', '')),
            'total_weight_kg': inv.get('total_weight_kg'),
            'total_volume_m3': inv.get('total_volume_m3'),
            'pickup_location_id': inv.get('pickup_location_id'),
            'has_document': doc is not None,
            'document_id': doc.id if doc else None,
            'document_filename': doc.original_filename if doc else None,
        })

    invoices_json = json.dumps(invoices_for_js)

    # Count unassigned items
    unassigned_count = len([i for i in my_items if not i.get("invoice_id")])

    # Build invoice cards for left panel
    def invoice_card(inv, idx):
        supp = suppliers.get(inv.get("supplier_id"), "Поставщик не указан")
        buyer = buyer_companies.get(inv.get("buyer_company_id"), {})
        buyer_name = buyer.get("name", "Компания не указана")
        currency = inv.get("currency", "USD")
        currency_sym = currency_symbols.get(currency, currency)
        weight = inv.get("total_weight_kg")
        volume = inv.get("total_volume_m3")
        status = inv.get("status", "pending_procurement")
        is_completed = status != "pending_procurement"
        has_document = inv["id"] in invoice_documents

        # Count items in this invoice
        items_in_invoice = len([i for i in my_items if i.get("invoice_id") == inv["id"]])

        # Calculate total for this invoice
        total_sum = sum(
            (item.get("purchase_price_original", 0) or 0) * (item.get("quantity", 0) or 0)
            for item in my_items if item.get("invoice_id") == inv["id"]
        )

        # Status indicator and styling
        status_labels = {
            "pending_procurement": None,
            "pending_logistics": "→ Логистика",
            "pending_customs": "→ Таможня",
            "completed": "Завершён"
        }
        status_label = status_labels.get(status)

        # Gradient card styling based on status
        if is_completed:
            card_bg = "linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)"
            border_color = "#10b981"
            header_icon = icon("check-circle", size=16, color="#10b981")
        else:
            card_bg = "linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%)"
            border_color = "#3b82f6"
            header_icon = icon("package", size=16, color="#3b82f6")

        return Div(
            # Invoice header
            Div(
                Div(
                    header_icon,
                    Span(f" Инвойс #{idx}", style="font-weight: 600; font-size: 1rem; margin-left: 6px;"),
                    style="display: flex; align-items: center;"
                ),
                Span(f"{items_in_invoice} поз.", style="font-size: 0.75rem; color: #64748b; background: #e2e8f0; padding: 0.125rem 0.5rem; border-radius: 999px;"),
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
            ),

            # Supplier → Buyer
            Div(
                Span(supp, style="font-size: 0.875rem; color: #374151;"),
                Span(" → ", style="color: #94a3b8;"),
                Span(buyer_name, style="font-size: 0.875rem; color: #374151;"),
                style="margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
            ),

            # Status label for completed invoices
            Div(
                icon("check", size=12, color="#059669"),
                Span(f" {status_label}", style="font-size: 0.75rem; color: #059669; font-weight: 500;"),
                style="margin-bottom: 0.5rem; display: flex; align-items: center;"
            ) if status_label else None,

            # Currency, weight, document indicator
            Div(
                Span(currency, style="font-weight: 500; color: #059669; margin-right: 0.75rem;"),
                Div(
                    icon("scale", size=12, color="#64748b"),
                    Span(f" {weight or '—'} кг", style="color: #64748b; margin-left: 2px;"),
                    style="display: inline-flex; align-items: center; margin-right: 0.75rem;"
                ) if weight else Div(
                    icon("alert-triangle", size=12, color="#f59e0b"),
                    Span(" вес", style="color: #f59e0b; margin-left: 2px;"),
                    style="display: inline-flex; align-items: center; margin-right: 0.75rem;"
                ),
                # Document indicator
                Div(
                    icon("file-text", size=12, color="#10b981"),
                    Span(" скан", style="color: #10b981; margin-left: 2px;"),
                    style="display: inline-flex; align-items: center; margin-right: 0.75rem;"
                ) if has_document else Div(
                    icon("file-x", size=12, color="#94a3b8"),
                    Span(" нет скана", style="color: #94a3b8; margin-left: 2px;"),
                    style="display: inline-flex; align-items: center; margin-right: 0.75rem;"
                ),
                Span(f"Σ {total_sum:,.2f} {currency_sym}", style="font-weight: 500; color: #1e40af;") if total_sum > 0 else None,
                style="font-size: 0.75rem; display: flex; align-items: center; flex-wrap: wrap; gap: 0.25rem;"
            ),

            # Action buttons for pending invoices
            Div(
                A("Редактировать", href="#", cls="text-blue-600 text-sm",
                  onclick=f"openEditInvoiceModal('{inv['id']}'); return false;",
                  style="font-size: 0.75rem; color: #3b82f6; margin-right: 0.75rem;"),
                A("Назначить ↓", href="#", cls="text-green-600 text-sm",
                  onclick=f"assignSelectedToInvoice('{inv['id']}'); return false;",
                  style="font-size: 0.75rem; color: #059669;"),
                style="margin-top: 0.5rem;"
            ) if can_edit and not is_completed else None,

            # Complete button for pending invoices
            Div(
                A(
                    Span(icon("check", size=14, color="white"), style="margin-right: 4px; display: inline-flex; vertical-align: middle;"),
                    Span("Завершить инвойс"),
                    href="#",
                    onclick=f"completeInvoice('{inv['id']}'); return false;",
                    style="font-size: 0.75rem; color: white; background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 0.375rem 0.75rem; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                ),
                style="margin-top: 0.75rem;"
            ) if can_edit and not is_completed else None,

            # Reopen button for completed invoices
            Div(
                A(
                    icon("lock-open", size=12, color="#64748b"),
                    Span(" Вернуть в работу", style="margin-left: 4px;"),
                    href="#",
                    onclick=f"reopenInvoice('{inv['id']}'); return false;",
                    style="font-size: 0.75rem; color: #64748b; text-decoration: underline; display: inline-flex; align-items: center;"
                ),
                style="margin-top: 0.5rem;"
            ) if can_edit and is_completed else None,

            cls="card",
            style=f"padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid {border_color}; cursor: pointer; background: {card_bg}; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.04);" + (" opacity: 0.9;" if is_completed else ""),
            id=f"invoice-card-{inv['id']}",
            onclick=f"selectInvoice('{inv['id']}')"
        )

    return page_layout(f"Закупки — {quote_idn}",
        # Breadcrumbs
        Div(
            A("← Назад к задачам", href="/tasks"),
            style="margin-bottom: 1rem;"
        ),

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "procurement", user.get("roles", [])),

        # Header with gradient styling
        Div(
            H1(f"Закупки: {quote_idn}", style="margin: 0; font-size: 1.5rem;"),
            Div(
                Span(f"Клиент: {customer_name}", style="margin-right: 1.5rem; color: #64748b;"),
                workflow_status_badge(workflow_status),
                style="margin-top: 0.5rem;"
            ),
            style="margin-bottom: 1rem;"
        ),

        # Workflow progress bar
        workflow_progress_bar(workflow_status),

        # Revision banner with icon
        Div(
            Div(
                icon("rotate-ccw", size=18, color="#92400e"),
                Span(" Возвращено на доработку", style="font-weight: 600; font-size: 1.1rem; margin-left: 6px;"),
                style="margin-bottom: 0.5rem; display: flex; align-items: center;"
            ),
            Div(
                Span("Комментарий:", style="font-weight: 500;"),
                P(revision_comment, style="margin: 0.25rem 0 0; font-style: italic;"),
            ) if revision_comment else None,
            cls="card",
            style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 1rem; border-radius: 10px;"
        ) if is_revision else None,

        # Progress bar with gradient card
        Div(
            Div(
                icon("trending-up", size=16, color="#64748b"),
                Span(f" Прогресс: ", style="font-weight: 500; margin-left: 6px;"),
                Span(f"{priced_items}/{total_items}", style="font-weight: 600; color: #1e40af;"),
                Span(" оценено", style="color: #64748b;"),
                Span(f" | {assigned_items} назначено", style="color: #64748b;"),
                style="margin-bottom: 0.5rem; display: flex; align-items: center;"
            ),
            Div(
                Div(style=f"width: {(priced_items/total_items*100) if total_items > 0 else 0}%; height: 8px; background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%); border-radius: 999px;"),
                style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 999px; overflow: hidden;"
            ),
            cls="card", style="padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 10px;"
        ),

        # Warning if not in correct status
        Div(
            P(icon("alert-triangle", size=16), f" КП в статусе «{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}». Редактирование недоступно.",
              style="color: #b45309; margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
            cls="card", style="background: #fffbeb; margin-bottom: 1rem;"
        ) if not can_edit else None,

        # Two-column layout
        Div(
            # Left panel - Invoices
            Div(
                # Section header with icon
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span(" ИНВОЙСЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                    A(icon("plus", size=14), " Новый",
                      href="#", onclick="openCreateInvoiceModal(); return false;",
                      style="font-size: 0.75rem; color: #3b82f6; display: flex; align-items: center; gap: 0.25rem; margin-left: auto;"
                    ) if can_edit else None,
                    style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0;"
                ),

                # Invoice cards (always has id for HTMX target)
                Div(
                    *[invoice_card(inv, idx) for idx, inv in enumerate(invoices, 1)],
                    id="invoices-list"
                ) if invoices else Div(
                    icon("inbox", size=24, color="#94a3b8"),
                    P("Нет инвойсов", style="color: #64748b; text-align: center; margin: 0.5rem 0 0;"),
                    P("Создайте инвойс, чтобы начать", style="color: #94a3b8; text-align: center; font-size: 0.875rem; margin: 0.25rem 0 0;"),
                    style="padding: 2rem 0; text-align: center;",
                    id="invoices-list"
                ),

                # Unassigned items count with icon
                Div(
                    Div(
                        icon("alert-triangle", size=14, color="#92400e"),
                        Span(f" Без инвойса: {unassigned_count}", style="font-weight: 500; color: #92400e; margin-left: 4px;"),
                        style="padding: 0.5rem 0.75rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 6px; text-align: center; display: flex; align-items: center; justify-content: center;"
                    ),
                    style="margin-top: 1rem;"
                ) if unassigned_count > 0 else None,

                style="width: 280px; flex-shrink: 0; padding-right: 1.5rem; border-right: 1px solid #e2e8f0;",
                id="invoices-panel"
            ),

            # Right panel - Items table
            Div(
                # Section header with icon
                Div(
                    Div(
                        icon("package", size=16, color="#64748b"),
                        Span(f" ПОЗИЦИИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                        Span(f" ({total_items})", style="font-size: 11px; color: #94a3b8;"),
                        style="display: flex; align-items: center;"
                    ),
                    Div(
                        Span(id="selection-count", style="margin-right: 1rem; color: #64748b;"),
                        A(icon("download", size=14), " Excel",
                          href=f"/procurement/{quote_id}/export",
                          style="font-size: 0.75rem; color: #3b82f6; display: flex; align-items: center; gap: 0.25rem;"
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0;"
                ),

                # Copy-paste hint with better styling
                Div(
                    icon("clipboard", size=14, color="#64748b"),
                    Span(" Ctrl+V для вставки цен из Excel", style="margin-left: 0.5rem;"),
                    style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem; display: flex; align-items: center;"
                ) if can_edit else None,

                # Handsontable container with enhanced styling
                Div(
                    Div(id="items-spreadsheet", style="width: 100%; height: 500px; overflow: hidden;"),
                    cls="handsontable-container"
                ),

                # Footer with actions
                Div(
                    btn("Сохранить", variant="secondary", icon_name="save", id="btn-save", onclick="saveAllChanges()") if can_edit else None,
                    btn("Завершить закупку", variant="success", icon_name="check", id="btn-complete", onclick="completeProcurement()") if can_edit else None,
                    btn_link("Вернуть на проверку", href=f"/procurement/{quote_id}/return-to-control", variant="primary", icon_name="arrow-up") if is_revision else None,
                    style="display: flex; gap: 0.75rem; margin-top: 1rem;"
                ),

                style="flex: 1; padding-left: 1.5rem;",
                id="items-panel"
            ),

            style="display: flex; gap: 0; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 1.25rem;",
            cls="card"
        ),

        # Create Invoice Modal (with all fields including pickup_country, weight, volume)
        Div(
            # Backdrop (click to close)
            Div(
                id="create-invoice-backdrop",
                onclick="closeCreateInvoiceModal()",
                cls="fixed inset-0 bg-black/50 z-[999]",
                style="display: none;"
            ),
            # Modal box with gradient styling
            Div(
                Div(
                    Div(
                        icon("file-plus", size=18, color="#3b82f6"),
                        Span(" Новый инвойс", style="font-weight: 600; font-size: 1.125rem; margin-left: 8px;"),
                        style="display: flex; align-items: center;"
                    ),
                    A("×", href="#", onclick="closeCreateInvoiceModal(); return false;",
                      cls="text-2xl text-gray-500 hover:text-gray-700 no-underline"),
                    cls="flex justify-between items-center mb-4"
                ),

                # Selected items indicator with icon
                Div(
                    icon("package", size=16, color="#3b82f6"),
                    Span(" Выбрано позиций: ", style="color: #64748b; margin-left: 6px;"),
                    Span("0", id="modal-selected-count", style="font-weight: 600; color: #1e40af;"),
                    style="margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px; font-size: 0.875rem; display: flex; align-items: center;"
                ),

                Form(
                    # Hidden field for selected item IDs
                    Input(type="hidden", name="item_ids", id="modal-item-ids"),

                    # Supplier dropdown
                    supplier_dropdown(
                        name="supplier_id",
                        label="Поставщик *",
                        required=True,
                        placeholder="Поиск поставщика...",
                        dropdown_id="modal-supplier"
                    ),

                    # Buyer company dropdown
                    buyer_company_dropdown(
                        name="buyer_company_id",
                        label="Компания-покупатель *",
                        required=True,
                        placeholder="Поиск компании...",
                        dropdown_id="modal-buyer"
                    ),

                    # Location dropdown
                    location_dropdown(
                        name="pickup_location_id",
                        label="Точка отгрузки",
                        placeholder="Поиск локации...",
                        dropdown_id="modal-location"
                    ),

                    # Pickup Country
                    Div(
                        Label("Страна отгрузки *", cls="block mb-2 font-medium"),
                        Select(
                            Option("— Выберите страну —", value="", disabled=True, selected=True),
                            Option("Россия", value="RU"),
                            Option("Китай", value="CN"),
                            Option("Турция", value="TR"),
                            Option("Германия", value="DE"),
                            Option("США", value="US"),
                            Option("Италия", value="IT"),
                            Option("Другое", value="OTHER"),
                            name="pickup_country",
                            required=True,
                            cls="w-full p-2 border border-gray-300 rounded-md"
                        ),
                        cls="mb-4"
                    ),

                    # Currency
                    Div(
                        Label("Валюта *", cls="block mb-2 font-medium"),
                        Select(
                            Option("USD", value="USD", selected=True),
                            Option("EUR", value="EUR"),
                            Option("RUB", value="RUB"),
                            Option("CNY", value="CNY"),
                            Option("TRY", value="TRY"),
                            name="currency",
                            required=True,
                            cls="w-full p-2 border border-gray-300 rounded-md"
                        ),
                        cls="mb-4"
                    ),

                    # Weight and Volume in a row
                    Div(
                        Div(
                            Label("Общий вес, кг *", cls="block mb-2 font-medium"),
                            Input(type="number", name="total_weight_kg", step="0.001", min="0.001", required=True,
                                  placeholder="125.5", cls="w-full p-2 border border-gray-300 rounded-md"),
                            cls="flex-1"
                        ),
                        Div(
                            Label("Объём, м³", cls="block mb-2 font-medium"),
                            Input(type="number", name="total_volume_m3", step="0.0001", min="0",
                                  placeholder="2.5", cls="w-full p-2 border border-gray-300 rounded-md"),
                            cls="flex-1"
                        ),
                        cls="flex gap-4 mb-4"
                    ),

                    # Invoice file upload
                    Div(
                        Label("Скан инвойса от поставщика", cls="block mb-2 font-medium"),
                        Div(
                            icon("upload", size=20, color="#64748b"),
                            Span(" Выберите файл или перетащите", style="margin-left: 8px; color: #64748b;"),
                            Input(type="file", name="invoice_file", id="create-invoice-file",
                                  accept=".pdf,.jpg,.jpeg,.png,.webp",
                                  style="position: absolute; inset: 0; opacity: 0; cursor: pointer;"),
                            style="position: relative; display: flex; align-items: center; justify-content: center; padding: 1rem; border: 2px dashed #e2e8f0; border-radius: 8px; background: #f8fafc; cursor: pointer;",
                            onclick="document.getElementById('create-invoice-file').click()"
                        ),
                        Div(id="create-invoice-filename", style="margin-top: 0.5rem; font-size: 0.875rem; color: #059669;"),
                        cls="mb-4"
                    ),

                    # Error message container
                    Div(id="create-invoice-error", cls="text-red-500 text-sm mt-2 hidden"),

                    # Action buttons - use flex-none to prevent button stretching
                    Div(
                        Button(
                            icon("check", size=16),
                            "Создать",
                            type="button",
                            onclick="submitCreateInvoiceForm()",
                            cls="flex-none btn btn--primary"
                        ),
                        Button(
                            "Отмена",
                            type="button",
                            onclick="closeCreateInvoiceModal()",
                            cls="flex-none btn btn--ghost"
                        ),
                        cls="flex gap-3 justify-end mt-6"
                    ),

                    id="create-invoice-form"
                ),

                id="create-invoice-modal-box",
                cls="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 z-[1000] w-[90%] max-w-lg max-h-[90vh] overflow-y-auto",
                style="display: none;"
            ),
            id="create-invoice-modal"
        ),

        # Edit Invoice Modal (exact feedback modal pattern with Tailwind)
        Div(
            # Backdrop (click to close)
            Div(
                id="edit-invoice-backdrop",
                onclick="closeEditInvoiceModal()",
                cls="fixed inset-0 bg-black/50 z-[999]",
                style="display: none;"
            ),
            # Modal box with gradient styling
            Div(
                Div(
                    Div(
                        icon("edit", size=18, color="#3b82f6"),
                        Span(" Редактировать инвойс", style="font-weight: 600; font-size: 1.125rem; margin-left: 8px;"),
                        style="display: flex; align-items: center;"
                    ),
                    A("×", href="#", onclick="closeEditInvoiceModal(); return false;",
                      cls="text-2xl text-gray-500 hover:text-gray-700 no-underline"),
                    cls="flex justify-between items-center mb-4"
                ),

                Form(
                    Input(type="hidden", name="invoice_id", id="edit-invoice-id"),

                    # Invoice number
                    Div(
                        Label("Номер инвойса *", cls="block mb-2 font-medium"),
                        Input(type="text", name="invoice_number", id="edit-invoice-number", required=True,
                              cls="w-full p-2 border border-gray-300 rounded-md"),
                        cls="mb-4"
                    ),

                    # Currency
                    Div(
                        Label("Валюта *", cls="block mb-2 font-medium"),
                        Select(
                            Option("USD", value="USD"),
                            Option("EUR", value="EUR"),
                            Option("RUB", value="RUB"),
                            Option("CNY", value="CNY"),
                            Option("TRY", value="TRY"),
                            name="currency",
                            id="edit-invoice-currency",
                            required=True,
                            cls="w-full p-2 border border-gray-300 rounded-md"
                        ),
                        cls="mb-4"
                    ),

                    # Weight
                    Div(
                        Label("Общий вес, кг *", cls="block mb-2 font-medium"),
                        Input(type="number", name="total_weight_kg", id="edit-invoice-weight", step="0.001", min="0", required=True,
                              placeholder="125.5",
                              cls="w-full p-2 border border-gray-300 rounded-md"),
                        cls="mb-4"
                    ),

                    # Volume
                    Div(
                        Label("Общий объём, м³", cls="block mb-2 font-medium"),
                        Input(type="number", name="total_volume_m3", id="edit-invoice-volume", step="0.0001", min="0",
                              placeholder="2.5",
                              cls="w-full p-2 border border-gray-300 rounded-md"),
                        cls="mb-4"
                    ),

                    # Invoice file section
                    Div(
                        Label("Скан инвойса от поставщика", cls="block mb-2 font-medium"),
                        # Current file display (hidden by default, shown via JS)
                        Div(
                            icon("file-text", size=16, color="#10b981"),
                            Span(id="edit-invoice-doc-filename", style="margin-left: 6px; color: #374151;"),
                            A("Скачать", href="#", id="edit-invoice-doc-download", target="_blank",
                              style="margin-left: 0.75rem; color: #3b82f6; font-size: 0.875rem;"),
                            A("Удалить", href="#", onclick="deleteInvoiceDocument(); return false;",
                              style="margin-left: 0.75rem; color: #ef4444; font-size: 0.875rem;"),
                            id="edit-invoice-doc-current",
                            style="display: none; align-items: center; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.5rem;"
                        ),
                        # Upload new file
                        Div(
                            icon("upload", size=20, color="#64748b"),
                            Span(" Заменить файл", id="edit-upload-label", style="margin-left: 8px; color: #64748b;"),
                            Input(type="file", name="invoice_file", id="edit-invoice-file",
                                  accept=".pdf,.jpg,.jpeg,.png,.webp",
                                  style="position: absolute; inset: 0; opacity: 0; cursor: pointer;"),
                            style="position: relative; display: flex; align-items: center; justify-content: center; padding: 0.75rem; border: 2px dashed #e2e8f0; border-radius: 8px; background: #f8fafc; cursor: pointer;",
                            onclick="document.getElementById('edit-invoice-file').click()"
                        ),
                        Div(id="edit-invoice-filename", style="margin-top: 0.5rem; font-size: 0.875rem; color: #059669;"),
                        cls="mb-4"
                    ),

                    # Delete button
                    Div(
                        A("🗑 Удалить инвойс", href="#", onclick="deleteInvoice(); return false;",
                          cls="text-red-600 text-sm"),
                        cls="mb-4"
                    ),

                    # Action buttons
                    Div(
                        btn("Сохранить", variant="primary", type="button", icon_name="check", onclick="submitEditInvoiceForm()"),
                        btn("Отмена", variant="ghost", type="button", onclick="closeEditInvoiceModal()"),
                        cls="flex gap-3 justify-end mt-6"
                    ),

                    id="edit-invoice-form",
                    enctype="multipart/form-data"
                ),

                id="edit-invoice-modal-box",
                cls="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 z-[1000] w-[90%] max-w-lg",
                style="display: none;"
            ),
            id="edit-invoice-modal"
        ),

        # Transition history
        workflow_transition_history(quote_id),

        # JavaScript for procurement workspace
        Script(f"""
        (function() {{
            var quoteId = '{quote_id}';
            var canEdit = {'true' if can_edit else 'false'};
            var invoicesData = {invoices_json};
            var itemsData = {items_json};
            var hot = null;
            var selectedInvoiceId = null;

            // Modal functions (sibling pattern - backdrop + modal-box)
            window.openCreateInvoiceModal = function() {{
                // Save Handsontable data before opening modal (prevents data loss on page reload)
                saveAllChanges(false);

                // Collect selected item IDs
                if (!hot) {{
                    alert('Таблица не инициализирована');
                    return;
                }}
                var sourceData = hot.getSourceData();
                var selectedIds = [];
                for (var i = 0; i < sourceData.length; i++) {{
                    if (hot.getDataAtCell(i, 0) === true) {{
                        selectedIds.push(sourceData[i].id);
                    }}
                }}
                if (selectedIds.length === 0) {{
                    alert('Сначала выберите позиции для добавления в инвойс');
                    return;
                }}
                // Set hidden field with item IDs
                document.getElementById('modal-item-ids').value = JSON.stringify(selectedIds);
                // Update selected count display
                document.getElementById('modal-selected-count').textContent = selectedIds.length;
                // Show modal
                document.getElementById('create-invoice-backdrop').style.display = 'block';
                document.getElementById('create-invoice-modal-box').style.display = 'block';
            }};

            window.closeCreateInvoiceModal = function() {{
                document.getElementById('create-invoice-backdrop').style.display = 'none';
                document.getElementById('create-invoice-modal-box').style.display = 'none';
                document.getElementById('create-invoice-form').reset();
                document.getElementById('modal-item-ids').value = '';
                document.getElementById('modal-selected-count').textContent = '0';
                document.getElementById('create-invoice-error').classList.add('hidden');
                document.getElementById('create-invoice-filename').textContent = '';
            }};

            // File input change handlers
            document.getElementById('create-invoice-file').addEventListener('change', function(e) {{
                var filename = e.target.files[0] ? e.target.files[0].name : '';
                document.getElementById('create-invoice-filename').textContent = filename ? '📎 ' + filename : '';
            }});

            document.getElementById('edit-invoice-file').addEventListener('change', function(e) {{
                var filename = e.target.files[0] ? e.target.files[0].name : '';
                document.getElementById('edit-invoice-filename').textContent = filename ? '📎 Новый файл: ' + filename : '';
            }});

            window.submitCreateInvoiceForm = function() {{
                var form = document.getElementById('create-invoice-form');
                var errEl = document.getElementById('create-invoice-error');
                errEl.classList.add('hidden');

                var formData = new FormData(form);

                fetch('/api/procurement/{quote_id}/invoices', {{
                    method: 'POST',
                    body: formData
                }})
                .then(function(response) {{
                    return response.json();
                }})
                .then(function(data) {{
                    if (data.success) {{
                        closeCreateInvoiceModal();
                        location.reload();
                    }} else {{
                        errEl.textContent = data.error || 'Ошибка создания инвойса';
                        errEl.classList.remove('hidden');
                    }}
                }})
                .catch(function(err) {{
                    errEl.textContent = 'Ошибка сети: ' + err.message;
                    errEl.classList.remove('hidden');
                }});
            }};

            window.openEditInvoiceModal = function(invoiceId) {{
                // Save Handsontable data before opening modal (prevents data loss)
                saveAllChanges(false);

                var inv = invoicesData.find(function(i) {{ return i.id === invoiceId; }});
                if (!inv) return;

                document.getElementById('edit-invoice-id').value = inv.id;
                document.getElementById('edit-invoice-number').value = inv.invoice_number || '';
                document.getElementById('edit-invoice-currency').value = inv.currency || 'USD';
                document.getElementById('edit-invoice-weight').value = inv.total_weight_kg || '';
                document.getElementById('edit-invoice-volume').value = inv.total_volume_m3 || '';

                // Show/hide current document info
                var docCurrentEl = document.getElementById('edit-invoice-doc-current');
                var uploadLabel = document.getElementById('edit-upload-label');
                if (inv.has_document && inv.document_filename) {{
                    docCurrentEl.style.display = 'flex';
                    document.getElementById('edit-invoice-doc-filename').textContent = inv.document_filename;
                    document.getElementById('edit-invoice-doc-download').href = '/api/documents/' + inv.document_id + '/download';
                    uploadLabel.textContent = ' Заменить файл';
                }} else {{
                    docCurrentEl.style.display = 'none';
                    uploadLabel.textContent = ' Загрузить файл';
                }}
                document.getElementById('edit-invoice-filename').textContent = '';
                document.getElementById('edit-invoice-file').value = '';

                selectedInvoiceId = invoiceId;
                document.getElementById('edit-invoice-backdrop').style.display = 'block';
                document.getElementById('edit-invoice-modal-box').style.display = 'block';
            }};

            window.closeEditInvoiceModal = function() {{
                document.getElementById('edit-invoice-backdrop').style.display = 'none';
                document.getElementById('edit-invoice-modal-box').style.display = 'none';
                document.getElementById('edit-invoice-filename').textContent = '';
                selectedInvoiceId = null;
            }};

            window.submitEditInvoiceForm = function() {{
                var form = document.getElementById('edit-invoice-form');
                var formData = new FormData(form);

                fetch('/api/procurement/{quote_id}/invoices/update', {{
                    method: 'PATCH',
                    body: formData
                }})
                .then(function(response) {{
                    if (response.ok) {{
                        closeEditInvoiceModal();
                        location.reload();
                    }} else {{
                        return response.json().then(function(data) {{
                            alert(data.error || 'Ошибка сохранения');
                        }});
                    }}
                }})
                .catch(function(err) {{
                    alert('Ошибка сети: ' + err.message);
                }});
            }};

            window.deleteInvoiceDocument = function() {{
                if (!selectedInvoiceId) return;
                var inv = invoicesData.find(function(i) {{ return i.id === selectedInvoiceId; }});
                if (!inv || !inv.document_id) return;

                if (!confirm('Удалить скан инвойса?')) return;

                fetch('/api/documents/' + inv.document_id, {{
                    method: 'DELETE'
                }})
                .then(function(response) {{ return response.json(); }})
                .then(function(data) {{
                    if (data.success) {{
                        // Update local data and UI
                        inv.has_document = false;
                        inv.document_id = null;
                        inv.document_filename = null;
                        document.getElementById('edit-invoice-doc-current').style.display = 'none';
                        document.getElementById('edit-upload-label').textContent = ' Загрузить файл';
                        location.reload();
                    }} else {{
                        alert(data.error || 'Ошибка удаления');
                    }}
                }})
                .catch(function(err) {{ alert('Ошибка: ' + err.message); }});
            }};

            // Invoice selection
            window.selectInvoice = function(invoiceId) {{
                document.querySelectorAll('[id^="invoice-card-"]').forEach(function(el) {{
                    el.style.background = 'white';
                }});
                var card = document.getElementById('invoice-card-' + invoiceId);
                if (card) card.style.background = '#eff6ff';
                selectedInvoiceId = invoiceId;
            }};

            // Assign selected items to invoice
            window.assignSelectedToInvoice = function(invoiceId) {{
                if (!hot) return;
                var selectedRows = [];
                var sourceData = hot.getSourceData();

                for (var i = 0; i < sourceData.length; i++) {{
                    var cellMeta = hot.getCellMeta(i, 0);
                    if (cellMeta && hot.getDataAtCell(i, 0) === true) {{
                        selectedRows.push(sourceData[i].id);
                    }}
                }}

                if (selectedRows.length === 0) {{
                    alert('Выберите позиции для назначения');
                    return;
                }}

                fetch('/api/procurement/' + quoteId + '/items/assign', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{
                        item_ids: selectedRows,
                        invoice_id: invoiceId
                    }})
                }})
                .then(function(r) {{ return r.json(); }})
                .then(function(data) {{
                    if (data.success) {{
                        // Update table data
                        var inv = invoicesData.find(function(i) {{ return i.id === invoiceId; }});
                        var invLabel = inv ? '#' + inv.number : '';

                        for (var i = 0; i < sourceData.length; i++) {{
                            if (selectedRows.indexOf(sourceData[i].id) >= 0) {{
                                sourceData[i].invoice_id = invoiceId;
                                sourceData[i].invoice_label = invLabel;
                                hot.setDataAtCell(i, 0, false);  // Uncheck
                            }}
                        }}
                        hot.render();
                        location.reload();  // Refresh to update counts
                    }} else {{
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }}
                }});
            }};

            // Save all changes - returns Promise for chaining
            window.saveAllChanges = function(showAlert) {{
                if (!hot) return Promise.resolve({{ success: true }});
                // IMPORTANT: Finish any active cell edit before reading data
                // Without this, typing a value and clicking Save/Complete won't include the current edit
                hot.deselectCell();
                var sourceData = hot.getSourceData();
                var updates = [];

                for (var i = 0; i < sourceData.length; i++) {{
                    var row = sourceData[i];
                    if (row.id) {{
                        updates.push({{
                            id: row.id,
                            purchase_price_original: row.price !== '' && row.price != null ? parseFloat(row.price) : null,
                            production_time_days: row.production_time !== '' && row.production_time != null ? parseInt(row.production_time) : null,
                            price_includes_vat: row.price_includes_vat || false,
                            is_unavailable: row.is_unavailable || false
                        }});
                    }}
                }}

                return fetch('/api/procurement/' + quoteId + '/items/bulk', {{
                    method: 'PATCH',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ items: updates }})
                }})
                .then(function(r) {{ return r.json(); }})
                .then(function(data) {{
                    if (showAlert !== false) {{
                        if (data.success) {{
                            alert('Сохранено успешно');
                        }} else {{
                            alert('Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка'));
                        }}
                    }}
                    return data;
                }});
            }};

            // Complete procurement - properly awaits save before completing
            window.completeProcurement = function() {{
                if (!confirm('Завершить закупку? Все позиции будут отмечены как оценённые.')) return;

                // First save all changes, then complete (no race condition)
                window.saveAllChanges(false)
                    .then(function(saveResult) {{
                        if (!saveResult.success) {{
                            alert('Ошибка сохранения: ' + (saveResult.error || 'Неизвестная ошибка'));
                            return;
                        }}
                        return fetch('/api/procurement/' + quoteId + '/complete', {{
                            method: 'POST',
                            headers: {{ 'Content-Type': 'application/json' }}
                        }});
                    }})
                    .then(function(r) {{ if (r) return r.json(); }})
                    .then(function(data) {{
                        if (!data) return;
                        if (data.success) {{
                            alert('Закупка завершена!');
                            location.href = '/tasks';
                        }} else {{
                            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                        }}
                    }})
                    .catch(function(err) {{
                        alert('Ошибка сети: ' + err.message);
                    }});
            }};

            // Delete invoice
            window.deleteInvoice = function() {{
                if (!selectedInvoiceId) return;
                if (!confirm('Удалить инвойс? Товары будут откреплены.')) return;

                fetch('/api/procurement/' + quoteId + '/invoices/' + selectedInvoiceId, {{
                    method: 'DELETE'
                }})
                .then(function(r) {{ return r.json(); }})
                .then(function(data) {{
                    if (data.success) {{
                        closeEditInvoiceModal();
                        location.reload();
                    }} else {{
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }}
                }});
            }};

            // Complete invoice - moves to logistics/customs
            window.completeInvoice = function(invoiceId) {{
                if (!confirm('Завершить инвойс и передать в логистику/таможню?')) return;

                // First save all changes
                window.saveAllChanges(false)
                    .then(function(saveResult) {{
                        if (!saveResult.success) {{
                            alert('Ошибка сохранения: ' + (saveResult.error || 'Неизвестная ошибка'));
                            return;
                        }}
                        // Then complete the invoice
                        return fetch('/api/procurement/' + quoteId + '/invoices/' + invoiceId + '/complete', {{
                            method: 'POST'
                        }});
                    }})
                    .then(function(r) {{
                        if (!r) return;
                        return r.json();
                    }})
                    .then(function(data) {{
                        if (!data) return;
                        if (data.success) {{
                            alert('Инвойс завершён и передан в логистику/таможню!');
                            location.reload();
                        }} else {{
                            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                        }}
                    }})
                    .catch(function(err) {{
                        alert('Ошибка сети: ' + err.message);
                    }});
            }};

            // Reopen invoice - returns to procurement
            window.reopenInvoice = function(invoiceId) {{
                if (!confirm('Вернуть инвойс в работу?')) return;

                fetch('/api/procurement/' + quoteId + '/invoices/' + invoiceId + '/reopen', {{
                    method: 'POST'
                }})
                .then(function(r) {{ return r.json(); }})
                .then(function(data) {{
                    if (data.success) {{
                        location.reload();
                    }} else {{
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    }}
                }})
                .catch(function(err) {{
                    alert('Ошибка сети: ' + err.message);
                }});
            }};

            // Update selection count
            function updateSelectionCount() {{
                if (!hot) return;
                var count = 0;
                for (var i = 0; i < hot.countRows(); i++) {{
                    if (hot.getDataAtCell(i, 0) === true) count++;
                }}
                var el = document.getElementById('selection-count');
                if (el) el.textContent = count > 0 ? count + ' выбрано' : '';
            }}

            // Initialize Handsontable
            function initTable() {{
                var container = document.getElementById('items-spreadsheet');
                if (!container || typeof Handsontable === 'undefined') return;

                var columns = [
                    {{data: 'selected', type: 'checkbox', width: 40, readOnly: !canEdit}},
                    {{data: 'brand', type: 'text', readOnly: true, width: 100}},
                    {{data: 'product_name', type: 'text', readOnly: true, width: 200}},
                    {{data: 'quantity', type: 'numeric', readOnly: true, width: 50}},
                    {{data: 'price', type: 'numeric', width: 80, readOnly: !canEdit, numericFormat: {{pattern: '0.00'}}}},
                    {{data: 'production_time', type: 'numeric', width: 50, readOnly: !canEdit}},
                    {{data: 'price_includes_vat', type: 'checkbox', width: 50, readOnly: !canEdit}},
                    {{data: 'is_unavailable', type: 'checkbox', width: 50, readOnly: !canEdit,
                      renderer: function(instance, td, row, col, prop, value) {{
                          Handsontable.renderers.CheckboxRenderer.apply(this, arguments);
                          td.style.textAlign = 'center';
                          if (value) {{
                              td.parentNode.style.backgroundColor = '#fef2f2';
                          }}
                          return td;
                      }}
                    }},
                    {{data: 'invoice_label', type: 'text', readOnly: true, width: 70,
                      renderer: function(instance, td, row, col, prop, value) {{
                          td.innerHTML = value || '<span style="color:#f59e0b">—</span>';
                          td.style.textAlign = 'center';
                          if (value) td.style.color = '#3b82f6';
                          return td;
                      }}
                    }}
                ];

                // Add 'selected' field to each item
                itemsData.forEach(function(item) {{
                    item.selected = false;
                }});

                hot = new Handsontable(container, {{
                    licenseKey: 'non-commercial-and-evaluation',
                    data: itemsData,
                    colHeaders: ['☐', 'Бренд', 'Наименование', 'Кол-во', 'Цена', 'Дни', 'НДС', 'Н/Д', 'Инвойс'],
                    columns: columns,
                    rowHeaders: true,
                    stretchH: 'all',
                    autoWrapRow: true,
                    contextMenu: false,
                    manualColumnResize: true,
                    afterChange: function(changes, source) {{
                        if (source === 'loadData') return;
                        updateSelectionCount();
                    }},
                    cells: function(row, col) {{
                        var cellProperties = {{}};
                        if (col === 0) {{
                            cellProperties.className = 'htCenter';
                        }}
                        return cellProperties;
                    }}
                }});

                window.hot = hot;
            }}

            // Initialize on DOM ready
            if (document.readyState === 'loading') {{
                document.addEventListener('DOMContentLoaded', initTable);
            }} else {{
                initTable();
            }}
        }})();
        """),

        session=session
    )


# ============================================================================
# PROCUREMENT API ENDPOINTS
# ============================================================================

@rt("/api/procurement/{quote_id}/invoices", methods=["POST"])
async def api_create_invoice(quote_id: str, session, request):
    """Create a new invoice for procurement with selected items."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    supabase = get_supabase()

    # Verify quote exists
    quote_result = supabase.table("quotes") \
        .select("id, idn_quote") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    quote = quote_result.data

    # Parse form data
    form = await request.form()

    supplier_id = form.get("supplier_id")
    buyer_company_id = form.get("buyer_company_id")
    pickup_location_id = form.get("pickup_location_id") or None
    pickup_country = form.get("pickup_country", "").strip()
    currency = form.get("currency", "USD")
    total_weight_kg = form.get("total_weight_kg")
    total_volume_m3 = form.get("total_volume_m3") or None
    item_ids_json = form.get("item_ids", "[]")

    # Parse item IDs
    try:
        item_ids = json.loads(item_ids_json) if item_ids_json else []
    except json.JSONDecodeError:
        item_ids = []

    if not supplier_id or not buyer_company_id:
        return JSONResponse({"success": False, "error": "Supplier and buyer company are required"}, status_code=400)

    if not pickup_country:
        return JSONResponse({"success": False, "error": "Pickup country is required"}, status_code=400)

    if not total_weight_kg:
        return JSONResponse({"success": False, "error": "Total weight is required"}, status_code=400)

    if not item_ids:
        return JSONResponse({"success": False, "error": "No items selected"}, status_code=400)

    # Generate invoice number
    count_result = supabase.table("invoices").select("id", count="exact").eq("quote_id", quote_id).execute()
    idx = (count_result.count or 0) + 1
    invoice_number = f"INV-{idx:02d}-{quote.get('idn_quote', quote_id[:8])}"

    try:
        # Create invoice with all fields
        invoice_data = {
            "quote_id": quote_id,
            "supplier_id": supplier_id,
            "buyer_company_id": buyer_company_id,
            "pickup_location_id": pickup_location_id,
            "pickup_country": pickup_country,
            "currency": currency,
            "invoice_number": invoice_number,
            "total_weight_kg": float(total_weight_kg),
            "total_volume_m3": float(total_volume_m3) if total_volume_m3 else None,
        }

        result = supabase.table("invoices").insert(invoice_data).execute()

        if not result.data:
            return JSONResponse({"success": False, "error": "Failed to create invoice"}, status_code=500)

        invoice_id = result.data[0]["id"]

        # Assign selected items to this invoice and set supplier_country
        supabase.table("quote_items") \
            .update({
                "invoice_id": invoice_id,
                "purchase_currency": currency,
                "supplier_country": pickup_country,
            }) \
            .in_("id", item_ids) \
            .eq("quote_id", quote_id) \
            .execute()

        # Handle file upload if provided
        invoice_file = form.get("invoice_file")
        if invoice_file and hasattr(invoice_file, 'filename') and invoice_file.filename:
            file_content = await invoice_file.read()
            if file_content:
                doc, error = upload_document(
                    organization_id=org_id,
                    entity_type="supplier_invoice",
                    entity_id=invoice_id,
                    file_content=file_content,
                    filename=invoice_file.filename,
                    document_type="invoice_scan",
                    uploaded_by=user["id"],
                    parent_quote_id=quote_id,
                )
                if error:
                    print(f"Warning: Failed to upload invoice document: {error}")

        # Return success JSON
        return JSONResponse({"success": True, "invoice_id": invoice_id})

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/invoices/update", methods=["PATCH"])
async def api_update_invoice(quote_id: str, session, request):
    """Update an existing invoice."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    form = await request.form()
    invoice_id = form.get("invoice_id")

    if not invoice_id:
        return JSONResponse({"success": False, "error": "Invoice ID required"}, status_code=400)

    supabase = get_supabase()

    # Build update data
    update_data = {}

    invoice_number = form.get("invoice_number")
    if invoice_number:
        update_data["invoice_number"] = invoice_number.strip()

    currency = form.get("currency")
    if currency:
        update_data["currency"] = currency

    weight = form.get("total_weight_kg")
    if weight:
        update_data["total_weight_kg"] = float(weight)

    volume = form.get("total_volume_m3")
    if volume:
        update_data["total_volume_m3"] = float(volume)

    # Handle file upload if provided
    invoice_file = form.get("invoice_file")
    has_file_upload = invoice_file and hasattr(invoice_file, 'filename') and invoice_file.filename

    if not update_data and not has_file_upload:
        return JSONResponse({"success": False, "error": "No fields to update"}, status_code=400)

    try:
        if update_data:
            supabase.table("invoices").update(update_data).eq("id", invoice_id).execute()

            # Also update currency on linked items
            if currency:
                supabase.table("quote_items") \
                    .update({"purchase_currency": currency}) \
                    .eq("invoice_id", invoice_id) \
                    .execute()

        # Handle file upload
        if has_file_upload:
            file_content = await invoice_file.read()
            if file_content:
                # Delete existing document first
                existing_docs = get_documents_for_entity("supplier_invoice", invoice_id)
                for doc in existing_docs:
                    delete_document(doc.id)

                # Upload new document
                doc, error = upload_document(
                    organization_id=org_id,
                    entity_type="supplier_invoice",
                    entity_id=invoice_id,
                    file_content=file_content,
                    filename=invoice_file.filename,
                    document_type="invoice_scan",
                    uploaded_by=user["id"],
                    parent_quote_id=quote_id,
                )
                if error:
                    print(f"Warning: Failed to upload invoice document: {error}")

        return await render_invoices_list(quote_id, org_id, session)

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/invoices/{invoice_id}", methods=["DELETE"])
async def api_delete_invoice(quote_id: str, invoice_id: str, session):
    """Delete an invoice and unlink items."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    supabase = get_supabase()

    # Verify quote belongs to user's organization
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    try:
        # Unlink items first (scoped to quote_id for safety)
        supabase.table("quote_items") \
            .update({"invoice_id": None}) \
            .eq("invoice_id", invoice_id) \
            .eq("quote_id", quote_id) \
            .execute()

        # Delete invoice (scoped to quote_id for safety)
        supabase.table("invoices") \
            .delete() \
            .eq("id", invoice_id) \
            .eq("quote_id", quote_id) \
            .execute()

        return JSONResponse({"success": True})

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/invoices/{invoice_id}/complete", methods=["POST"])
async def api_complete_invoice(quote_id: str, invoice_id: str, session):
    """Complete an invoice - moves it to logistics/customs stage."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    supabase = get_supabase()

    # Verify quote belongs to user's organization
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Get invoice
    invoice_result = supabase.table("invoices") \
        .select("*") \
        .eq("id", invoice_id) \
        .eq("quote_id", quote_id) \
        .single() \
        .execute()

    if not invoice_result.data:
        return JSONResponse({"success": False, "error": "Invoice not found"}, status_code=404)

    invoice = invoice_result.data

    # Check invoice is in pending_procurement status
    if invoice.get("status") != "pending_procurement":
        return JSONResponse({"success": False, "error": "Invoice is not in procurement stage"}, status_code=400)

    # Get items in this invoice
    items_result = supabase.table("quote_items") \
        .select("id, purchase_price_original, production_time_days, is_unavailable") \
        .eq("invoice_id", invoice_id) \
        .eq("quote_id", quote_id) \
        .execute()

    items = items_result.data or []

    if not items:
        return JSONResponse({"success": False, "error": "Invoice has no items"}, status_code=400)

    # Validate: all items must have (price > 0 AND production_time > 0) OR be marked unavailable
    invalid_items = []
    for item in items:
        is_unavailable = item.get("is_unavailable", False)
        if is_unavailable:
            continue  # Unavailable items are OK

        has_price = item.get("purchase_price_original") and float(item.get("purchase_price_original", 0)) > 0
        has_time = item.get("production_time_days") and int(item.get("production_time_days", 0)) > 0

        if not has_price or not has_time:
            invalid_items.append(item["id"])

    if invalid_items:
        return JSONResponse({
            "success": False,
            "error": f"Не все позиции заполнены. {len(invalid_items)} поз. без цены или срока производства (и не отмечены как недоступные)."
        }, status_code=400)

    try:
        # Update invoice status
        supabase.table("invoices") \
            .update({
                "status": "pending_logistics",
                "procurement_completed_at": "now()",
                "procurement_completed_by": user_id
            }) \
            .eq("id", invoice_id) \
            .execute()

        # Mark all items in this invoice as procurement completed
        # This is required for quote workflow transition check
        supabase.table("quote_items") \
            .update({"procurement_status": "completed"}) \
            .eq("invoice_id", invoice_id) \
            .execute()

        # Check if ALL items in quote are now in completed invoices
        # If yes, auto-transition the quote workflow
        all_invoices = supabase.table("invoices") \
            .select("id, status") \
            .eq("quote_id", quote_id) \
            .execute()

        all_items = supabase.table("quote_items") \
            .select("id, invoice_id, is_unavailable") \
            .eq("quote_id", quote_id) \
            .execute()

        invoices_data = all_invoices.data or []
        items_data = all_items.data or []

        # Get IDs of completed invoices (not pending_procurement)
        completed_invoice_ids = set(
            inv["id"] for inv in invoices_data
            if inv.get("status") != "pending_procurement"
        )

        # Check: all items must either:
        # 1. Be in a completed invoice (which validated price + production_time), OR
        # 2. Be marked as unavailable (can skip invoice entirely)
        all_items_ready = all(
            (item.get("invoice_id") and item.get("invoice_id") in completed_invoice_ids)
            or item.get("is_unavailable", False)
            for item in items_data
        ) if items_data else False

        workflow_transitioned = False
        if all_items_ready:
            # All items are in completed invoices - transition quote workflow
            try:
                user_roles = user.get("roles", [])
                result = complete_procurement(quote_id, user_id, user_roles)
                workflow_transitioned = result.success if result else False
            except Exception as workflow_err:
                # Log but don't fail - invoice was completed successfully
                print(f"Auto-transition failed: {workflow_err}")

        return JSONResponse({
            "success": True,
            "new_status": "pending_logistics",
            "workflow_transitioned": workflow_transitioned
        })

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/invoices/{invoice_id}/reopen", methods=["POST"])
async def api_reopen_invoice(quote_id: str, invoice_id: str, session):
    """Reopen an invoice - returns it to procurement stage."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    supabase = get_supabase()

    # Verify quote belongs to user's organization
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Get invoice
    invoice_result = supabase.table("invoices") \
        .select("*") \
        .eq("id", invoice_id) \
        .eq("quote_id", quote_id) \
        .single() \
        .execute()

    if not invoice_result.data:
        return JSONResponse({"success": False, "error": "Invoice not found"}, status_code=404)

    invoice = invoice_result.data

    # Only allow reopening if not yet fully completed (customs done)
    if invoice.get("status") == "completed":
        return JSONResponse({"success": False, "error": "Cannot reopen fully completed invoice"}, status_code=400)

    try:
        # Update invoice status back to procurement
        supabase.table("invoices") \
            .update({
                "status": "pending_procurement",
                "procurement_completed_at": None,
                "procurement_completed_by": None
            }) \
            .eq("id", invoice_id) \
            .execute()

        return JSONResponse({"success": True, "new_status": "pending_procurement"})

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/items/assign", methods=["POST"])
async def api_assign_items_to_invoice(quote_id: str, session, request):
    """Bulk assign items to an invoice."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    body = await request.body()
    try:
        data = json.loads(body)
    except json.JSONDecodeError:
        return JSONResponse({"success": False, "error": "Invalid JSON"}, status_code=400)

    item_ids = data.get("item_ids", [])
    invoice_id = data.get("invoice_id")

    if not item_ids or not invoice_id:
        return JSONResponse({"success": False, "error": "item_ids and invoice_id required"}, status_code=400)

    supabase = get_supabase()

    # Verify quote belongs to user's organization
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    try:
        # Get invoice currency (verify invoice belongs to this quote)
        invoice_result = supabase.table("invoices") \
            .select("currency") \
            .eq("id", invoice_id) \
            .eq("quote_id", quote_id) \
            .single() \
            .execute()

        if not invoice_result.data:
            return JSONResponse({"success": False, "error": "Invoice not found"}, status_code=404)

        currency = invoice_result.data.get("currency", "USD")

        # Update items
        supabase.table("quote_items") \
            .update({
                "invoice_id": invoice_id,
                "purchase_currency": currency
            }) \
            .in_("id", item_ids) \
            .eq("quote_id", quote_id) \
            .execute()

        return JSONResponse({"success": True, "updated": len(item_ids)})

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/items/bulk", methods=["PATCH"])
async def api_bulk_update_items(quote_id: str, session, request):
    """Bulk update item prices and production times."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    body = await request.body()
    try:
        data = json.loads(body)
    except json.JSONDecodeError:
        return JSONResponse({"success": False, "error": "Invalid JSON"}, status_code=400)

    items = data.get("items", [])
    if not items:
        return JSONResponse({"success": False, "error": "No items provided"}, status_code=400)

    supabase = get_supabase()

    # Verify quote belongs to user's organization
    quote_result = supabase.table("quotes") \
        .select("id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return JSONResponse({"success": False, "error": "Quote not found"}, status_code=404)

    # Get valid item IDs for this quote (batch validation)
    item_ids = [item.get("id") for item in items if item.get("id")]
    if not item_ids:
        return JSONResponse({"success": False, "error": "No valid item IDs"}, status_code=400)

    valid_items_result = supabase.table("quote_items") \
        .select("id") \
        .eq("quote_id", quote_id) \
        .in_("id", item_ids) \
        .execute()

    valid_item_ids = set(item["id"] for item in valid_items_result.data or [])

    try:
        updated = 0
        for item in items:
            item_id = item.get("id")
            if not item_id or item_id not in valid_item_ids:
                continue

            update_data = {}

            if "purchase_price_original" in item and item["purchase_price_original"] is not None:
                update_data["purchase_price_original"] = item["purchase_price_original"]

            if "production_time_days" in item and item["production_time_days"] is not None:
                update_data["production_time_days"] = item["production_time_days"]

            # Support price_includes_vat checkbox
            if "price_includes_vat" in item:
                update_data["price_includes_vat"] = bool(item["price_includes_vat"])

            # Support is_unavailable checkbox
            if "is_unavailable" in item:
                update_data["is_unavailable"] = bool(item["is_unavailable"])

            # Note: supplier_country is now set at invoice level, not per-item

            if update_data:
                supabase.table("quote_items") \
                    .update(update_data) \
                    .eq("id", item_id) \
                    .execute()
                updated += 1

        return JSONResponse({"success": True, "updated": updated})

    except Exception as e:
        return JSONResponse({"success": False, "error": str(e)}, status_code=500)


@rt("/api/procurement/{quote_id}/complete", methods=["POST"])
async def api_complete_procurement(quote_id: str, session):
    """Complete procurement for all user's items."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    # Check if user is admin - bypass brand filtering
    is_admin = user_has_any_role(session, ["admin"])

    supabase = get_supabase()

    # Get user's assigned brands (admin sees all)
    my_brands = get_assigned_brands(user_id, org_id) if not is_admin else []
    my_brands_lower = [b.lower() for b in my_brands]

    # Get all items for this quote
    items_result = supabase.table("quote_items") \
        .select("id, brand") \
        .eq("quote_id", quote_id) \
        .execute()

    all_items = items_result.data or []

    # Filter items for my brands - admin can complete all
    if is_admin:
        my_item_ids = [item["id"] for item in all_items]
    else:
        my_item_ids = [item["id"] for item in all_items
                       if (item.get("brand") or "").lower() in my_brands_lower]

    if my_item_ids:
        # Mark items as completed
        supabase.table("quote_items") \
            .update({
                "procurement_status": "completed",
                "procurement_completed_at": datetime.utcnow().isoformat(),
                "procurement_completed_by": user_id
            }) \
            .in_("id", my_item_ids) \
            .execute()

    # Check if ALL items are complete and trigger workflow transition
    user_roles = get_user_roles_from_session(session)
    completion_result = complete_procurement(
        quote_id=quote_id,
        actor_id=user_id,
        actor_roles=user_roles
    )

    return JSONResponse({
        "success": True,
        "completed_items": len(my_item_ids),
        "workflow_transitioned": completion_result.success if completion_result else False
    })


# ============================================================================
# DOCUMENT API ENDPOINTS
# ============================================================================

@rt("/api/documents/{document_id}/download")
def api_document_download(document_id: str, session):
    """Get a download URL for a document."""
    redirect = require_login(session)
    if redirect:
        return RedirectResponse("/login", status_code=303)

    # Get download URL
    download_url = get_download_url(document_id, expires_in=3600, force_download=True)
    if not download_url:
        return JSONResponse({"success": False, "error": "Document not found"}, status_code=404)

    return RedirectResponse(download_url, status_code=302)


@rt("/api/documents/{document_id}", methods=["DELETE"])
def api_delete_document(document_id: str, session):
    """Delete a document."""
    redirect = require_login(session)
    if redirect:
        return JSONResponse({"success": False, "error": "Unauthorized"}, status_code=401)

    user = session["user"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return JSONResponse({"success": False, "error": "Forbidden"}, status_code=403)

    # Delete the document
    success, error = delete_document(document_id)
    if success:
        return JSONResponse({"success": True})
    else:
        return JSONResponse({"success": False, "error": error or "Delete failed"}, status_code=500)


async def render_invoices_list(quote_id: str, org_id: str, session):
    """Helper to render the invoices list HTML for HTMX updates."""
    supabase = get_supabase()
    user = session["user"]
    user_id = user["id"]

    # Check if user is admin - bypass brand filtering
    is_admin = user_has_any_role(session, ["admin"])

    # Get user's assigned brands (admin sees all)
    my_brands = get_assigned_brands(user_id, org_id) if not is_admin else []
    my_brands_lower = [b.lower() for b in my_brands]

    # Get invoices
    invoices_result = supabase.table("invoices") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    invoices = invoices_result.data or []

    # Get items
    items_result = supabase.table("quote_items") \
        .select("id, brand, invoice_id, purchase_price_original, quantity") \
        .eq("quote_id", quote_id) \
        .execute()

    all_items = items_result.data or []
    if is_admin:
        my_items = all_items
    else:
        my_items = [item for item in all_items
                    if (item.get("brand") or "").lower() in my_brands_lower]

    # Get supplier and buyer names
    supplier_ids = list(set(inv.get("supplier_id") for inv in invoices if inv.get("supplier_id")))
    suppliers = {}
    if supplier_ids:
        suppliers_result = supabase.table("suppliers").select("id, name").in_("id", supplier_ids).execute()
        suppliers = {s["id"]: s["name"] for s in suppliers_result.data or []}

    buyer_company_ids = list(set(inv.get("buyer_company_id") for inv in invoices if inv.get("buyer_company_id")))
    buyer_companies = {}
    if buyer_company_ids:
        buyers_result = supabase.table("buyer_companies").select("id, name").in_("id", buyer_company_ids).execute()
        buyer_companies = {b["id"]: b["name"] for b in buyers_result.data or []}

    currency_symbols = {"USD": "$", "EUR": "€", "RUB": "₽", "CNY": "¥", "TRY": "₺"}

    # Build invoice cards
    cards = []
    for idx, inv in enumerate(invoices, 1):
        supp = suppliers.get(inv.get("supplier_id"), "—")
        buyer = buyer_companies.get(inv.get("buyer_company_id"), "—")
        currency = inv.get("currency", "USD")
        currency_sym = currency_symbols.get(currency, currency)
        weight = inv.get("total_weight_kg")

        items_in_invoice = len([i for i in my_items if i.get("invoice_id") == inv["id"]])
        total_sum = sum(
            (item.get("purchase_price_original", 0) or 0) * (item.get("quantity", 0) or 0)
            for item in my_items if item.get("invoice_id") == inv["id"]
        )

        cards.append(
            Div(
                Div(
                    Span(f"📦 Инвойс #{idx}", style="font-weight: 600;"),
                    Span(f"{items_in_invoice} поз.", style="font-size: 0.75rem; color: #666; background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 999px;"),
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
                ),
                Div(
                    Span(supp, style="font-size: 0.875rem;"),
                    Span(" → ", style="color: #9ca3af;"),
                    Span(buyer, style="font-size: 0.875rem;"),
                    style="margin-bottom: 0.5rem;"
                ),
                Div(
                    Span(currency, style="font-weight: 500; color: #059669; margin-right: 0.75rem;"),
                    Span(f"{weight or '—'} кг", style="color: #666; margin-right: 0.75rem;") if weight else Span("⚠ вес", style="color: #f59e0b; margin-right: 0.75rem;"),
                    Span(f"Σ {total_sum:,.2f} {currency_sym}", style="font-weight: 500;") if total_sum > 0 else None,
                    style="font-size: 0.75rem;"
                ),
                Div(
                    A("Редактировать", href="#", onclick=f"openEditInvoiceModal('{inv['id']}'); return false;",
                      style="font-size: 0.75rem; color: #3b82f6; margin-right: 0.75rem;"),
                    A("Назначить ↓", href="#", onclick=f"assignSelectedToInvoice('{inv['id']}'); return false;",
                      style="font-size: 0.75rem; color: #059669;"),
                    style="margin-top: 0.5rem;"
                ),
                cls="card",
                style="padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid #3b82f6;",
                id=f"invoice-card-{inv['id']}",
                onclick=f"selectInvoice('{inv['id']}')"
            )
        )

    if not cards:
        return Div(
            P("Нет инвойсов", style="color: #666; text-align: center;"),
            P("Создайте инвойс, чтобы начать", style="color: #9ca3af; text-align: center; font-size: 0.875rem;"),
            style="padding: 2rem 0;"
        )

    return Div(*cards)


# ============================================================================
# PROCUREMENT EXCEL EXPORT (Feature #36)
# ============================================================================


# ============================================================================
# PROCUREMENT - RETURN TO QUOTE CONTROL (Feature: multi-department return)
# ============================================================================

@rt("/procurement/{quote_id}/return-to-control")
def get(quote_id: str, session):
    """
    Form for procurement to return a revised quote back to quote control.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data
    workflow_status = quote.get("workflow_status", "draft")
    revision_comment = quote.get("revision_comment", "")
    idn_quote = quote.get("idn_quote", f"#{quote_id[:8]}")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    # Can only return from pending_procurement status
    if workflow_status != "pending_procurement":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}»."),
            A("← Назад", href=f"/procurement/{quote_id}"),
            session=session
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    comment_box_style = """
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        padding: 16px;
        border-radius: 0 8px 8px 0;
        margin-bottom: 24px;
    """

    textarea_style = """
        width: 100%;
        min-height: 120px;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
    """

    return page_layout(f"Вернуть на проверку - {idn_quote}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), f" Назад к закупкам", href=f"/procurement/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1("Вернуть КП на проверку",
               style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            Div(
                icon("file-text", size=14, style="color: #64748b;"),
                Span(f"КП: {idn_quote}", style="color: #475569; font-weight: 500;"),
                Span(" • ", style="color: #cbd5e1;"),
                Span(f"Клиент: {customer_name}", style="color: #64748b;"),
                style="display: flex; align-items: center; gap: 8px; font-size: 14px;"
            ),
            style=header_style
        ),

        # Original comment (if present)
        Div(
            Div(icon("message-circle", size=14), " Исходный комментарий контроллёра", style=section_header_style),
            P(revision_comment if revision_comment else "— нет комментария —",
              style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.5;"),
            style=comment_box_style
        ) if revision_comment else None,

        # Form
        Form(
            Div(
                Div(icon("edit-3", size=14), " Комментарий об исправлениях *", style=section_header_style),
                P("Опишите, какие исправления были внесены:",
                  style="color: #64748b; font-size: 13px; margin: 0 0 12px 0;"),
                Textarea(
                    name="comment",
                    placeholder="Исправлена цена на позицию X...\nОбновлены данные поставщика...\nИзменены сроки производства...",
                    required=True,
                    style=textarea_style
                ),
                style="margin-bottom: 24px;"
            ),
            Div(
                Button(icon("check", size=14), " Вернуть на проверку", type="submit",
                       style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                A(icon("x", size=14), " Отмена", href=f"/procurement/{quote_id}",
                  style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
                style="display: flex; gap: 12px;"
            ),
            action=f"/procurement/{quote_id}/return-to-control",
            method="post",
            style=form_card_style
        ),
        session=session
    )


@rt("/procurement/{quote_id}/return-to-control")
def post(quote_id: str, session, comment: str = ""):
    """
    Handle return to quote control from procurement.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["procurement", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка"),
            P("Необходимо указать комментарий об исправлениях."),
            A("← Вернуться", href=f"/procurement/{quote_id}/return-to-control"),
            session=session
        )

    supabase = get_supabase()

    # Verify quote exists
    quote_result = supabase.table("quotes") \
        .select("workflow_status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    current_status = quote_result.data[0].get("workflow_status", "draft")

    if current_status != "pending_procurement":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}»."),
            A("← Назад", href=f"/procurement/{quote_id}"),
            session=session
        )

    # Perform workflow transition
    user_roles = get_user_roles_from_session(session)
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.PENDING_QUOTE_CONTROL,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"Исправления от закупок: {comment.strip()}"
    )

    if result.success:
        # Clear revision fields after returning
        supabase.table("quotes").update({
            "revision_department": None,
            "revision_comment": None,
            "revision_returned_at": None
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на проверку"),
            P("КП отправлено контроллёру КП для повторной проверки."),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось вернуть КП: {result.error_message}"),
            A("← Назад", href=f"/procurement/{quote_id}/return-to-control"),
            session=session
        )


@rt("/procurement/{quote_id}/export")
def get(quote_id: str, session):
    """
    Export procurement items to Excel for sending to suppliers.

    Feature #36: Скачивание списка для оценки
    - Exports items belonging to user's assigned brands
    - Creates Excel file with columns for supplier to fill in
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has procurement role
    if not user_has_any_role(session, ["procurement", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote with customer info
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    quote = quote_result.data
    if not quote:
        return RedirectResponse("/procurement", status_code=303)

    customer_name = quote.get("customers", {}).get("name", "") if quote.get("customers") else ""

    # Check if user is admin - bypass brand filtering
    is_admin = user_has_any_role(session, ["admin"])

    # Get user's assigned brands (admin sees all)
    my_brands = get_assigned_brands(user_id, org_id) if not is_admin else []
    my_brands_lower = [b.lower() for b in my_brands]

    # Get all items for this quote
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    all_items = items_result.data or []

    # Filter items for my brands (handle None brand values) - admin sees all
    if is_admin:
        my_items = all_items
    else:
        my_items = [item for item in all_items
                    if (item.get("brand") or "").lower() in my_brands_lower]

    if not my_items:
        # No items to export, redirect back with message
        return RedirectResponse(f"/procurement/{quote_id}", status_code=303)

    # Generate Excel
    excel_bytes = create_procurement_excel(
        quote=quote,
        items=my_items,
        brands=my_brands,
        customer_name=customer_name
    )

    # Return as file download
    from starlette.responses import Response
    filename = build_export_filename(
        doc_type="procurement",
        customer_name=customer_name,
        quote_number=quote.get("idn_quote", ''),
        ext="xlsx"
    )
    return Response(
        content=excel_bytes,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        headers={"Content-Disposition": f"attachment; filename={filename}"}
    )


# ============================================================================
# LOGISTICS WORKSPACE (Feature #38)
# ============================================================================

@rt("/logistics")
def get(session, status_filter: str = None):
    """
    Redirect to unified dashboard logistics tab.
    Old URL preserved for backwards compatibility.
    """
    url = "/dashboard?tab=logistics"
    if status_filter:
        url += f"&status_filter={status_filter}"
    return RedirectResponse(url, status_code=303)


# ============================================================================
# LOGISTICS DETAIL PAGE
# ============================================================================

@rt("/logistics/{quote_id}")
def get(session, quote_id: str):
    """
    Logistics detail page - view and edit logistics data for a quote.

    Feature UI-020 (v4.0): Invoice-based logistics workspace
    - Shows invoices (not individual items)
    - Displays weight/volume per invoice (filled by procurement)
    - Single logistics cost field per invoice (not per item)
    - Only editable when quote is in pending_logistics or pending_customs status
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has logistics role
    if not user_has_any_role(session, ["logistics", "admin", "head_of_logistics"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch quote with customer info
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("Quote Not Found"),
            P("The requested quote was not found or you don't have access."),
            A("← Back to Tasks", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")
    customer_name = quote.get("customers", {}).get("name", "Unknown") if quote.get("customers") else "Unknown"
    currency = quote.get("currency", "RUB")

    # Check for revision status (returned from quote control)
    revision_department = quote.get("revision_department")
    revision_comment = quote.get("revision_comment")
    is_revision = revision_department == "logistics" and workflow_status == "pending_logistics"

    # Check if quote is ready for logistics (procurement must be done first)
    ready_for_logistics_statuses = ["pending_logistics", "pending_customs", "pending_logistics_and_customs", "pending_sales_review"]
    is_ready_for_logistics = workflow_status in ready_for_logistics_statuses

    # Check if logistics is editable (only when ready and not completed)
    is_editable = is_ready_for_logistics and quote.get("logistics_completed_at") is None
    logistics_done = quote.get("logistics_completed_at") is not None

    # Fetch invoices for this quote
    invoices_result = supabase.table("invoices") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    invoices = invoices_result.data or []

    # For each invoice, fetch its items and related data (location, supplier)
    invoices_with_items = []
    for invoice in invoices:
        items_result = supabase.table("quote_items") \
            .select("id, brand, product_name, quantity, purchase_price_original, purchase_currency, supplier_country") \
            .eq("invoice_id", invoice["id"]) \
            .execute()

        invoice_data = dict(invoice)
        invoice_data["items"] = items_result.data or []

        # Load pickup location info
        pickup_location_id = invoice.get("pickup_location_id")
        if pickup_location_id:
            try:
                from services.location_service import get_location
                loc = get_location(pickup_location_id)
                if loc:
                    invoice_data["pickup_location"] = {
                        "city": loc.city,
                        "country": loc.country
                    }
            except:
                pass

        # Load supplier info
        supplier_id = invoice.get("supplier_id")
        if supplier_id:
            try:
                from services.supplier_service import get_supplier
                sup = get_supplier(supplier_id)
                if sup:
                    invoice_data["supplier"] = {
                        "name": sup.name,
                        "country": sup.country
                    }
            except:
                pass

        invoices_with_items.append(invoice_data)

    # Calculate summary stats from invoices
    # Import currency conversion for multi-currency logistics
    from services.currency_service import convert_amount
    from decimal import Decimal

    total_invoices = len(invoices)
    invoices_with_logistics = 0
    total_logistics_cost = Decimal(0)  # Will be in quote currency
    total_weight = 0
    total_volume = 0
    total_items = 0
    unique_countries = set()

    for inv in invoices_with_items:
        total_items += len(inv["items"])
        total_weight += float(inv.get("total_weight_kg") or 0)
        total_volume += float(inv.get("total_volume_m3") or 0)

        # Count logistics completion per invoice
        # Each segment may be in different currency - convert to quote currency before summing
        s2h = Decimal(str(inv.get("logistics_supplier_to_hub") or 0))
        s2h_currency = inv.get("logistics_supplier_to_hub_currency") or "USD"
        h2c = Decimal(str(inv.get("logistics_hub_to_customs") or 0))
        h2c_currency = inv.get("logistics_hub_to_customs_currency") or "USD"
        c2c = Decimal(str(inv.get("logistics_customs_to_customer") or 0))
        c2c_currency = inv.get("logistics_customs_to_customer_currency") or "USD"

        # Convert each segment to quote currency
        s2h_converted = convert_amount(s2h, s2h_currency, currency) if s2h > 0 else Decimal(0)
        h2c_converted = convert_amount(h2c, h2c_currency, currency) if h2c > 0 else Decimal(0)
        c2c_converted = convert_amount(c2c, c2c_currency, currency) if c2c > 0 else Decimal(0)

        inv_total = s2h_converted + h2c_converted + c2c_converted
        if inv_total > 0 or inv.get("logistics_total_days"):
            invoices_with_logistics += 1
        total_logistics_cost += inv_total

        # Collect countries from items
        for item in inv["items"]:
            if item.get("supplier_country"):
                unique_countries.add(item["supplier_country"])

    # Convert total to float for display
    total_logistics_cost = float(total_logistics_cost)

    # Build invoice form cards for v4.0 invoice-level logistics
    def logistics_invoice_card(invoice, idx):
        invoice_id = invoice.get("id")
        invoice_number = invoice.get("invoice_number", f"Invoice #{idx+1}")
        inv_currency = invoice.get("currency", currency)

        # Get current invoice logistics values
        s2h = invoice.get("logistics_supplier_to_hub") or 0
        h2c = invoice.get("logistics_hub_to_customs") or 0
        c2c = invoice.get("logistics_customs_to_customer") or 0
        days = invoice.get("logistics_total_days") or ""
        # Currency values for each segment (default: USD)
        s2h_currency = invoice.get("logistics_supplier_to_hub_currency") or "USD"
        h2c_currency = invoice.get("logistics_hub_to_customs_currency") or "USD"
        c2c_currency = invoice.get("logistics_customs_to_customer_currency") or "USD"
        invoice_logistics_total = float(s2h) + float(h2c) + float(c2c)  # Note: mixed currencies, for display only

        # Invoice completion indicator
        has_logistics = invoice_logistics_total > 0 or days
        status_icon_elem = icon("check-circle", size=16) if has_logistics else icon("clock", size=16)
        status_color = "#22c55e" if has_logistics else "#f59e0b"

        # Weight/volume from procurement
        weight = invoice.get("total_weight_kg") or 0
        volume = invoice.get("total_volume_m3") or 0

        # Items list
        items = invoice.get("items", [])
        total_items_in_invoice = len(items)

        # Country code/name to Russian name mapping
        country_names = {
            # ISO codes
            "DE": "Германия", "CN": "Китай", "TR": "Турция", "IT": "Италия",
            "RU": "Россия", "US": "США", "KR": "Корея", "JP": "Япония",
            "FR": "Франция", "GB": "Великобритания", "ES": "Испания", "PL": "Польша",
            "CZ": "Чехия", "NL": "Нидерланды", "BE": "Бельгия", "AT": "Австрия",
            "CH": "Швейцария", "SE": "Швеция", "FI": "Финляндия", "DK": "Дания",
            "IN": "Индия", "TW": "Тайвань", "VN": "Вьетнам", "TH": "Таиланд",
            "MY": "Малайзия", "SG": "Сингапур", "AE": "ОАЭ", "SA": "Саудовская Аравия",
            "OTHER": "Другое",
            # English names
            "Germany": "Германия", "China": "Китай", "Turkey": "Турция", "Italy": "Италия",
            "Russia": "Россия", "United States": "США", "USA": "США",
            "South Korea": "Корея", "Korea": "Корея", "Japan": "Япония",
            "France": "Франция", "United Kingdom": "Великобритания", "UK": "Великобритания",
            "Spain": "Испания", "Poland": "Польша", "Czech Republic": "Чехия",
            "Netherlands": "Нидерланды", "Belgium": "Бельгия", "Austria": "Австрия",
            "Switzerland": "Швейцария", "Sweden": "Швеция", "Finland": "Финляндия",
            "Denmark": "Дания", "India": "Индия", "Taiwan": "Тайвань",
            "Vietnam": "Вьетнам", "Thailand": "Таиланд", "Malaysia": "Малайзия",
            "Singapore": "Сингапур", "UAE": "ОАЭ", "Saudi Arabia": "Саудовская Аравия",
        }

        # Get origin location text
        origin_city = (
            invoice.get("pickup_location", {}).get("city", "")
            if invoice.get("pickup_location") and invoice.get("pickup_location", {}).get("city")
            else ""
        )
        # Origin country: pickup_location > supplier > invoice.pickup_country
        raw_origin_country = (
            invoice.get("pickup_location", {}).get("country", "")
            if invoice.get("pickup_location") and invoice.get("pickup_location", {}).get("country")
            else (invoice.get("supplier", {}).get("country", ""))
            if invoice.get("supplier") and invoice.get("supplier", {}).get("country")
            else invoice.get("pickup_country", "")
        )
        # Convert country code to name if needed
        origin_country = country_names.get(raw_origin_country, raw_origin_country) if raw_origin_country else ""

        dest_city = quote.get('delivery_city', '')
        raw_dest_country = quote.get('delivery_country', '')
        dest_country = country_names.get(raw_dest_country, raw_dest_country) if raw_dest_country else ""
        delivery_method_text = {"air": "Авиа", "auto": "Авто", "sea": "Море", "multimodal": "Мульти"}.get(
            quote.get("delivery_method", ""), "—"
        )
        delivery_method_icon = {"air": "✈", "auto": "🚛", "sea": "🚢", "multimodal": "📦"}.get(
            quote.get("delivery_method", ""), "📦"
        )

        # Styles
        card_style = f"""
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            overflow: hidden;
        """
        header_style = f"""
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: {'linear-gradient(90deg, #f0fdf4 0%, #fafbfc 100%)' if has_logistics else '#fafbfc'};
            border-bottom: 1px solid #e2e8f0;
        """
        body_style = """
            display: flex;
            padding: 16px;
            gap: 20px;
        """
        route_card_style = """
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border: 1px solid #e8ecf1;
            flex: 0 0 280px;
            display: flex;
            flex-direction: column;
        """
        pricing_card_style = """
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            flex: 1;
            min-width: 300px;
        """
        input_row_style = """
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        """
        input_row_last_style = """
            display: flex;
            align-items: center;
            padding: 8px 0;
        """
        label_style = """
            font-size: 13px;
            color: #64748b;
            width: 90px;
            font-weight: 500;
        """
        input_style = """
            width: 90px;
            padding: 8px 10px;
            font-size: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            transition: all 0.2s;
        """
        select_style = """
            width: 62px;
            padding: 8px 4px;
            font-size: 13px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #f8fafc;
            margin-left: 8px;
            color: #64748b;
            cursor: pointer;
            flex-shrink: 0;
        """

        return Div(
            # Invoice header
            Div(
                Div(
                    Span(status_icon_elem, style=f"color: {status_color}; margin-right: 8px;"),
                    Span(invoice_number, style="font-weight: 600; color: #1e293b; font-size: 14px;"),
                    Span(f"  •  {inv_currency}", style="color: #94a3b8; font-size: 13px; margin-left: 4px;"),
                    style="display: flex; align-items: center;"
                ),
                Span(f"#{idx+1}", style="color: #94a3b8; font-size: 12px; font-weight: 500; background: #f1f5f9; padding: 2px 8px; border-radius: 4px;"),
                style=header_style
            ),

            # Two-column layout
            Div(
                # LEFT: Route visualization
                Div(
                    # Origin
                    Div(
                        Div("ОТКУДА", style="font-size: 10px; color: #94a3b8; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600;"),
                        Div(origin_city, style="font-size: 15px; color: #059669; font-weight: 600;") if origin_city else None,
                        Div(origin_country or "—", style=f"font-size: {'12px' if origin_city else '15px'}; color: {'#64748b' if origin_city else '#059669'}; font-weight: {'400' if origin_city else '600'};"),
                        style="margin-bottom: 12px;"
                    ),
                    # Arrow
                    Div(
                        Div(
                            Span("", style="display: block; width: 2px; height: 20px; background: linear-gradient(to bottom, #059669, #3b82f6); margin: 0 auto;"),
                            Span("▼", style="color: #3b82f6; font-size: 8px; display: block; text-align: center; margin-top: -2px;"),
                        ),
                        style="padding: 4px 0;"
                    ),
                    # Destination
                    Div(
                        Div("КУДА", style="font-size: 10px; color: #94a3b8; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600;"),
                        Div(dest_city, style="font-size: 15px; color: #3b82f6; font-weight: 600;") if dest_city else None,
                        Div(dest_country or "—", style=f"font-size: {'12px' if dest_city else '15px'}; color: {'#64748b' if dest_city else '#3b82f6'}; font-weight: {'400' if dest_city else '600'};"),
                        style="margin-bottom: 12px;"
                    ),
                    # Delivery method badge
                    Div(
                        Span(f"{delivery_method_icon} {delivery_method_text}",
                             style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-block;"),
                        style="margin-top: auto; padding-top: 8px; border-top: 1px solid #f1f5f9;"
                    ),
                    # Weight & items
                    Div(
                        Div(
                            Span(f"{weight} кг" if weight > 0 else "—", style=f"font-weight: 600; color: {'#059669' if weight > 0 else '#94a3b8'};"),
                            style="font-size: 13px;"
                        ),
                        Span("•", style="color: #cbd5e1; margin: 0 8px;"),
                        Div(
                            Span(f"{total_items_in_invoice} поз.", style="color: #64748b;"),
                            style="font-size: 13px;"
                        ),
                        style="display: flex; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0;"
                    ),
                    # Expandable items
                    Details(
                        Summary(Span("Показать товары", style="font-size: 12px; color: #3b82f6; cursor: pointer;")),
                        Div(
                            *[Div(
                                Span(f"{item.get('brand', '—')} — {item.get('product_name', '—')[:25]}", style="flex: 1; color: #475569;"),
                                Span(f"×{item.get('quantity', 0)}", style="color: #94a3b8; font-weight: 500;"),
                                style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px;"
                            ) for item in items],
                            style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;"
                        ),
                        style="margin-top: 8px;"
                    ) if items else None,
                    style=route_card_style
                ),

                # RIGHT: Pricing card (elevated)
                Div(
                    # Two-column layout: pricing on left, comment on right
                    Div(
                        # LEFT: Pricing inputs
                        Div(
                            Div("СТОИМОСТЬ ДОСТАВКИ", style="font-size: 10px; color: #94a3b8; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 10px;"),
                            # Row 1
                            Div(
                                Span("Поставщик → Хаб", style=label_style),
                                Input(name=f"logistics_supplier_to_hub_{invoice_id}", type="number", value=str(s2h),
                                      min="0", step="0.01", disabled=not is_editable, style=input_style),
                                Select(
                                    Option("USD", value="USD", selected=s2h_currency == "USD"),
                                    Option("EUR", value="EUR", selected=s2h_currency == "EUR"),
                                    Option("RUB", value="RUB", selected=s2h_currency == "RUB"),
                                    Option("CNY", value="CNY", selected=s2h_currency == "CNY"),
                                    Option("TRY", value="TRY", selected=s2h_currency == "TRY"),
                                    name=f"logistics_supplier_to_hub_currency_{invoice_id}",
                                    disabled=not is_editable, style=select_style
                                ),
                                style=input_row_style
                            ),
                            # Row 2
                            Div(
                                Span("Хаб → Таможня", style=label_style),
                                Input(name=f"logistics_hub_to_customs_{invoice_id}", type="number", value=str(h2c),
                                      min="0", step="0.01", disabled=not is_editable, style=input_style),
                                Select(
                                    Option("USD", value="USD", selected=h2c_currency == "USD"),
                                    Option("EUR", value="EUR", selected=h2c_currency == "EUR"),
                                    Option("RUB", value="RUB", selected=h2c_currency == "RUB"),
                                    Option("CNY", value="CNY", selected=h2c_currency == "CNY"),
                                    Option("TRY", value="TRY", selected=h2c_currency == "TRY"),
                                    name=f"logistics_hub_to_customs_currency_{invoice_id}",
                                    disabled=not is_editable, style=select_style
                                ),
                                style=input_row_style
                            ),
                            # Row 3
                            Div(
                                Span("Таможня → Клиент", style=label_style),
                                Input(name=f"logistics_customs_to_customer_{invoice_id}", type="number", value=str(c2c),
                                      min="0", step="0.01", disabled=not is_editable, style=input_style),
                                Select(
                                    Option("USD", value="USD", selected=c2c_currency == "USD"),
                                    Option("EUR", value="EUR", selected=c2c_currency == "EUR"),
                                    Option("RUB", value="RUB", selected=c2c_currency == "RUB"),
                                    Option("CNY", value="CNY", selected=c2c_currency == "CNY"),
                                    Option("TRY", value="TRY", selected=c2c_currency == "TRY"),
                                    name=f"logistics_customs_to_customer_currency_{invoice_id}",
                                    disabled=not is_editable, style=select_style
                                ),
                                style=input_row_style
                            ),
                            # Row 4: Days
                            Div(
                                Span("Срок доставки", style=label_style),
                                Input(name=f"logistics_total_days_{invoice_id}", type="number",
                                      value=str(days) if days else "", min="1", max="365",
                                      disabled=not is_editable, style=input_style),
                                Span("дней", style="margin-left: 8px; color: #94a3b8; font-size: 13px;"),
                                style=input_row_last_style
                            ),
                            style="flex: 0 0 auto;"
                        ),
                        # RIGHT: Comment box
                        Div(
                            Div("КОММЕНТАРИЙ", style="font-size: 10px; color: #94a3b8; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 10px;"),
                            Textarea(
                                invoice.get("logistics_notes", ""),
                                name=f"logistics_notes_{invoice_id}",
                                placeholder="Заметки по доставке, особые условия, контакты перевозчика...",
                                disabled=not is_editable,
                                rows="5",
                                style="width: 100%; height: 100%; min-height: 120px; padding: 10px 12px; font-size: 13px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; resize: none; flex: 1; font-family: inherit; line-height: 1.5;"
                            ),
                            style="flex: 1; min-width: 200px; display: flex; flex-direction: column;"
                        ),
                        style="display: flex; gap: 24px;"
                    ),
                    style=pricing_card_style
                ),
                style=body_style
            ),
            style=card_style
        )

    # Build the invoice-level logistics form
    invoice_logistics_section = Div(
        H3(icon("file-text", size=20), " Логистика по инвойсам (v4.0)", style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"),
        P("Введите стоимость доставки для каждого инвойса. Вес/объём заполнен закупками.",
          style="color: #666; margin-bottom: 1rem;"),
        *[logistics_invoice_card(invoice, idx) for idx, invoice in enumerate(invoices_with_items)],
    ) if invoices_with_items else Div(
        P("Нет инвойсов для расчёта логистики. Закупки должны создать инвойсы сначала.", style="color: #666;"),
        cls="card"
    )


    # Form wrapper
    logistics_form = Form(
        # Invoice-level logistics (v4.0)
        invoice_logistics_section,

        # Action buttons - sticky footer bar
        Div(
            Div(
                btn("Сохранить данные", variant="secondary", icon_name="save", type="submit", name="action", value="save") if is_editable else None,
                btn("✓ Завершить логистику", variant="success", icon_name=None, type="submit", name="action", value="complete") if is_editable else None,
                Span(icon("check-circle", size=16), " Логистика завершена", style="color: #22c55e; font-weight: bold; display: inline-flex; align-items: center; gap: 0.25rem;") if logistics_done else None,
                style="display: inline-flex; gap: 1rem; align-items: center;"
            ),
            style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"
        ) if is_editable or logistics_done else None,

        method="post",
        action=f"/logistics/{quote_id}"
    )

    # Status banners
    # Not ready for logistics (still in procurement/draft)
    not_ready_banner = Div(
        P(icon("clock", size=16), " КП ещё не готово для логистики. Ожидается завершение этапа закупок.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        P(f"Текущий статус: {STATUS_NAMES.get(workflow_status, workflow_status)}",
          style="margin: 0.5rem 0 0; font-size: 0.875rem; color: #666;"),
        style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if not is_ready_for_logistics and not logistics_done else None

    # Other non-editable status
    status_banner = Div(
        P(icon("alert-triangle", size=16), f" Данный КП в статусе '{STATUS_NAMES.get(workflow_status, workflow_status)}' — редактирование логистики недоступно.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if is_ready_for_logistics and not is_editable and not logistics_done else None

    success_banner = Div(
        P(icon("check-circle", size=16), " Логистика по данному КП завершена.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        style="background-color: #dcfce7; border: 1px solid #22c55e; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if logistics_done else None

    return page_layout(f"Logistics - {quote.get('idn_quote', '')}",
        # Back link
        Div(
            A("← К задачам", href="/tasks", style="color: #666; font-size: 0.875rem;"),
            style="margin-bottom: 1rem;"
        ),

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "logistics", user.get("roles", [])),

        # Header
        Div(
            H1(f"Логистика: {quote.get('idn_quote', '')}", cls="page-header"),
            Div(
                Span(f"Клиент: {customer_name}", style="margin-right: 1rem;"),
                workflow_status_badge(workflow_status),
                style="display: flex; align-items: center; gap: 0.5rem;"
            ),
            style="margin-bottom: 1rem;"
        ),

        # Workflow progress bar (Feature #87)
        workflow_progress_bar(workflow_status),

        # Partial recalculation banner - shown when returned from client for logistics-only changes
        Div(
            Div(
                Span("🔄 Частичный пересчёт: только логистика", style="font-weight: 600; font-size: 1.1rem;"),
                style="margin-bottom: 0.5rem;"
            ),
            Div(
                P("Клиент запросил изменение логистики. Данные закупки и таможни сохранены.", style="margin: 0 0 0.5rem;"),
                P("После обновления логистики КП автоматически вернётся клиенту.", style="margin: 0; font-size: 0.875rem; color: #666;"),
            ),
            cls="card",
            style="background: #e0f2fe; border: 2px solid #0891b2; margin-bottom: 1rem;"
        ) if quote.get("partial_recalc") == "logistics" else None,

        # Revision banner - shown when returned from quote control (Feature: multi-department return)
        Div(
            Div(
                Span("↩ Возвращено на доработку", style="font-weight: 600; font-size: 1.1rem;"),
                style="margin-bottom: 0.5rem;"
            ),
            Div(
                Span("Комментарий контроллёра КП:", style="font-weight: 500;"),
                P(revision_comment, style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap;"),
                style="margin-bottom: 1rem;"
            ) if revision_comment else None,
            Div(
                P("После внесения исправлений верните КП на проверку.", style="margin: 0 0 0.75rem; font-size: 0.875rem;"),
                A("✓ Вернуть на проверку", href=f"/logistics/{quote_id}/return-to-control",
                  role="button", style="background: #22c55e; border-color: #22c55e;"),
            ),
            cls="card",
            style="background: #fef3c7; border: 2px solid #f59e0b; margin-bottom: 1rem;"
        ) if is_revision else None,

        # Status banners
        not_ready_banner,
        success_banner,
        status_banner,

        # Logistics form with item-level editing (v4.0 compact design)
        logistics_form,

        # Transition history (Feature #88)
        workflow_transition_history(quote_id),

        session=session
    )


@rt("/logistics/{quote_id}")
async def post(session, quote_id: str, request):
    """
    Save logistics data and optionally mark logistics as complete.

    Feature UI-020 (v4.0): Invoice-based logistics POST handler
    - Saves invoice-level logistics costs to invoices table
    - Handles 'complete' action to mark logistics as done
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["logistics", "admin", "head_of_logistics"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Verify quote exists and belongs to org
    quote_result = supabase.table("quotes") \
        .select("id, workflow_status, logistics_completed_at") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return RedirectResponse("/logistics", status_code=303)

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is ready for logistics (procurement must be done first)
    ready_statuses = ["pending_logistics", "pending_customs", "pending_logistics_and_customs", "pending_sales_review"]
    if workflow_status not in ready_statuses or quote.get("logistics_completed_at"):
        return RedirectResponse(f"/logistics/{quote_id}", status_code=303)

    # Get form data
    form_data = await request.form()

    # Helper functions
    def safe_decimal(val, default="0"):
        try:
            return float(val) if val else float(default)
        except:
            return float(default)

    def safe_int(val, default=None):
        try:
            return int(val) if val else default
        except:
            return default

    # ==========================================
    # v4.0: Save invoice-level logistics to invoices table
    # ==========================================

    # Get all invoices for this quote
    invoices_result = supabase.table("invoices") \
        .select("id") \
        .eq("quote_id", quote_id) \
        .execute()

    invoices = invoices_result.data or []

    # Update each invoice's logistics fields
    for invoice in invoices:
        invoice_id = invoice["id"]

        # Get invoice-specific logistics values from form
        s2h = form_data.get(f"logistics_supplier_to_hub_{invoice_id}")
        h2c = form_data.get(f"logistics_hub_to_customs_{invoice_id}")
        c2c = form_data.get(f"logistics_customs_to_customer_{invoice_id}")
        days = form_data.get(f"logistics_total_days_{invoice_id}")
        notes = form_data.get(f"logistics_notes_{invoice_id}")
        # Currency values for each segment
        s2h_currency = form_data.get(f"logistics_supplier_to_hub_currency_{invoice_id}")
        h2c_currency = form_data.get(f"logistics_hub_to_customs_currency_{invoice_id}")
        c2c_currency = form_data.get(f"logistics_customs_to_customer_currency_{invoice_id}")

        # Build update data
        update_data = {}

        if s2h is not None:
            update_data["logistics_supplier_to_hub"] = safe_decimal(s2h)
        if h2c is not None:
            update_data["logistics_hub_to_customs"] = safe_decimal(h2c)
        if c2c is not None:
            update_data["logistics_customs_to_customer"] = safe_decimal(c2c)
        if days is not None:
            days_val = safe_int(days)
            update_data["logistics_total_days"] = days_val if days_val and days_val > 0 else None
        if notes is not None:
            update_data["logistics_notes"] = notes
        # Save currency values
        if s2h_currency:
            update_data["logistics_supplier_to_hub_currency"] = s2h_currency
        if h2c_currency:
            update_data["logistics_hub_to_customs_currency"] = h2c_currency
        if c2c_currency:
            update_data["logistics_customs_to_customer_currency"] = c2c_currency

        # Update invoice if we have data
        if update_data:
            try:
                supabase.table("invoices") \
                    .update(update_data) \
                    .eq("id", invoice_id) \
                    .execute()
            except Exception as e:
                print(f"Error updating logistics for invoice {invoice_id}: {e}")

    # Get action
    action = form_data.get("action", "save")

    # If action is complete, mark logistics as done
    if action == "complete":
        user_roles = get_user_roles_from_session(session)
        result = complete_logistics(quote_id, user_id, user_roles)

        if not result.success:
            # Log error but still redirect
            print(f"Error completing logistics: {result.error_message}")
        else:
            # Check for partial recalculation mode
            try:
                partial_check = supabase.table("quotes") \
                    .select("partial_recalc") \
                    .eq("id", quote_id) \
                    .single() \
                    .execute()

                partial_recalc = partial_check.data.get("partial_recalc") if partial_check.data else None

                if partial_recalc == "logistics":
                    # Partial recalculation - skip customs, return to client negotiation
                    # Clear partial_recalc flag and transition to client_negotiation
                    supabase.table("quotes").update({
                        "partial_recalc": None
                    }).eq("id", quote_id).execute()

                    # Transition directly to client_negotiation
                    transition_quote_status(
                        quote_id=quote_id,
                        to_status="client_negotiation",
                        actor_id=user_id,
                        actor_roles=user_roles,
                        comment="Partial recalculation: logistics updated, returning to client negotiation"
                    )
            except Exception as e:
                print(f"Error checking partial_recalc: {e}")

    return RedirectResponse(f"/logistics/{quote_id}", status_code=303)


# ============================================================================
# LOGISTICS - RETURN TO QUOTE CONTROL (Feature: multi-department return)
# ============================================================================

@rt("/logistics/{quote_id}/return-to-control")
def get(quote_id: str, session):
    """
    Form for logistics to return a revised quote back to quote control.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["logistics", "admin", "head_of_logistics"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data
    workflow_status = quote.get("workflow_status", "draft")
    revision_comment = quote.get("revision_comment", "")
    idn_quote = quote.get("idn_quote", f"#{quote_id[:8]}")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    if workflow_status != "pending_logistics":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}»."),
            A("← Назад", href=f"/logistics/{quote_id}"),
            session=session
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    comment_box_style = """
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        padding: 16px;
        border-radius: 0 8px 8px 0;
        margin-bottom: 24px;
    """

    textarea_style = """
        width: 100%;
        min-height: 120px;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
    """

    return page_layout(f"Вернуть на проверку - {idn_quote}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), f" Назад к логистике", href=f"/logistics/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1("Вернуть КП на проверку",
               style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            Div(
                icon("file-text", size=14, style="color: #64748b;"),
                Span(f"КП: {idn_quote}", style="color: #475569; font-weight: 500;"),
                Span(" • ", style="color: #cbd5e1;"),
                Span(f"Клиент: {customer_name}", style="color: #64748b;"),
                style="display: flex; align-items: center; gap: 8px; font-size: 14px;"
            ),
            style=header_style
        ),

        # Original comment (if present)
        Div(
            Div(icon("message-circle", size=14), " Исходный комментарий контроллёра", style=section_header_style),
            P(revision_comment if revision_comment else "— нет комментария —",
              style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.5;"),
            style=comment_box_style
        ) if revision_comment else None,

        # Form
        Form(
            Div(
                Div(icon("edit-3", size=14), " Комментарий об исправлениях *", style=section_header_style),
                P("Опишите, какие исправления были внесены:",
                  style="color: #64748b; font-size: 13px; margin: 0 0 12px 0;"),
                Textarea(
                    name="comment",
                    placeholder="Исправлены расчёты доставки...\nИзменены маршруты...\nОбновлены сроки...",
                    required=True,
                    style=textarea_style
                ),
                style="margin-bottom: 24px;"
            ),
            Div(
                Button(icon("check", size=14), " Вернуть на проверку", type="submit",
                       style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                A(icon("x", size=14), " Отмена", href=f"/logistics/{quote_id}",
                  style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
                style="display: flex; gap: 12px;"
            ),
            action=f"/logistics/{quote_id}/return-to-control",
            method="post",
            style=form_card_style
        ),
        session=session
    )


@rt("/logistics/{quote_id}/return-to-control")
def post(quote_id: str, session, comment: str = ""):
    """
    Handle return to quote control from logistics.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["logistics", "admin", "head_of_logistics"]):
        return RedirectResponse("/unauthorized", status_code=303)

    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка"),
            P("Необходимо указать комментарий об исправлениях."),
            A("← Вернуться", href=f"/logistics/{quote_id}/return-to-control"),
            session=session
        )

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("workflow_status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    current_status = quote_result.data[0].get("workflow_status", "draft")

    if current_status != "pending_logistics":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}»."),
            A("← Назад", href=f"/logistics/{quote_id}"),
            session=session
        )

    user_roles = get_user_roles_from_session(session)
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.PENDING_QUOTE_CONTROL,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"Исправления от логистики: {comment.strip()}"
    )

    if result.success:
        supabase.table("quotes").update({
            "revision_department": None,
            "revision_comment": None,
            "revision_returned_at": None
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на проверку"),
            P("КП отправлено контроллёру КП для повторной проверки."),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось вернуть КП: {result.error_message}"),
            A("← Назад", href=f"/logistics/{quote_id}/return-to-control"),
            session=session
        )


# ============================================================================
# CUSTOMS WORKSPACE (Feature #42)
# ============================================================================

@rt("/customs")
def get(session, status_filter: str = None):
    """
    Redirect to unified dashboard customs tab.
    Old URL preserved for backwards compatibility.
    """
    url = "/dashboard?tab=customs"
    if status_filter:
        url += f"&status_filter={status_filter}"
    return RedirectResponse(url, status_code=303)


# ============================================================================
# CUSTOMS DETAIL PAGE (Feature #44, #45)
# ============================================================================

@rt("/customs/{quote_id}")
def get(session, quote_id: str):
    """
    Customs detail page - view and edit customs data for each item in a quote.

    Feature UI-021 (v3.0): Customs workspace view
    - Shows quote summary and items with item-level customs data (hs_code, duty %)
    - Shows quote-level costs section (5 fields: brokerage, SVH, documentation)
    - Pickup location and supplier display for each item (v3.0 supply chain)
    - Only editable when quote is in pending_customs or pending_logistics status
    - Uses v3.0 field names: hs_code, customs_duty (no per-item extra costs)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has customs role (includes head_of_customs for v3.0)
    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch quote with customer info
    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("Quote Not Found"),
            P("The requested quote was not found or you don't have access."),
            A("← Back to Tasks", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")
    customer_name = quote.get("customers", {}).get("name", "Unknown") if quote.get("customers") else "Unknown"
    currency = quote.get("currency", "RUB")

    # Check for revision status (returned from quote control)
    revision_department = quote.get("revision_department")
    revision_comment = quote.get("revision_comment")
    is_revision = revision_department == "customs" and workflow_status == "pending_customs"

    # Fetch quote items with v3.0 customs and supply chain fields (extra costs at quote level)
    items_result = supabase.table("quote_items") \
        .select("""
            id, brand, product_code, product_name, quantity, unit,
            base_price_vat, purchase_price_original, purchase_currency,
            weight_in_kg, volume_m3, supplier_country,
            pickup_location_id, supplier_id,
            hs_code, customs_duty
        """) \
        .eq("quote_id", quote_id) \
        .order("created_at") \
        .execute()

    items = items_result.data or []

    # Load calculation variables (for quote-level costs)
    calc_vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()

    calc_vars = {}
    if calc_vars_result.data:
        calc_vars = calc_vars_result.data[0].get("variables", {})

    # Extract quote-level customs costs (defaults to 0)
    brokerage_hub = calc_vars.get("brokerage_hub", 0)
    brokerage_customs = calc_vars.get("brokerage_customs", 0)
    warehousing_at_customs = calc_vars.get("warehousing_at_customs", 0)
    customs_documentation = calc_vars.get("customs_documentation", 0)
    brokerage_extra = calc_vars.get("brokerage_extra", 0)

    # Extract currency for each brokerage field (default RUB - as per user feedback these are typically in rubles)
    brokerage_hub_currency = calc_vars.get("brokerage_hub_currency", "RUB")
    brokerage_customs_currency = calc_vars.get("brokerage_customs_currency", "RUB")
    warehousing_at_customs_currency = calc_vars.get("warehousing_at_customs_currency", "RUB")
    customs_documentation_currency = calc_vars.get("customs_documentation_currency", "RUB")
    brokerage_extra_currency = calc_vars.get("brokerage_extra_currency", "RUB")

    # Check if quote is ready for customs (procurement must be done first)
    ready_for_customs_statuses = ["pending_customs", "pending_logistics", "pending_logistics_and_customs", "pending_sales_review"]
    is_ready_for_customs = workflow_status in ready_for_customs_statuses

    # Check if customs is editable (only when ready and not completed)
    is_editable = is_ready_for_customs and quote.get("customs_completed_at") is None
    customs_done = quote.get("customs_completed_at") is not None

    # Check if customs can be completed
    can_complete_customs = is_ready_for_customs and not customs_done

    # v3.0: Fetch pickup location info for items
    pickup_location_map = {}
    pickup_location_ids = [item.get("pickup_location_id") for item in items if item.get("pickup_location_id")]
    if pickup_location_ids:
        try:
            from services.location_service import get_location, format_location_for_dropdown
            for pickup_location_id in set(pickup_location_ids):
                try:
                    loc = get_location(pickup_location_id)
                    if loc:
                        pickup_location_map[pickup_location_id] = {
                            "id": loc.id,
                            "label": format_location_for_dropdown(loc).get("label", loc.display_name or f"{loc.city}, {loc.country}"),
                            "city": loc.city,
                            "country": loc.country
                        }
                except Exception:
                    pass
        except ImportError:
            pass

    # v3.0: Fetch supplier info for items
    supplier_map = {}
    supplier_ids = [item.get("supplier_id") for item in items if item.get("supplier_id")]
    if supplier_ids:
        try:
            from services.supplier_service import get_supplier, format_supplier_for_dropdown
            for supplier_id in set(supplier_ids):
                try:
                    sup = get_supplier(supplier_id)
                    if sup:
                        supplier_map[supplier_id] = {
                            "id": sup.id,
                            "label": format_supplier_for_dropdown(sup).get("label", sup.name),
                            "country": sup.country
                        }
                except Exception:
                    pass
        except ImportError:
            pass

    # Calculate summary stats with v3.0 fields
    total_items = len(items)
    items_with_hs = sum(1 for item in items if item.get("hs_code"))
    items_with_customs = 0
    total_customs_cost = 0

    for item in items:
        duty_percent = float(item.get("customs_duty") or 0)
        purchase_price = float(item.get("purchase_price_original") or item.get("base_price_vat") or 0)
        quantity = float(item.get("quantity") or 1)

        # Calculate duty amount based on purchase price * duty percent (extra costs now at quote level)
        duty_amount = purchase_price * quantity * (duty_percent / 100)
        item_customs_total = duty_amount

        if item.get("hs_code") and item.get("customs_duty") is not None:
            items_with_customs += 1
        total_customs_cost += item_customs_total

    # Prepare items data for Handsontable (JSON)
    items_for_handsontable = [
        {
            'id': item.get('id'),
            'row_num': idx + 1,
            'brand': item.get('brand', ''),
            'product_name': item.get('product_name', ''),
            'quantity': item.get('quantity', 1),
            'supplier_country': item.get('supplier_country', ''),
            'hs_code': item.get('hs_code') or '',
            'customs_duty': float(item.get('customs_duty') or 0)
        } for idx, item in enumerate(items)
    ]
    items_json = json.dumps(items_for_handsontable)

    # Build item cards for v3.0 item-level customs data (DEPRECATED - replaced by Handsontable)
    def customs_item_card(item, idx):
        item_id = item.get("id")
        pickup_info = pickup_location_map.get(item.get("pickup_location_id"))
        supplier_info = supplier_map.get(item.get("supplier_id"))

        # Get current item customs values (v3.0 fields)
        hs_code = item.get("hs_code") or ""
        duty_percent = item.get("customs_duty") or 0

        # Calculate duty amount for display (extra costs now at quote level)
        purchase_price = float(item.get("purchase_price_original") or item.get("base_price_vat") or 0)
        quantity = float(item.get("quantity") or 1)
        duty_amount = purchase_price * quantity * (float(duty_percent) / 100)
        item_customs_total = duty_amount

        # Item completion indicator
        has_customs = hs_code and duty_percent is not None
        status_icon_elem = icon("check-circle", size=16) if has_customs else icon("clock", size=16)
        status_color = "#22c55e" if has_customs else "#f59e0b"

        # Weight/volume reference
        weight = item.get("weight_kg") or item.get("weight_in_kg") or 0
        volume = item.get("volume_m3") or 0

        return Div(
            # Item header
            Div(
                Div(
                    Span(status_icon_elem, style=f"color: {status_color}; margin-right: 0.25rem;"),
                    Strong(item.get("brand", "—")),
                    Span(f" — {(item.get('product_name') or '—')[:50]}", style="color: #666;"),
                    style="flex: 1; display: flex; align-items: center;"
                ),
                Span(f"#{idx+1}", style="color: #999; font-size: 0.875rem;"),
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;"
            ),

            # Item info badges
            Div(
                Span(icon("package", size=14), f" Кол-во: {item.get('quantity', 0)}", style="margin-right: 1rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;"),
                Span(icon("scale", size=14), f" Вес: {weight} кг", style="margin-right: 1rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;") if weight else None,
                Span(icon("globe", size=14), f" {item.get('supplier_country', '—')}", style="margin-right: 1rem; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;"),
                # Pickup location badge (v3.0)
                Span(
                    icon("map-pin", size=14), f" {pickup_info['label'] if pickup_info else '—'}",
                    style="font-size: 0.875rem; color: #cc6600;",
                    title=f"Точка отгрузки: {pickup_info['city']}, {pickup_info['country']}" if pickup_info else "Точка отгрузки не указана"
                ) if pickup_info or item.get("pickup_location_id") else None,
                # Supplier badge (v3.0)
                Span(
                    icon("building-2", size=14), f" {supplier_info['label'][:30] if supplier_info else '—'}",
                    style="font-size: 0.875rem; color: #3b82f6; margin-left: 0.5rem;",
                    title=f"Поставщик: {supplier_info['label']}" if supplier_info else "Поставщик не указан"
                ) if supplier_info or item.get("supplier_id") else None,
                style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.25rem;"
            ),

            # Customs data inputs (v3.0 - item level)
            Div(
                H4(icon("shield-check", size=18), " Таможенные данные", style="margin: 0 0 0.75rem; font-size: 0.95rem; color: #374151; display: flex; align-items: center; gap: 0.5rem;"),
                Div(
                    # HS Code (ТН ВЭД)
                    Div(
                        Label("Код ТН ВЭД",
                            Input(
                                name=f"hs_code_{item_id}",
                                type="text",
                                value=hs_code,
                                placeholder="8482.10.10",
                                maxlength="20",
                                disabled=not is_editable,
                                style="width: 100%;"
                            ),
                            style="display: block; font-size: 0.875rem;"
                        ),
                        Small("Формат: XXXX.XX.XX", style="color: #999;"),
                        style="flex: 1;"
                    ),
                    # Duty Percent
                    Div(
                        Label("Пошлина %",
                            Input(
                                name=f"customs_duty_{item_id}",
                                type="number",
                                value=str(duty_percent),
                                min="0",
                                max="100",
                                step="0.01",
                                disabled=not is_editable,
                                style="width: 100%;"
                            ),
                            style="display: block; font-size: 0.875rem;"
                        ),
                        style="flex: 0 0 150px;"
                    ),
                    style="display: flex; gap: 0.75rem;"
                ),
                style="background: #f9fafb; padding: 1rem; border-radius: 4px;"
            ),

            cls="card",
            style="margin-bottom: 1rem; border-left: 3px solid " + (status_color if has_customs else "#e5e7eb") + ";"
        )

    # ==========================================================================
    # CUSTOMS PAGE STYLING (Logistics-inspired compact design)
    # ==========================================================================
    customs_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 16px;
        margin-bottom: 12px;
    """
    customs_section_header_style = "font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;"
    customs_input_row_style = "display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;"
    customs_field_label_style = "font-size: 13px; color: #64748b; width: 140px; font-weight: 500;"
    customs_input_style = "width: 90px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc;"

    # Build the item-level customs section with Handsontable
    item_customs_section = Div(
        # Section header with gradient accent
        Div(
            Span(icon("package", size=14), style="color: #64748b;"),
            Span("ТАМОЖНЯ ПО ПОЗИЦИЯМ", style=customs_section_header_style[len("font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; "):]),
            Span(id="customs-items-count", style="margin-left: 0.5rem; color: #64748b; font-size: 12px;"),
            style=customs_section_header_style
        ),
        # Status and description row
        Div(
            P("Заполните код ТН ВЭД и процент пошлины для каждой позиции. Можно копировать из Excel.",
              style="color: #64748b; margin: 0 0 12px 0; font-size: 13px;"),
            Span(id="customs-save-status", style="font-size: 12px; color: #64748b;"),
            style="display: flex; justify-content: space-between; align-items: center;"
        ),
        # Handsontable container with enhanced styling
        Div(
            Div(id="customs-spreadsheet", style="width: 100%; height: 350px; overflow: hidden;"),
            cls="handsontable-container"
        ),
        style=customs_card_style
    ) if items else Div(
        Div(
            Span(icon("package", size=14), style="color: #64748b;"),
            Span("ТАМОЖНЯ ПО ПОЗИЦИЯМ", style=customs_section_header_style[len("font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; "):]),
            style=customs_section_header_style
        ),
        P("Нет позиций в КП для таможенного оформления.", style="color: #64748b; font-size: 13px;"),
        style=customs_card_style
    )

    # Helper to create currency options for brokerage fields
    def brokerage_currency_options(selected_currency):
        currencies = [("RUB", "₽ RUB"), ("USD", "$ USD"), ("EUR", "€ EUR"), ("CNY", "¥ CNY"), ("TRY", "₺ TRY")]
        return [Option(label, value=code, selected=(code == selected_currency)) for code, label in currencies]

    # Quote-level costs section (customs/brokerage expenses) - with gradient styling
    customs_costs_card_style = """
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-radius: 12px;
        border: 1px solid #fcd34d;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 16px;
        margin-bottom: 12px;
    """
    customs_costs_input_style = "width: 90px; padding: 8px 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: white;"
    customs_costs_select_style = "width: 70px; padding: 8px 6px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; margin-left: 6px;"

    quote_level_costs_section = Div(
        # Section header
        Div(
            Span(icon("wallet", size=14), style="color: #b45309;"),
            Span("ОБЩИЕ РАСХОДЫ НА КП", style="font-size: 11px; font-weight: 600; color: #b45309; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
            style="display: flex; align-items: center; margin-bottom: 12px;"
        ),
        P("Укажите общие расходы на всю квоту. Выберите валюту для каждого поля.",
          style="color: #92400e; margin: 0 0 16px 0; font-size: 13px;"),
        Div(
            # Row 1: brokerage_hub + brokerage_customs
            Div(
                Div(
                    Span("Брокерские (хаб)", style=customs_field_label_style),
                    Div(
                        Input(
                            name="brokerage_hub",
                            type="number",
                            value=str(brokerage_hub),
                            min="0",
                            step="0.01",
                            disabled=not is_editable,
                            style=customs_costs_input_style
                        ),
                        Select(
                            *brokerage_currency_options(brokerage_hub_currency),
                            name="brokerage_hub_currency",
                            disabled=not is_editable,
                            style=customs_costs_select_style
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style=customs_input_row_style
                ),
                Div(
                    Span("Брокерские (таможня)", style=customs_field_label_style),
                    Div(
                        Input(
                            name="brokerage_customs",
                            type="number",
                            value=str(brokerage_customs),
                            min="0",
                            step="0.01",
                            disabled=not is_editable,
                            style=customs_costs_input_style
                        ),
                        Select(
                            *brokerage_currency_options(brokerage_customs_currency),
                            name="brokerage_customs_currency",
                            disabled=not is_editable,
                            style=customs_costs_select_style
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style=customs_input_row_style
                ),
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"
            ),
            # Row 2: warehousing_at_customs + customs_documentation
            Div(
                Div(
                    Span("СВХ", style=customs_field_label_style),
                    Div(
                        Input(
                            name="warehousing_at_customs",
                            type="number",
                            value=str(warehousing_at_customs),
                            min="0",
                            step="0.01",
                            disabled=not is_editable,
                            style=customs_costs_input_style
                        ),
                        Select(
                            *brokerage_currency_options(warehousing_at_customs_currency),
                            name="warehousing_at_customs_currency",
                            disabled=not is_editable,
                            style=customs_costs_select_style
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style=customs_input_row_style
                ),
                Div(
                    Span("Документация", style=customs_field_label_style),
                    Div(
                        Input(
                            name="customs_documentation",
                            type="number",
                            value=str(customs_documentation),
                            min="0",
                            step="0.01",
                            disabled=not is_editable,
                            style=customs_costs_input_style
                        ),
                        Select(
                            *brokerage_currency_options(customs_documentation_currency),
                            name="customs_documentation_currency",
                            disabled=not is_editable,
                            style=customs_costs_select_style
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style=customs_input_row_style
                ),
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 8px;"
            ),
            # Row 3: brokerage_extra (half width)
            Div(
                Div(
                    Span("Доп. брокерские", style=customs_field_label_style),
                    Div(
                        Input(
                            name="brokerage_extra",
                            type="number",
                            value=str(brokerage_extra),
                            min="0",
                            step="0.01",
                            disabled=not is_editable,
                            style=customs_costs_input_style
                        ),
                        Select(
                            *brokerage_currency_options(brokerage_extra_currency),
                            name="brokerage_extra_currency",
                            disabled=not is_editable,
                            style=customs_costs_select_style
                        ),
                        style="display: flex; align-items: center;"
                    ),
                    style="display: flex; align-items: center; padding: 8px 0;"
                ),
                style="margin-top: 8px; width: 50%;"
            ),
        ),
        style=customs_costs_card_style
    )

    # Quote-level notes section - with gradient styling
    quote_level_section = Div(
        # Section header
        Div(
            Span(icon("message-square", size=14), style="color: #64748b;"),
            Span("ПРИМЕЧАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
            style="display: flex; align-items: center; margin-bottom: 12px;"
        ),
        Div(
            Span("Примечания таможенника", style="font-size: 13px; color: #64748b; font-weight: 500; display: block; margin-bottom: 8px;"),
            Textarea(
                quote.get("customs_notes") or "",
                name="customs_notes",
                rows="3",
                disabled=not is_editable,
                style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; resize: vertical;"
            ),
        ),
        style=customs_card_style
    )

    # Form wrapper (only for quote-level costs - items saved via Handsontable)
    customs_form = Form(
        # Quote-level costs (brokerage, SVH, documentation)
        quote_level_costs_section,

        # Quote-level notes
        quote_level_section,

        # Action buttons - sticky footer bar
        Div(
            Div(
                btn("Сохранить расходы", variant="secondary", icon_name="save", type="submit", name="action", value="save") if is_editable else None,
                btn("✓ Завершить таможню", variant="success", icon_name=None, type="submit", name="action", value="complete") if can_complete_customs else None,
                # Show message when editable but waiting for procurement
                Span(icon("clock", size=16), " Ожидание завершения закупок",
                     style="color: #f59e0b; font-weight: 500; display: inline-flex; align-items: center; gap: 0.25rem;"
                ) if is_editable and not can_complete_customs else None,
                Span(icon("check-circle", size=16), " Таможня завершена", style="color: #22c55e; font-weight: bold; display: inline-flex; align-items: center; gap: 0.25rem;") if customs_done else None,
                style="display: inline-flex; gap: 1rem; align-items: center;"
            ),
            style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;"
        ) if is_editable or customs_done else None,

        method="post",
        action=f"/customs/{quote_id}",
        id="customs-form"
    )

    # Status banners
    # Not ready for customs (still in procurement/draft)
    not_ready_banner = Div(
        P(icon("clock", size=16), " КП ещё не готово для таможни. Ожидается завершение этапа закупок.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        P(f"Текущий статус: {STATUS_NAMES.get(workflow_status, workflow_status)}",
          style="margin: 0.5rem 0 0; font-size: 0.875rem; color: #666;"),
        style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if not is_ready_for_customs and not customs_done else None

    # Other non-editable status
    status_banner = Div(
        P(icon("alert-triangle", size=16), f" Данный КП в статусе '{STATUS_NAMES.get(workflow_status, workflow_status)}' — редактирование таможни недоступно.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        style="background-color: #fef3c7; border: 1px solid #f59e0b; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if is_ready_for_customs and not is_editable and not customs_done else None

    success_banner = Div(
        P(icon("check-circle", size=16), " Таможня по данному КП завершена.",
          style="margin: 0; display: flex; align-items: center; gap: 0.5rem;"),
        style="background-color: #dcfce7; border: 1px solid #22c55e; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;"
    ) if customs_done else None

    # Progress indicator
    progress_percent = int(items_with_hs / total_items * 100) if total_items > 0 else 0

    return page_layout(f"Customs - {quote.get('idn_quote', '')}",
        # Back link
        Div(
            A("← К задачам", href="/tasks", style="color: #666; font-size: 0.875rem;"),
            style="margin-bottom: 1rem;"
        ),

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "customs", user.get("roles", [])),

        # Header
        Div(
            H1(icon("shield-check", size=28), f" Таможня: {quote.get('idn_quote', '')}", cls="page-header"),
            Div(
                Span(f"Клиент: {customer_name}", style="margin-right: 1rem;"),
                workflow_status_badge(workflow_status),
                style="display: flex; align-items: center; gap: 0.5rem;"
            ),
            style="margin-bottom: 1rem;"
        ),

        # Workflow progress bar (Feature #87)
        workflow_progress_bar(workflow_status),

        # Revision banner - shown when returned from quote control (Feature: multi-department return)
        Div(
            Div(
                Span("↩ Возвращено на доработку", style="font-weight: 600; font-size: 1.1rem;"),
                style="margin-bottom: 0.5rem;"
            ),
            Div(
                Span("Комментарий контроллёра КП:", style="font-weight: 500;"),
                P(revision_comment, style="margin: 0.25rem 0 0; font-style: italic; white-space: pre-wrap;"),
                style="margin-bottom: 1rem;"
            ) if revision_comment else None,
            Div(
                P("После внесения исправлений верните КП на проверку.", style="margin: 0 0 0.75rem; font-size: 0.875rem;"),
                A("✓ Вернуть на проверку", href=f"/customs/{quote_id}/return-to-control",
                  role="button", style="background: #22c55e; border-color: #22c55e;"),
            ),
            cls="card",
            style="background: #fef3c7; border: 2px solid #f59e0b; margin-bottom: 1rem;"
        ) if is_revision else None,

        # Status banners
        not_ready_banner,
        success_banner,
        status_banner,

        # Quote summary with customs stats (v3.0) - gradient styling
        Div(
            # Section header
            Div(
                Span(icon("file-text", size=14), style="color: #64748b;"),
                Span("СВОДКА ПО КП", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 12px;"
            ),
            Div(
                Div(
                    Div(str(total_items), cls="stat-value"),
                    Div("Позиций", style="font-size: 12px; color: #64748b;"),
                    cls="stat-card-mini"
                ),
                Div(
                    Div(f"{items_with_hs}/{total_items}", cls="stat-value"),
                    Div("Заполнено ТН ВЭД", style="font-size: 12px; color: #64748b;"),
                    cls="stat-card-mini"
                ),
                Div(
                    Div(f"{items_with_customs}/{total_items}", cls="stat-value"),
                    Div("С пошлиной", style="font-size: 12px; color: #64748b;"),
                    cls="stat-card-mini"
                ),
                style="display: flex; gap: 12px; margin-bottom: 12px;"
            ),
            # Progress bar
            Div(
                Div(
                    Div(style=f"width: {progress_percent}%; height: 100%; background: linear-gradient(90deg, {'#22c55e' if progress_percent == 100 else '#3b82f6'} 0%, {'#4ade80' if progress_percent == 100 else '#60a5fa'} 100%); border-radius: 4px;"),
                    style="background-color: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;"
                ),
                P(f"Прогресс: {progress_percent}% ({items_with_hs} из {total_items} позиций)", style="margin-top: 6px; font-size: 12px; color: #64748b;"),
            ),
            cls="customs-summary-card"
        ),

        # Instructions - gradient info card
        Div(
            Div(
                Span(icon("info", size=14), style="color: #1e40af;"),
                Span("ИНСТРУКЦИЯ", style="font-size: 11px; font-weight: 600; color: #1e40af; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 8px;"
            ),
            P("Заполните код ТН ВЭД и пошлину в таблице. Нажмите 'Сохранить расходы' для сохранения. Можно копировать из Excel.", style="margin: 0; font-size: 13px; color: #1e40af;"),
            style="background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%); border-radius: 12px; border: 1px solid #93c5fd; padding: 16px; margin-bottom: 12px;"
        ) if is_editable else None,

        # Items table (Handsontable - explicit save on button click)
        item_customs_section,

        # Quote-level costs form
        customs_form,

        # Transition history (Feature #88)
        workflow_transition_history(quote_id),

        # Additional styles - enhanced with gradient design
        Style("""
            .stat-card-mini {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                padding: 0.75rem 1rem;
                border-radius: 8px;
                text-align: center;
                border: 1px solid #e2e8f0;
            }
            .stat-card-mini .stat-value {
                font-size: 1.5rem;
                font-weight: bold;
                color: #1e40af;
            }
            .customs-summary-card {
                background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
                border-radius: 12px;
                border: 1px solid #e2e8f0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                padding: 16px;
                margin-bottom: 12px;
            }
        """),

        # Handsontable initialization script for customs (explicit save, no auto-save)
        Script(f"""
            (function() {{
                var quoteId = '{quote_id}';
                var initialData = {items_json};
                var isEditable = {'true' if is_editable else 'false'};
                var hot = null;
                var hasUnsavedChanges = false;

                function updateCount() {{
                    var count = hot ? hot.countRows() : 0;
                    var el = document.getElementById('customs-items-count');
                    if (el) el.textContent = '(' + count + ' позиций)';
                }}

                function showSaveStatus(status) {{
                    var el = document.getElementById('customs-save-status');
                    if (!el) return;
                    if (status === 'saving') {{
                        el.textContent = 'Сохранение...';
                        el.style.color = '#f59e0b';
                    }} else if (status === 'saved') {{
                        el.textContent = 'Сохранено';
                        el.style.color = '#10b981';
                        setTimeout(function() {{ el.textContent = ''; }}, 2000);
                    }} else if (status === 'error') {{
                        el.textContent = 'Ошибка сохранения';
                        el.style.color = '#ef4444';
                    }}
                }}

                // Save all customs items data (called on form submit)
                window.saveCustomsItems = function() {{
                    if (!hot) return Promise.resolve({{ success: true }});
                    // IMPORTANT: Finish any active cell edit before reading data
                    hot.deselectCell();
                    var sourceData = hot.getSourceData();
                    var items = sourceData.map(function(row) {{
                        return {{
                            id: row.id,
                            hs_code: row.hs_code || '',
                            customs_duty: parseFloat(row.customs_duty) || 0
                        }};
                    }}).filter(function(item) {{ return item.id; }});

                    if (items.length === 0) return Promise.resolve({{ success: true }});

                    showSaveStatus('saving');
                    return fetch('/api/customs/' + quoteId + '/items/bulk', {{
                        method: 'PATCH',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify({{ items: items }})
                    }})
                    .then(function(r) {{ return r.json(); }})
                    .then(function(data) {{
                        if (data.success) {{
                            showSaveStatus('saved');
                            hasUnsavedChanges = false;
                        }} else {{
                            showSaveStatus('error');
                        }}
                        return data;
                    }})
                    .catch(function(err) {{
                        showSaveStatus('error');
                        return {{ success: false, error: err.message }};
                    }});
                }};

                function initTable() {{
                    var container = document.getElementById('customs-spreadsheet');
                    if (!container || typeof Handsontable === 'undefined') return;

                    hot = new Handsontable(container, {{
                        licenseKey: 'non-commercial-and-evaluation',
                        data: initialData,
                        colHeaders: ['№', 'Бренд', 'Наименование', 'Кол-во', 'Страна закупки', 'Код ТН ВЭД', 'Пошлина %'],
                        columns: [
                            {{data: 'row_num', readOnly: true, type: 'numeric', width: 40,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  td.innerHTML = row + 1;
                                  td.style.textAlign = 'center';
                                  td.style.color = '#666';
                                  td.style.background = '#f9fafb';
                                  return td;
                              }}
                            }},
                            {{data: 'brand', readOnly: true, type: 'text', width: 100,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  td.innerHTML = value || '—';
                                  td.style.color = '#666';
                                  td.style.background = '#f9fafb';
                                  return td;
                              }}
                            }},
                            {{data: 'product_name', readOnly: true, type: 'text', width: 250,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  td.innerHTML = (value || '—').substring(0, 50);
                                  td.style.color = '#666';
                                  td.style.background = '#f9fafb';
                                  return td;
                              }}
                            }},
                            {{data: 'quantity', readOnly: true, type: 'numeric', width: 60,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  td.innerHTML = value || 0;
                                  td.style.textAlign = 'center';
                                  td.style.color = '#666';
                                  td.style.background = '#f9fafb';
                                  return td;
                              }}
                            }},
                            {{data: 'supplier_country', readOnly: true, type: 'text', width: 80,
                              renderer: function(instance, td, row, col, prop, value, cellProperties) {{
                                  td.innerHTML = value || '—';
                                  td.style.color = '#666';
                                  td.style.background = '#f9fafb';
                                  return td;
                              }}
                            }},
                            {{data: 'hs_code', type: 'text', width: 120, readOnly: !isEditable}},
                            {{data: 'customs_duty', type: 'numeric', width: 80, readOnly: !isEditable,
                              numericFormat: {{pattern: '0.00'}}
                            }}
                        ],
                        rowHeaders: false,
                        stretchH: 'all',
                        autoWrapRow: true,
                        autoWrapCol: true,
                        contextMenu: isEditable ? ['copy', 'cut'] : ['copy'],
                        manualColumnResize: true,
                        afterChange: function(changes, source) {{
                            if (source === 'loadData' || !changes) return;
                            hasUnsavedChanges = true;
                        }}
                    }});

                    updateCount();
                    window.customsHot = hot;

                    // Intercept form submission to save items first
                    var form = document.getElementById('customs-form');
                    if (form && isEditable) {{
                        form.addEventListener('submit', function(e) {{
                            e.preventDefault();
                            var submitBtn = e.submitter;
                            var action = submitBtn ? submitBtn.value : 'save';

                            // Save items first, then submit form
                            window.saveCustomsItems().then(function(result) {{
                                if (result.success) {{
                                    // Create hidden input for action and submit
                                    var actionInput = document.createElement('input');
                                    actionInput.type = 'hidden';
                                    actionInput.name = 'action';
                                    actionInput.value = action;
                                    form.appendChild(actionInput);

                                    // Remove event listener and submit
                                    form.removeEventListener('submit', arguments.callee);
                                    form.submit();
                                }} else {{
                                    alert('Ошибка сохранения данных таможни');
                                }}
                            }});
                        }});
                    }}
                }}

                if (document.readyState === 'loading') {{
                    document.addEventListener('DOMContentLoaded', initTable);
                }} else {{
                    initTable();
                }}
            }})();
        """) if items else None,

        session=session
    )


@rt("/customs/{quote_id}")
async def post(session, quote_id: str, request):
    """
    Save customs data for all items and optionally mark customs as complete.

    Feature UI-021 (v3.0): Customs workspace POST handler
    - Saves item-level customs data to quote_items table (hs_code, customs_duty)
    - Saves quote-level costs to quote_calculation_variables (5 fields)
    - Saves quote-level customs_notes
    - Handles 'complete' action to mark customs as done
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Get form data
    form_data = await request.form()
    action = form_data.get("action", "save")
    customs_notes = form_data.get("customs_notes", "")

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role (includes head_of_customs for v3.0)
    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Verify quote exists and belongs to org
    quote_result = supabase.table("quotes") \
        .select("id, workflow_status, customs_completed_at") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return RedirectResponse("/customs", status_code=303)

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is ready for customs (procurement must be done first)
    ready_statuses = ["pending_customs", "pending_logistics", "pending_logistics_and_customs", "pending_sales_review"]
    if workflow_status not in ready_statuses or quote.get("customs_completed_at"):
        return RedirectResponse(f"/customs/{quote_id}", status_code=303)

    # Get all items for this quote
    items_result = supabase.table("quote_items") \
        .select("id") \
        .eq("quote_id", quote_id) \
        .execute()

    items = items_result.data or []

    # Helper function for safe decimal conversion
    def safe_decimal(val, default=0):
        try:
            return float(val) if val else default
        except:
            return default

    # NOTE: Item-level customs data (hs_code, customs_duty) is saved via
    # JavaScript bulk PATCH to /api/customs/{quote_id}/items/bulk on form submit.
    # DO NOT add a loop here to update item fields from form_data - the form
    # doesn't contain these fields and it would overwrite saved data with nulls.

    # Save customs notes at quote level
    if customs_notes:
        supabase.table("quotes") \
            .update({"customs_notes": customs_notes}) \
            .eq("id", quote_id) \
            .execute()

    # Save quote-level costs to quote_calculation_variables
    brokerage_hub = safe_decimal(form_data.get("brokerage_hub", 0))
    brokerage_customs = safe_decimal(form_data.get("brokerage_customs", 0))
    warehousing_at_customs = safe_decimal(form_data.get("warehousing_at_customs", 0))
    customs_documentation = safe_decimal(form_data.get("customs_documentation", 0))
    brokerage_extra = safe_decimal(form_data.get("brokerage_extra", 0))

    # Get currency values for each brokerage field (default RUB)
    brokerage_hub_currency = form_data.get("brokerage_hub_currency", "RUB")
    brokerage_customs_currency = form_data.get("brokerage_customs_currency", "RUB")
    warehousing_at_customs_currency = form_data.get("warehousing_at_customs_currency", "RUB")
    customs_documentation_currency = form_data.get("customs_documentation_currency", "RUB")
    brokerage_extra_currency = form_data.get("brokerage_extra_currency", "RUB")

    # Load existing variables or create empty dict
    calc_vars_result = supabase.table("quote_calculation_variables") \
        .select("id, variables") \
        .eq("quote_id", quote_id) \
        .execute()

    if calc_vars_result.data:
        # Update existing record
        calc_var_id = calc_vars_result.data[0]["id"]
        existing_vars = calc_vars_result.data[0].get("variables", {})

        # Update the 5 cost fields and their currencies
        existing_vars["brokerage_hub"] = brokerage_hub
        existing_vars["brokerage_customs"] = brokerage_customs
        existing_vars["warehousing_at_customs"] = warehousing_at_customs
        existing_vars["customs_documentation"] = customs_documentation
        existing_vars["brokerage_extra"] = brokerage_extra
        existing_vars["brokerage_hub_currency"] = brokerage_hub_currency
        existing_vars["brokerage_customs_currency"] = brokerage_customs_currency
        existing_vars["warehousing_at_customs_currency"] = warehousing_at_customs_currency
        existing_vars["customs_documentation_currency"] = customs_documentation_currency
        existing_vars["brokerage_extra_currency"] = brokerage_extra_currency

        supabase.table("quote_calculation_variables") \
            .update({"variables": existing_vars}) \
            .eq("id", calc_var_id) \
            .execute()
    else:
        # Create new record with 5 cost fields and currencies
        import uuid
        supabase.table("quote_calculation_variables") \
            .insert({
                "id": str(uuid.uuid4()),
                "quote_id": quote_id,
                "variables": {
                    "brokerage_hub": brokerage_hub,
                    "brokerage_customs": brokerage_customs,
                    "warehousing_at_customs": warehousing_at_customs,
                    "customs_documentation": customs_documentation,
                    "brokerage_extra": brokerage_extra,
                    "brokerage_hub_currency": brokerage_hub_currency,
                    "brokerage_customs_currency": brokerage_customs_currency,
                    "warehousing_at_customs_currency": warehousing_at_customs_currency,
                    "customs_documentation_currency": customs_documentation_currency,
                    "brokerage_extra_currency": brokerage_extra_currency
                }
            }) \
            .execute()

    # If action is complete, mark customs as done
    if action == "complete":
        user_roles = get_user_roles_from_session(session)
        result = complete_customs(quote_id, user_id, user_roles)

        if not result.success:
            # Log error but still redirect
            print(f"Error completing customs: {result.error_message}")

    return RedirectResponse(f"/customs/{quote_id}", status_code=303)


# ============================================================================
# CUSTOMS ITEM API (bulk save on form submit)
# ============================================================================

@rt("/api/customs/{quote_id}/items/bulk", methods=["PATCH"])
async def api_customs_items_bulk_update(quote_id: str, session, request):
    """Bulk update customs items (hs_code, customs_duty) on form submit"""
    redirect = require_login(session)
    if redirect:
        return {"success": False, "error": "Not authenticated"}

    user = session["user"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return {"success": False, "error": "Unauthorized"}

    try:
        body = await request.json()
    except:
        return {"success": False, "error": "Invalid JSON"}

    items = body.get("items", [])
    if not items:
        return {"success": True}  # Nothing to update

    supabase = get_supabase()

    # Verify quote exists and belongs to org
    quote_result = supabase.table("quotes") \
        .select("id, workflow_status, customs_completed_at") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return {"success": False, "error": "Quote not found"}

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is ready for customs (procurement must be done first)
    ready_statuses = ["pending_customs", "pending_logistics", "pending_logistics_and_customs", "pending_sales_review"]
    if workflow_status not in ready_statuses or quote.get("customs_completed_at"):
        return {"success": False, "error": "Quote not editable - waiting for procurement"}

    # Update each item
    for item in items:
        item_id = item.get("id")
        if not item_id:
            continue

        hs_code = item.get("hs_code", "")
        customs_duty = item.get("customs_duty", 0)

        try:
            customs_duty = float(customs_duty) if customs_duty else 0
        except:
            customs_duty = 0

        supabase.table("quote_items") \
            .update({
                "hs_code": hs_code if hs_code else None,
                "customs_duty": customs_duty
            }) \
            .eq("id", item_id) \
            .eq("quote_id", quote_id) \
            .execute()

    return {"success": True}


@rt("/customs/{quote_id}/items/{item_id}")
async def patch(session, quote_id: str, item_id: str, request):
    """Update a single customs item field (legacy - kept for compatibility)"""
    redirect = require_login(session)
    if redirect:
        return {"success": False, "error": "Not authenticated"}

    user = session["user"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return {"success": False, "error": "Unauthorized"}

    try:
        body = await request.json()
    except:
        return {"success": False, "error": "Invalid JSON"}

    supabase = get_supabase()

    # Verify quote exists and belongs to org
    quote_result = supabase.table("quotes") \
        .select("id, workflow_status, customs_completed_at") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return {"success": False, "error": "Quote not found"}

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is ready for customs (procurement must be done first)
    ready_statuses = ["pending_customs", "pending_logistics", "pending_logistics_and_customs", "pending_sales_review"]
    if workflow_status not in ready_statuses or quote.get("customs_completed_at"):
        return {"success": False, "error": "Quote not editable - waiting for procurement"}

    # Verify item belongs to quote
    item_result = supabase.table("quote_items") \
        .select("id") \
        .eq("id", item_id) \
        .eq("quote_id", quote_id) \
        .execute()

    if not item_result.data:
        return {"success": False, "error": "Item not found"}

    # Build update dict for allowed fields only
    allowed_fields = ["hs_code", "customs_duty"]
    update_data = {}

    for field in allowed_fields:
        if field in body:
            val = body[field]
            if field == "customs_duty":
                try:
                    update_data[field] = float(val) if val is not None else 0
                except:
                    update_data[field] = 0
            else:
                update_data[field] = val if val else None

    if not update_data:
        return {"success": False, "error": "No valid fields to update"}

    # Update item
    supabase.table("quote_items") \
        .update(update_data) \
        .eq("id", item_id) \
        .execute()

    return {"success": True}


# ============================================================================
# CUSTOMS - RETURN TO QUOTE CONTROL (Feature: multi-department return)
# ============================================================================

@rt("/customs/{quote_id}/return-to-control")
def get(quote_id: str, session):
    """
    Form for customs to return a revised quote back to quote control.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("*, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .single() \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data
    workflow_status = quote.get("workflow_status", "draft")
    revision_comment = quote.get("revision_comment", "")
    idn_quote = quote.get("idn_quote", f"#{quote_id[:8]}")
    customer_name = quote.get("customers", {}).get("name", "—") if quote.get("customers") else "—"

    if workflow_status != "pending_customs":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}»."),
            A("← Назад", href=f"/customs/{quote_id}"),
            session=session
        )

    # Design system styles
    header_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 24px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    section_header_style = """
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    """

    comment_box_style = """
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        padding: 16px;
        border-radius: 0 8px 8px 0;
        margin-bottom: 24px;
    """

    textarea_style = """
        width: 100%;
        min-height: 120px;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        background: #f8fafc;
        font-family: inherit;
        resize: vertical;
        box-sizing: border-box;
    """

    return page_layout(f"Вернуть на проверку - {idn_quote}",
        # Header card
        Div(
            Div(
                A(icon("arrow-left", size=16), f" Назад к таможне", href=f"/customs/{quote_id}",
                  style="color: #64748b; text-decoration: none; font-size: 13px; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            H1("Вернуть КП на проверку",
               style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #1e293b;"),
            Div(
                icon("file-text", size=14, style="color: #64748b;"),
                Span(f"КП: {idn_quote}", style="color: #475569; font-weight: 500;"),
                Span(" • ", style="color: #cbd5e1;"),
                Span(f"Клиент: {customer_name}", style="color: #64748b;"),
                style="display: flex; align-items: center; gap: 8px; font-size: 14px;"
            ),
            style=header_style
        ),

        # Original comment (if present)
        Div(
            Div(icon("message-circle", size=14), " Исходный комментарий контроллёра", style=section_header_style),
            P(revision_comment if revision_comment else "— нет комментария —",
              style="margin: 0; font-size: 14px; color: #92400e; line-height: 1.5;"),
            style=comment_box_style
        ) if revision_comment else None,

        # Form
        Form(
            Div(
                Div(icon("edit-3", size=14), " Комментарий об исправлениях *", style=section_header_style),
                P("Опишите, какие исправления были внесены:",
                  style="color: #64748b; font-size: 13px; margin: 0 0 12px 0;"),
                Textarea(
                    name="comment",
                    placeholder="Исправлены HS-коды...\nОбновлены пошлины...\nИзменены таможенные расходы...",
                    required=True,
                    style=textarea_style
                ),
                style="margin-bottom: 24px;"
            ),
            Div(
                Button(icon("check", size=14), " Вернуть на проверку", type="submit",
                       style="padding: 10px 20px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;"),
                A(icon("x", size=14), " Отмена", href=f"/customs/{quote_id}",
                  style="padding: 10px 20px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 6px;"),
                style="display: flex; gap: 12px;"
            ),
            action=f"/customs/{quote_id}/return-to-control",
            method="post",
            style=form_card_style
        ),
        session=session
    )


@rt("/customs/{quote_id}/return-to-control")
def post(quote_id: str, session, comment: str = ""):
    """
    Handle return to quote control from customs.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["customs", "admin", "head_of_customs"]):
        return RedirectResponse("/unauthorized", status_code=303)

    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка"),
            P("Необходимо указать комментарий об исправлениях."),
            A("← Вернуться", href=f"/customs/{quote_id}/return-to-control"),
            session=session
        )

    supabase = get_supabase()

    quote_result = supabase.table("quotes") \
        .select("workflow_status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            A("← К задачам", href="/tasks"),
            session=session
        )

    current_status = quote_result.data[0].get("workflow_status", "draft")

    if current_status != "pending_customs":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе «{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}»."),
            A("← Назад", href=f"/customs/{quote_id}"),
            session=session
        )

    user_roles = get_user_roles_from_session(session)
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.PENDING_QUOTE_CONTROL,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=f"Исправления от таможни: {comment.strip()}"
    )

    if result.success:
        supabase.table("quotes").update({
            "revision_department": None,
            "revision_comment": None,
            "revision_returned_at": None
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на проверку"),
            P("КП отправлено контроллёру КП для повторной проверки."),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось вернуть КП: {result.error_message}"),
            A("← Назад", href=f"/customs/{quote_id}/return-to-control"),
            session=session
        )


# ============================================================================
# QUOTE CONTROL - CALCULATION COLUMNS DEFINITION
# ============================================================================

# All available calculation columns with their metadata
CALC_COLUMNS = {
    # Purchase group
    "N16": {"name": "Цена закупки/ед", "group": "Закупка", "format": "money"},
    "P16": {"name": "После скидки", "group": "Закупка", "format": "money"},
    "R16": {"name": "Цена/ед в вал. КП", "group": "Закупка", "format": "money"},
    "S16": {"name": "Сумма закупки", "group": "Закупка", "format": "money"},
    # Logistics group
    "T16": {"name": "Логистика 1", "group": "Логистика", "format": "money"},
    "U16": {"name": "Логистика 2", "group": "Логистика", "format": "money"},
    "V16": {"name": "Логистика всего", "group": "Логистика", "format": "money"},
    # Customs group
    "Y16": {"name": "Пошлина", "group": "Таможня", "format": "money"},
    "Z16": {"name": "Акциз", "group": "Таможня", "format": "money"},
    # COGS group
    "AA16": {"name": "Себест./ед", "group": "Себестоимость", "format": "money"},
    "AB16": {"name": "Себестоимость", "group": "Себестоимость", "format": "money"},
    # Sales group
    "AD16": {"name": "Цена без фин.", "group": "Продажа", "format": "money"},
    "AE16": {"name": "Сумма без фин.", "group": "Продажа", "format": "money"},
    "AF16": {"name": "Прибыль", "group": "Продажа", "format": "money", "highlight": True},
    "AG16": {"name": "ЛПР", "group": "Продажа", "format": "money"},
    "AJ16": {"name": "Цена/ед б/НДС", "group": "Продажа", "format": "money"},
    "AK16": {"name": "Сумма б/НДС", "group": "Продажа", "format": "money"},
    "AL16": {"name": "Сумма с НДС", "group": "Продажа", "format": "money", "bold": True},
    # VAT group
    "AP16": {"name": "НДС к уплате", "group": "НДС", "format": "money"},
    # Finance group
    "BA16": {"name": "Финансирование", "group": "Финансы", "format": "money"},
    "BB16": {"name": "Кредит", "group": "Финансы", "format": "money"},
}

# Column presets
CALC_PRESET_BASIC = ["N16", "S16", "V16", "AB16", "AF16", "AK16", "AL16"]
CALC_PRESET_FULL = ["N16", "P16", "S16", "T16", "U16", "V16", "Y16", "AA16", "AB16", "AD16", "AF16", "AG16", "AJ16", "AK16", "AL16", "AP16", "BA16", "BB16"]

# Mapping from phase_results columns to summary columns
CALC_SUMMARY_MAP = {
    "S16": "calc_s16_total_purchase_price",
    "V16": "calc_v16_total_logistics",
    "AB16": "calc_ab16_cogs_total",
    "AF16": "calc_af16_profit_margin",  # Note: this is actually markup %, not total profit
    "AK16": "calc_ak16_final_price_total",
    "AL16": "calc_al16_total_with_vat",
    "Y16": "calc_y16_customs_duty",
    "AP16": "calc_ap16_net_vat_payable",
    "AG16": "calc_ag16_dm_fee",
}


def get_user_calc_columns(user_id: str, supabase) -> list:
    """Get user's custom column selection from user_settings."""
    try:
        result = supabase.table("user_settings") \
            .select("setting_value") \
            .eq("user_id", user_id) \
            .eq("setting_key", "quote_control_columns") \
            .execute()
        if result.data:
            return result.data[0].get("setting_value", {}).get("columns", CALC_PRESET_BASIC)
    except Exception:
        pass
    return CALC_PRESET_BASIC


def save_user_calc_columns(user_id: str, columns: list, supabase) -> bool:
    """Save user's custom column selection to user_settings."""
    try:
        # Upsert the setting
        supabase.table("user_settings").upsert({
            "user_id": user_id,
            "setting_key": "quote_control_columns",
            "setting_value": {"columns": columns, "preset": "custom"},
            "updated_at": "now()"
        }, on_conflict="user_id,setting_key").execute()
        return True
    except Exception:
        return False


def build_calc_table(items_data: list, summary_data: dict, columns: list, currency: str = "RUB"):
    """
    Build calculation details table with selected columns.

    Args:
        items_data: List of dicts with item info and phase_results
        summary_data: Dict with aggregated totals from quote_calculation_summaries
        columns: List of column codes to display (e.g., ["N16", "S16", "V16"])
        currency: Currency code for display

    Returns:
        FastHTML Table element
    """
    # Build header row
    header_cells = [
        Th("Товар", style="text-align: left; white-space: nowrap; position: sticky; left: 0; background: white; z-index: 1;"),
        Th("Кол-во", style="text-align: right; white-space: nowrap;"),
    ]
    for col in columns:
        col_info = CALC_COLUMNS.get(col, {"name": col, "group": ""})
        header_cells.append(
            Th(col_info["name"],
               style="text-align: right; white-space: nowrap;",
               title=f"{col} - {col_info.get('group', '')}")
        )
    header_cells.append(Th("Маржа %", style="text-align: right; white-space: nowrap;"))

    # Build data rows
    data_rows = []
    for item in items_data:
        phase = item.get("phase_results", {})
        row_cells = [
            Td(
                (item.get("product_name") or "—")[:35],
                style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; position: sticky; left: 0; background: white;",
                title=item.get("product_name", "")
            ),
            Td(str(item.get("quantity", "—")), style="text-align: right;"),
        ]

        for col in columns:
            col_info = CALC_COLUMNS.get(col, {})
            value = float(phase.get(col, 0) or 0)
            style = "text-align: right;"
            if col_info.get("highlight"):
                style += " color: #22c55e;"
            if col_info.get("bold"):
                style += " font-weight: 500;"
            row_cells.append(Td(format_money(value, currency), style=style))

        # Margin % calculation
        cogs = float(phase.get("AB16", 0) or 0)
        profit = float(phase.get("AF16", 0) or 0)
        margin_pct = (profit / cogs * 100) if cogs > 0 else 0
        row_cells.append(Td(f"{margin_pct:.1f}%", style="text-align: right; color: #22c55e;"))

        data_rows.append(Tr(*row_cells))

    # Build footer row with totals
    footer_cells = [
        Td(Strong("ИТОГО"), style="position: sticky; left: 0; background: #f9fafb;"),
        Td("", style="background: #f9fafb;"),
    ]
    for col in columns:
        summary_col = CALC_SUMMARY_MAP.get(col)
        if summary_col and summary_data:
            value = float(summary_data.get(summary_col, 0) or 0)
            footer_cells.append(Td(Strong(format_money(value, currency)), style="text-align: right; background: #f9fafb;"))
        else:
            footer_cells.append(Td("—", style="text-align: right; background: #f9fafb;"))
    # Average margin
    avg_margin = float(summary_data.get("calc_af16_profit_margin", 0) or 0) if summary_data else 0
    footer_cells.append(Td(Strong(f"{avg_margin:.1f}%"), style="text-align: right; color: #22c55e; background: #f9fafb;"))

    return Table(
        Thead(Tr(*header_cells)),
        Tbody(*data_rows),
        Tfoot(Tr(*footer_cells)),
        style="width: 100%; font-size: 0.875rem; border-collapse: collapse;"
    )


# ============================================================================
# QUOTE CONTROL WORKSPACE (Features #46-51)
# ============================================================================

@rt("/quote-control")
def get(session, status_filter: str = None):
    """
    Redirect to unified dashboard quote-control tab.
    Old URL preserved for backwards compatibility.
    """
    url = "/dashboard?tab=quote-control"
    if status_filter:
        url += f"&status_filter={status_filter}"
    return RedirectResponse(url, status_code=303)


# ============================================================================
# QUOTE CONTROL DETAIL VIEW (Feature #48)
# ============================================================================

@rt("/quote-control/{quote_id}")
def get(session, quote_id: str, preset: str = None):
    """
    Quote Control detail view - shows checklist for reviewing a specific quote.

    Feature #48: Checklist for quote_controller (Жанна) to verify all aspects of the quote.

    Checklist items from spec:
    1. Тип сделки (поставка/транзит) - разная наценка
    2. Базис поставки (чаще DDP)
    3. Валюта КП, корректность конвертации
    4. Условия расчётов с клиентом
    5. Размер аванса поставщику
    6. Корректность закупочных цен, НДС
    7. Корректность логистики (не из головы)
    8. Минимальные наценки
    9. Вознаграждения ЛПРа
    10. % курсовой разницы

    Query params:
        preset: 'basic', 'full', or 'custom' - which column preset to display
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Get quote items
    items_result = supabase.table("quote_items") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()
    items = items_result.data or []

    # Get calculation variables
    vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()
    calc_vars = vars_result.data[0]["variables"] if vars_result.data else {}

    # Get calculation summary
    summary_result = supabase.table("quote_calculation_summaries") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()
    summary = summary_result.data[0] if summary_result.data else {}

    # Get detailed calculation results from quote_calculation_results (all phases)
    calc_results_query = supabase.table("quote_calculation_results") \
        .select("quote_item_id, phase_results") \
        .eq("quote_id", quote_id) \
        .execute()

    # Get aggregated totals from quote_calculation_summaries
    calc_summary_result = supabase.table("quote_calculation_summaries") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .execute()
    calc_summary = calc_summary_result.data[0] if calc_summary_result.data else {}

    # Build items data with phase_results joined
    items_by_id = {item["id"]: item for item in items}
    calc_items_data = []
    if calc_results_query.data:
        for cr in calc_results_query.data:
            item_id = cr.get("quote_item_id")
            item = items_by_id.get(item_id, {})
            calc_items_data.append({
                "id": item_id,
                "product_name": item.get("product_name", "—"),
                "quantity": item.get("quantity", 0),
                "phase_results": cr.get("phase_results", {})
            })

    # Fallback to quote_versions if no calculation results
    if not calc_items_data:
        version_result = supabase.table("quote_versions") \
            .select("input_variables") \
            .eq("quote_id", quote_id) \
            .order("version", desc=True) \
            .limit(1) \
            .execute()
        if version_result.data:
            input_vars = version_result.data[0].get("input_variables", {})
            for r in input_vars.get("results", []):
                item_id = r.get("item_id")
                item = items_by_id.get(item_id, {})
                calc_items_data.append({
                    "id": item_id,
                    "product_name": item.get("product_name", "—"),
                    "quantity": item.get("quantity", 0),
                    "phase_results": r  # Results are already phase data
                })
            # Also get variables from version if not from quote_calculation_variables
            if not calc_vars:
                calc_vars = input_vars.get("variables", {})

    # Get user's column preferences (URL param overrides saved setting)
    user_calc_preset = "basic"  # Default
    user_calc_columns = CALC_PRESET_BASIC
    user_custom_columns = None  # Saved custom columns if any

    # First load saved settings
    try:
        user_settings_result = supabase.table("user_settings") \
            .select("setting_value") \
            .eq("user_id", user_id) \
            .eq("setting_key", "quote_control_columns") \
            .execute()
        if user_settings_result.data:
            setting = user_settings_result.data[0].get("setting_value", {})
            user_custom_columns = setting.get("columns", CALC_PRESET_BASIC)
            if not preset:  # Only use saved preset if no URL param
                user_calc_preset = setting.get("preset", "basic")
    except Exception:
        pass

    # URL param overrides saved setting
    if preset in ("basic", "full", "custom"):
        user_calc_preset = preset

    # Set columns based on active preset
    if user_calc_preset == "full":
        user_calc_columns = CALC_PRESET_FULL
    elif user_calc_preset == "custom" and user_custom_columns:
        user_calc_columns = user_custom_columns
    else:
        user_calc_columns = CALC_PRESET_BASIC

    # Determine if editing is allowed
    can_edit = workflow_status == "pending_quote_control"

    # Load organization's calculation settings for fallback values
    calc_settings_result = supabase.table("calculation_settings") \
        .select("*") \
        .eq("organization_id", org_id) \
        .execute()
    org_calc_settings = calc_settings_result.data[0] if calc_settings_result.data else {}

    # Extract values for checklist verification
    deal_type = quote.get("deal_type") or calc_vars.get("offer_sale_type", "")
    incoterms = calc_vars.get("offer_incoterms", "")
    currency = quote.get("currency", "USD")
    markup = float(calc_vars.get("markup", 0) or 0)
    supplier_advance = float(calc_vars.get("supplier_advance", 0) or 0)
    exchange_rate = float(calc_vars.get("exchange_rate", 1.0) or 1.0)
    # Forex risk: first from quote calculation, then from org settings, default 3%
    forex_risk = float(calc_vars.get("forex_risk_percent", 0) or org_calc_settings.get("rate_forex_risk", 3) or 0)
    lpr_reward = float(calc_vars.get("lpr_reward", 0) or calc_vars.get("decision_maker_reward", 0) or 0)

    # Payment terms
    payment_terms = calc_vars.get("client_payment_terms", "")
    prepayment = float(calc_vars.get("client_prepayment_percent", 100) or 100)

    # Logistics costs - get from calculation results, not input variables
    # calc_summary has the aggregated total, phase_results has per-item breakdown
    total_logistics = float(calc_summary.get("calc_v16_total_logistics", 0) or 0)

    # Calculate leg breakdown from phase_results (T16 = first leg, U16 = last leg)
    # Note: V16 = T16 + U16 (total logistics per item)
    logistics_first_leg = sum(
        float(item.get("phase_results", {}).get("T16", 0) or 0)
        for item in calc_items_data
    )
    logistics_last_leg = sum(
        float(item.get("phase_results", {}).get("U16", 0) or 0)
        for item in calc_items_data
    )
    # For display: first leg = supplier to hub + hub to customs, last leg = customs to client
    # Simplified display as two legs since that's what calculation engine provides
    logistics_supplier_hub = logistics_first_leg
    logistics_hub_customs = 0  # Combined into first_leg in calculation
    logistics_customs_client = logistics_last_leg

    # Min markup thresholds (these would typically come from settings)
    min_markup_supply = 12  # %
    min_markup_transit = 8   # %

    # Approval triggers (from spec):
    # - Валюта КП = рубли
    # - Условия не 100% предоплата
    # - Наценка ниже минимума
    # - Есть вознаграждение ЛПРа
    needs_approval_reasons = []
    if currency == "RUB":
        needs_approval_reasons.append("Валюта КП = рубли")
    if prepayment < 100:
        needs_approval_reasons.append(f"Не 100% предоплата ({prepayment}%)")
    if deal_type == "supply" and markup < min_markup_supply:
        needs_approval_reasons.append(f"Наценка ({markup}%) ниже минимума для поставки ({min_markup_supply}%)")
    elif deal_type == "transit" and markup < min_markup_transit:
        needs_approval_reasons.append(f"Наценка ({markup}%) ниже минимума для транзита ({min_markup_transit}%)")
    if lpr_reward > 0:
        needs_approval_reasons.append(f"Есть вознаграждение ЛПРа ({lpr_reward})")

    needs_approval = len(needs_approval_reasons) > 0

    # Build checklist items with auto-detected status (modern card design)
    def checklist_item(name, description, value, status="info", details=None):
        """Create a modern checklist card with status indicator using Lucide icons."""
        status_config = {
            "ok": {
                "bg": "linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)",
                "border": "#86efac",
                "text": "#166534",
                "icon_name": "check-circle",
                "icon_color": "#22c55e"
            },
            "warning": {
                "bg": "linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)",
                "border": "#fcd34d",
                "text": "#92400e",
                "icon_name": "alert-triangle",
                "icon_color": "#f59e0b"
            },
            "error": {
                "bg": "linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)",
                "border": "#fca5a5",
                "text": "#991b1b",
                "icon_name": "x-circle",
                "icon_color": "#ef4444"
            },
            "info": {
                "bg": "linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)",
                "border": "#93c5fd",
                "text": "#1e40af",
                "icon_name": "info",
                "icon_color": "#3b82f6"
            },
        }
        cfg = status_config.get(status, status_config["info"])

        # Extract item number from name (e.g., "1. Тип сделки" -> "1")
        item_name = name.split(". ", 1)[-1] if ". " in name else name

        return Div(
            # Header: status icon + name
            Div(
                icon(cfg["icon_name"], size=16, color=cfg["icon_color"]),
                Span(item_name, style=f"font-weight: 600; font-size: 0.8125rem; color: #374151; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 0.5rem;"
            ),
            # Value
            Div(
                Span(str(value) if value else "—", style=f"font-weight: 600; font-size: 0.875rem; color: {cfg['text']};"),
                style="margin-bottom: 0.25rem;"
            ),
            # Details (if present)
            Div(
                Span(details, style="color: #64748b; font-size: 0.75rem;"),
                style="margin-top: 0.25rem;"
            ) if details else None,
            title=description,  # Description as tooltip
            style=f"padding: 0.75rem; background: {cfg['bg']}; border: 1px solid {cfg['border']}; border-radius: 8px; cursor: help; box-shadow: 0 1px 3px rgba(0,0,0,0.04);"
        )

    # Generate checklist
    checklist_items = []

    # 1. Deal type
    deal_type_display = "Поставка" if deal_type == "supply" else ("Транзит" if deal_type == "transit" else deal_type or "Не указан")
    deal_status = "ok" if deal_type else "warning"
    checklist_items.append(checklist_item(
        "1. Тип сделки",
        "Поставка или транзит - влияет на минимальную наценку",
        deal_type_display,
        deal_status,
        f"Мин. наценка: {min_markup_supply}% (поставка) / {min_markup_transit}% (транзит)"
    ))

    # 2. Incoterms
    incoterms_status = "ok" if incoterms else "warning"
    checklist_items.append(checklist_item(
        "2. Базис поставки (Incoterms)",
        "Обычно DDP. Влияет на распределение расходов и рисков",
        incoterms or "Не указан",
        incoterms_status,
        "DDP = все расходы до клиента включены в цену"
    ))

    # 3. Currency
    currency_status = "warning" if currency == "RUB" else "ok"
    checklist_items.append(checklist_item(
        "3. Валюта КП",
        "Проверить корректность конвертации. Рубли требуют согласования",
        currency,
        currency_status,
        f"Курс: {exchange_rate}" if exchange_rate != 1.0 else None
    ))

    # 4. Payment terms
    payment_display = f"{prepayment}% предоплата"
    if payment_terms:
        payment_display += f" ({payment_terms})"
    payment_status = "ok" if prepayment == 100 else "warning"
    checklist_items.append(checklist_item(
        "4. Условия расчётов с клиентом",
        "Не 100% предоплата требует согласования",
        payment_display,
        payment_status,
        "100% предоплата = минимальный риск" if prepayment == 100 else "Отсрочка = требует согласования"
    ))

    # 5. Supplier advance
    supplier_advance_display = f"{supplier_advance}%"
    advance_status = "ok" if supplier_advance <= 50 else "warning"
    checklist_items.append(checklist_item(
        "5. Размер аванса поставщику",
        "Проверить соответствие договорённостям с поставщиком",
        supplier_advance_display,
        advance_status,
        "Стандарт: 30-50% аванс"
    ))

    # 6. Purchase prices - use calculated total from summary, not raw item prices
    total_purchase = float(calc_summary.get("calc_s16_total_purchase_price", 0) or 0)
    # Fallback to item prices if summary not available
    if total_purchase == 0:
        total_purchase = sum(float(item.get("purchase_price", 0) or 0) * int(item.get("quantity", 1) or 1) for item in items)

    # VAT rate: 22% for 2026+ (Russian government mandate), 20% before
    from datetime import date
    current_year = date.today().year
    vat_rate = 22 if current_year >= 2026 else 20

    checklist_items.append(checklist_item(
        "6. Закупочные цены и НДС",
        "Проверить корректность закупочных цен",
        f"Итого закупка: {format_money(total_purchase, currency)} | НДС: {vat_rate}%",
        "info",
        f"Позиций с ценами: {len([i for i in items if i.get('purchase_price')])}/{len(items)}"
    ))

    # 7. Logistics
    logistics_status = "ok" if total_logistics > 0 else "warning"
    checklist_items.append(checklist_item(
        "7. Корректность логистики",
        "Стоимость должна быть рассчитана, не 'из головы'",
        f"Участок 1 (до таможни): {format_money(logistics_first_leg, currency)} | Участок 2 (до клиента): {format_money(logistics_last_leg, currency)}",
        logistics_status,
        f"Итого логистика: {format_money(total_logistics, currency)}"
    ))

    # 8. Minimum markup
    min_markup = min_markup_supply if deal_type == "supply" else min_markup_transit
    markup_status = "ok" if markup >= min_markup else "error"
    checklist_items.append(checklist_item(
        "8. Минимальные наценки",
        f"Минимум: {min_markup}% для {'поставки' if deal_type == 'supply' else 'транзита'}",
        f"{markup}%",
        markup_status,
        "Наценка в норме" if markup >= min_markup else f"Ниже минимума на {min_markup - markup}%"
    ))

    # 9. LPR reward
    lpr_status = "warning" if lpr_reward > 0 else "ok"
    checklist_items.append(checklist_item(
        "9. Вознаграждение ЛПРа",
        "Наличие вознаграждения требует согласования",
        f"{lpr_reward}" if lpr_reward else "Нет",
        lpr_status,
        "Требует согласования топ-менеджера" if lpr_reward > 0 else None
    ))

    # 10. Forex risk
    forex_status = "ok" if forex_risk > 0 else "info"
    checklist_items.append(checklist_item(
        "10. % курсовой разницы",
        "Заложен ли риск изменения курса валют",
        f"{forex_risk}%" if forex_risk else "Не учтён",
        forex_status,
        "Рекомендуется 2-5% при длительных сроках поставки"
    ))

    # 11. Invoice verification (v3.0 Feature UI-022)
    # Check invoices created by procurement team (from 'invoices' table)
    # These are internal invoices grouping quote_items by supplier
    invoices_result = supabase.table("invoices") \
        .select("id, invoice_number, supplier_id, currency, total_weight_kg") \
        .eq("quote_id", quote_id) \
        .execute()

    invoices_list = invoices_result.data or []
    invoice_count = len(invoices_list)

    # Count items with invoice_id set (linked to invoices)
    items_with_invoice = sum(1 for item in items if item.get("invoice_id"))
    total_items = len(items)

    if total_items > 0:
        if invoice_count > 0 and items_with_invoice == total_items:
            invoice_status = "ok"
            invoice_value = f"{invoice_count} инвойс(ов), все позиции ({items_with_invoice}/{total_items})"
        elif invoice_count > 0:
            invoice_status = "warning"
            invoice_value = f"{invoice_count} инвойс(ов), {items_with_invoice}/{total_items} позиций привязано"
        else:
            invoice_status = "error"
            invoice_value = "Нет инвойсов от поставщиков"

        checklist_items.append(checklist_item(
            "11. Наличие инвойсов от поставщиков",
            "Проверка внутренних инвойсов и привязки позиций",
            invoice_value,
            invoice_status,
            f"Инвойсы: {', '.join(inv['invoice_number'] for inv in invoices_list)}" if invoices_list else "Создайте инвойсы на вкладке Закупки"
        ))
    else:
        checklist_items.append(checklist_item(
            "11. Наличие инвойсов от поставщиков",
            "Проверка внутренних инвойсов и привязки позиций",
            "Нет позиций для проверки",
            "info",
            None
        ))

    # Load invoicing summary for detail section (using supplier_invoice_items for per-item breakdown)
    # This is separate from criterion 11 which checks internal invoices
    from services.supplier_invoice_service import get_quote_invoicing_summary
    invoicing_summary = get_quote_invoicing_summary(quote_id)

    # Summary info
    customer_name = quote.get("customers", {}).get("name", "—")
    quote_total = float(quote.get("total_amount", 0) or 0)

    # Status banner
    if workflow_status == "pending_quote_control":
        status_banner = Div(
            icon("clipboard-list", size=20), " Требуется проверка",
            style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 8px; text-align: center; font-weight: 500; margin-bottom: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"
        )
    elif workflow_status == "pending_approval":
        status_banner = Div(
            icon("clock", size=20), " Ожидает согласования топ-менеджера",
            style="background: #dbeafe; color: #1e40af; padding: 1rem; border-radius: 8px; text-align: center; font-weight: 500; margin-bottom: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"
        )
    elif workflow_status == "approved":
        status_banner = Div(
            icon("check-circle", size=20), " КП одобрено",
            style="background: #dcfce7; color: #166534; padding: 1rem; border-radius: 8px; text-align: center; font-weight: 500; margin-bottom: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"
        )
    else:
        status_banner = Div(
            "Статус: ", workflow_status_badge(workflow_status),
            style="margin-bottom: 1rem;"
        )

    # Approval requirements banner
    approval_banner = None
    if needs_approval and workflow_status == "pending_quote_control":
        approval_banner = Div(
            H4(icon("alert-triangle", size=18), " Требуется согласование топ-менеджера", style="color: #b45309; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;"),
            Ul(*[Li(reason) for reason in needs_approval_reasons], style="margin: 0; padding-left: 1.5rem; color: #92400e;"),
            style="background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"
        )

    return page_layout(f"Проверка КП - {quote.get('idn_quote', '')}",
        # Back link
        Div(
            A("← К задачам", href="/tasks", style="color: #3b82f6; text-decoration: none;"),
            style="margin-bottom: 1rem;"
        ),

        # Role-based tabs for quote detail navigation
        quote_detail_tabs(quote_id, "control", user.get("roles", [])),

        # Header with gradient styling
        Div(
            Div(
                icon("clipboard-check", size=24, color="#1e40af"),
                H1(f" Проверка КП {quote.get('idn_quote', '')}", style="margin: 0; margin-left: 8px; font-size: 1.5rem;"),
                style="display: flex; align-items: center;"
            ),
            P(f"Клиент: {customer_name} | Сумма: {format_money(quote_total)} {currency}", style="color: #64748b; margin-top: 0.5rem;"),
            style="margin-bottom: 1rem;"
        ),

        # Workflow progress bar (Feature #87)
        workflow_progress_bar(workflow_status),

        # Status banner
        status_banner,

        # Approval requirements banner
        approval_banner,

        # Quote summary card with gradient styling
        Div(
            # Section header
            Div(
                icon("file-text", size=16, color="#64748b"),
                Span(" СВОДКА ПО КП", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            # Summary grid with 5 columns
            Div(
                Div(
                    Span("ТИП СДЕЛКИ", style="font-size: 11px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px;"),
                    Span(deal_type_display, style="font-weight: 600; color: #1e40af;"),
                ),
                Div(
                    Span("INCOTERMS", style="font-size: 11px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px;"),
                    Span(incoterms or "—", style="font-weight: 600; color: #1e40af;"),
                ),
                Div(
                    Span("ВАЛЮТА", style="font-size: 11px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px;"),
                    Span(currency, style="font-weight: 600; color: #1e40af;"),
                ),
                Div(
                    Span("НАЦЕНКА", style="font-size: 11px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px;"),
                    Span(f"{markup}%", style="font-weight: 600; color: #1e40af;"),
                ),
                Div(
                    Span("ПОЗИЦИЙ", style="font-size: 11px; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px;"),
                    Span(str(len(items)), style="font-weight: 600; color: #1e40af;"),
                ),
                style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;"
            ),
            cls="card",
            style="margin-bottom: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Checklist (modern 3-column grid)
        Div(
            # Section header
            Div(
                icon("check-square", size=16, color="#64748b"),
                Span(" ЧЕК-ЛИСТ ПРОВЕРКИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            P("Проверьте все пункты перед одобрением или возвратом КП", style="color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"),
            Div(
                *checklist_items,
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;"
            ),
            cls="card",
            style="padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Detailed Calculation Results Table with Preset Selector
        Div(
            # Section header
            Div(
                icon("calculator", size=16, color="#64748b"),
                Span(" ДЕТАЛИ РАСЧЁТА ПО ПОЗИЦИЯМ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            P("Промежуточные значения расчёта для каждой позиции", style="color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"),

            # Preset selector (links include #calc-table anchor to preserve scroll position)
            Div(
                Span("Показать:", style="margin-right: 0.5rem; font-weight: 500;"),
                A(
                    "Базовый",
                    href=f"/quote-control/{quote_id}?preset=basic#calc-table",
                    cls="btn btn-sm" + (" btn-primary" if user_calc_preset == "basic" else ""),
                    style="margin-right: 0.25rem;"
                ),
                A(
                    "Полный",
                    href=f"/quote-control/{quote_id}?preset=full#calc-table",
                    cls="btn btn-sm" + (" btn-primary" if user_calc_preset == "full" else ""),
                    style="margin-right: 0.25rem;"
                ),
                A(
                    "Настроить...",
                    href=f"/quote-control/{quote_id}/columns",
                    cls="btn btn-sm" + (" btn-primary" if user_calc_preset == "custom" else ""),
                ),
                style="display: flex; align-items: center; margin-bottom: 1rem;"
            ),

            # Summary totals from calc_summary
            Div(
                Div(
                    Strong("Итого закупка: "),
                    format_money(float(calc_summary.get('calc_s16_total_purchase_price', 0) or 0), currency),
                    style="margin-right: 2rem;"
                ),
                Div(
                    Strong("Себестоимость: "),
                    format_money(float(calc_summary.get('calc_ab16_cogs_total', 0) or 0), currency),
                    style="margin-right: 2rem;"
                ),
                Div(
                    Strong("Логистика: "),
                    format_money(float(calc_summary.get('calc_v16_total_logistics', 0) or 0), currency),
                    style="margin-right: 2rem;"
                ),
                Div(
                    Strong("Продажа с НДС: "),
                    format_money(float(calc_summary.get('calc_al16_total_with_vat', 0) or 0), currency),
                    style="margin-right: 2rem; color: #22c55e; font-weight: 500;"
                ),
                style="display: flex; flex-wrap: wrap; gap: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 1rem;"
            ) if calc_summary else None,

            # Per-item calculation table using build_calc_table
            Div(
                build_calc_table(calc_items_data, calc_summary, user_calc_columns, currency) if calc_items_data else
                    Div(
                        P("Нет данных расчёта. Выполните расчёт КП.", style="text-align: center; color: #666; padding: 2rem;")
                    ),
                style="overflow-x: auto;"
            ),

            # Column legend for current preset
            Div(
                P(
                    Strong("Отображаемые колонки: "),
                    ", ".join([CALC_COLUMNS.get(col, {}).get("name", col) for col in user_calc_columns]),
                    style="font-size: 0.75rem; color: #666;"
                ),
                style="margin-top: 0.5rem;"
            ),

            id="calc-table",
            cls="card",
            style="margin-top: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if calc_items_data or calc_summary else None,

        # Invoice verification detail (v3.0 Feature UI-022)
        Div(
            # Section header
            Div(
                icon("receipt", size=16, color="#64748b"),
                Span(" ПРОВЕРКА ИНВОЙСОВ ПОСТАВЩИКОВ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            P("Сверка сумм и позиций с инвойсами в реестре", style="color: #64748b; margin-bottom: 1rem; font-size: 0.8125rem;"),
            # Summary stats
            Div(
                Div(
                    Span(f"{invoicing_summary.items_with_invoices}", style="font-size: 1.5rem; font-weight: bold;"),
                    Span(f" / {invoicing_summary.total_items} позиций с инвойсами",
                         style="color: #666;"),
                    style="text-align: center;"
                ),
                Div(
                    Span(f"{invoicing_summary.coverage_percent:.0f}%", style="font-size: 1.25rem; font-weight: bold; color: #22c55e;" if invoicing_summary.coverage_percent == 100 else "font-size: 1.25rem; font-weight: bold; color: #f59e0b;"),
                    Span(" покрытие", style="color: #666;"),
                    style="text-align: center;"
                ),
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;"
            ),
            # Items table
            Table(
                Thead(
                    Tr(
                        Th("Товар", style="text-align: left;"),
                        Th("Кол-во", style="text-align: right;"),
                        Th("Инвойс кол-во", style="text-align: right;"),
                        Th("Инвойс сумма", style="text-align: right;"),
                        Th("Статус", style="text-align: center;"),
                    )
                ),
                Tbody(
                    *[
                        Tr(
                            Td(item.product_name or "—", style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;"),
                            Td(f"{item.quote_quantity:.0f}", style="text-align: right;"),
                            Td(
                                f"{item.invoiced_quantity:.0f}" if item.invoice_count > 0 else "—",
                                style="text-align: right;"
                            ),
                            Td(
                                format_money(float(item.invoiced_amount)) if item.invoice_count > 0 else "—",
                                style="text-align: right;"
                            ),
                            Td(
                                Span("✓", style="color: #22c55e; font-weight: bold;") if item.is_fully_invoiced else (
                                    Span("◐", style="color: #f59e0b;", title="Частично") if item.invoice_count > 0 else Span("✗", style="color: #ef4444;", title="Нет инвойса")
                                ),
                                style="text-align: center;"
                            )
                        )
                        for item in invoicing_summary.items
                    ] if invoicing_summary.items else [
                        Tr(
                            Td("Нет позиций для проверки", colspan="5", style="text-align: center; color: #666; padding: 1rem;")
                        )
                    ]
                ),
                style="width: 100%;"
            ),
            # Link to supplier invoices registry
            Div(
                A(icon("clipboard-list", size=16), " Открыть реестр инвойсов поставщиков →", href="/supplier-invoices",
                  style="color: #3b82f6; text-decoration: none; font-size: 0.875rem;"),
                style="margin-top: 1rem; text-align: right;"
            ),
            cls="card",
            style="margin-top: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if invoicing_summary.total_items > 0 else None,

        # Action buttons (only if can edit)
        Div(
            # Section header
            Div(
                icon("zap", size=16, color="#64748b"),
                Span(" ДЕЙСТВИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            Div(
                # Return for revision button
                A(
                    icon("rotate-ccw", size=16, color="white"),
                    Span(" Вернуть на доработку", style="margin-left: 6px;"),
                    href=f"/quote-control/{quote_id}/return",
                    role="button",
                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 8px; padding: 0.625rem 1rem; display: inline-flex; align-items: center; text-decoration: none; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                ),
                # Approve or send for approval
                A(
                    icon("check" if not needs_approval else "clock", size=16, color="white"),
                    Span(" Одобрить" if not needs_approval else " Отправить на согласование", style="margin-left: 6px;"),
                    href=f"/quote-control/{quote_id}/approve" if not needs_approval else f"/quote-control/{quote_id}/request-approval",
                    role="button",
                    style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border: none; border-radius: 8px; padding: 0.625rem 1rem; display: inline-flex; align-items: center; text-decoration: none; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                ) if workflow_status == "pending_quote_control" else None,
                style="display: flex; gap: 1rem; flex-wrap: wrap;"
            ),
            cls="card",
            style="margin-top: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if can_edit else Div(
            P("Редактирование недоступно в текущем статусе", style="color: #64748b; text-align: center;"),
            cls="card",
            style="margin-top: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Link to quote details
        Div(
            A(icon("file-text", size=16), " Открыть КП в редакторе", href=f"/quotes/{quote_id}", role="button",
              style="background: #6b7280; border-color: #6b7280;"),
            style="margin-top: 1rem; text-align: center;"
        ),

        # Transition history (Feature #88)
        workflow_transition_history(quote_id),

        session=session
    )


# ============================================================================
# QUOTE CONTROL - CUSTOM COLUMN SELECTOR
# ============================================================================

@rt("/quote-control/{quote_id}/columns")
def get(session, quote_id: str):
    """Custom column selector page for quote control calculations."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get current user settings
    current_columns = CALC_PRESET_BASIC
    try:
        result = supabase.table("user_settings") \
            .select("setting_value") \
            .eq("user_id", user_id) \
            .eq("setting_key", "quote_control_columns") \
            .execute()
        if result.data:
            current_columns = result.data[0].get("setting_value", {}).get("columns", CALC_PRESET_BASIC)
    except Exception:
        pass

    # Group columns by category
    column_groups = {}
    for col_code, col_info in CALC_COLUMNS.items():
        group = col_info.get("group", "Прочее")
        if group not in column_groups:
            column_groups[group] = []
        column_groups[group].append((col_code, col_info))

    # Build checkboxes grouped by category
    checkbox_groups = []
    for group_name, cols in column_groups.items():
        checkboxes = [
            Label(
                Input(
                    type="checkbox",
                    name="columns",
                    value=col_code,
                    checked=col_code in current_columns,
                    style="margin-right: 0.5rem;"
                ),
                col_info["name"],
                Span(f" ({col_code})", style="color: #666; font-size: 0.75rem;"),
                style="display: flex; align-items: center; margin-bottom: 0.5rem;"
            )
            for col_code, col_info in cols
        ]
        checkbox_groups.append(
            Div(
                H4(group_name, style="margin-bottom: 0.5rem; color: #374151;"),
                *checkboxes,
                style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;"
            )
        )

    return page_layout(
        "Настройка колонок расчёта",

        H1(icon("settings", size=28), " Настройка колонок", cls="page-header"),
        P("Выберите колонки для отображения в таблице расчётов", style="color: #666; margin-bottom: 1rem;"),

        # Quick preset buttons
        Div(
            btn_link("Базовый набор", href=f"/quote-control/{quote_id}/columns/preset/basic", variant="secondary", size="sm"),
            btn_link("Полный набор", href=f"/quote-control/{quote_id}/columns/preset/full", variant="secondary", size="sm"),
            style="margin-bottom: 1rem; display: flex; gap: 0.5rem;"
        ),

        Form(
            *checkbox_groups,

            Div(
                btn("Сохранить настройки", variant="primary", icon_name="check", type="submit"),
                btn_link("Отмена", href=f"/quote-control/{quote_id}", variant="ghost"),
                style="margin-top: 1rem; display: flex; gap: 0.5rem;"
            ),
            action=f"/quote-control/{quote_id}/columns",
            method="post"
        ),

        session=session
    )


@rt("/quote-control/{quote_id}/columns")
def post(session, quote_id: str, columns: list = None):
    """Save custom column selection."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]

    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Handle single column (not list) case from form submission
    if columns is None:
        columns = []
    elif isinstance(columns, str):
        columns = [columns]

    # Validate columns
    valid_columns = [c for c in columns if c in CALC_COLUMNS]
    if not valid_columns:
        valid_columns = CALC_PRESET_BASIC

    # Save to user_settings using upsert
    try:
        # First try to update
        update_result = supabase.table("user_settings") \
            .update({
                "setting_value": {"columns": valid_columns, "preset": "custom"},
                "updated_at": datetime.now().isoformat()
            }) \
            .eq("user_id", user_id) \
            .eq("setting_key", "quote_control_columns") \
            .execute()

        # If no rows updated, insert new
        if not update_result.data:
            supabase.table("user_settings").insert({
                "user_id": user_id,
                "setting_key": "quote_control_columns",
                "setting_value": {"columns": valid_columns, "preset": "custom"}
            }).execute()
    except Exception as e:
        print(f"Error saving user settings: {e}")

    return RedirectResponse(f"/quote-control/{quote_id}?preset=custom#calc-table", status_code=303)


@rt("/quote-control/{quote_id}/columns/preset/{preset_name}")
def get(session, quote_id: str, preset_name: str):
    """Quick preset selection - sets preset and redirects."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]

    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    if preset_name not in ("basic", "full"):
        preset_name = "basic"

    # Save preset to user settings
    columns = CALC_PRESET_FULL if preset_name == "full" else CALC_PRESET_BASIC
    try:
        update_result = supabase.table("user_settings") \
            .update({
                "setting_value": {"columns": columns, "preset": preset_name},
                "updated_at": datetime.now().isoformat()
            }) \
            .eq("user_id", user_id) \
            .eq("setting_key", "quote_control_columns") \
            .execute()

        if not update_result.data:
            supabase.table("user_settings").insert({
                "user_id": user_id,
                "setting_key": "quote_control_columns",
                "setting_value": {"columns": columns, "preset": preset_name}
            }).execute()
    except Exception as e:
        print(f"Error saving user settings: {e}")

    return RedirectResponse(f"/quote-control/{quote_id}?preset={preset_name}#calc-table", status_code=303)


# ============================================================================
# TOP MANAGER APPROVALS WORKSPACE
# ============================================================================

@rt("/approvals")
def get(session):
    """
    Top Manager Approvals Workspace.

    Shows all quotes pending approval with:
    - Quote details (IDN, customer, amount)
    - Approval reason from controller
    - Justification from sales manager
    - Quick action buttons
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has top_manager role
    if not user_has_any_role(session, ["top_manager", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get all quotes pending approval for this org
    quotes_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("organization_id", org_id) \
        .eq("workflow_status", "pending_approval") \
        .order("updated_at", desc=True) \
        .execute()

    pending_quotes = quotes_result.data or []

    # Count stats
    total_pending = len(pending_quotes)
    total_amount = sum(float(q.get("total_amount") or 0) for q in pending_quotes)

    # Build quote cards
    quote_cards = []
    for q in pending_quotes:
        quote_id = q.get("id")
        idn_quote = q.get("idn_quote", f"#{quote_id[:8]}")
        customer = q.get("customers", {}) or {}
        customer_name = customer.get("name", "—")
        amount = q.get("total_amount")
        currency = q.get("currency", "RUB")
        approval_reason = q.get("approval_reason", "")
        approval_justification = q.get("approval_justification", "")
        updated_at = q.get("updated_at", "")[:10] if q.get("updated_at") else "—"

        quote_cards.append(
            Div(
                # Header row
                Div(
                    Div(
                        A(f"📋 {idn_quote}", href=f"/quotes/{quote_id}",
                          style="font-weight: 600; font-size: 1.1rem; color: #1e40af; text-decoration: none;"),
                        Span(f" • {customer_name}", style="color: #6b7280;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Span(format_money(amount, currency), style="font-weight: 600; font-size: 1.1rem; color: #059669;"),
                        style="text-align: right;"
                    ),
                    style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;"
                ),

                # Context section
                Div(
                    Div(
                        Span("📋 Причина:", style="font-weight: 500; font-size: 0.875rem;"),
                        Span(f" {approval_reason[:100]}{'...' if len(approval_reason) > 100 else ''}" if approval_reason else " Не указана",
                             style="font-size: 0.875rem; color: #666;"),
                        style="background: #fef3c7; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;"
                    ) if approval_reason else None,
                    Div(
                        Span("💼 Обоснование:", style="font-weight: 500; font-size: 0.875rem;"),
                        Span(f" {approval_justification[:100]}{'...' if len(approval_justification) > 100 else ''}" if approval_justification else " Не указано",
                             style="font-size: 0.875rem; color: #666;"),
                        style="background: #dbeafe; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;"
                    ) if approval_justification else None,
                    style="margin-bottom: 0.75rem;"
                ) if approval_reason or approval_justification else None,

                # Actions row
                Div(
                    Span(f"Обновлено: {updated_at}", style="color: #9ca3af; font-size: 0.875rem;"),
                    Div(
                        A(icon("check", size=14), " Одобрить", href=f"/quotes/{quote_id}",
                          style="background: #16a34a; color: white; padding: 0.375rem 0.75rem; border-radius: 6px; text-decoration: none; font-size: 0.875rem; margin-right: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"),
                        A(icon("eye", size=14), " Подробнее", href=f"/quotes/{quote_id}",
                          style="background: #3b82f6; color: white; padding: 0.375rem 0.75rem; border-radius: 6px; text-decoration: none; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;"),
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),

                cls="card",
                style="margin-bottom: 1rem; border-left: 4px solid #f59e0b;"
            )
        )

    return page_layout("Согласования",
        # Header
        Div(
            H1(icon("clock", size=28), " Согласования", cls="page-header"),
            P("Коммерческие предложения, ожидающие вашего решения", style="color: #666;"),
            style="margin-bottom: 1rem;"
        ),

        # Stats cards
        Div(
            Div(
                Div(str(total_pending), style="font-size: 2rem; font-weight: 700; color: #f59e0b;"),
                Div("Ожидают решения", style="color: #666; font-size: 0.875rem;"),
                cls="card", style="text-align: center; padding: 1rem;"
            ),
            Div(
                Div(format_money(total_amount, "RUB"), style="font-size: 1.5rem; font-weight: 700; color: #059669;"),
                Div("Общая сумма", style="color: #666; font-size: 0.875rem;"),
                cls="card", style="text-align: center; padding: 1rem;"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;"
        ),

        # Quotes list
        Div(
            H2(f"КП на согласовании ({total_pending})", style="margin-bottom: 1rem;"),
            *quote_cards if quote_cards else [
                Div(
                    icon("check-circle", size=48),
                    H3("Все согласовано!", style="margin: 1rem 0 0.5rem;"),
                    P("Нет КП, ожидающих вашего решения.", style="color: #666;"),
                    style="text-align: center; padding: 3rem; color: #16a34a;",
                    cls="card"
                )
            ],
        ),

        session=session
    )


# ============================================================================
# QUOTE CONTROL - RETURN FOR REVISION FORM (Feature #49)
# ============================================================================

@rt("/quote-control/{quote_id}/return")
def get(session, quote_id: str):
    """
    Return for Revision form - shows a form for quote_controller to return a quote
    back to sales manager with a comment explaining what needs to be fixed.

    Feature #49: Форма возврата на доработку
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is in correct status
    if workflow_status != "pending_quote_control":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе '{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}' и не может быть возвращено на доработку."),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}"),
            session=session
        )

    customer_name = quote.get("customers", {}).get("name", "—")
    idn_quote = quote.get("idn_quote", "")

    # Department options for return
    department_options = [
        ("sales", "💼 Менеджер по продажам", "Вернуть для исправления данных о клиенте, наценке, условиях"),
        ("procurement", "📦 Закупки", "Вернуть для исправления цен, поставщиков, сроков производства"),
        ("logistics", "🚚 Логистика", "Вернуть для исправления расчёта доставки, маршрутов"),
        ("customs", "📋 Таможня", "Вернуть для исправления таможенных расчётов, HS-кодов"),
    ]

    return page_layout(f"Возврат на доработку - {idn_quote}",
        # Gradient header card
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#64748b"),
                    Span("Вернуться к проверке", style="margin-left: 6px;"),
                    href=f"/quote-control/{quote_id}",
                    style="display: inline-flex; align-items: center; color: #64748b; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("undo-2", size=24, color="#f59e0b"),
                    Span(f"Возврат КП {idn_quote} на доработку", style="font-size: 22px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    style="display: flex; align-items: center;"
                ),
                Div(
                    Span(f"Клиент: {customer_name}", style="color: #64748b; font-size: 14px;"),
                    style="margin-top: 4px;"
                ),
            ),
            style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fde68a; border-radius: 12px; padding: 20px 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Form
        Form(
            # Department selection card
            Div(
                Div(
                    icon("users", size=16, color="#64748b"),
                    Span("КОМУ ВЕРНУТЬ?", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"
                ),
                P("Выберите отдел, который должен внести исправления:",
                  style="color: #64748b; font-size: 13px; margin-bottom: 16px;"),
                *[
                    Div(
                        Label(
                            Input(
                                type="radio",
                                name="department",
                                value=dept_code,
                                required=True,
                                checked=(dept_code == "sales"),
                                style="margin-right: 10px; accent-color: #f59e0b;"
                            ),
                            Span(dept_label, style="font-weight: 500; color: #1e293b;"),
                            Br(),
                            Span(dept_desc, style="color: #64748b; font-size: 13px; margin-left: 26px; display: block; margin-top: 2px;"),
                            style="cursor: pointer; display: block;"
                        ),
                        style="padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 8px; background: #f8fafc; transition: all 0.15s ease;"
                    )
                    for dept_code, dept_label, dept_desc in department_options
                ],
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Comment section card
            Div(
                Div(
                    icon("message-square", size=16, color="#64748b"),
                    Span("ПРИЧИНА ВОЗВРАТА", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;"
                ),
                P("Укажите, что необходимо исправить в КП:",
                  style="color: #64748b; font-size: 13px; margin-bottom: 12px;"),
                Textarea(
                    name="comment",
                    id="comment",
                    placeholder="Опишите, какие именно данные требуют исправления:\n- Неверная наценка\n- Ошибки в логистике\n- Некорректные условия оплаты\n- и т.д.",
                    required=True,
                    style="width: 100%; min-height: 150px; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; resize: vertical; background: #f8fafc; font-size: 14px; color: #1e293b;"
                ),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Info banner
            Div(
                icon("alert-triangle", size=18, color="#92400e"),
                Span("После исправлений выбранный отдел вернёт КП обратно на проверку.", style="margin-left: 10px;"),
                style="display: flex; align-items: center; background: #fef3c7; color: #92400e; padding: 14px 16px; border-radius: 10px; margin-bottom: 24px; font-size: 14px;"
            ),

            # Action buttons
            Div(
                btn("Вернуть на доработку", variant="secondary", icon_name="undo-2", type="submit"),
                btn_link("Отмена", href=f"/quote-control/{quote_id}", variant="ghost"),
                style="display: flex; align-items: center; gap: 12px;"
            ),

            action=f"/quote-control/{quote_id}/return",
            method="post"
        ),

        session=session
    )


@rt("/quote-control/{quote_id}/return")
def post(session, quote_id: str, comment: str = "", department: str = "sales"):
    """
    Handle the return for revision form submission.
    Transitions the quote from PENDING_QUOTE_CONTROL to the selected department's status.

    Feature #49: Форма возврата на доработку - POST handler
    Feature: Multi-department return - can return to sales/procurement/logistics/customs
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Get user's role codes for the transition
    user_roles = get_user_roles_from_session(session)

    # Map department to target status
    department_status_map = {
        "sales": WorkflowStatus.PENDING_SALES_REVIEW,
        "procurement": WorkflowStatus.PENDING_PROCUREMENT,
        "logistics": WorkflowStatus.PENDING_LOGISTICS,
        "customs": WorkflowStatus.PENDING_CUSTOMS,
    }

    department_names = {
        "sales": "менеджеру по продажам",
        "procurement": "в отдел закупок",
        "logistics": "в отдел логистики",
        "customs": "в таможенный отдел",
    }

    # Validate department
    if department not in department_status_map:
        return page_layout("Ошибка",
            H1("Ошибка возврата"),
            P("Выбран некорректный отдел для возврата."),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/return"),
            session=session
        )

    target_status = department_status_map[department]
    department_name = department_names[department]

    # Validate comment is provided
    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка возврата"),
            P("Необходимо указать причину возврата КП на доработку."),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/return"),
            session=session
        )

    supabase = get_supabase()

    # Verify quote exists and belongs to this org
    quote_result = supabase.table("quotes") \
        .select("workflow_status") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    current_status = quote_result.data[0].get("workflow_status", "draft")

    # Check if quote is in correct status
    if current_status != "pending_quote_control":
        return page_layout("Возврат невозможен",
            H1("Возврат невозможен"),
            P(f"КП находится в статусе '{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}' и не может быть возвращено на доработку."),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}"),
            session=session
        )

    # Perform the workflow transition
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=target_status,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=comment.strip()
    )

    if result.success:
        # Save revision tracking info to quote
        from datetime import datetime, timezone
        try:
            supabase.table("quotes").update({
                "revision_department": department,
                "revision_comment": comment.strip(),
                "revision_returned_at": datetime.now(timezone.utc).isoformat()
            }).eq("id", quote_id).execute()
        except Exception as e:
            print(f"Warning: Failed to save revision info for quote {quote_id}: {e}")

        # Feature #63: Send notification to quote creator about the return
        # Import asyncio locally if not already imported at module level
        import asyncio
        try:
            asyncio.get_event_loop().run_until_complete(
                notify_creator_of_return(
                    quote_id=quote_id,
                    actor_id=user_id,
                    comment=comment.strip()
                )
            )
        except Exception as e:
            # Log error but don't fail the request - notification is best effort
            print(f"Error sending return notification for quote {quote_id}: {e}")

        # Redirect to quote control list with success message
        return page_layout("Успешно",
            H1(icon("check", size=28), " КП возвращено на доработку", cls="page-header"),
            P(f"КП было успешно возвращено {department_name}."),
            P(f"Комментарий: {comment.strip()}", style="color: #666; font-style: italic;"),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        # Show error
        return page_layout("Ошибка",
            H1("Ошибка возврата"),
            P(f"Не удалось вернуть КП на доработку: {result.error_message}"),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/return"),
            session=session
        )


# ============================================================================
# QUOTE CONTROL - REQUEST APPROVAL FORM (Feature #50)
# ============================================================================

@rt("/quote-control/{quote_id}/request-approval")
def get(session, quote_id: str):
    """
    Request Approval form - shows a form for quote_controller to request
    top manager approval when the quote meets certain criteria.

    Feature #50: Кнопка отправки на согласование

    Approval is required when:
    - Currency is RUB
    - Prepayment is less than 100%
    - Markup is below minimum threshold
    - There is an LPR reward
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is in correct status
    if workflow_status != "pending_quote_control":
        return page_layout("Согласование невозможно",
            H1("Согласование невозможно"),
            P(f"КП находится в статусе '{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}' и не может быть отправлено на согласование."),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}"),
            session=session
        )

    # Get calculation variables to show reasons
    vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()
    calc_vars = vars_result.data[0]["variables"] if vars_result.data else {}

    # Calculate approval reasons (same logic as in quote-control detail page)
    deal_type = quote.get("deal_type") or calc_vars.get("offer_sale_type", "")
    currency = quote.get("currency", "USD")
    markup = float(calc_vars.get("markup", 0) or 0)
    prepayment = float(calc_vars.get("client_prepayment_percent", 100) or 100)
    lpr_reward = float(calc_vars.get("lpr_reward", 0) or calc_vars.get("decision_maker_reward", 0) or 0)

    min_markup_supply = 12
    min_markup_transit = 8

    approval_reasons = []
    if currency == "RUB":
        approval_reasons.append("Валюта КП = рубли")
    if prepayment < 100:
        approval_reasons.append(f"Не 100% предоплата ({prepayment}%)")
    if deal_type == "supply" and markup < min_markup_supply:
        approval_reasons.append(f"Наценка ({markup}%) ниже минимума для поставки ({min_markup_supply}%)")
    elif deal_type == "transit" and markup < min_markup_transit:
        approval_reasons.append(f"Наценка ({markup}%) ниже минимума для транзита ({min_markup_transit}%)")
    if lpr_reward > 0:
        approval_reasons.append(f"Есть вознаграждение ЛПРа ({lpr_reward})")

    customer_name = quote.get("customers", {}).get("name", "—")
    idn_quote = quote.get("idn_quote", "")

    # Pre-fill the reason with detected triggers
    default_reason = ""
    if approval_reasons:
        default_reason = "Требуется согласование по следующим причинам:\n" + "\n".join(f"• {r}" for r in approval_reasons)

    return page_layout(f"Запрос согласования - {idn_quote}",
        # Header
        Div(
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}", style="color: #3b82f6; text-decoration: none;"),
            H1(icon("clock", size=28), f" Запрос согласования КП {idn_quote}", cls="page-header"),
            P(f"Клиент: {customer_name}", style="color: #666;"),
            style="margin-bottom: 1rem;"
        ),

        # Info banner
        Div(
            icon("info", size=16), " КП будет отправлено на согласование топ-менеджеру. После одобрения вы сможете отправить его клиенту.",
            style="background: #dbeafe; color: #1e40af; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"
        ),

        # Detected reasons card
        Div(
            H3("Причины для согласования"),
            Ul(*[Li(reason) for reason in approval_reasons], style="margin: 0; padding-left: 1.5rem;") if approval_reasons else P("Причины не обнаружены автоматически", style="color: #666;"),
            cls="card",
            style="margin-bottom: 1rem; background: #fef3c7;"
        ) if approval_reasons else None,

        # Form
        Form(
            Div(
                H3("Комментарий для топ-менеджера", style="margin-bottom: 0.5rem;"),
                P("Опишите причину запроса согласования и любую дополнительную информацию.",
                  style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;"),
                Textarea(
                    default_reason,
                    name="comment",
                    id="comment",
                    placeholder="Укажите причину запроса согласования...",
                    required=True,
                    style="width: 100%; min-height: 150px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; resize: vertical;"
                ),
                style="margin-bottom: 1rem;"
            ),

            # Action buttons
            Div(
                btn("Отправить на согласование", variant="primary", icon_name="clock", type="submit"),
                btn_link("Отмена", href=f"/quote-control/{quote_id}", variant="ghost"),
                style="display: flex; align-items: center; gap: 1rem;"
            ),

            action=f"/quote-control/{quote_id}/request-approval",
            method="post",
            cls="card"
        ),

        session=session
    )


@rt("/quote-control/{quote_id}/request-approval")
def post(session, quote_id: str, comment: str = ""):
    """
    Handle the request approval form submission.
    Uses request_approval() to:
    1. Transition quote from PENDING_QUOTE_CONTROL to PENDING_APPROVAL
    2. Create approval records for all top_manager/admin users
    3. Send Telegram notifications to approvers

    Feature #50: Кнопка отправки на согласование - POST handler
    Feature #65: Uses request_approval function for complete workflow
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Get user's role codes for the transition
    user_roles = get_user_roles_from_session(session)

    # Validate comment is provided
    if not comment or not comment.strip():
        return page_layout("Ошибка",
            H1("Ошибка отправки"),
            P("Необходимо указать причину запроса согласования."),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/request-approval"),
            session=session
        )

    supabase = get_supabase()

    # Verify quote exists and belongs to this org
    quote_result = supabase.table("quotes") \
        .select("workflow_status, idn_quote, total_amount, currency, customers(name)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    idn_quote = quote.get("idn_quote", "")
    customer_name = quote.get("customers", {}).get("name", "") if quote.get("customers") else ""

    # Feature: Justification workflow (Variant B)
    # Instead of sending directly to pending_approval, we:
    # 1. Save the controller's approval_reason
    # 2. Set needs_justification=true
    # 3. Transition to pending_sales_review so sales manager can provide justification
    # 4. After sales provides justification, THEN it goes to pending_approval

    try:
        # Transition quote to pending_sales_review for justification
        result = transition_quote(
            quote_id=quote_id,
            to_status=WorkflowStatus.PENDING_SALES_REVIEW,
            actor_id=user_id,
            actor_roles=user_roles,
            comment=f"[Запрос согласования] {comment.strip()}"
        )

        if not result.success:
            return page_layout("Ошибка",
                H1("Ошибка отправки"),
                P(f"Не удалось отправить КП на согласование: {result.error_message}"),
                A("← Вернуться к форме", href=f"/quote-control/{quote_id}/request-approval"),
                session=session
            )

        # Save approval_reason and needs_justification flag
        supabase.table("quotes").update({
            "approval_reason": comment.strip(),
            "needs_justification": True,
            "approval_justification": None  # Clear any previous justification
        }).eq("id", quote_id).execute()

        return page_layout("Успешно",
            H1(icon("check", size=28), " Отправлено менеджеру продаж", cls="page-header"),
            P(f"КП {idn_quote} отправлено менеджеру продаж для обоснования."),
            P(f"Причина согласования: {comment.strip()}", style="color: #666; font-style: italic;"),
            P("После того как менеджер продаж предоставит обоснование, КП будет отправлено на согласование топ-менеджеру.", style="color: #666;"),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    except Exception as e:
        return page_layout("Ошибка",
            H1("Ошибка отправки"),
            P(f"Произошла ошибка: {str(e)}"),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/request-approval"),
            session=session
        )


# ============================================================================
# QUOTE CONTROL - APPROVE QUOTE (Feature #51)
# ============================================================================

@rt("/quote-control/{quote_id}/approve")
def get(session, quote_id: str):
    """
    Approve Quote confirmation page - shows a confirmation before approving.

    Feature #51: Кнопка одобрения КП

    This is used when the quote does NOT require top manager approval.
    For quotes that need approval, use /request-approval instead.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Get the quote
    quote_result = supabase.table("quotes") \
        .select("*, customers(name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("Quote Not Found",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    workflow_status = quote.get("workflow_status", "draft")

    # Check if quote is in correct status
    if workflow_status != "pending_quote_control":
        return page_layout("Одобрение невозможно",
            H1("Одобрение невозможно"),
            P(f"КП находится в статусе '{STATUS_NAMES.get(WorkflowStatus(workflow_status), workflow_status)}' и не может быть одобрено."),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}"),
            session=session
        )

    # Get calculation variables to check if approval is needed
    vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()
    calc_vars = vars_result.data[0]["variables"] if vars_result.data else {}

    # Check if approval is required (same logic as in quote-control detail page)
    deal_type = quote.get("deal_type") or calc_vars.get("offer_sale_type", "")
    currency = quote.get("currency", "USD")
    markup = float(calc_vars.get("markup", 0) or 0)
    prepayment = float(calc_vars.get("client_prepayment_percent", 100) or 100)
    lpr_reward = float(calc_vars.get("lpr_reward", 0) or calc_vars.get("decision_maker_reward", 0) or 0)

    min_markup_supply = 12
    min_markup_transit = 8

    approval_reasons = []
    if currency == "RUB":
        approval_reasons.append("Валюта КП = рубли")
    if prepayment < 100:
        approval_reasons.append(f"Не 100% предоплата ({prepayment}%)")
    if deal_type == "supply" and markup < min_markup_supply:
        approval_reasons.append(f"Наценка ниже минимума для поставки")
    elif deal_type == "transit" and markup < min_markup_transit:
        approval_reasons.append(f"Наценка ниже минимума для транзита")
    if lpr_reward > 0:
        approval_reasons.append(f"Есть вознаграждение ЛПРа")

    # If approval is required, redirect to request-approval
    if approval_reasons:
        return page_layout("Требуется согласование",
            H1(icon("alert-triangle", size=28), " Требуется согласование топ-менеджера", cls="page-header"),
            P("Это КП не может быть одобрено напрямую, так как имеются следующие причины для согласования:"),
            Ul(*[Li(reason) for reason in approval_reasons]),
            A(icon("clock", size=16), " Отправить на согласование", href=f"/quote-control/{quote_id}/request-approval", role="button"),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}",
              style="margin-left: 1rem; color: #6b7280; text-decoration: none;"),
            session=session
        )

    customer_name = quote.get("customers", {}).get("name", "—")
    idn_quote = quote.get("idn_quote", "")
    total_amount = float(quote.get("total_amount", 0) or 0)
    quote_currency = quote.get("currency", "USD")

    return page_layout(f"Одобрение КП - {idn_quote}",
        # Header
        Div(
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}", style="color: #3b82f6; text-decoration: none;"),
            H1(icon("check", size=28), f" Одобрение КП {idn_quote}", cls="page-header"),
            P(f"Клиент: {customer_name}", style="color: #666;"),
            style="margin-bottom: 1rem;"
        ),

        # Success banner
        Div(
            "КП прошло проверку и может быть одобрено",
            style="background: #dcfce7; color: #166534; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"
        ),

        # Quote summary card
        Div(
            H3("Сводка по КП"),
            Div(
                Div(Strong("Сумма: "), format_money(total_amount, quote_currency)),
                Div(Strong("Наценка: "), f"{markup}%"),
                Div(Strong("Предоплата: "), f"{prepayment}%"),
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;"
            ),
            cls="card",
            style="margin-bottom: 1rem;"
        ),

        # Confirmation form
        Form(
            P("После одобрения КП станет доступно для отправки клиенту.", style="color: #666; margin-bottom: 1rem;"),

            # Optional comment
            Div(
                Label("Комментарий (необязательно)", for_="comment", style="font-weight: 500; margin-bottom: 0.25rem; display: block;"),
                Textarea(
                    name="comment",
                    id="comment",
                    placeholder="Дополнительные комментарии...",
                    style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-family: inherit; resize: vertical;"
                ),
                style="margin-bottom: 1rem;"
            ),

            # Action buttons
            Div(
                btn("Одобрить КП", variant="success", icon_name="check", type="submit"),
                btn_link("Отмена", href=f"/quote-control/{quote_id}", variant="ghost"),
                style="display: flex; align-items: center; gap: 1rem;"
            ),

            action=f"/quote-control/{quote_id}/approve",
            method="post",
            cls="card"
        ),

        session=session
    )


@rt("/quote-control/{quote_id}/approve")
def post(session, quote_id: str, comment: str = ""):
    """
    Handle the approve quote form submission.
    Transitions the quote from PENDING_QUOTE_CONTROL to APPROVED.

    Feature #51: Кнопка одобрения КП - POST handler
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has quote_controller role
    if not user_has_any_role(session, ["quote_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Get user's role codes for the transition
    user_roles = get_user_roles_from_session(session)

    supabase = get_supabase()

    # Verify quote exists and belongs to this org
    quote_result = supabase.table("quotes") \
        .select("workflow_status, idn_quote") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не существует или у вас нет доступа."),
            A("← К задачам", href="/tasks"),
            session=session
        )

    quote = quote_result.data[0]
    current_status = quote.get("workflow_status", "draft")
    idn_quote = quote.get("idn_quote", "")

    # Check if quote is in correct status
    if current_status != "pending_quote_control":
        return page_layout("Одобрение невозможно",
            H1("Одобрение невозможно"),
            P(f"КП находится в статусе '{STATUS_NAMES.get(WorkflowStatus(current_status), current_status)}' и не может быть одобрено."),
            A("← Вернуться к проверке", href=f"/quote-control/{quote_id}"),
            session=session
        )

    # Perform the workflow transition to APPROVED
    result = transition_quote_status(
        quote_id=quote_id,
        to_status=WorkflowStatus.APPROVED,
        actor_id=user_id,
        actor_roles=user_roles,
        comment=comment.strip() if comment else "Одобрено контроллером КП"
    )

    if result.success:
        # Success - redirect to quote control list
        return page_layout("Успешно",
            H1(icon("check-circle", size=28), " КП одобрено", cls="page-header"),
            P(f"КП {idn_quote} было успешно одобрено."),
            P("Теперь менеджер по продажам может отправить его клиенту.", style="color: #666;"),
            btn_link("К задачам", href="/tasks", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        # Show error
        return page_layout("Ошибка",
            H1("Ошибка одобрения"),
            P(f"Не удалось одобрить КП: {result.error_message}"),
            A("← Вернуться к форме", href=f"/quote-control/{quote_id}/approve"),
            session=session
        )


# ============================================================================
# TELEGRAM BOT WEBHOOK (Feature #53)
# ============================================================================

# Import asyncio for running async webhook handler
import asyncio

# Import telegram service functions
from services.telegram_service import (
    is_bot_configured,
    process_webhook_update,
    respond_to_command,
    WebhookResult,
    # Feature #56 imports
    get_user_telegram_status,
    request_verification_code,
    unlink_telegram_account,
    # Feature #60 imports
    handle_approve_callback,
    send_callback_response,
    # Feature #61 imports
    handle_reject_callback,
    # Feature #63 imports
    notify_creator_of_return,
    # Bug report imports
    send_admin_bug_report,
)


@rt("/api/telegram/webhook")
async def telegram_webhook(request):
    """Handle incoming Telegram webhook updates.

    This endpoint receives updates from Telegram when:
    - Users send messages to the bot (/start, /status, /help)
    - Users press inline buttons (approve, reject, details)

    Returns:
        JSON response with status

    Note:
        - This endpoint must be publicly accessible (HTTPS in production)
        - Webhook URL must be registered with Telegram via set_webhook()
        - Always return 200 OK quickly to prevent Telegram from retrying
    """
    import json
    import logging

    logger = logging.getLogger(__name__)

    # Check if bot is configured
    if not is_bot_configured():
        logger.warning("Telegram webhook received but bot is not configured")
        return {"ok": True, "message": "Bot not configured"}

    # Get the request body
    try:
        # FastHTML provides the body through request
        body = await request.body()
        json_data = json.loads(body)
    except Exception as e:
        logger.error(f"Failed to parse webhook request: {e}")
        return {"ok": False, "error": "Invalid request body"}

    # Log the incoming update (for debugging)
    logger.info(f"Telegram webhook received update: {json_data.get('update_id', 'unknown')}")

    # Process the update asynchronously
    try:
        result: WebhookResult = await process_webhook_update(json_data)

        if result.success:
            # Handle different update types
            if result.update_type == "command" and result.telegram_id and result.text:
                # Respond to commands, passing any arguments (e.g., /start ABC123)
                # Also pass telegram_username for verification (Feature #55)
                await respond_to_command(result.telegram_id, result.text, result.args, result.telegram_username)

            elif result.update_type == "callback_query" and result.callback_data:
                # Handle callback queries (inline button presses)
                callback_data = result.callback_data
                logger.info(f"Callback query: {callback_data.action} for {callback_data.quote_id}")

                # Feature #60: Handle approve callback
                if callback_data.action == "approve":
                    approve_result = await handle_approve_callback(
                        telegram_id=result.telegram_id,
                        quote_id=callback_data.quote_id
                    )
                    logger.info(f"Approve callback result: success={approve_result.success}, quote={approve_result.quote_idn}")

                    # Get message_id from the original update to edit the message
                    message_id = json_data.get("callback_query", {}).get("message", {}).get("message_id")
                    if message_id and result.telegram_id:
                        await send_callback_response(result.telegram_id, message_id, approve_result)

                # Feature #61: Handle reject callback
                elif callback_data.action == "reject":
                    reject_result = await handle_reject_callback(
                        telegram_id=result.telegram_id,
                        quote_id=callback_data.quote_id
                    )
                    logger.info(f"Reject callback result: success={reject_result.success}, quote={reject_result.quote_idn}")

                    # Get message_id from the original update to edit the message
                    message_id = json_data.get("callback_query", {}).get("message", {}).get("message_id")
                    if message_id and result.telegram_id:
                        await send_callback_response(result.telegram_id, message_id, reject_result)

                # Handle details callback - just log for now
                elif callback_data.action == "details":
                    logger.info(f"Details callback for quote {callback_data.quote_id}")

            elif result.update_type == "message":
                # Regular text message (not a command)
                logger.info(f"Text message from {result.telegram_id}: {result.text}")

            logger.info(f"Webhook processed: {result.message}")
        else:
            logger.warning(f"Webhook processing failed: {result.error}")

    except Exception as e:
        logger.error(f"Error processing webhook: {e}")
        # Still return 200 to prevent Telegram from retrying
        return {"ok": True, "error": str(e)}

    # Always return 200 OK to Telegram
    return {"ok": True}


# ============================================================================
# FEEDBACK / BUG REPORT API
# ============================================================================

def generate_feedback_short_id():
    """Generate short ID: FB-YYMMDDHHMMSS"""
    from datetime import datetime
    now = datetime.now()
    return f"FB-{now.strftime('%y%m%d%H%M%S')}"


@rt("/api/feedback", methods=["POST"])
async def submit_feedback(session, request: Request):
    """Handle feedback/bug report submission.

    Saves to database and sends notification to admin via Telegram.
    """
    import json as json_lib

    user = session.get("user", {})
    form = await request.form()

    feedback_type = form.get("feedback_type", "bug")
    description = form.get("description", "").strip()
    page_url = form.get("page_url", "")
    page_title = form.get("page_title", "")
    debug_context_str = form.get("debug_context", "{}")

    if not description:
        return Div("Пожалуйста, опишите проблему", cls="text-error mt-2")

    # Parse debug_context
    try:
        debug_context = json_lib.loads(debug_context_str)
    except:
        debug_context = {}

    # Generate short ID
    short_id = generate_feedback_short_id()

    supabase = get_supabase()

    try:
        # 1. Save to database
        supabase.table("user_feedback").insert({
            "short_id": short_id,
            "user_id": user.get("id"),
            "user_email": user.get("email"),
            "user_name": user.get("name", user.get("email", "Неизвестный")),
            "organization_id": user.get("org_id"),
            "organization_name": user.get("org_name", ""),
            "page_url": page_url,
            "page_title": page_title,
            "user_agent": request.headers.get("user-agent", ""),
            "feedback_type": feedback_type,
            "description": description,
            "debug_context": debug_context
        }).execute()

        # 2. Send to Telegram
        await send_admin_bug_report(
            short_id=short_id,
            user_name=user.get("name", user.get("email", "Неизвестный")),
            user_email=user.get("email", ""),
            org_name=user.get("org_name", ""),
            page_url=page_url,
            feedback_type=feedback_type,
            description=description,
            debug_context=debug_context
        )

        # 3. Return success message with short ID
        return Div(
            Div("Спасибо за обратную связь!", cls="text-success font-medium"),
            P(f"Номер обращения: {short_id}", cls="text-sm text-gray-500 mt-1 font-mono"),
            btn("Закрыть", variant="secondary", size="sm", onclick="closeFeedbackModal()", type="button")
        )

    except Exception as e:
        logger.error(f"Error saving feedback: {e}")
        return Div(
            Div("Ошибка при отправке", cls="text-error font-medium"),
            P(str(e), cls="text-sm text-gray-500 mt-1"),
            cls="mt-2"
        )


# ============================================================================
# SPEC CONTROL WORKSPACE (Features #67-72)
# ============================================================================

@rt("/spec-control")
def get(session, status_filter: str = None):
    """
    Redirect to unified dashboard spec-control tab.
    Old URL preserved for backwards compatibility.
    """
    url = "/dashboard?tab=spec-control"
    if status_filter:
        url += f"&status_filter={status_filter}"
    return RedirectResponse(url, status_code=303)


# ============================================================================
# SPECIFICATION DATA ENTRY (Feature #69)
# ============================================================================

@rt("/spec-control/create/{quote_id}")
def get(session, quote_id: str):
    """
    Create a new specification from a quote.

    Feature #69: Specification data entry form (create new)
    Feature UI-023: Enhanced v3.0 integration with seller company, customer contracts, signatory
    - Shows quote summary
    - Pre-fills some fields from quote data
    - v3.0: Auto-fetches seller company from quote's seller_company_id
    - v3.0: Customer contract dropdown for specification numbering
    - v3.0: Shows signatory from customer_contacts
    - Form for all 18 specification fields
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has spec_controller role
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch quote with customer info (some columns may not exist in DB)
    quote_result = supabase.table("quotes") \
        .select("*, customers(id, name, inn)") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return page_layout("КП не найдено",
            H1("КП не найдено"),
            P("Запрошенное КП не найдено или у вас нет доступа."),
            A("← Назад к спецификациям", href="/spec-control"),
            session=session
        )

    quote = quote_result.data[0]
    customer = quote.get("customers", {}) or {}
    customer_id = customer.get("id")
    customer_name = customer.get("name", "Unknown")
    customer_company = customer.get("company_name") or customer_name

    # v3.0: Get seller company from quote
    seller_company = quote.get("seller_companies", {}) or {}
    seller_company_name = seller_company.get("name", "")
    seller_company_id = quote.get("seller_company_id")

    # Check if specification already exists for this quote
    existing_spec = supabase.table("specifications") \
        .select("id") \
        .eq("quote_id", quote_id) \
        .execute()

    if existing_spec.data:
        # Redirect to edit existing specification
        return RedirectResponse(f"/spec-control/{existing_spec.data[0]['id']}", status_code=303)

    # Get quote versions for version selection (use * to avoid column mismatch)
    versions_result = supabase.table("quote_versions") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at", desc=True) \
        .execute()

    versions = versions_result.data or []

    # Get quote calculation variables for pre-filling some fields
    vars_result = supabase.table("quote_calculation_variables") \
        .select("variables") \
        .eq("quote_id", quote_id) \
        .execute()

    calc_vars = vars_result.data[0].get("variables", {}) if vars_result.data else {}

    # v3.0: Get customer contracts for dropdown
    customer_contracts = []
    if customer_id:
        contracts_result = supabase.table("customer_contracts") \
            .select("id, contract_number, contract_date, next_specification_number, status") \
            .eq("customer_id", customer_id) \
            .eq("status", "active") \
            .order("contract_date", desc=True) \
            .execute()
        customer_contracts = contracts_result.data or []

    # v3.0: Get customer signatory from customer_contacts
    signatory_info = None
    if customer_id:
        signatory_result = supabase.table("customer_contacts") \
            .select("name, position") \
            .eq("customer_id", customer_id) \
            .eq("is_signatory", True) \
            .limit(1) \
            .execute()
        if signatory_result.data:
            signatory_info = signatory_result.data[0]

    # Pre-fill values from quote
    prefill = {
        "proposal_idn": quote.get("idn_quote", ""),
        "specification_currency": quote.get("currency", "USD"),
        "client_legal_entity": customer_company,
        "delivery_city_russia": calc_vars.get("delivery_city", ""),
        "cargo_pickup_country": calc_vars.get("supplier_country", ""),
        # v3.0: Pre-fill our legal entity from seller company
        "our_legal_entity": seller_company_name,
    }

    # Form fields grouped by category
    return page_layout("Создание спецификации",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Назад", href="/dashboard?tab=spec-control",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    icon("file-plus", size=24, color="#6366f1"),
                    H1("Создание спецификации", style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    style="display: flex; align-items: center; gap: 12px;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Quote summary card
        Div(
            Div(
                Span("ИНФОРМАЦИЯ О КП", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 6px;"),
                style="margin-bottom: 12px;"
            ),
            Div(
                Div(
                    Span("КП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(f"{quote.get('idn_quote', '-')}", style="font-weight: 600; color: #1e293b; font-size: 15px;"),
                    style="flex: 1;"
                ),
                Div(
                    Span("Клиент", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(customer_name, style="font-weight: 600; color: #1e293b; font-size: 15px;"),
                    style="flex: 1;"
                ),
                Div(
                    Span("Сумма КП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(f"{quote.get('total_amount', 0):,.2f} {quote.get('currency', 'RUB')}", style="font-weight: 600; color: #1e293b; font-size: 15px;"),
                    style="flex: 1;"
                ),
                style="display: flex; gap: 24px;"
            ),
            style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;"
        ),

        Form(
            # Hidden fields
            Input(type="hidden", name="quote_id", value=quote_id),
            Input(type="hidden", name="organization_id", value=org_id),

            # Section 1: Identification & Date
            Div(
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ИДЕНТИФИКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("№ Спецификации", For="specification_number", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="specification_number", id="specification_number",
                              placeholder="Авто при выборе договора",
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        Small("Заполнится автоматически при выборе договора", style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Дата подписания", For="sign_date", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="sign_date", id="sign_date", type="date",
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Версия КП", For="quote_version_id", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Select(
                            Option("-- Выберите версию --", value=""),
                            *[Option(
                                f"v{v.get('version_number', 0)} - {v.get('total_amount', 0):,.2f} {v.get('currency', '')} ({v.get('created_at', '')[:10]})",
                                value=v.get("id"),
                                selected=v.get("id") == quote.get("current_version_id")
                            ) for v in versions],
                            name="quote_version_id",
                            id="quote_version_id",
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(3, 1fr); gap: 1rem;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Section 2: Delivery Conditions
            Div(
                Div(
                    icon("truck", size=16, color="#64748b"),
                    Span("УСЛОВИЯ ПОСТАВКИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Срок поставки (дней)", For="delivery_days", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="delivery_days", id="delivery_days", type="number", min="1",
                              placeholder="Авто из расчёта",
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        Small("Заполнится автоматически из расчёта КП", style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Тип дней", For="delivery_days_type", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Select(
                            Option("рабочих дней", value="рабочих дней", selected=True),
                            Option("календарных дней", value="календарных дней"),
                            name="delivery_days_type",
                            id="delivery_days_type",
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(2, 1fr); gap: 1rem;"
                ),
                P(
                    icon("info", size=14, color="#64748b"),
                    " Остальные условия (оплата, адрес, Incoterms) берутся из КП и данных клиента",
                    style="color: #64748b; font-size: 13px; margin-top: 12px; display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #f1f5f9; border-radius: 6px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Section 3: Contract and Signatory
            Div(
                Div(
                    icon("file-signature", size=16, color="#64748b"),
                    Span("ДОГОВОР И ПОДПИСАНТ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Договор клиента", For="contract_id", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Select(
                            Option("-- Без привязки к договору --", value=""),
                            *[Option(
                                f"{c.get('contract_number', '-')} от {c.get('contract_date', '')[:10] if c.get('contract_date') else '-'} (след.спец: №{c.get('next_specification_number', 1)})",
                                value=c.get("id")
                            ) for c in customer_contracts],
                            name="contract_id",
                            id="contract_id",
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ),
                        Small(
                            "При выборе договора номер спецификации будет сгенерирован автоматически",
                            style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;"
                        ),
                        cls="form-group"
                    ) if customer_contracts else Div(
                        Label("Договор клиента", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        P(icon("alert-triangle", size=14, color="#d97706"), " У клиента нет активных договоров", style="color: #d97706; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 13px;"),
                        A("Создать договор →", href=f"/customer-contracts/new?customer_id={customer_id}" if customer_id else "#",
                          style="font-size: 13px; color: #6366f1; margin-top: 4px; display: inline-block;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Подписант со стороны клиента", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Div(
                            P(
                                Strong(signatory_info.get("name", ""), style="color: #1e293b;"),
                                Br() if signatory_info.get("position") else None,
                                Span(signatory_info.get("position", ""), style="color: #64748b; font-size: 13px;") if signatory_info.get("position") else None,
                                style="margin: 0; padding: 10px 14px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 6px; border-left: 3px solid #22c55e;"
                            ),
                            Small(icon("check", size=12, color="#16a34a"), " Подписант определён из контактов клиента", style="color: #16a34a; display: flex; align-items: center; gap: 4px; margin-top: 6px; font-size: 12px;"),
                        ) if signatory_info else Div(
                            P(icon("alert-triangle", size=14, color="#d97706"), " Подписант не указан в контактах клиента", style="color: #d97706; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 13px;"),
                            A("Указать подписанта →", href=f"/customers/{customer_id}" if customer_id else "#",
                              style="font-size: 13px; color: #6366f1; margin-top: 4px; display: inline-block;"),
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(2, 1fr); gap: 1rem;"
                ),
                style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border: 1px solid #fde047; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Action buttons
            Div(
                btn("Создать спецификацию", variant="success", icon_name="save", type="submit", name="action", value="create"),
                btn_link("Отмена", href="/dashboard?tab=spec-control", variant="secondary"),
                style="margin-top: 8px; display: flex; gap: 12px;"
            ),

            action=f"/spec-control/create/{quote_id}",
            method="POST"
        ),

        session=session
    )


@rt("/spec-control/create/{quote_id}")
def post(session, quote_id: str, action: str = "create", **kwargs):
    """
    Create a new specification from form data.

    Feature #69: Specification data entry form (create POST handler)
    Feature UI-023: v3.0 enhanced with contract_id for auto-numbering
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Verify quote exists and belongs to org
    quote_result = supabase.table("quotes") \
        .select("id, organization_id") \
        .eq("id", quote_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not quote_result.data:
        return RedirectResponse("/spec-control", status_code=303)

    # Check if specification already exists
    existing_spec = supabase.table("specifications") \
        .select("id") \
        .eq("quote_id", quote_id) \
        .execute()

    if existing_spec.data:
        return RedirectResponse(f"/spec-control/{existing_spec.data[0]['id']}", status_code=303)

    # Helper for safe numeric conversion
    def safe_decimal(val, default=None):
        try:
            return float(val) if val else default
        except:
            return default

    def safe_int(val, default=None):
        try:
            return int(val) if val else default
        except:
            return default

    # v3.0: Handle contract_id for auto-numbering
    contract_id = kwargs.get("contract_id") or None
    specification_number = kwargs.get("specification_number") or None

    # Auto-generate specification number from contract if selected and no manual number provided
    if contract_id and not specification_number:
        try:
            # Get contract info for spec numbering
            contract_result = supabase.table("customer_contracts") \
                .select("contract_number, next_specification_number") \
                .eq("id", contract_id) \
                .execute()

            if contract_result.data:
                contract = contract_result.data[0]
                next_spec_num = contract.get("next_specification_number", 1)
                contract_num = contract.get("contract_number", "")
                # Format: CONTRACT_NUMBER-SPEC_NUMBER (e.g., ДП-001/2025-1)
                specification_number = f"{contract_num}-{next_spec_num}"

                # Increment next_specification_number in contract
                supabase.table("customer_contracts") \
                    .update({"next_specification_number": next_spec_num + 1}) \
                    .eq("id", contract_id) \
                    .execute()
        except Exception as e:
            print(f"Error auto-generating specification number: {e}")

    # Pre-fill delivery_days from calc_variables.delivery_time
    delivery_days = safe_int(kwargs.get("delivery_days"))
    if not delivery_days:
        try:
            calc_vars_result = supabase.table("quote_calculation_variables") \
                .select("variables") \
                .eq("quote_id", quote_id) \
                .execute()
            if calc_vars_result.data:
                variables = calc_vars_result.data[0].get("variables", {})
                delivery_days = safe_int(variables.get("delivery_time"))
        except Exception as e:
            print(f"Error fetching delivery_time from calc_variables: {e}")

    # Build specification data
    spec_data = {
        "quote_id": quote_id,
        "organization_id": org_id,
        "quote_version_id": kwargs.get("quote_version_id") or None,
        "specification_number": specification_number,
        "proposal_idn": kwargs.get("proposal_idn") or None,
        "item_ind_sku": kwargs.get("item_ind_sku") or None,
        "sign_date": kwargs.get("sign_date") or None,
        "validity_period": kwargs.get("validity_period") or None,
        "specification_currency": kwargs.get("specification_currency") or "USD",
        "exchange_rate_to_ruble": safe_decimal(kwargs.get("exchange_rate_to_ruble")),
        "client_payment_term_after_upd": safe_int(kwargs.get("client_payment_term_after_upd")),
        "client_payment_terms": kwargs.get("client_payment_terms") or None,
        "cargo_pickup_country": kwargs.get("cargo_pickup_country") or None,
        "readiness_period": kwargs.get("readiness_period") or None,
        "goods_shipment_country": kwargs.get("goods_shipment_country") or None,
        "delivery_city_russia": kwargs.get("delivery_city_russia") or None,
        "cargo_type": kwargs.get("cargo_type") or None,
        "logistics_period": kwargs.get("logistics_period") or None,
        "delivery_days": delivery_days,  # Pre-filled from calc_variables.delivery_time
        "delivery_days_type": kwargs.get("delivery_days_type") or "рабочих дней",
        "our_legal_entity": kwargs.get("our_legal_entity") or None,
        "client_legal_entity": kwargs.get("client_legal_entity") or None,
        "supplier_payment_country": kwargs.get("supplier_payment_country") or None,
        "contract_id": contract_id,  # v3.0: Link to customer contract
        "status": "draft",
        "created_by": user_id,
    }

    # Insert specification
    result = supabase.table("specifications").insert(spec_data).execute()

    if result.data:
        spec_id = result.data[0]["id"]
        return RedirectResponse(f"/spec-control/{spec_id}", status_code=303)
    else:
        return page_layout("Ошибка",
            H1("Ошибка создания спецификации"),
            P("Не удалось создать спецификацию. Попробуйте еще раз."),
            A("← Назад", href=f"/spec-control/create/{quote_id}"),
            session=session
        )


@rt("/spec-control/{spec_id}")
def get(session, spec_id: str):
    """
    View/edit an existing specification.

    Feature #69: Specification data entry form (edit existing)
    Feature UI-023: v3.0 enhanced with seller company, contracts, signatory
    - Shows all 18 specification fields
    - Editable when status is draft or pending_review
    - Shows quote summary and customer info
    - v3.0: Shows seller company from quote
    - v3.0: Shows linked contract info
    - v3.0: Shows signatory from customer_contacts
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has spec_controller role
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch specification with quote and customer info
    # Note: contract_id FK not yet applied in production DB (migration 036 pending)
    # Contracts are fetched separately below (lines 9298-9306)
    try:
        spec_result = supabase.table("specifications") \
            .select("*, quotes(id, idn_quote, total_amount, currency, workflow_status, customers(id, name, inn))") \
            .eq("id", spec_id) \
            .eq("organization_id", org_id) \
            .execute()
    except Exception as e:
        # Log detailed error to Sentry
        import traceback
        error_details = {
            "spec_id": spec_id,
            "org_id": org_id,
            "user_id": user_id,
            "error": str(e),
            "traceback": traceback.format_exc()
        }

        # Log to Sentry if available
        if sentry_dsn:
            sentry_sdk.capture_exception(e)

        # Log to console for debugging
        print(f"[ERROR] Spec-control route failed for spec_id={spec_id}")
        print(f"Error: {str(e)}")
        print(f"Traceback:\n{traceback.format_exc()}")

        return page_layout("Ошибка",
            H1("Ошибка загрузки спецификации"),
            Div(
                P(f"Произошла ошибка при загрузке спецификации ID: {spec_id}"),
                P(f"Ошибка: {str(e)}", style="font-family: monospace; font-size: 0.9rem; background: #f5f5f5; padding: 0.5rem; border-radius: 4px;"),
                P("Ошибка отправлена в систему мониторинга.", style="font-size: 0.875rem; color: #666;"),
                style="background: #fee; border: 1px solid #c33; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;"
            ),
            A("← Назад к спецификациям", href="/spec-control"),
            session=session
        )

    if not spec_result.data:
        return page_layout("Спецификация не найдена",
            H1("Спецификация не найдена"),
            P("Запрошенная спецификация не найдена или у вас нет доступа."),
            A("← Назад к спецификациям", href="/spec-control"),
            session=session
        )

    spec = spec_result.data[0]
    quote = spec.get("quotes", {}) or {}
    customer = quote.get("customers", {}) or {}
    customer_id = customer.get("id")
    customer_name = customer.get("name", "Unknown")
    customer_company = customer_name  # Fixed: removed company_name reference
    quote_id = spec.get("quote_id")
    status = spec.get("status", "draft")
    quote_workflow_status = quote.get("workflow_status", "draft")

    # TODO: seller_companies relationship not yet implemented in database
    seller_company_name = ""
    seller_company_code = ""

    # v3.0: Get linked contract info (if contract_id exists)
    contract_id = spec.get("contract_id")
    linked_contract = {}
    if contract_id:
        try:
            linked_contract_result = supabase.table("customer_contracts") \
                .select("id, contract_number, contract_date") \
                .eq("id", contract_id) \
                .limit(1) \
                .execute()
            if linked_contract_result.data:
                linked_contract = linked_contract_result.data[0]
        except Exception as e:
            print(f"[WARNING] Could not fetch linked contract {contract_id}: {e}")
            linked_contract = {}

    # Check if editable
    is_editable = status in ["draft", "pending_review"]

    # Get quote versions for version selection (use * to avoid column mismatch)
    versions_result = supabase.table("quote_versions") \
        .select("*") \
        .eq("quote_id", quote_id) \
        .order("created_at", desc=True) \
        .execute()

    versions = versions_result.data or []

    # v3.0: Get customer contracts for dropdown
    customer_contracts = []
    if customer_id:
        contracts_result = supabase.table("customer_contracts") \
            .select("id, contract_number, contract_date, next_specification_number, status") \
            .eq("customer_id", customer_id) \
            .eq("status", "active") \
            .order("contract_date", desc=True) \
            .execute()
        customer_contracts = contracts_result.data or []

    # v3.0: Get customer signatory from customer_contacts
    signatory_info = None
    if customer_id:
        signatory_result = supabase.table("customer_contacts") \
            .select("name, position") \
            .eq("customer_id", customer_id) \
            .eq("is_signatory", True) \
            .limit(1) \
            .execute()
        if signatory_result.data:
            signatory_info = signatory_result.data[0]

    # Status badge helper with design system colors
    def spec_status_badge(status):
        status_map = {
            "draft": ("Черновик", "#64748b", "#f1f5f9"),
            "pending_review": ("На проверке", "#d97706", "#fef3c7"),
            "approved": ("Утверждена", "#2563eb", "#dbeafe"),
            "signed": ("Подписана", "#16a34a", "#dcfce7"),
        }
        label, color, bg = status_map.get(status, (status, "#64748b", "#f1f5f9"))
        return Span(label, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {color}; background: {bg};")

    # Safe workflow progress bar with error handling
    try:
        progress_bar = workflow_progress_bar(quote_workflow_status)
    except Exception as e:
        print(f"[WARNING] workflow_progress_bar failed for status={quote_workflow_status}: {e}")
        progress_bar = Div()  # Empty div if workflow bar fails

    return page_layout("Редактирование спецификации",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Назад", href="/dashboard?tab=spec-control",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        Div(
                            icon("file-text", size=24, color="#6366f1"),
                            H1(f"Спецификация: {spec.get('specification_number', '-') or 'Без номера'}", style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                            style="display: flex; align-items: center; gap: 12px;"
                        ),
                        Div(spec_status_badge(status), style="margin-top: 8px;"),
                    ),
                    Div(
                        Div(
                            Span("КП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                            Div(quote.get('idn_quote', '-'), style="font-weight: 600; color: #1e293b; font-size: 14px;"),
                        ),
                        Div(
                            Span("Клиент", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                            Div(customer_name, style="font-weight: 600; color: #1e293b; font-size: 14px;"),
                        ),
                        Div(
                            Span("Сумма КП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                            Div(f"{quote.get('total_amount', 0):,.2f} {quote.get('currency', 'RUB')}", style="font-weight: 600; color: #1e293b; font-size: 14px;"),
                        ),
                        style="display: flex; gap: 24px; text-align: left;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: flex-start;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Workflow progress bar (Feature #87)
        progress_bar,

        # Warning banner if not editable
        Div(
            icon("alert-triangle", size=16, color="#d97706"), " Спецификация утверждена/подписана и не может быть отредактирована.",
            style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fde047; border-left: 4px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; font-size: 14px; color: #92400e;"
        ) if not is_editable else None,

        # Admin panel for status management (Bug #8: Allow admins to move specs between stages)
        Div(
            Div(
                icon("wrench", size=16, color="#dc2626"),
                Span("АДМИН-ПАНЕЛЬ УПРАВЛЕНИЯ СТАТУСОМ", style="font-size: 11px; font-weight: 600; color: #dc2626; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            P("Текущий статус: ", spec_status_badge(status), style="margin-bottom: 12px; font-size: 14px;"),
            P("Изменить статус на:", style="margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #374151;"),
            Div(
                # Simplified workflow: draft -> approved -> signed (no pending_review)
                Form(
                    Input(type="hidden", name="action", value="admin_change_status"),
                    Input(type="hidden", name="new_status", value="draft"),
                    btn("Черновик", variant="secondary", icon_name="file-edit", type="submit", size="sm",
                        disabled=(status == "draft")),
                    action=f"/spec-control/{spec_id}",
                    method="POST",
                    style="display: inline;"
                ),
                Form(
                    Input(type="hidden", name="action", value="admin_change_status"),
                    Input(type="hidden", name="new_status", value="approved"),
                    btn("Утверждена", variant="primary", icon_name="check", type="submit", size="sm",
                        disabled=(status == "approved")),
                    action=f"/spec-control/{spec_id}",
                    method="POST",
                    style="display: inline;"
                ),
                Form(
                    Input(type="hidden", name="action", value="admin_change_status"),
                    Input(type="hidden", name="new_status", value="signed"),
                    btn("Подписана", variant="success", icon_name="pen-tool", type="submit", size="sm",
                        disabled=(status == "signed")),
                    action=f"/spec-control/{spec_id}",
                    method="POST",
                    style="display: inline;"
                ),
                style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;"
            ),
            P(icon("alert-triangle", size=14, color="#ef4444"), " Внимание: это админ-функция для тестирования и исправления ошибок. Используйте осторожно!",
              style="margin-top: 12px; font-size: 12px; color: #ef4444; display: flex; align-items: center; gap: 6px;"),
            style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 1px solid #fca5a5; border-left: 4px solid #dc2626; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px;"
        ) if user_has_any_role(session, ["admin"]) else None,

        Form(
            # Hidden fields
            Input(type="hidden", name="spec_id", value=spec_id),

            # Section 1: Identification & Date
            Div(
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ИДЕНТИФИКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("№ Спецификации", For="specification_number", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="specification_number", id="specification_number",
                              value=spec.get("specification_number", ""),
                              placeholder="Авто при выборе договора",
                              disabled=not is_editable,
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Дата подписания", For="sign_date", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="sign_date", id="sign_date", type="date",
                              value=spec.get("sign_date", "") or "",
                              disabled=not is_editable,
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Версия КП", For="quote_version_id", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Select(
                            Option("-- Выберите версию --", value=""),
                            *[Option(
                                f"v{v.get('version_number', 0)} - {v.get('total_amount', 0):,.2f} {v.get('currency', '')} ({v.get('created_at', '')[:10]})",
                                value=v.get("id"),
                                selected=v.get("id") == spec.get("quote_version_id")
                            ) for v in versions],
                            name="quote_version_id",
                            id="quote_version_id",
                            disabled=not is_editable,
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(3, 1fr); gap: 1rem;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Section 2: Delivery Conditions
            Div(
                Div(
                    icon("truck", size=16, color="#64748b"),
                    Span("УСЛОВИЯ ПОСТАВКИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Срок поставки (дней)", For="delivery_days", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Input(name="delivery_days", id="delivery_days", type="number", min="1",
                              value=str(spec.get("delivery_days", "")) if spec.get("delivery_days") else "",
                              placeholder="Из расчёта КП",
                              disabled=not is_editable,
                              style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"),
                        cls="form-group"
                    ),
                    Div(
                        Label("Тип дней", For="delivery_days_type", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Select(
                            Option("рабочих дней", value="рабочих дней",
                                   selected=spec.get("delivery_days_type", "рабочих дней") == "рабочих дней"),
                            Option("календарных дней", value="календарных дней",
                                   selected=spec.get("delivery_days_type") == "календарных дней"),
                            name="delivery_days_type",
                            id="delivery_days_type",
                            disabled=not is_editable,
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(2, 1fr); gap: 1rem;"
                ),
                P(
                    icon("info", size=14, color="#64748b"),
                    " Остальные условия (оплата, адрес, Incoterms) берутся из КП и данных клиента",
                    style="color: #64748b; font-size: 13px; margin-top: 12px; display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: #f1f5f9; border-radius: 6px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Section 3: Contract and Signatory
            Div(
                Div(
                    icon("file-signature", size=16, color="#64748b"),
                    Span("ДОГОВОР И ПОДПИСАНТ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Договор клиента", For="contract_id", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        # Show linked contract (read-only display) or dropdown to select
                        Div(
                            P(
                                Strong(f"{linked_contract.get('contract_number', '-')}", style="color: #1e293b;"),
                                f" от {linked_contract.get('contract_date', '')[:10] if linked_contract.get('contract_date') else '-'}",
                                style="margin: 0; padding: 10px 14px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 6px; border-left: 3px solid #3b82f6; font-size: 14px;"
                            ),
                            Small(icon("check", size=12, color="#1d4ed8"), " Спецификация привязана к договору", style="color: #1d4ed8; display: flex; align-items: center; gap: 4px; margin-top: 6px; font-size: 12px;"),
                            Input(type="hidden", name="contract_id", value=contract_id or ""),
                        ) if linked_contract.get("contract_number") else Select(
                            Option("-- Без привязки к договору --", value="", selected=not contract_id),
                            *[Option(
                                f"{c.get('contract_number', '-')} от {c.get('contract_date', '')[:10] if c.get('contract_date') else '-'}",
                                value=c.get("id"),
                                selected=c.get("id") == contract_id
                            ) for c in customer_contracts],
                            name="contract_id",
                            id="contract_id",
                            disabled=not is_editable,
                            style="width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8fafc; font-size: 14px;"
                        ) if customer_contracts else Div(
                            P(icon("alert-triangle", size=14, color="#d97706"), " У клиента нет активных договоров", style="color: #d97706; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 13px;"),
                            A("Создать договор →", href=f"/customer-contracts/new?customer_id={customer_id}" if customer_id else "#",
                              style="font-size: 13px; color: #6366f1; margin-top: 4px; display: inline-block;"),
                        ),
                        cls="form-group"
                    ),
                    Div(
                        Label("Подписант со стороны клиента", style="font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px; display: block;"),
                        Div(
                            P(
                                Strong(signatory_info.get("name", ""), style="color: #1e293b;"),
                                Br() if signatory_info.get("position") else None,
                                Span(signatory_info.get("position", ""), style="color: #64748b; font-size: 13px;") if signatory_info.get("position") else None,
                                style="margin: 0; padding: 10px 14px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 6px; border-left: 3px solid #22c55e;"
                            ),
                            Small(icon("check", size=12, color="#16a34a"), " Подписант определён из контактов клиента", style="color: #16a34a; display: flex; align-items: center; gap: 4px; margin-top: 6px; font-size: 12px;"),
                        ) if signatory_info else Div(
                            P(icon("alert-triangle", size=14, color="#d97706"), " Подписант не указан в контактах клиента", style="color: #d97706; margin: 0; display: flex; align-items: center; gap: 8px; font-size: 13px;"),
                            A("Указать подписанта →", href=f"/customers/{customer_id}" if customer_id else "#",
                              style="font-size: 13px; color: #6366f1; margin-top: 4px; display: inline-block;"),
                        ),
                        cls="form-group"
                    ),
                    cls="grid",
                    style="grid-template-columns: repeat(2, 1fr); gap: 1rem;"
                ),
                style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border: 1px solid #fde047; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),

            # Action buttons (simplified workflow: draft -> approved -> signed)
            Div(
                btn("Сохранить", variant="primary", icon_name="save", type="submit", name="action", value="save",
                    disabled=not is_editable) if is_editable else None,
                btn("Утвердить", variant="success", icon_name="check", type="submit", name="action", value="approve",
                    disabled=not is_editable) if is_editable and status == "draft" else None,
                # Feature #70: PDF Preview button (opens in new tab)
                btn_link("Предпросмотр PDF", href=f"/spec-control/{spec_id}/preview-pdf", variant="ghost", icon_name="file-text", target="_blank"),
                # Contract-style specification export (direct download - no modal)
                btn_link("Экспорт PDF", href=f"/spec-control/{spec_id}/export-pdf", variant="primary", icon_name="download"),
                btn_link("DOCX (Beta)", href=f"/spec-control/{spec_id}/export-docx", variant="secondary", icon_name="file-text"),
                btn_link("Назад", href="/dashboard?tab=spec-control", variant="ghost", icon_name="arrow-left"),
                style="margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap;"
            ),

            action=f"/spec-control/{spec_id}",
            method="POST"
        ),

        # Feature #71: Section 7 - Signed Scan Upload (OUTSIDE main form - HTML doesn't support nested forms)
        # Visible when status is approved or signed
        Div(
            Div(
                icon("pen-tool", size=16, color="#64748b"),
                Span("ПОДПИСАННЫЙ СКАН", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            # Show current scan if exists
            Div(
                P(
                    icon("check-circle", size=14, color="#16a34a"), " Скан загружен: ",
                    # Strip query params (token) from display for security - only show filename
                    A(spec.get("signed_scan_url", "").split("/")[-1].split("?")[0] if spec.get("signed_scan_url") else "",
                      href=spec.get("signed_scan_url", "#"),
                      target="_blank",
                      style="color: #6366f1; font-weight: 500;"),
                    style="margin-bottom: 0; display: flex; align-items: center; gap: 6px; font-size: 14px;"
                ),
                style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 1px solid #86efac; border-left: 4px solid #22c55e; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;"
            ) if spec.get("signed_scan_url") else None,
            # Upload form (standalone - not nested)
            P(
                "Загрузите скан подписанной спецификации (PDF, JPG, PNG, до 10 МБ).",
                style="margin-bottom: 12px; color: #64748b; font-size: 13px;"
            ) if not spec.get("signed_scan_url") else P(
                "Вы можете загрузить новый скан для замены текущего.",
                style="margin-bottom: 12px; color: #64748b; font-size: 13px;"
            ),
            Form(
                Input(type="file", name="signed_scan", id="signed_scan",
                      accept=".pdf,.jpg,.jpeg,.png",
                      style="margin-bottom: 12px; font-size: 14px;"),
                btn("Загрузить скан", variant="primary", icon_name="upload", type="submit"),
                action=f"/spec-control/{spec_id}/upload-signed",
                method="POST",
                enctype="multipart/form-data"
            ),
            # Feature #72: Confirm Signature button (visible when approved + has signed scan)
            Div(
                Div(style="height: 1px; background: #e2e8f0; margin: 16px 0;"),
                P(
                    icon("file-text", size=14, color="#16a34a"), " Скан загружен. Подтвердите подпись для создания сделки.",
                    style="margin-bottom: 12px; color: #16a34a; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 8px;"
                ),
                Form(
                    btn("Подтвердить подпись и создать сделку", variant="success", icon_name="check", type="submit", full_width=True),
                    action=f"/spec-control/{spec_id}/confirm-signature",
                    method="POST"
                ),
                style="margin-top: 16px;"
            ) if status == "approved" and spec.get("signed_scan_url") else None,
            # Info for already signed specs
            Div(
                Div(style="height: 1px; background: #e2e8f0; margin: 16px 0;"),
                P(
                    icon("check-circle", size=14, color="#16a34a"), " Спецификация подписана. Сделка создана.",
                    style="margin-bottom: 0; color: #16a34a; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 8px;"
                ),
                style="margin-top: 16px;"
            ) if status == "signed" else None,
            style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if status in ["approved", "signed"] else None,

        # Transition history (Feature #88) - uses quote_id from the spec
        workflow_transition_history(quote_id) if quote_id else None,

        session=session
    )


@rt("/spec-control/{spec_id}")
def post(session, spec_id: str, action: str = "save", new_status: str = "", **kwargs):
    """
    Save specification changes or change status.

    Feature #69: Specification data entry form (save/update POST handler)
    Bug #8: Admin status override for testing and error correction

    Actions:
    - save: Save current data
    - approve: Save and change status to approved (direct from draft)
    - admin_change_status: Admin-only action to directly change status to any value
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Verify spec exists and belongs to org
    spec_result = supabase.table("specifications") \
        .select("id, status, quote_id") \
        .eq("id", spec_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not spec_result.data:
        return RedirectResponse("/spec-control", status_code=303)

    spec = spec_result.data[0]
    current_status = spec.get("status", "draft")

    # Bug #8: Admin override - allow admins to change status directly
    if action == "admin_change_status":
        if not user_has_any_role(session, ["admin"]):
            return RedirectResponse("/unauthorized", status_code=303)

        new_status = new_status or current_status
        valid_statuses = ["draft", "pending_review", "approved", "signed"]

        if new_status not in valid_statuses:
            return RedirectResponse(f"/spec-control/{spec_id}", status_code=303)

        # Update only the status
        supabase.table("specifications") \
            .update({"status": new_status}) \
            .eq("id", spec_id) \
            .execute()

        return RedirectResponse(f"/spec-control/{spec_id}", status_code=303)

    # Check if editable (for regular save/approve actions)
    if current_status not in ["draft"]:
        return RedirectResponse(f"/spec-control/{spec_id}", status_code=303)

    # Helper for safe numeric conversion
    def safe_decimal(val, default=None):
        try:
            return float(val) if val else default
        except:
            return default

    def safe_int(val, default=None):
        try:
            return int(val) if val else default
        except:
            return default

    # Determine new status based on action
    # Simplified workflow: draft -> approved (no pending_review step)
    new_status = current_status
    if action == "approve" and current_status == "draft":
        new_status = "approved"

    # Build update data
    update_data = {
        "quote_version_id": kwargs.get("quote_version_id") or None,
        "specification_number": kwargs.get("specification_number") or None,
        "proposal_idn": kwargs.get("proposal_idn") or None,
        "item_ind_sku": kwargs.get("item_ind_sku") or None,
        "sign_date": kwargs.get("sign_date") or None,
        "validity_period": kwargs.get("validity_period") or None,
        "specification_currency": kwargs.get("specification_currency") or "USD",
        "exchange_rate_to_ruble": safe_decimal(kwargs.get("exchange_rate_to_ruble")),
        "client_payment_term_after_upd": safe_int(kwargs.get("client_payment_term_after_upd")),
        "client_payment_terms": kwargs.get("client_payment_terms") or None,
        "cargo_pickup_country": kwargs.get("cargo_pickup_country") or None,
        "readiness_period": kwargs.get("readiness_period") or None,
        "goods_shipment_country": kwargs.get("goods_shipment_country") or None,
        "delivery_city_russia": kwargs.get("delivery_city_russia") or None,
        "cargo_type": kwargs.get("cargo_type") or None,
        "logistics_period": kwargs.get("logistics_period") or None,
        "delivery_days": safe_int(kwargs.get("delivery_days")),
        "delivery_days_type": kwargs.get("delivery_days_type") or "рабочих дней",
        "our_legal_entity": kwargs.get("our_legal_entity") or None,
        "client_legal_entity": kwargs.get("client_legal_entity") or None,
        "supplier_payment_country": kwargs.get("supplier_payment_country") or None,
        "status": new_status,
    }

    # Update specification
    supabase.table("specifications") \
        .update(update_data) \
        .eq("id", spec_id) \
        .execute()

    return RedirectResponse(f"/spec-control/{spec_id}", status_code=303)


# ============================================================================
# Feature #70: Specification PDF Preview
# ============================================================================

@rt("/spec-control/{spec_id}/preview-pdf")
def get(session, spec_id: str):
    """
    Preview specification PDF in browser.

    Feature #70: Preview PDF спецификации

    Uses contract-style template with fixed delivery conditions.
    Opens PDF inline in browser for preview.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check role access
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # UUID validation
    import uuid
    try:
        uuid.UUID(spec_id)
    except ValueError:
        return RedirectResponse("/spec-control", status_code=303)

    try:
        from services.contract_spec_export import generate_contract_spec_pdf

        # Generate PDF using contract-style template (no modal - uses fixed template)
        pdf_bytes, spec_number = generate_contract_spec_pdf(spec_id, org_id)

        # Clean filename for safe characters
        safe_spec_number = "".join(c if c.isalnum() or c in "-_" else "_" for c in str(spec_number))

        # Return as inline view (opens in browser)
        from starlette.responses import Response
        filename = f"Specification_{safe_spec_number}.pdf"
        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={
                "Content-Disposition": f'inline; filename="{filename}"'
            }
        )

    except ValueError as e:
        return page_layout("Ошибка",
            H1("Ошибка генерации PDF"),
            Div(
                f"Не удалось сгенерировать PDF: {str(e)}",
                cls="card",
                style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
            session=session
        )

    except Exception as e:
        print(f"Error generating specification PDF: {e}")
        import traceback
        traceback.print_exc()
        return page_layout("Ошибка",
            H1("Ошибка генерации PDF"),
            Div(
                f"Произошла ошибка при генерации PDF. Пожалуйста, попробуйте позже.",
                cls="card",
                style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            P(f"Техническая информация: {str(e)}", style="font-size: 0.8rem; color: #666;"),
            A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
            session=session
        )


# ============================================================================
# Contract-style Specification Export (Direct Download - No Modal)
# ============================================================================

@rt("/spec-control/{spec_id}/export-pdf")
def get(session, spec_id: str):
    """
    Download specification PDF.

    Uses contract-style template with fixed delivery conditions.
    All variable values are pulled from the database - no user input needed.
    Downloads PDF as attachment.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # UUID validation
    import uuid
    try:
        uuid.UUID(spec_id)
    except ValueError:
        return RedirectResponse("/spec-control", status_code=303)

    try:
        from services.contract_spec_export import generate_contract_spec_pdf

        # Generate PDF using contract-style template with fixed delivery conditions
        pdf_bytes, spec_number = generate_contract_spec_pdf(spec_id, org_id)

        safe_spec_number = "".join(c if c.isalnum() or c in "-_" else "_" for c in str(spec_number))

        from starlette.responses import Response
        return Response(
            content=pdf_bytes,
            media_type="application/pdf",
            headers={"Content-Disposition": f'attachment; filename="Specification_{safe_spec_number}.pdf"'}
        )

    except Exception as e:
        print(f"Error generating contract specification PDF: {e}")
        import traceback
        traceback.print_exc()
        return page_layout("Ошибка",
            H1("Ошибка генерации PDF"),
            Div(f"Ошибка: {str(e)}", cls="card", style="background: #fee2e2; border-left: 4px solid #dc2626;"),
            A("← Назад", href=f"/spec-control/{spec_id}"),
            session=session
        )


@rt("/spec-control/{spec_id}/export-docx")
def get(session, spec_id: str):
    """
    Download specification as DOCX (Beta).

    Uses same data as PDF export but generates editable Word document.
    Beta feature - allows users to edit the document if needed.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # UUID validation
    import uuid
    try:
        uuid.UUID(spec_id)
    except ValueError:
        return RedirectResponse("/spec-control", status_code=303)

    try:
        from services.contract_spec_docx import generate_contract_spec_docx
        from services.contract_spec_export import fetch_contract_spec_data

        # Generate DOCX
        docx_bytes = generate_contract_spec_docx(spec_id, org_id)

        # Get spec number for filename
        data = fetch_contract_spec_data(spec_id, org_id)
        spec_number = data["specification"].get("specification_number") or data["specification"].get("proposal_idn") or "spec"
        safe_spec_number = "".join(c if c.isalnum() or c in "-_" else "_" for c in str(spec_number))

        from starlette.responses import Response
        return Response(
            content=docx_bytes,
            media_type="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            headers={"Content-Disposition": f'attachment; filename="Specification_{safe_spec_number}.docx"'}
        )

    except Exception as e:
        print(f"Error generating contract specification DOCX: {e}")
        import traceback
        traceback.print_exc()
        return page_layout("Ошибка",
            H1("Ошибка генерации DOCX"),
            Div(f"Ошибка: {str(e)}", cls="card", style="background: #fee2e2; border-left: 4px solid #dc2626;"),
            A("← Назад", href=f"/spec-control/{spec_id}"),
            session=session
        )


# ============================================================================
# Feature #71: Upload signed specification scan (simplified with document_service)
# ============================================================================

@rt("/spec-control/{spec_id}/upload-signed")
async def post(session, spec_id: str, request):
    """
    Upload signed specification scan using unified document_service.

    Feature #71: Загрузка подписанного скана
    Simplified: Uses document_service for unified document storage.

    Accepts PDF, JPG, PNG files up to 50MB (document_service limit).
    Stores in unified 'kvota-documents' bucket via document_service.
    Updates specifications.signed_scan_document_id with document reference.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Verify specification exists and belongs to org
    spec_result = supabase.table("specifications") \
        .select("id, status, specification_number, quote_id") \
        .eq("id", spec_id) \
        .eq("organization_id", org_id) \
        .execute()

    if not spec_result.data:
        return RedirectResponse("/spec-control", status_code=303)

    spec = spec_result.data[0]
    status = spec.get("status", "draft")
    quote_id = spec.get("quote_id")

    # Only allow upload for approved specifications
    if status not in ["approved", "signed"]:
        return page_layout("Ошибка загрузки",
            H1("Ошибка загрузки"),
            Div(
                "Загрузка скана доступна только для утверждённых спецификаций.",
                cls="card",
                style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
            session=session
        )

    try:
        # Get the uploaded file from form data
        form = await request.form()
        signed_scan = form.get("signed_scan")

        if not signed_scan or not signed_scan.filename:
            return page_layout("Ошибка загрузки",
                H1("Файл не выбран"),
                Div(
                    "Пожалуйста, выберите файл для загрузки.",
                    cls="card",
                    style="background: #fee2e2; border-left: 4px solid #dc2626;"
                ),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        # Read file content
        file_content = await signed_scan.read()
        filename = signed_scan.filename

        # Use document_service for upload (handles validation, storage, metadata)
        doc, error = upload_document(
            organization_id=org_id,
            entity_type="specification",
            entity_id=spec_id,
            file_content=file_content,
            filename=filename,
            document_type="specification_signed_scan",
            uploaded_by=user_id,
            parent_quote_id=quote_id,  # For hierarchical aggregation
        )

        if error:
            return page_layout("Ошибка загрузки",
                H1("Ошибка загрузки файла"),
                Div(error, cls="card", style="background: #fee2e2; border-left: 4px solid #dc2626;"),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        # Update specification with document reference
        # Keep signed_scan_url for backward compatibility (generate signed URL)
        signed_url = get_download_url(doc.id, expires_in=3600*24*365)  # 1 year expiry

        supabase.table("specifications") \
            .update({
                "signed_scan_document_id": doc.id,
                "signed_scan_url": signed_url,  # Backward compatibility
                "updated_at": datetime.now().isoformat()
            }) \
            .eq("id", spec_id) \
            .execute()

        print(f"Signed scan uploaded successfully via document_service: doc_id={doc.id}")

        # Redirect back to spec page with success
        return RedirectResponse(f"/spec-control/{spec_id}?upload_success=1", status_code=303)

    except Exception as e:
        print(f"Error uploading signed scan: {e}")
        import traceback
        traceback.print_exc()

        return page_layout("Ошибка загрузки",
            H1("Ошибка загрузки файла"),
            Div(
                "Произошла ошибка при загрузке файла. Пожалуйста, попробуйте позже.",
                cls="card",
                style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            P(f"Техническая информация: {str(e)}", style="font-size: 0.8rem; color: #666;"),
            A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
            session=session
        )


# ============================================================================
# Feature #72: Confirm Signature and Create Deal
# ============================================================================

@rt("/spec-control/{spec_id}/confirm-signature")
def post(session, spec_id: str):
    """
    Confirm signature on specification and create a deal.

    Feature #72: Кнопка подтверждения подписи

    This endpoint:
    1. Validates spec is in 'approved' status and has signed_scan_url
    2. Updates specification status to 'signed'
    3. Creates a new deal record from the specification data
    4. Updates quote workflow status to 'deal_signed'
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check role (spec_controller or admin)
    if not user_has_any_role(session, ["spec_controller", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    try:
        # Fetch specification with all needed data
        spec_result = supabase.table("specifications") \
            .select("id, quote_id, organization_id, status, signed_scan_url, specification_number, sign_date, specification_currency, exchange_rate_to_ruble") \
            .eq("id", spec_id) \
            .eq("organization_id", org_id) \
            .execute()

        if not spec_result.data:
            return page_layout("Ошибка",
                H1("Спецификация не найдена"),
                Div("Спецификация не найдена или у вас нет доступа.", cls="card", style="background: #fee2e2;"),
                A("← Назад к спецификациям", href="/spec-control"),
                session=session
            )

        spec = spec_result.data[0]
        current_status = spec.get("status", "")
        signed_scan_url = spec.get("signed_scan_url", "")

        # Validate status is 'approved'
        if current_status != "approved":
            return page_layout("Ошибка статуса",
                H1("Неверный статус"),
                Div(
                    f"Подтверждение подписи возможно только для спецификаций в статусе 'Утверждена'. Текущий статус: {current_status}",
                    cls="card", style="background: #fee2e2; border-left: 4px solid #dc2626;"
                ),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        # Validate signed scan exists
        if not signed_scan_url:
            return page_layout("Ошибка",
                H1("Скан не загружен"),
                Div(
                    "Для подтверждения подписи необходимо сначала загрузить скан подписанной спецификации.",
                    cls="card", style="background: #fef3c7; border-left: 4px solid #f59e0b;"
                ),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        # Check if deal already exists for this spec
        existing_deal = supabase.table("deals") \
            .select("id, deal_number") \
            .eq("specification_id", spec_id) \
            .execute()

        if existing_deal.data:
            return page_layout("Сделка уже существует",
                H1("Сделка уже создана"),
                Div(
                    f"Для этой спецификации уже создана сделка: {existing_deal.data[0].get('deal_number', 'N/A')}",
                    cls="card", style="background: #d4edda; border-left: 4px solid #28a745;"
                ),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        # Get quote data for total amount calculation
        quote_id = spec.get("quote_id")
        quote_result = supabase.table("quotes") \
            .select("id, total_amount, customers(id, name)") \
            .eq("id", quote_id) \
            .execute()

        if not quote_result.data:
            return page_layout("Ошибка",
                H1("КП не найдено"),
                Div("Связанное КП не найдено.", cls="card", style="background: #fee2e2;"),
                A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
                session=session
            )

        quote = quote_result.data[0]
        total_amount = quote.get("total_amount") or 0

        # Generate deal number using SQL function if available, otherwise generate manually
        try:
            deal_number_result = supabase.rpc("generate_deal_number", {"org_id": org_id}).execute()
            deal_number = deal_number_result.data if deal_number_result.data else None
        except Exception:
            deal_number = None

        # Fallback: generate deal number manually
        if not deal_number:
            from datetime import datetime
            year = datetime.now().year

            # Count existing deals for this org in current year
            count_result = supabase.table("deals") \
                .select("id", count="exact") \
                .eq("organization_id", org_id) \
                .execute()

            seq_num = (count_result.count or 0) + 1
            deal_number = f"DEAL-{year}-{seq_num:04d}"

        # Get sign date (from spec or use today)
        from datetime import date
        sign_date = spec.get("sign_date") or date.today().isoformat()
        currency = spec.get("specification_currency") or "RUB"

        # Step 1: Update specification status to 'signed'
        supabase.table("specifications") \
            .update({"status": "signed"}) \
            .eq("id", spec_id) \
            .execute()

        # Step 2: Create deal record
        deal_data = {
            "specification_id": spec_id,
            "quote_id": quote_id,
            "organization_id": org_id,
            "deal_number": deal_number,
            "signed_at": sign_date,
            "total_amount": float(total_amount) if total_amount else 0.0,
            "currency": currency,
            "status": "active",
            "created_by": user_id,
        }

        deal_result = supabase.table("deals") \
            .insert(deal_data) \
            .execute()

        if not deal_result.data:
            # Rollback spec status
            supabase.table("specifications") \
                .update({"status": "approved"}) \
                .eq("id", spec_id) \
                .execute()
            raise Exception("Failed to create deal record")

        deal_id = deal_result.data[0]["id"]

        # Step 3: Update quote workflow status to deal_signed (if workflow service available)
        try:
            from services import transition_quote_status, WorkflowStatus
            # Try to transition quote to deal_signed status
            transition_result = transition_quote_status(
                quote_id=quote_id,
                to_status=WorkflowStatus.DEAL_SIGNED,
                actor_id=user_id,
                actor_roles=get_user_roles_from_session(session),
                comment=f"Сделка {deal_number} создана из спецификации",
                supabase=supabase
            )
            print(f"Quote workflow transition result: {transition_result}")
        except Exception as e:
            # Workflow transition is optional - log but don't fail
            print(f"Note: Could not transition quote workflow: {e}")

        print(f"Deal created successfully: {deal_number} (ID: {deal_id})")

        # Show success page
        return page_layout("Сделка создана",
            H1(icon("check-circle", size=28), " Сделка успешно создана", cls="page-header"),
            Div(
                H3(f"Номер сделки: {deal_number}"),
                P(f"Клиент: {quote.get('customers', {}).get('name', 'N/A') if quote.get('customers') else 'N/A'}"),
                P(f"Сумма: {total_amount:,.2f} {currency}"),
                P(f"Дата подписания: {sign_date}"),
                cls="card",
                style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem;"
            ),
            Div(
                btn_link("К спецификации", href=f"/spec-control/{spec_id}", variant="primary", icon_name="arrow-right"),
                btn_link("Назад к списку", href="/spec-control", variant="secondary", icon_name="arrow-left"),
                style="margin-top: 1rem; display: flex; gap: 0.5rem;"
            ),
            session=session
        )

    except Exception as e:
        print(f"Error confirming signature: {e}")
        import traceback
        traceback.print_exc()

        return page_layout("Ошибка",
            H1("Ошибка создания сделки"),
            Div(
                "Произошла ошибка при создании сделки. Пожалуйста, попробуйте позже.",
                cls="card", style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            P(f"Техническая информация: {str(e)}", style="font-size: 0.8rem; color: #666;"),
            A("← Назад к спецификации", href=f"/spec-control/{spec_id}"),
            session=session
        )



# ============================================================================
# DEALS (Object-oriented finance - Сделки)
# ============================================================================

@rt("/deals")
def get(session, status_filter: str = None):
    """Deals list page - shows all deals with filtering."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["finance", "admin", "top_manager"]):
        return RedirectResponse("/unauthorized", status_code=303)

    content = finance_workspace_tab(session, user, org_id, status_filter)

    # Design system header
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    return page_layout("Сделки",
        # Header card with gradient
        Div(
            Div(
                icon("briefcase", size=24, color="#475569"),
                Span(" Сделки", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            P("Активные сделки и план-факт анализ",
              style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
            style=header_card_style
        ),
        content,
        session=session,
        current_path="/deals"
    )


# ============================================================================
# PAYMENTS CALENDAR (Object-oriented finance - Календарь платежей)
# ============================================================================

@rt("/payments/calendar")
def get(session):
    """Payment calendar page."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    if not user_has_any_role(session, ["finance", "admin", "top_manager"]):
        return RedirectResponse("/unauthorized", status_code=303)

    content = finance_calendar_tab(session, user, org_id)

    # Design system header
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    return page_layout("Календарь платежей",
        # Header card with gradient
        Div(
            Div(
                icon("calendar", size=24, color="#475569"),
                Span(" Календарь платежей", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            P("Планируемые и выполненные платежи",
              style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
            style=header_card_style
        ),
        content,
        session=session,
        current_path="/payments/calendar"
    )

# ============================================================================
# FINANCE WORKSPACE (Features #77-80)
# ============================================================================

@rt("/finance")
def get(session, tab: str = "workspace", status_filter: str = None, view: str = "full", groups: str = None):
    """
    Finance page with tabs: Workspace, ERPS, Calendar

    Tabs:
    - workspace: Shows active deals and plan-fact management
    - erps: Единый реестр подписанных спецификаций (with configurable views)
    - calendar: Календарь платежей

    ERPS Views:
    - full: All 30 columns
    - compact: Key columns only (8)
    - finance: Spec + Finance + Management blocks
    - logistics: Key + Logistics + Delivery periods
    - procurement: Key + Procurement + Auto-calculated payments
    - custom: User-selected column groups
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin", "top_manager"]):
        return RedirectResponse("/unauthorized", status_code=303)

    # Tab navigation with design system styling
    tabs_style = """
        .finance-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 16px 0 16px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
            border-radius: 12px 12px 0 0;
        }
        .finance-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 500;
            text-decoration: none;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -1px;
            color: #64748b;
            background: transparent;
        }
        .finance-tab:hover {
            color: #1e293b;
            background: rgba(255,255,255,0.5);
        }
        .finance-tab.active {
            color: #1e293b;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-color: #e2e8f0;
            font-weight: 600;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
        }
    """

    tabs = Div(
        Style(tabs_style),
        Div(
            A(icon("briefcase", size=16), " Рабочая зона",
              href="/finance?tab=workspace",
              cls="finance-tab" + (" active" if tab == "workspace" else "")),
            A(icon("table", size=16), " ERPS",
              href="/finance?tab=erps",
              cls="finance-tab" + (" active" if tab == "erps" else "")),
            A(icon("calendar", size=16), " Календарь",
              href="/finance?tab=calendar",
              cls="finance-tab" + (" active" if tab == "calendar" else "")),
            cls="finance-tabs"
        )
    )

    # Render selected tab
    if tab == "erps":
        content = finance_erps_tab(session, user, org_id, view=view, custom_groups=groups)
    elif tab == "calendar":
        content = finance_calendar_tab(session, user, org_id)
    else:
        content = finance_workspace_tab(session, user, org_id, status_filter)

    # Design system header
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    return page_layout("Финансы",
        # Header card with gradient
        Div(
            Div(
                icon("wallet", size=24, color="#475569"),
                Span(" Финансы", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            P("Сделки, ERPS и календарь платежей",
              style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
            style=header_card_style
        ),
        tabs,
        content,
        session=session
    )


def finance_workspace_tab(session, user, org_id, status_filter=None):
    """Finance workspace tab - shows active deals"""
    supabase = get_supabase()

    # Get deal statistics
    stats = {
        "active": 0,
        "completed": 0,
        "cancelled": 0,
        "total": 0,
        "active_amount": 0.0,
        "completed_amount": 0.0,
    }

    try:
        # Count deals by status
        for status in ["active", "completed", "cancelled"]:
            count_result = supabase.table("deals").select("id", count="exact") \
                .eq("organization_id", org_id) \
                .eq("status", status) \
                .execute()
            stats[status] = count_result.count or 0

        stats["total"] = stats["active"] + stats["completed"] + stats["cancelled"]

        # Sum amounts for active deals
        active_result = supabase.table("deals").select("total_amount") \
            .eq("organization_id", org_id) \
            .eq("status", "active") \
            .execute()
        if active_result.data:
            stats["active_amount"] = sum(float(d.get("total_amount", 0) or 0) for d in active_result.data)

        # Sum amounts for completed deals
        completed_result = supabase.table("deals").select("total_amount") \
            .eq("organization_id", org_id) \
            .eq("status", "completed") \
            .execute()
        if completed_result.data:
            stats["completed_amount"] = sum(float(d.get("total_amount", 0) or 0) for d in completed_result.data)

    except Exception as e:
        print(f"Error getting deal stats: {e}")

    # Get deals with details based on filter
    target_status = status_filter if status_filter and status_filter != "all" else None

    try:
        query = supabase.table("deals").select(
            "id, deal_number, signed_at, total_amount, currency, status, created_at, "
            "specifications(id, specification_number, proposal_idn), "
            "quotes(id, idn_quote, customer_name, customers(name, company_name))"
        ).eq("organization_id", org_id)

        if target_status:
            query = query.eq("status", target_status)

        deals_result = query.order("signed_at", desc=True).limit(100).execute()
        deals = deals_result.data or []
    except Exception as e:
        print(f"Error getting deals: {e}")
        deals = []

    # Separate deals by status for display
    active_deals = [d for d in deals if d.get("status") == "active"]
    completed_deals = [d for d in deals if d.get("status") == "completed"]
    cancelled_deals = [d for d in deals if d.get("status") == "cancelled"]

    # Status badge helper
    def deal_status_badge(status):
        status_map = {
            "active": ("В работе", "status-success"),
            "completed": ("Завершена", "status-info"),
            "cancelled": ("Отменена", "status-error"),
        }
        label, cls_name = status_map.get(status, (status, "status-neutral"))
        return Span(label, cls=f"status-badge {cls_name}")

    # Deal row helper
    def deal_row(deal):
        spec = deal.get("specifications", {}) or {}
        quote = deal.get("quotes", {}) or {}
        customer = quote.get("customers", {}) or {}
        customer_name = customer.get("company_name") or customer.get("name") or quote.get("customer_name", "Неизвестно")

        # Format amount
        amount = float(deal.get("total_amount", 0) or 0)
        currency = deal.get("currency", "RUB")
        amount_str = f"{amount:,.2f} {currency}"

        # Format date
        signed_at = deal.get("signed_at", "")[:10] if deal.get("signed_at") else "-"

        return Tr(
            Td(A(deal.get("deal_number", "-"), href=f"/finance/{deal['id']}", style="color: var(--accent); font-weight: 500;")),
            Td(spec.get("specification_number", "-") or spec.get("proposal_idn", "-")),
            Td(customer_name),
            Td(amount_str, cls="col-money"),
            Td(signed_at),
            Td(deal_status_badge(deal.get("status", "active"))),
            Td(
                A(icon("eye", size=16), href=f"/finance/{deal['id']}", title="Подробнее", cls="table-action-btn"),
                cls="col-actions"
            ),
            cls="clickable-row"
        )

    # Build deals table
    def deals_table(deals_list, title, status_color):
        if not deals_list:
            return Div(
                H4(f"{title} (0)", style=f"color: {status_color}; margin-bottom: 0.5rem;"),
                P("Нет сделок", style="color: #666; font-style: italic;"),
                style="margin-bottom: 1.5rem;"
            )

        return Div(
            H4(f"{title} ({len(deals_list)})", style=f"color: {status_color}; margin-bottom: 0.75rem;"),
            Div(
                Div(
                    Table(
                        Thead(
                            Tr(
                                Th("№ СДЕЛКИ"),
                                Th("№ СПЕЦИФИКАЦИИ"),
                                Th("КЛИЕНТ"),
                                Th("СУММА", cls="col-money"),
                                Th("ДАТА"),
                                Th("СТАТУС"),
                                Th("", cls="col-actions"),
                            )
                        ),
                        Tbody(*[deal_row(d) for d in deals_list]),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                cls="table-container", style="margin: 0; margin-bottom: 1.5rem;"
            )
        )

    # Build filter buttons
    filter_buttons = Div(
        btn_link("Все", href="/finance", variant="primary" if not status_filter or status_filter == "all" else "secondary"),
        btn_link("В работе", href="/finance?status_filter=active", variant="success" if status_filter == "active" else "secondary"),
        btn_link("Завершённые", href="/finance?status_filter=completed", variant="primary" if status_filter == "completed" else "secondary"),
        btn_link("Отменённые", href="/finance?status_filter=cancelled", variant="danger" if status_filter == "cancelled" else "secondary"),
        style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem;"
    )

    # Show appropriate table based on filter
    if status_filter == "active":
        deals_section = deals_table(active_deals, "Сделки в работе", "#10b981")
    elif status_filter == "completed":
        deals_section = deals_table(completed_deals, "Завершённые сделки", "#3b82f6")
    elif status_filter == "cancelled":
        deals_section = deals_table(cancelled_deals, "Отменённые сделки", "#ef4444")
    else:
        # Show all (active first, then completed, then cancelled)
        deals_section = Div(
            deals_table(active_deals, "Сделки в работе", "#10b981") if active_deals else "",
            deals_table(completed_deals, "Завершённые сделки", "#3b82f6") if completed_deals else "",
            deals_table(cancelled_deals, "Отменённые сделки", "#ef4444") if cancelled_deals else "",
        )

    return Div(
        H2("Финансовый менеджер", style="margin-bottom: 1.5rem;"),

        # Stats cards
        Div(
            Div(
                Div(str(stats["active"]), cls="stat-value", style="color: #10b981;"),
                Div("В работе", style="font-size: 0.875rem;"),
                Div(f"{stats['active_amount']:,.0f} ₽", style="font-size: 0.75rem; color: #666;"),
                cls="stat-card",
                style="border-left: 4px solid #10b981;" if stats["active"] > 0 else ""
            ),
            Div(
                Div(str(stats["completed"]), cls="stat-value", style="color: #3b82f6;"),
                Div("Завершено", style="font-size: 0.875rem;"),
                Div(f"{stats['completed_amount']:,.0f} ₽", style="font-size: 0.75rem; color: #666;"),
                cls="stat-card"
            ),
            Div(
                Div(str(stats["cancelled"]), cls="stat-value", style="color: #ef4444;"),
                Div("Отменено", style="font-size: 0.875rem;"),
                cls="stat-card"
            ),
            Div(
                Div(str(stats["total"]), cls="stat-value", style="color: #6b7280;"),
                Div("Всего сделок", style="font-size: 0.875rem;"),
                Div(f"{stats['active_amount'] + stats['completed_amount']:,.0f} ₽", style="font-size: 0.75rem; color: #666;"),
                cls="stat-card"
            ),
            cls="stats-grid",
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;"
        ),

        # Filter buttons
        filter_buttons,

        # Deals section
        deals_section
    )


# ERPS Column definitions by group
ERPS_COLUMN_GROUPS = {
    'spec': {
        'label': 'Спецификация',
        'color': '#fef3c7',
        'columns': [
            # IDN and Client are sticky - always visible, handled separately
            ('sign_date', 'Дата подписания', 'date', None),
            ('deal_type', 'Тип сделки', 'text', None),
            ('payment_terms', 'Условия оплаты', 'text', None),
            ('advance_percent', 'Аванс %', 'percent', None),
            ('payment_deferral_days', 'Отсрочка, дни', 'text', None),
            ('spec_sum_usd', 'Сумма спец. USD', 'money', 'text-align: right; font-weight: 500;'),
            ('spec_profit_usd', 'Профит USD', 'money', 'text-align: right; color: #059669; font-weight: 500;'),
            ('delivery_deadline', 'Крайний срок поставки', 'date', None),
            ('advance_payment_deadline', 'Крайний срок оплаты аванса', 'date', None),
        ]
    },
    'auto': {
        'label': 'Авто-расчетные',
        'color': '#e9d5ff',
        'columns': [
            ('days_until_advance', 'Остаток дней до аванса', 'number', 'text-align: right;'),
            ('planned_advance_usd', 'Планируемая сумма аванса USD', 'money', 'text-align: right;'),
            ('total_paid_usd', 'Всего оплачено USD', 'money', 'text-align: right;'),
            ('remaining_payment_usd', 'Остаток к оплате USD', 'money', 'text-align: right; color: #dc2626;'),
            ('remaining_payment_percent', 'Остаток %', 'percent', 'text-align: right;'),
            ('delivery_period_calendar_days', 'Срок поставки, к.д.', 'number', 'text-align: right;'),
            ('delivery_period_working_days', 'Срок поставки, р.д.', 'number', 'text-align: right;'),
        ]
    },
    'finance': {
        'label': 'Финансы',
        'color': '#fecdd3',
        'columns': [
            ('advance_payment_date', 'Дата оплаты аванса', 'date', None),
            ('last_payment_date', 'Дата последней оплаты', 'date', None),
            ('comment', 'Комментарий', 'text', 'max-width: 200px; overflow: hidden; text-overflow: ellipsis;'),
        ]
    },
    'procurement': {
        'label': 'Закупки',
        'color': '#bfdbfe',
        'columns': [
            ('supplier_payment_date', 'Дата оплаты поставщику', 'date', None),
            ('total_spent_usd', 'Всего потрачено USD', 'money', 'text-align: right;'),
        ]
    },
    'logistics': {
        'label': 'Логистика',
        'color': '#ddd6fe',
        'columns': [
            ('planned_delivery_date', 'Планируемая дата доставки', 'date', None),
            ('actual_delivery_date', 'Фактическая дата доставки', 'date', None),
            ('planned_dovoz_date', 'Планируемая дата довоза', 'date', None),
        ]
    },
    'management': {
        'label': 'Руководство',
        'color': '#fecdd3',
        'columns': [
            ('priority_tag', 'Тег приоритетности', 'priority', None),
            ('actual_profit_usd', 'Фактический профит USD', 'money', 'text-align: right; color: #059669; font-weight: 500;'),
        ]
    },
    'system': {
        'label': 'Системные',
        'color': '#e5e7eb',
        'columns': [
            ('created_at', 'Дата создания', 'date', None),
            ('updated_at', 'Дата изменения', 'date', None),
        ]
    },
}

# Predefined views with groups to show
ERPS_VIEWS = {
    'full': ['spec', 'auto', 'finance', 'procurement', 'logistics', 'management', 'system'],
    'compact': ['spec'],  # Will be further filtered to key columns only
    'finance': ['spec', 'finance', 'management'],
    'logistics': ['spec', 'auto', 'logistics'],
    'procurement': ['spec', 'auto', 'procurement'],
}

# Compact view shows only these specific columns from spec group
ERPS_COMPACT_COLUMNS = ['sign_date', 'spec_sum_usd', 'spec_profit_usd', 'total_paid_usd', 'remaining_payment_usd', 'priority_tag']


def finance_erps_tab(session, user, org_id, view: str = "full", custom_groups: str = None):
    """ERPS tab - Единый реестр подписанных спецификаций with configurable views"""
    supabase = get_supabase()

    # Fetch data from erps_registry view
    try:
        result = supabase.from_("erps_registry").select("*").execute()
        specs = result.data or []
    except Exception as e:
        print(f"Error fetching ERPS data: {e}")
        specs = []

    # Helper formatters
    def fmt_money(value):
        if value is None:
            return "-"
        return f"${value:,.2f}"

    def fmt_date(value):
        if not value:
            return "-"
        return str(value)[:10] if isinstance(value, str) else str(value)

    def fmt_percent(value):
        if value is None:
            return "-"
        return f"{value:.1f}%"

    def fmt_priority(value):
        if not value:
            return "-"
        labels = {'important': 'Важно', 'normal': 'Обычно', 'problem': 'Проблема'}
        return labels.get(value, value)

    def format_value(value, fmt_type):
        if fmt_type == 'money':
            return fmt_money(value)
        elif fmt_type == 'date':
            return fmt_date(value)
        elif fmt_type == 'percent':
            return fmt_percent(value)
        elif fmt_type == 'priority':
            return fmt_priority(value)
        elif fmt_type == 'number':
            return str(value) if value is not None else '-'
        else:
            return str(value) if value else '-'

    # Determine which groups to show
    if view == 'custom' and custom_groups:
        import json
        try:
            visible_groups = json.loads(custom_groups)
            active_groups = [g for g, enabled in visible_groups.items() if enabled]
        except:
            active_groups = list(ERPS_COLUMN_GROUPS.keys())
    elif view == 'compact':
        # Compact view iterates ALL groups but filters to specific columns
        active_groups = list(ERPS_COLUMN_GROUPS.keys())
    elif view in ERPS_VIEWS:
        active_groups = ERPS_VIEWS[view]
    else:
        active_groups = ERPS_VIEWS['full']

    # Build column list based on view
    columns = []
    for group_key in active_groups:
        if group_key not in ERPS_COLUMN_GROUPS:
            continue
        group = ERPS_COLUMN_GROUPS[group_key]
        group_color = group['color']
        group_columns_filtered = []
        for col_key, col_label, col_type, col_style in group['columns']:
            # For compact view, only show specific columns
            if view == 'compact' and col_key not in ERPS_COMPACT_COLUMNS:
                continue
            group_columns_filtered.append({
                'key': col_key,
                'label': col_label,
                'type': col_type,
                'style': col_style,
                'color': group_color,
                'group': group_key,
                'is_last_in_group': False
            })
        # Mark the last column of this group
        if group_columns_filtered:
            group_columns_filtered[-1]['is_last_in_group'] = True
            columns.extend(group_columns_filtered)

    # CSS for sticky columns and view selector
    erps_css = """
        .erps-table-container {
            overflow-x: auto;
            max-width: 100%;
            position: relative;
        }
        .erps-table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.72rem;
        }
        /* All columns fixed width */
        .erps-table th, .erps-table td {
            padding: 0.3rem 0.4rem;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #f0f0f0;
            text-align: center;
            width: 75px;
            min-width: 75px;
            max-width: 75px;
            box-sizing: border-box;
        }
        /* Vertical headers */
        .erps-table th {
            font-weight: 600;
            height: 130px;
            vertical-align: bottom;
            padding-bottom: 8px;
            position: relative;
        }
        .erps-table th .th-text {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            display: inline-block;
            white-space: nowrap;
            font-size: 0.68rem;
            letter-spacing: -0.02em;
            max-height: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Data cells styling */
        .erps-table td {
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Money columns - right align, bold */
        .erps-table td.col-money {
            text-align: right;
            font-weight: 500;
        }
        /* Percent columns */
        .erps-table td.col-percent {
            text-align: right;
        }
        /* Date columns - smaller font */
        .erps-table td.col-date {
            font-size: 0.65rem;
        }
        /* Number columns */
        .erps-table td.col-number {
            text-align: right;
        }
        /* Row hover */
        .erps-table tbody tr:hover td {
            background-color: #f0f9ff !important;
        }
        /* Sticky columns: IDN */
        .erps-table th.sticky-idn,
        .erps-table td.sticky-idn {
            position: sticky !important;
            left: 0 !important;
            z-index: 20 !important;
            background: #fef3c7 !important;
            width: 85px;
            min-width: 85px;
            max-width: 85px;
            text-align: left;
            font-weight: 600;
            box-shadow: 2px 0 4px -2px rgba(0,0,0,0.15);
        }
        .erps-table th.sticky-idn {
            vertical-align: middle;
            height: auto;
            padding: 0.5rem;
        }
        .erps-table th.sticky-idn .th-text {
            writing-mode: horizontal-tb;
            transform: none;
        }
        /* Sticky columns: Client */
        .erps-table th.sticky-client,
        .erps-table td.sticky-client {
            position: sticky !important;
            left: 85px !important;
            z-index: 20 !important;
            background: #fffbeb !important;
            width: 110px;
            min-width: 110px;
            max-width: 110px;
            text-align: left;
            border-right: 2px solid #d97706;
            box-shadow: 4px 0 6px -2px rgba(0,0,0,0.2);
        }
        .erps-table th.sticky-client {
            vertical-align: middle;
            height: auto;
            padding: 0.5rem;
        }
        .erps-table th.sticky-client .th-text {
            writing-mode: horizontal-tb;
            transform: none;
        }
        .erps-table th.sticky-idn,
        .erps-table th.sticky-client {
            z-index: 25 !important;
        }
        /* View selector styles */
        .view-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            text-decoration: none;
            color: #374151;
            font-size: 0.875rem;
            background: white;
            transition: all 0.15s;
        }
        .view-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .view-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .group-toggles {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .group-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .group-toggle input {
            margin: 0;
        }
        /* Block dividers - thick border at end of each column group */
        .erps-table th.block-end,
        .erps-table td.block-end {
            border-right: 2px solid #9ca3af !important;
        }
    """

    # View selector buttons
    view_labels = [
        ('full', 'Полный'),
        ('compact', 'Компактный'),
        ('finance', 'Финансы'),
        ('logistics', 'Логистика'),
        ('procurement', 'Закупки'),
        ('custom', 'Кастомный'),
    ]

    view_buttons = [
        A(label,
          href=f"/finance?tab=erps&view={key}",
          cls="view-btn" + (" active" if view == key else ""))
        for key, label in view_labels
    ]

    # Group toggles for custom view (shown only when custom is selected)
    group_toggles = None
    if view == 'custom':
        # Parse current custom groups or default to all enabled
        import json
        try:
            current_groups = json.loads(custom_groups) if custom_groups else {}
        except:
            current_groups = {}

        # Default all groups to enabled if not specified
        for gk in ERPS_COLUMN_GROUPS.keys():
            if gk not in current_groups:
                current_groups[gk] = True

        toggle_items = []
        for group_key, group_data in ERPS_COLUMN_GROUPS.items():
            is_checked = current_groups.get(group_key, True)
            toggle_items.append(
                Label(
                    Input(
                        type="checkbox",
                        checked=is_checked,
                        data_group=group_key,
                        cls="group-checkbox"
                    ),
                    f" {group_data['label']}",
                    cls="group-toggle",
                    style=f"background: {group_data['color']};"
                )
            )

        group_toggles = Div(
            Span("Показать блоки:", style="font-weight: 500; margin-right: 0.5rem;"),
            *toggle_items,
            cls="group-toggles",
            id="group-toggles"
        )

    # JavaScript for custom view toggling
    custom_js = Script("""
        document.addEventListener('DOMContentLoaded', function() {
            // Handle group checkbox changes
            document.querySelectorAll('.group-checkbox').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    updateCustomView();
                });
            });
        });

        function updateCustomView() {
            const groups = {};
            document.querySelectorAll('.group-checkbox').forEach(function(checkbox) {
                groups[checkbox.dataset.group] = checkbox.checked;
            });
            // Save to localStorage
            localStorage.setItem('erps_custom_groups', JSON.stringify(groups));
            // Reload with new groups
            window.location.href = '/finance?tab=erps&view=custom&groups=' + encodeURIComponent(JSON.stringify(groups));
        }

        // On page load, check if we should apply saved custom groups
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            if (view === 'custom' && !urlParams.has('groups')) {
                const savedGroups = localStorage.getItem('erps_custom_groups');
                if (savedGroups) {
                    window.location.href = '/finance?tab=erps&view=custom&groups=' + encodeURIComponent(savedGroups);
                }
            }
        })();
    """)

    # Build table headers with vertical text
    header_cells = [
        Th(Span("IDN", cls="th-text"), cls="sticky-idn", style="background: #fef3c7;"),
        Th(Span("Клиент", cls="th-text"), cls="sticky-client"),
    ]
    for col in columns:
        cell_style = f"background: {col['color']};"
        cell_cls = "block-end" if col.get('is_last_in_group') else ""
        # Wrap label in span for vertical text
        header_cells.append(Th(Span(col['label'], cls="th-text"), style=cell_style, cls=cell_cls))

    # Map column types to CSS classes
    type_to_class = {
        'money': 'col-money',
        'percent': 'col-percent',
        'date': 'col-date',
        'number': 'col-number',
    }

    # Build table rows
    rows = []
    for spec in specs:
        row_cells = [
            Td(spec.get('idn', '-'), cls="sticky-idn"),
            Td(spec.get('client_name', '-'), cls="sticky-client"),
        ]
        for col in columns:
            value = spec.get(col['key'])
            formatted = format_value(value, col['type'])
            cell_style = f"background: {col['color']};"
            cell_cls = type_to_class.get(col['type'], '')
            if col.get('is_last_in_group'):
                cell_cls = f"{cell_cls} block-end" if cell_cls else "block-end"
            row_cells.append(Td(formatted, style=cell_style, cls=cell_cls))
        rows.append(Tr(*row_cells))

    # Build table
    if specs:
        table = Table(
            Thead(Tr(*header_cells)),
            Tbody(*rows),
            cls="erps-table"
        )
    else:
        colspan = 2 + len(columns)
        table = Table(
            Thead(Tr(*header_cells)),
            Tbody(Tr(Td("Нет данных", colspan=str(colspan), style="text-align: center; padding: 2rem; color: #666;"))),
            cls="erps-table"
        )

    # Build complete UI
    return Div(
        Style(erps_css),
        custom_js,
        H2("Единый реестр подписанных спецификаций (ERPS)", style="margin-bottom: 1rem;"),

        # View selector
        Div(
            Span("Вид:", style="font-weight: 500; margin-right: 0.5rem;"),
            *view_buttons,
            cls="view-selector"
        ),

        # Group toggles (only for custom view)
        group_toggles if group_toggles else "",

        # Stats
        P(f"Всего спецификаций: {len(specs)} | Колонок: {2 + len(columns)}", style="margin-bottom: 1rem; color: #666; font-size: 0.875rem;"),

        # Table
        Div(table, cls="erps-table-container")
    )


def finance_calendar_tab(session, user, org_id):
    """Calendar tab - Календарь платежей"""
    supabase = get_supabase()

    # Fetch payment schedule
    try:
        result = supabase.table("payment_schedule") \
            .select("*, specifications(specification_number)") \
            .order("expected_payment_date") \
            .execute()
        payments = result.data or []
    except Exception as e:
        print(f"Error fetching payment schedule: {e}")
        payments = []

    # Helper to format date
    def fmt_date(value):
        if not value:
            return "-"
        return str(value)[:10] if isinstance(value, str) else str(value)

    # Helper to format money
    def fmt_money(value, currency="USD"):
        if value is None:
            return "-"
        return f"{value:,.2f} {currency}"

    # Translation maps
    variant_map = {
        "from_order_date": "от даты заказа",
        "from_agreement_date": "от даты согласования",
        "from_shipment_date": "от даты отгрузки",
        "until_shipment_date": "до даты отгрузки"
    }

    purpose_map = {
        "advance": "Аванс",
        "additional": "Доплата",
        "final": "Закрывающий"
    }

    # Build table
    table = Table(
        Thead(
            Tr(
                Th("IDN"),
                Th("№ ПЛАТЕЖА"),
                Th("СРОК ДНЕЙ", cls="col-number"),
                Th("ВАРИАНТ РАСЧЕТА"),
                Th("ОЖИДАЕМАЯ ДАТА"),
                Th("ФАКТИЧЕСКАЯ ДАТА"),
                Th("СУММА", cls="col-money"),
                Th("НАЗНАЧЕНИЕ"),
                Th("КОММЕНТАРИЙ"),
            )
        ),
        Tbody(
            *[Tr(
                Td(p.get('specifications', {}).get('specification_number', '-') if p.get('specifications') else '-'),
                Td(str(p.get('payment_number', '-'))),
                Td(str(p.get('days_term', '-')), cls="col-number"),
                Td(variant_map.get(p.get('calculation_variant', ''), p.get('calculation_variant', '-'))),
                Td(fmt_date(p.get('expected_payment_date'))),
                Td(fmt_date(p.get('actual_payment_date'))),
                Td(fmt_money(p.get('payment_amount'), p.get('payment_currency', 'USD')), cls="col-money"),
                Td(purpose_map.get(p.get('payment_purpose', ''), p.get('payment_purpose', '-'))),
                Td(p.get('comment', '-'), style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;"),
            ) for p in payments]
        ) if payments else Tbody(
            Tr(Td("Нет данных", colspan="9", style="text-align: center; padding: 2rem; color: #666;"))
        ),
        cls="unified-table"
    )

    return Div(
        Div(
            Div(
                H3("Календарь платежей", style="margin: 0;"),
                cls="table-header"
            ),
            Div(table, cls="table-responsive"),
            Div(
                Span(f"Всего записей: {len(payments)}"),
                cls="table-footer"
            ),
            cls="table-container"
        )
    )


# ============================================================================
# FINANCE DEAL DETAIL PAGE (Feature #79)
# ============================================================================

@rt("/finance/{deal_id}")
def get(session, deal_id: str):
    """
    Finance deal detail page - shows deal info and plan-fact table.

    Feature #79: Таблица план-факт по сделке

    This page shows:
    1. Deal information (number, customer, specification, dates)
    2. Plan-fact table with all payment items
    3. Summary of planned vs actual amounts
    4. Variance tracking
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch deal with related data
    try:
        deal_result = supabase.table("deals").select(
            "id, deal_number, signed_at, total_amount, currency, status, created_at, "
            "specifications(id, specification_number, proposal_idn, sign_date, validity_period, "
            "  specification_currency, exchange_rate_to_ruble, client_payment_terms, "
            "  our_legal_entity, client_legal_entity), "
            "quotes(id, idn_quote, customer_name, customers(name, company_name))"
        ).eq("id", deal_id).eq("organization_id", org_id).single().execute()

        deal = deal_result.data
        if not deal:
            return page_layout("Ошибка",
                H1("Сделка не найдена"),
                P(f"Сделка с ID {deal_id} не найдена или у вас нет доступа."),
                btn_link("Назад к списку сделок", href="/finance", variant="secondary", icon_name="arrow-left"),
                session=session
            )
    except Exception as e:
        print(f"Error fetching deal: {e}")
        return page_layout("Ошибка",
            H1("Ошибка загрузки"),
            P(f"Не удалось загрузить сделку: {str(e)}"),
            btn_link("Назад к списку сделок", href="/finance", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Fetch plan_fact_items for this deal
    try:
        plan_fact_result = supabase.table("plan_fact_items").select(
            "id, description, planned_amount, planned_currency, planned_date, "
            "actual_amount, actual_currency, actual_date, actual_exchange_rate, "
            "variance_amount, payment_document, notes, created_at, "
            "plan_fact_categories(id, code, name, is_income, sort_order)"
        ).eq("deal_id", deal_id).order("planned_date").execute()

        plan_fact_items = plan_fact_result.data or []
    except Exception as e:
        print(f"Error fetching plan_fact_items: {e}")
        plan_fact_items = []

    # Fetch all categories for reference
    try:
        categories_result = supabase.table("plan_fact_categories").select(
            "id, code, name, is_income, sort_order"
        ).order("sort_order").execute()
        categories = categories_result.data or []
    except Exception as e:
        print(f"Error fetching categories: {e}")
        categories = []

    # Extract deal info
    spec = deal.get("specifications", {}) or {}
    quote = deal.get("quotes", {}) or {}
    customer = quote.get("customers", {}) or {}
    customer_name = customer.get("company_name") or customer.get("name") or quote.get("customer_name", "Неизвестно")

    deal_number = deal.get("deal_number", "-")
    spec_number = spec.get("specification_number", "-") or spec.get("proposal_idn", "-")
    deal_amount = float(deal.get("total_amount", 0) or 0)
    deal_currency = deal.get("currency", "RUB")
    signed_at = deal.get("signed_at", "")[:10] if deal.get("signed_at") else "-"

    # Status badge
    status_map = {
        "active": ("В работе", "bg-green-200 text-green-800", "#10b981"),
        "completed": ("Завершена", "bg-blue-200 text-blue-800", "#3b82f6"),
        "cancelled": ("Отменена", "bg-red-200 text-red-800", "#ef4444"),
    }
    status = deal.get("status", "active")
    status_label, status_class, status_color = status_map.get(status, (status, "bg-gray-200 text-gray-800", "#6b7280"))
    status_badge = Span(status_label, cls=f"px-2 py-1 rounded text-sm {status_class}")

    # Calculate plan-fact summary
    total_planned_income = sum(
        float(item.get("planned_amount", 0) or 0)
        for item in plan_fact_items
        if item.get("plan_fact_categories", {}).get("is_income", False)
    )
    total_planned_expense = sum(
        float(item.get("planned_amount", 0) or 0)
        for item in plan_fact_items
        if not item.get("plan_fact_categories", {}).get("is_income", True)
    )
    total_actual_income = sum(
        float(item.get("actual_amount", 0) or 0)
        for item in plan_fact_items
        if item.get("plan_fact_categories", {}).get("is_income", False) and item.get("actual_amount") is not None
    )
    total_actual_expense = sum(
        float(item.get("actual_amount", 0) or 0)
        for item in plan_fact_items
        if not item.get("plan_fact_categories", {}).get("is_income", True) and item.get("actual_amount") is not None
    )
    total_variance = sum(
        float(item.get("variance_amount", 0) or 0)
        for item in plan_fact_items
        if item.get("variance_amount") is not None
    )

    # Count paid vs unpaid items
    paid_count = sum(1 for item in plan_fact_items if item.get("actual_amount") is not None)
    unpaid_count = len(plan_fact_items) - paid_count

    # Build plan-fact table row
    def plan_fact_row(item):
        category = item.get("plan_fact_categories", {}) or {}
        is_income = category.get("is_income", False)
        category_name = category.get("name", "Прочее")

        # Format amounts
        planned_amount = float(item.get("planned_amount", 0) or 0)
        planned_currency = item.get("planned_currency", "RUB")
        planned_str = f"{planned_amount:,.2f} {planned_currency}"

        actual_amount = item.get("actual_amount")
        actual_currency = item.get("actual_currency", "RUB")
        if actual_amount is not None:
            actual_str = f"{float(actual_amount):,.2f} {actual_currency}"
        else:
            actual_str = "—"

        variance = item.get("variance_amount")
        if variance is not None:
            variance_val = float(variance)
            if variance_val > 0:
                variance_str = f"+{variance_val:,.2f}"
                variance_color = "#ef4444" if not is_income else "#10b981"  # Red for overspend, green for extra income
            elif variance_val < 0:
                variance_str = f"{variance_val:,.2f}"
                variance_color = "#10b981" if not is_income else "#ef4444"  # Green for underspend, red for less income
            else:
                variance_str = "0.00"
                variance_color = "#6b7280"
        else:
            variance_str = "—"
            variance_color = "#6b7280"

        # Format dates
        planned_date = item.get("planned_date", "")[:10] if item.get("planned_date") else "-"
        actual_date = item.get("actual_date", "")[:10] if item.get("actual_date") else "-"

        # Payment status
        if actual_amount is not None:
            payment_status = Span(icon("check", size=14), " Оплачено", style="color: #10b981; font-weight: 500; display: inline-flex; align-items: center; gap: 0.25rem;")
        else:
            payment_status = Span("○ Ожидает", style="color: #f59e0b;")

        # Category badge color
        category_color = "#10b981" if is_income else "#6366f1"

        cell_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"
        return Tr(
            Td(
                Span(category_name, style=f"color: {category_color}; font-weight: 600; display: block;"),
                Span(item.get("description", "-") or "-", style="color: #64748b; font-size: 12px;"),
                style=cell_style
            ),
            Td(planned_date, style=cell_style),
            Td(planned_str, style=f"{cell_style} text-align: right; font-weight: 500;"),
            Td(actual_date if actual_amount is not None else "-", style=cell_style),
            Td(actual_str, style=f"{cell_style} text-align: right;"),
            Td(variance_str, style=f"{cell_style} text-align: right; color: {variance_color}; font-weight: 600;"),
            Td(payment_status, style=cell_style),
            Td(
                btn_link("Редакт.", href=f"/finance/{deal_id}/plan-fact/{item['id']}", variant="primary", size="sm") if actual_amount is None else "",
                style=cell_style
            ),
            style="transition: background-color 0.15s ease;",
            onmouseover="this.style.backgroundColor='#f8fafc'",
            onmouseout="this.style.backgroundColor='transparent'"
        )

    # Build plan-fact table with modern styling
    table_header_style = "padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; background: #f8fafc; border-bottom: 2px solid #e2e8f0;"
    table_cell_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"

    if plan_fact_items:
        plan_fact_table = Table(
            Thead(
                Tr(
                    Th("Категория / Описание", style=table_header_style),
                    Th("План. дата", style=table_header_style),
                    Th("План. сумма", style=f"{table_header_style} text-align: right;"),
                    Th("Факт. дата", style=table_header_style),
                    Th("Факт. сумма", style=f"{table_header_style} text-align: right;"),
                    Th("Отклонение", style=f"{table_header_style} text-align: right;"),
                    Th("Статус", style=table_header_style),
                    Th("", style=table_header_style),
                )
            ),
            Tbody(*[plan_fact_row(item) for item in plan_fact_items]),
            style="width: 100%; border-collapse: collapse;"
        )
    else:
        plan_fact_table = Div(
            Div(
                icon("file-plus", size=40, color="#94a3b8"),
                style="margin-bottom: 12px;"
            ),
            P("Плановые платежи ещё не созданы", style="color: #64748b; font-size: 14px; margin: 0 0 16px 0;"),
            Div(
                btn_link("Сгенерировать из КП", href=f"/finance/{deal_id}/generate-plan-fact", variant="primary", icon_name="refresh-cw"),
                btn_link("Добавить вручную", href=f"/finance/{deal_id}/plan-fact/new", variant="success", icon_name="plus"),
                style="display: flex; gap: 8px; justify-content: center;"
            ),
            style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 12px;"
        )

    return page_layout(f"Сделка {deal_number}",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                "К списку сделок",
                href="/finance",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("briefcase", size=28, color="#6366f1"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1(f"Сделка {deal_number}", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    Div(
                        Span(customer_name, style="color: #64748b; font-size: 14px; margin-right: 12px;"),
                        Span(
                            status_label,
                            style=f"display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: {status_color}20; color: {status_color};"
                        ),
                        style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;"
                    ),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Two-column grid for info cards
        Div(
            # Left column - Deal info card
            Div(
                Div(
                    icon("file-text", size=14, color="#64748b"),
                    Span("ИНФОРМАЦИЯ О СДЕЛКЕ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                ),
                Div(
                    *[Div(
                        Span(label, style="font-size: 12px; color: #64748b; display: block; margin-bottom: 2px;"),
                        Span(value, style="font-size: 14px; color: #1e293b; font-weight: 500;"),
                        style="margin-bottom: 12px;"
                    ) for label, value in [
                        ("Номер сделки", deal_number),
                        ("Спецификация", spec_number),
                        ("Клиент", customer_name),
                        ("Сумма сделки", f"{deal_amount:,.2f} {deal_currency}"),
                        ("Дата подписания", signed_at),
                        ("Условия оплаты", spec.get("client_payment_terms", "-") or "-"),
                        ("Наше юр. лицо", spec.get("our_legal_entity", "-") or "-"),
                        ("Юр. лицо клиента", spec.get("client_legal_entity", "-") or "-"),
                    ]],
                ),
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            # Right column - Plan-fact summary card
            Div(
                Div(
                    icon("bar-chart-2", size=14, color="#64748b"),
                    Span("СВОДКА ПЛАН-ФАКТ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                ),
                # Summary stats grid
                Div(
                    Div(
                        Span("Плановые поступления", style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;"),
                        Span(f"{total_planned_income:,.2f} ₽", style="font-size: 18px; font-weight: 600; color: #10b981;"),
                        style="padding: 12px; background: #f0fdf4; border-radius: 8px;"
                    ),
                    Div(
                        Span("Факт. поступления", style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;"),
                        Span(f"{total_actual_income:,.2f} ₽", style="font-size: 18px; font-weight: 600; color: #1e293b;"),
                        style="padding: 12px; background: #f8fafc; border-radius: 8px;"
                    ),
                    Div(
                        Span("Плановые расходы", style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;"),
                        Span(f"{total_planned_expense:,.2f} ₽", style="font-size: 18px; font-weight: 600; color: #6366f1;"),
                        style="padding: 12px; background: #eef2ff; border-radius: 8px;"
                    ),
                    Div(
                        Span("Факт. расходы", style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;"),
                        Span(f"{total_actual_expense:,.2f} ₽", style="font-size: 18px; font-weight: 600; color: #1e293b;"),
                        style="padding: 12px; background: #f8fafc; border-radius: 8px;"
                    ),
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;"
                ),
                # Margin and variance
                Div(
                    Div(
                        Span("Плановая маржа", style="font-size: 12px; color: #64748b;"),
                        Span(f"{total_planned_income - total_planned_expense:,.2f} ₽", style="font-size: 14px; font-weight: 600; color: #1e293b;"),
                        style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;"
                    ),
                    Div(
                        Span("Общее отклонение", style="font-size: 12px; color: #64748b;"),
                        Span(
                            f"{total_variance:+,.2f} ₽" if total_variance != 0 else "0.00 ₽",
                            style=f"font-size: 14px; font-weight: 600; color: {'#ef4444' if total_variance > 0 else '#10b981' if total_variance < 0 else '#64748b'};"
                        ),
                        style="display: flex; justify-content: space-between; padding: 8px 0;"
                    ),
                ),
                # Payment status badges
                Div(
                    Span(
                        icon("check-circle", size=14, color="#10b981"),
                        f" Оплачено: {paid_count}",
                        style="display: inline-flex; align-items: center; padding: 4px 10px; background: #f0fdf4; border-radius: 12px; font-size: 12px; color: #10b981; font-weight: 500; margin-right: 8px;"
                    ),
                    Span(
                        icon("clock", size=14, color="#f59e0b"),
                        f" Ожидает: {unpaid_count}",
                        style="display: inline-flex; align-items: center; padding: 4px 10px; background: #fef3c7; border-radius: 12px; font-size: 12px; color: #d97706; font-weight: 500;"
                    ),
                    style="margin-top: 12px;"
                ),
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;"
        ),

        # Plan-fact table section
        Div(
            # Section header
            Div(
                Div(
                    icon("list", size=14, color="#64748b"),
                    Span("ПЛАН-ФАКТ ПЛАТЕЖЕЙ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; display: flex; align-items: center;"
                ),
                Div(
                    btn_link("Добавить платёж", href=f"/finance/{deal_id}/plan-fact/new", variant="success", size="sm", icon_name="plus"),
                    btn_link("Перегенерировать", href=f"/finance/{deal_id}/generate-plan-fact", variant="secondary", size="sm", icon_name="refresh-cw"),
                    style="display: flex; gap: 8px;"
                ) if plan_fact_items else "",
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;"
            ),
            # Table container
            Div(
                plan_fact_table,
                style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="margin-bottom: 24px;"
        ),

        # Transition history (Feature #88) - uses quote_id from the deal
        workflow_transition_history(quote.get("id")) if quote.get("id") else None,

        session=session
    )


# ============================================================================
# AUTO-GENERATE PLAN-FACT ITEMS (Feature #82)
# ============================================================================

@rt("/finance/{deal_id}/generate-plan-fact")
def get(session, deal_id: str):
    """
    Preview and confirm auto-generation of plan-fact items.

    Feature #82: Автогенерация плановых платежей

    Shows a preview of what plan-fact items will be generated from deal conditions.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    from services import get_plan_fact_generation_preview

    # Get preview of what will be generated
    preview = get_plan_fact_generation_preview(deal_id)

    if preview.get('error'):
        return page_layout("Ошибка",
            H1("Ошибка генерации"),
            P(f"Не удалось подготовить предпросмотр: {preview.get('error')}"),
            btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    deal_info = preview.get('deal_info', {})
    planned_items = preview.get('planned_items', [])
    totals = preview.get('totals', {})
    existing_items = preview.get('existing_items', 0)

    # Build preview table
    preview_rows = []
    for item in planned_items:
        is_income = item.get('is_income', False)
        amount = float(item.get('amount', 0))
        category_color = "#10b981" if is_income else "#6366f1"

        preview_rows.append(Tr(
            Td(Span(item.get('category_name', '-'), style=f"color: {category_color}; font-weight: 500;")),
            Td(item.get('description', '-')),
            Td(f"{amount:,.2f} {item.get('currency', 'RUB')}", style="text-align: right; font-weight: 500;"),
            Td(item.get('date', '-')),
            Td(
                Span("Доход", style="color: #10b981;") if is_income else Span("Расход", style="color: #6366f1;")
            ),
        ))

    # Calculate totals
    total_income = sum(item.get('amount', 0) for item in planned_items if item.get('is_income'))
    total_expense = sum(item.get('amount', 0) for item in planned_items if not item.get('is_income'))
    planned_margin = total_income - total_expense

    # Warning if items exist
    existing_warning = None
    if existing_items > 0:
        existing_warning = Div(
            Strong(icon("alert-triangle", size=14), " Внимание: "),
            f"Для этой сделки уже существуют {existing_items} плановых платежей. ",
            "Генерация заменит все существующие записи.",
            style="background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #92400e;"
        )

    # Define consistent table styles
    th_style = "padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; background: #f8fafc; border-bottom: 2px solid #e2e8f0;"
    td_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"
    tfoot_style = "padding: 12px 16px; font-size: 14px; background: #f8fafc; border-top: 2px solid #e2e8f0;"

    return page_layout(f"Генерация план-факта",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                f"К сделке {deal_info.get('deal_number', '')}",
                href=f"/finance/{deal_id}",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("refresh-cw", size=28, color="#6366f1"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1("Автогенерация плановых платежей", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    P("На основе условий сделки будут созданы плановые платежи", style="margin: 0; color: #64748b; font-size: 14px;"),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Warning banner if items exist
        Div(
            Div(
                icon("alert-triangle", size=18, color="#d97706"),
                style="margin-right: 12px;"
            ),
            Div(
                Strong(f"Внимание: для этой сделки уже существуют {existing_items} плановых платежей. ", style="display: block; margin-bottom: 2px;"),
                Span("Генерация заменит все существующие записи.", style="color: #92400e; font-size: 13px;"),
            ),
            style="display: flex; align-items: flex-start; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; color: #92400e;"
        ) if existing_items > 0 else "",

        # Source data card
        Div(
            Div(
                icon("database", size=14, color="#64748b"),
                Span("ИСХОДНЫЕ ДАННЫЕ", style="margin-left: 6px;"),
                style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
            ),
            Div(
                *[Div(
                    Span(label, style="font-size: 12px; color: #64748b; display: block; margin-bottom: 2px;"),
                    Span(str(value), style="font-size: 14px; color: #1e293b; font-weight: 500;"),
                    style="padding: 10px 16px; background: #f8fafc; border-radius: 8px;"
                ) for label, value in [
                    ("Сумма сделки", f"{deal_info.get('total_amount', 0):,.2f} {deal_info.get('currency', 'RUB')}"),
                    ("Дата подписания", deal_info.get('signed_at', '-')),
                    ("Закупка (из КП)", f"{totals.get('total_purchase', 0):,.2f}"),
                    ("Логистика (из КП)", f"{totals.get('total_logistics', 0):,.2f}"),
                    ("Таможня (из КП)", f"{totals.get('total_customs', 0):,.2f}"),
                ]],
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;"
            ),
            style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; margin-bottom: 24px;"
        ),

        # Preview table section
        Div(
            Div(
                icon("list", size=14, color="#64748b"),
                Span("ПЛАНИРУЕМЫЕ ПЛАТЕЖИ", style="margin-left: 6px;"),
                style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
            ),
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("Категория", style=th_style),
                            Th("Описание", style=th_style),
                            Th("Сумма", style=f"{th_style} text-align: right;"),
                            Th("План. дата", style=th_style),
                            Th("Тип", style=th_style),
                        )
                    ),
                    Tbody(*[Tr(
                        Td(Span(item.get('category_name', '-'), style=f"color: {'#10b981' if item.get('is_income') else '#6366f1'}; font-weight: 600;"), style=td_style),
                        Td(item.get('description', '-'), style=td_style),
                        Td(f"{float(item.get('amount', 0)):,.2f} {item.get('currency', 'RUB')}", style=f"{td_style} text-align: right; font-weight: 500;"),
                        Td(item.get('date', '-'), style=td_style),
                        Td(
                            Span("Доход", style="padding: 3px 10px; background: #f0fdf4; border-radius: 12px; color: #10b981; font-size: 12px; font-weight: 500;") if item.get('is_income') else
                            Span("Расход", style="padding: 3px 10px; background: #eef2ff; border-radius: 12px; color: #6366f1; font-size: 12px; font-weight: 500;"),
                            style=td_style
                        ),
                    ) for item in planned_items]),
                    Tfoot(
                        Tr(
                            Td(Strong("Итого поступлений:"), colspan="2", style=tfoot_style),
                            Td(Strong(f"{total_income:,.2f}"), style=f"{tfoot_style} text-align: right; color: #10b981;"),
                            Td("", style=tfoot_style),
                            Td("", style=tfoot_style),
                        ),
                        Tr(
                            Td(Strong("Итого расходов:"), colspan="2", style=tfoot_style),
                            Td(Strong(f"{total_expense:,.2f}"), style=f"{tfoot_style} text-align: right; color: #6366f1;"),
                            Td("", style=tfoot_style),
                            Td("", style=tfoot_style),
                        ),
                        Tr(
                            Td(Strong("Плановая маржа:"), colspan="2", style=f"{tfoot_style} font-weight: 700;"),
                            Td(Strong(f"{planned_margin:,.2f}"), style=f"{tfoot_style} text-align: right; font-weight: 700; color: {'#10b981' if planned_margin >= 0 else '#ef4444'};"),
                            Td("", style=tfoot_style),
                            Td("", style=tfoot_style),
                        ),
                    ),
                    style="width: 100%; border-collapse: collapse;"
                ) if preview_rows else Div(
                    icon("file-x", size=40, color="#94a3b8"),
                    P("Нет данных для генерации платежей", style="color: #64748b; font-size: 14px; margin: 12px 0 0 0;"),
                    style="text-align: center; padding: 40px 20px;"
                ),
                style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="margin-bottom: 24px;"
        ),

        # Action buttons
        Form(
            Div(
                btn("Сгенерировать платежи", variant="success", icon_name="check", type="submit") if preview_rows else "",
                btn_link("Отмена", href=f"/finance/{deal_id}", variant="secondary"),
                style="display: flex; gap: 12px;"
            ),
            method="POST",
            action=f"/finance/{deal_id}/generate-plan-fact",
        ),

        session=session
    )


@rt("/finance/{deal_id}/generate-plan-fact")
def post(session, deal_id: str):
    """
    Execute auto-generation of plan-fact items.

    Feature #82: Автогенерация плановых платежей

    Creates plan_fact_items based on deal conditions (payment terms, amounts, etc.)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    from services import generate_plan_fact_from_deal, count_items_for_deal

    # Check if items already exist and replace them
    existing_count = count_items_for_deal(deal_id).get('total', 0)
    replace_existing = existing_count > 0

    # Generate plan-fact items
    result = generate_plan_fact_from_deal(
        deal_id=deal_id,
        created_by=user_id,
        replace_existing=replace_existing
    )

    if result.success:
        # Redirect back to deal page with success message
        return RedirectResponse(f"/finance/{deal_id}?generated={result.items_count}", status_code=303)
    else:
        # Show error
        return page_layout("Ошибка генерации",
            H1("Ошибка"),
            P(f"Не удалось сгенерировать плановые платежи: {result.error}"),
            btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# PAYMENT REGISTRATION FORM (Feature #80)
# ============================================================================

@rt("/finance/{deal_id}/plan-fact/{item_id}")
def get(session, deal_id: str, item_id: str):
    """
    Payment registration form - allows registering actual payment for a plan_fact_item.

    Feature #80: Форма регистрации платежа

    This form allows finance users to:
    1. View planned payment details
    2. Enter actual payment information (amount, date, currency, exchange rate)
    3. Add payment document reference and notes
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Fetch the plan_fact_item with category info
    try:
        item_result = supabase.table("plan_fact_items").select(
            "id, deal_id, category_id, description, "
            "planned_amount, planned_currency, planned_date, "
            "actual_amount, actual_currency, actual_date, actual_exchange_rate, "
            "variance_amount, payment_document, notes, created_at, "
            "plan_fact_categories(id, code, name, is_income)"
        ).eq("id", item_id).single().execute()

        item = item_result.data
        if not item:
            return page_layout("Ошибка",
                H1("Платёж не найден"),
                P(f"Запись план-факта с ID {item_id} не найдена."),
                btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
                session=session
            )
    except Exception as e:
        print(f"Error fetching plan_fact_item: {e}")
        return page_layout("Ошибка",
            H1("Ошибка загрузки"),
            P(f"Не удалось загрузить запись: {str(e)}"),
            btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Verify item belongs to the deal
    if str(item.get("deal_id")) != str(deal_id):
        return page_layout("Ошибка",
            H1("Неверный запрос"),
            P("Запись план-факта не относится к указанной сделке."),
            btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Fetch deal info for header
    try:
        deal_result = supabase.table("deals").select(
            "id, deal_number, organization_id"
        ).eq("id", deal_id).single().execute()

        deal = deal_result.data
        if not deal or str(deal.get("organization_id")) != str(org_id):
            return page_layout("Ошибка",
                H1("Сделка не найдена"),
                P("Сделка не найдена или у вас нет доступа."),
                btn_link("Назад к финансам", href="/finance", variant="secondary", icon_name="arrow-left"),
                session=session
            )
    except Exception as e:
        print(f"Error fetching deal: {e}")
        return page_layout("Ошибка",
            H1("Ошибка загрузки"),
            P(f"Не удалось загрузить сделку: {str(e)}"),
            btn_link("Назад к финансам", href="/finance", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    deal_number = deal.get("deal_number", "-")

    # Extract item info
    category = item.get("plan_fact_categories", {}) or {}
    category_name = category.get("name", "Прочее")
    is_income = category.get("is_income", False)
    description = item.get("description", "") or ""

    planned_amount = float(item.get("planned_amount", 0) or 0)
    planned_currency = item.get("planned_currency", "RUB")
    planned_date = item.get("planned_date", "")[:10] if item.get("planned_date") else ""

    # Existing actual values (for editing)
    actual_amount = item.get("actual_amount")
    actual_currency = item.get("actual_currency") or planned_currency
    actual_date = item.get("actual_date", "")[:10] if item.get("actual_date") else ""
    actual_exchange_rate = item.get("actual_exchange_rate") or ""
    payment_document = item.get("payment_document", "") or ""
    notes = item.get("notes", "") or ""

    # Status indicator
    is_paid = actual_amount is not None
    status_label = "Оплачено" if is_paid else "Ожидает оплаты"
    status_color = "#10b981" if is_paid else "#f59e0b"

    # Category badge
    category_color = "#10b981" if is_income else "#6366f1"
    category_type = "Доход" if is_income else "Расход"

    # Modern form input styles
    input_style = "width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; transition: border-color 0.15s ease, box-shadow 0.15s ease;"
    label_style = "display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;"
    select_style = "width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;"

    return page_layout(f"Регистрация платежа — {deal_number}",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                f"К сделке {deal_number}",
                href=f"/finance/{deal_id}",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("credit-card", size=28, color="#10b981"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1("Регистрация платежа", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    Div(
                        Span(category_name, style=f"color: {category_color}; font-weight: 500; margin-right: 8px;"),
                        Span(f"({category_type})", style="color: #64748b; font-size: 13px; margin-right: 12px;"),
                        Span(
                            status_label,
                            style=f"display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: {status_color}20; color: {status_color};"
                        ),
                        style="display: flex; align-items: center; flex-wrap: wrap;"
                    ),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Two-column layout
        Div(
            # Left column - Planned payment info card
            Div(
                Div(
                    icon("file-text", size=14, color="#64748b"),
                    Span("ПЛАНОВЫЕ ДАННЫЕ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                ),
                Div(
                    *[Div(
                        Span(label, style="font-size: 12px; color: #64748b; display: block; margin-bottom: 2px;"),
                        Span(value, style="font-size: 14px; color: #1e293b; font-weight: 500;"),
                        style="margin-bottom: 12px;"
                    ) for label, value in [
                        ("Категория", f"{category_name} ({category_type})"),
                        ("Описание", description or "-"),
                        ("Плановая сумма", f"{planned_amount:,.2f} {planned_currency}"),
                        ("Плановая дата", planned_date or "-"),
                    ]],
                ),
                # Help box
                Div(
                    Div(
                        icon("info", size=16, color="#d97706"),
                        style="margin-right: 10px; flex-shrink: 0;"
                    ),
                    Div(
                        Strong("Подсказка", style="display: block; font-size: 13px; margin-bottom: 4px;"),
                        Span("При сохранении система автоматически рассчитает отклонение: Факт - План", style="font-size: 12px; color: #92400e;"),
                    ),
                    style="display: flex; align-items: flex-start; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fcd34d; padding: 12px 14px; border-radius: 8px; margin-top: 16px;"
                ),
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            # Right column - Actual payment form
            Div(
                Form(
                    Div(
                        icon("check-circle", size=14, color="#64748b"),
                        Span("ФАКТИЧЕСКИЕ ДАННЫЕ", style="margin-left: 6px;"),
                        style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                    ),

                    # Hidden fields
                    Input(type="hidden", name="deal_id", value=deal_id),
                    Input(type="hidden", name="item_id", value=item_id),

                    # Actual amount
                    Div(
                        Label("Фактическая сумма *", fr="actual_amount", style=label_style),
                        Input(
                            type="number",
                            name="actual_amount",
                            id="actual_amount",
                            value=str(actual_amount) if actual_amount is not None else "",
                            step="0.01",
                            min="0",
                            required=True,
                            placeholder=f"Плановая: {planned_amount:,.2f}",
                            style=input_style
                        ),
                        style="margin-bottom: 16px;"
                    ),

                    # Currency and exchange rate row
                    Div(
                        Div(
                            Label("Валюта", fr="actual_currency", style=label_style),
                            Select(
                                Option("RUB - Рубли", value="RUB", selected=(actual_currency == "RUB")),
                                Option("USD - Доллары США", value="USD", selected=(actual_currency == "USD")),
                                Option("EUR - Евро", value="EUR", selected=(actual_currency == "EUR")),
                                Option("CNY - Юани", value="CNY", selected=(actual_currency == "CNY")),
                                name="actual_currency",
                                id="actual_currency",
                                style=select_style
                            ),
                            style="flex: 1;"
                        ),
                        Div(
                            Label("Курс к рублю", fr="actual_exchange_rate", style=label_style),
                            Input(
                                type="number",
                                name="actual_exchange_rate",
                                id="actual_exchange_rate",
                                value=str(actual_exchange_rate) if actual_exchange_rate else "",
                                step="0.0001",
                                min="0",
                                placeholder="Для валюты ≠ RUB",
                                style=input_style
                            ),
                            style="flex: 1;"
                        ),
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;"
                    ),

                    # Actual date
                    Div(
                        Label("Дата платежа *", fr="actual_date", style=label_style),
                        Input(
                            type="date",
                            name="actual_date",
                            id="actual_date",
                            value=actual_date or "",
                            required=True,
                            style=input_style
                        ),
                        style="margin-bottom: 16px;"
                    ),

                    # Payment document
                    Div(
                        Label("Номер платёжного документа", fr="payment_document", style=label_style),
                        Input(
                            type="text",
                            name="payment_document",
                            id="payment_document",
                            value=payment_document,
                            placeholder="№ п/п, номер счёта и т.д.",
                            style=input_style
                        ),
                        style="margin-bottom: 16px;"
                    ),

                    # Notes
                    Div(
                        Label("Примечания", fr="notes", style=label_style),
                        Textarea(
                            notes,
                            name="notes",
                            id="notes",
                            rows="3",
                            placeholder="Дополнительная информация о платеже...",
                            style=f"{input_style} resize: vertical; min-height: 80px;"
                        ),
                        style="margin-bottom: 20px;"
                    ),

                    # Submit buttons
                    Div(
                        btn("Сохранить платёж", variant="success", icon_name="check", type="submit"),
                        btn_link("Отмена", href=f"/finance/{deal_id}", variant="secondary"),
                        style="display: flex; gap: 12px;"
                    ),

                    action=f"/finance/{deal_id}/plan-fact/{item_id}",
                    method="POST",
                ),
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px;"
        ),

        session=session
    )


@rt("/finance/{deal_id}/plan-fact/{item_id}")
def post(session, deal_id: str, item_id: str,
         actual_amount: str = None,
         actual_currency: str = "RUB",
         actual_exchange_rate: str = None,
         actual_date: str = None,
         payment_document: str = None,
         notes: str = None):
    """
    Handle payment registration form submission.

    Feature #80: Форма регистрации платежа (POST handler)

    Updates the plan_fact_item with actual payment data.
    The database trigger automatically calculates variance.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Check if user has finance role
    if not user_has_any_role(session, ["finance", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()

    # Validate required fields
    if not actual_amount or not actual_date:
        return page_layout("Ошибка",
            H1("Ошибка валидации"),
            P("Сумма и дата платежа обязательны для заполнения."),
            btn_link("Назад к форме", href=f"/finance/{deal_id}/plan-fact/{item_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Validate the item exists and belongs to the deal in user's org
    try:
        # First verify the deal belongs to user's org
        deal_result = supabase.table("deals").select(
            "id, deal_number, organization_id"
        ).eq("id", deal_id).eq("organization_id", org_id).single().execute()

        if not deal_result.data:
            return page_layout("Ошибка",
                H1("Доступ запрещён"),
                P("Сделка не найдена или у вас нет доступа."),
                btn_link("Назад к финансам", href="/finance", variant="secondary", icon_name="arrow-left"),
                session=session
            )

        # Verify item belongs to the deal
        item_result = supabase.table("plan_fact_items").select(
            "id, deal_id"
        ).eq("id", item_id).eq("deal_id", deal_id).single().execute()

        if not item_result.data:
            return page_layout("Ошибка",
                H1("Запись не найдена"),
                P("Запись план-факта не найдена или не относится к указанной сделке."),
                btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
                session=session
            )
    except Exception as e:
        print(f"Error validating item: {e}")
        return page_layout("Ошибка",
            H1("Ошибка"),
            P(f"Не удалось проверить запись: {str(e)}"),
            btn_link("Назад к сделке", href=f"/finance/{deal_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Prepare update data
    try:
        actual_amount_val = float(actual_amount)
    except ValueError:
        return page_layout("Ошибка",
            H1("Ошибка валидации"),
            P("Некорректное значение суммы."),
            btn_link("Назад к форме", href=f"/finance/{deal_id}/plan-fact/{item_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    update_data = {
        "actual_amount": actual_amount_val,
        "actual_currency": actual_currency,
        "actual_date": actual_date,
        "payment_document": payment_document.strip() if payment_document else None,
        "notes": notes.strip() if notes else None,
    }

    # Handle exchange rate
    if actual_exchange_rate and actual_exchange_rate.strip():
        try:
            update_data["actual_exchange_rate"] = float(actual_exchange_rate)
        except ValueError:
            return page_layout("Ошибка",
                H1("Ошибка валидации"),
                P("Некорректное значение курса валюты."),
                btn_link("Назад к форме", href=f"/finance/{deal_id}/plan-fact/{item_id}", variant="secondary", icon_name="arrow-left"),
                session=session
            )
    else:
        # For RUB, set exchange rate to 1
        if actual_currency == "RUB":
            update_data["actual_exchange_rate"] = 1.0
        else:
            update_data["actual_exchange_rate"] = None

    # Update the plan_fact_item
    try:
        result = supabase.table("plan_fact_items").update(update_data).eq("id", item_id).execute()

        if not result.data:
            raise Exception("No data returned from update")

        # Redirect back to deal page with success
        return RedirectResponse(f"/finance/{deal_id}?payment_registered=1", status_code=303)

    except Exception as e:
        print(f"Error updating plan_fact_item: {e}")
        return page_layout("Ошибка",
            H1("Ошибка сохранения"),
            P(f"Не удалось сохранить платёж: {str(e)}"),
            btn_link("Назад к форме", href=f"/finance/{deal_id}/plan-fact/{item_id}", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# ADMIN: USER MANAGEMENT
# Feature #84: Страница /admin/users
# ============================================================================

@rt("/admin/users")
def get_admin_users_redirect(session):
    """Redirect old /admin/users to new /admin"""
    return RedirectResponse("/admin", status_code=303)


# ============================================================================
# COMPANIES PAGE (Юрлица) - seller + buyer companies with tabs
# ============================================================================

@rt("/companies")
def get(session, tab: str = "seller_companies"):
    """Companies page with tabs for seller and buyer companies.

    Tabs:
    - seller_companies: Seller companies (юрлица-продажи) - default
    - buyer_companies: Buyer companies (юрлица-закупки)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    # Only admins can access this page
    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = user["org_id"]

    # Tab navigation
    tabs_nav = Div(
        A("Юрлица-продажи",
          href="/companies?tab=seller_companies",
          cls=f"tab-btn {'active' if tab == 'seller_companies' else ''}"),
        A("Юрлица-закупки",
          href="/companies?tab=buyer_companies",
          cls=f"tab-btn {'active' if tab == 'buyer_companies' else ''}"),
        cls="tabs-nav"
    )

    # Build tab content based on selected tab
    if tab == "seller_companies":
        # Get all seller companies
        companies = supabase.table("seller_companies").select("*")\
            .eq("organization_id", org_id)\
            .order("name")\
            .execute()

        companies_data = companies.data if companies.data else []

        company_rows = []
        for company in companies_data:
            status_badge = Span("Активна" if company.get("is_active") else "Неактивна",
                              cls=f"status-badge {'status-approved' if company.get('is_active') else 'status-rejected'}")

            company_rows.append(
                Tr(
                    Td(Strong(company.get("name", "—"))),
                    Td(company.get("supplier_code", "—")),
                    Td(company.get("inn", "—")),
                    Td(company.get("kpp", "—")),
                    Td(company.get("country", "—")),
                    Td(status_badge),
                    Td(
                        A(icon("edit", size=14), href=f"/seller-companies/{company['id']}/edit", title="Редактировать",
                          style="margin-right: 0.5rem;"),
                        A(icon("eye", size=14), href=f"/seller-companies/{company['id']}", title="Просмотр")
                    )
                )
            )

        tab_content = Div(
            Div(
                icon("info", size=16), " Компании-продавцы — это наши юридические лица, через которые мы продаём товары клиентам. ",
                "Каждое КП привязывается к одной компании-продавцу.",
                cls="alert alert-info",
                style="margin-bottom: 1rem;"
            ),
            Div(
                btn_link("Добавить компанию-продавца", href="/seller-companies/new", variant="success", icon_name="plus"),
                style="margin-bottom: 1rem;"
            ),
            Table(
                Thead(
                    Tr(
                        Th("Название"),
                        Th("Код"),
                        Th("ИНН"),
                        Th("КПП"),
                        Th("Страна"),
                        Th("Статус"),
                        Th("Действия"),
                    )
                ),
                Tbody(*company_rows) if company_rows else Tbody(
                    Tr(Td("Компании-продавцы не найдены. ", A("Добавить первую компанию", href="/seller-companies/new"),
                           colspan="7", style="text-align: center; padding: 2rem;"))
                )
            ),
            id="tab-content"
        )

    elif tab == "buyer_companies":
        # Get all buyer companies
        companies = supabase.table("buyer_companies").select("*")\
            .eq("organization_id", org_id)\
            .order("name")\
            .execute()

        companies_data = companies.data if companies.data else []

        company_rows = []
        for company in companies_data:
            status_badge = Span("Активна" if company.get("is_active") else "Неактивна",
                              cls=f"status-badge {'status-approved' if company.get('is_active') else 'status-rejected'}")

            company_rows.append(
                Tr(
                    Td(Strong(company.get("name", "—"))),
                    Td(company.get("company_code", "—")),
                    Td(company.get("inn", "—")),
                    Td(company.get("kpp", "—")),
                    Td(company.get("country", "—")),
                    Td(status_badge),
                    Td(
                        A(icon("edit", size=14), href=f"/buyer-companies/{company['id']}/edit", title="Редактировать",
                          style="margin-right: 0.5rem;"),
                        A(icon("eye", size=14), href=f"/buyer-companies/{company['id']}", title="Просмотр")
                    )
                )
            )

        tab_content = Div(
            Div(
                icon("lightbulb", size=16), " Компании-покупатели — наши юрлица, через которые мы закупаем товар у поставщиков. ",
                "Указываются на уровне позиции КП.",
                cls="alert alert-info",
                style="margin-bottom: 1rem;"
            ),
            Div(
                btn_link("Добавить компанию-покупателя", href="/buyer-companies/new", variant="success", icon_name="plus"),
                style="margin-bottom: 1rem;"
            ),
            Table(
                Thead(
                    Tr(
                        Th("Название"),
                        Th("Код"),
                        Th("ИНН"),
                        Th("КПП"),
                        Th("Страна"),
                        Th("Статус"),
                        Th("Действия"),
                    )
                ),
                Tbody(*company_rows) if company_rows else Tbody(
                    Tr(Td("Компании-покупатели не найдены. ", A("Добавить первую компанию", href="/buyer-companies/new"),
                           colspan="7", style="text-align: center; padding: 2rem;"))
                )
            ),
            id="tab-content"
        )

    else:
        tab_content = Div("Неизвестная вкладка", id="tab-content")

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    return page_layout("Юрлица",
        # Header card with gradient
        Div(
            Div(
                icon("building", size=24, color="#475569"),
                Span(" Юрлица", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            P("Управление юридическими лицами для продаж и закупок",
              style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
            style=header_card_style
        ),

        # Tabs navigation
        tabs_nav,

        # Tab content
        tab_content,

        # Tab styles (reuse admin tab styles)
        Style("""
            .tabs-nav {
                display: flex;
                gap: 4px;
                padding: 0 4px;
                margin-bottom: 20px;
                border-bottom: 1px solid #e2e8f0;
                background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
                padding: 12px 16px 0 16px;
                border-radius: 12px 12px 0 0;
            }

            .tab-btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 18px;
                font-size: 13px;
                font-weight: 500;
                text-decoration: none;
                border-radius: 8px 8px 0 0;
                transition: all 0.2s ease;
                border: 1px solid transparent;
                border-bottom: none;
                margin-bottom: -1px;
                color: #64748b;
                background: transparent;
            }

            .tab-btn:hover {
                color: #1e293b;
                background: rgba(255,255,255,0.5);
            }

            .tab-btn.active {
                color: #1e293b;
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                border-color: #e2e8f0;
                font-weight: 600;
                box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
            }
        """),

        session=session
    )


@rt("/admin")
def get(session):
    """Admin page - user management.

    Feature #84: Страница /admin
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    # Only admins can access this page
    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = user["org_id"]

    # Get all organization members with their roles and Telegram status
    members_result = supabase.table("organization_members").select(
        "user_id, status, created_at"
    ).eq("organization_id", org_id).eq("status", "active").execute()

    members = members_result.data if members_result.data else []

    # Get all available roles for this organization (system roles + org-specific roles)
    from services.role_service import get_all_roles
    all_roles = get_all_roles(organization_id=org_id)

    # Build user data with roles
    users_data = []
    for member in members:
        member_user_id = member["user_id"]

        # Get user roles (DB uses 'slug', we call it 'code' in UI)
        user_roles_result = supabase.table("user_roles").select(
            "id, role_id, roles(slug, name)"
        ).eq("user_id", member_user_id).eq("organization_id", org_id).execute()

        member_roles = user_roles_result.data if user_roles_result.data else []
        role_codes = [r.get("roles", {}).get("slug", "") for r in member_roles if r.get("roles")]
        role_names = [r.get("roles", {}).get("name", "") for r in member_roles if r.get("roles")]

        # Get Telegram status
        tg_result = supabase.table("telegram_users").select(
            "telegram_id, telegram_username, verified_at"
        ).eq("user_id", member_user_id).limit(1).execute()

        tg_data = tg_result.data[0] if tg_result.data else None

        # Try to get email from auth.users via profiles or organization_invites
        # Since we can't directly query auth.users, use the invite email if available
        # Or show user_id shortened
        email_display = member_user_id[:8] + "..."  # Default fallback

        users_data.append({
            "user_id": member_user_id,
            "email": email_display,
            "roles": role_codes,
            "role_names": role_names,
            "telegram": tg_data,
            "joined_at": member["created_at"][:10] if member.get("created_at") else "-"
        })

    # Build users table rows
    user_rows = []
    for u in users_data:
        # Roles badges - using status-badge style
        role_badges = []
        for i, code in enumerate(u["roles"]):
            name = u["role_names"][i] if i < len(u["role_names"]) else code
            # Map roles to unified badge colors
            badge_class = {
                "admin": "status-error",
                "sales": "status-info",
                "procurement": "status-success",
                "logistics": "status-warning",
                "customs": "status-progress",
                "quote_controller": "status-new",
                "spec_controller": "status-info",
                "finance": "status-success",
                "top_manager": "status-warning"
            }.get(code, "status-neutral")
            role_badges.append(
                Span(name, cls=f"status-badge {badge_class}", style="margin-right: 4px;")
            )

        # Telegram status
        if u["telegram"] and u["telegram"].get("verified_at"):
            tg_status = Span("✓ @" + (u["telegram"].get("username") or str(u["telegram"]["telegram_id"])),
                style="color: #10b981; font-size: 0.875rem;")
        else:
            tg_status = Span("—", style="color: #9ca3af;")

        # Make roles cell clickable for inline editing
        roles_cell = Td(
            Div(
                *role_badges if role_badges else [Span("—", style="color: #9ca3af;")],
                id=f"roles-display-{u['user_id']}",
                style="cursor: pointer;",
                hx_get=f"/admin/users/{u['user_id']}/roles/edit",
                hx_target=f"#roles-cell-{u['user_id']}",
                hx_swap="innerHTML",
                title="Кликните для редактирования ролей"
            ),
            id=f"roles-cell-{u['user_id']}"
        )

        user_rows.append(Tr(
            Td(u["email"]),
            roles_cell,
            Td(tg_status),
            Td(u["joined_at"])
        ))

    users_content = Div(
        # Stats
        Div(
            Div(
                Div(str(len(users_data)), cls="stat-value", style="color: #3b82f6;"),
                Div("Всего пользователей", style="font-size: 0.875rem;"),
                cls="card", style="text-align: center; padding: 16px;"
            ),
            Div(
                Div(str(sum(1 for u in users_data if u["telegram"])), cls="stat-value", style="color: #10b981;"),
                Div("С Telegram", style="font-size: 0.875rem;"),
                cls="card", style="text-align: center; padding: 16px;"
            ),
            Div(
                Div(str(len(all_roles)), cls="stat-value", style="color: #8b7cf6;"),
                Div("Доступных ролей", style="font-size: 0.875rem;"),
                cls="card", style="text-align: center; padding: 16px;"
            ),
            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;"
        ),

        # Users table
        Div(
            Div(
                Div(H4("Пользователи организации", style="margin: 0;"), cls="table-header-left"),
                cls="table-header"
            ),
            Div(
                Table(
                    Thead(Tr(
                        Th("ФИО"),
                        Th("РОЛИ"),
                        Th("TELEGRAM"),
                        Th("ДАТА")
                    )),
                    Tbody(*user_rows) if user_rows else Tbody(Tr(Td("Нет пользователей", colspan="4", style="text-align: center; padding: 2rem; color: #9ca3af;"))),
                    cls="unified-table"
                ),
                cls="table-responsive"
            ),
            Div(Span(f"Всего: {len(users_data)} пользователей"), cls="table-footer"),
            cls="table-container", style="margin: 0;"
        ),

        # Navigation
        Div(
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            btn_link("Назначение брендов", href="/admin/brands", variant="primary", icon_name="arrow-right"),
            style="margin-top: 24px; display: flex; gap: 12px;"
        ),
    )

    # Design system styles for admin page
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    return page_layout("Пользователи",
        # Header card with gradient
        Div(
            Div(
                icon("settings", size=24, color="#475569"),
                Span(" Пользователи", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                style="display: flex; align-items: center;"
            ),
            P("Управление пользователями и ролями",
              style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
            style=header_card_style
        ),

        # Users content (no tabs needed - only users here now)
        users_content,

        session=session
    )


@rt("/admin/users/{user_id}/roles/edit")
def get(user_id: str, session):
    """Inline role editor - returns form HTML fragment for HTMX."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    roles = admin_user.get("roles", [])
    org_id = admin_user["org_id"]

    # Only admins can edit roles
    if "admin" not in roles:
        return Div("Нет прав", style="color: #ef4444;")

    supabase = get_supabase()
    from services.role_service import get_all_roles, get_user_role_codes

    # Get available roles for organization
    all_roles = get_all_roles(organization_id=org_id)

    # Get current user roles
    current_role_codes = get_user_role_codes(user_id, org_id)

    # Build checkboxes for each role
    role_checkboxes = []
    for role in all_roles:
        color = {
            "admin": "#ef4444",
            "sales": "#3b82f6",
            "procurement": "#10b981",
            "logistics": "#f59e0b",
            "customs": "#8b5cf6",
            "quote_controller": "#ec4899",
            "spec_controller": "#06b6d4",
            "finance": "#84cc16",
            "top_manager": "#f97316"
        }.get(role.code, "#6b7280")

        is_checked = role.code in current_role_codes

        role_checkboxes.append(
            Label(
                Input(
                    type="checkbox",
                    name="roles",
                    value=role.code,
                    checked=is_checked,
                    style="margin-right: 6px;"
                ),
                Span(role.name, style=f"background: {color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;"),
                style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; cursor: pointer;"
            )
        )

    # Return inline form
    return Form(
        Div(
            *role_checkboxes,
            style="display: flex; flex-direction: column; background: #f9fafb; padding: 12px; border-radius: 8px; margin: 4px 0;"
        ),
        Div(
            btn("Сохранить", variant="primary", icon_name="check", type="submit", size="sm"),
            btn("Отмена", variant="ghost", size="sm", type="button",
                hx_get=f"/admin/users/{user_id}/roles/cancel",
                hx_target=f"#roles-cell-{user_id}",
                hx_swap="innerHTML"),
            style="display: flex; gap: 8px; margin-top: 8px;"
        ),
        hx_post=f"/admin/users/{user_id}/roles/update",
        hx_target=f"#roles-cell-{user_id}",
        hx_swap="innerHTML",
        style="margin: 0;"
    )


@rt("/admin/users/{user_id}/roles/update")
def post(user_id: str, session, roles: list = []):
    """Update user roles inline - returns updated badges HTML fragment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    admin_roles = admin_user.get("roles", [])
    org_id = admin_user["org_id"]
    admin_id = admin_user["id"]

    # Only admins can edit roles
    if "admin" not in admin_roles:
        return Div("Нет прав", style="color: #ef4444;")

    from services.role_service import (
        get_user_role_codes, assign_role, remove_role,
        get_all_roles, get_role_by_code
    )

    # Get current roles
    current_roles = get_user_role_codes(user_id, org_id)

    # Convert single value to list
    if isinstance(roles, str):
        roles = [roles]

    # Determine which roles to add/remove
    roles_to_add = [r for r in roles if r not in current_roles]
    roles_to_remove = [r for r in current_roles if r not in roles]

    # Add new roles
    for role_code in roles_to_add:
        assign_role(user_id, org_id, role_code, admin_id)

    # Remove old roles
    for role_code in roles_to_remove:
        remove_role(user_id, org_id, role_code)

    # Get updated roles
    updated_role_codes = get_user_role_codes(user_id, org_id)

    # Build updated badges
    role_badges = []
    all_roles_dict = {r.code: r.name for r in get_all_roles(organization_id=org_id)}

    for code in updated_role_codes:
        name = all_roles_dict.get(code, code)
        color = {
            "admin": "#ef4444",
            "sales": "#3b82f6",
            "procurement": "#10b981",
            "logistics": "#f59e0b",
            "customs": "#8b5cf6",
            "quote_controller": "#ec4899",
            "spec_controller": "#06b6d4",
            "finance": "#84cc16",
            "top_manager": "#f97316"
        }.get(code, "#6b7280")

        role_badges.append(
            Span(name, style=f"background: {color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px;")
        )

    # Return updated display
    return Div(
        *role_badges if role_badges else [Span("—", style="color: #9ca3af;")],
        id=f"roles-display-{user_id}",
        style="cursor: pointer;",
        hx_get=f"/admin/users/{user_id}/roles/edit",
        hx_target=f"#roles-cell-{user_id}",
        hx_swap="innerHTML",
        title="Кликните для редактирования ролей"
    )


@rt("/admin/users/{user_id}/roles/cancel")
def get(user_id: str, session):
    """Cancel inline editing - returns original badges HTML fragment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    org_id = admin_user["org_id"]

    from services.role_service import get_user_role_codes, get_all_roles

    # Get current roles
    role_codes = get_user_role_codes(user_id, org_id)

    # Build badges
    role_badges = []
    all_roles_dict = {r.code: r.name for r in get_all_roles(organization_id=org_id)}

    for code in role_codes:
        name = all_roles_dict.get(code, code)
        color = {
            "admin": "#ef4444",
            "sales": "#3b82f6",
            "procurement": "#10b981",
            "logistics": "#f59e0b",
            "customs": "#8b5cf6",
            "quote_controller": "#ec4899",
            "spec_controller": "#06b6d4",
            "finance": "#84cc16",
            "top_manager": "#f97316"
        }.get(code, "#6b7280")

        role_badges.append(
            Span(name, style=f"background: {color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px;")
        )

    # Return original display
    return Div(
        *role_badges if role_badges else [Span("—", style="color: #9ca3af;")],
        id=f"roles-display-{user_id}",
        style="cursor: pointer;",
        hx_get=f"/admin/users/{user_id}/roles/edit",
        hx_target=f"#roles-cell-{user_id}",
        hx_swap="innerHTML",
        title="Кликните для редактирования ролей"
    )


@rt("/admin/users/{user_id}/roles")
def get(user_id: str, session):
    """Page to manage roles for a specific user.

    Shows all available roles and allows admin to toggle them on/off.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    roles = admin_user.get("roles", [])

    # Only admins can access this page
    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = admin_user["org_id"]

    # Get all available roles
    from services.role_service import get_all_roles, get_user_role_codes
    all_roles = get_all_roles()

    # Get current user roles
    current_roles = get_user_role_codes(user_id, org_id)

    # Build role checkboxes with modern card styling
    role_inputs = []
    for r in all_roles:
        checked = r.code in current_roles
        color = {
            "admin": "#ef4444",
            "sales": "#3b82f6",
            "procurement": "#10b981",
            "logistics": "#f59e0b",
            "customs": "#8b5cf6",
            "quote_controller": "#ec4899",
            "spec_controller": "#06b6d4",
            "finance": "#84cc16",
            "top_manager": "#f97316"
        }.get(r.code, "#6b7280")

        card_bg = f"{color}10" if checked else "#f8fafc"
        card_border = color if checked else "#e2e8f0"

        role_inputs.append(
            Label(
                Div(
                    Div(
                        Input(type="checkbox", name="roles", value=r.code, checked=checked, style="width: 16px; height: 16px; accent-color: " + color + ";"),
                        style="margin-right: 12px; display: flex; align-items: center;"
                    ),
                    Div(
                        Div(
                            Span(r.name, style=f"color: {color}; font-weight: 600; font-size: 14px;"),
                            Span(f" ({r.code})", style="color: #94a3b8; font-size: 12px; margin-left: 4px;"),
                        ),
                        Span(r.description or "", style="color: #64748b; font-size: 12px; display: block; margin-top: 2px;") if r.description else None,
                        style="flex: 1;"
                    ),
                    style="display: flex; align-items: flex-start;"
                ),
                style=f"display: block; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: {card_bg}; border: 1px solid {card_border}; transition: all 0.15s ease;"
            )
        )

    return page_layout(f"Управление ролями",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                "К списку пользователей",
                href="/admin",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("shield", size=28, color="#6366f1"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1("Управление ролями", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    Span(f"ID: {user_id[:8]}...", style="color: #64748b; font-size: 13px;"),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Two-column layout
        Div(
            # Left column - Current roles
            Div(
                Div(
                    icon("user-check", size=14, color="#64748b"),
                    Span("ТЕКУЩИЕ РОЛИ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                ),
                Div(
                    *[Span(code, style="display: inline-block; background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; margin: 0 6px 6px 0;") for code in current_roles]
                    if current_roles else [Span("Нет назначенных ролей", style="color: #94a3b8; font-size: 14px;")]
                ),
                Div(
                    Span(f"{len(current_roles)} ", style="font-weight: 600; color: #1e293b;"),
                    Span("из ", style="color: #64748b;"),
                    Span(f"{len(all_roles)} ", style="font-weight: 600; color: #1e293b;"),
                    Span("ролей назначено", style="color: #64748b;"),
                    style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; font-size: 13px;"
                ),
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            # Right column - Role selection form
            Form(
                Div(
                    icon("settings", size=14, color="#64748b"),
                    Span("ВЫБОР РОЛЕЙ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
                ),
                Div(
                    *role_inputs,
                    style="max-height: 400px; overflow-y: auto; padding-right: 8px;"
                ),
                Input(type="hidden", name="user_id", value=user_id),
                Div(
                    btn("Сохранить роли", variant="primary", icon_name="check", type="submit"),
                    style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0;"
                ),
                method="POST",
                action=f"/admin/users/{user_id}/roles",
                style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;"
        ),

        session=session
    )


@rt("/admin/users/{user_id}/roles")
def post(user_id: str, session, roles: list = None):
    """Handle role updates for a user.

    Compares submitted roles with current roles and adds/removes as needed.
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    admin_roles = admin_user.get("roles", [])

    # Only admins can access this page
    if "admin" not in admin_roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    org_id = admin_user["org_id"]
    admin_id = admin_user["id"]

    # Handle empty roles list (none selected)
    if roles is None:
        roles = []
    elif isinstance(roles, str):
        roles = [roles]

    # Get current user roles
    from services.role_service import get_user_role_codes, assign_role, remove_role
    current_roles = get_user_role_codes(user_id, org_id)

    submitted_roles = set(roles)
    current_roles_set = set(current_roles)

    # Roles to add
    to_add = submitted_roles - current_roles_set
    for role_code in to_add:
        result = assign_role(user_id, org_id, role_code, admin_id)
        if result:
            print(f"Added role {role_code} to user {user_id}")

    # Roles to remove
    to_remove = current_roles_set - submitted_roles
    for role_code in to_remove:
        result = remove_role(user_id, org_id, role_code)
        if result:
            print(f"Removed role {role_code} from user {user_id}")

    # Success message
    return page_layout("Роли обновлены",
        H1("✓ Роли обновлены"),
        P(f"Пользователь: {user_id[:8]}..."),
        P(f"Добавлено ролей: {len(to_add)}" if to_add else ""),
        P(f"Удалено ролей: {len(to_remove)}" if to_remove else ""),
        Div(
            H4("Текущие роли:", style="margin-bottom: 8px;"),
            Div(
                *[Span(code, style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.875rem; margin-right: 4px;") for code in sorted(submitted_roles)]
                if submitted_roles else [Span("Нет ролей", style="color: #9ca3af;")]
            ),
            style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-top: 16px;"
        ),
        Div(
            btn_link("Назад к списку", href="/admin/users", variant="secondary", icon_name="arrow-left"),
            style="margin-top: 24px;"
        ),
        session=session
    )


# ============================================================================
# ADMIN: BRAND MANAGEMENT
# Feature #85: Страница /admin/brands
# ============================================================================

@rt("/admin/brands")
def get(session):
    """Admin page for brand assignments.

    Feature #85: Страница /admin/brands

    This page allows admins to:
    - View all brand assignments (brand → procurement manager)
    - Import new brands from existing quotes
    - Assign/reassign brands to procurement managers
    - Delete brand assignments
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    # Only admins can access this page
    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = user["org_id"]

    # Import brand service functions
    from services.brand_service import (
        get_all_brand_assignments,
        get_unique_brands_in_org,
        count_assignments_by_user
    )

    # Get all current brand assignments
    assignments = get_all_brand_assignments(org_id)

    # Get unique brands from quote_items in this organization
    # This is for "import from quotes" functionality
    quote_items_result = supabase.table("quote_items").select(
        "brand, quotes!inner(organization_id)"
    ).eq("quotes.organization_id", org_id).execute()

    all_quote_brands = set()
    for item in (quote_items_result.data or []):
        if item.get("brand"):
            all_quote_brands.add(item["brand"])

    # Get already assigned brands
    assigned_brands = set(a.brand.lower() for a in assignments)

    # Find unassigned brands
    unassigned_brands = [b for b in sorted(all_quote_brands) if b.lower() not in assigned_brands]

    # Get procurement users for assignments
    from services.role_service import get_user_role_codes

    # Get all active organization members
    members_result = supabase.table("organization_members").select(
        "user_id"
    ).eq("organization_id", org_id).eq("status", "active").execute()

    # Filter to only users who have the procurement role
    procurement_users = []
    for member in (members_result.data or []):
        user_id = member["user_id"]
        user_roles = get_user_role_codes(user_id, org_id)
        if "procurement" in user_roles:
            procurement_users.append(user_id)

    # Get assignment counts per user
    assignment_counts = count_assignments_by_user(org_id)

    # Build assignment table rows
    assignment_rows = []
    for a in assignments:
        # Get user display (shortened ID)
        user_display = a.user_id[:8] + "..."
        brand_count = assignment_counts.get(a.user_id, 0)

        assignment_rows.append(Tr(
            Td(Span(a.brand, style="font-weight: 600;")),
            Td(user_display),
            Td(str(brand_count)),
            Td(a.created_at.strftime("%Y-%m-%d") if a.created_at else "-"),
            Td(
                Div(
                    btn_link("Изменить", href=f"/admin/brands/{a.id}/edit", variant="secondary", size="sm"),
                    Form(
                        btn("Удалить", variant="danger", size="sm", type="submit"),
                        method="POST",
                        action=f"/admin/brands/{a.id}/delete",
                        style="display: inline;"
                    ),
                    style="display: flex; align-items: center; gap: 0.5rem;"
                )
            )
        ))

    # Build unassigned brands list with modern styling
    unassigned_items = []
    for brand in unassigned_brands:
        unassigned_items.append(
            Div(
                Span(brand, style="font-weight: 600; color: #1e293b; margin-right: 12px;"),
                btn_link("Назначить", href=f"/admin/brands/new?brand={brand}", variant="secondary", size="sm"),
                style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; margin-bottom: 6px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;"
            )
        )

    # Table styles
    th_style = "padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; background: #f8fafc; border-bottom: 2px solid #e2e8f0;"
    td_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"

    return page_layout("Управление брендами",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                "К администрированию",
                href="/admin",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content with action button
            Div(
                Div(
                    Div(
                        icon("tag", size=28, color="#8b5cf6"),
                        style="width: 48px; height: 48px; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                    ),
                    Div(
                        H1("Управление брендами", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        P("Назначение брендов менеджерам по закупкам", style="margin: 0; color: #64748b; font-size: 14px;"),
                        style="flex: 1;"
                    ),
                    style="display: flex; align-items: center; flex: 1;"
                ),
                btn_link("Добавить назначение", href="/admin/brands/new", variant="success", icon_name="plus"),
                style="display: flex; align-items: center; justify-content: space-between;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Stats grid
        Div(
            Div(
                Span(str(len(assignments)), style="font-size: 28px; font-weight: 700; color: #10b981; display: block;"),
                Span("Назначено брендов", style="font-size: 12px; color: #64748b;"),
                style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            Div(
                Span(str(len(unassigned_brands)), style="font-size: 28px; font-weight: 700; color: #f59e0b; display: block;"),
                Span("Без назначения", style="font-size: 12px; color: #64748b;"),
                style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            Div(
                Span(str(len(procurement_users)), style="font-size: 28px; font-weight: 700; color: #3b82f6; display: block;"),
                Span("Менеджеров закупок", style="font-size: 12px; color: #64748b;"),
                style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            Div(
                Span(str(len(all_quote_brands)), style="font-size: 28px; font-weight: 700; color: #8b5cf6; display: block;"),
                Span("Всего брендов в КП", style="font-size: 12px; color: #64748b;"),
                style="text-align: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;"
        ),

        # Unassigned brands section
        Div(
            Div(
                icon("alert-circle", size=14, color="#d97706"),
                Span("БРЕНДЫ БЕЗ НАЗНАЧЕНИЯ", style="margin-left: 6px;"),
                style="font-size: 11px; font-weight: 600; color: #d97706; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center;"
            ),
            Div(
                *unassigned_items if unassigned_items else [
                    Div(
                        icon("check-circle", size=16, color="#10b981"),
                        Span(" Все бренды из КП назначены менеджерам", style="color: #10b981; font-size: 14px; margin-left: 8px;"),
                        style="display: flex; align-items: center;"
                    )
                ],
                style="max-height: 200px; overflow-y: auto;"
            ),
            style=f"background: {'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)' if unassigned_items else 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'}; border-radius: 12px; padding: 16px 20px; margin-bottom: 24px; border: 1px solid {'#fcd34d' if unassigned_items else '#86efac'};"
        ) if all_quote_brands else None,

        # Current assignments table section
        Div(
            Div(
                icon("list", size=14, color="#64748b"),
                Span("ТЕКУЩИЕ НАЗНАЧЕНИЯ", style="margin-left: 6px;"),
                style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 16px; display: flex; align-items: center;"
            ),
            Div(
                Table(
                    Thead(Tr(
                        Th("Бренд", style=th_style),
                        Th("Менеджер", style=th_style),
                        Th("Всего брендов", style=th_style),
                        Th("Дата назначения", style=th_style),
                        Th("Действия", style=th_style)
                    )),
                    Tbody(*[Tr(
                        Td(Span(a.brand, style="font-weight: 600; color: #8b5cf6;"), style=td_style),
                        Td(a.user_id[:8] + "...", style=td_style),
                        Td(str(assignment_counts.get(a.user_id, 0)), style=td_style),
                        Td(a.created_at.strftime("%Y-%m-%d") if a.created_at else "-", style=td_style),
                        Td(
                            Div(
                                btn_link("Изменить", href=f"/admin/brands/{a.id}/edit", variant="secondary", size="sm"),
                                Form(
                                    btn("Удалить", variant="danger", size="sm", type="submit"),
                                    method="POST",
                                    action=f"/admin/brands/{a.id}/delete",
                                    style="display: inline;"
                                ),
                                style="display: flex; align-items: center; gap: 8px;"
                            ),
                            style=td_style
                        )
                    ) for a in assignments]) if assignment_rows else Tbody(
                        Tr(Td(
                            Div(
                                icon("inbox", size=32, color="#94a3b8"),
                                P("Нет назначений", style="color: #64748b; margin: 8px 0 0 0;"),
                                style="text-align: center; padding: 32px;"
                            ),
                            colspan="5"
                        ))
                    ),
                    style="width: 100%; border-collapse: collapse;"
                ),
                style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;"
            ),
        ),

        session=session
    )


@rt("/admin/brands/new")
def get(session, brand: str = None):
    """Form to create new brand assignment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = user["org_id"]

    # Get procurement users
    # First get all active organization members
    members_result = supabase.table("organization_members").select(
        "user_id"
    ).eq("organization_id", org_id).eq("status", "active").execute()

    # Filter to only users who have the procurement role
    from services.role_service import get_user_role_codes
    procurement_users = []
    for member in (members_result.data or []):
        user_id = member["user_id"]
        user_roles = get_user_role_codes(user_id, org_id)
        if "procurement" in user_roles:
            procurement_users.append({
                "user_id": user_id,
                "display": user_id[:8] + "..."
            })

    # Build user options
    user_options = [
        Option(u["display"], value=u["user_id"])
        for u in procurement_users
    ]

    # Form input styles
    input_style = "width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;"
    label_style = "display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;"
    select_style = "width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;"

    return page_layout("Новое назначение бренда",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                "К списку брендов",
                href="/admin/brands",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("plus-circle", size=28, color="#10b981"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1("Новое назначение бренда", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    P("Назначьте бренд менеджеру по закупкам", style="margin: 0; color: #64748b; font-size: 14px;"),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Form card
        Div(
            Form(
                Div(
                    icon("tag", size=14, color="#64748b"),
                    Span("ДАННЫЕ НАЗНАЧЕНИЯ", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 20px; display: flex; align-items: center;"
                ),

                # Brand name
                Div(
                    Label("Название бренда *", fr="brand", style=label_style),
                    Input(type="text", name="brand", id="brand", value=brand or "", required=True,
                          placeholder="Например: BOSCH", style=input_style),
                    style="margin-bottom: 16px;"
                ),

                # Manager select
                Div(
                    Label("Менеджер по закупкам *", fr="user_id", style=label_style),
                    Select(
                        Option("— Выберите менеджера —", value="", disabled=True, selected=True),
                        *user_options,
                        name="user_id",
                        id="user_id",
                        required=True,
                        style=select_style
                    ) if user_options else Div(
                        Div(
                            icon("alert-triangle", size=16, color="#ef4444"),
                            Span(" Нет пользователей с ролью 'procurement'", style="color: #ef4444; font-size: 14px; margin-left: 8px;"),
                            style="display: flex; align-items: center; margin-bottom: 8px;"
                        ),
                        P("Сначала назначьте роль менеджера по закупкам на ",
                          A("странице пользователей", href="/admin", style="color: #3b82f6; text-decoration: underline;"), ".",
                          style="color: #64748b; font-size: 13px; margin: 0;"),
                        style="padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Submit button
                Div(
                    btn("Создать назначение", variant="success", icon_name="plus", type="submit"),
                    btn_link("Отмена", href="/admin/brands", variant="secondary"),
                    style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0;"
                ) if user_options else None,

                method="POST",
                action="/admin/brands/new"
            ),
            style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; max-width: 500px;"
        ),

        session=session
    )


@rt("/admin/brands/new")
def post(session, brand: str, user_id: str):
    """Create new brand assignment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    roles = admin_user.get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    org_id = admin_user["org_id"]
    admin_id = admin_user["id"]

    from services.brand_service import create_brand_assignment, get_brand_assignment_by_brand

    # Check if brand is already assigned
    existing = get_brand_assignment_by_brand(org_id, brand)
    if existing:
        return page_layout("Ошибка",
            H1(icon("alert-triangle", size=28), " Бренд уже назначен", cls="page-header"),
            P(f"Бренд '{brand}' уже назначен другому менеджеру."),
            P("Используйте функцию редактирования для изменения назначения."),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Create the assignment
    result = create_brand_assignment(
        organization_id=org_id,
        brand=brand.strip(),
        user_id=user_id,
        created_by=admin_id
    )

    if result:
        return page_layout("Назначение создано",
            H1("✓ Назначение создано"),
            P(f"Бренд '{brand}' успешно назначен менеджеру."),
            Div(
                Span(brand, style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;"),
                Span(" → ", style="margin: 0 8px;"),
                Span(user_id[:8] + "...", style="color: #6b7280;"),
                style="margin: 16px 0;"
            ),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1(icon("x-circle", size=28), " Ошибка создания", cls="page-header"),
            P("Не удалось создать назначение. Попробуйте ещё раз."),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )


@rt("/admin/brands/{assignment_id}/edit")
def get(assignment_id: str, session):
    """Edit form for brand assignment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    roles = user.get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    from services.brand_service import get_brand_assignment

    assignment = get_brand_assignment(assignment_id)
    if not assignment:
        return page_layout("Не найдено",
            H1("Назначение не найдено"),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    supabase = get_supabase()
    org_id = user["org_id"]

    # Get procurement users
    from services.role_service import get_user_role_codes

    # Get all active organization members
    members_result = supabase.table("organization_members").select(
        "user_id"
    ).eq("organization_id", org_id).eq("status", "active").execute()

    # Filter to only users who have the procurement role
    procurement_users = []
    for member in (members_result.data or []):
        user_id = member["user_id"]
        user_roles = get_user_role_codes(user_id, org_id)
        if "procurement" in user_roles:
            procurement_users.append({
                "user_id": user_id,
                "display": user_id[:8] + "..."
            })

    # Build user options
    user_options = [
        Option(u["display"], value=u["user_id"], selected=(u["user_id"] == assignment.user_id))
        for u in procurement_users
    ]

    # Form input styles
    select_style = "width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;"
    label_style = "display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px;"

    return page_layout("Редактирование назначения",
        # Modern gradient header card
        Div(
            # Back link
            A(
                Span(icon("arrow-left", size=14), style="margin-right: 6px;"),
                "К списку брендов",
                href="/admin/brands",
                style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; margin-bottom: 16px;"
            ),
            # Header content
            Div(
                Div(
                    icon("edit-3", size=28, color="#f59e0b"),
                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;"
                ),
                Div(
                    H1("Редактирование назначения", style="margin: 0 0 4px 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                    Div(
                        Span("Бренд: ", style="color: #64748b; font-size: 14px;"),
                        Span(assignment.brand, style="color: #8b5cf6; font-size: 14px; font-weight: 600;"),
                    ),
                    style="flex: 1;"
                ),
                style="display: flex; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f1f5f9 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; border: 1px solid #e2e8f0;"
        ),

        # Form card
        Div(
            Form(
                Div(
                    icon("user", size=14, color="#64748b"),
                    Span("ИЗМЕНИТЬ МЕНЕДЖЕРА", style="margin-left: 6px;"),
                    style="font-size: 11px; font-weight: 600; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 20px; display: flex; align-items: center;"
                ),

                Input(type="hidden", name="brand", value=assignment.brand),

                # Current assignment info
                Div(
                    Span("Текущий менеджер: ", style="color: #64748b; font-size: 13px;"),
                    Span(assignment.user_id[:8] + "...", style="color: #1e293b; font-weight: 500; font-size: 13px;"),
                    style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 16px;"
                ),

                # Manager select
                Div(
                    Label("Новый менеджер по закупкам *", fr="user_id", style=label_style),
                    Select(
                        *user_options,
                        name="user_id",
                        id="user_id",
                        required=True,
                        style=select_style
                    ) if user_options else P("Нет менеджеров с ролью procurement", style="color: #ef4444; font-size: 14px;"),
                    style="margin-bottom: 20px;"
                ),

                # Submit button
                Div(
                    btn("Сохранить изменения", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/admin/brands", variant="secondary"),
                    style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0;"
                ) if user_options else None,

                method="POST",
                action=f"/admin/brands/{assignment_id}/edit"
            ),
            style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; max-width: 500px;"
        ),

        session=session
    )


@rt("/admin/brands/{assignment_id}/edit")
def post(assignment_id: str, session, user_id: str, brand: str = None):
    """Update brand assignment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    roles = admin_user.get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    from services.brand_service import update_brand_assignment, get_brand_assignment

    assignment = get_brand_assignment(assignment_id)
    if not assignment:
        return page_layout("Не найдено",
            H1("Назначение не найдено"),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Update the assignment
    result = update_brand_assignment(assignment_id, user_id)

    if result:
        return page_layout("Назначение обновлено",
            H1("✓ Назначение обновлено"),
            P(f"Бренд '{assignment.brand}' переназначен новому менеджеру."),
            Div(
                Span(assignment.brand, style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-weight: 600;"),
                Span(" → ", style="margin: 0 8px;"),
                Span(user_id[:8] + "...", style="color: #6b7280;"),
                style="margin: 16px 0;"
            ),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1(icon("x-circle", size=28), " Ошибка обновления", cls="page-header"),
            P("Не удалось обновить назначение. Попробуйте ещё раз."),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )


@rt("/admin/brands/{assignment_id}/delete")
def post(assignment_id: str, session):
    """Delete brand assignment."""
    redirect = require_login(session)
    if redirect:
        return redirect

    admin_user = session["user"]
    roles = admin_user.get("roles", [])

    if "admin" not in roles:
        return page_layout("Доступ запрещён",
            H1("Доступ запрещён"),
            P("Эта страница доступна только администраторам."),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    from services.brand_service import get_brand_assignment, delete_brand_assignment

    assignment = get_brand_assignment(assignment_id)
    brand_name = assignment.brand if assignment else "Unknown"

    result = delete_brand_assignment(assignment_id)

    if result:
        return page_layout("Назначение удалено",
            H1("✓ Назначение удалено"),
            P(f"Бренд '{brand_name}' больше не назначен менеджеру."),
            P("Бренд вернулся в список неназначенных.", style="color: #6b7280;"),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )
    else:
        return page_layout("Ошибка",
            H1(icon("x-circle", size=28), " Ошибка удаления", cls="page-header"),
            P("Не удалось удалить назначение. Попробуйте ещё раз."),
            btn_link("Назад к списку", href="/admin/brands", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# API ENDPOINTS - HTMX Search Endpoints
# ============================================================================

# Import location service for API endpoint
from services.location_service import get_locations_for_dropdown, search_locations, format_location_for_dropdown


@rt("/api/locations/search")
def get(session, q: str = "", hub_only: str = "", customs_only: str = "", limit: int = 20):
    """
    Search locations for HTMX dropdown autocomplete.

    This endpoint provides location search functionality for HTMX-powered
    dropdown components used in quote item forms (pickup_location_id).

    Query Parameters:
        q: Search query (matches code, city, country, address)
        hub_only: If "true", return only logistics hub locations
        customs_only: If "true", return only customs point locations
        limit: Maximum number of results (default 20)

    Returns:
        HTML fragment with <option> elements for dropdown

    Usage in HTMX:
        <input type="text"
               hx-get="/api/locations/search"
               hx-trigger="input changed delay:300ms"
               hx-target="#location-options"
               name="q">
        <select id="location-options">
            <!-- Options populated by HTMX -->
        </select>

    Example Response (HTML):
        <option value="">Выберите локацию...</option>
        <option value="uuid-1">MSK - Москва, Россия [хаб]</option>
        <option value="uuid-2">SPB - Санкт-Петербург, Россия [хаб]</option>
    """
    # Check authentication
    redirect = require_login(session)
    if redirect:
        # Return empty for HTMX partial
        return Option("Требуется авторизация", value="", disabled=True)

    user = session["user"]
    org_id = user.get("org_id")

    if not org_id:
        return Option("Организация не найдена", value="", disabled=True)

    # Parse boolean flags
    is_hub_only = hub_only.lower() == "true"
    is_customs_only = customs_only.lower() == "true"

    # Search locations using location service
    try:
        if q and len(q.strip()) > 0:
            # Search with query
            from services.location_service import search_locations
            locations = search_locations(
                organization_id=org_id,
                query=q.strip(),
                is_hub_only=is_hub_only,
                is_customs_only=is_customs_only,
                limit=min(limit, 50),  # Cap at 50 for safety
            )
            dropdown_items = [format_location_for_dropdown(loc) for loc in locations]
        else:
            # Get all locations (limited) when no query
            dropdown_items = get_locations_for_dropdown(
                organization_id=org_id,
                query=None,
                is_hub_only=is_hub_only,
                is_customs_only=is_customs_only,
                limit=min(limit, 50),
            )

        # Build HTML options for datalist
        options = []
        for item in dropdown_items:
            # For datalist: value = display text, data-id = UUID
            options.append(Option(
                item["label"],
                value=item["label"],
                **{"data-id": item["value"]}
            ))

        # If no results found
        if len(dropdown_items) == 0 and q:
            options.append(Option(f"Ничего не найдено по запросу '{q}'", value="", disabled=True))

        return Group(*options)

    except Exception as e:
        print(f"Error in location search API: {e}")
        return Option(f"Ошибка поиска: {str(e)}", value="", disabled=True)


@rt("/api/locations/search/json")
def get(session, q: str = "", hub_only: str = "", customs_only: str = "", limit: int = 20):
    """
    Search locations for HTMX dropdown - JSON response format.

    Same as /api/locations/search but returns JSON instead of HTML.
    Useful for custom dropdown implementations.

    Returns:
        JSON array of {value, label} objects
    """
    # Check authentication
    redirect = require_login(session)
    if redirect:
        return {"error": "Unauthorized", "items": []}

    user = session["user"]
    org_id = user.get("org_id")

    if not org_id:
        return {"error": "Organization not found", "items": []}

    # Parse boolean flags
    is_hub_only = hub_only.lower() == "true"
    is_customs_only = customs_only.lower() == "true"

    # Search locations
    try:
        if q and len(q.strip()) > 0:
            from services.location_service import search_locations
            locations = search_locations(
                organization_id=org_id,
                query=q.strip(),
                is_hub_only=is_hub_only,
                is_customs_only=is_customs_only,
                limit=min(limit, 50),
            )
            items = [format_location_for_dropdown(loc) for loc in locations]
        else:
            items = get_locations_for_dropdown(
                organization_id=org_id,
                query=None,
                is_hub_only=is_hub_only,
                is_customs_only=is_customs_only,
                limit=min(limit, 50),
            )

        return {"items": items, "count": len(items), "query": q}

    except Exception as e:
        print(f"Error in location search JSON API: {e}")
        return {"error": str(e), "items": []}


# ============================================================================
# UI COMPONENTS - Reusable HTMX Dropdown Components (Feature UI-011)
# ============================================================================

def location_dropdown(
    name: str = "pickup_location_id",
    label: str = "Локация",
    selected_id: str = None,
    selected_label: str = None,
    required: bool = False,
    hub_only: bool = False,
    customs_only: bool = False,
    placeholder: str = "Поиск локации...",
    help_text: str = None,
    cls: str = "",
    dropdown_id: str = None,
) -> Div:
    """
    Reusable HTMX-powered location dropdown component.

    Creates a searchable dropdown that fetches location options from
    /api/locations/search as user types. Uses trigram-based search
    for fuzzy matching on city, country, code, and address.

    Args:
        name: Form field name (default: "pickup_location_id")
        label: Label text displayed above the dropdown
        selected_id: Pre-selected location UUID (for edit forms)
        selected_label: Pre-selected location display text
        required: Whether field is required
        hub_only: Only show hub locations (is_hub=true)
        customs_only: Only show customs point locations (is_customs_point=true)
        placeholder: Placeholder text for search input
        help_text: Optional help text below the dropdown
        cls: Additional CSS classes for the container
        dropdown_id: Custom ID for the dropdown (auto-generated if not provided)

    Returns:
        Div: FastHTML element containing the complete dropdown component

    Usage in forms:
        # Basic usage
        location_dropdown(name="pickup_location_id", label="Точка отгрузки")

        # For edit form with pre-selected value
        location_dropdown(
            name="pickup_location_id",
            label="Точка отгрузки",
            selected_id=item.get("pickup_location_id"),
            selected_label="MSK - Москва, Россия [хаб]",
            required=True
        )

        # Hub locations only
        location_dropdown(
            name="hub_location_id",
            label="Хаб",
            hub_only=True
        )

        # Customs points only
        location_dropdown(
            name="customs_location_id",
            label="Таможенный пост",
            customs_only=True
        )

    Example HTML output:
        <div class="location-dropdown">
            <label>Локация *</label>
            <input type="text"
                   placeholder="Поиск локации..."
                   hx-get="/api/locations/search"
                   hx-trigger="input changed delay:300ms, focus"
                   hx-target="#location-options-123"
                   hx-vals='{"hub_only": "false"}'>
            <select id="location-options-123" name="pickup_location_id">
                <option value="">Выберите локацию...</option>
            </select>
            <p class="help-text">Начните вводить название</p>
        </div>
    """
    # Generate unique ID if not provided
    import uuid
    component_id = dropdown_id or f"loc-{uuid.uuid4().hex[:8]}"
    datalist_id = f"datalist-{component_id}"
    hidden_id = f"hidden-{component_id}"
    input_id = f"input-{component_id}"

    # Build hx-vals for query parameters
    hx_vals_dict = {}
    if hub_only:
        hx_vals_dict["hub_only"] = "true"
    if customs_only:
        hx_vals_dict["customs_only"] = "true"

    # Convert to JSON string for hx-vals
    import json
    hx_vals = json.dumps(hx_vals_dict) if hx_vals_dict else None

    # Build label with required indicator
    label_text = f"{label} *" if required else label

    # Build help text element
    help_element = Small(help_text, style="color: #666; display: block; margin-top: 0.25rem;") if help_text else None

    # Build the container class
    container_cls = f"location-dropdown {cls}".strip()

    # Inline script to sync datalist selection with hidden field and handle Enter key
    sync_script = Script(f"""
        (function() {{
            const input = document.getElementById('{input_id}');
            const datalist = document.getElementById('{datalist_id}');
            const hidden = document.getElementById('{hidden_id}');

            if (!input || !datalist || !hidden) return;

            function syncValue() {{
                const option = Array.from(datalist.options).find(opt => opt.value === input.value);
                hidden.value = option ? (option.getAttribute('data-id') || '') : '';
            }}

            input.addEventListener('input', syncValue);
            input.addEventListener('change', syncValue);

            input.addEventListener('keydown', function(e) {{
                if (e.key === 'Enter') {{
                    const options = Array.from(datalist.options);
                    if (options.length === 1) {{
                        input.value = options[0].value;
                        syncValue();
                        e.preventDefault();
                    }} else if (options.length > 1) {{
                        const exact = options.find(opt => opt.value === input.value);
                        if (exact) {{
                            syncValue();
                            e.preventDefault();
                        }} else {{
                            const partial = options.find(opt =>
                                opt.value.toLowerCase().includes(input.value.toLowerCase())
                            );
                            if (partial) {{
                                input.value = partial.value;
                                syncValue();
                                e.preventDefault();
                            }}
                        }}
                    }}
                }}
            }});
        }})();
    """)

    # Build input attributes for datalist
    input_attrs = {
        "type": "text",
        "id": input_id,
        "name": "q",  # HTMX will send this value as query parameter
        "list": datalist_id,
        "value": selected_label or "",
        "placeholder": placeholder,
        "autocomplete": "off",
        "required": required,
        "style": "width: 100%;",
        "hx-get": "/api/locations/search",
        "hx-trigger": "input changed delay:300ms, focus",
        "hx-target": f"#{datalist_id}",
    }
    # Add filter parameters (hub_only, customs_only) if provided
    if hx_vals:
        input_attrs["hx-vals"] = hx_vals

    # Construct the component
    return Div(
        Label(
            label_text,
            Input(**input_attrs),
            Datalist(id=datalist_id),
            Input(type="hidden", name=name, id=hidden_id, value=selected_id or ""),
            help_element,
        ),
        sync_script,
        cls=container_cls,
        id=component_id,
    )


def location_dropdown_simple(
    name: str = "location_id",
    label: str = "Локация",
    locations: List[Dict] = None,
    selected_id: str = None,
    required: bool = False,
    placeholder: str = "Выберите локацию...",
    help_text: str = None,
) -> Label:
    """
    Simple location dropdown without HTMX search.

    Use when you have a small list of locations that can be preloaded.
    For large lists or dynamic search, use location_dropdown() instead.

    Args:
        name: Form field name
        label: Label text
        locations: List of location dicts with 'value' and 'label' keys
        selected_id: Pre-selected location UUID
        required: Whether field is required
        placeholder: First option placeholder text
        help_text: Optional help text

    Returns:
        Label: FastHTML Label element containing the dropdown
    """
    options = [Option(placeholder, value="")]

    if locations:
        for loc in locations:
            is_selected = loc.get("value") == selected_id
            options.append(Option(loc.get("label", ""), value=loc.get("value", ""), selected=is_selected))

    label_text = f"{label} *" if required else label

    elements = [
        label_text,
        Select(*options, name=name, required=required),
    ]
    if help_text:
        elements.append(Small(help_text, style="color: #666;"))

    return Label(*elements)


def supplier_dropdown(
    name: str = "supplier_id",
    label: str = "Поставщик",
    selected_id: str = None,
    selected_label: str = None,
    required: bool = False,
    placeholder: str = "Начните печатать название...",
    help_text: str = None,
    cls: str = "",
    dropdown_id: str = None,
) -> Div:
    """
    Reusable HTMX-powered supplier dropdown component using datalist.

    Creates a searchable input with suggestions that fetches supplier options from
    /api/suppliers/search as user types. Uses HTML5 datalist for native autocomplete.

    Args:
        name: Form field name (default: "supplier_id")
        label: Label text displayed above the dropdown
        selected_id: Pre-selected supplier UUID (for edit forms)
        selected_label: Pre-selected supplier display text
        required: Whether field is required
        placeholder: Placeholder text for search input
        help_text: Optional help text below the dropdown
        cls: Additional CSS classes for the container
        dropdown_id: Custom ID for the dropdown

    Returns:
        Div: FastHTML element containing the complete dropdown component

    Usage:
        supplier_dropdown(
            name="supplier_id",
            label="Поставщик",
            required=True
        )
    """
    import uuid
    component_id = dropdown_id or f"sup-{uuid.uuid4().hex[:8]}"
    datalist_id = f"datalist-{component_id}"
    hidden_id = f"hidden-{component_id}"
    input_id = f"input-{component_id}"

    label_text = f"{label} *" if required else label
    help_element = Small(help_text, style="color: #666; display: block; margin-top: 0.25rem;") if help_text else None
    container_cls = f"supplier-dropdown {cls}".strip()

    # Inline script to sync datalist selection with hidden field and handle Enter key
    sync_script = Script(f"""
        (function() {{
            const input = document.getElementById('{input_id}');
            const datalist = document.getElementById('{datalist_id}');
            const hidden = document.getElementById('{hidden_id}');

            if (!input || !datalist || !hidden) return;

            function syncValue() {{
                const option = Array.from(datalist.options).find(opt => opt.value === input.value);
                hidden.value = option ? (option.getAttribute('data-id') || '') : '';
            }}

            input.addEventListener('input', syncValue);
            input.addEventListener('change', syncValue);

            input.addEventListener('keydown', function(e) {{
                if (e.key === 'Enter') {{
                    const options = Array.from(datalist.options);
                    if (options.length === 1) {{
                        input.value = options[0].value;
                        syncValue();
                        e.preventDefault();
                    }} else if (options.length > 1) {{
                        const exact = options.find(opt => opt.value === input.value);
                        if (exact) {{
                            syncValue();
                            e.preventDefault();
                        }} else {{
                            const partial = options.find(opt =>
                                opt.value.toLowerCase().includes(input.value.toLowerCase())
                            );
                            if (partial) {{
                                input.value = partial.value;
                                syncValue();
                                e.preventDefault();
                            }}
                        }}
                    }}
                }}
            }});
        }})();
    """)

    return Div(
        Label(
            label_text,
            Input(
                type="text",
                id=input_id,
                name="q",  # HTMX will send this value as query parameter
                list=datalist_id,
                value=selected_label or "",
                placeholder=placeholder,
                autocomplete="off",
                required=required,
                style="width: 100%;",
                **{
                    "hx-get": "/api/suppliers/search",
                    "hx-trigger": "input changed delay:300ms, focus",
                    "hx-target": f"#{datalist_id}",
                }
            ),
            Datalist(id=datalist_id),
            Input(type="hidden", name=name, id=hidden_id, value=selected_id or ""),
            help_element,
        ),
        sync_script,
        cls=container_cls,
        id=component_id,
    )


def buyer_company_dropdown(
    name: str = "buyer_company_id",
    label: str = "Компания-покупатель",
    selected_id: str = None,
    selected_label: str = None,
    required: bool = False,
    placeholder: str = "Начните печатать название...",
    help_text: str = None,
    cls: str = "",
    dropdown_id: str = None,
) -> Div:
    """
    Reusable HTMX-powered buyer company dropdown component using datalist.

    Creates a searchable input with suggestions for selecting our purchasing legal entities.
    Uses HTML5 datalist for native autocomplete without separate search field.

    Args:
        name: Form field name (default: "buyer_company_id")
        label: Label text
        selected_id: Pre-selected company UUID
        selected_label: Pre-selected company display text
        required: Whether field is required
        placeholder: Placeholder text
        help_text: Optional help text
        cls: Additional CSS classes
        dropdown_id: Custom ID

    Returns:
        Div: FastHTML element containing the input with datalist
    """
    import uuid
    component_id = dropdown_id or f"buy-{uuid.uuid4().hex[:8]}"
    datalist_id = f"datalist-{component_id}"
    hidden_id = f"hidden-{component_id}"
    input_id = f"input-{component_id}"

    label_text = f"{label} *" if required else label
    help_element = Small(help_text, style="color: #666; display: block; margin-top: 0.25rem;") if help_text else None
    container_cls = f"buyer-company-dropdown {cls}".strip()

    # Inline script to sync datalist selection with hidden field and handle Enter key
    sync_script = Script(f"""
        (function() {{
            const input = document.getElementById('{input_id}');
            const datalist = document.getElementById('{datalist_id}');
            const hidden = document.getElementById('{hidden_id}');

            if (!input || !datalist || !hidden) return;

            function syncValue() {{
                const option = Array.from(datalist.options).find(opt => opt.value === input.value);
                hidden.value = option ? (option.getAttribute('data-id') || '') : '';
            }}

            input.addEventListener('input', syncValue);
            input.addEventListener('change', syncValue);

            input.addEventListener('keydown', function(e) {{
                if (e.key === 'Enter') {{
                    const options = Array.from(datalist.options);
                    if (options.length === 1) {{
                        input.value = options[0].value;
                        syncValue();
                        e.preventDefault();
                    }} else if (options.length > 1) {{
                        const exact = options.find(opt => opt.value === input.value);
                        if (exact) {{
                            syncValue();
                            e.preventDefault();
                        }} else {{
                            const partial = options.find(opt =>
                                opt.value.toLowerCase().includes(input.value.toLowerCase())
                            );
                            if (partial) {{
                                input.value = partial.value;
                                syncValue();
                                e.preventDefault();
                            }}
                        }}
                    }}
                }}
            }});
        }})();
    """)

    return Div(
        Label(
            label_text,
            Input(
                type="text",
                id=input_id,
                name="q",  # HTMX will send this value as query parameter
                list=datalist_id,
                value=selected_label or "",
                placeholder=placeholder,
                autocomplete="off",
                required=required,
                style="width: 100%;",
                **{
                    "hx-get": "/api/buyer-companies/search",
                    "hx-trigger": "input changed delay:300ms, focus",
                    "hx-target": f"#{datalist_id}",
                }
            ),
            Datalist(id=datalist_id),
            Input(type="hidden", name=name, id=hidden_id, value=selected_id or ""),
            help_element,
        ),
        sync_script,
        cls=container_cls,
        id=component_id,
    )


def seller_company_dropdown(
    name: str = "seller_company_id",
    label: str = "Компания-продавец",
    selected_id: str = None,
    selected_label: str = None,
    required: bool = False,
    placeholder: str = "Начните печатать название...",
    help_text: str = None,
    cls: str = "",
    dropdown_id: str = None,
) -> Div:
    """
    Reusable HTMX-powered seller company dropdown component using datalist.

    Creates a searchable input with suggestions for selecting our selling legal entities
    at the quote level. Uses HTML5 datalist for native autocomplete.

    Args:
        name: Form field name (default: "seller_company_id")
        label: Label text
        selected_id: Pre-selected company UUID
        selected_label: Pre-selected company display text
        required: Whether field is required
        placeholder: Placeholder text
        help_text: Optional help text
        cls: Additional CSS classes
        dropdown_id: Custom ID

    Returns:
        Div: FastHTML element containing the input with datalist
    """
    import uuid
    component_id = dropdown_id or f"sel-{uuid.uuid4().hex[:8]}"
    datalist_id = f"datalist-{component_id}"
    hidden_id = f"hidden-{component_id}"
    input_id = f"input-{component_id}"

    label_text = f"{label} *" if required else label
    help_element = Small(help_text, style="color: #666; display: block; margin-top: 0.25rem;") if help_text else None
    container_cls = f"seller-company-dropdown {cls}".strip()

    # Inline script to sync datalist selection with hidden field and handle Enter key
    sync_script = Script(f"""
        (function() {{
            const input = document.getElementById('{input_id}');
            const datalist = document.getElementById('{datalist_id}');
            const hidden = document.getElementById('{hidden_id}');

            if (!input || !datalist || !hidden) return;

            function syncValue() {{
                const option = Array.from(datalist.options).find(opt => opt.value === input.value);
                hidden.value = option ? (option.getAttribute('data-id') || '') : '';
            }}

            input.addEventListener('input', syncValue);
            input.addEventListener('change', syncValue);

            input.addEventListener('keydown', function(e) {{
                if (e.key === 'Enter') {{
                    const options = Array.from(datalist.options);
                    if (options.length === 1) {{
                        input.value = options[0].value;
                        syncValue();
                        e.preventDefault();
                    }} else if (options.length > 1) {{
                        const exact = options.find(opt => opt.value === input.value);
                        if (exact) {{
                            syncValue();
                            e.preventDefault();
                        }} else {{
                            const partial = options.find(opt =>
                                opt.value.toLowerCase().includes(input.value.toLowerCase())
                            );
                            if (partial) {{
                                input.value = partial.value;
                                syncValue();
                                e.preventDefault();
                            }}
                        }}
                    }}
                }}
            }});
        }})();
    """)

    return Div(
        Label(
            label_text,
            Input(
                type="text",
                id=input_id,
                name="q",  # HTMX will send this value as query parameter
                list=datalist_id,
                value=selected_label or "",
                placeholder=placeholder,
                autocomplete="off",
                required=required,
                style="width: 100%;",
                **{
                    "hx-get": "/api/seller-companies/search",
                    "hx-trigger": "input changed delay:300ms, focus",
                    "hx-target": f"#{datalist_id}",
                }
            ),
            Datalist(id=datalist_id),
            Input(type="hidden", name=name, id=hidden_id, value=selected_id or ""),
            help_element,
        ),
        sync_script,
        cls=container_cls,
        id=component_id,
    )


# ============================================================================
# API ENDPOINTS - Supplier Search for HTMX Dropdown (Feature UI-011)
# ============================================================================

@rt("/api/suppliers/search")
def get(session, q: str = "", country: str = "", limit: int = 20):
    """
    Search suppliers for HTMX dropdown autocomplete.

    Query Parameters:
        q: Search query (matches name, supplier_code, or INN)
        country: Filter by country code
        limit: Maximum results (default 20, max 50)

    Returns:
        HTML fragment with <option> elements for dropdown
    """
    redirect = require_login(session)
    if redirect:
        return Option("Требуется авторизация", value="", disabled=True)

    user = session["user"]
    org_id = user.get("org_id")  # Fixed: session stores 'org_id' not 'organization_id'

    if not org_id:
        return Option("Организация не найдена", value="", disabled=True)

    try:
        from services.supplier_service import search_suppliers, get_all_suppliers, format_supplier_for_dropdown

        if q and len(q.strip()) > 0:
            suppliers = search_suppliers(
                organization_id=org_id,
                query=q.strip(),
                is_active=True,
                limit=min(limit, 50),
            )
        else:
            suppliers = get_all_suppliers(
                organization_id=org_id,
                is_active=True,
                limit=min(limit, 50),
            )

        options = []
        for sup in suppliers:
            label = format_supplier_for_dropdown(sup)
            # For datalist: value = display text, data-id = UUID
            options.append(Option(
                label.get("label", ""),
                value=label.get("label", ""),
                **{"data-id": label.get("value", "")}
            ))

        if len(suppliers) == 0 and q:
            options.append(Option(f"Ничего не найдено по запросу '{q}'", value="", disabled=True))

        return Group(*options)

    except Exception as e:
        print(f"Error in supplier search API: {e}")
        return Option(f"Ошибка: {str(e)}", value="", disabled=True)


@rt("/api/buyer-companies/search")
def get(session, q: str = "", limit: int = 20):
    """
    Search buyer companies for HTMX dropdown autocomplete.

    Query Parameters:
        q: Search query (matches name, company_code, or INN)
        limit: Maximum results (default 20, max 50)

    Returns:
        HTML fragment with <option> elements for dropdown
    """
    redirect = require_login(session)
    if redirect:
        return Option("Требуется авторизация", value="", disabled=True)

    user = session["user"]
    org_id = user.get("org_id")

    if not org_id:
        return Option("Организация не найдена", value="", disabled=True)

    try:
        from services.buyer_company_service import search_buyer_companies, get_all_buyer_companies, format_buyer_company_for_dropdown

        if q and len(q.strip()) > 0:
            companies = search_buyer_companies(
                organization_id=org_id,
                query=q.strip(),
                is_active=True,
                limit=min(limit, 50),
            )
        else:
            companies = get_all_buyer_companies(
                organization_id=org_id,
                is_active=True,
                limit=min(limit, 50),
            )

        options = []
        for comp in companies:
            label = format_buyer_company_for_dropdown(comp)
            # For datalist: value = display text, data-id = UUID
            options.append(Option(
                label.get("label", ""),
                value=label.get("label", ""),
                **{"data-id": label.get("value", "")}
            ))

        if len(companies) == 0 and q:
            options.append(Option(f"Ничего не найдено по запросу '{q}'", value="", disabled=True))

        return Group(*options)

    except Exception as e:
        print(f"Error in buyer company search API: {e}")
        return Option(f"Ошибка: {str(e)}", value="", disabled=True)


@rt("/api/seller-companies/search")
def get(session, q: str = "", limit: int = 20):
    """
    Search seller companies for HTMX dropdown autocomplete.

    Query Parameters:
        q: Search query (matches name, supplier_code, or INN)
        limit: Maximum results (default 20, max 50)

    Returns:
        HTML fragment with <option> elements for dropdown
    """
    redirect = require_login(session)
    if redirect:
        return Option("Требуется авторизация", value="", disabled=True)

    user = session["user"]
    org_id = user.get("org_id")

    if not org_id:
        return Option("Организация не найдена", value="", disabled=True)

    try:
        from services.seller_company_service import search_seller_companies, get_all_seller_companies, format_seller_company_for_dropdown

        if q and len(q.strip()) > 0:
            companies = search_seller_companies(
                organization_id=org_id,
                query=q.strip(),
                is_active=True,
                limit=min(limit, 50),
            )
        else:
            companies = get_all_seller_companies(
                organization_id=org_id,
                is_active=True,
                limit=min(limit, 50),
            )

        options = []
        for comp in companies:
            label = format_seller_company_for_dropdown(comp)
            # For datalist: value = display text, data-id = UUID
            options.append(Option(
                label.get("label", ""),
                value=label.get("label", ""),
                **{"data-id": label.get("value", "")}
            ))

        if len(companies) == 0 and q:
            options.append(Option(f"Ничего не найдено по запросу '{q}'", value="", disabled=True))

        return Group(*options)

    except Exception as e:
        print(f"Error in seller company search API: {e}")
        return Option(f"Ошибка: {str(e)}", value="", disabled=True)


# ============================================================================
# SUPPLIERS LIST (Feature UI-001)
# ============================================================================

@rt("/suppliers")
def get(session, q: str = "", country: str = "", status: str = ""):
    """
    Suppliers list page with search and filters.

    Query Parameters:
        q: Search query (matches name or supplier_code)
        country: Filter by country
        status: Filter by status ("active", "inactive", or "" for all)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin or procurement role required
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div(
                H1("⛔ Доступ запрещён"),
                P("У вас нет прав для просмотра справочника поставщиков."),
                P("Требуется роль: admin или procurement"),
                btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    # Import supplier service
    from services.supplier_service import (
        get_all_suppliers, search_suppliers, get_unique_countries, get_supplier_stats
    )

    # Get suppliers based on filters
    try:
        if q and q.strip():
            # Use search if query provided
            suppliers = search_suppliers(
                organization_id=org_id,
                query=q.strip(),
                country=country if country else None,
                active_only=(status == "active"),
                limit=100
            )
        else:
            # Get all with filters
            is_active = None if status == "" else (status == "active")
            if country:
                # Use country-specific function
                from services.supplier_service import get_suppliers_by_country
                suppliers = get_suppliers_by_country(
                    organization_id=org_id,
                    country=country,
                    is_active=is_active
                )
            else:
                suppliers = get_all_suppliers(
                    organization_id=org_id,
                    is_active=is_active,
                    limit=100
                )

        # Get countries for filter dropdown
        countries = get_unique_countries(organization_id=org_id)

        # Get stats for summary
        stats = get_supplier_stats(organization_id=org_id)

    except Exception as e:
        print(f"Error loading suppliers: {e}")
        suppliers = []
        countries = []
        stats = {"total": 0, "active": 0, "inactive": 0}

    # Build country options for filter
    country_options = [Option("Все страны", value="")] + [
        Option(c, value=c, selected=(c == country)) for c in countries
    ]

    # Status options
    status_options = [
        Option("Все статусы", value="", selected=(status == "")),
        Option("Активные", value="active", selected=(status == "active")),
        Option("Неактивные", value="inactive", selected=(status == "inactive")),
    ]

    # Build supplier rows
    supplier_rows = []
    for s in suppliers:
        status_text = "Активен" if s.is_active else "Неактивен"
        status_class = "status-success" if s.is_active else "status-neutral"

        supplier_rows.append(
            Tr(
                Td(
                    A(Strong(s.supplier_code), href=f"/suppliers/{s.id}", style="font-family: monospace; color: var(--accent);")
                ),
                Td(s.name),
                Td(f"{s.country or '—'}, {s.city or '—'}" if s.country else "—"),
                Td(s.inn or "—"),
                Td(s.contact_person or "—"),
                Td(s.contact_email or "—"),
                Td(Span(status_text, cls=f"status-badge {status_class}")),
                Td(
                    A(icon("eye", size=16), href=f"/suppliers/{s.id}", title="Просмотр", cls="table-action-btn"),
                    A(icon("edit", size=16), href=f"/suppliers/{s.id}/edit", title="Редактировать", cls="table-action-btn"),
                    cls="col-actions"
                ),
                cls="clickable-row"
            )
        )

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    """

    page_title_style = """
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: -0.02em;
    """

    new_btn_style = """
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.25);
    """

    stat_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        padding: 16px 20px;
        text-align: center;
        min-width: 120px;
    """

    filter_input_style = """
        padding: 8px 12px;
        font-size: 13px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #f8fafc;
        color: #1e293b;
    """

    return page_layout("Поставщики",
        # Header card with title and actions
        Div(
            Div(
                icon("package", size=26, style="color: #f59e0b;"),
                H1("Поставщики", style=page_title_style),
                style="display: flex; align-items: center; gap: 14px;"
            ),
            Div(
                A(
                    icon("plus", size=16),
                    Span("Добавить"),
                    href="/suppliers/new",
                    style=new_btn_style
                ),
            ),
            style=header_card_style
        ),

        # Stats cards row
        Div(
            Div(
                Div(str(stats.get("total", 0)), style="font-size: 24px; font-weight: 700; color: #1e293b;"),
                Div("Всего", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("active", 0)), style="font-size: 24px; font-weight: 700; color: #059669;"),
                Div("Активных", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("inactive", 0)), style="font-size: 24px; font-weight: 700; color: #dc2626;"),
                Div("Неактивных", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px;"),
                style=stat_card_style
            ),
            style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;"
        ),

        # Table Container
        Div(
            # Table header with filters
            Div(
                Div(
                    Form(
                        Input(name="q", value=q, placeholder="Поиск по названию или коду...", style=filter_input_style + "min-width: 220px;"),
                        Select(*country_options, name="country", style=filter_input_style),
                        Select(*status_options, name="status", style=filter_input_style),
                        btn("Поиск", variant="secondary", icon_name="search", type="submit", size="sm"),
                        method="get",
                        action="/suppliers",
                        style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;"
                    ),
                    cls="table-header-left"
                ),
                cls="table-header"
            ),
            # Table
            Div(
                Div(
                    Table(
                        Thead(
                            Tr(
                                Th("КОД"),
                                Th("НАЗВАНИЕ"),
                                Th("ЛОКАЦИЯ"),
                                Th("ИНН"),
                                Th("КОНТАКТ"),
                                Th("EMAIL"),
                                Th("СТАТУС"),
                                Th("", cls="col-actions")
                            )
                        ),
                        Tbody(*supplier_rows) if supplier_rows else Tbody(
                            Tr(Td(
                                Div(
                                    icon("package", size=32, style="color: #94a3b8; margin-bottom: 12px;"),
                                    Div("Поставщики не найдены", style="font-size: 15px; font-weight: 500; color: #64748b; margin-bottom: 8px;"),
                                    A(
                                        icon("plus", size=14),
                                        Span("Добавить поставщика"),
                                        href="/suppliers/new",
                                        style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; color: #3b82f6; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; text-decoration: none;"
                                    ),
                                    style="text-align: center; padding: 40px 24px;"
                                ),
                                colspan="8"
                            ))
                        ),
                        cls="table-enhanced"
                    ),
                    cls="table-enhanced-container"
                ),
                cls="table-responsive"
            ),
            # Table footer
            Div(
                Span(f"Всего: {len(suppliers)} поставщиков", style="font-size: 13px; color: #64748b;"),
                cls="table-footer"
            ),
            cls="table-container"
        ),

        session=session,
        current_path="/suppliers"
    )


@rt("/suppliers/new")
def get(session):
    """Show form to create a new supplier."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания поставщиков.", cls="alert alert-error"),
            session=session
        )

    return _supplier_form(session=session)


@rt("/suppliers/new")
def post(
    supplier_code: str,
    name: str,
    country: str = "",
    city: str = "",
    inn: str = "",
    kpp: str = "",
    contact_person: str = "",
    contact_email: str = "",
    contact_phone: str = "",
    default_payment_terms: str = "",
    session=None
):
    """Handle supplier creation form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания поставщиков.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")
    user_id = user.get("id")

    from services.supplier_service import create_supplier, validate_supplier_code

    # Normalize supplier code to uppercase
    supplier_code = supplier_code.strip().upper() if supplier_code else ""

    # Validate supplier code format
    if not supplier_code or not validate_supplier_code(supplier_code):
        return _supplier_form(
            error="Код поставщика должен состоять из 3 заглавных латинских букв",
            session=session
        )

    try:
        supplier = create_supplier(
            organization_id=org_id,
            name=name.strip(),
            supplier_code=supplier_code,
            country=country.strip() or None,
            city=city.strip() or None,
            inn=inn.strip() or None,
            kpp=kpp.strip() or None,
            contact_person=contact_person.strip() or None,
            contact_email=contact_email.strip() or None,
            contact_phone=contact_phone.strip() or None,
            default_payment_terms=default_payment_terms.strip() or None,
            is_active=True,
            created_by=user_id,
        )

        if supplier:
            return RedirectResponse(f"/suppliers/{supplier.id}", status_code=303)
        else:
            return _supplier_form(
                error="Поставщик с таким кодом уже существует",
                session=session
            )

    except ValueError as e:
        return _supplier_form(error=str(e), session=session)
    except Exception as e:
        print(f"Error creating supplier: {e}")
        return _supplier_form(error=f"Ошибка при создании: {e}", session=session)


@rt("/suppliers/{supplier_id}")
def get(supplier_id: str, session):
    """View single supplier details."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра поставщиков.", cls="alert alert-error"),
            session=session
        )

    from services.supplier_service import get_supplier

    supplier = get_supplier(supplier_id)

    if not supplier:
        return page_layout("Поставщик не найден",
            Div(
                H1(icon("x-circle", size=28), " Поставщик не найден", cls="page-header"),
                P("Запрашиваемый поставщик не существует."),
                btn_link("К списку поставщиков", href="/suppliers", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    status_text = "Активен" if supplier.is_active else "Неактивен"

    return page_layout(f"Поставщик: {supplier.name}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Поставщики", href="/suppliers",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("package", size=24, color="#6366f1"),
                        H1(supplier.name, style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        Span(supplier.supplier_code, style="font-family: monospace; font-size: 14px; padding: 4px 10px; background: #eff6ff; color: #3b82f6; border-radius: 6px; font-weight: 600;"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span(status_text, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {'#16a34a' if supplier.is_active else '#dc2626'}; background: {'#dcfce7' if supplier.is_active else '#fee2e2'};"),
                        btn_link("Редактировать", href=f"/suppliers/{supplier_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Main info cards grid
        Div(
            # Card 1: Main Info
            Div(
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Код поставщика", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(supplier.supplier_code, style="font-weight: 600; color: #3b82f6; font-family: monospace; font-size: 16px;"),
                    ),
                    Div(
                        Span("Название", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(supplier.name, style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Card 2: Location
            Div(
                Div(
                    icon("map-pin", size=16, color="#64748b"),
                    Span("ЛОКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Страна", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(supplier.country or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Город", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(supplier.city or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;"
        ),

        # Legal info (if Russian supplier)
        Div(
            Div(
                icon("file-text", size=16, color="#64748b"),
                Span("ЮРИДИЧЕСКИЕ ДАННЫЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            Div(
                Div(
                    Span("ИНН", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(supplier.inn or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("КПП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(supplier.kpp or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;"
            ),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if supplier.inn or supplier.kpp else "",

        # Contact info
        Div(
            Div(
                icon("user", size=16, color="#64748b"),
                Span("КОНТАКТНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            Div(
                Div(
                    Span("Контактное лицо", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(supplier.contact_person or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("Email", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(
                        A(supplier.contact_email, href=f"mailto:{supplier.contact_email}", style="color: #6366f1;")
                        if supplier.contact_email else "—",
                        style="font-weight: 500; color: #1e293b; font-size: 14px;"
                    ),
                ),
                Div(
                    Span("Телефон", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(
                        A(supplier.contact_phone, href=f"tel:{supplier.contact_phone}", style="color: #6366f1;")
                        if supplier.contact_phone else "—",
                        style="font-weight: 500; color: #1e293b; font-size: 14px;"
                    ),
                ),
                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;"
            ),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Payment terms
        Div(
            Div(
                icon("credit-card", size=16, color="#64748b"),
                Span("УСЛОВИЯ ОПЛАТЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;"
            ),
            P(supplier.default_payment_terms or "Не указаны", style="font-size: 14px; color: #1e293b;"),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if supplier.default_payment_terms else "",

        # Metadata
        Div(
            Div(
                Span("Создан", style="font-size: 11px; color: #94a3b8; text-transform: uppercase;"),
                Span(f"{supplier.created_at.strftime('%d.%m.%Y %H:%M') if supplier.created_at else '—'}", style="font-size: 13px; color: #64748b; margin-left: 8px;"),
                style="display: flex; align-items: center; gap: 4px;"
            ),
            Div(
                Span("Обновлён", style="font-size: 11px; color: #94a3b8; text-transform: uppercase;"),
                Span(f"{supplier.updated_at.strftime('%d.%m.%Y %H:%M') if supplier.updated_at else '—'}", style="font-size: 13px; color: #64748b; margin-left: 8px;"),
                style="display: flex; align-items: center; gap: 4px;"
            ),
            style="display: flex; gap: 24px; padding: 12px 0; border-top: 1px solid #e2e8f0;"
        ),

        session=session
    )


# ============================================================================
# SUPPLIER FORM - CREATE/EDIT (Feature UI-002)
# ============================================================================

def _supplier_form(supplier=None, error=None, session=None):
    """
    Render supplier create/edit form.

    Args:
        supplier: Existing Supplier object for edit mode, None for create mode
        error: Error message to display
        session: Session object for page layout
    """
    is_edit = supplier is not None
    title = "Редактирование поставщика" if is_edit else "Новый поставщик"
    action_url = f"/suppliers/{supplier.id}/edit" if is_edit else "/suppliers/new"

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    return page_layout(title,
        # Error alert
        Div(
            icon("alert-circle", size=16, color="#dc2626"),
            Span(error, style="margin-left: 8px;"),
            style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ) if error else "",

        # Header card with gradient
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#64748b"),
                    Span("Поставщики", style="margin-left: 6px;"),
                    href="/suppliers",
                    style="display: inline-flex; align-items: center; color: #64748b; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("truck" if not is_edit else "edit", size=24, color="#6366f1"),
                    Span(title, style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    style="display: flex; align-items: center;"
                ),
            ),
            style=header_card_style
        ),

        # Form card
        Div(
            Form(
                # Section: Main info
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Код поставщика *", style=label_style),
                        Input(
                            name="supplier_code",
                            value=supplier.supplier_code if supplier else "",
                            placeholder="ABC",
                            required=True,
                            maxlength="3",
                            pattern="[A-Z]{3}",
                            title="3 заглавные латинские буквы",
                            style=f"{input_style} text-transform: uppercase; font-family: monospace; font-weight: bold;"
                        ),
                        Small("3 заглавные латинские буквы (например: CMT, RAR)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Название компании *", style=label_style),
                        Input(
                            name="name",
                            value=supplier.name if supplier else "",
                            placeholder="China Manufacturing Ltd",
                            required=True,
                            style=input_style
                        ),
                        style="flex: 2;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Location
                Div(
                    icon("map-pin", size=16, color="#64748b"),
                    Span("ЛОКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("Страна", style=label_style),
                        Input(name="country", value=supplier.country if supplier else "", placeholder="Китай", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Город", style=label_style),
                        Input(name="city", value=supplier.city if supplier else "", placeholder="Гуанчжоу", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Legal info
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ЮРИДИЧЕСКИЕ ДАННЫЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("ИНН", style=label_style),
                        Input(name="inn", value=supplier.inn if supplier else "", placeholder="1234567890", pattern="\\d{10}(\\d{2})?", title="10 или 12 цифр", style=input_style),
                        Small("10 цифр для юрлиц, 12 для ИП", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("КПП", style=label_style),
                        Input(name="kpp", value=supplier.kpp if supplier else "", placeholder="123456789", pattern="\\d{9}", title="9 цифр", style=input_style),
                        Small("9 цифр", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Contact info
                Div(
                    icon("phone", size=16, color="#64748b"),
                    Span("КОНТАКТНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("Контактное лицо", style=label_style),
                        Input(name="contact_person", value=supplier.contact_person if supplier else "", placeholder="Иван Иванов", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Email", style=label_style),
                        Input(name="contact_email", type="email", value=supplier.contact_email if supplier else "", placeholder="contact@supplier.com", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Телефон", style=label_style),
                        Input(name="contact_phone", value=supplier.contact_phone if supplier else "", placeholder="+7 999 123 4567", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 1;"),  # Spacer for alignment
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Payment terms
                Div(
                    icon("credit-card", size=16, color="#64748b"),
                    Span("УСЛОВИЯ РАБОТЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Label("Условия оплаты по умолчанию", style=label_style),
                    Textarea(
                        supplier.default_payment_terms if supplier else "",
                        name="default_payment_terms",
                        placeholder="50% предоплата, 50% по готовности",
                        rows="3",
                        style=f"{input_style} resize: vertical;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Status (for edit mode)
                Div(
                    Div(
                        icon("toggle-left", size=16, color="#64748b"),
                        Span("СТАТУС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style=f"{section_header_style} margin-top: 24px;"
                    ),
                    Label(
                        Input(
                            type="checkbox",
                            name="is_active",
                            checked=supplier.is_active if supplier else True,
                            value="true",
                            style="accent-color: #6366f1; margin-right: 8px;"
                        ),
                        Span("Активный поставщик", style="font-size: 14px; color: #1e293b;"),
                        style="display: flex; align-items: center; cursor: pointer;"
                    ),
                    Small("Неактивные поставщики не отображаются в выпадающих списках", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 6px;"),
                ) if is_edit else "",

                # Form actions
                Div(
                    btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/suppliers" if not is_edit else f"/suppliers/{supplier.id}", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; margin-top: 24px; border-top: 1px solid #e2e8f0;"
                ),

                method="post",
                action=action_url
            ),
            style=form_card_style
        ),
        session=session
    )


@rt("/suppliers/{supplier_id}/edit")
def get(supplier_id: str, session):
    """Show form to edit an existing supplier."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования поставщиков.", cls="alert alert-error"),
            session=session
        )

    from services.supplier_service import get_supplier

    supplier = get_supplier(supplier_id)

    if not supplier:
        return page_layout("Поставщик не найден",
            Div("Запрашиваемый поставщик не существует.", cls="alert alert-error"),
            btn_link("К списку поставщиков", href="/suppliers", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    return _supplier_form(supplier=supplier, session=session)


@rt("/suppliers/{supplier_id}/edit")
def post(
    supplier_id: str,
    supplier_code: str,
    name: str,
    country: str = "",
    city: str = "",
    inn: str = "",
    kpp: str = "",
    contact_person: str = "",
    contact_email: str = "",
    contact_phone: str = "",
    default_payment_terms: str = "",
    is_active: str = "",
    session=None
):
    """Handle supplier edit form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования поставщиков.", cls="alert alert-error"),
            session=session
        )

    from services.supplier_service import get_supplier, update_supplier, validate_supplier_code

    # Get current supplier for error display
    supplier = get_supplier(supplier_id)
    if not supplier:
        return page_layout("Поставщик не найден",
            Div("Запрашиваемый поставщик не существует.", cls="alert alert-error"),
            session=session
        )

    # Normalize supplier code to uppercase
    supplier_code = supplier_code.strip().upper() if supplier_code else ""

    # Validate supplier code format
    if not supplier_code or not validate_supplier_code(supplier_code):
        return _supplier_form(
            supplier=supplier,
            error="Код поставщика должен состоять из 3 заглавных латинских букв",
            session=session
        )

    try:
        # is_active is "true" if checkbox is checked, "" if not
        is_active_bool = is_active == "true"

        updated_supplier = update_supplier(
            supplier_id=supplier_id,
            name=name.strip(),
            supplier_code=supplier_code,
            country=country.strip() or None,
            city=city.strip() or None,
            inn=inn.strip() or None,
            kpp=kpp.strip() or None,
            contact_person=contact_person.strip() or None,
            contact_email=contact_email.strip() or None,
            contact_phone=contact_phone.strip() or None,
            default_payment_terms=default_payment_terms.strip() or None,
            is_active=is_active_bool,
        )

        if updated_supplier:
            return RedirectResponse(f"/suppliers/{supplier_id}", status_code=303)
        else:
            return _supplier_form(
                supplier=supplier,
                error="Ошибка при обновлении поставщика",
                session=session
            )

    except ValueError as e:
        return _supplier_form(supplier=supplier, error=str(e), session=session)
    except Exception as e:
        print(f"Error updating supplier: {e}")
        return _supplier_form(supplier=supplier, error=f"Ошибка при обновлении: {e}", session=session)


@rt("/suppliers/{supplier_id}/delete")
def post(supplier_id: str, session):
    """Handle supplier deletion (deactivation)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - only admin can delete
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("Только администратор может удалять поставщиков.", cls="alert alert-error"),
            session=session
        )

    from services.supplier_service import deactivate_supplier

    result = deactivate_supplier(supplier_id)

    if result:
        return RedirectResponse("/suppliers", status_code=303)
    else:
        return page_layout("Ошибка",
            Div("Не удалось деактивировать поставщика.", cls="alert alert-error"),
            btn_link("К списку поставщиков", href="/suppliers", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# BUYER COMPANIES LIST - Redirect to /companies page
# ============================================================================

@rt("/buyer-companies")
def get(session):
    """Redirect standalone buyer companies list to unified /companies page."""
    return RedirectResponse("/companies?tab=buyer_companies", status_code=303)


@rt("/buyer-companies/new")
def get(session):
    """Show form to create a new buyer company."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания компаний-покупателей. Требуется роль: admin", cls="alert alert-error"),
            session=session
        )

    return _buyer_company_form(session=session)


@rt("/buyer-companies/new")
def post(
    company_code: str,
    name: str,
    country: str = "Россия",
    inn: str = "",
    kpp: str = "",
    ogrn: str = "",
    registration_address: str = "",
    general_director_position: str = "Генеральный директор",
    general_director_name: str = "",
    session=None
):
    """Handle buyer company creation form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания компаний-покупателей.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")
    user_id = user.get("id")

    from services.buyer_company_service import (
        create_buyer_company, validate_company_code, validate_inn, validate_kpp, validate_ogrn
    )

    # Normalize company code to uppercase
    company_code = company_code.strip().upper() if company_code else ""

    # Validate company code format
    if not company_code or not validate_company_code(company_code):
        return _buyer_company_form(
            error="Код компании должен состоять из 3 заглавных латинских букв",
            session=session
        )

    # Validate INN (required for buyer companies)
    inn_clean = inn.strip() if inn else ""
    if not inn_clean:
        return _buyer_company_form(
            error="ИНН обязателен для компании-покупателя",
            session=session
        )
    if not validate_inn(inn_clean):
        return _buyer_company_form(
            error="ИНН должен состоять из 10 цифр (для юридического лица)",
            session=session
        )

    # Validate KPP (optional)
    kpp_clean = kpp.strip() if kpp else ""
    if kpp_clean and not validate_kpp(kpp_clean):
        return _buyer_company_form(
            error="КПП должен состоять из 9 цифр",
            session=session
        )

    # Validate OGRN (optional)
    ogrn_clean = ogrn.strip() if ogrn else ""
    if ogrn_clean and not validate_ogrn(ogrn_clean):
        return _buyer_company_form(
            error="ОГРН должен состоять из 13 цифр",
            session=session
        )

    try:
        company = create_buyer_company(
            organization_id=org_id,
            name=name.strip(),
            company_code=company_code,
            country=country.strip() or "Россия",
            inn=inn_clean,
            kpp=kpp_clean or None,
            ogrn=ogrn_clean or None,
            registration_address=registration_address.strip() or None,
            general_director_position=general_director_position.strip() or "Генеральный директор",
            general_director_name=general_director_name.strip() or None,
            is_active=True,
            created_by=user_id,
        )

        if company:
            return RedirectResponse(f"/buyer-companies/{company.id}", status_code=303)
        else:
            return _buyer_company_form(
                error="Компания с таким кодом или ИНН уже существует",
                session=session
            )

    except ValueError as e:
        return _buyer_company_form(error=str(e), session=session)
    except Exception as e:
        print(f"Error creating buyer company: {e}")
        return _buyer_company_form(error=f"Ошибка при создании: {e}", session=session)


@rt("/buyer-companies/{company_id}")
def get(company_id: str, session):
    """View single buyer company details."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра компаний-покупателей.", cls="alert alert-error"),
            session=session
        )

    from services.buyer_company_service import get_buyer_company

    company = get_buyer_company(company_id)

    if not company:
        return page_layout("Компания не найдена",
            Div(
                H1(icon("x-circle", size=28), " Компания не найдена", cls="page-header"),
                P("Запрашиваемая компания-покупатель не существует."),
                btn_link("К списку компаний", href="/companies?tab=buyer_companies", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    status_text = "Активна" if company.is_active else "Неактивна"

    return page_layout(f"Компания: {company.name}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Компании-покупатели", href="/companies?tab=buyer_companies",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("building-2", size=24, color="#8b5cf6"),
                        H1(company.name, style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        Span(company.company_code, style="font-family: monospace; font-size: 14px; padding: 4px 10px; background: #f3e8ff; color: #7c3aed; border-radius: 6px; font-weight: 600;"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span(status_text, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {'#16a34a' if company.is_active else '#dc2626'}; background: {'#dcfce7' if company.is_active else '#fee2e2'};"),
                        btn_link("Редактировать", href=f"/buyer-companies/{company_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Main info cards grid
        Div(
            # Card 1: Company Info
            Div(
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Код компании", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.company_code, style="font-weight: 600; color: #7c3aed; font-family: monospace; font-size: 16px;"),
                    ),
                    Div(
                        Span("Название", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.name, style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Страна", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.country or "Россия", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Card 2: Director
            Div(
                Div(
                    icon("user", size=16, color="#64748b"),
                    Span("РУКОВОДСТВО", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Должность", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.general_director_position or "Генеральный директор", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("ФИО", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.general_director_name or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;"
        ),

        # Legal info
        Div(
            Div(
                icon("file-text", size=16, color="#64748b"),
                Span("ЮРИДИЧЕСКИЕ ДАННЫЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            Div(
                Div(
                    Span("ИНН", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.inn or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("КПП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.kpp or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("ОГРН", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.ogrn or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;"
            ),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Registration address
        Div(
            Div(
                icon("map-pin", size=16, color="#64748b"),
                Span("ЮРИДИЧЕСКИЙ АДРЕС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;"
            ),
            P(company.registration_address or "Не указан", style="font-size: 14px; color: #1e293b; margin: 0;"),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if company.registration_address else "",

        # Metadata
        Div(
            Div(
                Span("Создана", style="font-size: 11px; color: #94a3b8; text-transform: uppercase;"),
                Span(f"{company.created_at.strftime('%d.%m.%Y %H:%M') if company.created_at else '—'}", style="font-size: 13px; color: #64748b; margin-left: 8px;"),
                style="display: flex; align-items: center; gap: 4px;"
            ),
            Div(
                Span("Обновлена", style="font-size: 11px; color: #94a3b8; text-transform: uppercase;"),
                Span(f"{company.updated_at.strftime('%d.%m.%Y %H:%M') if company.updated_at else '—'}", style="font-size: 13px; color: #64748b; margin-left: 8px;"),
                style="display: flex; align-items: center; gap: 4px;"
            ),
            style="display: flex; gap: 24px; padding: 12px 0; border-top: 1px solid #e2e8f0;"
        ),

        session=session
    )


# ============================================================================
# BUYER COMPANY FORM (Feature UI-004)
# ============================================================================

def _buyer_company_form(company=None, error=None, session=None):
    """
    Render buyer company create/edit form.

    Args:
        company: Existing BuyerCompany object for edit mode, None for create mode
        error: Error message to display
        session: Session object for page layout
    """
    is_edit = company is not None
    title = "Редактирование компании-покупателя" if is_edit else "Новая компания-покупатель"
    action_url = f"/buyer-companies/{company.id}/edit" if is_edit else "/buyer-companies/new"

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    return page_layout(title,
        # Error alert
        Div(
            icon("alert-circle", size=16, color="#dc2626"),
            Span(error, style="margin-left: 8px;"),
            style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ) if error else "",

        # Header card with gradient
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#64748b"),
                    Span("Компании-покупатели", style="margin-left: 6px;"),
                    href="/companies?tab=buyer_companies",
                    style="display: inline-flex; align-items: center; color: #64748b; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("building-2" if not is_edit else "edit", size=24, color="#3b82f6"),
                    Span(title, style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    style="display: flex; align-items: center;"
                ),
            ),
            style=header_card_style
        ),

        # Info alert
        Div(
            icon("lightbulb", size=16, color="#0369a1"),
            Span(" Компания-покупатель — наше юридическое лицо, через которое мы закупаем товар у поставщиков. Привязывается к позиции КП.", style="margin-left: 8px;"),
            style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ),

        # Form card
        Div(
            Form(
                # Section: Main info
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Код компании *", style=label_style),
                        Input(
                            name="company_code",
                            value=company.company_code if company else "",
                            placeholder="ZAK",
                            required=True,
                            maxlength="3",
                            pattern="[A-Z]{3}",
                            title="3 заглавные латинские буквы",
                            style=f"{input_style} text-transform: uppercase; font-family: monospace; font-weight: bold;"
                        ),
                        Small("3 заглавные латинские буквы (например: ZAK, CMT)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Название компании *", style=label_style),
                        Input(name="name", value=company.name if company else "", placeholder='ООО "Закупки"', required=True, style=input_style),
                        style="flex: 2;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Страна", style=label_style),
                        Input(name="country", value=company.country if company else "Россия", placeholder="Россия", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 1;"),  # Spacer
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Legal info
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ЮРИДИЧЕСКИЕ ДАННЫЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("ИНН *", style=label_style),
                        Input(name="inn", value=company.inn if company else "", placeholder="1234567890", pattern="\\d{10}", title="10 цифр для юридического лица", required=True, style=input_style),
                        Small("10 цифр (ИНН юридического лица)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("КПП", style=label_style),
                        Input(name="kpp", value=company.kpp if company else "", placeholder="123456789", pattern="\\d{9}", title="9 цифр", style=input_style),
                        Small("9 цифр", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("ОГРН", style=label_style),
                        Input(name="ogrn", value=company.ogrn if company else "", placeholder="1234567890123", pattern="\\d{13}", title="13 цифр", style=input_style),
                        Small("13 цифр", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 1;"),  # Spacer
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Registration address
                Div(
                    icon("map-pin", size=16, color="#64748b"),
                    Span("ЮРИДИЧЕСКИЙ АДРЕС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Label("Адрес регистрации", style=label_style),
                    Textarea(
                        company.registration_address if company else "",
                        name="registration_address",
                        placeholder="123456, г. Москва, ул. Примерная, д. 1",
                        rows="2",
                        style=f"{input_style} resize: vertical;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Section: Director info
                Div(
                    icon("user", size=16, color="#64748b"),
                    Span("РУКОВОДСТВО (ДЛЯ ДОКУМЕНТОВ)", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("Должность руководителя", style=label_style),
                        Input(name="general_director_position", value=company.general_director_position if company else "Генеральный директор", placeholder="Генеральный директор", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("ФИО руководителя", style=label_style),
                        Input(name="general_director_name", value=company.general_director_name if company else "", placeholder="Иванов Иван Иванович", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Status (for edit mode)
                Div(
                    Div(
                        icon("toggle-left", size=16, color="#64748b"),
                        Span("СТАТУС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style=f"{section_header_style} margin-top: 24px;"
                    ),
                    Label(
                        Input(
                            type="checkbox",
                            name="is_active",
                            checked=company.is_active if company else True,
                            value="true",
                            style="accent-color: #3b82f6; margin-right: 8px;"
                        ),
                        Span("Активная компания", style="font-size: 14px; color: #1e293b;"),
                        style="display: flex; align-items: center; cursor: pointer;"
                    ),
                    Small("Неактивные компании не отображаются в выпадающих списках", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 6px;"),
                ) if is_edit else "",

                # Form actions
                Div(
                    btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/companies?tab=buyer_companies" if not is_edit else f"/buyer-companies/{company.id}", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; margin-top: 24px; border-top: 1px solid #e2e8f0;"
                ),

                method="post",
                action=action_url
            ),
            style=form_card_style
        ),
        session=session
    )


@rt("/buyer-companies/{company_id}/edit")
def get(company_id: str, session):
    """Show form to edit an existing buyer company."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования компаний-покупателей.", cls="alert alert-error"),
            session=session
        )

    from services.buyer_company_service import get_buyer_company

    company = get_buyer_company(company_id)

    if not company:
        return page_layout("Компания не найдена",
            Div("Запрашиваемая компания-покупатель не существует.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=buyer_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    return _buyer_company_form(company=company, session=session)


@rt("/buyer-companies/{company_id}/edit")
def post(
    company_id: str,
    company_code: str,
    name: str,
    country: str = "Россия",
    inn: str = "",
    kpp: str = "",
    ogrn: str = "",
    registration_address: str = "",
    general_director_position: str = "Генеральный директор",
    general_director_name: str = "",
    is_active: str = "",
    session=None
):
    """Handle buyer company edit form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования компаний-покупателей.", cls="alert alert-error"),
            session=session
        )

    from services.buyer_company_service import (
        get_buyer_company, update_buyer_company, validate_company_code,
        validate_inn, validate_kpp, validate_ogrn
    )

    company = get_buyer_company(company_id)
    if not company:
        return page_layout("Компания не найдена",
            Div("Запрашиваемая компания-покупатель не существует.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=buyer_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Normalize company code to uppercase
    company_code = company_code.strip().upper() if company_code else ""

    # Validate company code format
    if not company_code or not validate_company_code(company_code):
        return _buyer_company_form(
            company=company,
            error="Код компании должен состоять из 3 заглавных латинских букв",
            session=session
        )

    # Validate INN (required)
    inn_clean = inn.strip() if inn else ""
    if not inn_clean:
        return _buyer_company_form(
            company=company,
            error="ИНН обязателен для компании-покупателя",
            session=session
        )
    if not validate_inn(inn_clean):
        return _buyer_company_form(
            company=company,
            error="ИНН должен состоять из 10 цифр (для юридического лица)",
            session=session
        )

    # Validate KPP (optional)
    kpp_clean = kpp.strip() if kpp else ""
    if kpp_clean and not validate_kpp(kpp_clean):
        return _buyer_company_form(
            company=company,
            error="КПП должен состоять из 9 цифр",
            session=session
        )

    # Validate OGRN (optional)
    ogrn_clean = ogrn.strip() if ogrn else ""
    if ogrn_clean and not validate_ogrn(ogrn_clean):
        return _buyer_company_form(
            company=company,
            error="ОГРН должен состоять из 13 цифр",
            session=session
        )

    # Checkbox handling: is_active
    active = is_active == "true"

    try:
        updated = update_buyer_company(
            company_id=company_id,
            name=name.strip(),
            company_code=company_code,
            country=country.strip() or "Россия",
            inn=inn_clean,
            kpp=kpp_clean or None,
            ogrn=ogrn_clean or None,
            registration_address=registration_address.strip() or None,
            general_director_position=general_director_position.strip() or "Генеральный директор",
            general_director_name=general_director_name.strip() or None,
            is_active=active,
        )

        if updated:
            return RedirectResponse(f"/buyer-companies/{company_id}", status_code=303)
        else:
            return _buyer_company_form(
                company=company,
                error="Не удалось обновить компанию. Возможно, код или ИНН уже используются другой компанией.",
                session=session
            )

    except ValueError as e:
        return _buyer_company_form(company=company, error=str(e), session=session)
    except Exception as e:
        print(f"Error updating buyer company: {e}")
        return _buyer_company_form(company=company, error=f"Ошибка при обновлении: {e}", session=session)


@rt("/buyer-companies/{company_id}/delete")
def post(company_id: str, session):
    """Handle buyer company deletion (soft delete - deactivate)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("Только администратор может удалять компании-покупатели.", cls="alert alert-error"),
            session=session
        )

    from services.buyer_company_service import deactivate_buyer_company

    result = deactivate_buyer_company(company_id)

    if result:
        return RedirectResponse("/companies?tab=buyer_companies", status_code=303)
    else:
        return page_layout("Ошибка",
            Div("Не удалось деактивировать компанию.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=buyer_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# SELLER COMPANIES MANAGEMENT (UI-005, UI-006)
# ============================================================================

@rt("/seller-companies")
def get(session):
    """Redirect standalone seller companies list to unified /companies page."""
    return RedirectResponse("/companies?tab=seller_companies", status_code=303)


@rt("/seller-companies/new")
def get(session):
    """Show form to create a new seller company."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания компаний-продавцов. Требуется роль: admin", cls="alert alert-error"),
            session=session
        )

    return _seller_company_form(session=session)


@rt("/seller-companies/new")
def post(
    supplier_code: str,
    name: str,
    country: str = "Россия",
    inn: str = "",
    kpp: str = "",
    ogrn: str = "",
    registration_address: str = "",
    general_director_position: str = "Генеральный директор",
    general_director_name: str = "",
    session=None
):
    """Handle seller company creation form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания компаний-продавцов.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")
    user_id = user.get("id")

    from services.seller_company_service import (
        create_seller_company, validate_supplier_code, validate_inn, validate_kpp, validate_ogrn
    )

    # Normalize supplier code to uppercase
    supplier_code = supplier_code.strip().upper() if supplier_code else ""

    # Validate supplier code format
    if not supplier_code or not validate_supplier_code(supplier_code):
        return _seller_company_form(
            error="Код компании должен состоять из 3 заглавных латинских букв (например, MBR, CMT, GES)",
            session=session
        )

    # Validate INN (optional but if provided must be valid)
    inn_clean = inn.strip() if inn else ""
    if inn_clean and not validate_inn(inn_clean):
        return _seller_company_form(
            error="ИНН должен состоять из 10 цифр (юрлицо) или 12 цифр (ИП)",
            session=session
        )

    # Validate KPP (optional)
    kpp_clean = kpp.strip() if kpp else ""
    if kpp_clean and not validate_kpp(kpp_clean):
        return _seller_company_form(
            error="КПП должен состоять из 9 цифр",
            session=session
        )

    # Validate OGRN (optional)
    ogrn_clean = ogrn.strip() if ogrn else ""
    if ogrn_clean and not validate_ogrn(ogrn_clean):
        return _seller_company_form(
            error="ОГРН должен состоять из 13 цифр (юрлицо) или 15 цифр (ИП)",
            session=session
        )

    try:
        company = create_seller_company(
            organization_id=org_id,
            name=name.strip(),
            supplier_code=supplier_code,
            country=country.strip() or "Россия",
            inn=inn_clean or None,
            kpp=kpp_clean or None,
            ogrn=ogrn_clean or None,
            registration_address=registration_address.strip() or None,
            general_director_position=general_director_position.strip() or "Генеральный директор",
            general_director_name=general_director_name.strip() or None,
            is_active=True,
            created_by=user_id,
        )

        if company:
            return RedirectResponse(f"/seller-companies/{company.id}", status_code=303)
        else:
            return _seller_company_form(
                error="Компания с таким кодом или ИНН уже существует",
                session=session
            )

    except ValueError as e:
        return _seller_company_form(error=str(e), session=session)
    except Exception as e:
        print(f"Error creating seller company: {e}")
        return _seller_company_form(error=f"Ошибка при создании: {e}", session=session)


@rt("/seller-companies/{company_id}")
def get(company_id: str, session):
    """Seller company detail view page."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра данной страницы.", cls="alert alert-error"),
            session=session
        )

    from services.seller_company_service import get_seller_company

    company = get_seller_company(company_id)
    if not company:
        return page_layout("Не найдено",
            Div("Компания-продавец не найдена.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=seller_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    status_text = "Активна" if company.is_active else "Неактивна"

    return page_layout(f"Компания: {company.name}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Компании-продавцы", href="/companies?tab=seller_companies",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("building-2", size=24, color="#f97316"),
                        H1(company.name, style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        Span(company.supplier_code, style="font-family: monospace; font-size: 14px; padding: 4px 10px; background: #fff7ed; color: #ea580c; border-radius: 6px; font-weight: 600;"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span(status_text, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {'#16a34a' if company.is_active else '#dc2626'}; background: {'#dcfce7' if company.is_active else '#fee2e2'};"),
                        btn_link("Редактировать", href=f"/seller-companies/{company_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Main info cards grid
        Div(
            # Card 1: Company Info
            Div(
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Код компании", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.supplier_code, style="font-weight: 600; color: #ea580c; font-family: monospace; font-size: 16px;"),
                    ),
                    Div(
                        Span("Название", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.name, style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Страна", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.country or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Card 2: Director
            Div(
                Div(
                    icon("user", size=16, color="#64748b"),
                    Span("РУКОВОДИТЕЛЬ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("ФИО директора", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.general_director_name or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Должность", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(company.general_director_position or "Генеральный директор", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; gap: 12px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;"
        ),

        # Legal info
        Div(
            Div(
                icon("file-text", size=16, color="#64748b"),
                Span("ЮРИДИЧЕСКИЕ РЕКВИЗИТЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            Div(
                Div(
                    Span("ИНН", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.inn or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("КПП", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.kpp or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("ОГРН", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(company.ogrn or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 16px;"
            ),
            Div(
                Span("Юридический адрес", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                Div(company.registration_address or "—", style="font-weight: 500; color: #1e293b; font-size: 14px; margin-top: 4px;"),
            ),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        session=session
    )


# -----------------------------------------------------------------------------
# UI-006: Seller Company Form (Create/Edit)
# -----------------------------------------------------------------------------

def _seller_company_form(
    company: "SellerCompany | None" = None,
    error: str = "",
    session=None
):
    """
    Render create/edit form for seller companies.

    Args:
        company: Existing company (for edit mode), None for create mode
        error: Error message to display
        session: User session

    Returns:
        Page layout with seller company form
    """
    is_edit = company is not None
    title = f"Редактировать: {company.name}" if is_edit else "Новая компания-продавец"
    action_url = f"/seller-companies/{company.id}/edit" if is_edit else "/seller-companies/new"

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-radius: 12px;
        border: 1px solid #fde68a;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    return page_layout(title,
        # Error alert
        Div(
            icon("alert-circle", size=16, color="#dc2626"),
            Span(error, style="margin-left: 8px;"),
            style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ) if error else "",

        # Header card with gradient (orange theme for seller)
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#92400e"),
                    Span("Компании-продавцы", style="margin-left: 6px;"),
                    href="/companies?tab=seller_companies",
                    style="display: inline-flex; align-items: center; color: #92400e; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("store" if not is_edit else "edit", size=24, color="#d97706"),
                    Span(title, style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    style="display: flex; align-items: center;"
                ),
            ),
            style=header_card_style
        ),

        # Info alert
        Div(
            icon("lightbulb", size=16, color="#0369a1"),
            Span(" Компания-продавец — это наше юридическое лицо, от имени которого мы продаём товары клиентам. Код компании (3 буквы) используется для генерации IDN коммерческого предложения.", style="margin-left: 8px;"),
            style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ),

        # Form card
        Div(
            Form(
                # Section: Main info
                Div(
                    icon("building", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Код компании *", style=label_style),
                        Input(
                            name="supplier_code",
                            value=company.supplier_code if company else "",
                            placeholder="MBR",
                            pattern="[A-Za-z]{3}",
                            maxlength="3",
                            required=True,
                            title="3 буквы латиницей (например, MBR, CMT, GES)",
                            style=f"{input_style} text-transform: uppercase; font-family: monospace; font-weight: bold;"
                        ),
                        Small("3 буквы латиницей (используется в IDN)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Название компании *", style=label_style),
                        Input(name="name", value=company.name if company else "", placeholder="ООО «МАСТЕР БЭРИНГ»", required=True, style=input_style),
                        style="flex: 2;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Страна", style=label_style),
                        Input(name="country", value=company.country if company else "Россия", placeholder="Россия", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 1;"),  # Spacer
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Legal info
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ЮРИДИЧЕСКИЕ РЕКВИЗИТЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                # Info note about legal IDs
                Div(
                    icon("info", size=14, color="#0369a1"),
                    Span(" ИНН: 10 цифр для юрлиц, 12 цифр для ИП. ОГРН: 13 цифр для юрлиц, 15 цифр для ИП.", style="margin-left: 6px;"),
                    style="background: #f0f9ff; color: #0369a1; padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; display: flex; align-items: center;"
                ),
                Div(
                    Div(
                        Label("ИНН", style=label_style),
                        Input(name="inn", value=company.inn if company else "", placeholder="1234567890 или 123456789012", pattern="\\d{10}|\\d{12}", title="10 цифр для юрлица или 12 цифр для ИП", style=input_style),
                        Small("10 цифр (юрлицо) или 12 цифр (ИП)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("КПП", style=label_style),
                        Input(name="kpp", value=company.kpp if company else "", placeholder="123456789", pattern="\\d{9}", title="9 цифр (только для юрлиц)", style=input_style),
                        Small("9 цифр (только для юрлиц)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("ОГРН", style=label_style),
                        Input(name="ogrn", value=company.ogrn if company else "", placeholder="1234567890123 или 123456789012345", pattern="\\d{13}|\\d{15}", title="13 цифр для юрлица или 15 цифр для ИП", style=input_style),
                        Small("13 цифр (юрлицо) или 15 цифр (ИП)", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 1;"),  # Spacer
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Section: Registration address
                Div(
                    icon("map-pin", size=16, color="#64748b"),
                    Span("ЮРИДИЧЕСКИЙ АДРЕС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Label("Адрес регистрации", style=label_style),
                    Textarea(
                        company.registration_address if company else "",
                        name="registration_address",
                        placeholder="123456, г. Москва, ул. Примерная, д. 1, офис 100",
                        rows="2",
                        style=f"{input_style} resize: vertical;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Section: Director info
                Div(
                    icon("user", size=16, color="#64748b"),
                    Span("РУКОВОДСТВО (ДЛЯ ДОКУМЕНТОВ)", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Div(
                        Label("Должность руководителя", style=label_style),
                        Input(name="general_director_position", value=company.general_director_position if company else "Генеральный директор", placeholder="Генеральный директор", style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("ФИО руководителя", style=label_style),
                        Input(name="general_director_name", value=company.general_director_name if company else "", placeholder="Иванов Иван Иванович", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 20px;"
                ),

                # Status (for edit mode)
                Div(
                    Div(
                        icon("toggle-left", size=16, color="#64748b"),
                        Span("СТАТУС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style=f"{section_header_style} margin-top: 24px;"
                    ),
                    Label(
                        Input(
                            type="checkbox",
                            name="is_active",
                            checked=company.is_active if company else True,
                            value="true",
                            style="accent-color: #d97706; margin-right: 8px;"
                        ),
                        Span("Активная компания", style="font-size: 14px; color: #1e293b;"),
                        style="display: flex; align-items: center; cursor: pointer;"
                    ),
                    Small("Неактивные компании не отображаются в выпадающих списках при создании КП", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 6px;"),
                ) if is_edit else "",

                # Form actions
                Div(
                    btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/companies?tab=seller_companies" if not is_edit else f"/seller-companies/{company.id}", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; margin-top: 24px; border-top: 1px solid #e2e8f0;"
                ),

                method="post",
                action=action_url
            ),
            cls="card"
        ),
        session=session
    )


@rt("/seller-companies/{company_id}/edit")
def get(company_id: str, session):
    """Show form to edit an existing seller company."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования компаний-продавцов.", cls="alert alert-error"),
            session=session
        )

    from services.seller_company_service import get_seller_company

    company = get_seller_company(company_id)

    if not company:
        return page_layout("Компания не найдена",
            Div("Запрашиваемая компания-продавец не существует.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=seller_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    return _seller_company_form(company=company, session=session)


@rt("/seller-companies/{company_id}/edit")
def post(
    company_id: str,
    supplier_code: str,
    name: str,
    country: str = "Россия",
    inn: str = "",
    kpp: str = "",
    ogrn: str = "",
    registration_address: str = "",
    general_director_position: str = "Генеральный директор",
    general_director_name: str = "",
    is_active: str = "",
    session=None
):
    """Handle seller company edit form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования компаний-продавцов.", cls="alert alert-error"),
            session=session
        )

    from services.seller_company_service import (
        get_seller_company, update_seller_company, validate_supplier_code,
        validate_inn, validate_kpp, validate_ogrn
    )

    company = get_seller_company(company_id)
    if not company:
        return page_layout("Компания не найдена",
            Div("Запрашиваемая компания-продавец не существует.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=seller_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Normalize supplier code to uppercase
    supplier_code = supplier_code.strip().upper() if supplier_code else ""

    # Validate supplier code format
    if not supplier_code or not validate_supplier_code(supplier_code):
        return _seller_company_form(
            company=company,
            error="Код компании должен состоять из 3 заглавных латинских букв (например, MBR, CMT, GES)",
            session=session
        )

    # Validate INN (optional)
    inn_clean = inn.strip() if inn else ""
    if inn_clean and not validate_inn(inn_clean):
        return _seller_company_form(
            company=company,
            error="ИНН должен состоять из 10 цифр (юрлицо) или 12 цифр (ИП)",
            session=session
        )

    # Validate KPP (optional)
    kpp_clean = kpp.strip() if kpp else ""
    if kpp_clean and not validate_kpp(kpp_clean):
        return _seller_company_form(
            company=company,
            error="КПП должен состоять из 9 цифр",
            session=session
        )

    # Validate OGRN (optional)
    ogrn_clean = ogrn.strip() if ogrn else ""
    if ogrn_clean and not validate_ogrn(ogrn_clean):
        return _seller_company_form(
            company=company,
            error="ОГРН должен состоять из 13 цифр (юрлицо) или 15 цифр (ИП)",
            session=session
        )

    # Checkbox handling: is_active
    active = is_active == "true"

    try:
        updated = update_seller_company(
            company_id=company_id,
            name=name.strip(),
            supplier_code=supplier_code,
            country=country.strip() or "Россия",
            inn=inn_clean or None,
            kpp=kpp_clean or None,
            ogrn=ogrn_clean or None,
            registration_address=registration_address.strip() or None,
            general_director_position=general_director_position.strip() or "Генеральный директор",
            general_director_name=general_director_name.strip() or None,
            is_active=active,
        )

        if updated:
            return RedirectResponse(f"/seller-companies/{company_id}", status_code=303)
        else:
            return _seller_company_form(
                company=company,
                error="Не удалось обновить компанию. Возможно, код или ИНН уже используются другой компанией.",
                session=session
            )

    except ValueError as e:
        return _seller_company_form(company=company, error=str(e), session=session)
    except Exception as e:
        print(f"Error updating seller company: {e}")
        return _seller_company_form(company=company, error=f"Ошибка при обновлении: {e}", session=session)


@rt("/seller-companies/{company_id}/delete")
def post(company_id: str, session):
    """Handle seller company deletion (soft delete - deactivate)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("Только администратор может удалять компании-продавцы.", cls="alert alert-error"),
            session=session
        )

    from services.seller_company_service import deactivate_seller_company

    result = deactivate_seller_company(company_id)

    if result:
        return RedirectResponse("/companies?tab=seller_companies", status_code=303)
    else:
        return page_layout("Ошибка",
            Div("Не удалось деактивировать компанию.", cls="alert alert-error"),
            btn_link("К списку компаний", href="/companies?tab=seller_companies", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# CUSTOMERS MANAGEMENT (UI-007, UI-008) - Feature v3.0
# ============================================================================

@rt("/customers")
def get(session, q: str = "", status: str = ""):
    """
    Customers list page with search, filters, and contacts preview.

    Customers are external companies that buy from us (at quote level).
    Each customer can have multiple contacts (ЛПР - decision makers).
    The is_signatory contact is used for specification PDF generation.

    Query Parameters:
        q: Search query (matches name or INN)
        status: Filter by status ("active", "inactive", or "" for all)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - sales, admin, or top_manager can view customers
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div(
                H1("⛔ Доступ запрещён"),
                P("У вас нет прав для просмотра справочника клиентов."),
                P("Требуется одна из ролей: admin, sales, top_manager"),
                btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    # Import customer service functions
    from services.customer_service import (
        get_all_customers, search_customers, get_customer_stats,
        get_contacts_for_customer, count_contacts
    )

    # Get customers based on filters
    try:
        if q and q.strip():
            # Use search if query provided
            is_active_filter = None if status == "" else (status == "active")
            customers = search_customers(
                organization_id=org_id,
                query=q.strip(),
                is_active=is_active_filter,
                limit=100
            )
        else:
            # Get all with filters
            is_active_filter = None if status == "" else (status == "active")
            customers = get_all_customers(
                organization_id=org_id,
                is_active=is_active_filter,
                limit=100
            )

        # Get stats for summary
        stats = get_customer_stats(organization_id=org_id)

        # Fetch contacts for each customer for preview
        customer_contacts_map = {}
        for customer in customers:
            contacts = get_contacts_for_customer(customer.id)
            customer_contacts_map[customer.id] = contacts

    except Exception as e:
        print(f"Error loading customers: {e}")
        customers = []
        stats = {"total": 0, "active": 0, "inactive": 0, "with_contacts": 0, "with_signatory": 0}
        customer_contacts_map = {}

    # Status options for filter
    status_options = [
        Option("Все статусы", value="", selected=(status == "")),
        Option("Активные", value="active", selected=(status == "active")),
        Option("Неактивные", value="inactive", selected=(status == "inactive")),
    ]

    # Build customer rows with contacts preview
    customer_rows = []
    for c in customers:
        status_class = "status-success" if c.is_active else "status-neutral"
        status_text = "Активен" if c.is_active else "Неактивен"

        # Build contacts preview
        contacts = customer_contacts_map.get(c.id, [])
        contacts_preview = []
        if contacts:
            for contact in contacts[:3]:  # Show up to 3 contacts
                badges = []
                if contact.is_signatory:
                    badges.append(Span(icon("pen-tool", size=10), " подписант", cls="badge badge-primary", style="font-size: 0.7em; margin-left: 0.3rem; display: inline-flex; align-items: center; gap: 0.15rem;"))
                if contact.is_primary:
                    badges.append(Span("★ основной", cls="badge badge-info", style="font-size: 0.7em; margin-left: 0.3rem;"))

                contact_line = Div(
                    Span(contact.name, style="font-weight: 500;"),
                    *badges,
                    Small(f" — {contact.position}" if contact.position else "", style="color: #666;"),
                    style="margin-bottom: 0.2rem;"
                )
                contacts_preview.append(contact_line)

            if len(contacts) > 3:
                contacts_preview.append(Small(f"... ещё {len(contacts) - 3}", style="color: #888;"))
        else:
            contacts_preview.append(Small("Нет контактов", style="color: #999;"))

        customer_rows.append(
            Tr(
                Td(
                    Div(
                        A(Strong(c.name), href=f"/customers/{c.id}", style="color: var(--accent); text-decoration: none;"),
                        Small(f" (ИНН: {c.inn})" if c.inn else "", style="color: #666; margin-left: 0.3rem;")
                    )
                ),
                Td(c.legal_address[:50] + "..." if c.legal_address and len(c.legal_address) > 50 else c.legal_address or "—"),
                Td(
                    Div(*contacts_preview),
                    style="min-width: 200px;"
                ),
                Td(c.general_director_name or "—"),
                Td(Span(status_text, cls=f"status-badge {status_class}")),
                Td(
                    A(icon("eye", size=16), href=f"/customers/{c.id}", title="Просмотр", cls="table-action-btn"),
                    A(icon("edit", size=16), href=f"/customers/{c.id}/edit", title="Редактировать", cls="table-action-btn"),
                    cls="col-actions"
                )
            )
        )

    return page_layout("Клиенты",
        # Header
        H1(icon("users", size=28), " Клиенты", cls="page-header"),

        # Info alert
        Div(
            icon("info", size=16), " Клиенты — это внешние компании, которые покупают у нас товары. ",
            "Каждое КП (quote) привязывается к одному клиенту. ",
            "У клиента могут быть несколько контактов (ЛПР). Контакт с флагом ",
            Span(icon("pen-tool", size=14), " подписант", style="font-weight: bold; display: inline-flex; align-items: center; gap: 0.25rem;"),
            " используется для генерации спецификации (PDF).",
            cls="alert alert-info"
        ),

        # Stats cards
        Div(
            Div(
                Div(str(stats.get("total", 0)), cls="stat-value"),
                Div("Всего"),
                cls="stat-card card"
            ),
            Div(
                Div(str(stats.get("active", 0)), cls="stat-value"),
                Div("Активных"),
                cls="stat-card card"
            ),
            Div(
                Div(str(stats.get("with_contacts", 0)), cls="stat-value"),
                Div("С контактами"),
                cls="stat-card card"
            ),
            Div(
                Div(str(stats.get("with_signatory", 0)), cls="stat-value"),
                Div("С подписантом"),
                cls="stat-card card"
            ),
            cls="stats-grid"
        ),

        # Unified Table with search in header
        Div(
            # Table header with search and filters
            Div(
                Div(
                    Form(
                        Input(type="text", name="q", value=q, placeholder="Поиск по названию или ИНН...", cls="table-search"),
                        Select(*status_options, name="status", style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);"),
                        btn("Найти", variant="secondary", icon_name="search", type="submit", size="sm"),
                        method="get",
                        action="/customers",
                        style="display: flex; gap: 0.75rem; align-items: center;"
                    ),
                    cls="table-header-left"
                ),
                Div(
                    btn_link("Добавить клиента", href="/customers/new", variant="primary", icon_name="plus"),
                    cls="table-header-right"
                ),
                cls="table-header"
            ),
            # Table
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("НАЗВАНИЕ"),
                            Th("АДРЕС"),
                            Th("КОНТАКТЫ"),
                            Th("ДИРЕКТОР"),
                            Th("СТАТУС"),
                            Th("", cls="col-actions"),
                        )
                    ),
                    Tbody(*customer_rows) if customer_rows else Tbody(
                        Tr(Td("Клиенты не найдены", colspan="6", style="text-align: center; padding: 2rem; color: #666;"))
                    ),
                    cls="unified-table"
                ),
                cls="table-responsive"
            ),
            # Table footer
            Div(
                Span(f"Всего: {len(customers)} клиентов"),
                cls="table-footer"
            ),
            cls="table-container"
        ),

        session=session
    )


def _stat_card_simple(value: str, label: str, description: str = None):
    """Simple stat card without DaisyUI borders."""
    return Div(
        Div(label, style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;"),
        Div(value, style="font-size: 1.75rem; font-weight: 600; color: #e2e8f0;"),
        Div(description, style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;") if description else None,
        style="background: linear-gradient(135deg, #2d2d44 0%, #1e1e2f 100%); border-radius: 0.75rem; padding: 1rem; text-align: center;"
    )


@rt("/customers/{customer_id}")
def get(customer_id: str, session, request, tab: str = "general"):
    """Customer detail view page with tabbed interface."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - sales, admin, or top_manager can view customers
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра данной страницы.", cls="alert alert-error"),
            session=session
        )

    from services.customer_service import get_customer_with_contacts

    customer = get_customer_with_contacts(customer_id)
    if not customer:
        return page_layout("Не найдено",
            Div("Клиент не найден.", cls="alert alert-error"),
            btn_link("К списку клиентов", href="/customers", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Tab navigation using DaisyUI tabs (short labels to prevent wrapping)
    tabs_nav = tab_nav([
        {'id': 'general', 'label': 'Общая', 'url': f'/customers/{customer_id}?tab=general'},
        {'id': 'addresses', 'label': 'Адреса', 'url': f'/customers/{customer_id}?tab=addresses'},
        {'id': 'contacts', 'label': 'Контакты', 'url': f'/customers/{customer_id}?tab=contacts'},
        {'id': 'contracts', 'label': 'Договоры', 'url': f'/customers/{customer_id}?tab=contracts'},
        {'id': 'quotes', 'label': 'КП', 'url': f'/customers/{customer_id}?tab=quotes'},
        {'id': 'specifications', 'label': 'Спеки', 'url': f'/customers/{customer_id}?tab=specifications'},
        {'id': 'requested_items', 'label': 'Позиции', 'url': f'/customers/{customer_id}?tab=requested_items'},
        {'id': 'additional', 'label': 'Ещё', 'url': f'/customers/{customer_id}?tab=additional'},
        {'id': 'calls', 'label': 'Звонки', 'url': f'/customers/{customer_id}?tab=calls'},
        {'id': 'meetings', 'label': 'Встречи', 'url': f'/customers/{customer_id}?tab=meetings'},
    ], active_tab=tab, target_id="tab-content")

    # Build tab content based on selected tab
    if tab == "general":
        from services.customer_service import get_customer_statistics, get_customer_quotes, get_customer_specifications, get_customer_contracts
        from datetime import datetime

        # Get statistics
        stats = get_customer_statistics(customer_id)

        # Get latest quotes and specifications (for summary)
        all_quotes = get_customer_quotes(customer_id)
        all_specs = get_customer_specifications(customer_id)
        latest_quotes = all_quotes[:5] if all_quotes else []
        latest_specs = all_specs[:5] if all_specs else []

        # Get contracts for preview
        contracts = get_customer_contracts(customer_id)

        # Format dates
        created_at = ""
        if customer.created_at:
            created_at = customer.created_at.strftime("%d.%m.%Y %H:%M")

        updated_at = ""
        if customer.updated_at:
            updated_at = customer.updated_at.strftime("%d.%m.%Y %H:%M")

        # Helper to render workflow status badge
        def render_status_badge(status):
            status_map = {
                'draft': ('Черновик', 'status-draft'),
                'sent': ('Отправлено', 'status-sent'),
                'approved': ('Одобрено', 'status-approved'),
                'rejected': ('Отклонено', 'status-rejected'),
                'in_progress': ('В работе', 'status-progress'),
                'pending': ('На рассмотрении', 'status-pending'),
                'deal': ('Сделка', 'status-approved'),
            }
            label, cls = status_map.get(status, (status or '—', 'status-draft'))
            return Span(label, cls=f"status-badge {cls}", style="font-size: 0.75rem; padding: 0.25rem 0.5rem;")

        # Build contacts preview items
        contacts_preview_items = []
        for contact in customer.contacts[:5]:
            badges = []
            if contact.is_lpr:
                badges.append(Span("ЛПР", title="Лицо, принимающее решения", style="margin-left: 0.25rem; background: #dbeafe; color: #1d4ed8; padding: 0.1rem 0.35rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600;"))
            if contact.is_signatory:
                badges.append(Span("✏️", title="Подписант", style="margin-left: 0.25rem;"))
            if contact.is_primary:
                badges.append(Span("★", title="Основной", style="margin-left: 0.25rem; color: #f59e0b;"))
            contacts_preview_items.append(
                Div(
                    Div(
                        Span(contact.get_full_name(), style="font-weight: 500; color: #374151;"),
                        *badges,
                        style="display: flex; align-items: center;"
                    ),
                    Div(contact.position or "—", style="font-size: 0.75rem; color: #6b7280;"),
                    style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;"
                )
            )

        # Build contracts preview items
        contracts_preview_items = []
        for contract in contracts[:5]:
            status = contract.get("status", "")
            status_color = "#10b981" if status == "active" else "#6b7280"
            status_text = "активен" if status == "active" else ("истёк" if status == "terminated" else status)
            contracts_preview_items.append(
                Div(
                    Div(
                        Span(f"№{contract.get('contract_number', '—')}", style="font-weight: 500; color: #374151;"),
                        style="display: flex; align-items: center;"
                    ),
                    Div(status_text, style=f"font-size: 0.75rem; color: {status_color};"),
                    style="padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;"
                )
            )

        # Build latest quotes rows
        quotes_rows = []
        for q in latest_quotes:
            q_date = ""
            if q.get("created_at"):
                try:
                    q_date = datetime.fromisoformat(q["created_at"].replace("Z", "+00:00")).strftime("%d.%m.%Y")
                except:
                    q_date = "—"
            quotes_rows.append(
                Tr(
                    Td(A(q.get("idn") or f"#{q['id'][:8]}", href=f"/quotes/{q['id']}", style="font-weight: 500;")),
                    Td(f"{q.get('total_sum', 0):,.0f} ₽", style="text-align: right;"),
                    Td(f"{q.get('total_profit', 0):,.0f} ₽", style="text-align: right; color: #10b981;"),
                    Td(q_date),
                    Td(render_status_badge(q.get("workflow_status"))),
                )
            )

        # Build latest specs rows
        specs_rows = []
        for s in latest_specs:
            s_date = ""
            if s.get("sign_date"):
                try:
                    s_date = datetime.fromisoformat(s["sign_date"].replace("Z", "+00:00")).strftime("%d.%m.%Y")
                except:
                    s_date = "—"
            elif s.get("created_at"):
                try:
                    s_date = datetime.fromisoformat(s["created_at"].replace("Z", "+00:00")).strftime("%d.%m.%Y")
                except:
                    s_date = "—"
            spec_idn = s.get("idn") or (s.get("quotes", {}) or {}).get("idn") or f"#{s['id'][:8]}"
            specs_rows.append(
                Tr(
                    Td(A(spec_idn, href=f"/specifications/{s['id']}", style="font-weight: 500;")),
                    Td(f"{s.get('total_sum', 0):,.0f} ₽", style="text-align: right;"),
                    Td(f"{s.get('total_profit', 0):,.0f} ₽", style="text-align: right; color: #10b981;"),
                    Td(s_date),
                    Td(render_status_badge(s.get("status"))),
                )
            )

        tab_content = Div(
            # Row 1: Three cards side by side with equal height
            Div(
                # Card 1: Company info (narrow, 2 columns layout)
                Div(
                    # Company name (full width)
                    Div(
                        Div("Название", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                        _render_field_display(customer_id, "name", customer.name or ""),
                        style="margin-bottom: 0.5rem;"
                    ),
                    # 2-column grid for fields
                    Div(
                        Div(
                            Div("ИНН", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            _render_field_display(customer_id, "inn", customer.inn or ""),
                        ),
                        Div(
                            Div("КПП", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            _render_field_display(customer_id, "kpp", customer.kpp or ""),
                        ),
                        Div(
                            Div("ОГРН", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            _render_field_display(customer_id, "ogrn", customer.ogrn or ""),
                        ),
                        Div(
                            Div("Статус", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            Span("Активен" if customer.is_active else "Неактивен",
                                 cls=f"status-badge {'status-approved' if customer.is_active else 'status-rejected'}",
                                 style="margin-top: 0.25rem; display: inline-block;"),
                        ),
                        Div(
                            Div("Создан", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            Div(created_at or "—", style="color: #374151; font-size: 0.875rem; padding: 0.25rem 0;"),
                        ),
                        Div(
                            Div("Обновлён", style="color: #6b7280; font-size: 0.7rem; text-transform: uppercase;"),
                            Div(updated_at or "—", style="color: #374151; font-size: 0.875rem; padding: 0.25rem 0;"),
                        ),
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"
                    ),
                    cls="card",
                    style="background: white; border-radius: 0.75rem; padding: 1rem; border: 1px solid #e5e7eb; flex: 1; min-width: 200px;"
                ),

                # Card 2: Contacts preview
                Div(
                    Div(
                        Span(icon("users", size=14), " Контакты", style="color: #374151; display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem; font-weight: 500;"),
                        A("→", href=f"/customers/{customer_id}?tab=contacts",
                          hx_get=f"/customers/{customer_id}?tab=contacts",
                          hx_target="#tab-content",
                          hx_push_url="true",
                          style="font-size: 0.875rem; color: #3b82f6;"),
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
                    ),
                    Div(
                        *contacts_preview_items if contacts_preview_items else [
                            Div("Нет контактов", style="color: #9ca3af; font-size: 0.8rem; text-align: center; padding: 1rem;")
                        ],
                        style="flex: 1; overflow-y: auto;"
                    ),
                    cls="card",
                    style="background: white; border-radius: 0.75rem; padding: 0.75rem; cursor: pointer; border: 1px solid #e5e7eb; flex: 1; display: flex; flex-direction: column;",
                    hx_get=f"/customers/{customer_id}?tab=contacts",
                    hx_target="#tab-content",
                    hx_push_url="true",
                ),

                # Card 3: Contracts preview
                Div(
                    Div(
                        Span(icon("file-text", size=14), " Договоры", style="color: #374151; display: flex; align-items: center; gap: 0.25rem; font-size: 0.875rem; font-weight: 500;"),
                        A("→", href=f"/customers/{customer_id}?tab=contracts",
                          hx_get=f"/customers/{customer_id}?tab=contracts",
                          hx_target="#tab-content",
                          hx_push_url="true",
                          style="font-size: 0.875rem; color: #3b82f6;"),
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
                    ),
                    Div(
                        *contracts_preview_items if contracts_preview_items else [
                            Div("Нет договоров", style="color: #9ca3af; font-size: 0.8rem; text-align: center; padding: 1rem;")
                        ],
                        style="flex: 1; overflow-y: auto;"
                    ),
                    cls="card",
                    style="background: white; border-radius: 0.75rem; padding: 0.75rem; cursor: pointer; border: 1px solid #e5e7eb; flex: 1; display: flex; flex-direction: column;",
                    hx_get=f"/customers/{customer_id}?tab=contracts",
                    hx_target="#tab-content",
                    hx_push_url="true",
                ),
                style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: stretch;"
            ),

            # Row 2: Two tables side by side (Quotes + Specifications) with stats in headers
            Div(
                # Latest Quotes table
                Div(
                    Div(
                        Div(
                            H3(icon("file-text", size=18), " КП", style="margin: 0; color: #374151; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;"),
                            Span(f"Всего: {stats['quotes_count']} • Сумма: {stats['quotes_sum']:,.0f} ₽", style="color: #6b7280; font-size: 0.75rem;"),
                            style="display: flex; flex-direction: column; gap: 0.25rem;"
                        ),
                        A("Все →", href=f"/customers/{customer_id}?tab=quotes",
                          hx_get=f"/customers/{customer_id}?tab=quotes",
                          hx_target="#tab-content",
                          hx_push_url="true",
                          style="font-size: 0.75rem; color: #3b82f6;"),
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;"
                    ),
                    Table(
                        Thead(
                            Tr(
                                Th("№", style="font-size: 0.75rem; color: #6b7280;"),
                                Th("Сумма", style="font-size: 0.75rem; text-align: right; color: #6b7280;"),
                                Th("Профит", style="font-size: 0.75rem; text-align: right; color: #6b7280;"),
                                Th("Дата", style="font-size: 0.75rem; color: #6b7280;"),
                                Th("Статус", style="font-size: 0.75rem; color: #6b7280;"),
                            )
                        ),
                        Tbody(*quotes_rows) if quotes_rows else Tbody(
                            Tr(Td("Нет КП", colspan="5", style="text-align: center; color: #9ca3af; padding: 1rem;"))
                        ),
                        style="font-size: 0.875rem;"
                    ),
                    cls="card",
                    style="background: white; border-radius: 0.75rem; padding: 1rem; flex: 1; border: 1px solid #e5e7eb;"
                ),

                # Latest Specifications table
                Div(
                    Div(
                        Div(
                            H3(icon("clipboard", size=18), " Спецификации", style="margin: 0; color: #374151; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;"),
                            Span(f"Всего: {stats['specifications_count']} • Сумма: {stats['specifications_sum']:,.0f} ₽", style="color: #6b7280; font-size: 0.75rem;"),
                            style="display: flex; flex-direction: column; gap: 0.25rem;"
                        ),
                        A("Все →", href=f"/customers/{customer_id}?tab=specifications",
                          hx_get=f"/customers/{customer_id}?tab=specifications",
                          hx_target="#tab-content",
                          hx_push_url="true",
                          style="font-size: 0.75rem; color: #3b82f6;"),
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;"
                    ),
                    Table(
                        Thead(
                            Tr(
                                Th("№", style="font-size: 0.75rem; color: #6b7280;"),
                                Th("Сумма", style="font-size: 0.75rem; text-align: right; color: #6b7280;"),
                                Th("Профит", style="font-size: 0.75rem; text-align: right; color: #6b7280;"),
                                Th("Дата", style="font-size: 0.75rem; color: #6b7280;"),
                                Th("Статус", style="font-size: 0.75rem; color: #6b7280;"),
                            )
                        ),
                        Tbody(*specs_rows) if specs_rows else Tbody(
                            Tr(Td("Нет спецификаций", colspan="5", style="text-align: center; color: #9ca3af; padding: 1rem;"))
                        ),
                        style="font-size: 0.875rem;"
                    ),
                    cls="card",
                    style="background: white; border-radius: 0.75rem; padding: 1rem; flex: 1; border: 1px solid #e5e7eb;"
                ),
                style="display: flex; gap: 1.5rem;"
            )
        )

    elif tab == "addresses":
        # Show postal address only if it differs from actual_address
        show_postal = customer.postal_address and customer.postal_address != customer.actual_address

        tab_content = Div(
            Div(
                # Legal address with inline editing
                Div(
                    Div(Strong("Юридический адрес"), style="color: #6b7280; font-size: 0.9em; margin-bottom: 0.5rem;"),
                    _render_field_display(customer_id, "legal_address", customer.legal_address or ""),
                    style="margin-bottom: 1.5rem;"
                ),
                # Actual address with inline editing
                Div(
                    Div(Strong("Фактический адрес"), style="color: #6b7280; font-size: 0.9em; margin-bottom: 0.5rem;"),
                    _render_field_display(customer_id, "actual_address", customer.actual_address or ""),
                    style="margin-bottom: 1.5rem;"
                ),
                # Postal address (only if different from actual)
                Div(
                    Div(Strong("Почтовый адрес"), style="color: #6b7280; font-size: 0.9em; margin-bottom: 0.5rem;"),
                    _render_field_display(customer_id, "postal_address", customer.postal_address or ""),
                    style="margin-bottom: 1.5rem;"
                ) if show_postal else Div(
                    Div(Strong("Почтовый адрес"), style="color: #6b7280; font-size: 0.9em; margin-bottom: 0.5rem;"),
                    Div(
                        "Совпадает с фактическим адресом",
                        style="color: #9ca3af; padding: 0.5rem 0.75rem; font-style: italic;"
                    ),
                    style="margin-bottom: 1.5rem;"
                ),
                # Warehouse addresses with dynamic add/delete
                Div(
                    Div(Strong("Адреса складов"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                    _render_warehouses_list(customer_id, customer.warehouse_addresses or []),
                    btn("Добавить адрес склада", variant="secondary", icon_name="plus", type="button",
                        hx_get=f"/customers/{customer_id}/warehouses/add",
                        hx_target="#add-warehouse-form",
                        hx_swap="outerHTML",
                        id="add-warehouse-form"),
                ),
                cls="table-container",
                style="margin: 0; padding: 1.5rem;"
            )
        )

    elif tab == "contacts":
        # Build contacts list with inline editing
        contacts_rows = []
        for contact in customer.contacts:
            contacts_rows.append(_render_contact_row(contact, customer_id))

        # Add button for table header
        add_btn = A(
            icon("plus", size=14), " Добавить",
            href=f"/customers/{customer_id}/contacts/new",
            style="background: var(--accent); color: white; padding: 0.4rem 0.75rem; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; font-weight: 500;"
        )

        tab_content = Div(
            Div(
                Div(
                    Table(
                        Thead(Tr(
                            Th("ФИО"),
                            Th("ДОЛЖНОСТЬ"),
                            Th("EMAIL"),
                            Th("ТЕЛЕФОН"),
                            Th("ЗАМЕТКИ"),
                            Th(add_btn, style="text-align: right;", cls="col-actions")
                        )),
                        Tbody(*contacts_rows, id="contacts-tbody") if contacts_rows else Tbody(
                            Tr(Td("Контакты не добавлены.", colspan="6", style="text-align: center; padding: 2rem; color: #666;")),
                            id="contacts-tbody"
                        ),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                Div(Span(f"Всего: {len(customer.contacts)} контактов"), cls="table-footer"),
                cls="table-container", style="margin: 0;"
            )
        )

    elif tab == "contracts":
        from services.customer_service import get_customer_contracts

        contracts = get_customer_contracts(customer_id)

        contracts_rows = []
        for contract in contracts:
            # Format date
            contract_date = contract.get("contract_date", "")
            if contract_date:
                try:
                    from datetime import datetime
                    dt = datetime.fromisoformat(contract_date.replace("Z", "+00:00"))
                    contract_date = dt.strftime("%d.%m.%Y")
                except:
                    pass

            # Status badge
            status = contract.get("status", "")
            status_text = {
                "active": "Активен",
                "suspended": "Приостановлен",
                "terminated": "Расторгнут"
            }.get(status, status)

            status_class = {
                "active": "status-approved",
                "suspended": "status-pending",
                "terminated": "status-rejected"
            }.get(status, "")

            contracts_rows.append(
                Tr(
                    Td(Strong(contract.get("contract_number", "—"))),
                    Td(contract_date or "—"),
                    Td(Span(status_text, cls=f"status-badge {status_class}")),
                    Td((contract.get("notes") or "—")[:100]),
                    Td(
                        A(icon("file-text", size=16), href=f"/customer-contracts/{contract['id']}", title="Просмотр") if contract.get("id") else "—"
                    )
                )
            )

        add_btn = A(
            icon("plus", size=14), " Добавить",
            href=f"/customer-contracts/new?customer_id={customer_id}",
            style="background: var(--accent); color: white; padding: 0.4rem 0.75rem; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; font-weight: 500;"
        )

        tab_content = Div(
            Div(
                Div(
                    Table(
                        Thead(Tr(
                            Th("НОМЕР"),
                            Th("ДАТА"),
                            Th("СТАТУС"),
                            Th("ПРИМЕЧАНИЯ"),
                            Th(add_btn, style="text-align: right;", cls="col-actions")
                        )),
                        Tbody(*contracts_rows) if contracts_rows else Tbody(
                            Tr(Td("Договоры не найдены.", colspan="5", style="text-align: center; padding: 2rem; color: #666;"))
                        ),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                Div(Span(f"Всего: {len(contracts)} договоров"), cls="table-footer"),
                cls="table-container", style="margin: 0;"
            )
        )

    elif tab == "quotes":
        from services.customer_service import get_customer_quotes

        quotes = get_customer_quotes(customer_id)

        quotes_rows = []
        for quote in quotes:
            # Format date
            created_at = quote.get("created_at", "")
            if created_at:
                try:
                    from datetime import datetime
                    dt = datetime.fromisoformat(created_at.replace("Z", "+00:00"))
                    created_at = dt.strftime("%d.%m.%Y %H:%M")
                except:
                    pass

            # Status badge
            workflow_status = quote.get("workflow_status", "")
            status_text = {
                "draft": "Черновик",
                "pending_procurement": "Закупка",
                "approved": "Согласовано",
                "sent_to_client": "Отправлено",
                "deal": "Сделка",
                "rejected": "Отклонено",
                "cancelled": "Отменено"
            }.get(workflow_status, workflow_status)

            # Format sum and profit
            total_sum = quote.get("total_sum", 0)
            total_profit = quote.get("total_profit", 0)

            quotes_rows.append(
                Tr(
                    Td(A(Strong(quote.get("idn", "—")), href=f"/quotes/{quote['id']}")),
                    Td(f"{total_sum:,.0f} ₽" if total_sum else "—", style="text-align: right;"),
                    Td(f"{total_profit:,.0f} ₽" if total_profit else "—", style="text-align: right; color: " + ("#16a34a" if total_profit > 0 else "#666")),
                    Td(created_at or "—", style="font-size: 0.9em;"),
                    Td(Span(status_text, cls="status-badge")),
                )
            )

        add_btn = A(
            icon("plus", size=14), " Создать КП",
            href=f"/quotes/new?customer_id={customer_id}",
            style="background: var(--accent); color: white; padding: 0.4rem 0.75rem; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; font-weight: 500;"
        )

        tab_content = Div(
            Div(
                Div(
                    Table(
                        Thead(Tr(
                            Th("IDN"),
                            Th("СУММА", cls="col-money"),
                            Th("ПРОФИТ", cls="col-money"),
                            Th("ДАТА"),
                            Th(add_btn, style="text-align: right;")
                        )),
                        Tbody(*quotes_rows) if quotes_rows else Tbody(
                            Tr(Td("КП не найдены.", colspan="5", style="text-align: center; padding: 2rem; color: #666;"))
                        ),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                Div(Span(f"Всего: {len(quotes)} КП"), cls="table-footer"),
                cls="table-container", style="margin: 0;"
            )
        )

    elif tab == "specifications":
        from services.customer_service import get_customer_specifications

        specifications = get_customer_specifications(customer_id)

        specs_rows = []
        for spec in specifications:
            # Format date
            sign_date = spec.get("sign_date", "")
            if sign_date:
                try:
                    from datetime import datetime
                    dt = datetime.fromisoformat(sign_date.replace("Z", "+00:00"))
                    sign_date = dt.strftime("%d.%m.%Y")
                except:
                    pass

            # Status badge
            status = spec.get("status", "")
            status_text = {
                "draft": "Черновик",
                "pending_review": "На проверке",
                "approved": "Согласовано",
                "signed": "Подписано"
            }.get(status, status)

            # Get quote IDN if available
            quote_idn = ""
            if spec.get("quotes"):
                quote_idn = spec["quotes"].get("idn", "")

            # Format sum and profit
            total_sum = spec.get("total_sum", 0)
            total_profit = spec.get("total_profit", 0)

            specs_rows.append(
                Tr(
                    Td(Strong(spec.get("specification_number", "—"))),
                    Td(A(quote_idn, href=f"/quotes/{spec.get('quote_id')}") if spec.get("quote_id") else "—"),
                    Td(f"{total_sum:,.0f} ₽" if total_sum else "—", style="text-align: right;"),
                    Td(f"{total_profit:,.0f} ₽" if total_profit else "—", style="text-align: right; color: " + ("#16a34a" if total_profit > 0 else "#666")),
                    Td(sign_date or "—", style="font-size: 0.9em;"),
                    Td(Span(status_text, cls="status-badge")),
                )
            )

        tab_content = Div(
            Div(
                Div(
                    Table(
                        Thead(Tr(
                            Th("НОМЕР"),
                            Th("IDN"),
                            Th("СУММА", cls="col-money"),
                            Th("ПРОФИТ", cls="col-money"),
                            Th("ДАТА"),
                            Th("СТАТУС")
                        )),
                        Tbody(*specs_rows) if specs_rows else Tbody(
                            Tr(Td("Спецификации не найдены.", colspan="6", style="text-align: center; padding: 2rem; color: #666;"))
                        ),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                Div(Span(f"Всего: {len(specifications)} спецификаций"), cls="table-footer"),
                cls="table-container", style="margin: 0;"
            )
        )

    elif tab == "requested_items":
        from services.customer_service import get_customer_requested_items

        items = get_customer_requested_items(customer_id)

        items_rows = []
        for item in items:
            product = item.get("product", {}) or {}

            # Format last requested date
            last_requested = item.get("last_requested_at", "")
            if last_requested:
                try:
                    from datetime import datetime
                    dt = datetime.fromisoformat(last_requested.replace("Z", "+00:00"))
                    last_requested = dt.strftime("%d.%m.%Y")
                except:
                    pass

            # Brands as comma-separated
            brands = ", ".join(item.get("brands", [])) if item.get("brands") else "—"

            # Quantity
            total_quantity = item.get("total_quantity", 0)

            # Price
            last_price = item.get("last_price")
            price_display = f"{last_price:,.2f} ₽" if last_price else "—"

            # Was sold status
            was_sold = item.get("was_sold", False)
            sold_badge = Span(icon("check-circle", size=14), " Продан", cls="status-badge status-approved", style="display: inline-flex; align-items: center; gap: 0.25rem;") if was_sold else Span("—", style="color: #999;")

            items_rows.append(
                Tr(
                    Td(Strong(product.get("name", "—"))),
                    Td(brands),
                    Td(product.get("sku", "—")),
                    Td(f"{total_quantity:,.0f}" if total_quantity else "—", style="text-align: right;"),
                    Td(price_display, style="text-align: right;"),
                    Td(last_requested or "—", style="font-size: 0.9em;"),
                    Td(sold_badge),
                )
            )

        tab_content = Div(
            Div(
                Div(
                    Table(
                        Thead(Tr(
                            Th("НАЗВАНИЕ"),
                            Th("БРЕНД"),
                            Th("АРТИКУЛ"),
                            Th("КОЛ-ВО", cls="col-number"),
                            Th("ЦЕНА", cls="col-money"),
                            Th("ДАТА"),
                            Th("СТАТУС")
                        )),
                        Tbody(*items_rows) if items_rows else Tbody(
                            Tr(Td("Позиции не найдены.", colspan="7", style="text-align: center; padding: 2rem; color: #666;"))
                        ),
                        cls="unified-table"
                    ),
                    cls="table-responsive"
                ),
                Div(Span(f"Всего: {len(items)} позиций"), cls="table-footer"),
                cls="table-container", style="margin: 0;"
            )
        )

    elif tab == "additional":
        # Additional tab - notes/remarks with inline editing
        tab_content = Div(
            Div(
                H3(icon("more-horizontal", size=20), " Дополнительная информация", style="margin-bottom: 1rem; color: #e2e8f0; display: flex; align-items: center; gap: 0.5rem;"),
                Div(
                    Div(
                        Div("Заметки / Примечания", style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 0.5rem;"),
                        _render_notes_display(customer_id, customer.notes or ""),
                        style="margin-bottom: 1rem;"
                    ),
                    style="padding: 1rem;"
                ),
                cls="card",
                style="background: linear-gradient(135deg, #2d2d44 0%, #1e1e2f 100%); border-radius: 0.75rem; max-width: 800px;"
            )
        )

    elif tab == "calls":
        # Calls tab - placeholder
        tab_content = Div(
            Div(
                icon("phone", size=48),
                H3("Звонки", style="margin: 1rem 0 0.5rem; color: #e2e8f0;"),
                P("Функционал находится в разработке", style="color: #64748b;"),
                cls="flex flex-col items-center justify-center",
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem; text-align: center; color: #94a3b8;"
            ),
            cls="card",
            style="background: linear-gradient(135deg, #2d2d44 0%, #1e1e2f 100%); border-radius: 0.75rem;"
        )

    elif tab == "meetings":
        # Meetings tab - placeholder
        tab_content = Div(
            Div(
                icon("calendar", size=48),
                H3("Встречи", style="margin: 1rem 0 0.5rem; color: #e2e8f0;"),
                P("Функционал находится в разработке", style="color: #64748b;"),
                cls="flex flex-col items-center justify-center",
                style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem; text-align: center; color: #94a3b8;"
            ),
            cls="card",
            style="background: linear-gradient(135deg, #2d2d44 0%, #1e1e2f 100%); border-radius: 0.75rem;"
        )

    else:
        tab_content = Div("Неизвестная вкладка")

    # If this is an HTMX request (tab switch), return only the tab content
    if request and request.headers.get("HX-Request"):
        return tab_content

    return page_layout(f"Клиент: {customer.name}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Клиенты", href="/customers",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("building", size=24, color="#10b981"),
                        H1(customer.name, style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span("Активен" if customer.is_active else "Неактивен",
                             style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {'#16a34a' if customer.is_active else '#dc2626'}; background: {'#dcfce7' if customer.is_active else '#fee2e2'};"),
                        btn_link("Редактировать", href=f"/customers/{customer_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Tabs navigation (DaisyUI)
        tabs_nav,

        # Tab content wrapper for HTMX targeting
        Div(tab_content, id="tab-content", style="min-height: 300px;"),

        session=session
    )


# ============================================================================
# Customer Inline Editing
# ============================================================================

@rt("/customers/{customer_id}/edit-field/{field_name}")
def get(customer_id: str, field_name: str, session):
    """Return inline edit form for a specific field."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    # Map field names to labels and current values
    field_config = {
        "name": ("Название компании", customer.name, "text"),
        "inn": ("ИНН", customer.inn or "", "text"),
        "kpp": ("КПП", customer.kpp or "", "text"),
        "ogrn": ("ОГРН", customer.ogrn or "", "text"),
        "legal_address": ("Юридический адрес", customer.legal_address or "", "textarea"),
        "actual_address": ("Фактический адрес", customer.actual_address or "", "textarea"),
        "postal_address": ("Почтовый адрес", customer.postal_address or "", "textarea"),
    }

    if field_name not in field_config:
        return Div("Неизвестное поле")

    label, value, input_type = field_config[field_name]

    # Style for modern inline editing
    input_style = "padding: 0.5rem 0.75rem; border: 2px solid #3b82f6; border-radius: 0.375rem; font-size: inherit; outline: none;"
    form_id = f"customer-field-form-{field_name}"

    # Key handlers: Enter to click hidden submit button, Escape to cancel
    esc_handler = "if(event.key === 'Escape') { event.preventDefault(); htmx.ajax('GET', '" + f"/customers/{customer_id}/cancel-edit/{field_name}" + "', {target: '#field-" + field_name + "', swap: 'outerHTML'}); }"
    key_handler = f"if(event.key === 'Enter' && !event.shiftKey) {{ event.preventDefault(); document.querySelector('#{form_id} button[type=submit]').click(); }} else " + esc_handler

    if input_type == "textarea":
        # Textarea: Escape cancels, Enter+Shift for newline, just Enter doesn't save (use button)
        input_elem = Textarea(
            value, name=field_name,
            autofocus=True,
            style=input_style + " width: 100%; min-height: 80px; font-family: inherit;",
            required=True if field_name == "name" else False,
            onkeydown=esc_handler
        )
    else:
        # Input: Enter saves, Escape cancels
        input_elem = Input(
            value=value, name=field_name,
            autofocus=True,
            style=input_style + " flex: 1;",
            required=True if field_name == "name" else False,
            onkeydown=key_handler
        )

    return Form(
        Div(
            input_elem,
            Button(type="submit", style="position: absolute; left: -9999px; width: 1px; height: 1px;"),  # Offscreen submit button
            id=f"field-{field_name}"
        ),
        id=form_id,
        hx_post=f"/customers/{customer_id}/update-field/{field_name}",
        hx_target=f"#field-{field_name}",
        hx_swap="outerHTML"
    )


@rt("/customers/{customer_id}/update-field/{field_name}")
async def post(customer_id: str, field_name: str, session, request):
    """Update a specific field via inline editing."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer, update_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    # Get form data
    form_data = await request.form()
    new_value = form_data.get(field_name, "")

    # Update customer
    update_data = {field_name: new_value}
    success = update_customer(customer_id, **update_data)

    if not success:
        return Div("Ошибка обновления", id=f"field-{field_name}")

    # Return updated display
    return _render_field_display(customer_id, field_name, new_value)


@rt("/customers/{customer_id}/cancel-edit/{field_name}")
def get(customer_id: str, field_name: str, session):
    """Cancel inline editing and return to display mode."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    # Get current value
    value = getattr(customer, field_name, "")

    return _render_field_display(customer_id, field_name, value)


def _render_field_display(customer_id: str, field_name: str, value: str):
    """Helper function to render field in display mode with modern inline edit."""
    display_value = value if value else "Не указан"
    # Use consistent dark gray for filled values, lighter gray for empty
    display_color = "#6b7280" if not value else "#374151"

    # Special formatting for name field
    if field_name == "name":
        font_style = "font-size: 1.1em; font-weight: 500;"
    else:
        font_style = ""

    return Div(
        display_value,
        id=f"field-{field_name}",
        hx_get=f"/customers/{customer_id}/edit-field/{field_name}",
        hx_target=f"#field-{field_name}",
        hx_swap="outerHTML",
        style=f"cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 0.375rem; transition: background 0.15s ease; color: {display_color}; {font_style}",
        onmouseover="this.style.background='#f3f4f6'",
        onmouseout="this.style.background='transparent'",
        title="Кликните для редактирования"
    )


def _render_notes_display(customer_id: str, value: str):
    """Helper function to render notes field in display mode with inline edit."""
    display_value = value if value else "Нажмите чтобы добавить заметки..."
    display_color = "#64748b" if not value else "#e2e8f0"

    return Div(
        Pre(display_value, style="white-space: pre-wrap; margin: 0; font-family: inherit;") if value else Span(display_value, style="font-style: italic;"),
        id="field-notes",
        hx_get=f"/customers/{customer_id}/edit-notes",
        hx_target="#field-notes",
        hx_swap="outerHTML",
        style=f"cursor: pointer; padding: 1rem; border-radius: 0.5rem; transition: background 0.15s ease; color: {display_color}; min-height: 100px; background: rgba(255,255,255,0.03);",
        onmouseover="this.style.background='rgba(255,255,255,0.08)'",
        onmouseout="this.style.background='rgba(255,255,255,0.03)'",
        title="Кликните для редактирования"
    )


@rt("/customers/{customer_id}/edit-notes")
def get(customer_id: str, session):
    """Return inline edit form for notes field."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    return Form(
        Div(
            Textarea(
                customer.notes or "",
                name="notes",
                autofocus=True,
                style="width: 100%; min-height: 150px; padding: 0.75rem; border: 2px solid #3b82f6; border-radius: 0.5rem; font-family: inherit; font-size: inherit; background: #1e1e2f; color: #e2e8f0; resize: vertical;",
                placeholder="Введите заметки о клиенте...",
                onkeydown="if(event.key === 'Escape') { event.target.form.querySelector('.cancel-btn').click(); }"
            ),
            Div(
                btn("Сохранить", variant="success", icon_name="check", type="submit", size="sm"),
                btn("Отмена", variant="danger", size="sm", type="button",
                    cls="cancel-btn",
                    hx_get=f"/customers/{customer_id}/cancel-edit-notes",
                    hx_target="#field-notes",
                    hx_swap="outerHTML"),
                style="display: flex; gap: 0.5rem; margin-top: 0.75rem;"
            ),
            id="field-notes"
        ),
        hx_post=f"/customers/{customer_id}/update-notes",
        hx_target="#field-notes",
        hx_swap="outerHTML"
    )


@rt("/customers/{customer_id}/update-notes")
async def post(customer_id: str, session, request):
    """Update notes field via inline editing."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer, update_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    # Get form data
    form_data = await request.form()
    new_value = form_data.get("notes", "")

    # Update customer
    success = update_customer(customer_id, notes=new_value)

    if not success:
        return Div("Ошибка обновления", id="field-notes")

    # Return updated display
    return _render_notes_display(customer_id, new_value)


@rt("/customers/{customer_id}/cancel-edit-notes")
def get(customer_id: str, session):
    """Cancel inline editing of notes and return to display mode."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    return _render_notes_display(customer_id, customer.notes or "")


# ============================================================================
# Contact Inline Editing
# ============================================================================

def _render_contact_field(contact_id: str, customer_id: str, field_name: str, value: str, is_link: bool = False):
    """Helper function to render a contact field with inline editing capability."""
    display_value = value if value else "—"

    # For email/phone links
    if is_link and value:
        if field_name == "email":
            content = A(value, href=f"mailto:{value}", style="color: #3b82f6; text-decoration: none;")
        elif field_name == "phone":
            content = A(value, href=f"tel:{value}", style="color: #3b82f6; text-decoration: none;")
        else:
            content = display_value
    else:
        content = display_value

    return Td(
        Div(
            content,
            id=f"contact-{contact_id}-{field_name}",
            hx_get=f"/customers/{customer_id}/contacts/{contact_id}/edit-field/{field_name}",
            hx_target=f"#contact-{contact_id}-{field_name}",
            hx_swap="outerHTML",
            style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background 0.15s ease; min-width: 60px;",
            onmouseover="this.style.background='#f3f4f6'",
            onmouseout="this.style.background='transparent'",
            title="Кликните для редактирования"
        )
    )


def _render_contact_name_cell(contact, customer_id: str):
    """Render the name cell with full name (Фамилия Имя Отчество), ЛПР badge, and inline editing."""
    # Build full name: Фамилия Имя Отчество
    name_parts = []
    if contact.last_name:
        name_parts.append(contact.last_name)
    if contact.name:
        name_parts.append(contact.name)
    if contact.patronymic:
        name_parts.append(contact.patronymic)
    full_name = " ".join(name_parts) if name_parts else "—"

    # Build name content with optional ЛПР badge
    name_content = [Strong(full_name)]
    if contact.is_lpr:
        name_content.append(Span("ЛПР", style="margin-left: 0.5rem; background: #dbeafe; color: #1d4ed8; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;"))

    return Td(
        Div(
            *name_content,
            id=f"contact-{contact.id}-name",
            hx_get=f"/customers/{customer_id}/contacts/{contact.id}/edit-field/name",
            hx_target=f"#contact-{contact.id}-name",
            hx_swap="outerHTML",
            style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background 0.15s ease;",
            onmouseover="this.style.background='#f3f4f6'",
            onmouseout="this.style.background='transparent'",
            title="Кликните для редактирования"
        )
    )


def _render_contact_flags_cell(contact, customer_id: str):
    """Render the flags cell (signatory, primary, LPR) with minimal clickable icons."""
    # Colors: green for signatory, orange for primary, blue for LPR, darker gray for inactive
    signatory_color = "#10b981" if contact.is_signatory else "#6b7280"
    primary_color = "#f59e0b" if contact.is_primary else "#6b7280"
    lpr_color = "#3b82f6" if contact.is_lpr else "#6b7280"

    # Use Span with HTMX instead of Button to avoid global button styling
    return Td(
        Div(
            Span(
                icon("pen-tool", size=18),
                hx_post=f"/customers/{customer_id}/contacts/{contact.id}/toggle-signatory",
                hx_target="#contacts-tbody",
                hx_swap="innerHTML",
                style=f"color: {signatory_color}; cursor: pointer; padding: 6px; display: inline-flex; border-radius: 4px; transition: background 0.15s;",
                title="Подписант" if contact.is_signatory else "Сделать подписантом",
                onmouseover="this.style.background='#f3f4f6'",
                onmouseout="this.style.background='transparent'"
            ),
            Span(
                icon("star", size=18),
                hx_post=f"/customers/{customer_id}/contacts/{contact.id}/toggle-primary",
                hx_target="#contacts-tbody",
                hx_swap="innerHTML",
                style=f"color: {primary_color}; cursor: pointer; padding: 6px; display: inline-flex; border-radius: 4px; transition: background 0.15s;",
                title="Основной контакт" if contact.is_primary else "Сделать основным",
                onmouseover="this.style.background='#f3f4f6'",
                onmouseout="this.style.background='transparent'"
            ),
            Span(
                icon("user-check", size=18),
                hx_post=f"/customers/{customer_id}/contacts/{contact.id}/toggle-lpr",
                hx_target="#contacts-tbody",
                hx_swap="innerHTML",
                style=f"color: {lpr_color}; cursor: pointer; padding: 6px; display: inline-flex; border-radius: 4px; transition: background 0.15s;",
                title="ЛПР (лицо, принимающее решения)" if contact.is_lpr else "Сделать ЛПР",
                onmouseover="this.style.background='#f3f4f6'",
                onmouseout="this.style.background='transparent'"
            ),
            style="display: flex; align-items: center; gap: 8px;"
        ),
        cls="col-actions"
    )


def _render_contact_row(contact, customer_id: str):
    """Render a single contact row with inline editing."""
    return Tr(
        _render_contact_name_cell(contact, customer_id),
        _render_contact_field(contact.id, customer_id, "position", contact.position or ""),
        _render_contact_field(contact.id, customer_id, "email", contact.email or "", is_link=True),
        _render_contact_field(contact.id, customer_id, "phone", contact.phone or "", is_link=True),
        _render_contact_field(contact.id, customer_id, "notes", (contact.notes[:50] + "..." if contact.notes and len(contact.notes) > 50 else contact.notes) or ""),
        _render_contact_flags_cell(contact, customer_id),
        id=f"contact-row-{contact.id}"
    )


@rt("/customers/{customer_id}/contacts/{contact_id}/edit-field/{field_name}")
def get(customer_id: str, contact_id: str, field_name: str, session):
    """Return inline edit form for a contact field."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact

    contact = get_contact(contact_id)
    if not contact:
        return Div("Контакт не найден", id=f"contact-{contact_id}-{field_name}")

    # Blur handler for save on click outside
    blur_save = "setTimeout(() => { if(this.form && document.contains(this)) this.form.requestSubmit(); }, 150)"
    cancel_url = f"/customers/{customer_id}/contacts/{contact_id}/cancel-edit/{field_name}"

    # Get current value based on field
    if field_name == "name":
        # For name, we edit all three parts: last_name, name, patronymic
        # Key handlers: Enter to click hidden submit button, Escape to cancel
        form_id = f"contact-name-form-{contact_id}"
        key_handler = f"if(event.key === 'Enter') {{ event.preventDefault(); document.querySelector('#{form_id} button[type=submit]').click(); }} else if(event.key === 'Escape') {{ event.preventDefault(); htmx.ajax('GET', '{cancel_url}', {{target: '#contact-{contact_id}-{field_name}', swap: 'outerHTML'}}); }}"
        input_style = "padding: 0.35rem 0.5rem; border: 2px solid #3b82f6; border-radius: 0.25rem;"

        return Div(
            Form(
                Div(
                    Input(type="text", name="last_name", value=contact.last_name or "", placeholder="Фамилия",
                          style=input_style + " width: 90px; margin-right: 0.25rem;",
                          onkeydown=key_handler),
                    Input(type="text", name="name", value=contact.name or "", placeholder="Имя", required=True,
                          style=input_style + " width: 70px; margin-right: 0.25rem;", autofocus=True,
                          onkeydown=key_handler),
                    Input(type="text", name="patronymic", value=contact.patronymic or "", placeholder="Отчество",
                          style=input_style + " width: 90px;",
                          onkeydown=key_handler),
                    Button(type="submit", style="position: absolute; left: -9999px; width: 1px; height: 1px;"),  # Offscreen submit button
                    style="display: flex; align-items: center; gap: 0.25rem;"
                ),
                id=form_id,
                hx_post=f"/customers/{customer_id}/contacts/{contact_id}/update-field/{field_name}",
                hx_target=f"#contact-row-{contact_id}",
                hx_swap="outerHTML"
            ),
            id=f"contact-{contact_id}-{field_name}",
            style="padding: 0.25rem;"
        )
    else:
        current_value = getattr(contact, field_name, "") or ""

        # Determine input type
        if field_name == "email":
            input_type = "email"
            placeholder = "email@example.com"
        elif field_name == "phone":
            input_type = "tel"
            placeholder = "+7 (999) 123-45-67"
        elif field_name == "notes":
            input_type = "text"
            placeholder = "Заметки..."
        else:
            input_type = "text"
            placeholder = ""

        # Key handlers: Enter to click hidden submit button, Escape to cancel
        form_id = f"contact-field-form-{contact_id}-{field_name}"
        key_handler = f"if(event.key === 'Enter') {{ event.preventDefault(); document.querySelector('#{form_id} button[type=submit]').click(); }} else if(event.key === 'Escape') {{ event.preventDefault(); htmx.ajax('GET', '{cancel_url}', {{target: '#contact-{contact_id}-{field_name}', swap: 'outerHTML'}}); }}"

        return Div(
            Form(
                Input(type=input_type, name=field_name, value=current_value, placeholder=placeholder,
                      style="padding: 0.35rem 0.5rem; border: 2px solid #3b82f6; border-radius: 0.25rem; width: 150px;", autofocus=True,
                      onkeydown=key_handler),
                Button(type="submit", style="position: absolute; left: -9999px; width: 1px; height: 1px;"),  # Offscreen submit button
                id=form_id,
                hx_post=f"/customers/{customer_id}/contacts/{contact_id}/update-field/{field_name}",
                hx_target=f"#contact-{contact_id}-{field_name}",
                hx_swap="outerHTML"
            ),
            id=f"contact-{contact_id}-{field_name}",
            style="padding: 0.25rem;"
        )


@rt("/customers/{customer_id}/contacts/{contact_id}/update-field/{field_name}")
async def post(customer_id: str, contact_id: str, field_name: str, session, request):
    """Update a contact field via inline editing."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact, update_contact

    contact = get_contact(contact_id)
    if not contact:
        return Div("Контакт не найден", id=f"contact-{contact_id}-{field_name}")

    # Get form data
    form_data = await request.form()

    try:
        if field_name == "name":
            # Update all name parts
            last_name = form_data.get("last_name", "")
            name = form_data.get("name", "")
            patronymic = form_data.get("patronymic", "")

            updated_contact = update_contact(contact_id, name=name, last_name=last_name, patronymic=patronymic)
        else:
            new_value = form_data.get(field_name, "")
            kwargs = {field_name: new_value}
            updated_contact = update_contact(contact_id, **kwargs)

        if not updated_contact:
            return Div("Ошибка обновления", id=f"contact-{contact_id}-{field_name}")

        # For name field, return the full row
        if field_name == "name":
            return _render_contact_row(updated_contact, customer_id)

        # For other fields, return just the updated cell content
        is_link = field_name in ("email", "phone")
        value = getattr(updated_contact, field_name, "") or ""
        if field_name == "notes" and value and len(value) > 50:
            value = value[:50] + "..."

        display_value = value if value else "—"

        if is_link and value:
            if field_name == "email":
                content = A(value, href=f"mailto:{value}", style="color: #3b82f6; text-decoration: none;")
            elif field_name == "phone":
                content = A(value, href=f"tel:{value}", style="color: #3b82f6; text-decoration: none;")
            else:
                content = display_value
        else:
            content = display_value

        return Div(
            content,
            id=f"contact-{contact_id}-{field_name}",
            hx_get=f"/customers/{customer_id}/contacts/{contact_id}/edit-field/{field_name}",
            hx_target=f"#contact-{contact_id}-{field_name}",
            hx_swap="outerHTML",
            style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background 0.15s ease; min-width: 60px;",
            onmouseover="this.style.background='#f3f4f6'",
            onmouseout="this.style.background='transparent'",
            title="Кликните для редактирования"
        )

    except ValueError as e:
        return Div(str(e), id=f"contact-{contact_id}-{field_name}", style="color: red; padding: 0.25rem 0.5rem;")


@rt("/customers/{customer_id}/contacts/{contact_id}/cancel-edit/{field_name}")
def get(customer_id: str, contact_id: str, field_name: str, session):
    """Cancel inline editing of a contact field."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact

    contact = get_contact(contact_id)
    if not contact:
        return Div("Контакт не найден", id=f"contact-{contact_id}-{field_name}")

    if field_name == "name":
        # Return the name cell with badges
        badges = []
        if contact.is_lpr:
            badges.append(Span("ЛПР", style="margin-left: 0.5rem; background: #dbeafe; color: #1d4ed8; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;"))
        if contact.is_signatory:
            badges.append(Span(icon("pen-tool", size=12), " Подписант", cls="status-badge status-approved", style="margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem;"))
        if contact.is_primary:
            badges.append(Span("★ Основной", cls="status-badge status-pending", style="margin-left: 0.5rem;"))

        return Div(
            Div(
                Strong(contact.get_full_name()),
                *badges,
                style="display: flex; align-items: center; flex-wrap: wrap;"
            ),
            id=f"contact-{contact.id}-name",
            hx_get=f"/customers/{customer_id}/contacts/{contact.id}/edit-field/name",
            hx_target=f"#contact-{contact.id}-name",
            hx_swap="outerHTML",
            style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background 0.15s ease;",
            onmouseover="this.style.background='#f3f4f6'",
            onmouseout="this.style.background='transparent'",
            title="Кликните для редактирования"
        )

    # For other fields
    is_link = field_name in ("email", "phone")
    value = getattr(contact, field_name, "") or ""
    if field_name == "notes" and value and len(value) > 50:
        value = value[:50] + "..."

    display_value = value if value else "—"

    if is_link and value:
        if field_name == "email":
            content = A(value, href=f"mailto:{value}", style="color: #3b82f6; text-decoration: none;")
        elif field_name == "phone":
            content = A(value, href=f"tel:{value}", style="color: #3b82f6; text-decoration: none;")
        else:
            content = display_value
    else:
        content = display_value

    return Div(
        content,
        id=f"contact-{contact_id}-{field_name}",
        hx_get=f"/customers/{customer_id}/contacts/{contact_id}/edit-field/{field_name}",
        hx_target=f"#contact-{contact_id}-{field_name}",
        hx_swap="outerHTML",
        style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background 0.15s ease; min-width: 60px;",
        onmouseover="this.style.background='#f3f4f6'",
        onmouseout="this.style.background='transparent'",
        title="Кликните для редактирования"
    )


@rt("/customers/{customer_id}/contacts/{contact_id}/toggle-signatory")
def post(customer_id: str, contact_id: str, session):
    """Toggle signatory status for a contact. Returns all contacts to show unique signatory."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact, update_contact, get_customer_with_contacts

    contact = get_contact(contact_id)
    if not contact:
        return Tr(Td("Контакт не найден", colspan="6"))

    # Toggle signatory status (backend will unset other signatories if setting to true)
    new_status = not contact.is_signatory
    update_contact(contact_id, is_signatory=new_status)

    # Re-fetch all contacts to show updated state (including unset signatory on other contacts)
    customer = get_customer_with_contacts(customer_id)
    if customer and customer.contacts:
        return tuple(_render_contact_row(c, customer_id) for c in customer.contacts)
    return Tr(Td("Контакты не найдены", colspan="6"))


@rt("/customers/{customer_id}/contacts/{contact_id}/toggle-primary")
def post(customer_id: str, contact_id: str, session):
    """Toggle primary status for a contact. Returns all contacts to show unique primary."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact, update_contact, get_customer_with_contacts

    contact = get_contact(contact_id)
    if not contact:
        return Tr(Td("Контакт не найден", colspan="6"))

    # Toggle primary status (backend will unset other primaries if setting to true)
    new_status = not contact.is_primary
    update_contact(contact_id, is_primary=new_status)

    # Re-fetch all contacts to show updated state (including unset primary on other contacts)
    customer = get_customer_with_contacts(customer_id)
    if customer and customer.contacts:
        return tuple(_render_contact_row(c, customer_id) for c in customer.contacts)
    return Tr(Td("Контакты не найдены", colspan="6"))


@rt("/customers/{customer_id}/contacts/{contact_id}/toggle-lpr")
def post(customer_id: str, contact_id: str, session):
    """Toggle LPR (decision maker) status for a contact. Multiple contacts can be LPR."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_contact, update_contact, get_customer_with_contacts

    contact = get_contact(contact_id)
    if not contact:
        return Tr(Td("Контакт не найден", colspan="6"))

    # Toggle LPR status (multiple contacts can be LPR, no need to unset others)
    new_status = not contact.is_lpr
    update_contact(contact_id, is_lpr=new_status)

    # Re-fetch all contacts to show updated state
    customer = get_customer_with_contacts(customer_id)
    if customer and customer.contacts:
        return tuple(_render_contact_row(c, customer_id) for c in customer.contacts)
    return Tr(Td("Контакты не найдены", colspan="6"))


# ============================================================================
# Customer Warehouse Addresses Management
# ============================================================================

@rt("/customers/{customer_id}/warehouses/add")
def get(customer_id: str, session):
    """Return form to add new warehouse address."""
    redirect = require_login(session)
    if redirect:
        return redirect

    return Form(
        Input(type="text", name="warehouse_address", placeholder="Введите адрес склада",
              style="width: 100%; padding: 0.5rem; border: 2px solid #3b82f6; border-radius: 0.375rem;", required=True),
        Div(
            btn("Добавить", variant="success", icon_name="check", type="submit", size="sm"),
            btn("Отмена", variant="danger", size="sm", type="button",
                hx_get=f"/customers/{customer_id}/warehouses/cancel-add",
                hx_target="#add-warehouse-form",
                hx_swap="outerHTML"),
            style="display: flex; gap: 0.5rem; margin-top: 0.5rem;"
        ),
        hx_post=f"/customers/{customer_id}/warehouses/add",
        hx_target="#warehouses-list",
        hx_swap="outerHTML",
        id="add-warehouse-form",
        style="margin-bottom: 1rem;"
    )


@rt("/customers/{customer_id}/warehouses/add")
async def post(customer_id: str, session, request):
    """Add new warehouse address."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer, update_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    # Get form data
    form_data = await request.form()
    new_address = form_data.get("warehouse_address", "").strip()

    if not new_address:
        return _render_warehouses_list(customer_id, customer.warehouse_addresses or [])

    # Add to warehouse addresses
    warehouses = customer.warehouse_addresses or []
    warehouses.append(new_address)

    # Update customer
    update_customer(customer_id, warehouse_addresses=warehouses)

    return _render_warehouses_list(customer_id, warehouses)


@rt("/customers/{customer_id}/warehouses/cancel-add")
def get(customer_id: str, session):
    """Cancel adding warehouse address."""
    redirect = require_login(session)
    if redirect:
        return redirect

    return btn("Добавить адрес склада", variant="secondary", icon_name="plus", type="button",
               hx_get=f"/customers/{customer_id}/warehouses/add",
               hx_target="#add-warehouse-form",
               hx_swap="outerHTML",
               id="add-warehouse-form")


@rt("/customers/{customer_id}/warehouses/delete/{index}")
def post(customer_id: str, index: int, session):
    """Delete warehouse address by index."""
    redirect = require_login(session)
    if redirect:
        return redirect

    from services.customer_service import get_customer, update_customer

    customer = get_customer(customer_id)
    if not customer:
        return Div("Клиент не найден")

    warehouses = customer.warehouse_addresses or []
    if 0 <= index < len(warehouses):
        warehouses.pop(index)
        update_customer(customer_id, warehouse_addresses=warehouses)

    return _render_warehouses_list(customer_id, warehouses)


def _render_warehouses_list(customer_id: str, warehouses: list):
    """Helper function to render warehouses list."""
    warehouse_items = []
    for i, addr in enumerate(warehouses):
        warehouse_items.append(
            Li(
                Span(addr, style="flex: 1;"),
                btn("Удалить", variant="danger", icon_name="trash-2", size="sm", type="button",
                    hx_post=f"/customers/{customer_id}/warehouses/delete/{i}",
                    hx_target="#warehouses-list",
                    hx_swap="outerHTML",
                    hx_confirm="Удалить этот адрес склада?"),
                style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;"
            )
        )

    return Div(
        Ul(*warehouse_items, style="padding-left: 1.5rem; list-style: none;") if warehouse_items else Div("Нет адресов складов", style="color: #999; font-style: italic;"),
        id="warehouses-list"
    )


# ============================================================================
# Customer Contacts - New Contact
# ============================================================================

@rt("/customers/{customer_id}/contacts/new")
def get(session, customer_id: str):
    """Add new contact for a customer."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check if user has sales or admin role
    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()
    user = session["user"]

    # Get customer info
    customer_result = supabase.table("customers") \
        .select("id, name, inn") \
        .eq("id", customer_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not customer_result.data:
        return page_layout("Клиент не найден",
            H1("Клиент не найден"),
            P("Запрошенный клиент не найден или у вас нет доступа."),
            A("← Назад к клиентам", href="/customers"),
            session=session
        )

    customer = customer_result.data[0]

    return page_layout("Добавить контакт",
        H1(f"Добавить контакт для {customer['name']}"),
        Div(
            Form(
                Div(
                    Label("Фамилия *", Input(name="last_name", required=True, placeholder="Иванов")),
                    Label("Имя *", Input(name="name", required=True, placeholder="Иван")),
                    Label("Отчество", Input(name="patronymic", placeholder="Иванович")),
                    cls="form-row", style="grid-template-columns: repeat(3, 1fr);"
                ),
                Div(
                    Label("Должность", Input(name="position", placeholder="Директор")),
                    cls="form-row"
                ),
                Div(
                    Label("Email", Input(name="email", type="email", placeholder="ivanov@company.ru")),
                    Label("Телефон", Input(name="phone", placeholder="+7 999 123 4567")),
                    cls="form-row"
                ),
                Div(
                    Label(
                        Input(type="checkbox", name="is_primary", value="true"),
                        " ★ Основной контакт (для основной коммуникации)",
                        style="display: flex; align-items: center; gap: 0.5rem;"
                    ),
                    Label(
                        Input(type="checkbox", name="is_signatory", value="true"),
                        icon("pen-tool", size=12), " Подписант (имя будет в спецификациях PDF)",
                        style="display: flex; align-items: center; gap: 0.5rem;"
                    ),
                    Label(
                        Input(type="checkbox", name="is_lpr", value="true"),
                        icon("user-check", size=12), " ЛПР (лицо, принимающее решения)",
                        style="display: flex; align-items: center; gap: 0.5rem;"
                    ),
                    cls="form-row"
                ),
                Label("Заметки", Textarea(name="notes", placeholder="Дополнительная информация о контакте", rows="3")),
                Div(
                    btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href=f"/customers/{customer_id}", variant="secondary"),
                    cls="form-actions"
                ),
                method="post",
                action=f"/customers/{customer_id}/contacts/new"
            ),
            cls="card"
        ),
        session=session
    )


@rt("/customers/{customer_id}/contacts/new")
def post(session, customer_id: str, name: str, last_name: str = "", patronymic: str = "",
         position: str = "", email: str = "", phone: str = "",
         is_primary: str = "", is_signatory: str = "", is_lpr: str = "", notes: str = ""):
    """Create new contact for a customer."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check if user has sales or admin role
    if not user_has_any_role(session, ["sales", "admin"]):
        return RedirectResponse("/unauthorized", status_code=303)

    supabase = get_supabase()
    user = session["user"]

    # Verify customer exists and user has access
    customer_result = supabase.table("customers") \
        .select("id, name") \
        .eq("id", customer_id) \
        .eq("organization_id", user["org_id"]) \
        .execute()

    if not customer_result.data:
        return RedirectResponse("/customers", status_code=303)

    customer = customer_result.data[0]

    try:
        # Combine name parts into full name: "Surname Name Patronymic"
        # Form has: last_name (Фамилия), name (Имя), patronymic (Отчество)
        full_name_parts = [last_name, name, patronymic]
        full_name = " ".join(p.strip() for p in full_name_parts if p and p.strip())

        # Insert new contact
        result = supabase.table("customer_contacts").insert({
            "customer_id": customer_id,
            "organization_id": user["org_id"],
            "name": full_name,  # Combined: "Рахал Мамут Иванович"
            "position": position or None,
            "email": email or None,
            "phone": phone or None,
            "is_primary": is_primary == "true",
            "is_signatory": is_signatory == "true",
            "is_lpr": is_lpr == "true",
            "notes": notes or None
        }).execute()

        return RedirectResponse(f"/customers/{customer_id}", status_code=303)

    except Exception as e:
        error_msg = f"Ошибка при создании контакта: {str(e)}"

        return page_layout("Добавить контакт",
            Div(error_msg, style="background: #fee; border: 1px solid #c33; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;"),
            H1(f"Добавить контакт для {customer['name']}"),
            Div(
                Form(
                    Div(
                        Label("Фамилия *", Input(name="last_name", required=True, placeholder="Иванов", value=last_name)),
                        Label("Имя *", Input(name="name", required=True, placeholder="Иван", value=name)),
                        Label("Отчество", Input(name="patronymic", placeholder="Иванович", value=patronymic)),
                        cls="form-row", style="grid-template-columns: repeat(3, 1fr);"
                    ),
                    Div(
                        Label("Должность", Input(name="position", placeholder="Директор", value=position)),
                        cls="form-row"
                    ),
                    Div(
                        Label("Email", Input(name="email", type="email", placeholder="ivanov@company.ru", value=email)),
                        Label("Телефон", Input(name="phone", placeholder="+7 999 123 4567", value=phone)),
                        cls="form-row"
                    ),
                    Div(
                        Label(
                            Input(type="checkbox", name="is_primary", value="true", checked=is_primary=="true"),
                            " ★ Основной контакт (для основной коммуникации)",
                            style="display: flex; align-items: center; gap: 0.5rem;"
                        ),
                        Label(
                            Input(type="checkbox", name="is_signatory", value="true", checked=is_signatory=="true"),
                            icon("pen-tool", size=12), " Подписант (имя будет в спецификациях PDF)",
                            style="display: flex; align-items: center; gap: 0.5rem;"
                        ),
                        Label(
                            Input(type="checkbox", name="is_lpr", value="true", checked=is_lpr=="true"),
                            icon("user-check", size=12), " ЛПР (лицо, принимающее решения)",
                            style="display: flex; align-items: center; gap: 0.5rem;"
                        ),
                        cls="form-row"
                    ),
                    Label("Заметки", Textarea(name="notes", placeholder="Дополнительная информация о контакте", rows="3", value=notes)),
                    Div(
                        btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                        btn_link("Отмена", href=f"/customers/{customer_id}", variant="secondary"),
                        cls="form-actions"
                    ),
                    method="post",
                    action=f"/customers/{customer_id}/contacts/new"
                ),
                cls="card"
            ),
            session=session
        )


# ============================================================================
# User Profile
# ============================================================================

@rt("/profile/{user_id}")
def get(user_id: str, session, tab: str = "general"):
    """User profile view page with statistics, specifications, and customers."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user.get("org_id")

    # Check permissions - users can view their own profile, admins can view all profiles
    current_user_id = user.get("user_id")
    is_admin = user_has_any_role(session, ["admin", "top_manager"])

    if user_id != current_user_id and not is_admin:
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра данного профиля.", cls="alert alert-error"),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    from services.user_profile_service import (
        get_user_profile,
        get_user_statistics,
        get_user_specifications,
        get_user_customers
    )

    # Get user profile
    profile = get_user_profile(user_id, org_id)
    if not profile:
        return page_layout("Не найдено",
            Div("Пользователь не найден.", cls="alert alert-error"),
            btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Tab navigation
    tabs_nav = Div(
        A("Общая информация",
          href=f"/profile/{user_id}?tab=general",
          cls=f"tab-btn {'active' if tab == 'general' else ''}"),
        A("Спецификации",
          href=f"/profile/{user_id}?tab=specifications",
          cls=f"tab-btn {'active' if tab == 'specifications' else ''}"),
        A("Клиенты",
          href=f"/profile/{user_id}?tab=customers",
          cls=f"tab-btn {'active' if tab == 'customers' else ''}"),
        cls="tabs-nav"
    )

    # Build tab content based on selected tab
    if tab == "general":
        # Get statistics
        stats = get_user_statistics(user_id, org_id)

        # Build editable fields for admins
        if is_admin:
            full_name_display = _render_profile_field_display(user_id, "full_name", profile.get("full_name") or "")
            phone_display = _render_profile_field_display(user_id, "phone", profile.get("phone") or "")
            position_display = _render_profile_field_display(user_id, "position", profile.get("position") or "")
            department_display = _render_profile_field_display(user_id, "department_id", profile.get("department") or "")
            sales_group_display = _render_profile_field_display(user_id, "sales_group_id", profile.get("sales_group") or "")
            manager_display = _render_profile_field_display(user_id, "manager_id", profile.get("manager_email") or "")
            location_display = _render_profile_field_display(user_id, "location", profile.get("location") or "")
        else:
            full_name_display = Div(profile.get("full_name") or "—", style="padding: 0.5rem 0.75rem;")
            phone_display = Div(profile.get("phone") or "—", style="padding: 0.5rem 0.75rem;")
            position_display = Div(profile.get("position") or "—", style="padding: 0.5rem 0.75rem;")
            department_display = Div(profile.get("department") or "—", style="padding: 0.5rem 0.75rem;")
            sales_group_display = Div(profile.get("sales_group") or "—", style="padding: 0.5rem 0.75rem;")
            manager_display = Div(profile.get("manager_email") or "—", style="padding: 0.5rem 0.75rem;")
            location_display = Div(profile.get("location") or "—", style="padding: 0.5rem 0.75rem;")

        tab_content = Div(
            # Main info section
            Div(
                H3("Основная информация", style="margin-bottom: 1rem;"),
                Div(
                    Div(
                        Div(Strong("ФИО"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        full_name_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Email"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        Div(profile.get("email") or "—", style="padding: 0.5rem 0.75rem;"),
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Телефон"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        phone_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Должность"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        position_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Департамент"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        department_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Группа"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        sales_group_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Руководитель"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        manager_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Местонахождение"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        location_display,
                        cls="info-item"
                    ),
                    Div(
                        Div(Strong("Роль"), style="color: #666; font-size: 0.9em; margin-bottom: 0.5rem;"),
                        Div(profile.get("role_name") or "—", style="padding: 0.5rem 0.75rem;"),
                        cls="info-item"
                    ),
                    cls="info-grid",
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;"
                ),
            ),

            # Statistics section (DaisyUI stats)
            Div(
                H3("Статистика", style="margin: 2rem 0 1rem 0;"),
                Div(
                    stat_card(
                        value=str(stats["total_customers"]),
                        label="Клиенты",
                        description="клиентов"
                    ),
                    stat_card(
                        value=str(stats["total_quotes"]),
                        label="КП",
                        description="коммерческих предложений"
                    ),
                    stat_card(
                        value=f"${stats['total_quotes_sum_usd']:,.0f}",
                        label="Сумма КП",
                        description="общая сумма предложений"
                    ),
                    stat_card(
                        value=str(stats["total_specifications"]),
                        label="Спецификации",
                        description="спецификаций"
                    ),
                    stat_card(
                        value=f"${stats['total_specifications_sum_usd']:,.0f}",
                        label="Сумма спецификаций",
                        description="общая сумма сделок"
                    ),
                    stat_card(
                        value=f"${stats['total_profit_usd']:,.0f}",
                        label="Профит",
                        description="суммарный профит"
                    ),
                    cls="stats stats-vertical lg:stats-horizontal shadow",
                    style="background: var(--card-background-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));"
                ),
            )
        )

    elif tab == "specifications":
        # Get specifications
        specifications = get_user_specifications(user_id, org_id)

        # Build specifications table
        spec_rows = []
        for spec in specifications:
            last_quote_date_str = ""
            if spec["last_quote_date"]:
                from datetime import datetime
                if isinstance(spec["last_quote_date"], str):
                    last_quote_date = datetime.fromisoformat(spec["last_quote_date"].replace("Z", "+00:00"))
                else:
                    last_quote_date = spec["last_quote_date"]
                last_quote_date_str = last_quote_date.strftime("%d.%m.%Y")

            updated_at_str = ""
            if spec["updated_at"]:
                from datetime import datetime
                if isinstance(spec["updated_at"], str):
                    updated_at = datetime.fromisoformat(spec["updated_at"].replace("Z", "+00:00"))
                else:
                    updated_at = spec["updated_at"]
                updated_at_str = updated_at.strftime("%d.%m.%Y %H:%M")

            spec_rows.append(
                Tr(
                    Td(spec["customer_name"]),
                    Td(spec["customer_inn"]),
                    Td(spec["customer_category"]),
                    Td(f"${spec['quote_sum']:,.0f}"),
                    Td(f"${spec['spec_sum']:,.0f}"),
                    Td(last_quote_date_str),
                    Td(updated_at_str),
                )
            )

        tab_content = Div(
            H3(f"Спецификации ({len(specifications)})", style="margin-bottom: 1rem;"),
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("Клиент"),
                            Th("ИНН"),
                            Th("Категория"),
                            Th("Сумма КП"),
                            Th("Сумма спецификации"),
                            Th("Дата последнего КП"),
                            Th("Дата обновления"),
                        )
                    ),
                    Tbody(*spec_rows) if spec_rows else Tbody(
                        Tr(Td("Нет спецификаций", colspan="7", style="text-align: center; color: #999;"))
                    ),
                    cls="table-auto"
                ),
                cls="table-container"
            ) if specifications else Div(
                P("Нет спецификаций", style="text-align: center; color: #999; padding: 2rem;")
            ),
            id="tab-content"
        )

    elif tab == "customers":
        # Get customers
        customers = get_user_customers(user_id, org_id)

        # Build customers table
        customer_rows = []
        for customer in customers:
            last_quote_date_str = ""
            if customer["last_quote_date"]:
                from datetime import datetime
                if isinstance(customer["last_quote_date"], str):
                    last_quote_date = datetime.fromisoformat(customer["last_quote_date"].replace("Z", "+00:00"))
                else:
                    last_quote_date = customer["last_quote_date"]
                last_quote_date_str = last_quote_date.strftime("%d.%m.%Y")

            updated_at_str = ""
            if customer["updated_at"]:
                from datetime import datetime
                if isinstance(customer["updated_at"], str):
                    updated_at = datetime.fromisoformat(customer["updated_at"].replace("Z", "+00:00"))
                else:
                    updated_at = customer["updated_at"]
                updated_at_str = updated_at.strftime("%d.%m.%Y %H:%M")

            customer_rows.append(
                Tr(
                    Td(A(customer["customer_name"], href=f"/customers/{customer['customer_id']}")),
                    Td(customer["customer_inn"]),
                    Td(customer["customer_category"]),
                    Td(f"${customer['quotes_sum']:,.0f}"),
                    Td(f"${customer['specs_sum']:,.0f}"),
                    Td(last_quote_date_str),
                    Td(updated_at_str),
                )
            )

        tab_content = Div(
            H3(f"Клиенты ({len(customers)})", style="margin-bottom: 1rem;"),
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("Наименование"),
                            Th("ИНН"),
                            Th("Категория"),
                            Th("Сумма КП"),
                            Th("Сумма спецификаций"),
                            Th("Дата последнего КП"),
                            Th("Дата обновления"),
                        )
                    ),
                    Tbody(*customer_rows) if customer_rows else Tbody(
                        Tr(Td("Нет клиентов", colspan="7", style="text-align: center; color: #999;"))
                    ),
                    cls="table-auto"
                ),
                cls="table-container"
            ) if customers else Div(
                P("Нет клиентов", style="text-align: center; color: #999; padding: 2rem;")
            ),
            id="tab-content"
        )

    # Page layout
    return page_layout(
        f"Профиль: {profile.get('full_name') or profile.get('email')}",
        Div(
            Div(
                H2(profile.get("full_name") or profile.get("email"), style="margin-bottom: 0.5rem;"),
                P(profile.get("position") or profile.get("role_name") or "—", style="color: #666;"),
                style="margin-bottom: 1.5rem;"
            ),
            tabs_nav,
            tab_content,
            cls="card"
        ),
        session=session
    )


@rt("/profile/{user_id}/edit-field/{field_name}")
def get(user_id: str, field_name: str, session):
    """Return inline edit form for a specific profile field (admin only)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - only admins can edit profiles
    if not user_has_any_role(session, ["admin", "top_manager"]):
        return Div("У вас нет прав для редактирования профиля", id=f"field-{field_name}")

    user = session["user"]
    org_id = user.get("org_id")

    from services.user_profile_service import (
        get_user_profile,
        get_departments,
        get_sales_groups,
        get_organization_users
    )

    profile = get_user_profile(user_id, org_id)
    if not profile:
        return Div("Пользователь не найден")

    # Map field names to labels and current values
    field_config = {
        "full_name": ("ФИО", profile.get("full_name") or "", "text"),
        "phone": ("Телефон", profile.get("phone") or "", "text"),
        "position": ("Должность", profile.get("position") or "", "text"),
        "location": ("Местонахождение", profile.get("location") or "", "text"),
        "department_id": ("Департамент", None, "select"),
        "sales_group_id": ("Группа", None, "select"),
        "manager_id": ("Руководитель", None, "select"),
    }

    if field_name not in field_config:
        return Div("Неизвестное поле")

    label, value, input_type = field_config[field_name]

    # Style for modern inline editing
    input_style = "width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #3b82f6; border-radius: 0.375rem; font-size: inherit; outline: none;"

    if input_type == "text":
        input_elem = Input(
            type="text", value=value, name=field_name,
            autofocus=True,
            style=input_style,
            onkeydown="if(event.key === 'Escape') { document.getElementById('cancel-btn-" + field_name + "').click(); } else if(event.key === 'Enter') { event.target.form.requestSubmit(); }"
        )
        # Simple input - no visible buttons
        action_buttons = Div(
            Button("✕", type="button", id=f"cancel-btn-{field_name}",
                  hx_get=f"/profile/{user_id}/cancel-edit/{field_name}",
                  hx_target=f"#field-{field_name}",
                  hx_swap="outerHTML",
                  style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #999; cursor: pointer; padding: 0.25rem 0.5rem; font-size: 1.2em;"),
            style="position: relative;"
        )
    elif input_type == "select":
        # Get options based on field
        if field_name == "department_id":
            departments = get_departments(org_id)
            current_value = None
            for dept in departments:
                if profile.get("department") == dept.get("name"):
                    current_value = dept.get("id")
                    break
            options = [Option("Не указан", value="", selected=(not current_value))]
            options.extend([
                Option(dept.get("name"), value=dept.get("id"), selected=(dept.get("id") == current_value))
                for dept in departments
            ])
        elif field_name == "sales_group_id":
            sales_groups = get_sales_groups(org_id)
            current_value = None
            for sg in sales_groups:
                if profile.get("sales_group") == sg.get("name"):
                    current_value = sg.get("id")
                    break
            options = [Option("Не указан", value="", selected=(not current_value))]
            options.extend([
                Option(sg.get("name"), value=sg.get("id"), selected=(sg.get("id") == current_value))
                for sg in sales_groups
            ])
        elif field_name == "manager_id":
            users = get_organization_users(org_id)
            current_value = None
            for u in users:
                if profile.get("manager_email") == u.get("email"):
                    current_value = u.get("id")
                    break
            options = [Option("Не указан", value="", selected=(not current_value))]
            options.extend([
                Option(u.get("full_name") or u.get("email"), value=u.get("id"), selected=(u.get("id") == current_value))
                for u in users
                if u.get("id") != user_id  # Don't allow selecting self as manager
            ])
        else:
            options = [Option("Не указан", value="")]

        input_elem = Select(
            *options,
            name=field_name,
            autofocus=True,
            style=input_style,
            onchange="this.form.requestSubmit();"
        )
        # Select dropdown - auto-submit on change
        action_buttons = Div(
            Button("✕", type="button", id=f"cancel-btn-{field_name}",
                  hx_get=f"/profile/{user_id}/cancel-edit/{field_name}",
                  hx_target=f"#field-{field_name}",
                  hx_swap="outerHTML",
                  style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #999; cursor: pointer; padding: 0.25rem 0.5rem; font-size: 1.2em;"),
            style="position: relative;"
        )

    return Form(
        Div(
            input_elem,
            action_buttons,
            style="position: relative;"
        ),
        id=f"field-{field_name}",
        hx_post=f"/profile/{user_id}/update-field/{field_name}",
        hx_target=f"#field-{field_name}",
        hx_swap="outerHTML",
        style="margin: 0;"
    )


@rt("/profile/{user_id}/update-field/{field_name}")
async def post(user_id: str, field_name: str, session, request):
    """Update a specific profile field via inline editing (admin only)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - only admins can edit profiles
    if not user_has_any_role(session, ["admin", "top_manager"]):
        return Div("У вас нет прав для редактирования профиля", id=f"field-{field_name}")

    user = session["user"]
    org_id = user.get("org_id")

    from services.user_profile_service import get_user_profile, update_user_profile

    profile = get_user_profile(user_id, org_id)
    if not profile:
        return Div("Пользователь не найден")

    # Get form data
    form_data = await request.form()
    new_value = form_data.get(field_name, "")

    # Update profile
    update_data = {field_name: new_value if new_value else None}
    success = update_user_profile(user_id, org_id, **update_data)

    if not success:
        return Div("Ошибка обновления", id=f"field-{field_name}")

    # Get updated profile to show new value
    updated_profile = get_user_profile(user_id, org_id)

    # Map field names to display values
    display_values = {
        "full_name": updated_profile.get("full_name") or "—",
        "phone": updated_profile.get("phone") or "—",
        "position": updated_profile.get("position") or "—",
        "location": updated_profile.get("location") or "—",
        "department_id": updated_profile.get("department") or "—",
        "sales_group_id": updated_profile.get("sales_group") or "—",
        "manager_id": updated_profile.get("manager_email") or "—",
    }

    # Return updated display
    return _render_profile_field_display(user_id, field_name, display_values.get(field_name, "—"))


@rt("/profile/{user_id}/cancel-edit/{field_name}")
def get(user_id: str, field_name: str, session):
    """Cancel inline editing and return to display mode."""
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user.get("org_id")

    from services.user_profile_service import get_user_profile

    profile = get_user_profile(user_id, org_id)
    if not profile:
        return Div("Пользователь не найден")

    # Map field names to display values
    display_values = {
        "full_name": profile.get("full_name") or "—",
        "phone": profile.get("phone") or "—",
        "position": profile.get("position") or "—",
        "location": profile.get("location") or "—",
        "department_id": profile.get("department") or "—",
        "sales_group_id": profile.get("sales_group") or "—",
        "manager_id": profile.get("manager_email") or "—",
    }

    return _render_profile_field_display(user_id, field_name, display_values.get(field_name, "—"))


def _render_profile_field_display(user_id: str, field_name: str, value: str):
    """Helper function to render profile field in display mode with modern inline edit."""
    display_value = value if value and value != "—" else "Не указан"
    display_color = "#999" if not value or value == "—" else "#000"

    return Div(
        display_value,
        id=f"field-{field_name}",
        hx_get=f"/profile/{user_id}/edit-field/{field_name}",
        hx_target=f"#field-{field_name}",
        hx_swap="outerHTML",
        style=f"cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 0.375rem; transition: background 0.15s ease; color: {display_color};",
        onmouseover="this.style.background='#f3f4f6'",
        onmouseout="this.style.background='transparent'",
        title="Кликните для редактирования"
    )


# ============================================================================
# UI-009: Customer Contracts List
# ============================================================================

@rt("/customer-contracts")
def get(session, q: str = "", status: str = "", customer_id: str = ""):
    """
    Customer contracts list page with search and filters.

    Contracts track supply agreements with customers and manage
    specification numbering (next_specification_number counter).

    Query Parameters:
        q: Search query (matches contract_number or customer name)
        status: Filter by status ("active", "suspended", "terminated", or "" for all)
        customer_id: Filter by specific customer
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin, sales, or top_manager can view contracts
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div(
                H1("⛔ Доступ запрещён"),
                P("У вас нет прав для просмотра договоров."),
                P("Требуется одна из ролей: admin, sales, top_manager"),
                btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    # Import contract service functions
    from services.customer_contract_service import (
        get_all_contracts, get_contracts_for_customer, get_contracts_with_customer_names,
        search_contracts, get_contract_stats,
        CONTRACT_STATUS_NAMES, CONTRACT_STATUS_COLORS
    )
    from services.customer_service import get_all_customers, get_customer

    # Get contracts based on filters
    try:
        if q and q.strip():
            # Use search if query provided
            status_filter = None if status == "" else status
            contracts = search_contracts(
                organization_id=org_id,
                query=q.strip(),
                status=status_filter,
                limit=100
            )
        elif customer_id:
            # Filter by customer
            status_filter = None if status == "" else status
            contracts = get_contracts_for_customer(
                customer_id=customer_id,
                status=status_filter,
                limit=100
            )
        else:
            # Get all with filters
            status_filter = status if status else None
            contracts = get_contracts_with_customer_names(
                organization_id=org_id,
                status=status_filter,
                limit=100
            )

        # Get stats for summary
        stats = get_contract_stats(organization_id=org_id)

        # Get customers for filter dropdown
        customers = get_all_customers(organization_id=org_id, is_active=True, limit=200)

        # If filtering by customer, get customer name for display
        filter_customer = None
        if customer_id:
            filter_customer = get_customer(customer_id)

    except Exception as e:
        print(f"Error loading contracts: {e}")
        contracts = []
        stats = {"total": 0, "active": 0, "suspended": 0, "terminated": 0}
        customers = []
        filter_customer = None

    # Status options for filter
    status_options = [
        Option("Все статусы", value="", selected=(status == "")),
        Option("Действующие", value="active", selected=(status == "active")),
        Option("Приостановленные", value="suspended", selected=(status == "suspended")),
        Option("Расторгнутые", value="terminated", selected=(status == "terminated")),
    ]

    # Customer options for filter
    customer_options = [Option("Все клиенты", value="", selected=(customer_id == ""))]
    for c in customers:
        customer_options.append(Option(
            c.name[:40] + "..." if len(c.name) > 40 else c.name,
            value=c.id,
            selected=(customer_id == c.id)
        ))

    # Build contract rows
    contract_rows = []
    for c in contracts:
        status_class = {
            "active": "status-approved",
            "suspended": "status-pending",
            "terminated": "status-rejected"
        }.get(c.status, "")
        status_text = CONTRACT_STATUS_NAMES.get(c.status, c.status)

        contract_rows.append(
            Tr(
                Td(
                    Strong(c.contract_number),
                    style="font-family: monospace;"
                ),
                Td(c.customer_name or "—"),
                Td(c.contract_date.strftime("%d.%m.%Y") if c.contract_date else "—"),
                Td(str(c.next_specification_number - 1 if c.next_specification_number > 1 else 0)),
                Td(Span(status_text, cls=f"status-badge {status_class}")),
                Td(
                    A(icon("edit", size=14), href=f"/customer-contracts/{c.id}/edit", title="Редактировать", style="margin-right: 0.5rem;"),
                    A(icon("eye", size=14), href=f"/customer-contracts/{c.id}", title="Просмотр"),
                )
            )
        )

    # Build page title with filter info
    page_title = "Договоры с клиентами"
    if filter_customer:
        page_title = f"Договоры: {filter_customer.name}"

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    stat_card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 16px 20px;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    """

    filter_card_style = """
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 16px 20px;
        margin-bottom: 16px;
    """

    select_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 180px;
    """

    input_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 220px;
    """

    table_card_style = """
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    """

    return page_layout(page_title,
        # Header card with gradient
        Div(
            Div(
                # Title row
                Div(
                    icon("file-signature", size=24, color="#475569"),
                    Span(f" {page_title}", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                    Span(f" ({stats.get('total', 0)})", style="font-size: 16px; color: #64748b; margin-left: 4px;"),
                    style="display: flex; align-items: center;"
                ),
                # Subtitle
                P("Рамочные соглашения на поставку с клиентами",
                  style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
                style="flex: 1;"
            ),
            btn_link("Добавить договор", href="/customer-contracts/new", variant="success", icon_name="plus"),
            style=f"{header_card_style} display: flex; justify-content: space-between; align-items: center;"
        ),

        # Stats cards row (4 columns)
        Div(
            Div(
                Div(str(stats.get("total", 0)), style="font-size: 28px; font-weight: 700; color: #1e293b;"),
                Div("Всего", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("active", 0)), style="font-size: 28px; font-weight: 700; color: #10b981;"),
                Div("Действующих", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("suspended", 0)), style="font-size: 28px; font-weight: 700; color: #f59e0b;"),
                Div("Приостановлено", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("terminated", 0)), style="font-size: 28px; font-weight: 700; color: #ef4444;"),
                Div("Расторгнуто", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;"
        ),

        # Filters card
        Div(
            Form(
                Div(
                    # Search input
                    Input(type="text", name="q", value=q, placeholder="Номер договора...",
                          style=f"{input_style} margin-right: 12px;"),
                    # Filters
                    Select(*customer_options, name="customer_id", style=f"{select_style} margin-right: 8px;"),
                    Select(*status_options, name="status", style=f"{select_style} margin-right: 12px;"),
                    # Buttons
                    Button(icon("search", size=14), " Поиск", type="submit",
                           style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 8px;"),
                    A(icon("x", size=14), " Сбросить", href="/customer-contracts",
                      style="padding: 10px 16px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none;"),
                    style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px 0;"
                ),
                method="get",
                action="/customer-contracts"
            ),
            style=filter_card_style
        ),

        # Contracts table with styled container
        Div(
            Table(
                Thead(
                    Tr(
                        Th("Номер договора"),
                        Th("Клиент"),
                        Th("Дата"),
                        Th("Спецификаций"),
                        Th("Статус"),
                        Th("Действия"),
                    )
                ),
                Tbody(*contract_rows) if contract_rows else Tbody(
                    Tr(Td("Договоры не найдены. ", A("Добавить первый договор", href="/customer-contracts/new"),
                          colspan="6", style="text-align: center; padding: 2rem; color: #64748b;"))
                )
            ),
            style=table_card_style
        ),

        session=session
    )


# ============================================================================
# UI-009b: Create Customer Contract
# ============================================================================

@rt("/customer-contracts/new")
def get(session, customer_id: str = ""):
    """Form for creating a new customer contract."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания договоров.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    from services.customer_service import get_all_customers, get_customer

    # Pre-select customer if provided
    selected_customer = None
    if customer_id:
        selected_customer = get_customer(customer_id)

    # Get customers for dropdown (only if no customer pre-selected)
    customers = []
    if not selected_customer:
        customers = get_all_customers(organization_id=org_id, limit=200)

    # Generate suggested contract number
    from datetime import date
    today = date.today()
    suggested_number = f"ДП-{today.strftime('%Y%m%d')}"

    return page_layout("Новый договор",
        H1(icon("file-plus", size=28), " Новый договор", cls="page-header"),

        Div(
            Form(
                # Customer - show as read-only if pre-selected, otherwise dropdown
                Div(
                    Label("Клиент *", For="customer_id"),
                    # If customer is pre-selected, show as read-only with hidden input
                    Div(
                        Input(type="hidden", name="customer_id", value=customer_id),
                        Div(
                            selected_customer.name if selected_customer else "",
                            style="padding: 0.5rem 0.75rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; color: #374151;"
                        ),
                        style="width: 100%;"
                    ) if selected_customer else
                    # Otherwise show dropdown
                    Select(
                        Option("-- Выберите клиента --", value="", disabled=True, selected=True),
                        *[Option(c.name, value=c.id) for c in customers],
                        name="customer_id",
                        id="customer_id",
                        required=True,
                        cls="form-input"
                    ),
                    cls="form-group"
                ),

                # Contract number
                Div(
                    Label("Номер договора *", For="contract_number"),
                    Input(
                        name="contract_number",
                        id="contract_number",
                        type="text",
                        value=suggested_number,
                        required=True,
                        placeholder="Например: ДП-001/2025",
                        cls="form-input"
                    ),
                    cls="form-group"
                ),

                # Contract date
                Div(
                    Label("Дата договора *", For="contract_date"),
                    Input(
                        name="contract_date",
                        id="contract_date",
                        type="date",
                        value=today.isoformat(),
                        required=True,
                        cls="form-input"
                    ),
                    cls="form-group"
                ),

                # Status
                Div(
                    Label("Статус", For="status"),
                    Select(
                        Option("Действующий", value="active", selected=True),
                        Option("Приостановлен", value="suspended"),
                        Option("Расторгнут", value="terminated"),
                        name="status",
                        id="status",
                        cls="form-input"
                    ),
                    cls="form-group"
                ),

                # Notes
                Div(
                    Label("Примечания", For="notes"),
                    Textarea(
                        name="notes",
                        id="notes",
                        rows="3",
                        placeholder="Дополнительная информация о договоре...",
                        cls="form-input"
                    ),
                    cls="form-group"
                ),

                # Buttons
                Div(
                    btn("Создать договор", variant="success", icon_name="save", type="submit"),
                    btn_link("Отмена", href="/customer-contracts", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 0.5rem; margin-top: 1rem;"
                ),

                method="post",
                action="/customer-contracts/new"
            ),
            cls="card"
        ),

        session=session
    )


@rt("/customer-contracts/new")
def post(session, customer_id: str, contract_number: str, contract_date: str, status: str = "active", notes: str = ""):
    """Handle new contract creation."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания договоров.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    from services.customer_contract_service import create_contract
    from datetime import date

    try:
        # Parse date
        contract_date_obj = date.fromisoformat(contract_date) if contract_date else date.today()

        # Create contract
        contract = create_contract(
            organization_id=org_id,
            customer_id=customer_id,
            contract_number=contract_number.strip(),
            contract_date=contract_date_obj,
            status=status,
            notes=notes.strip() if notes else None
        )

        if contract:
            # Success - redirect to contract detail
            return RedirectResponse(f"/customer-contracts/{contract.id}", status_code=303)
        else:
            return page_layout("Ошибка",
                Div("Не удалось создать договор.", cls="alert alert-error"),
                btn_link("Назад", href="/customer-contracts/new", variant="secondary"),
                session=session
            )

    except ValueError as e:
        return page_layout("Ошибка",
            Div(f"Ошибка: {str(e)}", cls="alert alert-error"),
            btn_link("Назад", href=f"/customer-contracts/new?customer_id={customer_id}", variant="secondary"),
            session=session
        )
    except Exception as e:
        print(f"Error creating contract: {e}")
        return page_layout("Ошибка",
            Div(f"Ошибка создания договора: {str(e)}", cls="alert alert-error"),
            btn_link("Назад", href="/customer-contracts/new", variant="secondary"),
            session=session
        )


@rt("/customer-contracts/{contract_id}")
def get(contract_id: str, session):
    """Customer contract detail view page."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "sales", "top_manager"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра данной страницы.", cls="alert alert-error"),
            session=session
        )

    from services.customer_contract_service import (
        get_contract_with_customer, CONTRACT_STATUS_NAMES, CONTRACT_STATUS_COLORS
    )

    contract = get_contract_with_customer(contract_id)
    if not contract:
        return page_layout("Не найдено",
            Div("Договор не найден.", cls="alert alert-error"),
            btn_link("К списку договоров", href="/customer-contracts", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    status_text = CONTRACT_STATUS_NAMES.get(contract.status, contract.status)
    status_colors = {
        "active": ("#16a34a", "#dcfce7"),
        "suspended": ("#d97706", "#fef3c7"),
        "terminated": ("#dc2626", "#fee2e2"),
    }
    status_color, status_bg = status_colors.get(contract.status, ("#64748b", "#f1f5f9"))

    specs_count = contract.next_specification_number - 1 if contract.next_specification_number > 1 else 0

    return page_layout(f"Договор: {contract.contract_number}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Договоры", href="/customer-contracts",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("file-text", size=24, color="#0ea5e9"),
                        H1(f"Договор {contract.contract_number}", style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span(status_text, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {status_color}; background: {status_bg};"),
                        btn_link("Редактировать", href=f"/customer-contracts/{contract_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Main info card
        Div(
            Div(
                icon("clipboard-list", size=16, color="#64748b"),
                Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
            ),
            Div(
                Div(
                    Span("Номер договора", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(contract.contract_number, style="font-weight: 600; color: #0284c7; font-family: monospace; font-size: 16px;"),
                ),
                Div(
                    Span("Клиент", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(
                        A(contract.customer_name, href=f"/customers/{contract.customer_id}", style="color: #6366f1; font-weight: 500;") if contract.customer_name else "—",
                        style="font-size: 14px;"
                    ),
                ),
                Div(
                    Span("Дата договора", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(contract.contract_date.strftime("%d.%m.%Y") if contract.contract_date else "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                ),
                Div(
                    Span("Спецификаций создано", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                    Div(str(specs_count), style="font-weight: 600; color: #1e293b; font-size: 16px;"),
                ),
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;"
            ),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Notes card (if has notes)
        Div(
            Div(
                icon("message-square", size=16, color="#64748b"),
                Span("ПРИМЕЧАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;"
            ),
            P(contract.notes or "Нет примечаний", style="font-size: 14px; color: #1e293b; margin: 0;"),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if contract.notes else "",

        # Specifications info
        Div(
            Div(
                icon("file-stack", size=16, color="#64748b"),
                Span("СПЕЦИФИКАЦИИ ПО ДОГОВОРУ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;"
            ),
            P(f"По данному договору создано {specs_count} спецификаций.", style="font-size: 14px; color: #1e293b; margin: 0 0 8px 0;") if specs_count > 0 else
            P("По данному договору ещё нет спецификаций.", style="font-size: 14px; color: #64748b; margin: 0 0 8px 0;"),
            P(Span("Следующий номер спецификации: ", style="color: #64748b;"), Strong(f"№{contract.next_specification_number}", style="color: #1e293b;"), style="font-size: 14px; margin: 0 0 16px 0;"),
            btn_link("К контролю спецификаций", href="/dashboard?tab=spec-control", variant="secondary", icon_name="arrow-right"),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        session=session
    )


# ============================================================================
# UI-010: Locations Directory Page
# ============================================================================

@rt("/locations")
def get(session, q: str = "", country: str = "", type_filter: str = "", status: str = ""):
    """
    Locations directory page with search and filters.

    Locations are pickup/delivery points used in quote_items (pickup_location_id).
    Includes hubs (logistics centers) and customs clearance points.

    Query Parameters:
        q: Search query (matches code, city, country)
        country: Filter by country
        type_filter: Filter by type ("hub", "customs", or "" for all)
        status: Filter by status ("active", "inactive", or "" for all)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin, logistics, customs, procurement can view locations
    if not user_has_any_role(session, ["admin", "logistics", "customs", "procurement"]):
        return page_layout("Access Denied",
            Div(
                H1("⛔ Доступ запрещён"),
                P("У вас нет прав для просмотра справочника локаций."),
                P("Требуется одна из ролей: admin, logistics, customs, procurement"),
                btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    # Import location service functions
    from services.location_service import (
        get_all_locations, search_locations, get_unique_countries, get_location_stats
    )

    # Get locations based on filters
    try:
        # Determine hub/customs filters
        is_hub = True if type_filter == "hub" else None
        is_customs = True if type_filter == "customs" else None
        is_active = None
        if status == "active":
            is_active = True
        elif status == "inactive":
            is_active = False

        if q and q.strip():
            # Use search if query provided
            locations = search_locations(
                organization_id=org_id,
                query=q.strip(),
                is_hub_only=(type_filter == "hub"),
                is_customs_only=(type_filter == "customs"),
                limit=100
            )
            # Filter by country and status after search if needed
            if country:
                locations = [loc for loc in locations if loc.country == country]
            if is_active is not None:
                locations = [loc for loc in locations if loc.is_active == is_active]
        else:
            # Get all with filters
            locations = get_all_locations(
                organization_id=org_id,
                is_active=is_active,
                is_hub=is_hub,
                is_customs_point=is_customs,
                limit=100
            )
            # Filter by country if specified
            if country:
                locations = [loc for loc in locations if loc.country == country]

        # Get stats for summary
        stats = get_location_stats(organization_id=org_id)

        # Get unique countries for filter dropdown
        countries = get_unique_countries(organization_id=org_id)

    except Exception as e:
        print(f"Error loading locations: {e}")
        locations = []
        stats = {"total": 0, "active": 0, "inactive": 0, "hubs": 0, "customs_points": 0}
        countries = []

    # Status options for filter
    status_options = [
        Option("Все", value="", selected=(status == "")),
        Option("Активные", value="active", selected=(status == "active")),
        Option("Неактивные", value="inactive", selected=(status == "inactive")),
    ]

    # Type options for filter
    type_options = [
        Option("Все типы", value="", selected=(type_filter == "")),
        Option("Хабы", value="hub", selected=(type_filter == "hub")),
        Option("Таможенные пункты", value="customs", selected=(type_filter == "customs")),
    ]

    # Country options for filter
    country_options = [Option("Все страны", value="", selected=(country == ""))]
    for c in countries:
        country_options.append(Option(c, value=c, selected=(country == c)))

    # Build location rows
    location_rows = []
    for loc in locations:
        status_class = "status-approved" if loc.is_active else "status-rejected"
        status_text = "Активна" if loc.is_active else "Неактивна"

        # Type badges
        type_badges = []
        if loc.is_hub:
            type_badges.append(Span(icon("building-2", size=12), " Хаб", cls="badge badge-primary", style="margin-right: 0.25rem; display: inline-flex; align-items: center; gap: 0.25rem;"))
        if loc.is_customs_point:
            type_badges.append(Span(icon("shield-check", size=12), " Таможня", cls="badge badge-info", style="margin-right: 0.25rem; display: inline-flex; align-items: center; gap: 0.25rem;"))

        location_rows.append(
            Tr(
                Td(
                    Strong(loc.code) if loc.code else "—",
                    style="font-family: monospace;"
                ),
                Td(loc.city or "—"),
                Td(loc.country),
                Td(*type_badges if type_badges else ["—"]),
                Td(loc.address[:50] + "..." if loc.address and len(loc.address) > 50 else (loc.address or "—")),
                Td(Span(status_text, cls=f"status-badge {status_class}")),
                Td(
                    A(icon("edit", size=14), href=f"/locations/{loc.id}/edit", title="Редактировать", style="margin-right: 0.5rem;"),
                    A(icon("eye", size=14), href=f"/locations/{loc.id}", title="Просмотр"),
                )
            )
        )

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    stat_card_style = """
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 16px 20px;
        text-align: center;
        box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    """

    filter_card_style = """
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 16px 20px;
        margin-bottom: 16px;
    """

    select_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 140px;
    """

    input_style = """
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        width: 220px;
    """

    table_card_style = """
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        overflow: hidden;
    """

    return page_layout("Справочник локаций",
        # Header card with gradient
        Div(
            Div(
                # Title row
                Div(
                    icon("map-pin", size=24, color="#475569"),
                    Span(" Локации", style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 8px;"),
                    Span(f" ({stats.get('total', 0)})", style="font-size: 16px; color: #64748b; margin-left: 4px;"),
                    style="display: flex; align-items: center;"
                ),
                # Subtitle
                P("Точки получения и доставки товаров",
                  style="margin: 6px 0 0 0; font-size: 13px; color: #64748b;"),
                style="flex: 1;"
            ),
            btn_link("Добавить локацию", href="/locations/new", variant="success", icon_name="plus"),
            style=f"{header_card_style} display: flex; justify-content: space-between; align-items: center;"
        ),

        # Stats cards row (4 columns)
        Div(
            Div(
                Div(str(stats.get("total", 0)), style="font-size: 28px; font-weight: 700; color: #1e293b;"),
                Div("Всего", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("active", 0)), style="font-size: 28px; font-weight: 700; color: #10b981;"),
                Div("Активных", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("hubs", 0)), style="font-size: 28px; font-weight: 700; color: #3b82f6;"),
                Div("Хабов", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            Div(
                Div(str(stats.get("customs_points", 0)), style="font-size: 28px; font-weight: 700; color: #f59e0b;"),
                Div("Таможенных", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=stat_card_style
            ),
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;"
        ),

        # Filters card
        Div(
            Form(
                Div(
                    # Search input
                    Input(type="text", name="q", value=q, placeholder="Код, город или страна...",
                          style=f"{input_style} margin-right: 12px;"),
                    # Filters
                    Select(*country_options, name="country", style=f"{select_style} margin-right: 8px;"),
                    Select(*type_options, name="type_filter", style=f"{select_style} margin-right: 8px;"),
                    Select(*status_options, name="status", style=f"{select_style} margin-right: 12px;"),
                    # Buttons
                    Button(icon("search", size=14), " Поиск", type="submit",
                           style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 8px;"),
                    A(icon("x", size=14), " Сбросить", href="/locations",
                      style="padding: 10px 16px; background: #f1f5f9; color: #475569; border: none; border-radius: 6px; font-size: 14px; text-decoration: none;"),
                    style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px 0;"
                ),
                method="get",
                action="/locations"
            ),
            style=filter_card_style
        ),

        # Locations table with styled container
        Div(
            Table(
                Thead(
                    Tr(
                        Th("Код"),
                        Th("Город"),
                        Th("Страна"),
                        Th("Тип"),
                        Th("Адрес"),
                        Th("Статус"),
                        Th("Действия"),
                    )
                ),
                Tbody(*location_rows) if location_rows else Tbody(
                    Tr(Td("Локации не найдены. ", A("Добавьте первую локацию", href="/locations/new"), " или ", A("загрузите стандартные", href="/locations/seed"), ".",
                          colspan="7", style="text-align: center; padding: 2rem; color: #64748b;"))
                )
            ),
            style=table_card_style
        ),

        session=session
    )


# NOTE: /locations/new routes MUST be defined BEFORE /locations/{location_id}
# to prevent "new" from being matched as a location_id parameter
@rt("/locations/new")
def get_new_location(session):
    """Show form to create a new location."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin or logistics can create locations
    if not user_has_any_role(session, ["admin", "logistics"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания локаций. Требуется роль: admin или logistics", cls="alert alert-error"),
            session=session
        )

    return _location_form(session=session)


@rt("/locations/new")
def post_new_location(
    country: str,
    code: str = "",
    city: str = "",
    address: str = "",
    is_hub: str = "",
    is_customs_point: str = "",
    notes: str = "",
    session=None
):
    """Handle location creation form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "logistics"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для создания локаций.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")
    user_id = user.get("id")

    from services.location_service import create_location, validate_location_code, validate_country

    # Normalize code to uppercase
    code = code.strip().upper() if code else ""

    # Validate country
    if not validate_country(country):
        return _location_form(error="Страна обязательна для заполнения", session=session)

    # Validate code format if provided
    if code and not validate_location_code(code):
        return _location_form(
            error="Код локации должен состоять из 2-5 заглавных латинских букв (например, MSK, SPB, SH)",
            session=session
        )

    try:
        location = create_location(
            organization_id=org_id,
            country=country.strip(),
            city=city.strip() if city else None,
            code=code if code else None,
            address=address.strip() if address else None,
            is_hub=bool(is_hub),
            is_customs_point=bool(is_customs_point),
            is_active=True,
            notes=notes.strip() if notes else None,
            created_by=user_id,
        )

        if location:
            return RedirectResponse(f"/locations/{location.id}", status_code=303)
        else:
            return _location_form(
                error="Локация с таким кодом уже существует или произошла ошибка",
                session=session
            )

    except ValueError as e:
        return _location_form(error=str(e), session=session)
    except Exception as e:
        print(f"Error creating location: {e}")
        return _location_form(error=f"Ошибка при создании: {e}", session=session)


@rt("/locations/{location_id}")
def get(location_id: str, session):
    """Location detail view page."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "logistics", "customs", "procurement"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра данной страницы.", cls="alert alert-error"),
            session=session
        )

    from services.location_service import get_location

    location = get_location(location_id)
    if not location:
        return page_layout("Не найдено",
            Div("Локация не найдена.", cls="alert alert-error"),
            btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    status_text = "Активна" if location.is_active else "Неактивна"
    display_name = location.display_name or f"{location.code or ''} - {location.city or ''}, {location.country}".strip(" -,")

    return page_layout(f"Локация: {display_name}",
        # Header card with gradient
        Div(
            Div(
                Div(
                    A(icon("arrow-left", size=18), " Локации", href="/locations",
                      style="color: #64748b; text-decoration: none; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"),
                    style="margin-bottom: 12px;"
                ),
                Div(
                    Div(
                        icon("map-pin", size=24, color="#0ea5e9"),
                        H1(display_name, style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #1e293b;"),
                        Span(location.code, style="font-family: monospace; font-size: 14px; padding: 4px 10px; background: #e0f2fe; color: #0284c7; border-radius: 6px; font-weight: 600;") if location.code else "",
                        style="display: flex; align-items: center; gap: 12px;"
                    ),
                    Div(
                        Span(status_text, style=f"display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: {'#16a34a' if location.is_active else '#dc2626'}; background: {'#dcfce7' if location.is_active else '#fee2e2'};"),
                        Span(icon("building-2", size=12), " Хаб", style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: #7c3aed; background: #f3e8ff;") if location.is_hub else "",
                        Span(icon("shield-check", size=12), " Таможня", style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; color: #0284c7; background: #e0f2fe;") if location.is_customs_point else "",
                        btn_link("Редактировать", href=f"/locations/{location_id}/edit", variant="secondary", icon_name="edit", size="sm"),
                        style="display: flex; align-items: center; gap: 8px;"
                    ),
                    style="display: flex; justify-content: space-between; align-items: center;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Main info cards grid
        Div(
            # Card 1: Location Info
            Div(
                Div(
                    icon("clipboard-list", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Код", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(location.code or "—", style="font-weight: 600; color: #0284c7; font-family: monospace; font-size: 16px;"),
                    ),
                    Div(
                        Span("Город", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(location.city or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Страна", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(location.country, style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    Div(
                        Span("Адрес", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(location.address or "—", style="font-weight: 500; color: #1e293b; font-size: 14px;"),
                    ),
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Card 2: Classification
            Div(
                Div(
                    icon("tag", size=16, color="#64748b"),
                    Span("КЛАССИФИКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Span("Логистический хаб", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(
                            Span(icon("check-circle", size=14, color="#16a34a"), " Да", style="display: inline-flex; align-items: center; gap: 4px; color: #16a34a; font-weight: 500;") if location.is_hub else
                            Span(icon("x-circle", size=14, color="#94a3b8"), " Нет", style="display: inline-flex; align-items: center; gap: 4px; color: #64748b;"),
                            style="font-size: 14px; margin-top: 4px;"
                        ),
                    ),
                    Div(
                        Span("Таможенный пункт", style="font-size: 11px; color: #64748b; text-transform: uppercase;"),
                        Div(
                            Span(icon("check-circle", size=14, color="#16a34a"), " Да", style="display: inline-flex; align-items: center; gap: 4px; color: #16a34a; font-weight: 500;") if location.is_customs_point else
                            Span(icon("x-circle", size=14, color="#94a3b8"), " Нет", style="display: inline-flex; align-items: center; gap: 4px; color: #64748b;"),
                            style="font-size: 14px; margin-top: 4px;"
                        ),
                    ),
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;"
                ),
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;"
        ),

        # Notes card (if has notes)
        Div(
            Div(
                icon("message-square", size=16, color="#64748b"),
                Span("ПРИМЕЧАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;"
            ),
            P(location.notes or "Нет примечаний", style="font-size: 14px; color: #1e293b; margin: 0;"),
            style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if location.notes else "",

        session=session
    )


def _location_form(location=None, error=None, session=None):
    """Helper function to render location create/edit form."""
    is_edit = location is not None
    title = f"Редактирование: {location.display_name or location.city or location.country}" if is_edit else "Новая локация"
    action_url = f"/locations/{location.id}/edit" if is_edit else "/locations/new"

    # Design system styles
    header_card_style = """
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border-radius: 12px;
        border: 1px solid #a7f3d0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 20px 24px;
        margin-bottom: 20px;
    """

    form_card_style = """
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        padding: 24px;
    """

    input_style = """
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        background: #f8fafc;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    """

    label_style = """
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 6px;
        display: block;
    """

    section_header_style = """
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e2e8f0;
    """

    checkbox_card_style = """
        padding: 14px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        background: #f8fafc;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
    """

    return page_layout(title,
        # Error alert
        Div(
            icon("alert-circle", size=16, color="#dc2626"),
            Span(error, style="margin-left: 8px;"),
            style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ) if error else "",

        # Header card with gradient (green theme for locations)
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#047857"),
                    Span("Локации", style="margin-left: 6px;"),
                    href="/locations",
                    style="display: inline-flex; align-items: center; color: #047857; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("map-pin" if not is_edit else "edit", size=24, color="#059669"),
                    Span(title, style="font-size: 20px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    style="display: flex; align-items: center;"
                ),
            ),
            style=header_card_style
        ),

        # Info alert
        Div(
            icon("lightbulb", size=16, color="#0369a1"),
            Span(" Локация — это точка получения или доставки товаров. Код (2-5 букв) используется для быстрого поиска. Отметьте как хаб или таможенный пункт при необходимости.", style="margin-left: 8px;"),
            style="background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center;"
        ),

        # Form card
        Div(
            Form(
                # Section: Main info
                Div(
                    icon("map", size=16, color="#64748b"),
                    Span("ОСНОВНАЯ ИНФОРМАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Label("Код (2-5 букв)", style=label_style),
                        Input(
                            name="code",
                            value=location.code if location else "",
                            placeholder="MSK",
                            pattern="[A-Za-z]{2,5}",
                            title="2-5 латинских букв",
                            maxlength="5",
                            style=f"{input_style} text-transform: uppercase; font-family: monospace; font-weight: bold;"
                        ),
                        Small("Необязательно. Например: MSK, SPB, SH, GZ", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 4px;"),
                        style="flex: 1;"
                    ),
                    Div(style="flex: 2;"),  # Spacer
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Div(
                        Label("Страна *", style=label_style),
                        Input(name="country", value=location.country if location else "Россия", placeholder="Россия", required=True, style=input_style),
                        style="flex: 1;"
                    ),
                    Div(
                        Label("Город", style=label_style),
                        Input(name="city", value=location.city if location else "", placeholder="Москва", style=input_style),
                        style="flex: 1;"
                    ),
                    style="display: flex; gap: 16px; margin-bottom: 16px;"
                ),
                Div(
                    Label("Адрес (полный)", style=label_style),
                    Textarea(
                        location.address if location else "",
                        name="address",
                        placeholder="ул. Примерная, д. 1, склад №5",
                        rows="2",
                        style=f"{input_style} resize: vertical;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Section: Classification
                Div(
                    icon("tag", size=16, color="#64748b"),
                    Span("КЛАССИФИКАЦИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Label(
                        Input(
                            type="checkbox",
                            name="is_hub",
                            value="1",
                            checked=location.is_hub if location else False,
                            style="accent-color: #059669; margin-right: 10px;"
                        ),
                        icon("building-2", size=16, color="#64748b"),
                        Span(" Логистический хаб", style="font-weight: 500; color: #1e293b; margin-left: 4px;"),
                        Br(),
                        Small("Центр консолидации и отправки грузов", style="color: #94a3b8; font-size: 12px; margin-left: 30px; display: block; margin-top: 2px;"),
                        style="cursor: pointer; display: block;"
                    ),
                    style=checkbox_card_style
                ),
                Div(
                    Label(
                        Input(
                            type="checkbox",
                            name="is_customs_point",
                            value="1",
                            checked=location.is_customs_point if location else False,
                            style="accent-color: #059669; margin-right: 10px;"
                        ),
                        icon("shield-check", size=16, color="#64748b"),
                        Span(" Таможенный пункт", style="font-weight: 500; color: #1e293b; margin-left: 4px;"),
                        Br(),
                        Small("Пункт таможенного оформления", style="color: #94a3b8; font-size: 12px; margin-left: 30px; display: block; margin-top: 2px;"),
                        style="cursor: pointer; display: block;"
                    ),
                    style=checkbox_card_style
                ),

                # Section: Notes
                Div(
                    icon("file-text", size=16, color="#64748b"),
                    Span("ПРИМЕЧАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=f"{section_header_style} margin-top: 24px;"
                ),
                Div(
                    Label("Заметки", style=label_style),
                    Textarea(
                        location.notes if location else "",
                        name="notes",
                        placeholder="Дополнительная информация о локации...",
                        rows="3",
                        style=f"{input_style} resize: vertical;"
                    ),
                    style="margin-bottom: 20px;"
                ),

                # Status (edit only)
                Div(
                    Div(
                        icon("toggle-left", size=16, color="#64748b"),
                        Span("СТАТУС", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                        style=f"{section_header_style} margin-top: 24px;"
                    ),
                    Label(
                        Input(
                            type="checkbox",
                            name="is_active",
                            value="1",
                            checked=location.is_active if location else True,
                            style="accent-color: #059669; margin-right: 8px;"
                        ),
                        Span("Активная локация", style="font-size: 14px; color: #1e293b;"),
                        style="display: flex; align-items: center; cursor: pointer;"
                    ),
                    Small("Неактивные локации не отображаются в выпадающих списках", style="color: #94a3b8; font-size: 12px; display: block; margin-top: 6px;"),
                ) if is_edit else "",

                # Form actions
                Div(
                    btn("Сохранить", variant="primary", icon_name="check", type="submit"),
                    btn_link("Отмена", href="/locations" if not is_edit else f"/locations/{location.id}", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; margin-top: 24px; border-top: 1px solid #e2e8f0;"
                ),

                method="post",
                action=action_url
            ),
            style=form_card_style
        ),
        session=session
    )


@rt("/locations/{location_id}/edit")
def get(location_id: str, session):
    """Show form to edit an existing location."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin or logistics can edit locations
    if not user_has_any_role(session, ["admin", "logistics"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования локаций.", cls="alert alert-error"),
            session=session
        )

    from services.location_service import get_location

    location = get_location(location_id)

    if not location:
        return page_layout("Локация не найдена",
            Div("Запрашиваемая локация не существует.", cls="alert alert-error"),
            btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    return _location_form(location=location, session=session)


@rt("/locations/{location_id}/edit")
def post(
    location_id: str,
    country: str,
    code: str = "",
    city: str = "",
    address: str = "",
    is_hub: str = "",
    is_customs_point: str = "",
    notes: str = "",
    is_active: str = "",
    session=None
):
    """Handle location edit form submission."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "logistics"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для редактирования локаций.", cls="alert alert-error"),
            session=session
        )

    from services.location_service import (
        get_location, update_location, validate_location_code, validate_country
    )

    location = get_location(location_id)
    if not location:
        return page_layout("Локация не найдена",
            Div("Запрашиваемая локация не существует.", cls="alert alert-error"),
            btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Normalize code to uppercase
    code = code.strip().upper() if code else ""

    # Validate country
    if not validate_country(country):
        return _location_form(location=location, error="Страна обязательна для заполнения", session=session)

    # Validate code format if provided
    if code and not validate_location_code(code):
        return _location_form(
            location=location,
            error="Код локации должен состоять из 2-5 заглавных латинских букв (например, MSK, SPB, SH)",
            session=session
        )

    try:
        updated = update_location(
            location_id=location_id,
            country=country.strip(),
            city=city.strip() if city else None,
            code=code if code else None,
            address=address.strip() if address else None,
            is_hub=bool(is_hub),
            is_customs_point=bool(is_customs_point),
            is_active=bool(is_active),
            notes=notes.strip() if notes else None,
        )

        if updated:
            return RedirectResponse(f"/locations/{location_id}", status_code=303)
        else:
            return _location_form(
                location=location,
                error="Не удалось обновить локацию. Возможно, код уже используется другой локацией.",
                session=session
            )

    except ValueError as e:
        return _location_form(location=location, error=str(e), session=session)
    except Exception as e:
        print(f"Error updating location: {e}")
        return _location_form(location=location, error=f"Ошибка при обновлении: {e}", session=session)


@rt("/locations/{location_id}/delete")
def post(location_id: str, session):
    """Handle location deletion (soft delete - deactivate)."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only can delete
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("Только администратор может удалять локации.", cls="alert alert-error"),
            session=session
        )

    from services.location_service import deactivate_location

    result = deactivate_location(location_id)

    if result:
        return RedirectResponse("/locations", status_code=303)
    else:
        return page_layout("Ошибка",
            Div("Не удалось деактивировать локацию.", cls="alert alert-error"),
            btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
            session=session
        )


@rt("/locations/seed")
def get(session):
    """Seed default locations for the organization."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin only can seed
    if not user_has_role(session, "admin"):
        return page_layout("Access Denied",
            Div("Только администратор может загружать стандартные локации.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")
    user_id = user.get("id")

    from services.location_service import seed_default_locations

    try:
        count = seed_default_locations(organization_id=org_id, created_by=user_id)

        return page_layout("Локации загружены",
            Div(
                H1(icon("check-circle", size=28), " Стандартные локации загружены", cls="page-header"),
                P(f"Создано локаций: {count}"),
                P("Локации включают основные города Китая, России, Казахстана, Турции и Европы."),
                btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    except Exception as e:
        print(f"Error seeding locations: {e}")
        return page_layout("Ошибка",
            Div(f"Ошибка при загрузке локаций: {e}", cls="alert alert-error"),
            btn_link("К списку локаций", href="/locations", variant="secondary", icon_name="arrow-left"),
            session=session
        )


# ============================================================================
# SUPPLIER INVOICES ROUTES
# ============================================================================

@rt("/supplier-invoices")
def get(session, q: str = "", supplier_id: str = "", status: str = ""):
    """
    Supplier invoices registry page with filters.

    Query Parameters:
        q: Search query (matches invoice number)
        supplier_id: Filter by supplier
        status: Filter by status (pending, partially_paid, paid, overdue, cancelled)
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions - admin, procurement, finance roles
    if not user_has_any_role(session, ["admin", "procurement", "finance"]):
        return page_layout("Access Denied",
            Div(
                H1("⛔ Доступ запрещён"),
                P("У вас нет прав для просмотра реестра инвойсов поставщиков."),
                P("Требуется роль: admin, procurement или finance"),
                btn_link("На главную", href="/dashboard", variant="secondary", icon_name="arrow-left"),
                cls="card"
            ),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    # Import invoice service
    from services.supplier_invoice_service import (
        get_all_invoices, search_invoices, get_invoice_summary,
        get_invoice_status_name, get_invoice_status_color,
        INVOICE_STATUSES, INVOICE_STATUS_NAMES
    )
    from services.supplier_service import get_all_suppliers

    # Get invoices based on filters
    try:
        if q and q.strip():
            # Use search if query provided
            invoices = search_invoices(
                organization_id=org_id,
                query_text=q.strip(),
                limit=100
            )
        else:
            # Get all with filters
            invoices = get_all_invoices(
                organization_id=org_id,
                status=status if status else None,
                supplier_id=supplier_id if supplier_id else None,
                limit=100
            )

        # Get suppliers for filter dropdown
        suppliers = get_all_suppliers(organization_id=org_id, is_active=True, limit=200)

        # Get summary stats
        summary = get_invoice_summary(organization_id=org_id)

    except Exception as e:
        print(f"Error loading supplier invoices: {e}")
        invoices = []
        suppliers = []
        from services.supplier_invoice_service import InvoiceSummary
        summary = InvoiceSummary()

    # Build supplier options for filter
    supplier_options = [Option("Все поставщики", value="")] + [
        Option(f"{s.supplier_code} - {s.name}", value=str(s.id), selected=(str(s.id) == supplier_id))
        for s in suppliers
    ]

    # Status options
    status_options = [
        Option("Все статусы", value="", selected=(status == "")),
    ] + [
        Option(INVOICE_STATUS_NAMES.get(s, s), value=s, selected=(status == s))
        for s in INVOICE_STATUSES
    ]

    # Status color mapping for CSS classes
    status_color_classes = {
        "pending": "status-pending",
        "partially_paid": "status-in-progress",
        "paid": "status-approved",
        "overdue": "status-rejected",
        "cancelled": "status-cancelled",
    }

    # Build invoice rows
    invoice_rows = []
    for inv in invoices:
        status_cls = status_color_classes.get(inv.status, "status-pending")
        status_text = get_invoice_status_name(inv.status)

        # Format amounts
        total_formatted = f"{inv.total_amount:,.2f}" if inv.total_amount else "0.00"
        paid_formatted = f"{inv.paid_amount:,.2f}" if inv.paid_amount else "0.00"
        remaining = (inv.total_amount or 0) - (inv.paid_amount or 0)
        remaining_formatted = f"{remaining:,.2f}"

        # Format dates
        invoice_date_str = inv.invoice_date.strftime("%d.%m.%Y") if inv.invoice_date else "—"
        due_date_str = inv.due_date.strftime("%d.%m.%Y") if inv.due_date else "—"

        # Overdue indicator
        overdue_badge = Span(icon("alert-triangle", size=14), title="Просрочено!", style="color: #dc3545; margin-left: 0.25rem;") if inv.is_overdue else ""

        invoice_rows.append(
            Tr(
                Td(
                    A(
                        Strong(inv.invoice_number),
                        href=f"/supplier-invoices/{inv.id}",
                        style="font-family: monospace; color: #4a4aff; text-decoration: none;"
                    )
                ),
                Td(f"{inv.supplier_code or ''} - {inv.supplier_name or '—'}" if inv.supplier_name else "—"),
                Td(invoice_date_str),
                Td(due_date_str, overdue_badge),
                Td(f"{total_formatted} {inv.currency}", style="text-align: right;"),
                Td(f"{paid_formatted} {inv.currency}", style="text-align: right; color: #28a745;"),
                Td(f"{remaining_formatted} {inv.currency}", style="text-align: right; color: #dc3545;" if remaining > 0 else "text-align: right;"),
                Td(Span(status_text, cls=f"status-badge {status_cls}")),
                Td(
                    A(icon("eye", size=14), href=f"/supplier-invoices/{inv.id}", title="Просмотр", style="margin-right: 0.5rem;"),
                    A(icon("edit", size=14), href=f"/supplier-invoices/{inv.id}/edit", title="Редактировать"),
                )
            )
        )

    # Design system styles
    input_style = "width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc;"
    select_style = "padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; background: #f8fafc; min-width: 150px;"
    th_style = "text-align: left; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"
    td_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"

    return page_layout("Инвойсы поставщиков",
        # Header card with gradient
        Div(
            Div(
                Div(
                    icon("receipt", size=24, color="#6366f1"),
                    Span("Реестр инвойсов поставщиков", style="font-size: 22px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    Span(f"{len(invoices)}", style="background: #e0e7ff; color: #4f46e5; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; margin-left: 12px;"),
                    style="display: flex; align-items: center;"
                ),
                btn_link("Добавить инвойс", href="/supplier-invoices/new", variant="primary", icon_name="plus"),
                style="display: flex; justify-content: space-between; align-items: center;"
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Stats cards grid
        Div(
            # Total
            Div(
                Div(
                    icon("file-text", size=20, color="#64748b"),
                    style="margin-bottom: 8px;"
                ),
                Div(str(summary.total), style="font-size: 28px; font-weight: 700; color: #1e293b;"),
                Div("Всего инвойсов", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Pending
            Div(
                Div(
                    icon("clock", size=20, color="#f59e0b"),
                    style="margin-bottom: 8px;"
                ),
                Div(str(summary.pending), style="font-size: 28px; font-weight: 700; color: #f59e0b;"),
                Div("Ожидает оплаты", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Partially paid
            Div(
                Div(
                    icon("pie-chart", size=20, color="#0ea5e9"),
                    style="margin-bottom: 8px;"
                ),
                Div(str(summary.partially_paid), style="font-size: 28px; font-weight: 700; color: #0ea5e9;"),
                Div("Частично оплачено", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Paid
            Div(
                Div(
                    icon("check-circle", size=20, color="#22c55e"),
                    style="margin-bottom: 8px;"
                ),
                Div(str(summary.paid), style="font-size: 28px; font-weight: 700; color: #22c55e;"),
                Div("Оплачено", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Overdue
            Div(
                Div(
                    icon("alert-triangle", size=20, color="#ef4444"),
                    style="margin-bottom: 8px;"
                ),
                Div(str(summary.overdue), style="font-size: 28px; font-weight: 700; color: #ef4444;"),
                Div("Просрочено", style="font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 20px;"
        ),

        # Summary amounts card
        Div(
            Div(
                Div(
                    icon("wallet", size=16, color="#64748b"),
                    Span("СВОДКА ПО СУММАМ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 8px;"),
                    style="display: flex; align-items: center; margin-bottom: 12px;"
                ),
                Div(
                    Span("К оплате: ", style="color: #64748b;"),
                    Span(f"{summary.pending_amount:,.2f} ₽", style="color: #ef4444; font-weight: 600;"),
                    Span(" • ", style="color: #cbd5e1; margin: 0 12px;"),
                    Span("Оплачено: ", style="color: #64748b;"),
                    Span(f"{summary.paid_amount:,.2f} ₽", style="color: #22c55e; font-weight: 600;"),
                    Span(" • ", style="color: #cbd5e1; margin: 0 12px;"),
                    Span("Всего: ", style="color: #64748b;"),
                    Span(f"{summary.total_amount:,.2f} ₽", style="color: #1e293b; font-weight: 600;"),
                    style="font-size: 15px;"
                ),
            ),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Filters card
        Div(
            Form(
                Div(
                    icon("search", size=16, color="#64748b"),
                    Span("ФИЛЬТРЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 8px;"),
                    style="display: flex; align-items: center; margin-bottom: 12px;"
                ),
                Div(
                    Input(name="q", value=q, placeholder="Поиск по номеру инвойса...", style=f"{input_style} flex: 2;"),
                    Select(*supplier_options, name="supplier_id", style=f"{select_style} flex: 2;"),
                    Select(*status_options, name="status", style=f"{select_style} flex: 1;"),
                    btn("Поиск", variant="primary", icon_name="search", type="submit"),
                    btn_link("Сбросить", href="/supplier-invoices", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 12px; align-items: center;"
                ),
                method="get",
                action="/supplier-invoices"
            ),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Table card
        Div(
            Div(
                Table(
                    Thead(
                        Tr(
                            Th("№ Инвойса", style=th_style),
                            Th("Поставщик", style=th_style),
                            Th("Дата", style=th_style),
                            Th("Срок оплаты", style=th_style),
                            Th("Сумма", style=f"{th_style} text-align: right;"),
                            Th("Оплачено", style=f"{th_style} text-align: right;"),
                            Th("Остаток", style=f"{th_style} text-align: right;"),
                            Th("Статус", style=th_style),
                            Th("", style=th_style)
                        )
                    ),
                    Tbody(*[
                        Tr(
                            Td(
                                A(
                                    Strong(inv.invoice_number),
                                    href=f"/supplier-invoices/{inv.id}",
                                    style="font-family: monospace; color: #6366f1; text-decoration: none; font-weight: 600;"
                                ),
                                style=td_style
                            ),
                            Td(f"{inv.supplier_code or ''} - {inv.supplier_name or '—'}" if inv.supplier_name else "—", style=td_style),
                            Td(inv.invoice_date.strftime("%d.%m.%Y") if inv.invoice_date else "—", style=td_style),
                            Td(
                                inv.due_date.strftime("%d.%m.%Y") if inv.due_date else "—",
                                Span(icon("alert-triangle", size=14), title="Просрочено!", style="color: #ef4444; margin-left: 6px;") if inv.is_overdue else "",
                                style=td_style
                            ),
                            Td(f"{inv.total_amount:,.2f}" if inv.total_amount else "0.00", Span(f" {inv.currency}", style="color: #94a3b8;"), style=f"{td_style} text-align: right; font-weight: 500;"),
                            Td(f"{inv.paid_amount:,.2f}" if inv.paid_amount else "0.00", Span(f" {inv.currency}", style="color: #94a3b8;"), style=f"{td_style} text-align: right; color: #22c55e; font-weight: 500;"),
                            Td(
                                f"{(inv.total_amount or 0) - (inv.paid_amount or 0):,.2f}",
                                Span(f" {inv.currency}", style="color: #94a3b8;"),
                                style=f"{td_style} text-align: right; color: {'#ef4444' if (inv.total_amount or 0) - (inv.paid_amount or 0) > 0 else '#64748b'}; font-weight: 500;"
                            ),
                            Td(status_badge(inv.status), style=td_style),
                            Td(
                                A(icon("eye", size=16, color="#64748b"), href=f"/supplier-invoices/{inv.id}", title="Просмотр", style="margin-right: 8px;"),
                                A(icon("edit", size=16, color="#64748b"), href=f"/supplier-invoices/{inv.id}/edit", title="Редактировать"),
                                style=f"{td_style} text-align: right;"
                            )
                        )
                        for inv in invoices
                    ]) if invoice_rows else Tbody(
                        Tr(Td(
                            Div(
                                icon("inbox", size=40, color="#cbd5e1"),
                                Div("Инвойсы не найдены", style="font-size: 16px; font-weight: 500; color: #64748b; margin-top: 12px;"),
                                A("Добавить первый инвойс", href="/supplier-invoices/new", style="color: #6366f1; font-size: 14px; margin-top: 8px; display: inline-block;"),
                                style="text-align: center; padding: 40px 20px;"
                            ),
                            colspan="9"
                        ))
                    ),
                    style="width: 100%; border-collapse: collapse;"
                ),
                style="overflow-x: auto;"
            ),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); overflow: hidden;"
        ),

        session=session
    )


@rt("/supplier-invoices/{invoice_id}")
def get(invoice_id: str, session):
    """View single supplier invoice details with items and payments."""
    redirect = require_login(session)
    if redirect:
        return redirect

    # Check permissions
    if not user_has_any_role(session, ["admin", "procurement", "finance"]):
        return page_layout("Access Denied",
            Div("У вас нет прав для просмотра инвойсов.", cls="alert alert-error"),
            session=session
        )

    user = session["user"]
    org_id = user.get("org_id")

    from services.supplier_invoice_service import (
        get_invoice_with_details, get_invoice_status_name, get_invoice_status_color
    )
    from services.supplier_invoice_payment_service import get_payments_for_invoice

    try:
        invoice = get_invoice_with_details(invoice_id)
        if not invoice:
            return page_layout("Не найдено",
                Div("Инвойс не найден.", cls="alert alert-error"),
                btn_link("К реестру инвойсов", href="/supplier-invoices", variant="secondary", icon_name="arrow-left"),
                session=session
            )

        # Verify organization access
        if str(invoice.organization_id) != str(org_id):
            return page_layout("Access Denied",
                Div("У вас нет доступа к этому инвойсу.", cls="alert alert-error"),
                session=session
            )

        # Get payments for this invoice
        payments = get_payments_for_invoice(invoice_id)

    except Exception as e:
        print(f"Error loading invoice: {e}")
        return page_layout("Ошибка",
            Div(f"Ошибка при загрузке инвойса: {e}", cls="alert alert-error"),
            btn_link("К реестру инвойсов", href="/supplier-invoices", variant="secondary", icon_name="arrow-left"),
            session=session
        )

    # Status styling
    status_color_classes = {
        "pending": "status-pending",
        "partially_paid": "status-in-progress",
        "paid": "status-approved",
        "overdue": "status-rejected",
        "cancelled": "status-cancelled",
    }
    status_cls = status_color_classes.get(invoice.status, "status-pending")
    status_text = get_invoice_status_name(invoice.status)

    # Calculate amounts
    total_amount = invoice.total_amount or 0
    paid_amount = invoice.paid_amount or 0
    remaining = total_amount - paid_amount

    # Format dates
    invoice_date_str = invoice.invoice_date.strftime("%d.%m.%Y") if invoice.invoice_date else "—"
    due_date_str = invoice.due_date.strftime("%d.%m.%Y") if invoice.due_date else "—"

    # Build items table (if items exist)
    items_section = []
    if hasattr(invoice, 'items') and invoice.items:
        item_rows = []
        for item in invoice.items:
            item_total = (item.quantity or 0) * (item.unit_price or 0)
            item_rows.append(
                Tr(
                    Td(item.description or "—"),
                    Td(str(item.quantity or 0)),
                    Td(f"{item.unit_price or 0:,.2f}"),
                    Td(f"{item_total:,.2f}", style="text-align: right;"),
                )
            )
        items_section = [
            H3(icon("package", size=20), " Позиции инвойса", cls="card-header"),
            Table(
                Thead(Tr(
                    Th("Описание"),
                    Th("Кол-во"),
                    Th("Цена за ед."),
                    Th("Сумма", style="text-align: right;"),
                )),
                Tbody(*item_rows),
                cls="table"
            ),
        ]

    # Build payments table
    payment_rows = []
    from services.supplier_invoice_payment_service import get_payment_type_name
    for p in payments:
        payment_date_str = p.payment_date.strftime("%d.%m.%Y") if p.payment_date else "—"
        payment_type_text = get_payment_type_name(p.payment_type)
        payment_rows.append(
            Tr(
                Td(payment_date_str),
                Td(payment_type_text),
                Td(f"{p.amount:,.2f} {p.currency}", style="text-align: right;"),
                Td(p.buyer_company_name or "—"),
                Td(p.payment_document or "—"),
                Td(p.notes or "—"),
            )
        )

    payments_section = [
        Div(
            H3(icon("credit-card", size=20), " Платежи", style="display: inline-flex; align-items: center; gap: 0.5rem;"),
            btn_link("Добавить платёж", href=f"/supplier-invoices/{invoice_id}/payments/new", variant="success", size="sm", icon_name="plus"),
            style="margin-bottom: 1rem;"
        ),
    ]

    if payment_rows:
        payments_section.append(
            Table(
                Thead(Tr(
                    Th("Дата"),
                    Th("Тип"),
                    Th("Сумма", style="text-align: right;"),
                    Th("Плательщик"),
                    Th("Документ"),
                    Th("Примечание"),
                )),
                Tbody(*payment_rows),
                cls="table"
            )
        )
    else:
        payments_section.append(
            Div("Платежи ещё не зарегистрированы.", cls="alert alert-warning")
        )

    # Design system styles
    section_header_style = "display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;"
    label_style = "font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 4px;"
    value_style = "font-size: 14px; font-weight: 500; color: #1e293b;"
    th_style = "text-align: left; padding: 12px 16px; background: #f8fafc; font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0;"
    td_style = "padding: 12px 16px; font-size: 14px; color: #1e293b; border-bottom: 1px solid #f1f5f9;"

    return page_layout(f"Инвойс {invoice.invoice_number}",
        # Header card with gradient
        Div(
            Div(
                A(
                    icon("arrow-left", size=16, color="#64748b"),
                    Span("К реестру инвойсов", style="margin-left: 6px;"),
                    href="/supplier-invoices",
                    style="display: inline-flex; align-items: center; color: #64748b; text-decoration: none; font-size: 13px; margin-bottom: 12px;"
                ),
                Div(
                    icon("receipt", size=24, color="#6366f1"),
                    Span(f"Инвойс {invoice.invoice_number}", style="font-size: 22px; font-weight: 600; color: #1e293b; margin-left: 10px;"),
                    status_badge(invoice.status),
                    style="display: flex; align-items: center; gap: 12px;"
                ),
                Div(
                    Span(f"Поставщик: {invoice.supplier_code or ''} - {invoice.supplier_name or '—'}", style="color: #64748b; font-size: 14px;"),
                    style="margin-top: 4px;"
                ),
            ),
            style="background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Two column layout for main info
        Div(
            # Left column - Invoice info
            Div(
                Div(
                    icon("info", size=16, color="#64748b"),
                    Span("ИНФОРМАЦИЯ ОБ ИНВОЙСЕ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Span("Номер инвойса", style=label_style),
                        Span(invoice.invoice_number, style=f"{value_style} font-family: monospace;"),
                        style="margin-bottom: 16px;"
                    ),
                    Div(
                        Span("Поставщик", style=label_style),
                        Span(f"{invoice.supplier_code or ''} - {invoice.supplier_name or '—'}", style=value_style),
                        style="margin-bottom: 16px;"
                    ),
                    Div(
                        Span("Дата инвойса", style=label_style),
                        Span(invoice_date_str, style=value_style),
                        style="margin-bottom: 16px;"
                    ),
                    Div(
                        Span("Срок оплаты", style=label_style),
                        Span(due_date_str, style=value_style),
                        Span(
                            icon("alert-triangle", size=14, color="#ef4444"),
                            " Просрочено!",
                            style="color: #ef4444; font-size: 12px; font-weight: 600; margin-left: 8px;"
                        ) if invoice.is_overdue else "",
                    ),
                ),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            # Right column - Financial info
            Div(
                Div(
                    icon("wallet", size=16, color="#64748b"),
                    Span("ФИНАНСЫ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    style=section_header_style
                ),
                Div(
                    Div(
                        Span("Сумма", style=label_style),
                        Span(f"{total_amount:,.2f} {invoice.currency}", style="font-size: 20px; font-weight: 600; color: #1e293b;"),
                        style="margin-bottom: 16px;"
                    ),
                    Div(
                        Span("Оплачено", style=label_style),
                        Span(f"{paid_amount:,.2f} {invoice.currency}", style="font-size: 18px; font-weight: 600; color: #22c55e;"),
                        style="margin-bottom: 16px;"
                    ),
                    Div(
                        Span("Остаток", style=label_style),
                        Span(f"{remaining:,.2f} {invoice.currency}", style=f"font-size: 18px; font-weight: 600; color: {'#ef4444' if remaining > 0 else '#22c55e'};"),
                    ),
                ),
                style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
            ),
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;"
        ),

        # Items section (if any)
        Div(
            Div(
                icon("package", size=16, color="#64748b"),
                Span("ПОЗИЦИИ ИНВОЙСА", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                Span(f"{len(invoice.items)}", style="background: #e0e7ff; color: #4f46e5; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-left: 8px;"),
                style=section_header_style
            ),
            Table(
                Thead(Tr(
                    Th("Описание", style=th_style),
                    Th("Кол-во", style=f"{th_style} text-align: center;"),
                    Th("Цена за ед.", style=f"{th_style} text-align: right;"),
                    Th("Сумма", style=f"{th_style} text-align: right;"),
                )),
                Tbody(*[
                    Tr(
                        Td(item.description or "—", style=td_style),
                        Td(str(item.quantity or 0), style=f"{td_style} text-align: center;"),
                        Td(f"{item.unit_price or 0:,.2f}", style=f"{td_style} text-align: right;"),
                        Td(f"{(item.quantity or 0) * (item.unit_price or 0):,.2f}", style=f"{td_style} text-align: right; font-weight: 500;"),
                    )
                    for item in invoice.items
                ]),
                style="width: 100%; border-collapse: collapse;"
            ),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if hasattr(invoice, 'items') and invoice.items else "",

        # Payments section
        Div(
            Div(
                Div(
                    icon("credit-card", size=16, color="#64748b"),
                    Span("ПЛАТЕЖИ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                    Span(f"{len(payments)}", style="background: #dcfce7; color: #16a34a; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-left: 8px;"),
                    style="display: flex; align-items: center; gap: 8px;"
                ),
                btn_link("Добавить платёж", href=f"/supplier-invoices/{invoice_id}/payments/new", variant="primary", size="sm", icon_name="plus"),
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;"
            ),
            Table(
                Thead(Tr(
                    Th("Дата", style=th_style),
                    Th("Тип", style=th_style),
                    Th("Сумма", style=f"{th_style} text-align: right;"),
                    Th("Плательщик", style=th_style),
                    Th("Документ", style=th_style),
                    Th("Примечание", style=th_style),
                )),
                Tbody(*[
                    Tr(
                        Td(p.payment_date.strftime("%d.%m.%Y") if p.payment_date else "—", style=td_style),
                        Td(get_payment_type_name(p.payment_type), style=td_style),
                        Td(f"{p.amount:,.2f} {p.currency}", style=f"{td_style} text-align: right; font-weight: 500; color: #22c55e;"),
                        Td(p.buyer_company_name or "—", style=td_style),
                        Td(p.payment_document or "—", style=f"{td_style} font-family: monospace; font-size: 13px;"),
                        Td(p.notes or "—", style=f"{td_style} color: #64748b;"),
                    )
                    for p in payments
                ]),
                style="width: 100%; border-collapse: collapse;"
            ) if payment_rows else Div(
                icon("inbox", size=32, color="#cbd5e1"),
                Div("Платежи ещё не зарегистрированы", style="font-size: 14px; color: #64748b; margin-top: 8px;"),
                style="text-align: center; padding: 32px 20px; color: #94a3b8;"
            ),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        # Notes section
        Div(
            Div(
                icon("message-square", size=16, color="#64748b"),
                Span("ПРИМЕЧАНИЯ", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;"),
                style=section_header_style
            ),
            P(invoice.notes or "Нет примечаний", style="color: #64748b; font-size: 14px; line-height: 1.6;"),
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ) if invoice.notes else "",

        # Actions
        Div(
            btn_link("Редактировать", href=f"/supplier-invoices/{invoice_id}/edit", variant="secondary", icon_name="edit"),
            btn_link("Добавить платёж", href=f"/supplier-invoices/{invoice_id}/payments/new", variant="primary", icon_name="credit-card"),
            style="display: flex; gap: 12px;"
        ),

        session=session
    )


# ============================================================================
# UI-014: INVOICE PAYMENT FORM
# ============================================================================

def _invoice_payment_form(invoice, payment=None, error=None, session=None):
    """
    Render invoice payment create/edit form.

    Args:
        invoice: SupplierInvoice object (required for context)
        payment: Existing SupplierInvoicePayment object for edit mode, None for create mode
        error: Error message to display
        session: Session object for page layout
    """
    from services.supplier_invoice_payment_service import (
        PAYMENT_TYPES, PAYMENT_TYPE_NAMES, DEFAULT_CURRENCY, SUPPORTED_CURRENCIES,
        get_remaining_amount
    )
    from services.buyer_company_service import get_all_buyer_companies

    is_edit = payment is not None
    title = "Редактирование платежа" if is_edit else "Регистрация платежа"
    action_url = f"/supplier-invoices/{invoice.id}/payments/{payment.id}/edit" if is_edit else f"/supplier-invoices/{invoice.id}/payments/new"

    # Calculate remaining amount
    remaining = get_remaining_amount(invoice.id)

    # Get buyer companies for dropdown
    buyer_companies = get_all_buyer_companies(invoice.organization_id) if invoice.organization_id else []

    # Format invoice dates
    invoice_date_str = invoice.invoice_date.strftime("%d.%m.%Y") if invoice.invoice_date else "—"
    due_date_str = invoice.due_date.strftime("%d.%m.%Y") if invoice.due_date else "—"

    # Pre-fill values
    today_str = date.today().isoformat()
    default_amount = str(remaining) if remaining > 0 else ""
    default_currency = invoice.currency or DEFAULT_CURRENCY

    # Build payment type options
    payment_type_options = []
    for pt in PAYMENT_TYPES:
        attrs = {"value": pt}
        if payment and payment.payment_type == pt:
            attrs["selected"] = True
        elif not payment and pt == "advance":  # Default to advance for new payments
            attrs["selected"] = True
        payment_type_options.append(Option(PAYMENT_TYPE_NAMES.get(pt, pt), **attrs))

    # Build currency options
    currency_options = []
    for curr in SUPPORTED_CURRENCIES:
        attrs = {"value": curr}
        if payment and payment.currency == curr:
            attrs["selected"] = True
        elif not payment and curr == default_currency:
            attrs["selected"] = True
        currency_options.append(Option(curr, **attrs))

    # Build buyer company options
    buyer_company_options = [Option("— Не указан —", value="")]
    for bc in buyer_companies:
        if bc.is_active:
            attrs = {"value": bc.id}
            if payment and payment.buyer_company_id == bc.id:
                attrs["selected"] = True
            label = f"{bc.company_code} - {bc.name}"
            buyer_company_options.append(Option(label, **attrs))

    return page_layout(title,
        # Error alert
        Div(error, cls="alert alert-error") if error else "",

        Div(
            icon("edit", size=28) if is_edit else icon("credit-card", size=28),
            H1(f" {title}", style="display: inline; margin-left: 0.5rem;"),
            style="display: flex; align-items: center;"
        ),

        # Invoice context card
        Div(
            H3(icon("clipboard-list", size=20), f" Инвойс {invoice.invoice_number}", cls="card-header"),
            Div(
                Div(
                    Table(
                        Tr(Td(Strong("Поставщик:")), Td(f"{invoice.supplier_code or ''} - {invoice.supplier_name or '—'}")),
                        Tr(Td(Strong("Дата инвойса:")), Td(invoice_date_str)),
                        Tr(Td(Strong("Срок оплаты:")), Td(due_date_str)),
                        style="border: none;"
                    ),
                    cls="col"
                ),
                Div(
                    Table(
                        Tr(Td(Strong("Сумма:")), Td(f"{invoice.total_amount:,.2f} {invoice.currency}", style="font-size: 1.1rem;")),
                        Tr(Td(Strong("Оплачено:")), Td(f"{invoice.total_paid:,.2f} {invoice.currency}", style="color: #28a745;")),
                        Tr(Td(Strong("Остаток:")), Td(f"{remaining:,.2f} {invoice.currency}", style="color: #dc3545; font-weight: bold;" if remaining > 0 else "color: #28a745; font-weight: bold;")),
                        style="border: none;"
                    ),
                    cls="col"
                ),
                cls="grid"
            ),
            cls="card", style="margin-bottom: 1.5rem; background: #f8f9fa;"
        ),

        Div(
            Form(
                # Payment details section
                H3("Данные платежа"),
                Div(
                    Label("Дата платежа *",
                        Input(
                            name="payment_date",
                            type="date",
                            value=payment.payment_date.isoformat() if payment and payment.payment_date else today_str,
                            required=True
                        )
                    ),
                    Label("Тип платежа *",
                        Select(
                            *payment_type_options,
                            name="payment_type",
                            required=True
                        ),
                        Small("Аванс — первый платёж, Финальный — полное закрытие", style="color: #666; display: block;")
                    ),
                    cls="form-row"
                ),
                Div(
                    Label("Сумма *",
                        Input(
                            name="amount",
                            type="number",
                            step="0.01",
                            min="0.01",
                            value=str(payment.amount) if payment else default_amount,
                            placeholder="1000.00",
                            required=True
                        ),
                        Small(f"Остаток к оплате: {remaining:,.2f} {invoice.currency}", style="color: #666; display: block;") if remaining > 0 else ""
                    ),
                    Label("Валюта *",
                        Select(
                            *currency_options,
                            name="currency",
                            required=True
                        )
                    ),
                    cls="form-row"
                ),

                # Payer section
                H3("Плательщик", style="margin-top: 1.5rem;"),
                Div(
                    Label("Компания-плательщик",
                        Select(
                            *buyer_company_options,
                            name="buyer_company_id"
                        ),
                        Small("Наше юрлицо, с которого производится оплата", style="color: #666; display: block;")
                    ),
                    Label("Курс к RUB",
                        Input(
                            name="exchange_rate",
                            type="number",
                            step="0.0001",
                            min="0",
                            value=str(payment.exchange_rate) if payment and payment.exchange_rate else "",
                            placeholder="90.5"
                        ),
                        Small("Для конвертации в рубли (опционально)", style="color: #666; display: block;")
                    ),
                    cls="form-row"
                ),

                # Document reference
                H3("Документ", style="margin-top: 1.5rem;"),
                Div(
                    Label("Номер платёжного документа",
                        Input(
                            name="payment_document",
                            value=payment.payment_document if payment else "",
                            placeholder="ПП-123, PAY-2025-001"
                        ),
                        Small("Номер платёжки или банковской операции", style="color: #666; display: block;")
                    ),
                    Div(cls="form-placeholder"),
                    cls="form-row"
                ),

                # Notes
                Label("Примечания",
                    Textarea(
                        payment.notes if payment else "",
                        name="notes",
                        rows=3,
                        placeholder="Дополнительная информация о платеже..."
                    )
                ),

                # Buttons
                Div(
                    btn("Сохранить", variant="primary", icon_name="save", type="submit"),
                    btn_link("Отмена", href=f"/supplier-invoices/{invoice.id}", variant="secondary", icon_name="x"),
                    style="display: flex; gap: 0.5rem; margin-top: 1.5rem;"
                ),

                method="POST",
                action=action_url
            ),
            cls="card"
        ),

        session=session
    )


@rt("/supplier-invoices/{invoice_id}/payments/new")
def get_new_invoice_payment(session, invoice_id: str):
    """Display form to register new payment for supplier invoice."""
    # Check authentication
    user = session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=303)

    # Check roles (admin, procurement, or finance can register payments)
    org_id = session.get("organization_id")
    if org_id:
        from services.user_service import get_user_roles_in_organization
        user_roles = get_user_roles_in_organization(user["id"], org_id)
        role_codes = [r.get("role_code") for r in user_roles]
        if not any(r in role_codes for r in ["admin", "procurement", "finance"]):
            return page_layout("Доступ запрещён",
                Div("У вас нет прав для регистрации платежей.", cls="alert alert-error"),
                session=session
            )

    # Get invoice with details
    from services.supplier_invoice_service import get_invoice_with_details
    invoice = get_invoice_with_details(invoice_id)

    if not invoice:
        return page_layout("Инвойс не найден",
            Div("Инвойс не найден или был удалён.", cls="alert alert-error"),
            A("← К реестру инвойсов", href="/supplier-invoices"),
            session=session
        )

    # Check organization access
    if invoice.organization_id and invoice.organization_id != org_id:
        return page_layout("Доступ запрещён",
            Div("У вас нет доступа к этому инвойсу.", cls="alert alert-error"),
            session=session
        )

    return _invoice_payment_form(invoice, session=session)


@rt("/supplier-invoices/{invoice_id}/payments/new")
def post_new_invoice_payment(session, invoice_id: str, payment_date: str, payment_type: str, amount: str, currency: str, buyer_company_id: str = None, exchange_rate: str = None, payment_document: str = None, notes: str = None):
    """Handle new payment form submission."""
    # Check authentication
    user = session.get("user")
    if not user:
        return RedirectResponse("/login", status_code=303)

    # Check roles
    org_id = session.get("organization_id")
    if org_id:
        from services.user_service import get_user_roles_in_organization
        user_roles = get_user_roles_in_organization(user["id"], org_id)
        role_codes = [r.get("role_code") for r in user_roles]
        if not any(r in role_codes for r in ["admin", "procurement", "finance"]):
            return page_layout("Доступ запрещён",
                Div("У вас нет прав для регистрации платежей.", cls="alert alert-error"),
                session=session
            )

    # Get invoice
    from services.supplier_invoice_service import get_invoice_with_details
    invoice = get_invoice_with_details(invoice_id)

    if not invoice:
        return page_layout("Инвойс не найден",
            Div("Инвойс не найден или был удалён.", cls="alert alert-error"),
            session=session
        )

    # Check organization access
    if invoice.organization_id and invoice.organization_id != org_id:
        return page_layout("Доступ запрещён",
            Div("У вас нет доступа к этому инвойсу.", cls="alert alert-error"),
            session=session
        )

    # Parse and validate input
    from decimal import Decimal, InvalidOperation
    from datetime import date as dt_date

    try:
        payment_date_parsed = dt_date.fromisoformat(payment_date)
    except (ValueError, TypeError):
        return _invoice_payment_form(invoice, error="Некорректная дата платежа", session=session)

    try:
        amount_decimal = Decimal(amount.strip())
        if amount_decimal <= 0:
            return _invoice_payment_form(invoice, error="Сумма должна быть больше нуля", session=session)
    except (InvalidOperation, ValueError, AttributeError):
        return _invoice_payment_form(invoice, error="Некорректная сумма платежа", session=session)

    exchange_rate_decimal = None
    if exchange_rate and exchange_rate.strip():
        try:
            exchange_rate_decimal = Decimal(exchange_rate.strip())
            if exchange_rate_decimal <= 0:
                return _invoice_payment_form(invoice, error="Курс должен быть больше нуля", session=session)
        except (InvalidOperation, ValueError):
            return _invoice_payment_form(invoice, error="Некорректный курс валюты", session=session)

    # Clean up optional fields
    buyer_company_id_clean = buyer_company_id.strip() if buyer_company_id and buyer_company_id.strip() else None
    payment_document_clean = payment_document.strip() if payment_document and payment_document.strip() else None
    notes_clean = notes.strip() if notes and notes.strip() else None

    # Register payment
    from services.supplier_invoice_payment_service import register_payment

    try:
        payment = register_payment(
            invoice_id=invoice_id,
            payment_date=payment_date_parsed,
            amount=amount_decimal,
            currency=currency,
            exchange_rate=exchange_rate_decimal,
            payment_type=payment_type,
            buyer_company_id=buyer_company_id_clean,
            payment_document=payment_document_clean,
            notes=notes_clean,
            created_by=user["id"]
        )

        if payment:
            # Success - redirect to invoice detail
            return RedirectResponse(f"/supplier-invoices/{invoice_id}", status_code=303)
        else:
            return _invoice_payment_form(invoice, error="Не удалось зарегистрировать платёж", session=session)

    except ValueError as e:
        return _invoice_payment_form(invoice, error=str(e), session=session)
    except Exception as e:
        return _invoice_payment_form(invoice, error=f"Ошибка при сохранении: {str(e)}", session=session)


# ============================================================================
# DOCUMENT STORAGE ROUTES
# ============================================================================
# Universal document upload/download/delete functionality
# Files stored in Supabase Storage bucket 'kvota-documents'
# Metadata stored in kvota.documents table

def _quote_documents_section(
    quote_id: str,
    session: dict,
    invoices: List[Dict],
    items: List[Dict],
    can_upload: bool = True,
    can_delete: bool = True
):
    """
    Documents section for quotes with hierarchical binding support.

    Shows ALL documents related to a quote:
    - Documents directly attached to the quote
    - Invoice documents (scans, payment orders)
    - Item certificates

    Upload form dynamically shows invoice/item selector based on document type.

    Args:
        quote_id: Quote UUID
        session: User session
        invoices: List of supplier invoices for this quote [{id, invoice_number, supplier_name}]
        items: List of quote items [{id, name, sku, brand}]
        can_upload: Whether user can upload
        can_delete: Whether user can delete
    """
    documents = get_all_documents_for_quote(quote_id)
    doc_types = get_allowed_document_types_for_entity("quote")

    # Build document rows with entity binding info
    doc_rows = []
    for doc in documents:
        # Determine binding label
        if doc.entity_type == "quote":
            binding_label = "КП"
            binding_style = "background: #dbeafe; color: #1e40af;"
        elif doc.entity_type == "supplier_invoice":
            # Find invoice name
            invoice_name = next((inv.get("invoice_number", "Инвойс") for inv in invoices if inv.get("id") == doc.entity_id), "Инвойс")
            binding_label = f"Инв: {invoice_name}"
            binding_style = "background: #fef3c7; color: #92400e;"
        elif doc.entity_type == "quote_item":
            # Find item name
            item_info = next((f"{it.get('name', 'Товар')[:20]}" for it in items if it.get("id") == doc.entity_id), "Товар")
            binding_label = f"Поз: {item_info}"
            binding_style = "background: #d1fae5; color: #065f46;"
        else:
            binding_label = get_entity_type_label(doc.entity_type)
            binding_style = "background: #f3f4f6; color: #374151;"

        doc_rows.append(
            Tr(
                # File icon + name (narrow, truncated, tooltip on hover)
                Td(
                    A(
                        I(cls=f"fa-solid {get_file_icon(doc.mime_type)}", style="margin-right: 0.5rem; color: var(--accent); flex-shrink: 0;"),
                        Span(doc.original_filename, style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"),
                        href=f"/documents/{doc.id}/view",
                        target="_blank",
                        title=doc.original_filename,
                        style="text-decoration: none; color: var(--text-primary); display: flex; align-items: center; max-width: 100%; overflow: hidden;"
                    ),
                    style="max-width: 150px; overflow: hidden;"
                ),
                # Document type
                Td(
                    Span(get_document_type_label(doc.document_type),
                         cls="badge",
                         style="background: var(--accent-light); color: var(--accent); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;")
                    if doc.document_type else "-"
                ),
                # Binding
                Td(
                    Span(binding_label,
                         style=f"{binding_style}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;")
                ),
                # Description (NEW)
                Td(
                    Span(doc.description or "-",
                         title=doc.description if doc.description else None,
                         style="color: var(--text-secondary); font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; max-width: 150px;")
                ),
                # File size
                Td(format_file_size(doc.file_size_bytes) or "-", style="color: var(--text-secondary); font-size: 0.85rem;"),
                # Upload date
                Td(doc.created_at.strftime("%d.%m.%Y") if doc.created_at else "-", style="color: var(--text-secondary); font-size: 0.85rem;"),
                # Actions - small square icon buttons
                Td(
                    A(
                      icon("eye", size=16),
                      href=f"/documents/{doc.id}/view",
                      target="_blank",
                      title="Просмотр",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;"),
                    A(
                      icon("download", size=16),
                      href=f"/documents/{doc.id}/download",
                      title="Скачать",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;"),
                    A(
                      icon("trash-2", size=16),
                      href="#",
                      hx_delete=f"/documents/{doc.id}",
                      hx_confirm="Удалить документ?",
                      hx_target=f"#doc-row-{doc.id}",
                      hx_swap="outerHTML",
                      title="Удалить",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;") if can_delete else None,
                    style="white-space: nowrap; display: flex; gap: 0.5rem;"
                ),
                id=f"doc-row-{doc.id}"
            )
        )

    # Empty state
    if not doc_rows:
        doc_rows.append(
            Tr(
                Td("Документы не загружены", colspan="7", style="text-align: center; color: var(--text-muted); padding: 2rem;")
            )
        )

    # Build invoice options for dropdown
    invoice_options = [Option("— Выберите инвойс —", value="")]
    for inv in invoices:
        supplier = inv.get("supplier_name", "")
        label = f"{inv.get('invoice_number', 'Инвойс')} ({supplier})" if supplier else inv.get("invoice_number", "Инвойс")
        invoice_options.append(Option(label, value=inv.get("id", "")))

    # Build item options for dropdown
    item_options = [Option("— Выберите товар —", value="")]
    for item in items:
        brand = item.get("brand", "")
        sku = item.get("sku", "")
        name = item.get("name", "Товар")[:30]
        label = f"{name}"
        if brand:
            label += f" ({brand})"
        if sku:
            label += f" [{sku}]"
        item_options.append(Option(label, value=item.get("id", "")))

    # JavaScript for dynamic sub-entity selector
    js_script = Script("""
    document.addEventListener('DOMContentLoaded', function() {
        const docTypeSelect = document.getElementById('doc_type');
        const invoiceDiv = document.getElementById('invoice-selector-div');
        const itemDiv = document.getElementById('item-selector-div');
        const invoiceSelect = document.getElementById('sub_entity_invoice');
        const itemSelect = document.getElementById('sub_entity_item');

        const invoiceTypes = ['invoice_scan', 'proforma_scan', 'payment_order'];
        const itemTypes = ['certificate'];

        function updateSelectors() {
            const selectedType = docTypeSelect.value;

            // Update select color: grey for placeholder, black for real selection
            if (selectedType && selectedType !== '') {
                docTypeSelect.style.color = '#111827';
            } else {
                docTypeSelect.style.color = '#9ca3af';
            }

            // Show/hide sub-selectors
            if (invoiceDiv) {
                invoiceDiv.style.display = invoiceTypes.includes(selectedType) ? 'block' : 'none';
            }
            if (itemDiv) {
                itemDiv.style.display = itemTypes.includes(selectedType) ? 'block' : 'none';
            }

            // Clear non-visible selectors
            if (!invoiceTypes.includes(selectedType) && invoiceSelect) {
                invoiceSelect.value = '';
            }
            if (!itemTypes.includes(selectedType) && itemSelect) {
                itemSelect.value = '';
            }
        }

        if (docTypeSelect) {
            docTypeSelect.addEventListener('change', updateSelectors);
            updateSelectors(); // Initial state
        }
    });
    """)

    # JavaScript for drag-and-drop
    drag_drop_js = Script("""
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('doc_file');
        const fileNameSpan = document.getElementById('file-name');

        if (!dropZone || !fileInput) return;

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#6366f1';
                dropZone.style.background = '#eef2ff';
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#d1d5db';
                dropZone.style.background = '#fafafa';
            }, false);
        });

        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                updateFileName(files[0].name);
            }
        }, false);

        // Handle file input change
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                updateFileName(fileInput.files[0].name);
            }
        });

        // Click to select
        dropZone.addEventListener('click', () => fileInput.click());

        function updateFileName(name) {
            if (fileNameSpan) {
                fileNameSpan.textContent = name;
                fileNameSpan.style.color = '#111827';
            }
        }
    });
    """)

    return Div(
        js_script,
        drag_drop_js,

        # Compact upload form
        Div(
            Form(
                Div(
                    # Left side: Drop zone (wider)
                    Div(
                        Div(
                            I(cls="fa-solid fa-cloud-arrow-up", style="font-size: 1.5rem; color: #9ca3af; margin-bottom: 0.5rem;"),
                            Div(
                                Span("Перетащите файл или ", style="color: #6b7280;"),
                                Span("выберите", style="color: #6366f1; cursor: pointer;"),
                                style="font-size: 0.875rem;"
                            ),
                            Span("", id="file-name", style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;"),
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;"
                        ),
                        Input(type="file", name="file", id="doc_file", required=True,
                              accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar,.7z,.txt,.csv",
                              style="display: none;"),
                        id="drop-zone",
                        style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem; background: #fafafa; flex: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                    ),
                    style="flex: 1; display: flex;"
                ),

                # Right side: Type, description, save
                Div(
                    # Document type with custom styled select
                    Div(
                        Select(
                            Option("Тип документа", value="", disabled=True, selected=True, style="color: #9ca3af;"),
                            *[Option(dt["label"], value=dt["value"]) for dt in doc_types],
                            name="document_type",
                            id="doc_type",
                            style="width: 100%; padding: 0.5rem 2rem 0.5rem 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; background: white; color: #9ca3af; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E\"); background-repeat: no-repeat; background-position: right 0.5rem center; cursor: pointer;"
                        ),
                        style="margin-bottom: 0.5rem; position: relative;"
                    ),

                    # Dynamic sub-entity selectors (hidden by default)
                    Div(
                        Select(
                            *invoice_options,
                            name="sub_entity_invoice",
                            id="sub_entity_invoice",
                            style="width: 100%; padding: 0.4rem; border: 1px solid #fcd34d; border-radius: 4px; font-size: 0.8rem; background: #fffbeb;"
                        ),
                        id="invoice-selector-div",
                        style="display: none; margin-bottom: 0.5rem;"
                    ) if invoices else Div(id="invoice-selector-div", style="display: none;"),

                    Div(
                        Select(
                            *item_options,
                            name="sub_entity_item",
                            id="sub_entity_item",
                            style="width: 100%; padding: 0.4rem; border: 1px solid #6ee7b7; border-radius: 4px; font-size: 0.8rem; background: #ecfdf5;"
                        ),
                        id="item-selector-div",
                        style="display: none; margin-bottom: 0.5rem;"
                    ) if items else Div(id="item-selector-div", style="display: none;"),

                    # Description
                    Div(
                        Input(type="text", name="description", id="doc_desc",
                              placeholder="Описание (опционально)",
                              style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;"),
                        style="margin-bottom: 0.5rem;"
                    ),

                    # Save button
                    btn("Сохранить", variant="primary", icon_name="check", type="submit", full_width=True),

                    style="width: 280px; flex-shrink: 0;"
                ),

                # Hidden field for parent quote
                Input(type="hidden", name="parent_quote_id", value=quote_id),

                action=f"/documents/upload/quote/{quote_id}",
                method="POST",
                enctype="multipart/form-data",
                id="doc-upload-form",
                style="display: flex; gap: 0.75rem; align-items: stretch;"
            ),
            style="margin-bottom: 1rem; padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px;"
        ) if can_upload else None,

        # Documents table with gradient container
        Div(
            # Section header
            Div(
                icon("folder-open", size=16, color="#64748b"),
                Span(f" ДОКУМЕНТЫ ({len(documents)})", style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 6px;"),
                style="display: flex; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;"
            ),
            Table(
                Thead(
                    Tr(
                        Th("Файл", style="width: 15%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("Тип", style="width: 12%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("Привязка", style="width: 10%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("Описание", style="width: 18%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("Размер", style="width: 8%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("Дата", style="width: 10%; color: #64748b; font-size: 0.75rem; text-transform: uppercase;"),
                        Th("", style="width: 10%;"),
                    )
                ),
                Tbody(*doc_rows, id="documents-tbody"),
                cls="table",
                style="width: 100%;"
            ),
            style="overflow-x: auto; background: linear-gradient(135deg, #fafbfc 0%, #f4f5f7 100%); padding: 1.25rem; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);"
        ),

        cls="documents-section",
        id="documents-section"
    )


def _documents_section(entity_type: str, entity_id: str, session: dict, can_upload: bool = True, can_delete: bool = True):
    """
    Reusable documents section component.

    Args:
        entity_type: Type of parent entity (quote, supplier_invoice, etc.)
        entity_id: UUID of parent entity
        session: User session
        can_upload: Whether user can upload new documents
        can_delete: Whether user can delete documents

    Returns:
        HTML component for documents section
    """
    documents = get_documents_for_entity(entity_type, entity_id)
    doc_types = get_allowed_document_types_for_entity(entity_type)

    # Document list
    doc_rows = []
    for doc in documents:
        doc_rows.append(
            Tr(
                # File icon + name
                Td(
                    I(cls=f"fa-solid {get_file_icon(doc.mime_type)}", style="margin-right: 0.5rem; color: var(--accent);"),
                    A(doc.original_filename,
                      href=f"/documents/{doc.id}/view",
                      target="_blank",
                      title="Открыть для просмотра",
                      style="text-decoration: none; color: var(--text-primary);"),
                    style="display: flex; align-items: center;"
                ),
                # Document type
                Td(
                    Span(get_document_type_label(doc.document_type),
                         cls="badge",
                         style="background: var(--accent-light); color: var(--accent); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;")
                    if doc.document_type else "-"
                ),
                # File size
                Td(format_file_size(doc.file_size_bytes) or "-", style="color: var(--text-secondary);"),
                # Upload date
                Td(doc.created_at.strftime("%d.%m.%Y %H:%M") if doc.created_at else "-", style="color: var(--text-secondary);"),
                # Description
                Td(doc.description or "-", style="color: var(--text-secondary); max-width: 200px; overflow: hidden; text-overflow: ellipsis;"),
                # Actions - small square icon buttons (using Lucide icons)
                Td(
                    A(
                      icon("eye", size=16),
                      href=f"/documents/{doc.id}/view",
                      target="_blank",
                      title="Просмотр",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;"),
                    A(
                      icon("download", size=16),
                      href=f"/documents/{doc.id}/download",
                      title="Скачать",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;"),
                    A(
                      icon("trash-2", size=16),
                      href="#",
                      hx_delete=f"/documents/{doc.id}",
                      hx_confirm="Удалить документ?",
                      hx_target=f"#doc-row-{doc.id}",
                      hx_swap="outerHTML",
                      title="Удалить",
                      style="display: inline-flex !important; align-items: center !important; justify-content: center !important; width: 32px !important; height: 32px !important; background: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 6px !important; color: #374151 !important; text-decoration: none !important;") if can_delete else None,
                    style="white-space: nowrap; display: flex; gap: 0.5rem;"
                ),
                id=f"doc-row-{doc.id}"
            )
        )

    # Empty state
    if not doc_rows:
        doc_rows.append(
            Tr(
                Td("Документы не загружены", colspan="6", style="text-align: center; color: var(--text-muted); padding: 2rem;")
            )
        )

    # JavaScript for drag-and-drop
    drag_drop_js = Script("""
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('doc_file');
        const fileNameSpan = document.getElementById('file-name');

        if (!dropZone || !fileInput) return;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#6366f1';
                dropZone.style.background = '#eef2ff';
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#d1d5db';
                dropZone.style.background = '#fafafa';
            }, false);
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                if (fileNameSpan) {
                    fileNameSpan.textContent = files[0].name;
                    fileNameSpan.style.color = '#111827';
                }
            }
        }, false);

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length && fileNameSpan) {
                fileNameSpan.textContent = fileInput.files[0].name;
                fileNameSpan.style.color = '#111827';
            }
        });

        dropZone.addEventListener('click', () => fileInput.click());

        // Handle document type select color
        const docTypeSelect = document.getElementById('doc_type');
        if (docTypeSelect) {
            docTypeSelect.addEventListener('change', function() {
                if (this.value && this.value !== '') {
                    this.style.color = '#111827';
                } else {
                    this.style.color = '#9ca3af';
                }
            });
        }
    });
    """)

    return Div(
        drag_drop_js,

        # Compact upload form
        Div(
            Form(
                Div(
                    # Left side: Drop zone (wider)
                    Div(
                        Div(
                            I(cls="fa-solid fa-cloud-arrow-up", style="font-size: 1.5rem; color: #9ca3af; margin-bottom: 0.5rem;"),
                            Div(
                                Span("Перетащите файл или ", style="color: #6b7280;"),
                                Span("выберите", style="color: #6366f1; cursor: pointer;"),
                                style="font-size: 0.875rem;"
                            ),
                            Span("", id="file-name", style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;"),
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;"
                        ),
                        Input(type="file", name="file", id="doc_file", required=True,
                              accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.zip,.rar,.7z,.txt,.csv",
                              style="display: none;"),
                        id="drop-zone",
                        style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem; background: #fafafa; flex: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                    ),
                    style="flex: 1; display: flex;"
                ),

                # Right side: Type, description, save
                Div(
                    # Document type with custom styled select
                    Div(
                        Select(
                            Option("Тип документа", value="", disabled=True, selected=True, style="color: #9ca3af;"),
                            *[Option(dt["label"], value=dt["value"]) for dt in doc_types],
                            name="document_type",
                            id="doc_type",
                            style="width: 100%; padding: 0.5rem 2rem 0.5rem 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; background: white; color: #9ca3af; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E\"); background-repeat: no-repeat; background-position: right 0.5rem center; cursor: pointer;"
                        ),
                        style="margin-bottom: 0.5rem; position: relative;"
                    ),

                    # Description
                    Div(
                        Input(type="text", name="description", id="doc_desc",
                              placeholder="Описание (опционально)",
                              style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;"),
                        style="margin-bottom: 0.5rem;"
                    ),

                    # Save button
                    btn("Сохранить", variant="primary", icon_name="check", type="submit", full_width=True),

                    style="flex: 1; min-width: 180px;"
                ),

                action=f"/documents/upload/{entity_type}/{entity_id}",
                method="POST",
                enctype="multipart/form-data",
                id="doc-upload-form",
                style="display: flex; gap: 0.75rem; align-items: stretch;"
            ),
            style="margin-bottom: 1rem; padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px;"
        ) if can_upload else None,

        # Documents table
        Div(
            H4(I(cls="fa-solid fa-folder-open", style="margin-right: 0.5rem;"), f"Документы ({len(documents)})"),
            Table(
                Thead(
                    Tr(
                        Th("Файл", style="width: 30%;"),
                        Th("Тип", style="width: 15%;"),
                        Th("Размер", style="width: 10%;"),
                        Th("Дата", style="width: 15%;"),
                        Th("Описание", style="width: 20%;"),
                        Th("", style="width: 10%;"),
                    )
                ),
                Tbody(*doc_rows, id="documents-tbody"),
                cls="table",
                style="width: 100%;"
            ),
            style="overflow-x: auto;"
        ),

        cls="documents-section",
        id="documents-section"
    )


@rt("/documents/upload/{entity_type}/{entity_id}")
async def post(session, entity_type: str, entity_id: str, request):
    """
    Upload a document for an entity.

    POST /documents/upload/{entity_type}/{entity_id}
    Form data: file, document_type (optional), description (optional),
               sub_entity_invoice (optional), sub_entity_item (optional),
               parent_quote_id (optional)

    Hierarchical binding:
    - For invoice docs (invoice_scan, proforma_scan, payment_order): binds to supplier_invoice
    - For certificates: binds to quote_item
    - parent_quote_id tracks the parent quote for aggregated document views
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    user_id = user["id"]
    org_id = user["org_id"]

    # Validate entity type
    valid_entity_types = {"quote", "specification", "supplier_invoice", "quote_item", "supplier", "customer", "seller_company", "buyer_company"}
    if entity_type not in valid_entity_types:
        return JSONResponse({"error": f"Invalid entity type: {entity_type}"}, status_code=400)

    try:
        # Get the uploaded file from form data
        form = await request.form()
        uploaded_file = form.get("file")
        document_type = form.get("document_type") or None
        description = form.get("description") or None

        # Hierarchical binding fields
        sub_entity_invoice = form.get("sub_entity_invoice") or None
        sub_entity_item = form.get("sub_entity_item") or None
        parent_quote_id = form.get("parent_quote_id") or None

        if not uploaded_file or not uploaded_file.filename:
            # Redirect back with error
            return page_layout("Ошибка загрузки",
                H1("Файл не выбран"),
                Div(
                    "Пожалуйста, выберите файл для загрузки.",
                    cls="card",
                    style="background: #fee2e2; border-left: 4px solid #dc2626;"
                ),
                btn("Назад", variant="secondary", icon_name="arrow-left", type="button", onclick="history.back()"),
                session=session
            )

        # Read file content
        file_content = await uploaded_file.read()
        filename = uploaded_file.filename

        # Determine actual entity binding based on document type
        actual_entity_type = entity_type
        actual_entity_id = entity_id

        if document_type:
            if document_type in INVOICE_DOCUMENT_TYPES and sub_entity_invoice:
                # Bind to supplier invoice
                actual_entity_type = "supplier_invoice"
                actual_entity_id = sub_entity_invoice
            elif document_type in ITEM_DOCUMENT_TYPES and sub_entity_item:
                # Bind to quote item
                actual_entity_type = "quote_item"
                actual_entity_id = sub_entity_item

        # Upload document using service
        doc, error = upload_document(
            organization_id=org_id,
            entity_type=actual_entity_type,
            entity_id=actual_entity_id,
            file_content=file_content,
            filename=filename,
            document_type=document_type,
            description=description,
            uploaded_by=user_id,
            parent_quote_id=parent_quote_id
        )

        if error:
            return page_layout("Ошибка загрузки",
                H1("Ошибка загрузки файла"),
                Div(
                    error,
                    cls="card",
                    style="background: #fee2e2; border-left: 4px solid #dc2626;"
                ),
                btn("Назад", variant="secondary", icon_name="arrow-left", type="button", onclick="history.back()"),
                session=session
            )

        # Determine redirect URL based on entity type
        # Use parent_quote_id if available for sub-entity documents
        if parent_quote_id and actual_entity_type in ("supplier_invoice", "quote_item"):
            redirect_url = f"/quotes/{parent_quote_id}?tab=documents"
        else:
            redirect_urls = {
                "quote": f"/quotes/{entity_id}?tab=documents",
                "specification": f"/spec-control/{entity_id}",
                "supplier_invoice": f"/supplier-invoices/{entity_id}",
                "supplier": f"/suppliers/{entity_id}",
                "customer": f"/customers/{entity_id}?tab=documents",
                "seller_company": f"/companies?tab=seller_companies",
                "buyer_company": f"/companies?tab=buyer_companies",
                "quote_item": f"/quotes/{entity_id}",
            }
            redirect_url = redirect_urls.get(entity_type, "/")

        return RedirectResponse(redirect_url, status_code=303)

    except Exception as e:
        print(f"Error uploading document: {e}")
        import traceback
        traceback.print_exc()

        return page_layout("Ошибка загрузки",
            H1("Ошибка загрузки файла"),
            Div(
                f"Произошла ошибка: {str(e)}",
                cls="card",
                style="background: #fee2e2; border-left: 4px solid #dc2626;"
            ),
            btn("Назад", variant="secondary", icon_name="arrow-left", type="button", onclick="history.back()"),
            session=session
        )


@rt("/documents/{document_id}/download")
async def get(session, document_id: str):
    """
    Download a document (redirect to signed URL).

    GET /documents/{document_id}/download
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Get document
    doc = get_document(document_id)
    if not doc:
        return page_layout("Документ не найден",
            H1("Документ не найден"),
            Div("Запрошенный документ не существует или был удалён.", cls="card"),
            session=session
        )

    # Verify organization access
    if doc.organization_id != org_id:
        return RedirectResponse("/unauthorized", status_code=303)

    # Get signed download URL with force_download to trigger browser download
    download_url = get_download_url(document_id, expires_in=3600, force_download=True)

    if not download_url:
        return page_layout("Ошибка загрузки",
            H1("Не удалось получить ссылку"),
            Div("Не удалось сгенерировать ссылку для скачивания. Попробуйте позже.", cls="card"),
            session=session
        )

    # Redirect to signed URL
    return RedirectResponse(download_url, status_code=302)


@rt("/documents/{document_id}/view")
async def get(session, document_id: str):
    """
    View a document in browser (redirect to signed URL without download header).

    GET /documents/{document_id}/view
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Get document
    doc = get_document(document_id)
    if not doc:
        return page_layout("Документ не найден",
            H1("Документ не найден"),
            Div("Запрошенный документ не существует или был удалён.", cls="card"),
            session=session
        )

    # Verify organization access
    if doc.organization_id != org_id:
        return RedirectResponse("/unauthorized", status_code=303)

    # Get signed URL without force_download (for viewing in browser)
    view_url = get_download_url(document_id, expires_in=3600, force_download=False)

    if not view_url:
        return page_layout("Ошибка просмотра",
            H1("Не удалось получить ссылку"),
            Div("Не удалось сгенерировать ссылку для просмотра. Попробуйте позже.", cls="card"),
            session=session
        )

    # Redirect to signed URL (will display in browser)
    return RedirectResponse(view_url, status_code=302)


@rt("/documents/{document_id}")
async def delete(session, document_id: str):
    """
    Delete a document (HTMX DELETE).

    DELETE /documents/{document_id}
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]
    org_id = user["org_id"]

    # Get document to verify ownership
    doc = get_document(document_id)
    if not doc:
        return ""  # Already deleted

    # Verify organization access
    if doc.organization_id != org_id:
        return ""

    # Check role permissions for delete
    if not user_has_any_role(session, ["admin", "sales_manager", "quote_controller", "finance"]):
        return Div("Недостаточно прав для удаления", style="color: #dc3545;")

    # Delete document
    success, error = delete_document(document_id)

    if not success:
        return Div(f"Ошибка: {error}", style="color: #dc3545;")

    # Return empty to remove row
    return ""


@rt("/documents/{entity_type}/{entity_id}")
async def get(session, entity_type: str, entity_id: str):
    """
    Get documents list for an entity (HTMX partial).

    GET /documents/{entity_type}/{entity_id}
    """
    redirect = require_login(session)
    if redirect:
        return redirect

    user = session["user"]

    # Determine permissions based on roles
    can_upload = user_has_any_role(session, ["admin", "sales", "sales_manager", "procurement", "quote_controller", "finance", "logistics", "customs"])
    can_delete = user_has_any_role(session, ["admin", "sales_manager", "quote_controller", "finance"])

    return _documents_section(entity_type, entity_id, session, can_upload=can_upload, can_delete=can_delete)


# ============================================================================
# RUN SERVER
# ============================================================================

if __name__ == "__main__":
    print("\n" + "="*50)
    print("  Kvota OneStack - FastHTML + Supabase")
    print("="*50)
    print("  URL: http://localhost:5001")
    print("  Using real Supabase database")
    print("="*50 + "\n")

    serve(port=5001)
